FROM ubuntu:20.04

LABEL maintainer="CVE-Builder"
LABEL description="ZenTao PMS 21.7.6 - Vulnerable to CVE-2025-13789 (SSRF)"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /opt
# Install system dependencies (iproute2 and sudo required by zbox)
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    ca-certificates \
    tmux \
    asciinema \
    procps \
    net-tools \
    iproute2 \
    sudo \
    git \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Download and extract ZenTao zbox package (all-in-one installer)
RUN wget -q https://www.zentao.net/dl/zentao/21.7/ZenTaoPMS-21.7.6-zbox_amd64.tar.gz -O zentao.tar.gz \
    && tar -xzf zentao.tar.gz -C /opt/ \
    && rm zentao.tar.gz

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create necessary directories and set permissions
RUN mkdir -p /opt/zbox/app/zentao/tmp/session \
    && mkdir -p /opt/zbox/app/zentao/tmp/cache \
    && mkdir -p /opt/zbox/app/zentao/tmp/log \
    && chmod -R 777 /opt/zbox/app/zentao/tmp

# Expose ports for web and MySQL
EXPOSE 80 3306

# Environment variables for ZenTao
ENV ZENTAO_PATH=/opt/zbox/app/zentao
ENV PATH="/opt/zbox/bin:/opt/zbox/run/php/bin:/opt/zbox/run/mysql:${PATH}"

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=5 \
    CMD curl -sf http://localhost/zentao/ || exit 1

# Start the container
# CMD ["/entrypoint.sh"]
