#!/bin/bash
set -e

cd /app/swftools

echo "Applying fix to swftools wav2swf..."

# ============================================================================
# Fix 1: lib/wav.c - Fix samplelen calculation (round up instead of truncate)
# ============================================================================
# Change: int samplelen=src->size/src->align;
# To:     int samplelen=(src->size+(src->align-1))/src->align;
sed -i 's/int samplelen=src->size\/src->align;/int samplelen=(src->size+(src->align-1))\/src->align;/' lib/wav.c

# ============================================================================
# Fix 2: lib/wav.c - Add align==0 check before division and PCM validation
# ============================================================================
# Insert checks after "int fill;" line in wav_convert2mono function
sed -i '/int fill;$/a\
\
    if (src->align == 0) {\
        fprintf(stderr, "Illegal wave align == 0\\n");\
        return 0;\
    }\
    if (src->size == 0 || src->data == 0) {\
        fprintf(stderr, "Invalid wave: no audio data\\n");\
        return 0;\
    }\
    if (src->align != (channels*bps\/8)) {\
        fprintf(stderr, "Unsupported non-PCM convert to mono: align:%d != (channels:%d*bps:%d\/8)\\n", src->align, channels, bps);\
        return 0;\
    }' lib/wav.c

# ============================================================================
# Fix 3: lib/wav.c - Proper error handling for unsupported bits-per-sample
# ============================================================================
# The vulnerable code has:
#   } else {
#       fprintf(stderr, "Unsupported bitspersample value: %d\n", bps);
#   }
#   return 1;
#
# We need to add cleanup and return 0 in the else block, and change return 1 to only
# happen on success path.
#
# Insert cleanup code after the "Unsupported bitspersample" error message
sed -i '/fprintf(stderr, "Unsupported bitspersample value: %d\\n", bps);/a\
        free(dest->data);\
        dest->data = 0;\
        return 0;' lib/wav.c

# ============================================================================
# Fix 4: src/wav2swf.c - Add error checking for wav_convert2mono return value
# ============================================================================
# Change: wav_convert2mono(&wav,&wav2, samplerate);
# To: Check return value and exit on error
sed -i 's/wav_convert2mono(\&wav,\&wav2, samplerate);/if(!wav_convert2mono(\&wav, \&wav2, samplerate))\n    {\n        msg("<fatal> Error convert %s to mono", filename);\n        exit(1);\n    }/' src/wav2swf.c

# ============================================================================
# Rebuild only wav2swf (not the full project since PDF lib has build issues)
# ============================================================================
echo "Rebuilding wav2swf..."
# Clean only the relevant files
rm -f lib/wav.o src/wav2swf.o src/wav2swf 2>/dev/null || true
# Rebuild libraries that include wav.c
make -C lib libbase.a 2>&1 | tail -10
# Rebuild wav2swf
make -C src wav2swf 2>&1 | tail -10

echo ""
echo "Fix applied successfully!"
echo "Changes made:"
echo "  1. Fixed samplelen calculation to round up in lib/wav.c"
echo "  2. Added align==0 validation check in lib/wav.c"
echo "  3. Added PCM format validation (align vs channels*bps/8) in lib/wav.c"
echo "  4. Added proper cleanup on unsupported bits-per-sample in lib/wav.c"
echo "  5. Added error handling for wav_convert2mono in src/wav2swf.c"
