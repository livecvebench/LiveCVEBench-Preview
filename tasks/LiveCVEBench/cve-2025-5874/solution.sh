#!/bin/bash
# Solution script for fixing the Python query runner sandbox issue
# This script modifies the vulnerable file to use safer_getattr instead of getattr

set -e

PYTHON_FILE="/app/redash/query_runner/python.py"

echo "Applying fix to Python query runner..."

# Verify the file exists
if [ ! -f "$PYTHON_FILE" ]; then
    echo "ERROR: File not found: $PYTHON_FILE"
    exit 1
fi

# Check if fix already applied
if grep -q "safer_getattr" "$PYTHON_FILE"; then
    echo "Fix already applied (safer_getattr found in file)"
    exit 0
fi

# Verify the vulnerable code exists before applying fix
if ! grep -q 'builtins\["_getattr_"\] = getattr' "$PYTHON_FILE"; then
    echo "ERROR: Could not find vulnerable code pattern"
    exit 1
fi

echo "Found vulnerable code, applying fix..."

# Apply the fix using Python for more robust text replacement
python3 << 'PYEOF'
import re
import sys

file_path = "/app/redash/query_runner/python.py"

with open(file_path, 'r') as f:
    content = f.read()

original_content = content

# Fix 1: Add safer_getattr to the import statement
# The import line looks like:
# from RestrictedPython.Guards import safe_builtins, guarded_iter_unpack_sequence, guarded_unpack_sequence
old_import = "from RestrictedPython.Guards import safe_builtins, guarded_iter_unpack_sequence, guarded_unpack_sequence"
new_import = "from RestrictedPython.Guards import safe_builtins, guarded_iter_unpack_sequence, guarded_unpack_sequence, safer_getattr"

if old_import in content:
    content = content.replace(old_import, new_import)
    print("Step 1: Added safer_getattr to imports")
else:
    # Try alternative pattern that might have trailing whitespace or newline differences
    pattern = r'from RestrictedPython\.Guards import safe_builtins, guarded_iter_unpack_sequence, guarded_unpack_sequence(?!\s*,\s*safer_getattr)'
    if re.search(pattern, content):
        content = re.sub(
            pattern,
            'from RestrictedPython.Guards import safe_builtins, guarded_iter_unpack_sequence, guarded_unpack_sequence, safer_getattr',
            content
        )
        print("Step 1: Added safer_getattr to imports (alternative pattern)")
    else:
        print("WARNING: Could not find import line to modify")

# Fix 2: Replace builtins["_getattr_"] = getattr with safer_getattr
# Be precise to avoid replacing other getattr usages
pattern2 = r'builtins\["_getattr_"\]\s*=\s*getattr(?!\w)'
if re.search(pattern2, content):
    content = re.sub(pattern2, 'builtins["_getattr_"] = safer_getattr', content)
    print("Step 2: Replaced _getattr_ assignment")
else:
    print("WARNING: Could not find _getattr_ assignment")

# Fix 3: Replace builtins["getattr"] = getattr with safer_getattr
pattern3 = r'builtins\["getattr"\]\s*=\s*getattr(?!\w)'
if re.search(pattern3, content):
    content = re.sub(pattern3, 'builtins["getattr"] = safer_getattr', content)
    print("Step 3: Replaced getattr assignment")
else:
    print("WARNING: Could not find getattr assignment")

# Write the modified content back
if content != original_content:
    with open(file_path, 'w') as f:
        f.write(content)
    print("Fix applied successfully!")
else:
    print("WARNING: No changes were made to the file")
    sys.exit(1)
PYEOF

# Verify the fix was applied
echo ""
echo "Verifying fix..."

if grep -q "safer_getattr" "$PYTHON_FILE"; then
    echo "Verification: safer_getattr found in imports"
else
    echo "ERROR: Verification failed - safer_getattr not found in imports"
    exit 1
fi

if grep -q 'builtins\["_getattr_"\] = safer_getattr' "$PYTHON_FILE"; then
    echo "Verification: _getattr_ correctly assigned to safer_getattr"
else
    echo "ERROR: Verification failed - _getattr_ not properly fixed"
    exit 1
fi

if grep -q 'builtins\["getattr"\] = safer_getattr' "$PYTHON_FILE"; then
    echo "Verification: getattr correctly assigned to safer_getattr"
else
    echo "ERROR: Verification failed - getattr not properly fixed"
    exit 1
fi

echo ""
echo "Fix applied and verified successfully!"

# If the application is running, it needs to be restarted
# Try to find and restart any running gunicorn/python server processes
if pgrep -f "gunicorn.*redash" > /dev/null 2>&1; then
    echo "Restarting Redash server..."
    pkill -f "gunicorn.*redash" || true
    sleep 2
    echo "Server process terminated. Container entrypoint will restart it."
elif pgrep -f "python.*redash" > /dev/null 2>&1; then
    echo "Restarting Python server..."
    pkill -f "python.*redash" || true
    sleep 2
    echo "Server process terminated. Container entrypoint will restart it."
else
    echo "No running server process detected (tests will use direct module import)"
fi

echo ""
echo "Solution complete!"
