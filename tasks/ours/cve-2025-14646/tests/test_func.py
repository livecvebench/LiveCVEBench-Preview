"""
Functionality tests for the School File Management System.
These tests verify that the application works correctly in both vulnerable and fixed states.
"""

import pytest
import requests
import time


BASE_URL = "http://localhost"
TIMEOUT = 10


class TestBasicFunctionality:
    """Tests for basic application functionality."""

    def test_homepage_accessible(self):
        """Test that the main homepage loads successfully."""
        response = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Student" in response.text or "Login" in response.text or "login" in response.text

    def test_admin_login_page_accessible(self):
        """Test that admin login page loads successfully."""
        response = requests.get(f"{BASE_URL}/admin/", timeout=TIMEOUT)
        assert response.status_code == 200
        # Check for login form elements
        assert "login" in response.text.lower() or "password" in response.text.lower() or "username" in response.text.lower()

    def test_admin_login_page_has_form(self):
        """Test that admin login page has a login form."""
        response = requests.get(f"{BASE_URL}/admin/login.php", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "<form" in response.text.lower() or "form" in response.text.lower()


class TestDeleteEndpoint:
    """Tests for the student delete functionality with valid inputs."""

    def test_delete_endpoint_exists(self):
        """Test that the delete endpoint responds to POST requests."""
        response = requests.post(
            f"{BASE_URL}/admin/delete_student.php",
            data={"stud_id": "999"},
            timeout=TIMEOUT
        )
        # Should return 200 even for non-existent IDs (just does nothing)
        assert response.status_code == 200

    def test_delete_with_valid_integer_string(self):
        """Test delete endpoint accepts valid integer as string."""
        response = requests.post(
            f"{BASE_URL}/admin/delete_student.php",
            data={"stud_id": "9999"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        # Should not contain PHP fatal errors
        assert "Fatal error" not in response.text
        assert "Parse error" not in response.text

    def test_delete_with_zero(self):
        """Test delete endpoint handles zero correctly."""
        response = requests.post(
            f"{BASE_URL}/admin/delete_student.php",
            data={"stud_id": "0"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        # Should not crash
        assert "Fatal error" not in response.text

    def test_delete_with_negative_number(self):
        """Test delete endpoint handles negative numbers."""
        response = requests.post(
            f"{BASE_URL}/admin/delete_student.php",
            data={"stud_id": "-1"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        # Should complete without fatal errors
        assert "Fatal error" not in response.text

    def test_delete_without_stud_id_parameter(self):
        """Test delete endpoint handles missing parameter gracefully."""
        response = requests.post(
            f"{BASE_URL}/admin/delete_student.php",
            data={},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        # Should not crash when parameter is missing
        assert "Fatal error" not in response.text

    def test_delete_response_is_quick(self):
        """Test that delete with valid input responds quickly."""
        start_time = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/delete_student.php",
            data={"stud_id": "12345"},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time

        assert response.status_code == 200
        # Valid request should respond in under 2 seconds
        assert elapsed < 2, f"Response took {elapsed:.2f}s, expected < 2s"


class TestDatabaseOperations:
    """Tests for database-related functionality."""

    def test_php_mysql_connection(self):
        """Test that PHP can establish MySQL connection (via admin page load)."""
        response = requests.get(f"{BASE_URL}/admin/", timeout=TIMEOUT)
        # If there's a connection error, it would likely show up here
        assert response.status_code == 200
        # Check for no connection errors in output
        assert "Connection failed" not in response.text
        assert "mysqli_connect" not in response.text  # Error message

    def test_student_page_loads(self):
        """Test that student management page loads (requires working DB)."""
        # Try to access the student page - it should load even without login
        # (authentication check is in separate validator.php)
        response = requests.get(f"{BASE_URL}/admin/student.php", timeout=TIMEOUT)
        assert response.status_code == 200
        # Page should contain student-related content or redirect
        assert len(response.text) > 0
