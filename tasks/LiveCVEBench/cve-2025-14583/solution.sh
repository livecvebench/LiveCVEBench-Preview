#!/bin/bash
# Solution script for CVE-2025-14583 - Unrestricted File Upload in register.php
# This fix adds whitelist validation for allowed file extensions

set -e

VULN_FILE="/var/www/html/student_enrollment/admin/register.php"

echo "Applying file upload fix to $VULN_FILE..."

# Check if file exists
if [ ! -f "$VULN_FILE" ]; then
    echo "ERROR: Vulnerable file not found at $VULN_FILE"
    exit 1
fi

# Check if fix has already been applied
if grep -q "allowed_extensions" "$VULN_FILE"; then
    echo "Fix has already been applied. Skipping..."
    exit 0
fi

# Create backup
cp "$VULN_FILE" "${VULN_FILE}.bak"

# Convert DOS line endings to Unix
sed -i 's/\r$//' "$VULN_FILE"

# Create a PHP script to apply the fix correctly
cat > /tmp/apply_fix.php << 'PHPSCRIPT'
<?php
$file = $argv[1];
$content = file_get_contents($file);

// The fix should be inserted after the empty($photo) validation block
// Use regex to find and replace with flexible whitespace

$fix_code = '
		// Security fix: Whitelist allowed file extensions
		$allowed_extensions = array(\'jpg\', \'jpeg\', \'png\', \'gif\');
		if (!in_array(strtolower($photo), $allowed_extensions)) {
			$input_error[\'photo\'] = "Only image files (JPG, JPEG, PNG, GIF) are allowed";
		}
';

// Use regex to match the pattern with flexible whitespace (tabs or spaces)
$pattern = '/if\s*\(\s*empty\s*\(\s*\$photo\s*\)\s*\)\s*\{\s*\n\s*\$input_error\s*\[\s*[\'"]photo[\'"]\s*\]\s*=\s*["\']The Photo Filed is Required["\'];\s*\n\s*\}/';

if (preg_match($pattern, $content, $matches)) {
    $new_content = preg_replace($pattern, $matches[0] . $fix_code, $content, 1);
} else {
    // Fallback: try simpler pattern
    $search = 'if (empty($photo)) {';
    if (strpos($content, $search) !== false) {
        // Find the closing brace for this if block
        $pos = strpos($content, $search);
        $endPos = strpos($content, '}', $pos + strlen($search));
        if ($endPos !== false) {
            $endPos++; // Include the closing brace
            $before = substr($content, 0, $endPos);
            $after = substr($content, $endPos);
            $new_content = $before . $fix_code . $after;
        } else {
            echo "Could not find closing brace\n";
            exit(1);
        }
    } else {
        echo "Pattern not found\n";
        exit(1);
    }
}

if (!isset($new_content) || $new_content === $content) {
    echo "Pattern not found or no change made\n";
    exit(1);
}

file_put_contents($file, $new_content);
echo "Fix applied successfully\n";
exit(0);
PHPSCRIPT

# Apply the fix
php /tmp/apply_fix.php "$VULN_FILE"
FIX_RESULT=$?

# Clean up
rm -f /tmp/apply_fix.php

# Verify the fix was applied
if [ $FIX_RESULT -eq 0 ] && grep -q "allowed_extensions" "$VULN_FILE"; then
    echo "Fix successfully applied!"
    rm -f "${VULN_FILE}.bak"
else
    echo "ERROR: Fix was not applied correctly"
    # Restore backup
    mv "${VULN_FILE}.bak" "$VULN_FILE"
    exit 1
fi

# Step 2: Add error display for photo field in HTML
# The HTML needs to show the error message when $input_error['photo'] is set
cat > /tmp/add_error_display.php << 'PHPSCRIPT2'
<?php
$file = $argv[1];
$content = file_get_contents($file);

// Find the photo input and add error display after it
$search = '<input type="file" id="photo" name="photo" class="form-control" id="inputPassword3" >';
$error_display = '<?= isset($input_error[\'photo\'])? \'<label class="error">\'.$input_error[\'photo\'].\'</label>\':\'\'  ?>';

if (strpos($content, $error_display) === false) {
    $content = str_replace($search, $search . $error_display, $content);
    file_put_contents($file, $content);
    echo "Added error display for photo field\n";
} else {
    echo "Error display already present\n";
}
PHPSCRIPT2

php /tmp/add_error_display.php "$VULN_FILE"
rm -f /tmp/add_error_display.php

echo "Solution applied successfully!"
