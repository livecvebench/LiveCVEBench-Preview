FROM php:8.2-apache

WORKDIR /var/www/html

# Install system dependencies for GD, PHP extensions and required utilities
RUN apt-get update && apt-get install -y \
    libpng-dev \
    libjpeg62-turbo-dev \
    libwebp-dev \
    libfreetype6-dev \
    libicu-dev \
    libzip-dev \
    libonig-dev \
    git \
    tmux \
    asciinema \
    curl \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Configure and install GD extension with all image format support
RUN docker-php-ext-configure gd \
    --with-freetype \
    --with-jpeg \
    --with-webp \
    && docker-php-ext-install -j$(nproc) gd mysqli mbstring intl zip fileinfo

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Copy the vulnerable image_resized.php from task-deps
COPY task-deps/image_resized.php /var/www/html/image_resized.php

# Copy Apache configuration
COPY task-deps/phpwcms.conf /etc/apache2/conf-available/phpwcms.conf
RUN a2enconf phpwcms

# Create img directory for default images
RUN mkdir -p /var/www/html/img

# Create a test image using PHP GD for functional testing
RUN php -r "\$im = imagecreatetruecolor(100, 100); \
    imagefill(\$im, 0, 0, imagecolorallocate(\$im, 255, 0, 0)); \
    imagejpeg(\$im, '/var/www/html/img/test.jpg', 90); \
    imagedestroy(\$im);"

# Create default leer.gif (placeholder image) that the script expects
RUN php -r "\$im = imagecreatetruecolor(1, 1); \
    imagefill(\$im, 0, 0, imagecolorallocate(\$im, 255, 255, 255)); \
    imagegif(\$im, '/var/www/html/img/leer.gif'); \
    imagedestroy(\$im);"

# Create symlink for /app if solution.sh expects it
RUN ln -s /var/www/html /app

# Set proper permissions
RUN chown -R www-data:www-data /var/www/html

EXPOSE 80

# CMD ["apache2-foreground"]  # Moved to docker-compose.yaml
