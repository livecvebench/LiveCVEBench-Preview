"""
Vulnerability tests for WeGIA cargos.php page.
These tests verify that special characters in message parameters are properly encoded.

Expected behavior:
- FAIL when vulnerable (XSS payload appears unencoded in response)
- PASS when fixed (XSS payload is HTML-encoded)
"""

import pytest
import requests
import urllib.parse
import os
import re

BASE_URL = os.environ.get("APP_URL", "http://localhost:80")

# Login credentials (from documentation)
LOGIN_CPF = "admin"
LOGIN_PWD = "wegia"


@pytest.fixture(scope="module")
def authenticated_session():
    """Create an authenticated session for testing."""
    session = requests.Session()

    # Login to the application
    login_data = {
        "cpf": LOGIN_CPF,
        "pwd": LOGIN_PWD
    }
    response = session.post(f"{BASE_URL}/html/login.php", data=login_data, timeout=10)

    # Session should now have the authentication cookie
    return session


class TestXSSVulnerabilityMsgE:
    """Tests for XSS vulnerability in msg_e parameter."""

    def test_basic_script_tag_injection(self, authenticated_session):
        """Test that basic script tag is properly encoded."""
        payload = "<script>alert('XSS')</script>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        # The raw payload should NOT appear in the response
        assert payload not in response.text, \
            f"Unencoded script tag found in response. XSS vulnerability exists!"

        # If fixed, we should see HTML entities
        if response.status_code == 200 and "alert" in response.text:
            assert "&lt;script&gt;" in response.text or "&lt;script" in response.text, \
                "Script tag should be HTML-encoded"

    def test_script_tag_with_document_cookie(self, authenticated_session):
        """Test cookie-stealing XSS payload is encoded."""
        payload = "<script>alert(document.cookie)</script>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert payload not in response.text, \
            "Unencoded cookie-stealing script found. XSS vulnerability exists!"

    def test_img_tag_with_onerror(self, authenticated_session):
        """Test img tag with onerror event handler is encoded."""
        payload = '<img src=x onerror="alert(1)">'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        # Check that the onerror handler is not executable
        assert 'onerror="alert(1)"' not in response.text and \
               "onerror='alert(1)'" not in response.text, \
            "Unencoded img onerror found. XSS vulnerability exists!"

    def test_svg_with_onload(self, authenticated_session):
        """Test SVG tag with onload event is encoded."""
        payload = "<svg onload=alert(1)>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert payload not in response.text, \
            "Unencoded SVG onload found. XSS vulnerability exists!"

    def test_body_tag_with_onload(self, authenticated_session):
        """Test body tag with onload is encoded."""
        payload = "<body onload=alert(1)>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        # Should not have unencoded body onload
        assert 'onload=alert(1)>' not in response.text, \
            "Unencoded body onload found. XSS vulnerability exists!"

    def test_iframe_injection(self, authenticated_session):
        """Test iframe injection is blocked."""
        payload = '<iframe src="javascript:alert(1)">'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert payload not in response.text, \
            "Unencoded iframe found. XSS vulnerability exists!"

    def test_event_handler_variations(self, authenticated_session):
        """Test various event handlers are encoded."""
        payloads = [
            '<div onmouseover="alert(1)">hover</div>',
            '<input onfocus="alert(1)" autofocus>',
            '<marquee onstart="alert(1)">',
            '<details open ontoggle="alert(1)">',
        ]

        for payload in payloads:
            response = authenticated_session.get(
                f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
                timeout=10
            )
            # Check that event handlers are encoded
            assert 'alert(1)">' not in response.text and \
                   "alert(1)'>" not in response.text, \
                f"Unencoded event handler in payload: {payload}"

    def test_javascript_protocol(self, authenticated_session):
        """Test javascript: protocol in href is encoded."""
        payload = '<a href="javascript:alert(1)">click</a>'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert 'href="javascript:alert(1)"' not in response.text, \
            "Unencoded javascript protocol found. XSS vulnerability exists!"

    def test_encoded_script_tag(self, authenticated_session):
        """Test that HTML entities in input are properly escaped in output."""
        # Using HTML entities that should be double-encoded if properly escaped
        payload = "&#60;script&#62;alert(1)&#60;/script&#62;"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        # If properly encoded, the & should become &amp;
        # If vulnerable, the raw &#60; appears as-is (not double-encoded)
        assert "&amp;#60;" in response.text or "&#60;" not in response.text, \
            "HTML entities should be escaped (& to &amp;)"


class TestXSSVulnerabilityMsgC:
    """Tests for XSS vulnerability in msg_c parameter (success messages)."""

    def test_basic_script_tag_in_success_message(self, authenticated_session):
        """Test that script tag in success message is encoded."""
        payload = "<script>alert('XSS')</script>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_c={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert payload not in response.text, \
            "Unencoded script in msg_c found. XSS vulnerability exists!"

    def test_img_onerror_in_success_message(self, authenticated_session):
        """Test img onerror in success message is encoded."""
        payload = '<img src=x onerror=alert(document.domain)>'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_c={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert payload not in response.text, \
            "Unencoded img onerror in msg_c found. XSS vulnerability exists!"

    def test_svg_onload_in_success_message(self, authenticated_session):
        """Test SVG onload in success message is encoded."""
        payload = '<svg/onload=alert(1)>'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_c={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert payload not in response.text, \
            "Unencoded SVG in msg_c found. XSS vulnerability exists!"


class TestHTMLInjection:
    """Tests for general HTML injection (even if not XSS)."""

    def test_html_bold_tag_encoded(self, authenticated_session):
        """Test that HTML bold tag is encoded and displayed as text."""
        payload = "<b>bold text</b>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        if response.status_code == 200:
            # The raw tag should not be in the HTML (should be encoded)
            # Either &lt;b&gt; should appear, or the raw tag should not exist
            has_encoded = "&lt;b&gt;" in response.text
            has_raw = re.search(r'<b>bold text</b>', response.text) is not None

            assert has_encoded or not has_raw, \
                "HTML tags should be encoded as text"

    def test_div_injection(self, authenticated_session):
        """Test that injected div tags are encoded."""
        payload = '<div style="background:red">injected</div>'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        if response.status_code == 200:
            # Should not have raw styled div
            assert 'style="background:red"' not in response.text or \
                   "&lt;div" in response.text


class TestEdgeCases:
    """Edge case tests for special input handling."""

    def test_angle_brackets_only(self, authenticated_session):
        """Test that lone angle brackets are encoded."""
        payload = "<>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        # If properly encoded, should have &lt;&gt;
        # If vulnerable, raw <> appears in the alert div
        assert "&lt;&gt;" in response.text, \
            "Angle brackets should be encoded as &lt;&gt;"

    def test_less_than_sign_encoded(self, authenticated_session):
        """Test that less-than sign is encoded."""
        payload = "5 < 10"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        if response.status_code == 200:
            # The < should be encoded as &lt;
            assert "&lt;" in response.text or "5 < 10" not in response.text

    def test_quotes_encoded(self, authenticated_session):
        """Test that quotes are properly HTML-encoded."""
        payload = 'test "quoted" text'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        # If properly encoded, quotes should become &quot;
        # Check response is OK and quotes are encoded
        assert response.status_code == 200
        assert '&quot;' in response.text or '"quoted"' not in response.text, \
            "Quotes should be encoded as &quot;"

    def test_ampersand_encoded(self, authenticated_session):
        """Test that ampersand is encoded."""
        payload = "Tom & Jerry"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        if response.status_code == 200:
            # Ampersand should be encoded as &amp;
            assert "&amp;" in response.text or "Tom & Jerry" not in response.text

    def test_mixed_xss_payload(self, authenticated_session):
        """Test complex mixed XSS payload."""
        payload = '"><script>alert(String.fromCharCode(88,83,83))</script>'
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert "<script>alert(String.fromCharCode" not in response.text, \
            "Unencoded complex XSS payload found!"

    def test_null_byte_injection(self, authenticated_session):
        """Test that special characters are properly encoded regardless of null bytes."""
        # Payload with angle brackets that should be encoded
        payload = "<test>null</test>"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        # If properly encoded, should have &lt;test&gt;
        assert "&lt;test&gt;" in response.text, \
            "HTML tags should be encoded even in edge cases"

    def test_unicode_encoded_payload(self, authenticated_session):
        """Test unicode-encoded XSS bypass attempts."""
        payload = "\u003cscript\u003ealert(1)\u003c/script\u003e"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(payload)}",
            timeout=10
        )

        assert "<script>alert(1)</script>" not in response.text
