import { createLink } from '../Link'

jest.mock('@meshconnect/uwc-bridge-parent', () => ({
  BridgeParent: jest.fn().mockImplementation(() => ({
    destroy: jest.fn()
  }))
}))

const VALID_HTTPS_URL = Buffer.from('https://secure.example.com/app').toString('base64')

describe('Functional: Valid HTTPS URL', () => {
  beforeEach(() => {
    document.getElementsByTagName('html')[0].innerHTML = ''
  })

  test('createLink with valid https:// URL should open popup', () => {
    const exitFunction = jest.fn<void, [string | undefined]>()
    const frontConnection = createLink({
      clientId: 'test',
      onIntegrationConnected: jest.fn(),
      onExit: exitFunction,
      language: 'en'
    })

    frontConnection.openLink(VALID_HTTPS_URL)

    expect(exitFunction).not.toHaveBeenCalled()
    const iframeElement = document.getElementById('mesh-link-popup__iframe')
    expect(iframeElement).toBeTruthy()
    expect(iframeElement?.attributes.getNamedItem('src')?.nodeValue).toContain('https://secure.example.com/app')
  })
})
