#!/bin/bash
set -e

# Solution script for fixing SQL injection vulnerability in admin_running.php
# The vulnerability is in the stockin and stockout functionality where the 'pid'
# parameter is used directly in SQL queries without sanitization.

echo "Applying fix for SQL injection vulnerability..."

# Path to the vulnerable file
VULN_FILE="/var/www/html/admin/admin_running.php"

# Check if file exists
if [ ! -f "$VULN_FILE" ]; then
    echo "ERROR: Vulnerable file not found at $VULN_FILE"
    exit 1
fi

# Create backup
cp "$VULN_FILE" "${VULN_FILE}.bak"

# First, convert DOS line endings to Unix if needed
if command -v dos2unix &> /dev/null; then
    dos2unix "$VULN_FILE" 2>/dev/null || true
else
    # Alternative: use sed to remove carriage returns
    sed -i 's/\r$//' "$VULN_FILE"
fi

# Use Python for reliable multi-line string replacement
python3 << 'PYTHON_SCRIPT'
import re

file_path = "/var/www/html/admin/admin_running.php"

with open(file_path, 'r') as f:
    content = f.read()

# Normalize line endings to Unix style
content = content.replace('\r\n', '\n').replace('\r', '\n')

# Original content for stockin block (lines 222-237 approximately)
# We need to match the exact whitespace pattern from the file

# Use regex to find and replace the stockin vulnerable block
stockin_pattern = re.compile(
    r'(/\* stock in \*/\s*\n\s*if\(isset\(\$_POST\[\'stockin\'\]\)\)\{\s*\n\s*\n\s*\$pid = \$_POST\[\'pid\'\];\s*\n\s*\n\s*)\$result = \$conn->query\("SELECT \* FROM `stock` WHERE product_id=\'\$pid\'"\) or die\(mysqli_error\(\)\);\s*\n\s*\$row = \$result->fetch_array\(\);(\s*\n\s*\n\s*\$old_stck = \$row\[\'qty\'\];\s*\n\s*\$new_stck = \$_POST\[\'new_stck\'\];\s*\n\s*\$total = \$old_stck \+ \$new_stck;\s*\n\s*\n\s*)\$que = \$conn->query\("UPDATE `stock` SET `qty` = \'\$total\' WHERE `product_id`=\'\$pid\'"\) or die\(mysql_error\(\)\);',
    re.MULTILINE
)

stockin_replacement = r'''\1// Fixed: Using prepared statements to prevent SQL injection
  $stmt = $conn->prepare("SELECT * FROM `stock` WHERE product_id=?");
  $stmt->bind_param("i", $pid);
  $stmt->execute();
  $result = $stmt->get_result();
  $row = $result->fetch_array();\2// Fixed: Using prepared statements for UPDATE
  $stmt2 = $conn->prepare("UPDATE `stock` SET `qty` = ? WHERE `product_id`=?");
  $stmt2->bind_param("ii", $total, $pid);
  $stmt2->execute();'''

content = stockin_pattern.sub(stockin_replacement, content)

# Use regex to find and replace the stockout vulnerable block
stockout_pattern = re.compile(
    r'(/\* stock out \*/\s*\n\s*if\(isset\(\$_POST\[\'stockout\'\]\)\)\{\s*\n\s*\n\s*\$pid = \$_POST\[\'pid\'\];\s*\n\s*\n\s*)\$result = \$conn->query\("SELECT \* FROM `stock` WHERE product_id=\'\$pid\'"\) or die\(mysqli_error\(\)\);\s*\n\s*\$row = \$result->fetch_array\(\);(\s*\n\s*\n\s*\$old_stck = \$row\[\'qty\'\];\s*\n\s*\$new_stck = \$_POST\[\'new_stck\'\];\s*\n\s*\$total = \$old_stck - \$new_stck;\s*\n\s*\n\s*)\$que = \$conn->query\("UPDATE `stock` SET `qty` = \'\$total\' WHERE `product_id`=\'\$pid\'"\) or die\(mysqli_error\(\)\);',
    re.MULTILINE
)

stockout_replacement = r'''\1// Fixed: Using prepared statements to prevent SQL injection
  $stmt = $conn->prepare("SELECT * FROM `stock` WHERE product_id=?");
  $stmt->bind_param("i", $pid);
  $stmt->execute();
  $result = $stmt->get_result();
  $row = $result->fetch_array();\2// Fixed: Using prepared statements for UPDATE
  $stmt2 = $conn->prepare("UPDATE `stock` SET `qty` = ? WHERE `product_id`=?");
  $stmt2->bind_param("ii", $total, $pid);
  $stmt2->execute();'''

content = stockout_pattern.sub(stockout_replacement, content)

with open(file_path, 'w') as f:
    f.write(content)

print("Fix applied successfully!")

# Verify the fix
with open(file_path, 'r') as f:
    new_content = f.read()

if 'prepare("SELECT * FROM `stock` WHERE product_id=?")' in new_content:
    print("Verification: Prepared statements are now in use.")
else:
    print("Warning: Fix may not have been applied correctly.")
    exit(1)

# Check if vulnerable query pattern still exists
if "$conn->query(\"SELECT * FROM `stock` WHERE product_id='$pid'\")" in new_content:
    print("Warning: Vulnerable code still present!")
    exit(1)
else:
    print("Verification: Vulnerable queries have been replaced.")

PYTHON_SCRIPT

echo ""
echo "Fix applied successfully!"
echo "The stockin and stockout functionality now uses prepared statements."
