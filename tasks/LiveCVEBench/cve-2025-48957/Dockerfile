FROM python:3.10-slim

WORKDIR /app

# Build-time proxy configuration (can be overridden via --build-arg)
ARG HTTP_PROXY=http://oversea-squid5.sgp.txyun:11080
ARG HTTPS_PROXY=http://oversea-squid5.sgp.txyun:11080
ENV http_proxy=${HTTP_PROXY}
ENV https_proxy=${HTTPS_PROXY}

# System dependencies (tmux, asciinema, curl are required plus build dependencies)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    tmux \
    asciinema \
    curl \
    gcc \
    build-essential \
    python3-dev \
    libffi-dev \
    libssl-dev \
    procps \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install uv for fast package management
RUN pip install uv

# Clone AstrBot at vulnerable commit and remove git history
RUN git clone https://github.com/AstrBotDevs/AstrBot.git . && \
    git checkout 2fc0ec0f720ef96b6fba4b453538dbc91978189a && \
    rm -rf .git

# Install Python dependencies
RUN uv pip install -r requirements.txt --no-cache-dir --system

# Create necessary directories
RUN mkdir -p data/webchat/imgs data/config data/plugins data/temp

# Copy mock sensitive configuration file for testing
COPY task-deps/cmd_config.json /app/data/cmd_config.json

# Copy entrypoint script for restart capability
COPY task-deps/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Environment variables
ENV TZ=UTC

# Expose the WebUI dashboard port
EXPOSE 6185

# Start via entrypoint (allows service restart)
# CMD ["/app/entrypoint.sh"]  # Moved to docker-compose.yaml
