"""
Functional tests for tiffmedian tool.
These tests verify that the tool works correctly and should pass
in both vulnerable and fixed states.
"""

import subprocess
import os
import tempfile
import struct
import pytest


# Path to the tiffmedian binary
TIFFMEDIAN = "/app/mybuild/tools/tiffmedian"
TIFFINFO = "/app/mybuild/tools/tiffinfo"


def create_simple_rgb_tiff(filepath, width=64, height=64):
    """
    Create a simple RGB TIFF file.
    Returns True on success.
    """
    # Use the pre-compiled create_test_tiff only for default 64x64 size
    create_tool = "/app/create_test_tiff"
    if os.path.exists(create_tool) and width == 64 and height == 64:
        result = subprocess.run([create_tool, filepath], capture_output=True)
        return result.returncode == 0

    # Use Python PIL for custom dimensions
    try:
        from PIL import Image

        # Create gradient RGB image
        img = Image.new('RGB', (width, height))
        for y in range(height):
            for x in range(width):
                r = (y * 4) % 256
                g = (x * 4) % 256
                b = ((x + y) * 2) % 256
                img.putpixel((x, y), (r, g, b))
        img.save(filepath, format='TIFF')
        return True
    except ImportError:
        pass

    # Fallback: try using ImageMagick
    result = subprocess.run([
        "convert", "-size", f"{width}x{height}",
        "xc:red", "xc:green", "xc:blue", "+append",
        "-resize", f"{width}x{height}!",
        "-define", "tiff:photometric=rgb",
        filepath
    ], capture_output=True)

    return result.returncode == 0


def get_tiff_dimensions(filepath):
    """Get width and height of a TIFF file."""
    result = subprocess.run([TIFFINFO, filepath], capture_output=True, text=True)
    width = None
    height = None
    for line in result.stdout.split('\n'):
        if 'Image Width:' in line:
            parts = line.split()
            for i, p in enumerate(parts):
                if p == 'Width:':
                    width = int(parts[i+1])
                if p == 'Length:':
                    height = int(parts[i+1])
    return width, height


class TestTiffmedianBasicFunctionality:
    """Test basic tiffmedian functionality."""

    @pytest.fixture(autouse=True)
    def setup_teardown(self, tmp_path):
        """Setup test fixtures."""
        self.tmp_path = tmp_path
        self.input_file = str(tmp_path / "input.tif")
        self.output_file = str(tmp_path / "output.tif")

        # Create test image
        assert create_simple_rgb_tiff(self.input_file, 64, 64), \
            "Failed to create test TIFF image"

    def test_tiffmedian_exists(self):
        """Verify tiffmedian binary exists."""
        assert os.path.exists(TIFFMEDIAN), f"tiffmedian not found at {TIFFMEDIAN}"

    def test_basic_processing_without_dither(self):
        """Test basic median cut without Floyd-Steinberg dithering."""
        result = subprocess.run(
            [TIFFMEDIAN, self.input_file, self.output_file],
            capture_output=True, text=True
        )
        assert result.returncode == 0, f"tiffmedian failed: {result.stderr}"
        assert os.path.exists(self.output_file), "Output file not created"

    def test_basic_processing_with_dither(self):
        """Test median cut with Floyd-Steinberg dithering (-f flag)."""
        result = subprocess.run(
            [TIFFMEDIAN, "-f", self.input_file, self.output_file],
            capture_output=True, text=True
        )
        assert result.returncode == 0, f"tiffmedian -f failed: {result.stderr}"
        assert os.path.exists(self.output_file), "Output file not created"

    def test_output_is_valid_tiff(self):
        """Verify output is a valid TIFF that can be read by tiffinfo."""
        subprocess.run(
            [TIFFMEDIAN, "-f", self.input_file, self.output_file],
            capture_output=True
        )

        result = subprocess.run(
            [TIFFINFO, self.output_file],
            capture_output=True, text=True
        )
        assert result.returncode == 0, f"Output is not a valid TIFF: {result.stderr}"
        assert "Image Width:" in result.stdout

    def test_colormap_size_option(self):
        """Test -C option to set colormap size."""
        result = subprocess.run(
            [TIFFMEDIAN, "-C", "128", "-f", self.input_file, self.output_file],
            capture_output=True, text=True
        )
        assert result.returncode == 0, f"tiffmedian -C 128 failed: {result.stderr}"
        assert os.path.exists(self.output_file)

    def test_compression_options(self):
        """Test various compression options."""
        for compression in ["none", "lzw", "packbits"]:
            output = str(self.tmp_path / f"output_{compression}.tif")
            result = subprocess.run(
                [TIFFMEDIAN, "-c", compression, "-f", self.input_file, output],
                capture_output=True, text=True
            )
            assert result.returncode == 0, \
                f"tiffmedian -c {compression} failed: {result.stderr}"
            assert os.path.exists(output), f"Output not created for {compression}"


class TestTiffmedianDifferentSizes:
    """Test tiffmedian with various image sizes."""

    @pytest.fixture(autouse=True)
    def setup(self, tmp_path):
        self.tmp_path = tmp_path

    @pytest.mark.parametrize("width,height", [
        (16, 16),
        (32, 32),
        (64, 64),
        (100, 50),
        (50, 100),
        (128, 128),
    ])
    def test_various_sizes(self, width, height):
        """Test processing images of various sizes."""
        input_file = str(self.tmp_path / f"input_{width}x{height}.tif")
        output_file = str(self.tmp_path / f"output_{width}x{height}.tif")

        if not create_simple_rgb_tiff(input_file, width, height):
            pytest.skip("Cannot create test image")

        result = subprocess.run(
            [TIFFMEDIAN, "-f", input_file, output_file],
            capture_output=True, text=True
        )
        assert result.returncode == 0, f"Failed for {width}x{height}: {result.stderr}"
        assert os.path.exists(output_file)


class TestTiffmedianHelp:
    """Test help and error handling."""

    def test_help_option(self):
        """Test -h shows help."""
        result = subprocess.run(
            [TIFFMEDIAN, "-h"],
            capture_output=True, text=True
        )
        assert result.returncode == 0
        assert "usage:" in result.stdout.lower() or "floyd" in result.stdout.lower()

    def test_missing_arguments(self):
        """Test that missing arguments cause error."""
        result = subprocess.run(
            [TIFFMEDIAN],
            capture_output=True, text=True
        )
        assert result.returncode != 0

    def test_nonexistent_input(self, tmp_path):
        """Test error on nonexistent input file."""
        result = subprocess.run(
            [TIFFMEDIAN, "-f", "/nonexistent/file.tif", str(tmp_path / "out.tif")],
            capture_output=True, text=True
        )
        assert result.returncode != 0
