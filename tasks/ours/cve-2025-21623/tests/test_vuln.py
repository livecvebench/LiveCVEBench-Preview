"""
Vulnerability tests for ClipBucket V5 template directory traversal.

These tests verify whether the vulnerability is exploitable:
- FAIL when vulnerable (unauthenticated users can change template dir)
- PASS when fixed (only authenticated admins can change template dir)
"""

import pytest
import requests
import os
import time

BASE_URL = os.environ.get("APP_URL", "http://localhost")

# Database connection settings from environment
DB_HOST = os.environ.get("DB_HOST", "localhost")
DB_USER = os.environ.get("DB_USER", "clipbucket")
DB_PASS = os.environ.get("DB_PASS", os.environ.get("MYSQL_PASSWORD", "clipbucket"))
DB_NAME = os.environ.get("DB_NAME", "clipbucket")


def get_db_connection():
    """Get a MySQL database connection."""
    import mysql.connector
    return mysql.connector.connect(
        host=DB_HOST,
        user=DB_USER,
        password=DB_PASS,
        database=DB_NAME
    )


def get_template_dir_from_db():
    """Get the current template_dir value from the database."""
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT value FROM cb_config WHERE name='template_dir'")
    result = cursor.fetchone()
    cursor.close()
    conn.close()
    return result[0] if result else None


def reset_template_dir():
    """Reset template_dir to the default value."""
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("UPDATE cb_config SET value='cb_28' WHERE name='template_dir'")
    conn.commit()
    cursor.close()
    conn.close()


class TestUnauthenticatedTemplateChange:
    """
    Test that unauthenticated users cannot change the template directory.
    These tests should FAIL when the vulnerability exists and PASS when fixed.
    """

    @pytest.fixture(autouse=True)
    def setup_and_teardown(self):
        """Ensure clean state before and after each test."""
        reset_template_dir()
        yield
        reset_template_dir()

    def test_basic_path_traversal_blocked(self):
        """
        Test that basic path traversal attack is blocked.
        Attacker tries to set template to ../../tmp
        """
        original_template = get_template_dir_from_db()
        assert original_template == "cb_28", f"Unexpected initial template: {original_template}"

        # Attempt path traversal attack via 404.php
        payload = "/../../../../../../../tmp"
        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"

        response = requests.get(attack_url, timeout=10)

        # Check if template was changed (vulnerability exists if changed)
        new_template = get_template_dir_from_db()

        assert new_template == "cb_28", \
            f"Vulnerability exists: template changed from 'cb_28' to '{new_template}'"

    def test_index_page_path_traversal_blocked(self):
        """
        Test that path traversal via index.php is blocked.
        """
        original_template = get_template_dir_from_db()
        assert original_template == "cb_28", f"Unexpected initial template: {original_template}"

        # Attempt attack via index.php
        payload = "/../../../../../../../tmp"
        attack_url = f"{BASE_URL}/index.php?template={payload}&set_template=1"

        response = requests.get(attack_url, timeout=10)

        new_template = get_template_dir_from_db()

        assert new_template == "cb_28", \
            f"Vulnerability exists: template changed via index.php to '{new_template}'"

    def test_encoded_path_traversal_blocked(self):
        """
        Test that URL-encoded path traversal is blocked.
        """
        original_template = get_template_dir_from_db()
        assert original_template == "cb_28", f"Unexpected initial template: {original_template}"

        # URL-encoded path traversal: %2f%2e%2e = /..
        payload = "%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2ftmp"
        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"

        response = requests.get(attack_url, timeout=10)

        new_template = get_template_dir_from_db()

        # Template should remain unchanged
        assert ".." not in new_template and new_template == "cb_28", \
            f"Vulnerability exists: template changed with encoded payload to '{new_template}'"

    def test_traversal_to_var_directory_blocked(self):
        """
        Test that traversal to /var directory is blocked.
        """
        original_template = get_template_dir_from_db()
        assert original_template == "cb_28", f"Unexpected initial template: {original_template}"

        # Try to traverse to /var (this directory exists in containers)
        payload = "/../../../../../../../var"
        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"

        response = requests.get(attack_url, timeout=10)

        new_template = get_template_dir_from_db()

        # If vulnerability exists, template will be changed to the traversal path
        assert new_template == "cb_28", \
            f"Vulnerability exists: template changed to '{new_template}'"

    def test_traversal_to_usr_directory_blocked(self):
        """
        Test that traversal to /usr directory is blocked.
        """
        original_template = get_template_dir_from_db()
        assert original_template == "cb_28", f"Unexpected initial template: {original_template}"

        # Try to traverse to /usr (this directory exists in containers)
        payload = "/../../../../../../../usr"
        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"

        response = requests.get(attack_url, timeout=10)

        new_template = get_template_dir_from_db()

        assert new_template == "cb_28", \
            f"Vulnerability exists: template changed to '{new_template}'"


class TestSensitiveDirectoryTraversal:
    """
    Test path traversal to sensitive system directories.
    """

    @pytest.fixture(autouse=True)
    def setup_and_teardown(self):
        """Ensure clean state before and after each test."""
        reset_template_dir()
        yield
        reset_template_dir()

    def test_traversal_to_etc_blocked(self):
        """
        Test that traversal to /etc directory is blocked.
        /etc contains sensitive configuration files.
        """
        payload = "/../../../../../../../etc"
        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"
        requests.get(attack_url, timeout=10)

        new_template = get_template_dir_from_db()
        assert new_template == "cb_28", \
            f"Vulnerability exists: template changed to sensitive directory '{new_template}'"

    def test_traversal_to_root_blocked(self):
        """
        Test that traversal to root directory is blocked.
        """
        payload = "/../../../../../../../"
        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"
        requests.get(attack_url, timeout=10)

        new_template = get_template_dir_from_db()
        assert new_template == "cb_28", \
            f"Vulnerability exists: template changed to root directory '{new_template}'"

    def test_traversal_persistence(self):
        """
        Test that malicious template change persists in database.
        This verifies the attack has real impact.
        """
        payload = "/../../../../../../../tmp"
        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"

        # First request
        requests.get(attack_url, timeout=10)
        first_check = get_template_dir_from_db()

        # Second request to different page (value should persist)
        requests.get(f"{BASE_URL}/index.php", timeout=10)
        second_check = get_template_dir_from_db()

        # Both checks should show cb_28 if vulnerability is fixed
        assert first_check == "cb_28" and second_check == "cb_28", \
            f"Vulnerability exists: malicious template persisted ({first_check}, {second_check})"


class TestSetTemplateParameter:
    """
    Test different set_template parameter variations.
    """

    @pytest.fixture(autouse=True)
    def setup_and_teardown(self):
        """Ensure clean state before and after each test."""
        reset_template_dir()
        yield
        reset_template_dir()

    def test_set_template_with_different_values(self):
        """
        Test set_template parameter with various truthy values.
        """
        payload = "/../../../../../../../tmp"

        # Test with different truthy values for set_template
        for set_val in ["1", "true", "yes", "on"]:
            reset_template_dir()
            attack_url = f"{BASE_URL}/404.php?template={payload}&set_template={set_val}"
            requests.get(attack_url, timeout=10)

            new_template = get_template_dir_from_db()
            assert new_template == "cb_28", \
                f"Vulnerability exists with set_template={set_val}: template changed to '{new_template}'"

class TestMultipleAttackVectors:
    """
    Test multiple attack entry points and payload variations.
    """

    @pytest.fixture(autouse=True)
    def setup_and_teardown(self):
        """Ensure clean state before and after each test."""
        reset_template_dir()
        yield
        reset_template_dir()

    def test_attack_via_different_pages(self):
        """
        Test that attack is blocked across different entry points.
        """
        pages_to_test = [
            "/404.php",
            "/index.php",
            "/view_channel.php",
            "/signup.php",
            "/videos.php"
        ]

        payload = "/../../../../../../../tmp"

        for page in pages_to_test:
            reset_template_dir()

            attack_url = f"{BASE_URL}{page}?template={payload}&set_template=1"

            try:
                response = requests.get(attack_url, timeout=10)
            except requests.exceptions.RequestException:
                # Page may not exist, which is fine
                continue

            new_template = get_template_dir_from_db()

            assert new_template == "cb_28", \
                f"Vulnerability exists via {page}: template changed to '{new_template}'"

    def test_repeated_attack_attempts(self):
        """
        Test that multiple rapid attack attempts are all blocked.
        """
        original_template = get_template_dir_from_db()

        payloads = [
            "/../../../../../../../tmp",
            "/../../../../../../var",
            "/../../../../../etc",
            "/../../../../usr",
            "/../../../home"
        ]

        for payload in payloads:
            attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"
            requests.get(attack_url, timeout=10)

        final_template = get_template_dir_from_db()

        assert final_template == "cb_28", \
            f"Vulnerability exists after repeated attacks: template is '{final_template}'"


class TestPathTraversalVariations:
    """
    Test various path traversal payload variations.
    """

    @pytest.fixture(autouse=True)
    def setup_and_teardown(self):
        """Ensure clean state before and after each test."""
        reset_template_dir()
        yield
        reset_template_dir()

    @pytest.mark.parametrize("payload", [
        # Basic path traversal to /tmp (should work - /tmp always exists)
        "/../../../../../../../tmp",
        # More levels of traversal
        "/../../../../../../../../../../../tmp",
    ])
    def test_various_traversal_payloads_blocked(self, payload):
        """
        Test that various path traversal payload variations are blocked.
        """
        reset_template_dir()

        attack_url = f"{BASE_URL}/404.php?template={payload}&set_template=1"

        response = requests.get(attack_url, timeout=10)

        new_template = get_template_dir_from_db()

        # Template should remain as default
        assert new_template == "cb_28", \
            f"Vulnerability exists with payload '{payload}': template changed to '{new_template}'"
