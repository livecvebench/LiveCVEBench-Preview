FROM php:8.2-apache

# 1. 安装系统依赖
RUN apt-get update && apt-get install -y \
    tmux asciinema gcc g++ wget \
    git unzip libzip-dev libpng-dev libonig-dev libxml2-dev libicu-dev sqlite3 vim \
    python3 python3-pip python3-venv

WORKDIR /app

# 2. 安装 PHP 扩展 (包含 calendar)
RUN docker-php-ext-install pdo_mysql mbstring zip exif pcntl bcmath gd intl calendar

# 3. 启用 Apache Rewrite
RUN a2enmod rewrite

# 4. [关键修复] 手动写入 Apache 站点配置
# 显式配置 /app/public 目录的权限，允许覆盖(.htaccess) 和 允许访问
RUN echo '<VirtualHost *:80>\n\
    DocumentRoot /app/public\n\
    <Directory /app/public>\n\
        Options Indexes FollowSymLinks\n\
        AllowOverride All\n\
        Require all granted\n\
    </Directory>\n\
    ErrorLog ${APACHE_LOG_DIR}/error.log\n\
    CustomLog ${APACHE_LOG_DIR}/access.log combined\n\
</VirtualHost>' > /etc/apache2/sites-available/000-default.conf

# 5. 安装 Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# 6. 克隆代码
RUN git clone https://github.com/unopim/unopim.git . && \
    git checkout c14eebe653aafd8dc713ca729165177e63315989^

# 7. 安装 PHP 依赖
RUN composer install --no-interaction --prefer-dist --optimize-autoloader

# 8. 预处理数据库配置
RUN cp .env.example .env && \
    sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/' .env && \
    sed -i 's/# DB_DATABASE=laravel/DB_DATABASE=\/app\/database\/database.sqlite/' .env && \
    mkdir -p database && \
    touch database/database.sqlite

# 9. Python 环境
RUN python3 -m venv /venv
ENV PATH="/venv/bin:$PATH"
RUN pip install pytest requests beautifulsoup4

# 10. [关键修复] 修改文件所有者
# Apache 运行在 www-data 用户下，必须把文件给它，否则会有各种读写权限问题
RUN chown -R www-data:www-data /app


EXPOSE 80
# CMD ["apache2-foreground"]