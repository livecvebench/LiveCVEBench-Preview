"""
Functionality tests for pdfminer.six CMapDB.

These tests verify that normal CMap loading functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""
import os
import pytest


class TestCMapDBFunctionality:
    """Test suite for CMapDB normal operations."""

    def test_identity_h_cmap(self):
        """Test that Identity-H CMap works correctly (built-in)."""
        from pdfminer.cmapdb import CMapDB, IdentityCMap

        cmap = CMapDB.get_cmap("Identity-H")
        assert cmap is not None
        assert isinstance(cmap, IdentityCMap)

    def test_identity_v_cmap(self):
        """Test that Identity-V CMap works correctly (built-in)."""
        from pdfminer.cmapdb import CMapDB, IdentityCMap

        cmap = CMapDB.get_cmap("Identity-V")
        assert cmap is not None
        assert isinstance(cmap, IdentityCMap)

    def test_one_byte_identity_h(self):
        """Test that OneByteIdentityH CMap works correctly (built-in)."""
        from pdfminer.cmapdb import CMapDB, IdentityCMapByte

        cmap = CMapDB.get_cmap("OneByteIdentityH")
        assert cmap is not None
        assert isinstance(cmap, IdentityCMapByte)

    def test_one_byte_identity_v(self):
        """Test that OneByteIdentityV CMap works correctly (built-in)."""
        from pdfminer.cmapdb import CMapDB, IdentityCMapByte

        cmap = CMapDB.get_cmap("OneByteIdentityV")
        assert cmap is not None
        assert isinstance(cmap, IdentityCMapByte)

    def test_cmap_not_found_exception(self):
        """Test that CMapNotFound is raised for invalid CMap names."""
        from pdfminer.cmapdb import CMapDB

        with pytest.raises(CMapDB.CMapNotFound):
            CMapDB.get_cmap("NonExistentCMap12345XYZ")

    def test_cmap_not_found_with_special_chars(self):
        """Test that CMapNotFound is raised for names with special characters."""
        from pdfminer.cmapdb import CMapDB

        with pytest.raises(CMapDB.CMapNotFound):
            CMapDB.get_cmap("Invalid/CMap*Name?")

    def test_cmap_cache_works(self):
        """Test that CMap caching works correctly."""
        from pdfminer.cmapdb import CMapDB

        # Clear cache to test fresh
        CMapDB._cmap_cache.clear()

        # Load same non-builtin CMap twice (Identity CMaps are special and don't use cache)
        try:
            cmap1 = CMapDB.get_cmap("UniGB-UCS2-H")
            cmap2 = CMapDB.get_cmap("UniGB-UCS2-H")
            # Should be the exact same object (from cache)
            assert cmap1 is cmap2
        except CMapDB.CMapNotFound:
            pytest.skip("UniGB-UCS2-H CMap not available for cache testing")

    def test_builtin_cmap_loading_unigb(self):
        """Test loading UniGB-UCS2-H CMap if available."""
        from pdfminer.cmapdb import CMapDB

        try:
            cmap = CMapDB.get_cmap("UniGB-UCS2-H")
            assert cmap is not None
        except CMapDB.CMapNotFound:
            pytest.skip("UniGB-UCS2-H CMap not available in this installation")

    def test_builtin_cmap_loading_90ms(self):
        """Test loading 90ms-RKSJ-H CMap if available."""
        from pdfminer.cmapdb import CMapDB

        try:
            cmap = CMapDB.get_cmap("90ms-RKSJ-H")
            assert cmap is not None
        except CMapDB.CMapNotFound:
            pytest.skip("90ms-RKSJ-H CMap not available in this installation")

    def test_null_byte_handling(self):
        """Test that null bytes in CMap names are handled."""
        from pdfminer.cmapdb import CMapDB

        # Null bytes should be stripped, and the name should still be valid
        # Identity-H\0 should become Identity-H
        try:
            cmap = CMapDB.get_cmap("Identity-H\0")
            assert cmap is not None
        except CMapDB.CMapNotFound:
            # If it raises CMapNotFound, that's also acceptable behavior
            pass


class TestCMapDBEnvironment:
    """Test CMapDB behavior with environment variables."""

    def test_default_cmap_path_works(self):
        """Test that default CMAP_PATH behavior works."""
        from pdfminer.cmapdb import CMapDB

        # Clear any custom CMAP_PATH
        original = os.environ.pop("CMAP_PATH", None)

        try:
            # Should still work with default paths
            cmap = CMapDB.get_cmap("Identity-H")
            assert cmap is not None
        finally:
            if original:
                os.environ["CMAP_PATH"] = original

    def test_empty_cmap_path(self):
        """Test behavior with empty CMAP_PATH."""
        from pdfminer.cmapdb import CMapDB

        original = os.environ.get("CMAP_PATH")
        os.environ["CMAP_PATH"] = ""

        try:
            # Identity CMaps are built-in and should still work
            cmap = CMapDB.get_cmap("Identity-H")
            assert cmap is not None
        finally:
            if original:
                os.environ["CMAP_PATH"] = original
            else:
                os.environ.pop("CMAP_PATH", None)
