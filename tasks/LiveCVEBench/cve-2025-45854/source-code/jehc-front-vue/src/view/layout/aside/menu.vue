<template>
  <ul class="menu-nav">
    <router-link
      to="/dashboard"
      v-slot="{ href, navigate, isActive, isExactActive }"
    >
      <li
        aria-haspopup="true"
        data-menu-toggle="hover"
        class="menu-item"
        :class="[
          isActive && 'menu-item-active',
          isExactActive && 'menu-item-active'
        ]"
      >
        <a :href="href" class="menu-link" @click="navigate">
          <i class="menu-icon flaticon2-architecture-and-city"></i>
          <span class="menu-text">首页</span>
        </a>
      </li>
    </router-link>

    <!-- <router-link
      to="/builder"
      v-slot="{ href, navigate, isActive, isExactActive }"
    >
      <li
        aria-haspopup="true"
        data-menu-toggle="hover"
        class="menu-item"
        :class="[
          isActive && 'menu-item-active',
          isExactActive && 'menu-item-active'
        ]"
      >
        <a :href="href" class="menu-link" @click="navigate">
          <i class="menu-icon flaticon2-expand"></i>
          <span class="menu-text">设置主题</span>
        </a>
      </li>
    </router-link> -->
    
    <template v-for="(item,index) in rootMenuData">
        <div :key="index" class="menuReplaceId">
          <li v-if="null != item.menu && rootMenuData.length > 0" class="menu-section" ><!--如果rootMenuData.length>1则只有一个系统时候不展示系统名-->
            <h4 class="menu-text">{{ item.sysName }}</h4>
            <i class="menu-icon flaticon-more-v2"></i>
          </li>          
          <!--增加隶属系统标题-->
          <itemMenu :menuDataList="item.menu"></itemMenu>
        </div>
    </template>
    
    
    <!-- 去除隶属系统标题 -->
    <!-- <itemMenu :menuDataList="menuData"></itemMenu> -->
  </ul>
</template>

<script>
import apiUtil from "@/core/util/apiUtil.js";
import itemMenu from "@/view/layout/aside/item-menu.vue";
import { handleNotify, handleAlert, handleConfirm, showWating, closeWating, doRouterTree,setLocalItem,removeLocalItem } from "@/core/util/jehcUtil.js";
export default {
  name: "KTMenu",
  data() {
    return {
      menuData: [],
      rootMenuData:[],//根目录（产品线）
      dymicRoutes: [],
    }
  },
  watch:{
    rootMenuData:{
          handler(newVal){
              this.$nextTick(() => {        
                  const list = document.querySelectorAll('.menuReplaceId')
                  for(let i in list){
                      let node = list[i];
                      if(node instanceof HTMLElement){
                      node.replaceWith(...node.childNodes)
                      }
                  }
              });
          }
          
      }
  },
  mounted() {
    this.initJEHCIndexList();
  },
  components: {
    itemMenu,
  },
  methods: {
    hasActiveChildren(match) {
      return this.$route["path"].indexOf(match) !== -1;
    },
    initJEHCIndexList() {          
      const JEHC_ROUTER = "Routers";
      const JEHC_ROUTER_NEED_LOAD = "JEHC_ROUTER_NEED_LOAD"; 
      showWating({ renderBody: "jehcIndexBody", message: "正在加载资源中，请稍后..." });
      apiUtil.get(process.env.VUE_APP_OAUTH_API + "/init/v1").then(({ data }) => {
        if (null != data.data && null != data.data.menuEntity) {
          let result = data.data.menuEntity;
          let dataMenuList = [];
          for (let i in result) {
            let arr = result[i];
            this.rootMenuData.push(arr);
            if (null != arr && "" != arr) {
              try {
                let menuArr = JSON.parse(arr.menuList);
                if (null != menuArr && menuArr.length > 0) {
                  for (let j in menuArr) {
                    dataMenuList.push(menuArr[j]);
                  }                  
                }
              } catch (e) {
                console.log("主资源菜单转换异常：", e);
                this.menuData = [];
              }
            }
          }
          if (null != dataMenuList && "" != dataMenuList) {
            this.toTreeData(dataMenuList);
            //处理将一级所属系统放出（新增）
            for(let i in this.rootMenuData){
              for(let j in this.menuData){
                  if(this.menuData[j].sysModeId == this.rootMenuData[i].sysModeId){    
                    if(!this.rootMenuData[i].menu){
                      this.rootMenuData[i].menu = [];
                    }
                    this.rootMenuData[i].menu.push(this.menuData[j]);
                  }
              }
            }
            // for(let i in this.rootMenuData){
            //   console.log("this.rootMenuData---", this.rootMenuData[i]);
            // }
            setLocalItem(JEHC_ROUTER, JSON.stringify(dataMenuList));
            setLocalItem(JEHC_ROUTER_NEED_LOAD, 1);
          }
        }
      });
    },
    toTreeData(data) {
      const parent = []
      for (let i = 0; i < data.length; i++) {
        if ("0" === data[i].parentId) {
          parent.push({
            ...data[i],
            id: data[i].id,
            label: data[i].name,
            componentRouter: data[i].componentRouter,
            componentRouterTo: data[i].componentRouterTo,
            componentIcon: data[i].componentIcon,
            componentJumpType: data[i].componentJumpType,
            componentHideMenu: data[i].componentHideMenu,
            componentOpenNewPage: data[i].componentOpenNewPage,
            componentOpenStyle: data[i].componentOpenStyle,
            sort: data[i].sort,
            leaf: data[i].leaf,
            sysModuleId: data[i].sysModuleId,
            sysModulesMode: data[i].sysModulesMode,
            children: []
          })
        }
      }
      this.childrenTree(parent, data)
    },
    childrenTree(parent, data) {
      if (data) {
        for (let i = 0; i < parent.length; i++) {
          for (let j = 0; j < data.length; j++) {
            if (parent[i].id === data[j].parentId) {
              parent[i].children.push({
                ...data[j],
                id: data[j].id,
                label: data[j].name,
                componentRouter: data[j].componentRouter,
                componentRouterTo: data[j].componentRouterTo,
                componentIcon: data[j].componentIcon,
                componentJumpType: data[j].componentJumpType,
                componentHideMenu: data[j].componentHideMenu,
                componentOpenNewPage: data[j].componentOpenNewPage,
                componentOpenStyle: data[j].componentOpenStyle,
                sort: data[j].sort,
                leaf: data[j].leaf,
                sysModuleId: data[j].sysModuleId,
                sysModulesMode: data[j].sysModulesMode,
                children: []
              })
            }
          }
          this.childrenTree(parent[i].children, data)
        }
      }
      this.menuData = parent
    },
  }
};
</script>
