#!/bin/bash
# Solution script for URL Shortify plugin input validation fix
# This script adds the sanitize_id() function to Helper.php and modifies
# Links_Table.php to use it for sanitizing the id parameter.

set -e

PLUGIN_DIR="/var/www/html/wp-content/plugins/url-shortify"
LINKS_TABLE_FILE="$PLUGIN_DIR/lite/includes/Admin/Links_Table.php"
HELPER_FILE="$PLUGIN_DIR/lite/includes/Helper.php"

echo "Applying fix to URL Shortify plugin..."

# Step 1: Add sanitize_id() function to Helper.php
# We need to add this function before the final closing brace of the class

# Check if sanitize_id already exists (idempotency)
if ! grep -q "public static function sanitize_id" "$HELPER_FILE"; then
    echo "Adding sanitize_id() function to Helper.php..."

    # Create the function to add
    SANITIZE_FUNCTION='
    /**
     * Sanitize Link ID.
     *
     * @param mixed $raw Raw input.
     *
     * @return int Sanitized link ID.
     *
     * @since 1.11.3
     */
    public static function sanitize_id( $raw ) {
        if ( is_array( $raw ) ) {
            return 0;
        }
        $raw = trim( (string) $raw );
        if ( $raw === '\'''\'' ) {
            return 0;
        }
        // Only accept positive integers (no hex, no scientific, no injection)
        if ( ctype_digit( $raw ) ) {
            return absint( $raw );
        }

        return 0;
    }
'

    # Find the last closing brace and insert the function before it
    # Use a temporary file approach for reliability
    cp "$HELPER_FILE" "$HELPER_FILE.bak"

    # Get the line number of the last closing brace
    LAST_LINE=$(tail -n 1 "$HELPER_FILE")

    # Remove the last line (closing brace) and add function + closing brace
    head -n -1 "$HELPER_FILE" > "$HELPER_FILE.tmp"
    echo "$SANITIZE_FUNCTION" >> "$HELPER_FILE.tmp"
    echo "}" >> "$HELPER_FILE.tmp"
    mv "$HELPER_FILE.tmp" "$HELPER_FILE"

    echo "sanitize_id() function added to Helper.php"
else
    echo "sanitize_id() function already exists in Helper.php"
fi

# Step 2: Modify Links_Table.php to use sanitize_id()
# The vulnerable code pattern:
#   if ( 'new' === $action || 'edit' === $action ) {
#       $link_id = Helper::get_request_data( 'id', null );
#       $this->render_form( $link_id );
#
# Should become:
#   $link_id_raw = Helper::get_request_data( 'id', null );
#   $link_id = Helper::sanitize_id( $link_id_raw );
#   if ( 'new' === $action || 'edit' === $action ) {
#       $this->render_form( $link_id );

# Check if already fixed (idempotency)
if grep -q "sanitize_id.*link_id_raw" "$LINKS_TABLE_FILE"; then
    echo "Links_Table.php already patched"
else
    echo "Patching Links_Table.php..."

    # Create a backup
    cp "$LINKS_TABLE_FILE" "$LINKS_TABLE_FILE.bak"

    # Use sed to make the changes
    # First, replace the pattern where $link_id is assigned inside the if block
    # We need to:
    # 1. Add the sanitization before the if block
    # 2. Remove the $link_id assignment from inside the if block

    # Pattern to find the vulnerable code block in render() function
    # Replace the if block that contains the vulnerable assignment

    sed -i "
    /if ( 'new' === \\\$action || 'edit' === \\\$action ) {/ {
        # Check if next line has the vulnerable assignment
        N
        /\\\$link_id = Helper::get_request_data( 'id', null );/ {
            # Replace the pattern
            s/if ( 'new' === \\\$action || 'edit' === \\\$action ) {\n[[:space:]]*\\\$link_id = Helper::get_request_data( 'id', null );/\$link_id_raw = Helper::get_request_data( 'id', null );\n\n            \$link_id = Helper::sanitize_id( \$link_id_raw );\n\n\t\t\tif ( 'new' === \$action || 'edit' === \$action ) {/
        }
    }
    " "$LINKS_TABLE_FILE"

    # Verify the change was made
    if grep -q "sanitize_id.*link_id_raw" "$LINKS_TABLE_FILE"; then
        echo "Links_Table.php patched successfully"
    else
        echo "Sed approach failed, trying alternative method..."

        # Restore from backup
        cp "$LINKS_TABLE_FILE.bak" "$LINKS_TABLE_FILE"

        # Alternative: Use Python for more reliable patching
        python3 << 'PYTHON_SCRIPT'
import re

links_table_file = "/var/www/html/wp-content/plugins/url-shortify/lite/includes/Admin/Links_Table.php"

with open(links_table_file, 'r') as f:
    content = f.read()

# Pattern to find the vulnerable code in render() function
# Looking for:
#   if ( 'new' === $action || 'edit' === $action ) {
#       $link_id = Helper::get_request_data( 'id', null );
#       $this->render_form( $link_id );

old_pattern = r"(if \( 'new' === \$action \|\| 'edit' === \$action \) \{)\s*\n\s*(\$link_id = Helper::get_request_data\( 'id', null \);)\s*\n\s*(\$this->render_form\( \$link_id \);)"

new_code = """$link_id_raw = Helper::get_request_data( 'id', null );

            $link_id = Helper::sanitize_id( $link_id_raw );

			if ( 'new' === $action || 'edit' === $action ) {
				$this->render_form( $link_id );"""

# Try to match and replace
if re.search(old_pattern, content):
    content = re.sub(old_pattern, new_code, content)
    with open(links_table_file, 'w') as f:
        f.write(content)
    print("Python patch applied successfully")
else:
    # Try a simpler approach - just look for the vulnerable line pattern
    # and insert sanitization before it

    # Find where we need to insert
    render_func_pattern = r"(\$action = Helper::get_request_data\( 'action' \);)\s*\n\s*(if \( 'new' === \$action)"

    if re.search(render_func_pattern, content):
        replacement = r"""\1

            $link_id_raw = Helper::get_request_data( 'id', null );

            $link_id = Helper::sanitize_id( $link_id_raw );

			\2"""
        content = re.sub(render_func_pattern, replacement, content)

        # Now remove the old $link_id assignment
        content = re.sub(
            r"\n\s*\$link_id = Helper::get_request_data\( 'id', null \);\s*\n\s*\$this->render_form\( \$link_id \);",
            "\n\n\t\t\t\t$this->render_form( $link_id );",
            content
        )

        with open(links_table_file, 'w') as f:
            f.write(content)
        print("Python patch (alternative) applied successfully")
    else:
        print("Could not find pattern to patch")
        exit(1)
PYTHON_SCRIPT
    fi
fi

# Clean up backup files
rm -f "$LINKS_TABLE_FILE.bak" "$HELPER_FILE.bak" 2>/dev/null || true

echo "Fix applied successfully!"

# No need to restart PHP-FPM for PHP file changes - they take effect immediately
echo "Done."
