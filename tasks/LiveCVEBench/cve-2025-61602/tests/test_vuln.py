"""
Vulnerability Tests for Chat Message Reaction Handlers

These tests verify the vulnerability status:
- FAIL in vulnerable state (vulnerability is exploitable - invalid reactionEmojiId accepted)
- PASS in fixed state (vulnerability is mitigated - reactionEmojiId removed or validated)

The vulnerability allows arbitrary strings to be passed as reactionEmojiId which causes
client-side crashes when they try to look up invalid emoji IDs.
"""

import subprocess
import json
import pytest
import os


def run_ts_test(test_code: str) -> dict:
    """
    Execute TypeScript test code and return the result.
    """
    test_file = "/tmp/ts_vuln_test_runner.ts"

    full_code = '''
import buildSendReaction from '/app/src/actions/chatSendMessageReaction';
import buildDeleteReaction from '/app/src/actions/chatDeleteMessageReaction';

const sessionVars = {
    'x-hasura-meetingid': 'meeting-123',
    'x-hasura-userid': 'user-456',
    'x-hasura-moderatorinmeeting': 'meeting-123',
    'x-hasura-presenterinmeeting': ''
};

async function runTest() {
    try {
''' + test_code + '''
    } catch (e: any) {
        console.log(JSON.stringify({
            success: false,
            error: e.message,
            errorType: e.constructor.name,
            status: e.status || null
        }));
    }
}

runTest();
'''

    with open(test_file, 'w') as f:
        f.write(full_code)

    result = subprocess.run(
        ['npx', 'tsx', test_file],
        capture_output=True,
        text=True,
        cwd='/app',
        timeout=30
    )

    output = result.stdout.strip()
    if output:
        try:
            return json.loads(output.split('\n')[-1])
        except json.JSONDecodeError:
            pass

    return {
        'success': False,
        'output': result.stdout,
        'error': result.stderr
    }


class TestSendReactionVulnerability:
    """
    Test that reactionEmojiId is NOT passed through to the body.

    In the vulnerable version, reactionEmojiId is accepted and included in the body,
    which causes downstream client crashes when they receive invalid IDs.

    In the fixed version, reactionEmojiId is removed entirely from the message flow.
    """

    def test_malformed_reaction_emoji_id_not_in_body(self):
        """
        The body should NOT contain reactionEmojiId (the problematic field).

        Vulnerable: body includes reactionEmojiId -> FAIL
        Fixed: body does NOT include reactionEmojiId -> PASS
        """
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: 'totally_invalid_emoji_id_12345'
        };

        const message = buildSendReaction(sessionVars, input);
        const bodyKeys = Object.keys(message.body);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId,
            bodyKeys: bodyKeys,
            body: message.body
        }));
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result['hasReactionEmojiId'] == False, \
            f"VULNERABLE: reactionEmojiId should NOT be in body but was found. Body keys: {result['bodyKeys']}"

    def test_invalid_id_with_special_chars_not_propagated(self):
        """
        Special characters in reactionEmojiId should not reach the body.

        Vulnerable: allows <script>alert('xss')</script> as reactionEmojiId -> FAIL
        Fixed: reactionEmojiId not in body -> PASS
        """
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: "<script>alert('xss')</script>"
        };

        const message = buildSendReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId,
            bodyKeys: Object.keys(message.body)
        }));
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result['hasReactionEmojiId'] == False, \
            f"VULNERABLE: Malicious reactionEmojiId should NOT be in body"

    def test_sql_injection_like_id_not_propagated(self):
        """
        SQL injection-like strings in reactionEmojiId should not reach the body.

        Vulnerable: allows "'; DROP TABLE--" as reactionEmojiId -> FAIL
        Fixed: reactionEmojiId not in body -> PASS
        """
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: "'; DROP TABLE reactions;--"
        };

        const message = buildSendReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId,
            bodyKeys: Object.keys(message.body)
        }));
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result['hasReactionEmojiId'] == False, \
            f"VULNERABLE: SQL-like reactionEmojiId should NOT be in body"

    def test_very_long_id_not_propagated(self):
        """
        Extremely long reactionEmojiId should not reach the body.

        Vulnerable: allows long string as reactionEmojiId -> FAIL
        Fixed: reactionEmojiId not in body -> PASS
        """
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: 'A'.repeat(10000)
        };

        const message = buildSendReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId,
            bodyKeys: Object.keys(message.body)
        }));
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result['hasReactionEmojiId'] == False, \
            f"VULNERABLE: Long reactionEmojiId should NOT be in body"

    def test_unicode_injection_id_not_propagated(self):
        """
        Unicode/special character injection in reactionEmojiId should not reach the body.

        Vulnerable: allows arbitrary unicode strings -> FAIL
        Fixed: reactionEmojiId not in body -> PASS
        """
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: '\\u0000\\u001f\\x00null_bytes'
        };

        const message = buildSendReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId,
            bodyKeys: Object.keys(message.body)
        }));
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result['hasReactionEmojiId'] == False, \
            f"VULNERABLE: Unicode injection reactionEmojiId should NOT be in body"


class TestDeleteReactionVulnerability:
    """
    Test that reactionEmojiId is NOT passed through in delete reactions.
    """

    def test_delete_reaction_no_emoji_id_in_body(self):
        """
        Delete reaction body should NOT contain reactionEmojiId.

        Vulnerable: body includes reactionEmojiId -> FAIL
        Fixed: body does NOT include reactionEmojiId -> PASS
        """
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: 'malicious_delete_id'
        };

        const message = buildDeleteReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId,
            bodyKeys: Object.keys(message.body)
        }));
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result['hasReactionEmojiId'] == False, \
            f"VULNERABLE: reactionEmojiId should NOT be in delete body"

    def test_delete_with_path_traversal_id_not_propagated(self):
        """
        Path traversal-like reactionEmojiId should not reach the body.

        Vulnerable: allows "../../../etc/passwd" as reactionEmojiId -> FAIL
        Fixed: reactionEmojiId not in body -> PASS
        """
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: '../../../etc/passwd'
        };

        const message = buildDeleteReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId,
            bodyKeys: Object.keys(message.body)
        }));
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result['hasReactionEmojiId'] == False, \
            f"VULNERABLE: Path traversal reactionEmojiId should NOT be in body"


class TestValidationRequirements:
    """
    Test that the validation changes are properly implemented.
    """

    def test_send_reaction_required_fields_only_three(self):
        """
        After fix, only chatId, messageId, and reactionEmoji should be required.

        Vulnerable: requires 4 fields including reactionEmojiId -> FAIL
        Fixed: requires only 3 fields -> PASS
        """
        result = run_ts_test('''
        // Try sending without reactionEmojiId - should succeed in fixed version
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€'
            // NO reactionEmojiId
        };

        try {
            const message = buildSendReaction(sessionVars, input);
            console.log(JSON.stringify({
                success: true,
                worked: true,
                bodyKeys: Object.keys(message.body)
            }));
        } catch (e: any) {
            // If it throws because reactionEmojiId is missing, it's vulnerable
            console.log(JSON.stringify({
                success: true,
                worked: false,
                error: e.message
            }));
        }
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result.get('worked') == True, \
            f"VULNERABLE: Should work without reactionEmojiId but got error: {result.get('error')}"

    def test_delete_reaction_required_fields_only_three(self):
        """
        After fix, delete should also only require chatId, messageId, and reactionEmoji.

        Vulnerable: requires 4 fields including reactionEmojiId -> FAIL
        Fixed: requires only 3 fields -> PASS
        """
        result = run_ts_test('''
        // Try deleting without reactionEmojiId - should succeed in fixed version
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€'
            // NO reactionEmojiId
        };

        try {
            const message = buildDeleteReaction(sessionVars, input);
            console.log(JSON.stringify({
                success: true,
                worked: true,
                bodyKeys: Object.keys(message.body)
            }));
        } catch (e: any) {
            // If it throws because reactionEmojiId is missing, it's vulnerable
            console.log(JSON.stringify({
                success: true,
                worked: false,
                error: e.message
            }));
        }
        ''')

        assert result['success'] == True, f"Test execution failed: {result}"
        assert result.get('worked') == True, \
            f"VULNERABLE: Should work without reactionEmojiId but got error: {result.get('error')}"


class TestMultiplePayloadVariations:
    """
    Test various malicious payload patterns to ensure they don't reach the body.
    """

    def test_json_injection_not_propagated(self):
        """JSON-like injection should not reach the body"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: '{"malicious": true, "command": "rm -rf /"}'
        };

        const message = buildSendReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId
        }));
        ''')

        assert result['success'] == True
        assert result['hasReactionEmojiId'] == False, "VULNERABLE: JSON injection should NOT be in body"

    def test_empty_string_id_not_propagated(self):
        """Empty string reactionEmojiId should not reach the body"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: ''
        };

        const message = buildSendReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId
        }));
        ''')

        assert result['success'] == True
        assert result['hasReactionEmojiId'] == False, "VULNERABLE: Empty reactionEmojiId should NOT be in body"

    def test_whitespace_only_id_not_propagated(self):
        """Whitespace-only reactionEmojiId should not reach the body"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'ðŸ˜€',
            reactionEmojiId: '   \\t\\n   '
        };

        const message = buildSendReaction(sessionVars, input);
        const hasReactionEmojiId = 'reactionEmojiId' in message.body;

        console.log(JSON.stringify({
            success: true,
            hasReactionEmojiId: hasReactionEmojiId
        }));
        ''')

        assert result['success'] == True
        assert result['hasReactionEmojiId'] == False, "VULNERABLE: Whitespace reactionEmojiId should NOT be in body"
