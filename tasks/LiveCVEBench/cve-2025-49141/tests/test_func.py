#!/usr/bin/env python3
"""
Functional tests for HAXcms Git integration.
These tests verify basic application functionality and should pass
in both vulnerable and fixed states.
"""

import requests
import pytest
import time

BASE_URL = "http://localhost"
TIMEOUT = 10


def get_jwt_token():
    """Get authentication token from login endpoint"""
    try:
        resp = requests.post(
            f"{BASE_URL}/system/api/login",
            json={"username": "admin", "password": "admin"},
            timeout=TIMEOUT
        )
        if resp.status_code == 200:
            data = resp.json()
            return data.get("jwt")
    except Exception as e:
        print(f"Login error: {e}")
    return None


def is_error_response(data):
    """Check if the response indicates an error/rejection"""
    if isinstance(data, str):
        # String responses like "invalid url" indicate rejection
        return "invalid" in data.lower() or "error" in data.lower()
    if isinstance(data, dict):
        # Dict responses with __failed or status codes indicate rejection
        if "__failed" in data:
            return True
        if data.get("status") == 403:
            return True
        if data.get("data") == "Invalid token":
            return True
    return False


class TestBasicFunctionality:
    """Test basic HAXcms functionality"""

    def test_application_is_running(self):
        """Test that the HAXcms application is accessible"""
        resp = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        assert resp.status_code == 200, "Application should be running and accessible"

    def test_login_endpoint_exists(self):
        """Test that login endpoint exists and responds"""
        resp = requests.post(
            f"{BASE_URL}/system/api/login",
            json={"username": "admin", "password": "admin"},
            timeout=TIMEOUT
        )
        assert resp.status_code == 200, "Login endpoint should respond"
        data = resp.json()
        assert "jwt" in data, "Login should return a JWT token"

    def test_login_with_invalid_credentials_fails(self):
        """Test that invalid credentials are rejected"""
        resp = requests.post(
            f"{BASE_URL}/system/api/login",
            json={"username": "invalid", "password": "wrongpassword"},
            timeout=TIMEOUT
        )
        data = resp.json()
        # Invalid credentials should either return 403 or a failed status
        assert resp.status_code == 403 or is_error_response(data), \
            "Invalid credentials should be rejected"

    def test_api_requires_authentication(self):
        """Test that gitImportSite endpoint requires authentication"""
        resp = requests.post(
            f"{BASE_URL}/system/api/gitImportSite",
            json={"site": {"git": {"url": "http://example.com/test.git"}}},
            timeout=TIMEOUT
        )
        data = resp.json()
        # Without JWT, the request should fail with auth error
        # HAXcms returns {"data": "Invalid token", "status": 403} for missing JWT
        assert is_error_response(data) or resp.status_code == 403, \
            f"API should require authentication, got: {data}"


class TestURLValidation:
    """Test URL validation in gitImportSite endpoint"""

    def test_invalid_url_format_rejected(self):
        """Test that invalid URL format is rejected"""
        token = get_jwt_token()
        assert token is not None, "Should be able to get JWT token"

        # URL without valid format
        resp = requests.post(
            f"{BASE_URL}/system/api/gitImportSite?jwt={token}",
            json={"site": {"git": {"url": "not-a-valid-url"}}},
            timeout=TIMEOUT
        )
        data = resp.json()
        # Invalid URL should fail validation - response is "invalid url" string
        assert is_error_response(data), \
            f"Invalid URL format should be rejected, got: {data}"

    def test_url_without_git_extension_rejected(self):
        """Test that URLs without .git are rejected"""
        token = get_jwt_token()
        assert token is not None, "Should be able to get JWT token"

        # Valid URL format but no .git
        resp = requests.post(
            f"{BASE_URL}/system/api/gitImportSite?jwt={token}",
            json={"site": {"git": {"url": "http://example.com/repo"}}},
            timeout=TIMEOUT
        )
        data = resp.json()
        # URL without .git should fail validation
        assert is_error_response(data), \
            f"URL without .git should be rejected, got: {data}"

    def test_valid_url_format_accepted(self):
        """Test that a properly formatted git URL passes initial validation"""
        token = get_jwt_token()
        assert token is not None, "Should be able to get JWT token"

        # Valid URL format with .git
        # Note: The actual git operation will fail (server doesn't exist)
        # but it should pass URL validation
        # Use longer timeout since git operations can be slow
        try:
            resp = requests.post(
                f"{BASE_URL}/system/api/gitImportSite?jwt={token}",
                json={"site": {"git": {"url": "http://127.0.0.1/test.git"}}},
                timeout=30
            )
            # The request should at least be processed (may fail at git level)
            # Accept 200 (success), 500 (git error), or any other code that indicates
            # the URL passed validation and reached the git operation
            assert resp.status_code in [200, 500], \
                f"Valid URL format should be processed, got {resp.status_code}"
        except requests.exceptions.Timeout:
            # Timeout is acceptable - it means the request reached the git operation
            # which takes time when connecting to an unreachable server
            pass

    def test_empty_url_rejected(self):
        """Test that empty URL is rejected"""
        token = get_jwt_token()
        assert token is not None, "Should be able to get JWT token"

        resp = requests.post(
            f"{BASE_URL}/system/api/gitImportSite?jwt={token}",
            json={"site": {"git": {"url": ""}}},
            timeout=TIMEOUT
        )
        data = resp.json()
        assert is_error_response(data), \
            f"Empty URL should be rejected, got: {data}"


class TestMalformedRequests:
    """Test handling of malformed requests"""

    def test_missing_site_parameter(self):
        """Test that missing site parameter is handled gracefully"""
        token = get_jwt_token()
        assert token is not None, "Should be able to get JWT token"

        resp = requests.post(
            f"{BASE_URL}/system/api/gitImportSite?jwt={token}",
            json={},
            timeout=TIMEOUT
        )
        # Should not crash, should return some error response
        assert resp.status_code in [200, 400, 500], \
            "Missing parameters should be handled gracefully"

    def test_missing_git_url_parameter(self):
        """Test that missing git URL parameter is handled"""
        token = get_jwt_token()
        assert token is not None, "Should be able to get JWT token"

        resp = requests.post(
            f"{BASE_URL}/system/api/gitImportSite?jwt={token}",
            json={"site": {"git": {}}},
            timeout=TIMEOUT
        )
        # Should handle missing URL gracefully
        assert resp.status_code in [200, 400, 500], \
            "Missing URL should be handled gracefully"
