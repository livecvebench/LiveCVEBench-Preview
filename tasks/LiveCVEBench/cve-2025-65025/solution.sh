#!/bin/bash
# Solution script for esm.sh path traversal vulnerability
# Fixes the tarslip vulnerability by adding path validation to ensure extracted
# files cannot escape the destination directory.

set -e

# Ensure Go is in PATH (golang Docker image puts it in /usr/local/go/bin)
export PATH=$PATH:/usr/local/go/bin

cd /app

echo "=== Applying path traversal fix to esm.sh ==="

# The vulnerability is in server/git.go in the ghInstall function
# The line "fp := path.Join(rootDir, hname)" is vulnerable because
# hname can contain "../" sequences that escape the rootDir.
#
# The fix must:
# 1. Clean the path to normalize it
# 2. Join with rootDir
# 3. Verify the result stays within rootDir (using strings.HasPrefix)

# Check if the file exists
if [ ! -f "/app/server/git.go" ]; then
    echo "Error: /app/server/git.go not found"
    exit 1
fi

# Check if the fix has already been applied (look for the HasPrefix check)
if grep -q "strings.HasPrefix(fp, rootDir)" /app/server/git.go; then
    echo "Fix already applied to git.go"
else
    echo "Applying fix to git.go..."

    # We need to add a proper path traversal check after the path.Join
    # The fix adds: clean the path, join, then validate with strings.HasPrefix

    # Create a patch that replaces the vulnerable extraction logic with a safe version
    cat > /tmp/git_fix.patch << 'PATCHEOF'
--- a/server/git.go
+++ b/server/git.go
@@ -88,13 +88,19 @@ func ghInstall(wd, name, hash string) (err error) {
 	tr := tar.NewReader(unziped)
 	rootDir := path.Join(wd, "node_modules", name)
 	for {
 		h, err := tr.Next()
 		if err == io.EOF {
 			break
 		}
 		if err != nil {
 			return err
 		}
 		// strip tarball root dir
 		hname := strings.Join(strings.Split(h.Name, "/")[1:], "/")
 		if strings.HasPrefix(hname, ".") {
 			continue
 		}
-		fp := path.Join(rootDir, hname)
+		// Fix CVE-2025-65025: Prevent path traversal by validating the final path
+		fp := path.Join(rootDir, path.Clean(hname))
+		// Ensure the file path stays within rootDir to prevent directory traversal attacks
+		if !strings.HasPrefix(fp, rootDir) {
+			continue
+		}
 		if h.Typeflag == tar.TypeDir {
 			ensureDir(fp)
 			continue
PATCHEOF

    # Apply via sed - more reliable than patch in this case
    # First, replace the vulnerable line and add the security check

    # Step 1: Replace fp := path.Join(rootDir, hname) with the fixed version
    sed -i 's/fp := path\.Join(rootDir, hname)/fp := path.Join(rootDir, path.Clean(hname))\n\t\t\/\/ Prevent path traversal - ensure path stays within rootDir\n\t\tif !strings.HasPrefix(fp, rootDir) {\n\t\t\tcontinue\n\t\t}/g' /app/server/git.go

    # Verify the fix was applied
    if grep -q "strings.HasPrefix(fp, rootDir)" /app/server/git.go; then
        echo "Fix successfully applied to git.go"
    else
        echo "Error: Fix was not applied correctly to git.go"
        echo "Trying alternative approach..."

        # Restore original file and try a different approach
        # Read the vulnerable line context and replace more carefully

        # Use a Go script to apply the fix since sed can be tricky with multiline
        cat > /tmp/apply_fix.go << 'GOEOF'
package main

import (
    "os"
    "strings"
)

func main() {
    content, err := os.ReadFile("/app/server/git.go")
    if err != nil {
        os.Exit(1)
    }

    old := "fp := path.Join(rootDir, hname)"
    new := `fp := path.Join(rootDir, path.Clean(hname))
		// Prevent path traversal - ensure path stays within rootDir
		if !strings.HasPrefix(fp, rootDir) {
			continue
		}`

    newContent := strings.Replace(string(content), old, new, 1)

    err = os.WriteFile("/app/server/git.go", []byte(newContent), 0644)
    if err != nil {
        os.Exit(1)
    }
}
GOEOF
        go run /tmp/apply_fix.go

        if grep -q "strings.HasPrefix(fp, rootDir)" /app/server/git.go; then
            echo "Fix successfully applied via Go script"
        else
            echo "Error: Could not apply fix"
            exit 1
        fi
    fi
fi

echo "=== Rebuilding application ==="

# Rebuild the Go application with the fix
if [ -f "/app/main.go" ]; then
    echo "Building esmd..."
    cd /app
    go build -o esmd main.go
    echo "Build completed successfully"
else
    echo "Warning: main.go not found, skipping rebuild"
fi

echo "=== Fix applied successfully ==="
echo "The tar extraction function now validates that extracted file paths"
echo "stay within the destination directory, preventing path traversal attacks."
