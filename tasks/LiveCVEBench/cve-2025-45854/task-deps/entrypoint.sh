#!/bin/bash

# Entrypoint script for JEHC-BPM application
# This script manages the Java application with restart capability

JAR_PATH="/app/jehc-djshi/jehc-api/target/jehc-api.jar"
PROFILE="docker"
PID_FILE="/tmp/app.pid"

# Function to start the application
start_app() {
    echo "Starting JEHC-BPM application..."
    java -Xmx1024m -Xms512m -jar "$JAR_PATH" --spring.profiles.active=$PROFILE &
    echo $! > $PID_FILE
    echo "Application started with PID $(cat $PID_FILE)"
}

# Function to stop the application
stop_app() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat $PID_FILE)
        if kill -0 $PID 2>/dev/null; then
            echo "Stopping application with PID $PID..."
            kill $PID
            wait $PID 2>/dev/null
            echo "Application stopped"
        fi
        rm -f $PID_FILE
    fi
}

# Trap signals for graceful shutdown
trap 'stop_app; exit 0' SIGTERM SIGINT

# Main loop - keeps container running and allows restart
while true; do
    start_app

    # Wait for the application process
    wait $(cat $PID_FILE) 2>/dev/null

    echo "Application exited, restarting in 3 seconds..."
    sleep 3
done
