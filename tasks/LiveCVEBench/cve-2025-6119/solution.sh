#!/bin/bash
set -e

# Fix the memory bug in BVHLoader.cpp
# The issue is that a reference to a vector element becomes invalid after
# recursive calls that may cause the vector to reallocate.
# Solution: Use an index instead of a reference.

FILE="/app/code/AssetLib/BVH/BVHLoader.cpp"

echo "Applying fix to $FILE..."

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "Error: File not found: $FILE"
    exit 1
fi

# Replace the reference declaration with an index
# Original: Node &internNode = mNodes.back();
# Fixed:    size_t nodeIndex = mNodes.size() - 1;
sed -i 's/Node &internNode = mNodes\.back();/size_t nodeIndex = mNodes.size() - 1;/g' "$FILE"

# Replace all uses of internNode with mNodes[nodeIndex]
# Original: ReadNodeOffset(internNode);
# Fixed:    ReadNodeOffset(mNodes[nodeIndex]);
sed -i 's/ReadNodeOffset(internNode)/ReadNodeOffset(mNodes[nodeIndex])/g' "$FILE"

# Original: ReadNodeChannels(internNode);
# Fixed:    ReadNodeChannels(mNodes[nodeIndex]);
sed -i 's/ReadNodeChannels(internNode)/ReadNodeChannels(mNodes[nodeIndex])/g' "$FILE"

echo "Fix applied: Replaced reference with index-based access in ReadNode()"

# Rebuild the project with ASAN
echo "Rebuilding assimp with the fix..."
cd /app/build

# Clean and rebuild
cmake --build . --target assimp --parallel $(nproc) 2>&1 || {
    echo "Rebuild failed, attempting full rebuild..."
    cmake .. -DCMAKE_BUILD_TYPE=Debug \
             -DCMAKE_C_COMPILER=clang \
             -DCMAKE_CXX_COMPILER=clang++ \
             -DCMAKE_C_FLAGS="-fsanitize=address -g -O1" \
             -DCMAKE_CXX_FLAGS="-fsanitize=address -g -O1" \
             -DASSIMP_BUILD_TESTS=OFF
    cmake --build . --parallel $(nproc)
}

echo "Fix applied and project rebuilt successfully"
