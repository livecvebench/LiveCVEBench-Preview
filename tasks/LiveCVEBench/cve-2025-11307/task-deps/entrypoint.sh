#!/bin/bash
set -e

# Source the WordPress environment setup from the original image
# This needs to run first to create wp-config.php

# Check if we need to wait for MySQL
echo "Waiting for MySQL..."
maxTries=30
while [ "$maxTries" -gt 0 ] && ! mysqladmin ping -h"$WORDPRESS_DB_HOST" --silent 2>/dev/null; do
    sleep 2
    maxTries=$((maxTries - 1))
done

if [ "$maxTries" -le 0 ]; then
    echo "MySQL is not available, continuing anyway..."
else
    echo "MySQL is ready!"
fi

# Run the WordPress initialization script (without starting Apache yet)
# The wordpress docker-entrypoint creates wp-config.php
/usr/local/bin/docker-entrypoint.sh apache2 -version > /dev/null 2>&1 || true

# Wait for wp-config.php to be created by docker-entrypoint
echo "Waiting for WordPress configuration..."
maxTries=30
while [ "$maxTries" -gt 0 ] && [ ! -f /var/www/html/wp-config.php ]; do
    sleep 2
    maxTries=$((maxTries - 1))
done
echo "WordPress configuration ready!"

# Setup WordPress via WP-CLI
cd /var/www/html

# Check if WordPress is already installed
if ! wp core is-installed --allow-root --path=/var/www/html 2>/dev/null; then
    echo "Installing WordPress..."
    wp core install \
        --url="http://localhost" \
        --title="CVE Test Site" \
        --admin_user=admin \
        --admin_password=admin123 \
        --admin_email=admin@test.local \
        --skip-email \
        --allow-root \
        --path=/var/www/html || true
    echo "WordPress installed!"
fi

# Activate the plugin
if ! wp plugin is-active wp-google-maps --allow-root --path=/var/www/html 2>/dev/null; then
    echo "Activating WP Go Maps plugin..."
    wp plugin activate wp-google-maps --allow-root --path=/var/www/html || true
    echo "Plugin activated!"
fi

# Create symlink for /app if it doesn't exist (for solution.sh compatibility)
if [ ! -e /app ]; then
    ln -s /var/www/html /app
fi

echo "WordPress with WP Go Maps is ready!"

# Start Apache in foreground
exec apache2-foreground
