#!/bin/bash
set -e

# Wait for database to be ready
echo "Waiting for database to be ready..."
max_tries=30
count=0
while ! mysqladmin ping -h"$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" --silent 2>/dev/null; do
    count=$((count + 1))
    if [ $count -ge $max_tries ]; then
        echo "Database connection failed after $max_tries attempts"
        exit 1
    fi
    echo "Waiting for database... ($count/$max_tries)"
    sleep 2
done
echo "Database is ready!"

# Run original WordPress entrypoint to setup wp-config.php
docker-entrypoint.sh apache2 -v > /dev/null 2>&1 || true

# Wait for WordPress files to be available
sleep 2

# Add configurations to wp-config.php to disable external connections and cron
# This prevents timeouts trying to reach wordpress.org
if ! grep -q "DISALLOW_FILE_MODS" /var/www/html/wp-config.php; then
    sed -i "/\/\* That's all, stop editing!/i\\
/* Disable auto-updates and external connections */\\
define('AUTOMATIC_UPDATER_DISABLED', true);\\
define('WP_AUTO_UPDATE_CORE', false);\\
define('DISALLOW_FILE_MODS', true);\\
define('WP_HTTP_BLOCK_EXTERNAL', true);\\
define('DISABLE_WP_CRON', true);\\
" /var/www/html/wp-config.php
fi

# Check if WordPress is already installed
if ! wp core is-installed --path=/var/www/html --allow-root 2>/dev/null; then
    echo "Installing WordPress..."
    wp core install \
        --path=/var/www/html \
        --url="http://localhost" \
        --title="CVE Test Site" \
        --admin_user=admin \
        --admin_password=admin123 \
        --admin_email=admin@test.com \
        --skip-email \
        --allow-root

    echo "WordPress installed successfully!"
else
    echo "WordPress already installed."
fi

# Check if plugin exists and activate it
if [ -d "/var/www/html/wp-content/plugins/find-me-on" ]; then
    echo "Activating Find Me On plugin..."
    wp plugin activate find-me-on --path=/var/www/html --allow-root 2>/dev/null || true
    echo "Plugin activated!"
fi

# Create subscriber user for testing
echo "Creating subscriber test user..."
wp user create subscriber subscriber@test.com \
    --role=subscriber \
    --user_pass=subscriber123 \
    --path=/var/www/html \
    --allow-root 2>/dev/null || echo "Subscriber user may already exist"

# Insert sample data into find_me_on table if it exists
echo "Inserting sample data..."
wp db query "INSERT IGNORE INTO wp_find_me_on (network_id, user_info, sort_order) VALUES (60, 'testuser', 1), (14, 'https://facebook.com/testuser', 2), (19, 'github_user', 3);" --path=/var/www/html --allow-root 2>/dev/null || echo "Sample data may already exist or table not ready"

echo "WordPress setup complete!"
echo "Admin user: admin / admin123"
echo "Subscriber user: subscriber / subscriber123"

# Start Apache in foreground
exec apache2-foreground
