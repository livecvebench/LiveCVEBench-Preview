"""
Functional tests for ValidatePackageNames validator.

These tests verify that the validator works correctly for legitimate use cases.
They should PASS in both vulnerable and fixed states.
"""

import json
import subprocess
import os
import tempfile

# Path to the app directory in container
APP_DIR = "/app"


def run_validator(packages_dict):
    """
    Run the ValidatePackageNames validator with the given packages.
    Returns the validation result as a dict with 'type' and 'errors' keys.
    """
    test_script = f"""
const ValidatePackageNames = require('{APP_DIR}/src/validators/ValidatePackageNames.js');

const packages = {json.dumps(packages_dict)};

const validator = new ValidatePackageNames({{ packages }});
const result = validator.validate();
console.log(JSON.stringify(result));
"""

    result = subprocess.run(
        ['node', '-e', test_script],
        capture_output=True,
        text=True,
        timeout=30
    )

    if result.returncode != 0:
        raise RuntimeError(f"Node script failed: {result.stderr}")

    return json.loads(result.stdout.strip())


class TestValidPackages:
    """Test that legitimate packages pass validation correctly."""

    def test_single_valid_package(self):
        """Test that a single legitimate package passes validation."""
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.npmjs.org/commander/-/commander-4.1.1.tgz",
                "integrity": "sha512-NOKm8xhkzAjzFx8B2v5OAHT+u5pRQc2UCa2Vq9jYL/31o2wi9mxBA7LIFs3sV5VSC49z6pEhfbMULvShKj26WA=="
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_multiple_valid_packages(self):
        """Test that multiple legitimate packages all pass validation."""
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.npmjs.org/commander/-/commander-4.1.1.tgz",
                "integrity": "sha512-..."
            },
            "express@4.17.1": {
                "version": "4.17.1",
                "resolved": "https://registry.npmjs.org/express/-/express-4.17.1.tgz",
                "integrity": "sha512-..."
            },
            "lodash@4.17.21": {
                "version": "4.17.21",
                "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_scoped_package_valid(self):
        """Test that scoped packages with correct URLs pass validation."""
        packages = {
            "@babel/core@7.12.0": {
                "version": "7.12.0",
                "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.12.0.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_multiple_scoped_packages(self):
        """Test multiple scoped packages from the same organization."""
        packages = {
            "@babel/core@7.12.0": {
                "version": "7.12.0",
                "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.12.0.tgz",
                "integrity": "sha512-..."
            },
            "@babel/preset-env@7.12.0": {
                "version": "7.12.0",
                "resolved": "https://registry.npmjs.org/@babel/preset-env/-/preset-env-7.12.0.tgz",
                "integrity": "sha512-..."
            },
            "@types/node@16.0.0": {
                "version": "16.0.0",
                "resolved": "https://registry.npmjs.org/@types/node/-/node-16.0.0.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"


class TestPackagesWithoutResolvedField:
    """Test that packages without resolved field are properly skipped."""

    def test_package_without_resolved(self):
        """Test that packages without resolved field pass (skipped)."""
        packages = {
            "local-package@1.0.0": {
                "version": "1.0.0"
                # No resolved field - locally installed
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_mixed_packages_with_and_without_resolved(self):
        """Test mix of packages with and without resolved fields."""
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.npmjs.org/commander/-/commander-4.1.1.tgz",
                "integrity": "sha512-..."
            },
            "local-package@1.0.0": {
                "version": "1.0.0"
                # No resolved field
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"


class TestNonOfficialRegistries:
    """Test that non-official registries are properly skipped."""

    def test_private_registry(self):
        """Test that packages from private registries are skipped."""
        packages = {
            "internal-package@1.0.0": {
                "version": "1.0.0",
                "resolved": "https://my-private-registry.company.com/internal-package/-/internal-package-1.0.0.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_yarn_registry_valid(self):
        """Test that yarn registry packages work correctly."""
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.yarnpkg.com/commander/-/commander-4.1.1.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_package_with_hyphen_in_name(self):
        """Test packages with hyphens in the name."""
        packages = {
            "lodash-es@4.17.21": {
                "version": "4.17.21",
                "resolved": "https://registry.npmjs.org/lodash-es/-/lodash-es-4.17.21.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_package_with_numbers_in_name(self):
        """Test packages with numbers in the name."""
        packages = {
            "es6-promise@4.2.8": {
                "version": "4.2.8",
                "resolved": "https://registry.npmjs.org/es6-promise/-/es6-promise-4.2.8.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_empty_packages_object(self):
        """Test with an empty packages object."""
        packages = {}

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"

    def test_package_with_underscore(self):
        """Test packages with underscores in the name."""
        packages = {
            "es5_shim@4.6.7": {
                "version": "4.6.7",
                "resolved": "https://registry.npmjs.org/es5_shim/-/es5_shim-4.6.7.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "success", f"Expected success but got: {result}"
        assert len(result["errors"]) == 0, f"Expected no errors but got: {result['errors']}"


class TestBasicMismatchDetection:
    """Test that basic package mismatches are detected correctly."""

    def test_completely_different_package(self):
        """
        Test: Declared 'axios' but resolved URL points to 'malware-package'.

        This should always fail regardless of the vulnerability,
        as the package names are completely different (not a prefix match).
        Ensures basic validation still works.
        """
        packages = {
            "axios@0.21.1": {
                "version": "0.21.1",
                "resolved": "https://registry.npmjs.org/malware-package/-/malware-package-0.21.1.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Basic validation failed! Completely different package should be rejected. Got: {result}"
        assert len(result["errors"]) > 0


class TestConstructorValidation:
    """Test constructor validation."""

    def test_constructor_requires_object(self):
        """Test that constructor throws error when not passed an object."""
        test_script = f"""
const ValidatePackageNames = require('{APP_DIR}/src/validators/ValidatePackageNames.js');

try {{
    const validator = new ValidatePackageNames();
    console.log(JSON.stringify({{"error": false}}));
}} catch (e) {{
    console.log(JSON.stringify({{"error": true, "message": e.message}}));
}}
"""

        result = subprocess.run(
            ['node', '-e', test_script],
            capture_output=True,
            text=True,
            timeout=30
        )

        output = json.loads(result.stdout.strip())
        assert output["error"] == True, "Expected constructor to throw error"
        assert "object" in output["message"].lower(), f"Expected error about object, got: {output['message']}"
