#!/usr/bin/env python3
"""
Simple backend server that echoes received headers.
Used for testing that Fabio correctly sets forwarding headers.
"""

from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import sys
import os


class HeaderEchoHandler(BaseHTTPRequestHandler):
    """HTTP handler that echoes received headers as JSON."""

    def do_GET(self):
        """Handle GET requests by returning received headers."""
        # Convert headers to dict
        headers = dict(self.headers)

        response_data = {
            "path": self.path,
            "method": "GET",
            "headers": headers
        }

        # Send response
        self.send_response(200)
        self.send_header("Content-Type", "application/json")
        self.end_headers()
        self.wfile.write(json.dumps(response_data, indent=2).encode())

    def do_POST(self):
        """Handle POST requests by returning received headers."""
        # Read request body if present
        content_length = int(self.headers.get('Content-Length', 0))
        body = self.rfile.read(content_length).decode() if content_length > 0 else ""

        headers = dict(self.headers)

        response_data = {
            "path": self.path,
            "method": "POST",
            "headers": headers,
            "body": body
        }

        self.send_response(200)
        self.send_header("Content-Type", "application/json")
        self.end_headers()
        self.wfile.write(json.dumps(response_data, indent=2).encode())

    def log_message(self, format, *args):
        """Suppress default logging to keep output clean."""
        # Uncomment the following line for debugging
        # sys.stderr.write(f"{self.address_string()} - {format % args}\n")
        pass


def run_server(port=8080):
    """Run the backend server."""
    server_address = ("0.0.0.0", port)
    httpd = HTTPServer(server_address, HeaderEchoHandler)
    print(f"Backend server listening on port {port}", flush=True)
    httpd.serve_forever()


if __name__ == "__main__":
    port = int(os.environ.get("BACKEND_PORT", 8080))
    run_server(port)
