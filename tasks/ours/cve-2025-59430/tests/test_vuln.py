"""
Vulnerability tests for the Mesh Connect SDK.

These tests verify that the URL protocol validation is in place.
- In VULNERABLE state: tests should FAIL (malicious protocols are accepted)
- In FIXED state: tests should PASS (malicious protocols are rejected)
"""

import subprocess
import os


def run_jest_file(test_file):
    """Run a specific Jest test file."""
    result = subprocess.run(
        ['npm', 'test', '--', test_file, '--ci'],
        cwd='/app/packages/link',
        capture_output=True,
        text=True,
        timeout=120
    )
    return result


class TestJavaScriptProtocolInjection:
    """Tests for javascript: protocol injection attempts."""

    def test_basic_javascript_protocol_rejected(self):
        """
        javascript:alert(document.domain)// should be rejected.

        In vulnerable state: iframe is created with javascript: src (FAIL)
        In fixed state: onExit called with 'Invalid link token!', no iframe (PASS)
        """
        result = run_jest_file('src/tests/vuln_js_basic.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_javascript_parent_document_access_rejected(self):
        """
        javascript:window.parent.document.cookie// should be rejected.

        This payload attempts to access parent document cookies.
        """
        result = run_jest_file('src/tests/vuln_js_parent_access.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_javascript_with_encoded_chars_rejected(self):
        """
        javascript: with URL-encoded characters should be rejected.
        """
        result = run_jest_file('src/tests/vuln_js_encoded.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_javascript_uppercase_rejected(self):
        """
        JAVASCRIPT: and JaVaScRiPt: variations should be rejected.
        """
        result = run_jest_file('src/tests/vuln_js_uppercase.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestDataProtocolInjection:
    """Tests for data: protocol injection attempts."""

    def test_data_html_protocol_rejected(self):
        """
        data:text/html,<script>alert(1)</script> should be rejected.
        """
        result = run_jest_file('src/tests/vuln_data_html.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_data_base64_protocol_rejected(self):
        """
        data:text/html;base64,... should be rejected.
        """
        result = run_jest_file('src/tests/vuln_data_base64.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestOtherDangerousProtocols:
    """Tests for other dangerous protocol injection attempts."""

    def test_vbscript_protocol_rejected(self):
        """
        vbscript: protocol should be rejected.
        """
        result = run_jest_file('src/tests/vuln_vbscript.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_file_protocol_rejected(self):
        """
        file:/// protocol should be rejected.
        """
        result = run_jest_file('src/tests/vuln_file.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_custom_iframe_with_malicious_url_rejected(self):
        """
        Malicious URL with customIframeId should still be rejected.
        """
        result = run_jest_file('src/tests/vuln_custom_iframe.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestEdgeCases:
    """Edge case tests for protocol validation."""

    def test_no_protocol_rejected(self):
        """
        URL without any protocol should be rejected.
        """
        result = run_jest_file('src/tests/vuln_no_protocol.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_http_in_path_not_confused(self):
        """
        URL with 'http' in path but javascript: protocol should be rejected.
        e.g., javascript:fetch('http://evil.com')//
        """
        result = run_jest_file('src/tests/vuln_http_in_path.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"
