#!/bin/bash
# Solution script for WeGIA debug_info.php input validation vulnerability
# This script applies the security fixes to prevent command injection

set -e

# Create /app symlink if it doesn't exist (for compatibility)
if [ ! -d "/app" ]; then
    ln -sf /var/www/WeGIA /app
fi

cd /var/www/WeGIA

TARGET_FILE="html/configuracao/debug_info.php"

if [ ! -f "$TARGET_FILE" ]; then
    echo "[-] Error: $TARGET_FILE not found"
    exit 1
fi

echo "[*] Applying security fixes to $TARGET_FILE..."

# Create a backup
cp "$TARGET_FILE" "${TARGET_FILE}.bak"

# Fix 1: Replace the vulnerable exec call in gitCheckout function
# The pattern in the file is: exec("git -C ".ROOT." checkout $branch", $output);
# Need to handle varying whitespace
sed -i 's|exec("git -C "\.ROOT\." checkout \$branch"|exec("git -C " . ROOT . " checkout " . escapeshellarg($branch)|g' "$TARGET_FILE"

# Fix 2: Replace direct $_POST access with filter_input
# Original: $branch = $_POST['branch'];
sed -i "s/\\\$branch = \\\$_POST\['branch'\];/\\\$branch = filter_input(INPUT_POST, 'branch', FILTER_SANITIZE_FULL_SPECIAL_CHARS);/g" "$TARGET_FILE"

# Original: $action = $_POST["action"];
sed -i 's/\$action = \$_POST\["action"\];/\$action = filter_input(INPUT_POST, '"'"'action'"'"', FILTER_SANITIZE_FULL_SPECIAL_CHARS);/g' "$TARGET_FILE"

# Fix 3: Add input validation after the filter_input lines
# We need to add the preg_match validation before the action handling
# Check if validation already exists
if ! grep -q "preg_match.*branch" "$TARGET_FILE"; then
    # Insert validation after $action = filter_input line
    sed -i '/\$action = filter_input.*action/a\
\
        if (!preg_match('\''/^[a-zA-Z0-9._\\-\\/]+$/'\'', $branch)) {\
            http_response_code(400);\
            exit("Branch inv√°lida.");\
        }' "$TARGET_FILE"
fi

# Fix 4: Remove branch parameter from redirect URL
# Original: header("Location: atualizacao.php?branch=$branch");
sed -i 's|header("Location: atualizacao\.php?branch=\$branch");|header("Location: atualizacao.php");|g' "$TARGET_FILE"

# Fix 5: Add htmlspecialchars to output encoding in HTML (if present)
# Original: <?php echo $branch; ?>
sed -i 's/<?php echo \$branch; ?>/<?php echo htmlspecialchars($branch); ?>/g' "$TARGET_FILE"

echo "[+] Security fixes applied successfully!"

# Verify the fixes were applied
echo "[*] Verifying fixes..."

if grep -q "escapeshellarg" "$TARGET_FILE"; then
    echo "[+] Fix 1: escapeshellarg added to gitCheckout function"
else
    echo "[-] Warning: escapeshellarg fix may not have been applied"
fi

if grep -q "filter_input.*INPUT_POST.*branch" "$TARGET_FILE"; then
    echo "[+] Fix 2: filter_input added for input sanitization"
else
    echo "[-] Warning: filter_input fix may not have been applied"
fi

if grep -q "preg_match.*branch" "$TARGET_FILE"; then
    echo "[+] Fix 3: Input validation regex added"
else
    echo "[-] Warning: Input validation fix may not have been applied"
fi

# Clear PHP OPcache if available (without restarting services)
php -r "if (function_exists('opcache_reset')) { opcache_reset(); echo 'OPcache cleared'; }" 2>/dev/null || true

echo "[+] Fix applied successfully!"
