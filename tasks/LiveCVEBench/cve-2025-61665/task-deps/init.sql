-- Database initialization for WeGIA member management system
-- WeGIA Member Management System

CREATE DATABASE IF NOT EXISTS wegia CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE wegia;

-- Create user
CREATE USER IF NOT EXISTS 'wegiauser'@'%' IDENTIFIED BY 'senha';
GRANT ALL PRIVILEGES ON wegia.* TO 'wegiauser'@'%';
FLUSH PRIVILEGES;

-- pessoa (Person) table
CREATE TABLE IF NOT EXISTS pessoa (
    id_pessoa INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    cpf VARCHAR(18),
    telefone VARCHAR(20),
    email VARCHAR(255),
    endereco VARCHAR(255),
    tipo_sanguineo VARCHAR(5),
    data_nascimento DATE,
    nome_pai VARCHAR(255),
    nome_mae VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- socio_status (Membership Status) lookup table
CREATE TABLE IF NOT EXISTS socio_status (
    id_sociostatus INT AUTO_INCREMENT PRIMARY KEY,
    status VARCHAR(50) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- socio_tipo (Membership Type) lookup table
CREATE TABLE IF NOT EXISTS socio_tipo (
    id_sociotipo INT AUTO_INCREMENT PRIMARY KEY,
    tipo VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- socio_tag (Membership Tag) lookup table
CREATE TABLE IF NOT EXISTS socio_tag (
    id_sociotag INT AUTO_INCREMENT PRIMARY KEY,
    tag VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- socio (Member/Associate) table
CREATE TABLE IF NOT EXISTS socio (
    id_socio INT AUTO_INCREMENT PRIMARY KEY,
    id_pessoa INT NOT NULL,
    id_sociostatus INT NOT NULL,
    id_sociotipo INT NOT NULL,
    id_sociotag INT,
    email VARCHAR(255),
    valor_periodo DECIMAL(10,2) DEFAULT 0.00,
    data_referencia DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_pessoa) REFERENCES pessoa(id_pessoa),
    FOREIGN KEY (id_sociostatus) REFERENCES socio_status(id_sociostatus),
    FOREIGN KEY (id_sociotipo) REFERENCES socio_tipo(id_sociotipo),
    FOREIGN KEY (id_sociotag) REFERENCES socio_tag(id_sociotag)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- cargo (Position/Role) table for permissions
CREATE TABLE IF NOT EXISTS cargo (
    id_cargo INT AUTO_INCREMENT PRIMARY KEY,
    cargo VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- funcionario (Employee) table
CREATE TABLE IF NOT EXISTS funcionario (
    id_funcionario INT AUTO_INCREMENT PRIMARY KEY,
    id_pessoa INT NOT NULL,
    id_cargo INT NOT NULL,
    FOREIGN KEY (id_pessoa) REFERENCES pessoa(id_pessoa),
    FOREIGN KEY (id_cargo) REFERENCES cargo(id_cargo)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- recurso (Resource) table for permissions
CREATE TABLE IF NOT EXISTS recurso (
    id_recurso INT AUTO_INCREMENT PRIMARY KEY,
    recurso VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- permissao (Permission) table
CREATE TABLE IF NOT EXISTS permissao (
    id_permissao INT AUTO_INCREMENT PRIMARY KEY,
    id_cargo INT NOT NULL,
    id_recurso INT NOT NULL,
    id_acao INT DEFAULT 1,
    FOREIGN KEY (id_cargo) REFERENCES cargo(id_cargo),
    FOREIGN KEY (id_recurso) REFERENCES recurso(id_recurso)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insert status types
INSERT IGNORE INTO socio_status (id_sociostatus, status) VALUES
(1, 'Ativo'),
(2, 'Inativo'),
(3, 'Suspenso');

-- Insert membership types (matches the switch statement in the code)
-- Casuais: 0,1 | Mensais: 2,3 | Bimestrais: 6,7 | Trimestrais: 8,9 | Semestrais: 10,11
INSERT IGNORE INTO socio_tipo (id_sociotipo, tipo) VALUES
(0, 'Casual - Boleto'),
(1, 'Casual - Cartão'),
(2, 'Física - Mensal - Boleto'),
(3, 'Física - Mensal - Cartão'),
(4, 'Jurídica - Mensal - Boleto'),
(5, 'Jurídica - Mensal - Cartão'),
(6, 'Física - Bimestral - Boleto'),
(7, 'Física - Bimestral - Cartão'),
(8, 'Física - Trimestral - Boleto'),
(9, 'Física - Trimestral - Cartão'),
(10, 'Física - Semestral - Boleto'),
(11, 'Física - Semestral - Cartão');

-- Insert tags
INSERT IGNORE INTO socio_tag (id_sociotag, tag) VALUES
(1, 'Solicitante'),
(2, 'Voluntário'),
(3, 'Doador'),
(4, 'Parceiro');

-- Insert sample persons (with sensitive data that should NOT be accessible without auth)
INSERT IGNORE INTO pessoa (id_pessoa, nome, cpf, telefone, email) VALUES
(1, 'Luis Barango', '649.659.320-56', '(71)98642-1278', 'luis.barango@teste.com'),
(2, 'Maria Silva Santos', '123.456.789-01', '(21)99999-1234', 'maria.silva@teste.com'),
(3, 'João Pedro Oliveira', '987.654.321-00', '(11)98765-4321', 'joao.pedro@teste.com'),
(4, 'Ana Carolina Souza', '456.789.123-45', '(31)97654-3210', 'ana.carolina@teste.com'),
(5, 'Empresa ABC Ltda', '12.345.678/0001-90', '(11)3333-4444', 'contato@empresaabc.com.br'),
(6, 'Admin User', '111.222.333-44', '(21)91111-2222', 'admin@wegia.org');

-- Insert sample members (socios)
INSERT IGNORE INTO socio (id_socio, id_pessoa, id_sociostatus, id_sociotipo, id_sociotag, email, valor_periodo) VALUES
(1, 1, 1, 2, 1, 'teste@teste.com', 5000.00),
(2, 2, 1, 3, 3, 'maria.silva@teste.com', 1500.00),
(3, 3, 1, 6, 2, 'joao.pedro@teste.com', 3000.00),
(4, 4, 2, 8, 1, 'ana.carolina@teste.com', 2500.00),
(5, 5, 1, 4, 4, 'contato@empresaabc.com.br', 10000.00);

-- Insert positions/roles
INSERT IGNORE INTO cargo (id_cargo, cargo) VALUES
(1, 'Administrador'),
(2, 'Gerente'),
(3, 'Funcionário'),
(4, 'Voluntário');

-- Insert resources (resource 4 = socio reports)
INSERT IGNORE INTO recurso (id_recurso, recurso) VALUES
(1, 'Dashboard'),
(2, 'Pessoas'),
(3, 'Configurações'),
(4, 'Relatórios Sócios'),
(5, 'Financeiro');

-- Insert permissions (only admin has access to resource 4 with action level 5)
INSERT IGNORE INTO permissao (id_cargo, id_recurso, id_acao) VALUES
(1, 1, 5),
(1, 2, 5),
(1, 3, 5),
(1, 4, 5),
(1, 5, 5),
(2, 1, 3),
(2, 2, 3),
(2, 4, 3),
(3, 1, 1),
(3, 2, 1);

-- Create an employee with admin privileges (for testing fixed version)
INSERT IGNORE INTO funcionario (id_pessoa, id_cargo) VALUES
(6, 1);
