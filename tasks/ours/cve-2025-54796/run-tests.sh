#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install pytest and requests if not present
pip install --quiet pytest requests 2>/dev/null || pip3 install --quiet pytest requests

# Wait for server to be ready
echo "Waiting for copyparty server to be ready..."
for i in {1..30}; do
    if curl -s -o /dev/null -w "%{http_code}" http://localhost:3923/ | grep -q "200\|302"; then
        echo "Server is ready"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "Warning: Server may not be fully ready"
    fi
    sleep 1
done

# Upload test files with long paths (no 'x' in path to trigger ReDoS)
# The ReDoS pattern (.+)+x requires strings WITHOUT 'x' to cause backtracking
echo "Uploading test files for ReDoS vulnerability testing..."
mkdir -p /data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa 2>/dev/null || true
mkdir -p /data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb 2>/dev/null || true

curl -s -X PUT -d "test content 1" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/testfile1.dat" >/dev/null 2>&1
curl -s -X PUT -d "test content 2" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/testfile2.dat" >/dev/null 2>&1
curl -s -X PUT -d "test content 3" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/document.pdf" >/dev/null 2>&1
curl -s -X PUT -d "nested content 1" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb/nested1.dat" >/dev/null 2>&1
curl -s -X PUT -d "nested content 2" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb/nested2.dat" >/dev/null 2>&1

echo "Test files uploaded"

# Wait a moment for uploads to be indexed
sleep 2

# Run all tests
python -m pytest . -rA -v
