#!/bin/bash
# Solution script for fixing the HTML encoding issue in admin menu template
# This script applies proper HTML escaping to user-controlled values in menu.tpl

set -e
cd /var/www/html

MENU_TPL="/var/www/html/admin/template/menu.tpl"

# Check if the file exists
if [ ! -f "$MENU_TPL" ]; then
    echo "Error: menu.tpl not found at $MENU_TPL"
    exit 1
fi

echo "Applying fix to $MENU_TPL..."

# Fix 1: Escape $menu_item['class'] output (line ~40)
# Before: if (isset($menu_item['class'])) echo $menu_item['class'];
# After:  if (isset($menu_item['class'])) echo htmlspecialchars($menu_item['class']);
sed -i "s/echo \$menu_item\['class'\];/echo htmlspecialchars(\$menu_item['class']);/g" "$MENU_TPL"

# Fix 2: Escape $key in data-target attribute (line ~44)
# Before: echo '#menu-' . $key;
# After:  echo '#menu-' . htmlspecialchars($key);
sed -i "s/echo '#menu-' \. \$key;/echo '#menu-' . htmlspecialchars(\$key);/g" "$MENU_TPL"

# Fix 3: Escape $submenu_item['class'] output (line ~61)
# Before: if (isset($submenu_item['class'])) echo $submenu_item['class'];
# After:  if (isset($submenu_item['class'])) echo htmlspecialchars($submenu_item['class']);
sed -i "s/echo \$submenu_item\['class'\];/echo htmlspecialchars(\$submenu_item['class']);/g" "$MENU_TPL"

echo "Fix applied successfully."

# Clear compiled template cache to ensure the fix takes effect
# The Vvveb template engine caches compiled templates
echo "Clearing compiled template cache..."
rm -f /var/www/html/storage/compiled-templates/*.html 2>/dev/null || true
rm -f /var/www/html/storage/compiled-templates/*.component 2>/dev/null || true
echo "Template cache cleared."

# Verify the fix was applied
if grep -q "htmlspecialchars(\$menu_item\['class'\])" "$MENU_TPL" && \
   grep -q "htmlspecialchars(\$key)" "$MENU_TPL" && \
   grep -q "htmlspecialchars(\$submenu_item\['class'\])" "$MENU_TPL"; then
    echo "Verification: All htmlspecialchars() calls are in place."
else
    echo "Warning: Some fixes may not have been applied. Checking file..."
    grep -n "echo.*menu_item\['class'\]" "$MENU_TPL" || true
    grep -n "echo.*#menu-.*key" "$MENU_TPL" || true
    grep -n "echo.*submenu_item\['class'\]" "$MENU_TPL" || true
fi

# Restart PHP-FPM or Apache to ensure changes take effect
# The container will typically run PHP via Apache or php-fpm
if command -v apache2ctl &> /dev/null; then
    echo "Restarting Apache..."
    apache2ctl graceful 2>/dev/null || true
elif command -v apachectl &> /dev/null; then
    echo "Restarting Apache..."
    apachectl graceful 2>/dev/null || true
fi

if pgrep -x "php-fpm" > /dev/null; then
    echo "Reloading PHP-FPM..."
    pkill -USR2 php-fpm 2>/dev/null || true
fi

echo "Solution applied successfully."
