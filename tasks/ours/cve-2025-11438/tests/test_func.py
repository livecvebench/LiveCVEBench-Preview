"""
Functionality tests for OpnForm workspace settings API.

These tests verify that the basic functionality works correctly:
- Admin users can modify workspace settings
- Basic API responses are correct

These tests should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import os
import subprocess
import time
import json

BASE_URL = os.environ.get("APP_URL", "http://localhost")

# Test data
ADMIN_EMAIL = "admin@test.com"
ADMIN_PASSWORD = "password123"


class TestSetup:
    """Helper class for test setup and utilities."""

    @staticmethod
    def get_auth_token(email, password):
        """Get authentication token for a user."""
        response = requests.post(
            f"{BASE_URL}/login",
            json={"email": email, "password": password},
            headers={"Content-Type": "application/json", "Accept": "application/json"},
            timeout=30
        )
        if response.status_code == 200:
            return response.json().get("token")
        return None

    @staticmethod
    def get_workspaces(token):
        """Get list of workspaces for authenticated user."""
        response = requests.get(
            f"{BASE_URL}/open/workspaces",
            headers={
                "Authorization": f"Bearer {token}",
                "Accept": "application/json"
            },
            timeout=30
        )
        if response.status_code == 200:
            data = response.json()
            # Response is a list, not {"data": [...]}
            if isinstance(data, list):
                return data
            return data.get("data", [])
        return []

    @staticmethod
    def wait_for_app():
        """Wait for the application to be ready."""
        for _ in range(30):
            try:
                # Check if the API responds to any request
                response = requests.get(f"{BASE_URL}/healthcheck", timeout=5)
                # Accept any HTTP response as sign that app is running
                return True
            except requests.exceptions.RequestException:
                pass
            time.sleep(1)
        return False


class TestAdminFunctionality:
    """Test that admin users can properly manage workspace settings."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test fixtures."""
        assert TestSetup.wait_for_app(), "Application is not ready"
        self.admin_token = TestSetup.get_auth_token(ADMIN_EMAIL, ADMIN_PASSWORD)
        assert self.admin_token, f"Failed to authenticate as admin user {ADMIN_EMAIL}"

        workspaces = TestSetup.get_workspaces(self.admin_token)
        assert len(workspaces) > 0, "No workspaces found for admin user"
        self.workspace_id = workspaces[0]["id"]

    def test_admin_can_view_workspaces(self):
        """Test that admin can view their workspaces."""
        response = requests.get(
            f"{BASE_URL}/open/workspaces",
            headers={
                "Authorization": f"Bearer {self.admin_token}",
                "Accept": "application/json"
            },
            timeout=30
        )
        assert response.status_code == 200
        data = response.json()
        # Response is a list directly
        assert isinstance(data, list)
        assert len(data) > 0

    def test_admin_can_update_custom_domains(self):
        """Test that admin user can successfully update custom domains."""
        test_domain = "admin-test-domain.com"

        response = requests.put(
            f"{BASE_URL}/open/workspaces/{self.workspace_id}/custom-domains",
            json={"custom_domains": [test_domain]},
            headers={
                "Authorization": f"Bearer {self.admin_token}",
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            timeout=30
        )

        # Admin should be able to update (200 or 201)
        assert response.status_code in [200, 201], \
            f"Admin should be able to update custom domains. Got {response.status_code}: {response.text}"

    def test_admin_can_update_email_settings(self):
        """Test that admin user can successfully update email settings."""
        response = requests.put(
            f"{BASE_URL}/open/workspaces/{self.workspace_id}/email-settings",
            json={
                "smtp_host": "smtp.example.com",
                "smtp_port": 587
            },
            headers={
                "Authorization": f"Bearer {self.admin_token}",
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            timeout=30
        )

        # Admin should be able to update (200 or 201)
        assert response.status_code in [200, 201], \
            f"Admin should be able to update email settings. Got {response.status_code}: {response.text}"

    def test_unauthenticated_request_rejected(self):
        """Test that unauthenticated requests are rejected."""
        response = requests.put(
            f"{BASE_URL}/open/workspaces/{self.workspace_id}/custom-domains",
            json={"custom_domains": ["test.com"]},
            headers={
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            timeout=30
        )

        # Should get 401 Unauthorized
        assert response.status_code == 401, \
            f"Unauthenticated request should be rejected. Got {response.status_code}"


class TestAPIResponses:
    """Test that API responses have correct format."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test fixtures."""
        assert TestSetup.wait_for_app(), "Application is not ready"
        self.admin_token = TestSetup.get_auth_token(ADMIN_EMAIL, ADMIN_PASSWORD)
        assert self.admin_token, f"Failed to authenticate as admin user {ADMIN_EMAIL}"

    def test_workspaces_endpoint_returns_json(self):
        """Test that workspaces endpoint returns valid JSON."""
        response = requests.get(
            f"{BASE_URL}/open/workspaces",
            headers={
                "Authorization": f"Bearer {self.admin_token}",
                "Accept": "application/json"
            },
            timeout=30
        )
        assert response.status_code == 200
        assert "application/json" in response.headers.get("Content-Type", "")

        # Should parse as valid JSON
        data = response.json()
        assert isinstance(data, list)

    def test_invalid_workspace_id_handled(self):
        """Test that invalid workspace ID returns appropriate error."""
        response = requests.put(
            f"{BASE_URL}/open/workspaces/99999999/custom-domains",
            json={"custom_domains": ["test.com"]},
            headers={
                "Authorization": f"Bearer {self.admin_token}",
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            timeout=30
        )

        # Should get 404 Not Found or 403 Forbidden
        assert response.status_code in [403, 404], \
            f"Invalid workspace should return 403 or 404. Got {response.status_code}"
