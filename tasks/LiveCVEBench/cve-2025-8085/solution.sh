#!/bin/bash
# Solution script to fix the unauthenticated API access vulnerability
# Adds nonce verification to API callback functions that use general_ditty_permissions_check
set -e

PLUGIN_FILE="/var/www/html/wp-content/plugins/ditty-news-ticker/includes/class-ditty-api.php"

echo "Applying fix to Ditty API..."

# Check if the file exists
if [ ! -f "$PLUGIN_FILE" ]; then
    echo "ERROR: Plugin file not found at $PLUGIN_FILE"
    exit 1
fi

# Check if already fixed (idempotent)
if grep -q "wp_verify_nonce.*HTTP_X_WP_NONCE" "$PLUGIN_FILE"; then
    echo "Fix already applied, skipping..."
    exit 0
fi

# Create backup
cp "$PLUGIN_FILE" "${PLUGIN_FILE}.bak"

# The fix adds nonce verification to the following functions:
# 1. get_display_items (lines ~281)
# 2. php_item_mods (lines ~342)
# 3. dynamic_layout_tags (lines ~402)
# 4. save_ditty (lines ~189)
# 5. save_display (lines ~207)
# 6. save_layout (lines ~225)
# 7. save_settings (lines ~243)
# 8. refresh_translations (lines ~373)

# We use PHP to inject the nonce check at the beginning of each function
# This is more reliable than sed for complex PHP code

php << 'PHPSCRIPT'
<?php
$file = '/var/www/html/wp-content/plugins/ditty-news-ticker/includes/class-ditty-api.php';
$content = file_get_contents($file);

// The nonce verification code to add
$nonce_check = '
    if ( ! wp_verify_nonce( $_SERVER[\'HTTP_X_WP_NONCE\'], \'wp_rest\' ) ) {
      return new WP_Error( \'no_nonce\', __( \'Invalid nonce\', \'ditty-news-ticker\' ), array( \'status\' => 403 ) );
    }
';

// Functions that need nonce verification added
$functions = [
    'get_display_items',
    'php_item_mods',
    'dynamic_layout_tags',
    'save_ditty',
    'save_display',
    'save_layout',
    'save_settings',
    'refresh_translations',
];

foreach ($functions as $func) {
    // Pattern to match the function definition and its opening brace
    $pattern = '/(public\s+function\s+' . preg_quote($func, '/') . '\s*\(\s*\$request\s*\)\s*\{)/';

    // Check if nonce check already exists after this function
    if (preg_match($pattern, $content, $matches)) {
        $pos = strpos($content, $matches[0]);
        $after = substr($content, $pos + strlen($matches[0]), 200);

        // Only add if not already present
        if (strpos($after, 'wp_verify_nonce') === false) {
            $content = preg_replace(
                $pattern,
                '$1' . $nonce_check,
                $content,
                1
            );
            echo "Added nonce check to $func\n";
        } else {
            echo "Nonce check already present in $func\n";
        }
    }
}

file_put_contents($file, $content);
echo "Fix applied successfully!\n";
?>
PHPSCRIPT

# Verify the fix was applied
if grep -q "wp_verify_nonce.*HTTP_X_WP_NONCE" "$PLUGIN_FILE"; then
    echo "Verification passed: Nonce check added successfully"
else
    echo "ERROR: Fix verification failed"
    # Restore backup
    cp "${PLUGIN_FILE}.bak" "$PLUGIN_FILE"
    exit 1
fi

# Clean up backup
rm -f "${PLUGIN_FILE}.bak"

echo "Fix applied successfully!"
echo ""
echo "Changes made:"
echo "- Added nonce verification to get_display_items()"
echo "- Added nonce verification to php_item_mods()"
echo "- Added nonce verification to dynamic_layout_tags()"
echo "- Added nonce verification to save_ditty()"
echo "- Added nonce verification to save_display()"
echo "- Added nonce verification to save_layout()"
echo "- Added nonce verification to save_settings()"
echo "- Added nonce verification to refresh_translations()"
