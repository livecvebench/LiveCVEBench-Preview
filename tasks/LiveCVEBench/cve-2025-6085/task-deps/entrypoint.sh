#!/bin/bash
set -e

# Function to wait for MySQL
wait_for_mysql() {
    echo "Waiting for MySQL to be ready..."
    until mysql -h"$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" -e "SELECT 1" &>/dev/null; do
        echo "MySQL is unavailable - sleeping"
        sleep 2
    done
    echo "MySQL is ready!"
}

# Function to setup WordPress
setup_wordpress() {
    cd /var/www/html

    # Check if WordPress is already installed
    if wp core is-installed --allow-root 2>/dev/null; then
        echo "WordPress is already installed"
    else
        echo "Installing WordPress..."

        # Wait for wp-config.php to be created by docker-entrypoint
        timeout=60
        while [ ! -f /var/www/html/wp-config.php ] && [ $timeout -gt 0 ]; do
            echo "Waiting for wp-config.php..."
            sleep 2
            timeout=$((timeout - 2))
        done

        if [ ! -f /var/www/html/wp-config.php ]; then
            echo "ERROR: wp-config.php not found after timeout"
            return 1
        fi

        # Install WordPress
        wp core install \
            --url="http://localhost" \
            --title="CVE-2025-6085 Test Site" \
            --admin_user="admin" \
            --admin_password="admin" \
            --admin_email="admin@test.local" \
            --skip-email \
            --allow-root

        echo "WordPress installed successfully"
    fi

    # Activate the plugin
    echo "Activating integromat-connector plugin..."
    wp plugin activate integromat-connector --allow-root || true

    # Verify API key exists
    API_KEY=$(wp option get iwc_api_key --allow-root 2>/dev/null || echo "")
    if [ -n "$API_KEY" ]; then
        echo "API Key generated: $API_KEY"
        echo "$API_KEY" > /tmp/api_key.txt
    else
        echo "Warning: API key not found"
    fi

    # Set permalinks for REST API
    wp rewrite structure '/%postname%/' --allow-root 2>/dev/null || true
    wp rewrite flush --allow-root 2>/dev/null || true

    # Ensure uploads directory exists and is writable
    mkdir -p /var/www/html/wp-content/uploads
    chown -R www-data:www-data /var/www/html/wp-content/uploads
    chmod -R 755 /var/www/html/wp-content/uploads

    echo "WordPress setup complete!"
}

# Main entrypoint logic
main() {
    # Run the original WordPress docker-entrypoint in background
    docker-entrypoint.sh apache2-foreground &
    WP_PID=$!

    # Wait for MySQL to be ready
    wait_for_mysql

    # Give Apache and WordPress time to initialize
    sleep 5

    # Setup WordPress and plugin
    setup_wordpress

    # Keep container running by waiting for Apache
    wait $WP_PID
}

main
