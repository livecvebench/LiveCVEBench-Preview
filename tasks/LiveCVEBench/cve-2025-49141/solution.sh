#!/bin/bash
# Solution: Fix shell command injection in Git.php
#
# The vulnerability exists in the set_remote() function where user-provided
# URL is concatenated directly into a shell command without escaping.
#
# Fix: Wrap $destination and $url parameters with escapeshellarg() to
# prevent shell metacharacters from being interpreted.

set -e

TARGET_FILE="/var/www/html/system/backend/php/lib/Git.php"

echo "Applying shell escaping fix to Git.php..."

# Check if file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo "ERROR: Target file not found: $TARGET_FILE"
    exit 1
fi

# Create backup
cp "$TARGET_FILE" "${TARGET_FILE}.bak"

# Apply the fix to set_remote() function
# Change from:
#   return $this->run("remote add $destination $url");
# To:
#   return $this->run("remote add " . escapeshellarg($destination) . " " . escapeshellarg($url));

sed -i 's|return \$this->run("remote add \$destination \$url");|return \$this->run("remote add " . escapeshellarg(\$destination) . " " . escapeshellarg(\$url));|' "$TARGET_FILE"

# Verify the fix was applied
if grep -q 'escapeshellarg.*destination.*escapeshellarg.*url' "$TARGET_FILE"; then
    echo "Fix applied successfully to set_remote() function"
else
    echo "ERROR: Fix may not have been applied correctly"
    echo "Checking file content..."
    grep -n "set_remote" "$TARGET_FILE" || true
    exit 1
fi

# Also fix the pull() function which has similar issues
# Change from:
#   return $this->run("pull $remote $branch");
# To use escapeshellarg for safety (though less critical as it's typically internal)
sed -i 's|return \$this->run("pull \$remote \$branch");|return \$this->run("pull " . escapeshellarg(\$remote) . " " . escapeshellarg(\$branch));|' "$TARGET_FILE"

# Fix push() function
sed -i 's|return \$this->run("push \$remote \$branch \$flags");|return \$this->run("push " . escapeshellarg(\$remote) . " " . escapeshellarg(\$branch) . " " . \$flags);|' "$TARGET_FILE"

# Fix clone_remote() function
sed -i 's|return \$this->run("clone \$reference \$source " \. \$this->repo_path);|return \$this->run("clone " . \$reference . " " . escapeshellarg(\$source) . " " . escapeshellarg(\$this->repo_path));|' "$TARGET_FILE"

# Fix clone_from() function
sed -i 's|return \$this->run("clone --local \$source " \. \$this->repo_path);|return \$this->run("clone --local " . escapeshellarg(\$source) . " " . escapeshellarg(\$this->repo_path));|' "$TARGET_FILE"

# Fix checkout() function
sed -i 's|return \$this->run("checkout \$branch");|return \$this->run("checkout " . escapeshellarg(\$branch));|' "$TARGET_FILE"

# Fix create_branch() function
sed -i 's|return \$this->run("branch \$branch");|return \$this->run("branch " . escapeshellarg(\$branch));|' "$TARGET_FILE"

# Fix delete_branch() function - this one is more complex due to the ternary
sed -i 's|return \$this->run("branch " \. (\$force ? ..-D.. : ..-d..) \. " \$branch");|return \$this->run("branch " . (\$force ? "-D" : "-d") . " " . escapeshellarg(\$branch));|' "$TARGET_FILE"

# Fix merge() function
sed -i 's|return \$this->run("merge \$branch --no-ff");|return \$this->run("merge " . escapeshellarg(\$branch) . " --no-ff");|' "$TARGET_FILE"

# Fix reset() function
sed -i 's|return \$this->run("reset \$flag \$remote/\$branch");|return \$this->run("reset " . \$flag . " " . escapeshellarg(\$remote) . "/" . escapeshellarg(\$branch));|' "$TARGET_FILE"

echo "Additional shell escaping fixes applied"

# No need to restart Apache - PHP files are interpreted at runtime
echo "Solution applied successfully!"
