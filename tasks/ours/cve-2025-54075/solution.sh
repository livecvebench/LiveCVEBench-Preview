#!/bin/bash
set -e
cd /app

# Fix for MDC Renderer Base Tag XSS Vulnerability
# The vulnerability exists because only 'script' tags are blocked,
# but 'base' tags pass through and can hijack URL resolution.

FILE="/app/node_modules/@nuxtjs/mdc/dist/runtime/components/MDCRenderer.vue"

# Check if the file exists
if [ ! -f "$FILE" ]; then
    echo "Error: MDCRenderer.vue not found at $FILE"
    exit 1
fi

echo "Applying fix to MDCRenderer.vue..."

# Check if fix is already applied (idempotency check)
if grep -q "dangerousTags.includes(renderTag.toLowerCase())" "$FILE"; then
    echo "Fix already applied. Skipping patch..."
else
    # If backup exists and file was already modified, restore from backup first
    if [ -f "${FILE}.bak" ]; then
        echo "Restoring from backup before applying fix..."
        cp "${FILE}.bak" "$FILE"
    else
        # Create backup of original file
        cp "$FILE" "${FILE}.bak"
    fi

    # Step 1: Add dangerousTags constant after specialParentTags
    # Find: const specialParentTags = ["math", "svg"];
    # Add after: const dangerousTags = ["script", "base"];
    # Note: We check both original and kebab-case versions because the parser may convert tags
    sed -i 's/const specialParentTags = \["math", "svg"\];/const specialParentTags = ["math", "svg"];\nconst dangerousTags = ["script", "base", "ba-se"];/' "$FILE"

    # Step 2: Replace the script-only check with dangerousTags check (case-insensitive)
    # Change: if (renderTag === "script")
    # To: if (dangerousTags.includes(renderTag.toLowerCase()))
    sed -i 's/if (renderTag === "script")/if (dangerousTags.includes(renderTag.toLowerCase()))/' "$FILE"

    # Step 3: Update the class name from script-to-pre to mdc-renderer-dangerous-tag
    sed -i 's/class: "script-to-pre"/class: "mdc-renderer-dangerous-tag"/' "$FILE"

    # Step 4: Update the output format to use renderTag variable instead of hardcoded "script"
    # Using Python for this as the patterns are complex with escaping
    python3 << 'PYTHON_FIX_STEP4'
file_path = "/app/node_modules/@nuxtjs/mdc/dist/runtime/components/MDCRenderer.vue"

with open(file_path, 'r') as f:
    content = f.read()

# Replace the hardcoded script output with dynamic renderTag-based output
# Original: "<script>\n" + nodeTextContent(node) + "\n<\/script>"
# New: "<" + renderTag + ">\n" + nodeTextContent(node) + "\n</" + renderTag + ">"
old_text = '"<script>\\n" + nodeTextContent(node) + "\\n<\\/script>"'
new_text = '"<" + renderTag + ">\\n" + nodeTextContent(node) + "\\n</" + renderTag + ">"'
content = content.replace(old_text, new_text)

with open(file_path, 'w') as f:
    f.write(content)

print("Step 4 fix applied!")
PYTHON_FIX_STEP4

    # Verify the fix was applied
    if grep -q "dangerousTags.includes(renderTag.toLowerCase())" "$FILE"; then
        echo "Fix applied successfully!"
    else
        echo "Warning: Fix may not have been applied correctly"
        # Try alternative approach if sed didn't work
        echo "Attempting alternative fix method..."

        # Restore backup and try Python-based replacement
        cp "${FILE}.bak" "$FILE"

        python3 << 'PYTHON_FIX'
import re

file_path = "/app/node_modules/@nuxtjs/mdc/dist/runtime/components/MDCRenderer.vue"

with open(file_path, 'r') as f:
    content = f.read()

# Add dangerousTags after specialParentTags
# Include ba-se for kebab-case version of base that parser may create
content = content.replace(
    'const specialParentTags = ["math", "svg"];',
    'const specialParentTags = ["math", "svg"];\nconst dangerousTags = ["script", "base", "ba-se"];'
)

# Replace the script check with dangerousTags check (case-insensitive)
content = content.replace(
    'if (renderTag === "script")',
    'if (dangerousTags.includes(renderTag.toLowerCase()))'
)

# Update the class name
content = content.replace(
    'class: "script-to-pre"',
    'class: "mdc-renderer-dangerous-tag"'
)

# Update the output format - replace hardcoded script with renderTag
old_output = '"<script>\\n" + nodeTextContent(node) + "\\n<\\/script>"'
new_output = '"<" + renderTag + ">\\n" + nodeTextContent(node) + "\\n</" + renderTag + ">"'
content = content.replace(old_output, new_output)

with open(file_path, 'w') as f:
    f.write(content)

print("Python fix applied!")
PYTHON_FIX
    fi
fi

# The key challenge: Vite doesn't watch node_modules by default
# We need to invalidate Vite's dep cache for changes to take effect

# Option 1: Delete Vite's dep optimization cache
echo "Invalidating Vite dependency cache..."
rm -rf /app/node_modules/.vite 2>/dev/null || true

# Option 2: Touch the nuxt config to trigger a full config reload
touch /app/nuxt.config.ts 2>/dev/null || touch /app/nuxt.config.js 2>/dev/null || true

# For the server to pick up node_modules changes, we need to restart it
# But we need to do this carefully to avoid "Server not available" errors

# Check if server is currently running
if pgrep -f "nuxt dev" > /dev/null 2>&1; then
    echo "Server running. Sending HUP signal to reload..."
    # Try graceful reload first
    pkill -HUP -f "node.*nuxt" 2>/dev/null || true
    sleep 3
fi

# Verify server is running, if not restart it
if ! curl -s http://localhost:3000/ > /dev/null 2>&1; then
    echo "Server not responding. Restarting..."
    pkill -f "node.*nuxt" 2>/dev/null || true
    sleep 2

    # Start server in background using shell job control
    cd /app
    (nuxt dev --host 0.0.0.0 --port 3000 > /tmp/nuxt.log 2>&1) &

    # Wait for server to be ready (longer timeout for cold start after cache clear)
    echo "Waiting for server to start..."
    for i in $(seq 1 120); do
        if curl -s http://localhost:3000/ > /dev/null 2>&1; then
            echo "Server is ready!"
            break
        fi
        if [ $i -eq 120 ]; then
            echo "Warning: Server may not have started in time"
        fi
        sleep 1
    done
fi

echo "Fix complete."
