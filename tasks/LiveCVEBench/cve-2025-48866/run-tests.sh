#!/bin/bash
# Test runner for CVE-2025-48866 ModSecurity sanitiseArg tests
set -e

cd "$(dirname "$0")"

echo "=============================================="
echo "Running ModSecurity sanitiseArg Tests"
echo "=============================================="
echo ""

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "[*] Installing uv package manager..."
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env
fi

# Initialize uv project if not already done
if [ ! -f "pyproject.toml" ]; then
    echo "[*] Initializing uv project..."
    uv init 2>/dev/null || true
fi

# Install test dependencies
echo "[*] Installing test dependencies..."
uv add pytest requests 2>/dev/null

# Wait for server to be ready
echo "[*] Checking server availability..."
MAX_WAIT=30
WAITED=0
while ! curl -s http://localhost:8080/test.php > /dev/null 2>&1; do
    if [ $WAITED -ge $MAX_WAIT ]; then
        echo "[-] ERROR: Server not available after ${MAX_WAIT}s"
        exit 1
    fi
    echo "    Waiting for server... (${WAITED}s)"
    sleep 2
    WAITED=$((WAITED + 2))
done
echo "[+] Server is available"
echo ""

# Export test URL for tests
export TEST_URL="http://localhost:8080"

# Run tests with pytest
echo "=============================================="
echo "Running pytest..."
echo "=============================================="
uv run pytest . -rA -v

echo ""
echo "=============================================="
echo "Tests completed"
echo "=============================================="
