#!/bin/bash
# Note: Not using set -e to allow graceful fallback if pip install fails

cd "$(dirname "$0")"

echo "=== Setting up test environment ==="

# Try to install pytest and requests (may already be installed via Dockerfile)
pip install --quiet pytest requests 2>/dev/null || pip3 install --quiet pytest requests 2>/dev/null || echo "pip install skipped (pytest may already be installed)"

# Verify pytest is available
if ! command -v pytest &> /dev/null; then
    echo "ERROR: pytest not found. Checking alternative locations..."
    export PATH="/usr/local/bin:$PATH"
    if ! command -v pytest &> /dev/null; then
        echo "FATAL: pytest is not available"
        exit 1
    fi
fi

echo "pytest found at: $(which pytest)"

echo "=== Waiting for Volto server to be ready ==="
timeout=60
elapsed=0
while [ $elapsed -lt $timeout ]; do
    # Use raw Python socket to check if port is open (more reliable than requests)
    if python3 -c "
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.settimeout(3)
try:
    s.connect(('localhost', 3000))
    s.close()
    exit(0)
except:
    exit(1)
" 2>/dev/null; then
        echo "Volto server is ready!"
        break
    fi
    echo "Waiting for server... ($elapsed/$timeout seconds)"
    sleep 5
    elapsed=$((elapsed + 5))
done

if [ $elapsed -ge $timeout ]; then
    echo "WARNING: Timeout waiting for Volto server. Proceeding with tests anyway..."
fi

echo "=== Running tests ==="
pytest . -rA --tb=short
