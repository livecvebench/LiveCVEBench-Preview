"""
Vulnerability tests for XSS in wiki formatter.
These tests verify that XSS payloads are properly escaped.
- FAIL in vulnerable state (XSS is exploitable)
- PASS in fixed state (XSS is mitigated)
"""

import subprocess
import re
import base64


def run_php_format_test(input_text):
    """
    Run the wakka formatter on the given input text and return the output.
    Uses a persistent PHP wrapper script inside the container.
    """
    # Base64 encode the input to safely pass it
    encoded_input = base64.b64encode(input_text.encode('utf-8')).decode('ascii')

    result = subprocess.run(
        ['php', '/tests/test_formatter.php', encoded_input],
        capture_output=True,
        text=True,
        timeout=10
    )
    return result.stdout, result.stderr, result.returncode


def contains_unescaped_script_tag(html):
    """Check if HTML contains an unescaped <script> tag."""
    # Match literal <script> (not escaped &lt;script&gt;)
    # Use DOTALL to match across newlines
    return bool(re.search(r'<script[^>]*>', html, re.IGNORECASE | re.DOTALL))


def contains_unescaped_event_handler(html):
    """Check if HTML contains unescaped event handlers like onerror, onload, etc."""
    # Match unescaped img/svg tags with event handlers
    patterns = [
        r'<img[^>]+onerror\s*=',
        r'<img[^>]+onload\s*=',
        r'<svg[^>]+onload\s*=',
        r'<body[^>]+onload\s*=',
        r'<input[^>]+onfocus\s*=',
    ]
    for pattern in patterns:
        if re.search(pattern, html, re.IGNORECASE | re.DOTALL):
            return True
    return False


def contains_unescaped_img_tag(html):
    """Check if HTML contains an unescaped <img> tag (not in expected positions)."""
    # Match literal <img with src=x (malicious pattern)
    return bool(re.search(r'<img\s+src\s*=\s*x', html, re.IGNORECASE))


class TestXSSViaAsteriskItalic:
    """Test XSS payloads using asterisk italic markdown syntax."""

    def test_basic_script_tag(self):
        """Basic <script> tag injection via asterisk italic"""
        payload = "*<script>alert('XSS')</script>*"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        # After fix: should NOT contain unescaped script tag
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tag found in output: {output}"
        # Should contain escaped version
        assert "&lt;script&gt;" in output or "&lt;script" in output, \
            f"Script tag should be escaped in output: {output}"

    def test_script_with_alert(self):
        """Script tag with alert payload"""
        payload = "*<script>alert(document.cookie)</script>*"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tag found in output: {output}"

    def test_simple_script(self):
        """Simple script tag injection"""
        payload = "*<script>1</script>*"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tag found in output: {output}"

    def test_script_with_src(self):
        """Script tag with src attribute"""
        payload = "*<script src=evil.js></script>*"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tag found in output: {output}"


class TestXSSViaUnderscoreItalic:
    """Test XSS payloads using underscore italic markdown syntax."""

    def test_img_onerror(self):
        """IMG tag with onerror event handler"""
        payload = "_<img src=x onerror=alert('XSS')>_"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_event_handler(output), \
            f"XSS vulnerability: unescaped event handler found in output: {output}"
        assert not contains_unescaped_img_tag(output), \
            f"XSS vulnerability: malicious img tag found in output: {output}"

    def test_img_onload(self):
        """IMG tag with onload event handler"""
        payload = "_<img src=valid.jpg onload=alert('XSS')>_"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_event_handler(output), \
            f"XSS vulnerability: unescaped event handler found in output: {output}"

    def test_svg_onload(self):
        """SVG tag with onload event handler"""
        payload = "_<svg onload=alert('XSS')>_"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not re.search(r'<svg[^>]+onload', output, re.IGNORECASE), \
            f"XSS vulnerability: unescaped svg onload found in output: {output}"

    def test_script_in_underscore(self):
        """Script tag via underscore italic"""
        payload = "_<script>document.location='http://evil.com'</script>_"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tag found in output: {output}"


class TestXSSViaMarkdownHeading:
    """Test XSS payloads using markdown heading syntax."""

    def test_script_in_h1(self):
        """Script tag in h1 heading"""
        payload = "# <script>alert('XSS')</script>\n"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tag found in output: {output}"

    def test_img_onerror_in_h2(self):
        """IMG onerror in h2 heading"""
        payload = "## <img src=x onerror=alert('XSS')>\n"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_event_handler(output), \
            f"XSS vulnerability: unescaped event handler found in output: {output}"

    def test_script_in_h3(self):
        """Script in h3 heading"""
        payload = "### <script>fetch('http://evil.com')</script>\n"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tag found in output: {output}"

    def test_body_onload_in_heading(self):
        """Body tag with onload in heading"""
        payload = "# <body onload=alert('XSS')>\n"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not re.search(r'<body[^>]+onload', output, re.IGNORECASE), \
            f"XSS vulnerability: unescaped body onload found in output: {output}"


class TestMixedCaseAndVariations:
    """Test mixed case and various script tag variations."""

    def test_mixed_case_script(self):
        """Mixed case script tag"""
        payload = "*<ScRiPt>alert('XSS')</sCrIpT>*"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not re.search(r'<script', output, re.IGNORECASE), \
            f"XSS vulnerability: mixed case script tag not escaped: {output}"

    def test_uppercase_script(self):
        """Uppercase SCRIPT tag"""
        payload = "*<SCRIPT>alert('XSS')</SCRIPT>*"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not re.search(r'<script', output, re.IGNORECASE), \
            f"XSS vulnerability: uppercase script tag not escaped: {output}"


class TestMultiplePayloads:
    """Test multiple payloads in same input."""

    def test_multiple_italics_with_xss(self):
        """Multiple italic blocks with XSS"""
        payload = "*<script>alert(1)</script>* and _<img src=x onerror=alert(2)>_"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability in first payload: {output}"
        assert not contains_unescaped_event_handler(output), \
            f"XSS vulnerability in second payload: {output}"

    def test_heading_and_italic_xss(self):
        """Heading and italic both with XSS"""
        payload = "# <script>alert(1)</script>\n*<script>alert(2)</script>*"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: unescaped script tags found: {output}"


class TestVariousXSSPayloads:
    """Test various XSS payload styles."""

    def test_xss_with_double_quotes(self):
        """XSS with double quotes"""
        payload = '*<script>alert("XSS")</script>*'
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability: {output}"

    def test_deeply_nested_tags(self):
        """Deeply nested/malformed tags"""
        payload = "_<div><script><div>alert(1)</div></script></div>_"
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not contains_unescaped_script_tag(output), \
            f"XSS vulnerability in nested tags: {output}"

    def test_javascript_protocol(self):
        """javascript: protocol in anchor"""
        payload = '_<a href="javascript:alert(1)">click</a>_'
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        # The anchor tag should be escaped
        assert "&lt;a" in output or not re.search(r'<a[^>]+href\s*=\s*["\']?javascript:', output), \
            f"XSS vulnerability: javascript protocol in href: {output}"

    def test_onmouseover_event(self):
        """onmouseover event handler"""
        payload = '_<div onmouseover=alert(1)>hover</div>_'
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert not re.search(r'<div[^>]+onmouseover', output, re.IGNORECASE), \
            f"XSS vulnerability: unescaped onmouseover found: {output}"

    def test_iframe_injection(self):
        """iframe injection via italic"""
        payload = '_<iframe src="javascript:alert(1)"></iframe>_'
        output, stderr, code = run_php_format_test(payload)
        assert code == 0, f"PHP error: {stderr}"
        assert "&lt;iframe" in output or not re.search(r'<iframe', output, re.IGNORECASE), \
            f"XSS vulnerability: unescaped iframe found: {output}"
