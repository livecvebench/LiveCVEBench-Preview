#!/bin/bash
# Solution script for DjVuLibre MMR decoder buffer overflow fix
# Adds bounds checking to MMRDecoder::scanruns() to prevent out-of-bounds access
set -e

cd /app

echo "=== Applying fix to libdjvu/MMRDecoder.cpp ==="

# The fix needs to add two bounds checks:
# 1. At the start of the main for loop (after "// Process MMR codes")
# 2. Modify existing bounds check in uncompressed mode section

MMRDECODER_FILE="libdjvu/MMRDecoder.cpp"

if [ ! -f "$MMRDECODER_FILE" ]; then
    echo "ERROR: $MMRDECODER_FILE not found"
    exit 1
fi

# Create backup
cp "$MMRDECODER_FILE" "${MMRDECODER_FILE}.bak"

# Fix 1: Add bounds check after "// Process MMR codes" comment
# This check ensures xr and pr pointers don't exceed their buffer limits
sed -i '/\/\/ Process MMR codes/a\      // Check for buffer overflow\n      if (xr > lineruns+width+2 || pr > prevruns+width+2)\n          G_THROW(invalid_mmr_data);' "$MMRDECODER_FILE"

# Fix 2: Modify the existing bounds check in uncompressed mode
# Change: if (a0 > width)
# To:     if (a0 > width || xr > lineruns+width+2)
# This handles the uncompressed mode code path
sed -i 's/if (a0 > width)$/if (a0 > width || xr > lineruns+width+2)/' "$MMRDECODER_FILE"

echo "=== Verifying patch was applied ==="

# Verify fix 1 was applied
if grep -q "xr > lineruns+width+2 || pr > prevruns+width+2" "$MMRDECODER_FILE"; then
    echo "Fix 1 (main loop bounds check) applied successfully"
else
    echo "ERROR: Fix 1 not applied correctly"
    exit 1
fi

# Verify fix 2 was applied
if grep -q "a0 > width || xr > lineruns+width+2" "$MMRDECODER_FILE"; then
    echo "Fix 2 (uncompressed mode bounds check) applied successfully"
else
    echo "ERROR: Fix 2 not applied correctly"
    exit 1
fi

echo "=== Rebuilding DjVuLibre ==="

# Clean and rebuild
make clean 2>/dev/null || true
make -j$(nproc) 2>&1 | tail -20
make install 2>&1 | tail -5

echo "=== Fix applied and rebuilt successfully ==="

# Verify the fixed binary is in place
if command -v ddjvu &> /dev/null; then
    echo "ddjvu binary available at: $(which ddjvu)"
else
    echo "WARNING: ddjvu not found in PATH after rebuild"
fi

echo "Fix complete!"
