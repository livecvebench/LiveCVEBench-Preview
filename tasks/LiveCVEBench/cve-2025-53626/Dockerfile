FROM node:18

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y git tmux asciinema curl && rm -rf /var/lib/apt/lists/*

# Clone the vulnerable version and remove git history
RUN git clone --depth 1 --branch 5.4.0 https://github.com/pdfme/pdfme.git . && \
    rm -rf .git

# Copy mock postinstall script
COPY task-deps/link-workspaces.sh /app/scripts/link-workspaces.sh
RUN chmod +x /app/scripts/link-workspaces.sh

# Install dependencies (with legacy-peer-deps to handle peer dep warnings)
RUN npm install --legacy-peer-deps

# Build the common package
RUN npm run -w packages/common build

# Keep container running (this is a library, not a server)
CMD ["tail", "-f", "/dev/null"]
