#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install pytest and requests using pip (in system python which has Django)
pip install pytest requests 2>/dev/null || pip install --user pytest requests 2>/dev/null || true

# Ensure Django can find the app
export PYTHONPATH="/app:$PYTHONPATH"
export DJANGO_SETTINGS_MODULE="horilla.settings"

# Wait for application to be ready (if running)
echo "Waiting for application to be ready..."
for i in {1..30}; do
    if curl -s http://localhost:8000/ > /dev/null 2>&1; then
        echo "Application is ready"
        break
    fi
    echo "Waiting... ($i/30)"
    sleep 3
done

# Run tests with pytest
echo "Running tests..."
python -m pytest . -rA
