#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install uv if not present
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize project and install dependencies
uv init 2>/dev/null || true
# Pin cadwyn to vulnerable version 5.4.2 with compatible fastapi
uv add pytest "cadwyn==5.4.2" "fastapi==0.115.6" httpx 2>/dev/null

# Apply fix to UV-installed cadwyn if solution was applied
# The fix marker is created by solution.sh when it runs
if [ -f "/app/.fix_applied" ]; then
    echo "Applying fix to UV-installed cadwyn..."
    # Find cadwyn path in UV virtual environment
    UV_CADWYN_PATH=$(uv run python -c "import cadwyn; import os; print(os.path.dirname(cadwyn.__file__))")
    UV_APP_FILE="${UV_CADWYN_PATH}/applications.py"

    # Add import if not present
    if ! grep -q "from urllib.parse import quote" "$UV_APP_FILE" 2>/dev/null; then
        sed -i '/^from typing import/a from urllib.parse import quote' "$UV_APP_FILE"
    fi

    # Apply the fix using Python for reliability
    uv run python << 'FIXSCRIPT'
import os
import cadwyn

cadwyn_path = os.path.dirname(cadwyn.__file__)
app_file = os.path.join(cadwyn_path, 'applications.py')

with open(app_file, 'r') as f:
    content = f.read()

# Check if already fixed
if 'quote(version, safe=' in content:
    print("Already fixed!")
else:
    # Fix the vulnerable lines (both occurrences)
    content = content.replace(
        'openapi_url = root_path + f"{self.openapi_url}?version={version}"',
        "openapi_url = root_path + f\"{self.openapi_url}?version={quote(version, safe='')}\""
    )

    with open(app_file, 'w') as f:
        f.write(content)
    print("Fix applied to UV cadwyn!")
FIXSCRIPT
fi

# Run pytest with verbose output
uv run pytest . -rA
