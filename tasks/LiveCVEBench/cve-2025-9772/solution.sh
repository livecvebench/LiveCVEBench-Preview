#!/bin/bash
# Solution script for RemoteClinic file upload vulnerability
# Applies strict image validation to staff profile image upload

set -e

TARGET="/var/www/html/staff/edit.php"

echo "Applying fix to $TARGET..."

# Backup original file
cp "$TARGET" "$TARGET.bak"

# Use Python to apply the fix (more reliable for multiline replacements)
python3 << 'PYTHON_EOF'
import re

with open('/var/www/html/staff/edit.php', 'r') as f:
    content = f.read()

# Pattern to match the vulnerable upload code block
# Original code:
#   if(isset($_FILES["image"]["tmp_name"])&& $_FILES["image"]["tmp_name"]!=""){
#       $dest="../media/staff/$id".".png";
#       copy($_FILES["image"]["tmp_name"],$dest);
#   }

pattern = r'if\(isset\(\$_FILES\["image"\]\["tmp_name"\]\)&& \$_FILES\["image"\]\["tmp_name"\]!=""\)\s*\{\s*\$dest="\.\./media/staff/\$id"\.".png";\s*copy\(\$_FILES\["image"\]\["tmp_name"\],\$dest\);\s*\}'

# Fixed code with comprehensive validation:
# 1. Check MIME type is a valid image type
# 2. Verify actual image content using getimagesize()
# 3. Scan for dangerous content patterns (PHP, scripts, shell, etc.)
replacement = '''if(isset($_FILES["image"]["tmp_name"]) && $_FILES["image"]["tmp_name"]!=""){
			// Validate file MIME type before saving
			$allowed_types = array('image/jpeg', 'image/png', 'image/gif');
			$finfo = finfo_open(FILEINFO_MIME_TYPE);
			$mime_type = finfo_file($finfo, $_FILES["image"]["tmp_name"]);
			finfo_close($finfo);

			// Verify this is actually an image using getimagesize
			$image_info = @getimagesize($_FILES["image"]["tmp_name"]);
			$is_real_image = ($image_info !== false && isset($image_info[2]) && in_array($image_info[2], array(IMAGETYPE_GIF, IMAGETYPE_JPEG, IMAGETYPE_PNG)));

			// Scan content for dangerous patterns
			$file_content = file_get_contents($_FILES["image"]["tmp_name"]);
			$dangerous_patterns = array(
				'<?php',      // PHP opening tag
				'<?=',        // PHP short echo tag
				'<?',         // PHP short tag (will match any <? pattern)
				'<script',    // JavaScript/HTML script tag
				'__HALT_COMPILER', // PHAR marker
				'#!/bin/',    // Shell script shebang
				'#!/usr/bin/', // Alternative shebang
				'eval(',      // PHP eval function
				'base64_decode', // Common obfuscation
				'<svg',       // SVG files can contain scripts
				'<html',      // HTML files
				'<body',      // HTML body tag
			);

			$has_dangerous = false;
			foreach($dangerous_patterns as $pattern) {
				if(stripos($file_content, $pattern) !== false) {
					$has_dangerous = true;
					break;
				}
			}

			// Only save if:
			// 1. MIME type is allowed AND
			// 2. It's a real image (getimagesize validates) AND
			// 3. No dangerous content patterns found
			if(in_array($mime_type, $allowed_types) && $is_real_image && !$has_dangerous){
				$dest="../media/staff/$id".".png";
				move_uploaded_file($_FILES["image"]["tmp_name"], $dest);
			}
		}'''

# Check if the vulnerable pattern exists
if re.search(pattern, content):
    content = re.sub(pattern, replacement, content)
    with open('/var/www/html/staff/edit.php', 'w') as f:
        f.write(content)
    print("Fix applied successfully - vulnerable code replaced with validated version")
else:
    # Try alternative pattern (might have slightly different whitespace)
    alt_pattern = r'if\s*\(\s*isset\s*\(\s*\$_FILES\s*\[\s*"image"\s*\]\s*\[\s*"tmp_name"\s*\]\s*\)\s*&&\s*\$_FILES\s*\[\s*"image"\s*\]\s*\[\s*"tmp_name"\s*\]\s*!=\s*""\s*\)\s*\{\s*\$dest\s*=\s*"\.\./media/staff/\$id"\s*\.\s*"\.png"\s*;\s*copy\s*\(\s*\$_FILES\s*\[\s*"image"\s*\]\s*\[\s*"tmp_name"\s*\]\s*,\s*\$dest\s*\)\s*;\s*\}'

    if re.search(alt_pattern, content, re.DOTALL):
        content = re.sub(alt_pattern, replacement, content, flags=re.DOTALL)
        with open('/var/www/html/staff/edit.php', 'w') as f:
            f.write(content)
        print("Fix applied successfully using alternative pattern")
    else:
        # Fallback: direct string replacement
        old_code = '''if(isset($_FILES["image"]["tmp_name"])&& $_FILES["image"]["tmp_name"]!=""){
			$dest="../media/staff/$id".".png";
			copy($_FILES["image"]["tmp_name"],$dest);
		}'''

        if old_code in content:
            content = content.replace(old_code, replacement)
            with open('/var/www/html/staff/edit.php', 'w') as f:
                f.write(content)
            print("Fix applied successfully using direct replacement")
        else:
            print("Warning: Could not find vulnerable code pattern")
            print("Checking if file might already be fixed...")
            if 'finfo_open(FILEINFO_MIME_TYPE)' in content:
                print("File appears to already have MIME validation - may already be fixed")
            else:
                print("ERROR: Could not apply fix - vulnerable pattern not found")
                exit(1)

PYTHON_EOF

echo "Fix application complete."

# Clean up any non-image files in the media/staff directory
# This removes malicious files that may have been uploaded before the fix
echo "Cleaning up malicious uploads in /var/www/html/media/staff/..."
python3 << 'CLEANUP_EOF'
import os
import glob

staff_dir = "/var/www/html/media/staff"
if os.path.exists(staff_dir):
    for filepath in glob.glob(os.path.join(staff_dir, "*.png")):
        try:
            with open(filepath, 'rb') as f:
                content = f.read()

            # Check if it's a valid image based on magic bytes
            is_valid = False

            # PNG signature
            if content[:8] == b'\x89PNG\r\n\x1a\n':
                is_valid = True
            # JPEG signature
            elif content[:2] == b'\xff\xd8':
                is_valid = True
            # GIF signatures
            elif content[:6] in [b'GIF87a', b'GIF89a']:
                is_valid = True

            # Additional check: scan for dangerous patterns
            if is_valid:
                dangerous_patterns = [
                    b'<?php', b'<?=', b'<?', b'<script',
                    b'__HALT_COMPILER', b'#!/bin/', b'#!/usr/bin/',
                    b'eval(', b'base64_decode'
                ]
                for pattern in dangerous_patterns:
                    if pattern in content:
                        is_valid = False
                        break

            if not is_valid:
                os.remove(filepath)
                print(f"Removed malicious file: {filepath}")
        except Exception as e:
            print(f"Error checking {filepath}: {e}")
    print("Cleanup complete.")
else:
    print("Staff media directory does not exist yet.")
CLEANUP_EOF

# Restart Apache to ensure changes take effect (PHP files are typically not cached,
# but this ensures any opcode cache is cleared)
if command -v apache2ctl &> /dev/null; then
    apache2ctl graceful 2>/dev/null || true
elif command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
fi

echo "Done."
