#!/bin/bash
# Entrypoint script with restart capability for Horilla HRMS
# This script keeps the container running and allows service restart

cd /app

# Run database migrations if not already done
if [ ! -f /app/.migrated ]; then
    echo "Running database migrations..."
    # First make any missing migrations
    python manage.py makemigrations --noinput || true
    # Then run all migrations
    python manage.py migrate --noinput

    # Try to create admin user using the Horilla custom command if available
    # Otherwise use shell to create superuser
    echo "Creating admin user..."
    python manage.py shell -c "
from django.contrib.auth import get_user_model
User = get_user_model()
if not User.objects.filter(username='admin').exists():
    user = User.objects.create_superuser('admin', 'admin@example.com', 'admin123')
    print('Admin user created successfully')
else:
    print('Admin user already exists')
" || echo "Admin user creation skipped or failed"

    touch /app/.migrated
fi

# Start the Django development server in a loop for restart capability
while true; do
    echo "Starting Django development server..."
    python manage.py runserver 0.0.0.0:8000

    # If server exits, wait a moment then restart
    echo "Server stopped, restarting in 2 seconds..."
    sleep 2
done
