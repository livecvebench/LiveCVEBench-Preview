#!/bin/bash

# Entrypoint script for soft-serve
# Wraps the service in a restart loop so container stays running
# when solution.sh kills and restarts the service process

export SOFT_SERVE_DATA_PATH="${SOFT_SERVE_DATA_PATH:-/soft-serve}"
export CI="${CI:-1}"

# Generate SSH keys if they don't exist
if [ ! -f /root/.ssh/id_ed25519 ]; then
    mkdir -p /root/.ssh
    ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N ""
    chmod 600 /root/.ssh/id_ed25519
    chmod 644 /root/.ssh/id_ed25519.pub
fi

# Extract the public key for admin access
export SOFT_SERVE_INITIAL_ADMIN_KEYS=$(cat /root/.ssh/id_ed25519.pub)

# Restart loop - keep the service running
while true; do
    echo "Starting soft-serve..."
    /usr/local/bin/soft serve
    exit_code=$?
    echo "soft-serve exited with code $exit_code. Restarting in 2 seconds..."
    sleep 2
done
