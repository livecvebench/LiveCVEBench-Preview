#!/bin/bash
# Solution script for WeGIA password configuration page output encoding issue
# This fix applies htmlspecialchars() to properly encode employee names and positions
# when rendering them in HTML option elements.

set -e

FILE="/var/www/html/WeGIA/html/geral/configurar_senhas.php"

echo "Applying fix to $FILE..."

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "Error: File not found: $FILE"
    exit 1
fi

# Create backup
cp "$FILE" "${FILE}.bak"

# The vulnerable code pattern is:
# echo "<option value=".$row[1].">".$row[0]. " - " . $row[2] ."</option>";
#
# This needs to be changed to use htmlspecialchars() on all output values:
# echo "<option value=".htmlspecialchars($row[1]).">".htmlspecialchars($row[0]). " - " . htmlspecialchars($row[2]) ."</option>";

# Use sed to fix the vulnerable echo statement
# We need to escape the special characters properly for sed
sed -i 's/echo "<option value="\.\$row\[1\]\.">"\.\$row\[0\]\. " - " \. \$row\[2\] \."<\/option>";/echo "<option value=".htmlspecialchars(\$row[1]).">".htmlspecialchars(\$row[0]). " - " . htmlspecialchars(\$row[2]) ."<\/option>";/g' "$FILE"

# Also fix the reflected XSS in the verificacao GET parameter
# Change: var verificacao = '<?php echo $_GET['verificacao'];?>';
# To: var verificacao = '<?php echo htmlspecialchars($_GET['verificacao']);?>';
# Or: const verificacao = '<?= htmlspecialchars($_GET['verificacao']) ?>';

sed -i "s/var verificacao = '<?php echo \$_GET\['verificacao'\];?>';/var verificacao = '<?php echo htmlspecialchars(\$_GET['verificacao']);?>';/g" "$FILE"

# Verify the fix was applied
if grep -q "htmlspecialchars(\$row\[0\])" "$FILE" 2>/dev/null; then
    echo "Fix successfully applied to employee name output."
else
    echo "Warning: Primary fix pattern not found. The file structure may have changed."
    echo "Attempting alternative fix approach..."

    # Alternative: Use the fixed file from task-deps if available
    if [ -f "/task-deps/fixed_configurar_senhas.php" ]; then
        cp /task-deps/fixed_configurar_senhas.php "$FILE"
        echo "Applied fix using pre-patched file."
    else
        # Restore backup and try a different approach
        cp "${FILE}.bak" "$FILE"

        # Try a more flexible sed pattern that handles whitespace variations
        sed -i 's/\$row\[0\]/htmlspecialchars($row[0])/g' "$FILE"
        sed -i 's/\$row\[2\]/htmlspecialchars($row[2])/g' "$FILE"

        # Avoid double-wrapping if already fixed
        sed -i 's/htmlspecialchars(htmlspecialchars/htmlspecialchars(/g' "$FILE"

        echo "Applied alternative fix."
    fi
fi

# Verify the page still has valid PHP syntax
php -l "$FILE" 2>/dev/null && echo "PHP syntax check passed." || echo "Warning: PHP syntax check skipped or failed."

# Clean up backup
rm -f "${FILE}.bak"

# Since this is a PHP file served by Apache, no service restart is needed
# (PHP files are interpreted on each request)

echo "Fix applied successfully!"
echo ""
echo "Changes made:"
echo "  - Employee names (nome) are now HTML-encoded before output"
echo "  - Position names (cargo) are now HTML-encoded before output"
echo "  - GET parameter 'verificacao' is now HTML-encoded before output"
