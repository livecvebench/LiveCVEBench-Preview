"""
Vulnerability tests for md-to-pdf library.
Tests that JavaScript execution in front-matter via ---javascript delimiter is exploitable.

These tests should:
- FAIL in vulnerable state (vulnerability is exploitable via ---javascript)
- PASS in fixed state (vulnerability is mitigated)

Note: The bug is that the config uses 'js' as the key instead of 'javascript'.
Since gray-matter aliases both to 'javascript', the ---javascript delimiter
bypasses the blocked 'js' engine.
"""

import subprocess
import os
import time
import uuid


def run_md_to_pdf(input_path, timeout=60):
    """Helper function to run md-to-pdf conversion."""
    result = subprocess.run(
        ['npx', 'md-to-pdf', input_path,
         '--launch-options', '{"args": ["--no-sandbox", "--disable-setuid-sandbox"]}'],
        capture_output=True,
        text=True,
        cwd='/app',
        timeout=timeout
    )
    return result


def cleanup_evidence_file(filepath):
    """Remove evidence file if it exists."""
    if os.path.exists(filepath):
        os.remove(filepath)


class TestJavaScriptDelimiterVulnerable:
    """
    Test that ---javascript front-matter delimiter executes code (vulnerable).

    In the vulnerable version (5.2.4), the config blocks 'js' engine but
    gray-matter resolves both 'js' and 'javascript' to 'javascript'.
    So ---javascript bypasses the block.
    """

    def test_javascript_delimiter_rce(self):
        """Test that ---javascript front-matter executes code (vulnerability test)."""
        evidence_file = f'/tmp/rce_javascript_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        # This payload uses ---javascript which bypasses the buggy 'js' block
        payload = f'''---javascript
((require("child_process")).execSync("echo VULNERABLE > {evidence_file}"))
---
# Test Document
'''
        input_path = '/tmp/malicious_javascript.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        # In VULNERABLE state: file should be created (RCE works) -> test FAILS
        # In FIXED state: file should NOT be created (RCE blocked) -> test PASSES
        assert not os.path.exists(evidence_file), \
            f"RCE occurred! Evidence file {evidence_file} was created. " \
            "JavaScript execution in ---javascript front-matter should be blocked."

    def test_javascript_fs_write(self):
        """Test that require('fs').writeFileSync works via ---javascript."""
        evidence_file = f'/tmp/rce_fs_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        payload = f'''---javascript
require("fs").writeFileSync("{evidence_file}", "pwned via fs.writeFileSync")
---
# File System Write Test
'''
        input_path = '/tmp/malicious_fs.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        assert not os.path.exists(evidence_file), \
            f"RCE via fs.writeFileSync occurred! Evidence file {evidence_file} was created."

    def test_javascript_child_process_exec(self):
        """Test that child_process.execSync works via ---javascript."""
        evidence_file = f'/tmp/rce_exec_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        payload = f'''---javascript
require("child_process").execSync("touch {evidence_file}")
---
# Child Process Test
'''
        input_path = '/tmp/malicious_exec.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        assert not os.path.exists(evidence_file), \
            f"RCE via child_process.execSync occurred! Evidence file {evidence_file} was created."

    def test_javascript_env_access(self):
        """Test that process.env is accessible via ---javascript."""
        evidence_file = f'/tmp/rce_env_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        payload = f'''---javascript
require("fs").writeFileSync("{evidence_file}", JSON.stringify(process.env))
---
# Environment Access Test
'''
        input_path = '/tmp/malicious_env.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        assert not os.path.exists(evidence_file), \
            f"Environment variable access occurred! Evidence file {evidence_file} was created."

    def test_javascript_iife_payload(self):
        """Test IIFE (Immediately Invoked Function Expression) payload."""
        evidence_file = f'/tmp/rce_iife_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        payload = f'''---javascript
(() => {{
    const {{ execSync }} = require("child_process");
    execSync("echo iife > {evidence_file}");
    return {{ title: "test" }};
}})()
---
# IIFE Test
'''
        input_path = '/tmp/malicious_iife.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        assert not os.path.exists(evidence_file), \
            f"RCE via IIFE payload occurred! Evidence file {evidence_file} was created."

    def test_javascript_file_read(self):
        """Test reading sensitive files via ---javascript."""
        evidence_file = f'/tmp/rce_passwd_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        # Use single expression that reads and writes
        payload = f'''---javascript
require("fs").writeFileSync("{evidence_file}", require("fs").readFileSync("/etc/passwd", "utf8").substring(0, 50))
---
# File Read Test
'''
        input_path = '/tmp/malicious_read.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        assert not os.path.exists(evidence_file), \
            f"File read via RCE occurred! Evidence file {evidence_file} was created."

    def test_javascript_command_output(self):
        """Test capturing command output via ---javascript."""
        evidence_file = f'/tmp/rce_id_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        # Use single expression
        payload = f'''---javascript
require("fs").writeFileSync("{evidence_file}", require("child_process").execSync("id").toString())
---
# Command Output Test
'''
        input_path = '/tmp/malicious_id.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        assert not os.path.exists(evidence_file), \
            f"Command execution with output capture occurred! Evidence file {evidence_file} was created."

    def test_javascript_hostname_leak(self):
        """Test leaking hostname via ---javascript."""
        evidence_file = f'/tmp/rce_hostname_{uuid.uuid4().hex[:8]}.txt'
        cleanup_evidence_file(evidence_file)

        payload = f'''---javascript
require("child_process").execSync("hostname > {evidence_file}")
---
# Hostname Test
'''
        input_path = '/tmp/malicious_hostname.md'

        with open(input_path, 'w') as f:
            f.write(payload)

        try:
            run_md_to_pdf(input_path, timeout=30)
        except subprocess.TimeoutExpired:
            pass

        time.sleep(2)

        assert not os.path.exists(evidence_file), \
            f"Hostname leak via RCE occurred! Evidence file {evidence_file} was created."
