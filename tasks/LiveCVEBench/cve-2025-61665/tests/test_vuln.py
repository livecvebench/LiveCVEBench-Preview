"""
Vulnerability tests for WeGIA member reports endpoint.
These tests verify that unauthenticated access to sensitive data is blocked.

Before fix (vulnerable): Tests FAIL because sensitive data is exposed without authentication
After fix (secure): Tests PASS because unauthenticated requests are blocked
"""
import pytest
import requests
import time

BASE_URL = "http://localhost"
ENDPOINT = "/WeGIA/html/socio/sistema/get_relatorios_socios.php"

# Sensitive fields that should NOT be exposed to unauthenticated users
SENSITIVE_FIELDS = ["cpf", "telefone", "nome", "email", "valor_periodo"]


def wait_for_server(timeout=60):
    """Wait for the web server to be ready."""
    start = time.time()
    while time.time() - start < timeout:
        try:
            response = requests.get(f"{BASE_URL}/WeGIA/", timeout=5)
            if response.status_code in [200, 302, 403]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(1)
    return False


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure the server is ready before running tests."""
    assert wait_for_server(), "Web server failed to start"


def test_unauthenticated_access_blocked():
    """
    Test that unauthenticated requests cannot access member data.

    The endpoint should require authentication before returning any sensitive
    member information. Without a valid session, requests should receive
    an error response or redirect, NOT the actual member data.
    """
    params = {
        "tipo_socio": "x",
        "tipo_pessoa": "x",
        "operador": "maior_q",
        "valor": "",
        "tag": "x",
        "status": "x"
    }

    # Make request WITHOUT any authentication (no session cookies)
    response = requests.get(
        f"{BASE_URL}{ENDPOINT}",
        params=params,
        allow_redirects=False
    )

    # Check for proper authentication enforcement
    # Fixed behavior: Should return error (400) or redirect (302/303)
    # Vulnerable behavior: Returns 200 with member data

    if response.status_code == 200:
        # If we get 200, check if it's returning sensitive data (vulnerable)
        # or an error message (acceptable)
        try:
            data = response.json()

            # If data is None or empty list, that's acceptable
            if data is None or data == []:
                return

            # If it's an error message dict, that's acceptable
            if isinstance(data, dict) and "erro" in data:
                return

            # If it's a list with member data, that's a vulnerability
            if isinstance(data, list) and len(data) > 0:
                first_record = data[0]
                # Check if sensitive fields are exposed
                exposed_fields = [f for f in SENSITIVE_FIELDS if f in first_record]
                if exposed_fields:
                    pytest.fail(
                        f"VULNERABILITY: Unauthenticated request returned sensitive data! "
                        f"Exposed fields: {exposed_fields}. "
                        f"The endpoint should require authentication."
                    )
        except ValueError:
            # Non-JSON response with 200 status is unusual but not necessarily vulnerable
            pass

    elif response.status_code == 400:
        # HTTP 400 with error message is correct behavior
        try:
            data = response.json()
            assert "erro" in data or "error" in data, \
                "400 response should contain error message"
        except ValueError:
            pass  # Non-JSON 400 is also acceptable

    elif response.status_code in [302, 303]:
        # Redirect to login/home is correct behavior
        pass

    elif response.status_code == 403:
        # Forbidden is correct behavior
        pass

    else:
        # Other status codes might indicate issues
        pytest.fail(
            f"Unexpected response status: {response.status_code}. "
            f"Expected 400 (error), 302/303 (redirect), or 403 (forbidden)"
        )


def test_no_sensitive_data_without_auth():
    """
    Verify that no sensitive member data is accessible without authentication.

    This test specifically checks that personal identifiable information (PII)
    like names, phone numbers, and identification numbers are not exposed.
    """
    params = {
        "tipo_socio": "x",
        "tipo_pessoa": "x",
        "operador": "maior_q",
        "valor": "",
        "tag": "x",
        "status": "x"
    }

    response = requests.get(
        f"{BASE_URL}{ENDPOINT}",
        params=params,
        allow_redirects=False
    )

    # If there's any response body, check it doesn't contain sensitive data
    response_text = response.text.lower()

    # Known test data values that should NOT appear in unauthenticated responses
    # These are from the test database - if they appear, data is being leaked
    test_data_indicators = [
        "luis barango",       # Test member name
        "maria silva",        # Test member name
        "649.659.320-56",     # Test CPF
        "123.456.789-01",     # Test CPF
        "(71)98642-1278",     # Test phone
        "(21)99999-1234",     # Test phone
    ]

    for indicator in test_data_indicators:
        if indicator.lower() in response_text:
            pytest.fail(
                f"VULNERABILITY: Sensitive test data '{indicator}' found in response! "
                f"Member data is exposed without authentication."
            )


def test_session_required_for_data_access():
    """
    Test that the endpoint properly validates session before returning data.

    The fix should check for a valid session with 'id_pessoa' set before
    processing the request.
    """
    params = {
        "tipo_socio": "x",
        "tipo_pessoa": "x",
        "operador": "maior_q",
        "valor": "",
        "tag": "x",
        "status": "x"
    }

    # Test with no cookies at all
    response_no_cookies = requests.get(
        f"{BASE_URL}{ENDPOINT}",
        params=params,
        allow_redirects=False,
        cookies={}
    )

    # Test with empty/invalid session
    response_empty_session = requests.get(
        f"{BASE_URL}{ENDPOINT}",
        params=params,
        allow_redirects=False,
        cookies={"PHPSESSID": "invalid_session_12345"}
    )

    for response in [response_no_cookies, response_empty_session]:
        # Should NOT return 200 with member data
        if response.status_code == 200:
            try:
                data = response.json()
                if isinstance(data, list) and len(data) > 0:
                    if any(f in data[0] for f in SENSITIVE_FIELDS):
                        pytest.fail(
                            "VULNERABILITY: Endpoint returns member data without valid session! "
                            "Session validation is missing or ineffective."
                        )
            except ValueError:
                pass


def test_filtered_request_also_blocked():
    """
    Test that filtered requests also require authentication.

    Even when using specific filters (e.g., status=1 for active members only),
    the endpoint should still require authentication.
    """
    # Try with specific filters that might return fewer results
    params = {
        "tipo_socio": "m",     # Monthly members only
        "tipo_pessoa": "f",    # Physical persons only
        "operador": "maior_q",
        "valor": "1000",       # Filter for values > 1000 (should match some records)
        "tag": "1",            # Specific tag
        "status": "1"          # Active only
    }

    response = requests.get(
        f"{BASE_URL}{ENDPOINT}",
        params=params,
        allow_redirects=False
    )

    # Even with filters, should require authentication
    if response.status_code == 200:
        try:
            data = response.json()
            if isinstance(data, list) and len(data) > 0:
                if any(f in data[0] for f in SENSITIVE_FIELDS):
                    pytest.fail(
                        "VULNERABILITY: Filtered request still exposes data without auth! "
                        "All requests to this endpoint should require authentication."
                    )
        except ValueError:
            pass
