#!/bin/bash
set -e

# Fix: Add Content-Security-Policy headers to query.php
# This prevents inline script execution in feed content

QUERY_FILE="/var/www/FreshRSS/p/api/query.php"

# Check if file exists
if [ ! -f "$QUERY_FILE" ]; then
    # Try alternate location
    QUERY_FILE="/app/p/api/query.php"
    if [ ! -f "$QUERY_FILE" ]; then
        echo "Error: query.php not found"
        exit 1
    fi
fi

echo "Patching: $QUERY_FILE"

# Check if already fixed
if grep -q "Content-Security-Policy" "$QUERY_FILE"; then
    echo "Fix already applied (CSP headers found)"
    exit 0
fi

# Create backup
cp "$QUERY_FILE" "${QUERY_FILE}.bak"

# Use Python for more reliable text manipulation
python3 << 'PYTHONEOF'
import os

filepath = "/var/www/FreshRSS/p/api/query.php"
if not os.path.exists(filepath):
    filepath = "/app/p/api/query.php"

with open(filepath, 'r') as f:
    content = f.read()

# 1. Add X-Content-Type-Options header after declare(strict_types=1);
content = content.replace(
    'declare(strict_types=1);\nrequire(',
    "declare(strict_types=1);\n\nheader('X-Content-Type-Options: nosniff');\n\nrequire("
)

# 2. Add format-specific CSP header EARLY, right after the format validation
# This ensures CSP is applied even on error responses (404, 422, etc.)
# Find the pattern after format validation and before user validation
old_pattern = """$user = Minz_Request::paramString('user');
if (!FreshRSS_user_Controller::checkUsername($user)) {"""

new_pattern = """// Apply format-specific Content-Security-Policy early to protect all responses
// This ensures CSP is present even on error paths (404, 422, 503)
if (in_array($format, ['rss', 'atom', 'greader', 'json', 'opml'], true)) {
    header("Content-Security-Policy: default-src 'none'; frame-ancestors 'none'; sandbox");
} else {
    header("Content-Security-Policy: default-src 'self'; frame-src *; img-src * data:; frame-ancestors 'none'; media-src *");
}

$user = Minz_Request::paramString('user');
if (!FreshRSS_user_Controller::checkUsername($user)) {"""

content = content.replace(old_pattern, new_pattern)

# 3. Add CSP header for RSS/Atom format output (override for when output is rendered)
content = content.replace(
    "header('Content-Type: application/rss+xml; charset=utf-8');\n\t$view->_layout(null);",
    'header(\'Content-Type: application/rss+xml; charset=utf-8\');\n\theader("Content-Security-Policy: default-src \'none\'; frame-ancestors \'none\'; sandbox");\n\t$view->_layout(null);'
)

# 4. Add CSP header for JSON/greader format output
content = content.replace(
    "header('Content-Type: application/json; charset=utf-8');\n\t$view->_layout(null);",
    'header(\'Content-Type: application/json; charset=utf-8\');\n\theader("Content-Security-Policy: default-src \'none\'; frame-ancestors \'none\'; sandbox");\n\t$view->_layout(null);'
)

# 5. Add CSP header for OPML format output
content = content.replace(
    "header('Content-Type: application/xml; charset=utf-8');\n\t$view->_layout(null);\n\t$view->_path('index/opml.phtml');",
    'header(\'Content-Type: application/xml; charset=utf-8\');\n\theader("Content-Security-Policy: default-src \'none\'; frame-ancestors \'none\'; sandbox");\n\t$view->_layout(null);\n\t$view->_path(\'index/opml.phtml\');'
)

# 6. Add CSP header for HTML format output (in the else block)
content = content.replace(
    "} else {\n\t$view->_layout('layout');",
    '} else {\n\theader("Content-Security-Policy: default-src \'self\'; frame-src *; img-src * data:; frame-ancestors \'none\'; media-src *");\n\t$view->_layout(\'layout\');'
)

with open(filepath, 'w') as f:
    f.write(content)

print("Python fix applied successfully")
PYTHONEOF

# Verify PHP syntax
if php -l "$QUERY_FILE" 2>&1 | grep -q "No syntax errors"; then
    echo "PHP syntax OK"
else
    echo "PHP syntax error detected, restoring backup..."
    cp "${QUERY_FILE}.bak" "$QUERY_FILE"
    exit 1
fi

# Verify the fix was applied
if grep -q "Content-Security-Policy" "$QUERY_FILE"; then
    echo "Fix verified: CSP headers added to query.php"
    rm -f "${QUERY_FILE}.bak"
else
    echo "Fix verification failed"
    cp "${QUERY_FILE}.bak" "$QUERY_FILE"
    exit 1
fi

# Gracefully reload Apache if running
if pgrep -x "apache2" > /dev/null || pgrep -x "httpd" > /dev/null; then
    if command -v apachectl &> /dev/null; then
        apachectl graceful 2>/dev/null || true
    elif command -v apache2ctl &> /dev/null; then
        apache2ctl graceful 2>/dev/null || true
    fi
    echo "Apache reloaded"
fi

echo "Solution completed"
