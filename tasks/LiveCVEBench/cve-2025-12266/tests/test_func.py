"""
Functional tests for ThinkPHP Widget Controller.

These tests verify that legitimate widget functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""
import requests
import pytest
import os
import time

# Base URL for the application
BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")


class TestWidgetBasicFunctionality:
    """Test that basic widget endpoint responds correctly."""

    def test_widget_endpoint_accessible(self):
        """Test that the widget endpoint is accessible."""
        response = requests.get(f"{BASE_URL}/index.php/auth/widget", timeout=10)
        # Should return some response (not a connection error)
        assert response.status_code in [200, 404, 500], \
            f"Widget endpoint should be accessible, got {response.status_code}"

    def test_index_endpoint_accessible(self):
        """Test that the main index endpoint is accessible."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=10)
        assert response.status_code in [200, 302, 404], \
            f"Index endpoint should be accessible, got {response.status_code}"

    def test_widget_index_action(self):
        """Test the widget index action."""
        response = requests.get(f"{BASE_URL}/index.php/auth/widget/index", timeout=10)
        # Should return some response without server crash
        assert response.status_code in [200, 404, 500]


class TestValidWidgetParameters:
    """Test that valid widget parameters are accepted."""

    def test_default_layer_parameter(self):
        """Test that default/valid layer parameter works."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.layer=view",
            timeout=10
        )
        # Should not cause server error
        assert response.status_code != 502, "Server should not crash with valid layer"

    def test_default_widget_parameter(self):
        """Test that default/valid widget parameter works."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.widget=default",
            timeout=10
        )
        assert response.status_code != 502, "Server should not crash with valid widget"

    def test_default_action_parameter(self):
        """Test that default/valid action parameter works."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.action=render",
            timeout=10
        )
        assert response.status_code != 502, "Server should not crash with valid action"

    def test_valid_parameter_combination(self):
        """Test a valid combination of all parameters."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.layer=view&get.widget=default&get.action=render",
            timeout=10
        )
        # Should process without crashing
        assert response.status_code != 502, "Server should handle valid parameter combination"

    def test_widget_header_parameter(self):
        """Test that header widget parameter works."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.widget=header",
            timeout=10
        )
        assert response.status_code != 502, "Server should handle header widget"

    def test_widget_footer_parameter(self):
        """Test that footer widget parameter works."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.widget=footer",
            timeout=10
        )
        assert response.status_code != 502, "Server should handle footer widget"


class TestWidgetRenderEndpoint:
    """Test the widget render endpoint functionality."""

    def test_render_endpoint_accessible(self):
        """Test that render endpoint is accessible."""
        response = requests.get(f"{BASE_URL}/index.php/auth/widget/render", timeout=10)
        assert response.status_code in [200, 404, 500]

    def test_render_with_valid_params(self):
        """Test render endpoint with valid parameters."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget/render?get.layer=view&get.widget=default&get.action=render",
            timeout=10
        )
        assert response.status_code != 502


class TestApplicationStability:
    """Test that the application remains stable under normal use."""

    def test_multiple_sequential_requests(self):
        """Test that multiple sequential requests don't crash the server."""
        for i in range(5):
            response = requests.get(f"{BASE_URL}/index.php/auth/widget", timeout=10)
            assert response.status_code != 502, f"Request {i+1} should not crash server"

    def test_empty_parameters_handled(self):
        """Test that empty parameters are handled gracefully."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.layer=&get.widget=&get.action=",
            timeout=10
        )
        # Should handle empty params without crashing
        assert response.status_code in [200, 400, 404, 500]

    def test_missing_parameters_handled(self):
        """Test that missing parameters use defaults."""
        response = requests.get(f"{BASE_URL}/index.php/auth/widget", timeout=10)
        # Should use default values without crashing
        assert response.status_code in [200, 404, 500]


class TestResponseContent:
    """Test response content for valid requests."""

    def test_response_is_html_or_json(self):
        """Test that response has valid content type."""
        response = requests.get(f"{BASE_URL}/index.php/auth/widget", timeout=10)
        content_type = response.headers.get('Content-Type', '')
        # Should return HTML or JSON, not binary or empty
        assert any(ct in content_type.lower() for ct in ['text', 'html', 'json']) or \
               len(response.content) > 0

    def test_no_php_errors_in_response(self):
        """Test that response doesn't contain raw PHP errors."""
        response = requests.get(
            f"{BASE_URL}/index.php/auth/widget?get.widget=default",
            timeout=10
        )
        # Check for common PHP error patterns (these should be handled gracefully)
        error_patterns = ['Parse error', 'Fatal error: Uncaught']
        for pattern in error_patterns:
            assert pattern not in response.text, \
                f"Response should not contain raw PHP error: {pattern}"
