"""
Functional tests for HAXcms PHP.

These tests verify that the application works correctly in both
vulnerable and fixed states. They should PASS regardless of whether
the vulnerability has been fixed.
"""

import pytest
import requests
import subprocess
import time
import os

# Configuration
BASE_URL = os.environ.get("BASE_URL", "http://localhost:80")
APP_PATH = "/var/www/html"


def wait_for_server(url, timeout=60):
    """Wait for the server to be available."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            resp = requests.get(url, timeout=5)
            if resp.status_code < 500:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


class TestApplicationFunctionality:
    """Test basic application functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test fixtures."""
        self.base_url = BASE_URL
        assert wait_for_server(self.base_url), "Server did not start in time"

    def test_server_responds(self):
        """Test that the server responds to requests."""
        response = requests.get(self.base_url, timeout=10)
        # Server should respond (any response is fine, even 404)
        assert response.status_code is not None

    def test_api_endpoint_exists(self):
        """Test that the system API route exists."""
        # Try to access the API - should get some response (not a connection error)
        response = requests.get(f"{self.base_url}/system/api", timeout=10)
        # Even 404 or 400 is acceptable - shows routing works
        assert response.status_code is not None

    def test_login_endpoint_accessible(self):
        """Test that the login endpoint can be reached."""
        # The login endpoint should be accessible
        response = requests.post(
            f"{self.base_url}/system/api/login",
            json={"username": "admin", "password": "wrong"},
            timeout=10
        )
        # Should get a response (even if login fails)
        assert response.status_code in [200, 400, 401, 403, 404, 500]

    def test_operations_php_exists(self):
        """Test that Operations.php file exists in the application."""
        operations_path = f"{APP_PATH}/system/backend/php/lib/Operations.php"
        result = subprocess.run(
            ["ls", "-la", operations_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Operations.php not found at {operations_path}"

    def test_git_php_exists(self):
        """Test that Git.php file exists in the application."""
        git_path = f"{APP_PATH}/system/backend/php/lib/Git.php"
        result = subprocess.run(
            ["ls", "-la", git_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Git.php not found at {git_path}"

    def test_php_syntax_valid(self):
        """Test that modified PHP files have valid syntax."""
        operations_path = f"{APP_PATH}/system/backend/php/lib/Operations.php"
        result = subprocess.run(
            ["php", "-l", operations_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"PHP syntax error: {result.stderr}"

    def test_config_directory_exists(self):
        """Test that the _config directory exists."""
        config_path = f"{APP_PATH}/_config"
        result = subprocess.run(
            ["ls", "-la", config_path],
            capture_output=True,
            text=True
        )
        # Directory should exist for app to function
        assert result.returncode == 0 or "No such file" not in result.stderr


class TestGitLibraryFunctionality:
    """Test Git library functionality (non-exploitative)."""

    def test_git_class_exists(self):
        """Test that Git class is properly defined."""
        git_path = f"{APP_PATH}/system/backend/php/lib/Git.php"
        result = subprocess.run(
            ["grep", "-c", "class Git", git_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, "Git class not found"
        assert int(result.stdout.strip()) >= 1, "Git class not defined"

    def test_gitrepo_class_exists(self):
        """Test that GitRepo class is properly defined."""
        git_path = f"{APP_PATH}/system/backend/php/lib/Git.php"
        result = subprocess.run(
            ["grep", "-c", "class GitRepo", git_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, "GitRepo class not found"
        assert int(result.stdout.strip()) >= 1, "GitRepo class not defined"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
