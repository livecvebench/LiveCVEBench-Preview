# CVE-2025-52903 - File Browser v2.32.0 Environment
# Uses pre-built binary with embedded frontend assets
# Keeps Go toolchain for solution rebuild capability

FROM golang:1.23-bookworm

WORKDIR /app

# System dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    git \
    tmux \
    asciinema \
    findutils \
    && rm -rf /var/lib/apt/lists/*

# Clone the vulnerable version source code (for solution to modify)
RUN git clone --depth 1 --branch v2.32.0 https://github.com/filebrowser/filebrowser.git . && \
    rm -rf .git

# Download and extract pre-built binary with embedded frontend assets
RUN curl -fsSL https://github.com/filebrowser/filebrowser/releases/download/v2.32.0/linux-amd64-filebrowser.tar.gz | tar -xz -C /app/

# Copy configuration - note: must be at root since filebrowser looks there
COPY task-deps/docker_config.json /.filebrowser.json

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create data directory
RUN mkdir -p /srv

VOLUME /srv
EXPOSE 80

# Health check
HEALTHCHECK --start-period=5s --interval=10s --timeout=5s \
    CMD curl -f http://localhost:80/ || exit 1

# ENTRYPOINT ["/entrypoint.sh"]  # Moved to docker-compose.yaml
