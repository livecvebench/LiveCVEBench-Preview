#!/bin/bash
# Solution script to fix the stored XSS vulnerability in Simple SEO plugin
# The fix adds esc_html() wrapper to all user-controlled post meta values
# before they are output in the admin interface.
set -e

# File to fix - WordPress plugin location
FILE="/var/www/html/wp-content/plugins/cds-simple-seo/app/Admin/Meta/Post.php"

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "ERROR: File not found: $FILE"
    exit 1
fi

echo "Applying fix to $FILE..."

# Create a backup
cp "$FILE" "${FILE}.bak"

# The vulnerability is that get_post_meta() values are output without escaping.
# The fix is to wrap each get_post_meta() call with esc_html() for the SEO fields.

# Fields that need esc_html() wrapper:
# - sseo_meta_title
# - sseo_meta_description
# - sseo_canonical_url
# - sseo_meta_keywords
# - sseo_robot_noindex
# - sseo_robot_nofollow
# - sseo_fb_title
# - sseo_fb_description
# - sseo_fb_image
# - sseo_tw_title
# - sseo_tw_description
# - sseo_tw_image

# Apply fix using sed - add esc_html() wrapper to get_post_meta calls
# Pattern: $variable = get_post_meta(..., true);
# Replace with: $variable = esc_html(get_post_meta(..., true));

# Fix sseo_meta_title
sed -i "s/\\\$sseo_meta_title = get_post_meta(\\\$post->ID, 'sseo_meta_title', true);/\\\$sseo_meta_title = esc_html(get_post_meta(\\\$post->ID, 'sseo_meta_title', true));/g" "$FILE"

# Fix sseo_meta_description
sed -i "s/\\\$sseo_meta_description = get_post_meta(\\\$post->ID, 'sseo_meta_description', true);/\\\$sseo_meta_description = esc_html(get_post_meta(\\\$post->ID, 'sseo_meta_description', true));/g" "$FILE"

# Fix sseo_canonical_url
sed -i "s/\\\$sseo_canonical_url = get_post_meta(\\\$post->ID, 'sseo_canonical_url', true);/\\\$sseo_canonical_url = esc_html(get_post_meta(\\\$post->ID, 'sseo_canonical_url', true));/g" "$FILE"

# Fix sseo_meta_keywords
sed -i "s/\\\$sseo_meta_keywords = get_post_meta(\\\$post->ID, 'sseo_meta_keywords', true);/\\\$sseo_meta_keywords = esc_html(get_post_meta(\\\$post->ID, 'sseo_meta_keywords', true));/g" "$FILE"

# Fix sseo_robot_noindex
sed -i "s/\\\$sseo_robot_noindex = get_post_meta(\\\$post->ID, 'sseo_robot_noindex', true);/\\\$sseo_robot_noindex = esc_html(get_post_meta(\\\$post->ID, 'sseo_robot_noindex', true));/g" "$FILE"

# Fix sseo_robot_nofollow
sed -i "s/\\\$sseo_robot_nofollow = get_post_meta(\\\$post->ID, 'sseo_robot_nofollow', true);/\\\$sseo_robot_nofollow = esc_html(get_post_meta(\\\$post->ID, 'sseo_robot_nofollow', true));/g" "$FILE"

# Fix sseo_fb_title
sed -i "s/\\\$sseo_fb_title = get_post_meta(\\\$post->ID, 'sseo_fb_title', true);/\\\$sseo_fb_title = esc_html(get_post_meta(\\\$post->ID, 'sseo_fb_title', true));/g" "$FILE"

# Fix sseo_fb_description
sed -i "s/\\\$sseo_fb_description = get_post_meta(\\\$post->ID, 'sseo_fb_description', true);/\\\$sseo_fb_description = esc_html(get_post_meta(\\\$post->ID, 'sseo_fb_description', true));/g" "$FILE"

# Fix sseo_fb_image
sed -i "s/\\\$sseo_fb_image = get_post_meta(\\\$post->ID, 'sseo_fb_image', true);/\\\$sseo_fb_image = esc_html(get_post_meta(\\\$post->ID, 'sseo_fb_image', true));/g" "$FILE"

# Fix sseo_tw_title
sed -i "s/\\\$sseo_tw_title = get_post_meta(\\\$post->ID, 'sseo_tw_title', true);/\\\$sseo_tw_title = esc_html(get_post_meta(\\\$post->ID, 'sseo_tw_title', true));/g" "$FILE"

# Fix sseo_tw_description
sed -i "s/\\\$sseo_tw_description = get_post_meta(\\\$post->ID, 'sseo_tw_description', true);/\\\$sseo_tw_description = esc_html(get_post_meta(\\\$post->ID, 'sseo_tw_description', true));/g" "$FILE"

# Fix sseo_tw_image
sed -i "s/\\\$sseo_tw_image = get_post_meta(\\\$post->ID, 'sseo_tw_image', true);/\\\$sseo_tw_image = esc_html(get_post_meta(\\\$post->ID, 'sseo_tw_image', true));/g" "$FILE"

echo "Fix applied successfully!"

# Verify the fix was applied by checking for esc_html
if grep -q "esc_html(get_post_meta" "$FILE"; then
    echo "Verification: esc_html wrappers found in file."
else
    echo "WARNING: esc_html wrappers not found. The fix may not have been applied correctly."
    exit 1
fi

# PHP is interpreted on each request, no service restart needed
echo "Fix complete. Changes will take effect immediately on next page load."
