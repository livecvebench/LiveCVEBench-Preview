#!/bin/bash
set -e
cd /app

echo "=== Applying fix for path traversal vulnerability in avatar deletion ==="

USER_CLASS_FILE="upload/includes/classes/user.class.php"

if [ ! -f "$USER_CLASS_FILE" ]; then
    echo "Error: $USER_CLASS_FILE not found"
    exit 1
fi

# Create backup
cp "$USER_CLASS_FILE" "${USER_CLASS_FILE}.bak"

# Fix 1: Change avatar_url to avatar in the file deletion path construction
# This is the critical fix - prevents path traversal
# Before: $file = DirPath::get('avatars') . $udetails['avatar_url'];
# After:  $file = DirPath::get('avatars') . $udetails['avatar'];
sed -i "s/\$file = DirPath::get('avatars') \. \$udetails\['avatar_url'\];/\$file = DirPath::get('avatars') . \$udetails['avatar'];/g" "$USER_CLASS_FILE"

# Fix 2: Update the condition check for file deletion
# Before: if (file_exists($file) && $udetails['avatar_url'] != '') {
# After:  if( file_exists($file) ){
sed -i "s/if (file_exists(\$file) && \$udetails\['avatar_url'\] != '') {/if( file_exists(\$file) ){/g" "$USER_CLASS_FILE"

# Fix 4: Replace single-letter type parameters with explicit names
# Change upload_user_file('a', ...) to upload_user_file('avatar', ...)
sed -i "s/upload_user_file('a',/upload_user_file('avatar',/g" "$USER_CLASS_FILE"

# Change upload_user_file('b', ...) to upload_user_file('background', ...)
sed -i "s/upload_user_file('b',/upload_user_file('background',/g" "$USER_CLASS_FILE"

# Fix 3: Add URL validation for avatar_url input
# This prevents storing path traversal sequences in the database
# We need to wrap the avatar_url assignment in a filter_var check

# Find and replace the avatar_url assignment block in update_user_avatar_bg function
# Original:
#   if (config('picture_url') == 'yes') {
#       //Updating User Avatar
#       $uquery_field[] = 'avatar_url';
#       $uquery_val[] = $array['avatar_url'];
#   }
#
# Fixed:
#   if (config('picture_url') == 'yes') {
#       if( filter_var($array['avatar_url'], FILTER_VALIDATE_URL) || empty($array['avatar_url']) ){
#           //Updating User Avatar
#           $uquery_field[] = 'avatar_url';
#           $uquery_val[] = $array['avatar_url'];
#       } else {
#           e(lang('incorrect_url'));
#       }
#   }

# Use perl for multi-line replacement as it's more reliable for complex patterns
perl -i -0pe 's/if \(config\(\x27picture_url\x27\) == \x27yes\x27\) \{\s*\/\/Updating User Avatar\s*\$uquery_field\[\] = \x27avatar_url\x27;\s*\$uquery_val\[\] = \$array\[\x27avatar_url\x27\];/if (config(\x27picture_url\x27) == \x27yes\x27) {\n                if( filter_var(\$array[\x27avatar_url\x27], FILTER_VALIDATE_URL) || empty(\$array[\x27avatar_url\x27]) ){\n                    \/\/Updating User Avatar\n                    \$uquery_field[] = \x27avatar_url\x27;\n                    \$uquery_val[] = \$array[\x27avatar_url\x27];\n                } else {\n                    e(lang(\x27incorrect_url\x27));\n                }/g' "$USER_CLASS_FILE"

echo "Fix applied successfully"

# Verify the fix was applied
echo ""
echo "=== Verifying fix ==="

if grep -q "\$udetails\['avatar'\]" "$USER_CLASS_FILE" && \
   grep -q "DirPath::get('avatars') \. \$udetails\['avatar'\]" "$USER_CLASS_FILE"; then
    echo "✓ avatar field is used for file path construction"
else
    echo "✗ Warning: avatar field fix may not be applied correctly"
fi

if grep -q "filter_var.*avatar_url.*FILTER_VALIDATE_URL" "$USER_CLASS_FILE"; then
    echo "✓ URL validation is in place for avatar_url"
else
    echo "✗ Warning: URL validation may not be applied correctly"
fi

echo ""
echo "=== Fix complete ==="
