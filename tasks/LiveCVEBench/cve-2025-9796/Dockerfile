FROM maven:3.9-eclipse-temurin-17

WORKDIR /app

# System dependencies required for tb framework
RUN apt-get update && apt-get install -y \
    tmux \
    asciinema \
    gcc \
    g++ \
    wget \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy Maven settings with proxy configuration
COPY task-deps/settings.xml /root/.m2/settings.xml

# Clone JeeSite5 at vulnerable version and remove git history
RUN git clone --depth 1 --branch v5.12.1.springboo3 https://github.com/thinkgem/jeesite5.git . && \
    rm -rf .git

# Build parent pom first, then common module
RUN cd /app/parent && mvn -N install -DskipTests && \
    cd /app && mvn -pl common -am clean compile -DskipTests

# Set working directory
WORKDIR /app

# Keep container running (handled by docker-compose command)
# CMD ["tail", "-f", "/dev/null"]
