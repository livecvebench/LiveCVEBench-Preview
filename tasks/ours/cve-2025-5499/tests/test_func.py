"""
Functional tests for phpwcms image_resized.php
These tests verify the application functions correctly in both vulnerable and fixed states.
"""
import os
import requests
import pytest
from PIL import Image
from io import BytesIO

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")


class TestBasicFunctionality:
    """Test that basic image resizing functionality works."""

    def test_endpoint_responds(self):
        """The image_resized.php endpoint should respond to requests."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_returns_image_content_type(self):
        """The endpoint should return an image content type."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200
        content_type = response.headers.get("Content-Type", "")
        assert any(img_type in content_type for img_type in ["image/jpeg", "image/png", "image/gif", "image/webp"])

    def test_returns_png_image_on_error(self):
        """When file is not found, should return an 'Image Error' PNG."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": "nonexistent_file_12345.jpg"},
            timeout=10
        )
        assert response.status_code == 200
        assert "image/png" in response.headers.get("Content-Type", "")
        # Verify it's actually a valid PNG (not empty or corrupt)
        assert len(response.content) > 0

    def test_format_parameter_jpg(self):
        """The format=jpg parameter should work."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_format_parameter_png(self):
        """The format=png parameter should work."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "png"},
            timeout=10
        )
        assert response.status_code == 200

    def test_format_parameter_gif(self):
        """The format=gif parameter should work."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "gif"},
            timeout=10
        )
        assert response.status_code == 200

    def test_width_height_parameters(self):
        """Width and height parameters should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "w": "100", "h": "100"},
            timeout=10
        )
        assert response.status_code == 200

    def test_quality_parameter(self):
        """Quality parameter should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "q": "75"},
            timeout=10
        )
        assert response.status_code == 200


class TestDefaultBehavior:
    """Test default image behavior."""

    def test_default_image_loads(self):
        """Without imgfile parameter, should use default image."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200
        # Should return some image response (either actual image or error image)
        content_type = response.headers.get("Content-Type", "")
        assert "image" in content_type


class TestSimpleImagePaths:
    """Test simple, legitimate image paths."""

    def test_simple_filename(self):
        """A simple filename should be processed (may return error if not found, but endpoint works)."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": "test.jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_subdirectory_path(self):
        """A subdirectory path should be processed."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": "img/test.jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_nested_subdirectory(self):
        """A nested subdirectory path should be processed."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": "uploads/images/photo.jpg"},
            timeout=10
        )
        assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
