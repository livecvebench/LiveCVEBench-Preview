"""
Functional tests for the export API.
These tests verify that normal export functionality works correctly.
Should PASS in both vulnerable and fixed states.

Tests send real HTTP requests to the running FastAPI server.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost:5000/api"


def wait_for_server(timeout=30):
    """Wait for the server to be available."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            requests.get(f"{BASE_URL}/exports", timeout=2)
            return True
        except requests.exceptions.ConnectionError:
            time.sleep(0.5)
    return False


@pytest.fixture(scope="module", autouse=True)
def ensure_server_running():
    """Ensure the server is running before tests."""
    if not wait_for_server():
        pytest.skip("Server not available")


class TestExportAPIFunctional:
    """Test that the export API functions correctly for valid inputs."""

    def test_export_without_image_path(self):
        """Test export works when no image_path is provided."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "test_export"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data.get("success") is True or "Starting export" in data.get("message", "")

    def test_export_with_valid_clips_path(self):
        """Test export works with a valid image_path within clips directory."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "test_export",
                "image_path": "/media/frigate/clips/thumbnail.webp"
            }
        )

        # Should succeed - valid path in clips directory
        assert response.status_code == 200

    def test_invalid_camera_returns_404(self):
        """Test that requesting export for non-existent camera returns 404."""
        response = requests.post(
            f"{BASE_URL}/export/nonexistent_camera/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "test_export"
            }
        )

        assert response.status_code == 404
        assert "not a valid camera" in response.text

    def test_export_with_empty_camera_name_returns_404(self):
        """Test that empty camera name returns 404."""
        # URL-encoded empty camera name
        response = requests.post(
            f"{BASE_URL}/export//start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "test_export"
            }
        )

        # Empty camera name should result in 404 (path not found) or validation error
        assert response.status_code in [404, 422]

    def test_export_response_contains_export_id(self):
        """Test that successful export response contains an export_id."""
        response = requests.post(
            f"{BASE_URL}/export/cam1/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "test_export"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "export_id" in data


class TestExportAPIWithRecordings:
    """Test export API with recordings source."""

    def test_export_recordings_source(self):
        """Test export with recordings source type."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "recordings",
                "name": "test_export"
            }
        )

        assert response.status_code == 200

    def test_get_exports_endpoint(self):
        """Test that the exports list endpoint works."""
        response = requests.get(f"{BASE_URL}/exports")

        # Should return 200 with an array (possibly empty)
        assert response.status_code == 200
        assert isinstance(response.json(), list)
