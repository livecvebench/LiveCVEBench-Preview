"""
Functional tests for the HTML purification functionality.
These tests verify that the Output::getPurified() method works correctly
for normal content and should PASS in both vulnerable and fixed states.
"""

import subprocess
import json
import pytest
import os

TEST_HELPER_PATH = "/tests/test_helper.php"


def call_purifier(html_input: str) -> dict:
    """Call PHP Output::getPurified via subprocess"""
    result = subprocess.run(
        ["php", TEST_HELPER_PATH, html_input],
        capture_output=True,
        text=True,
        cwd="/app",
        timeout=30
    )
    if result.returncode != 0:
        raise RuntimeError(f"PHP script failed: {result.stderr}")
    return json.loads(result.stdout)


class TestBasicPurification:
    """Test basic HTML purification functionality"""

    def test_basic_text_preserved(self):
        """Plain text should be preserved"""
        result = call_purifier("Hello, World!")
        assert result["success"] is True
        assert "Hello, World!" in result["output"]

    def test_allowed_tags_preserved(self):
        """Allowed HTML tags should be preserved"""
        html = "<p>This is a <strong>test</strong> with <em>emphasis</em>.</p>"
        result = call_purifier(html)
        assert result["success"] is True
        assert "<strong>" in result["output"]
        assert "<em>" in result["output"]
        assert "<p>" in result["output"]

    def test_basic_formatting_tags(self):
        """Basic formatting tags (b, i, u) should work"""
        html = "<b>bold</b> <i>italic</i> <u>underline</u>"
        result = call_purifier(html)
        assert result["success"] is True
        assert "<b>" in result["output"]
        assert "<i>" in result["output"]
        assert "<u>" in result["output"]

    def test_list_elements_preserved(self):
        """List elements should be preserved"""
        html = "<ul><li>Item 1</li><li>Item 2</li></ul>"
        result = call_purifier(html)
        assert result["success"] is True
        assert "<ul>" in result["output"]
        assert "<li>" in result["output"]

    def test_ordered_list_preserved(self):
        """Ordered list elements should be preserved"""
        html = "<ol><li>First</li><li>Second</li></ol>"
        result = call_purifier(html)
        assert result["success"] is True
        assert "<ol>" in result["output"]
        assert "<li>" in result["output"]


class TestDisallowedContent:
    """Test that disallowed/dangerous content is stripped"""

    def test_script_tags_removed(self):
        """Script tags should be completely removed"""
        html = "<p>Hello</p><script>alert('xss')</script><p>World</p>"
        result = call_purifier(html)
        assert result["success"] is True
        assert "<script>" not in result["output"]
        assert "alert" not in result["output"]

    def test_onclick_handlers_removed(self):
        """Event handlers should be removed from elements"""
        html = '<p onclick="alert(1)">Click me</p>'
        result = call_purifier(html)
        assert result["success"] is True
        assert "onclick" not in result["output"].lower()

    def test_javascript_urls_removed(self):
        """JavaScript URLs should be removed from links"""
        html = '<a href="javascript:alert(1)">Click me</a>'
        result = call_purifier(html)
        assert result["success"] is True
        assert "javascript:" not in result["output"].lower()


class TestLinksAndAnchors:
    """Test link (anchor) functionality"""

    def test_valid_links_preserved(self):
        """Valid HTTP links should be preserved"""
        html = '<a href="https://example.com">Example</a>'
        result = call_purifier(html)
        assert result["success"] is True
        assert "https://example.com" in result["output"]
        assert "<a " in result["output"]

    def test_link_target_attribute(self):
        """Link target attribute should be allowed"""
        html = '<a href="https://example.com" target="_blank">Example</a>'
        result = call_purifier(html)
        assert result["success"] is True
        assert 'target="_blank"' in result["output"]

    def test_link_rel_attribute(self):
        """Link rel attribute should be allowed with safe values"""
        html = '<a href="https://example.com" rel="noopener">Example</a>'
        result = call_purifier(html)
        assert result["success"] is True
        assert "noopener" in result["output"]


class TestImages:
    """Test image element functionality"""

    def test_img_element_preserved(self):
        """Image elements should be preserved"""
        html = '<img src="https://example.com/image.jpg" alt="test">'
        result = call_purifier(html)
        assert result["success"] is True
        assert "<img " in result["output"]
        assert "example.com/image.jpg" in result["output"]

    def test_img_with_dimensions_preserved(self):
        """Image width and height attributes should be preserved"""
        html = '<img src="https://example.com/image.jpg" width="100" height="100" alt="test">'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_img_width"] is True
        assert result["has_img_height"] is True

    def test_img_alt_attribute_preserved(self):
        """Image alt attribute should be preserved"""
        html = '<img src="https://example.com/image.jpg" alt="A test image">'
        result = call_purifier(html)
        assert result["success"] is True
        assert 'alt="A test image"' in result["output"]


class TestIframes:
    """Test iframe functionality for allowed video sources"""

    def test_youtube_iframe_allowed(self):
        """YouTube iframes should be allowed"""
        html = '<iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert "youtube.com/embed" in result["output"]

    def test_youtube_nocookie_iframe_allowed(self):
        """YouTube no-cookie iframes should be allowed"""
        html = '<iframe src="https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert "youtube-nocookie.com/embed" in result["output"]

    def test_vimeo_iframe_allowed(self):
        """Vimeo iframes should be allowed"""
        html = '<iframe src="https://player.vimeo.com/video/123456"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert "vimeo.com/video" in result["output"]

    def test_disallowed_iframe_source_blocked(self):
        """Iframes with non-allowed sources should be blocked"""
        html = '<iframe src="https://evil.com/malware"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        # The iframe should either be removed or have its src stripped
        assert "evil.com" not in result["output"]


class TestBlockquoteAndDiv:
    """Test blockquote and div elements"""

    def test_blockquote_preserved(self):
        """Blockquote elements should be preserved"""
        html = "<blockquote>This is a quote</blockquote>"
        result = call_purifier(html)
        assert result["success"] is True
        assert "<blockquote>" in result["output"]

    def test_div_with_align_preserved(self):
        """Div with align attribute should be preserved"""
        html = '<div align="center">Centered content</div>'
        result = call_purifier(html)
        assert result["success"] is True
        assert "<div" in result["output"]


class TestStyleAttributes:
    """Test inline style attributes"""

    def test_span_with_style_preserved(self):
        """Span with allowed style properties should be preserved"""
        html = '<span style="color: red;">Red text</span>'
        result = call_purifier(html)
        assert result["success"] is True
        assert "<span" in result["output"]
        assert "color" in result["output"]

    def test_span_with_class_preserved(self):
        """Span with class attribute should be preserved"""
        html = '<span class="highlight">Highlighted text</span>'
        result = call_purifier(html)
        assert result["success"] is True
        assert 'class="highlight"' in result["output"]


class TestFigureElements:
    """Test figure and figcaption elements"""

    def test_figure_element_preserved(self):
        """Figure elements should be preserved"""
        html = '<figure><img src="https://example.com/img.jpg" alt="test"><figcaption>Caption</figcaption></figure>'
        result = call_purifier(html)
        assert result["success"] is True
        assert "<figure>" in result["output"]
        assert "<figcaption>" in result["output"]


class TestEdgeCases:
    """Test edge cases and special inputs"""

    def test_empty_input(self):
        """Empty input should return empty output"""
        result = call_purifier("")
        assert result["success"] is True
        assert result["output"] == ""

    def test_whitespace_only(self):
        """Whitespace only input should be handled"""
        result = call_purifier("   \n\t  ")
        assert result["success"] is True

    def test_mixed_content(self):
        """Complex mixed content should be handled correctly"""
        html = """
        <p>Hello <strong>world</strong>!</p>
        <ul>
            <li>Item with <a href="https://example.com">link</a></li>
            <li>Item with <img src="https://example.com/img.jpg" alt="image"></li>
        </ul>
        <blockquote>A quote</blockquote>
        """
        result = call_purifier(html)
        assert result["success"] is True
        assert "<p>" in result["output"]
        assert "<strong>" in result["output"]
        assert "<ul>" in result["output"]
        assert "<li>" in result["output"]
        assert "<a " in result["output"]
        assert "<img " in result["output"]
        assert "<blockquote>" in result["output"]
