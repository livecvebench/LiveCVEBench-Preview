#!/usr/bin/env python3
"""
Vulnerability tests for Vvveb CMS page editor file access issue.
These tests verify that improper file access through URL parameters is blocked.

- FAIL in vulnerable state (file access is possible)
- PASS in fixed state (file access is blocked with 404)
"""

import pytest
import requests
import time
import os
import urllib.parse

# Configuration
BASE_URL = os.environ.get("BASE_URL", "http://localhost:80")
ADMIN_PATH = "/vadmin"
ADMIN_USER = os.environ.get("ADMIN_USER", "admin@vvveb.com")
ADMIN_PASS = os.environ.get("ADMIN_PASS", "admin")

# Timeout settings
REQUEST_TIMEOUT = 30


class TestFileAccessVulnerability:
    """Test that arbitrary file access through URL parameter is blocked."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup for each test - get authenticated session."""
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "Mozilla/5.0 (Test Suite)"
        })
        self._login()
        yield
        self.session.close()

    def _login(self):
        """Authenticate to the admin panel."""
        login_url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=user/login"

        # First GET to get CSRF token
        resp = self.session.get(login_url, timeout=REQUEST_TIMEOUT)

        # Extract CSRF token from response
        import re
        csrf_match = re.search(r'name="csrf"[^>]*value="([^"]+)"', resp.text)
        csrf_token = csrf_match.group(1) if csrf_match else ""

        # Attempt login - field is "user" not "email", and CSRF is required
        login_data = {
            "user": ADMIN_USER,
            "password": ADMIN_PASS,
            "csrf": csrf_token,
            "login": "1"
        }
        resp = self.session.post(login_url, data=login_data, timeout=REQUEST_TIMEOUT, allow_redirects=True)

        # Verify login by checking editor access
        editor_url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=editor/editor"
        check = self.session.get(editor_url, timeout=REQUEST_TIMEOUT, allow_redirects=False)

        if check.status_code == 302 and "login" in check.headers.get("Location", "").lower():
            pytest.skip("Unable to authenticate - check credentials")

    def _make_editor_request(self, url_param, template_param="index.html"):
        """Make a request to the editor with specified url parameter."""
        editor_url = f"{BASE_URL}{ADMIN_PATH}/index.php"
        params = {
            "module": "editor/editor",
            "url": url_param,
            "template": template_param
        }
        return self.session.get(editor_url, params=params, timeout=REQUEST_TIMEOUT)

    # ----- JSON file access tests -----

    def test_cannot_access_package_json(self):
        """Should NOT be able to read package.json through url parameter."""
        response = self._make_editor_request("package.json")

        # After fix: should return 404
        assert response.status_code == 404, \
            f"Expected 404 for package.json access, got {response.status_code}"

    def test_cannot_access_composer_json(self):
        """Should NOT be able to read composer.json through url parameter."""
        response = self._make_editor_request("composer.json")

        assert response.status_code == 404, \
            f"Expected 404 for composer.json access, got {response.status_code}"

    def test_cannot_access_package_lock_json(self):
        """Should NOT be able to read package-lock.json through url parameter."""
        response = self._make_editor_request("package-lock.json")

        assert response.status_code == 404, \
            f"Expected 404 for package-lock.json access, got {response.status_code}"

    # ----- PHP file access tests -----

    def test_cannot_access_php_files(self):
        """Should NOT be able to access .php files through url parameter."""
        response = self._make_editor_request("config.php")

        assert response.status_code == 404, \
            f"Expected 404 for config.php access, got {response.status_code}"

    def test_cannot_access_index_php(self):
        """Should NOT be able to access index.php through url parameter."""
        response = self._make_editor_request("index.php")

        assert response.status_code == 404, \
            f"Expected 404 for index.php access, got {response.status_code}"

    # ----- Configuration file access tests -----

    def test_cannot_access_htaccess(self):
        """Should NOT be able to access .htaccess through url parameter."""
        response = self._make_editor_request(".htaccess")

        assert response.status_code == 404, \
            f"Expected 404 for .htaccess access, got {response.status_code}"

    def test_cannot_access_env_file(self):
        """Should NOT be able to access .env file through url parameter."""
        response = self._make_editor_request(".env")

        assert response.status_code == 404, \
            f"Expected 404 for .env access, got {response.status_code}"

    def test_cannot_access_xml_files(self):
        """Should NOT be able to access XML files through url parameter."""
        response = self._make_editor_request("sitemap.xml")

        assert response.status_code == 404, \
            f"Expected 404 for sitemap.xml access, got {response.status_code}"

    # ----- JavaScript and CSS file tests -----

    def test_cannot_access_js_files(self):
        """Should NOT be able to access .js files through url parameter."""
        response = self._make_editor_request("scripts/main.js")

        assert response.status_code == 404, \
            f"Expected 404 for .js file access, got {response.status_code}"

    def test_cannot_access_css_files(self):
        """Should NOT be able to access .css files through url parameter."""
        response = self._make_editor_request("css/style.css")

        assert response.status_code == 404, \
            f"Expected 404 for .css file access, got {response.status_code}"

    # ----- Path traversal tests -----

    def test_blocks_path_traversal_with_dotdot(self):
        """Should block path traversal attempts with .. in url."""
        response = self._make_editor_request("../package.json")

        assert response.status_code == 404, \
            f"Expected 404 for path traversal attempt, got {response.status_code}"

    def test_blocks_path_traversal_multiple_levels(self):
        """Should block multi-level path traversal attempts."""
        response = self._make_editor_request("../../config.php")

        assert response.status_code == 404, \
            f"Expected 404 for multi-level path traversal, got {response.status_code}"

    def test_blocks_double_slash_traversal(self):
        """Should block double-slash based path traversal."""
        response = self._make_editor_request(
            "//etc/passwd",
            template_param="../.htaccess"
        )

        # Should return 404 for this combined attack
        assert response.status_code == 404, \
            f"Expected 404 for double-slash traversal, got {response.status_code}"

    def test_blocks_encoded_traversal(self):
        """Should block URL-encoded path traversal attempts."""
        # %2e%2e = ..
        response = self._make_editor_request("%2e%2e/package.json")

        assert response.status_code == 404, \
            f"Expected 404 for encoded traversal attempt, got {response.status_code}"

    # ----- Template parameter validation tests -----

    def test_blocks_non_html_template(self):
        """Should block non-.html files in template parameter."""
        response = self._make_editor_request(
            "index.html",
            template_param="config.php"
        )

        assert response.status_code == 404, \
            f"Expected 404 for non-html template, got {response.status_code}"

    def test_blocks_template_traversal(self):
        """Should block path traversal in template parameter."""
        response = self._make_editor_request(
            "index.html",
            template_param="../admin/config.php"
        )

        assert response.status_code == 404, \
            f"Expected 404 for template traversal, got {response.status_code}"

    def test_blocks_non_existent_template(self):
        """Should block access to non-existent template files."""
        response = self._make_editor_request(
            "index.html",
            template_param="nonexistent_file_12345.html"
        )

        # Should return 404 for non-existent files
        assert response.status_code == 404, \
            f"Expected 404 for non-existent template, got {response.status_code}"

    # ----- Various extension tests -----

    def test_cannot_access_txt_files(self):
        """Should NOT be able to access .txt files through url parameter."""
        response = self._make_editor_request("readme.txt")

        assert response.status_code == 404, \
            f"Expected 404 for .txt file access, got {response.status_code}"

    def test_cannot_access_log_files(self):
        """Should NOT be able to access .log files through url parameter."""
        response = self._make_editor_request("error.log")

        assert response.status_code == 404, \
            f"Expected 404 for .log file access, got {response.status_code}"

    def test_cannot_access_sql_files(self):
        """Should NOT be able to access .sql files through url parameter."""
        response = self._make_editor_request("database.sql")

        assert response.status_code == 404, \
            f"Expected 404 for .sql file access, got {response.status_code}"

    def test_cannot_access_md_files(self):
        """Should NOT be able to access .md files through url parameter."""
        response = self._make_editor_request("README.md")

        assert response.status_code == 404, \
            f"Expected 404 for .md file access, got {response.status_code}"

    # ----- Edge case tests -----

    def test_blocks_html_extension_with_path_prefix(self):
        """Should block files that look like HTML but have path prefix."""
        response = self._make_editor_request("../../public/index.html")

        assert response.status_code == 404, \
            f"Expected 404 for traversal with html extension, got {response.status_code}"

    def test_blocks_tools_directory_access(self):
        """Should block access to files in tools directory."""
        response = self._make_editor_request("tools/systeminfo.html")

        # If file doesn't exist in theme folder, should return 404
        # This tests the file_exists check
        assert response.status_code == 404 or "systeminfo" not in response.text.lower(), \
            "Should not expose tools directory files"


class TestContentLeakage:
    """Test that sensitive content is not leaked in responses."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup for each test - get authenticated session."""
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "Mozilla/5.0 (Test Suite)"
        })
        self._login()
        yield
        self.session.close()

    def _login(self):
        """Authenticate to the admin panel."""
        login_url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=user/login"
        resp = self.session.get(login_url, timeout=REQUEST_TIMEOUT)

        # Extract CSRF token from response
        import re
        csrf_match = re.search(r'name="csrf"[^>]*value="([^"]+)"', resp.text)
        csrf_token = csrf_match.group(1) if csrf_match else ""

        login_data = {
            "user": ADMIN_USER,
            "password": ADMIN_PASS,
            "csrf": csrf_token,
            "login": "1"
        }
        self.session.post(login_url, data=login_data, timeout=REQUEST_TIMEOUT, allow_redirects=True)

    def _make_editor_request(self, url_param, template_param="index.html"):
        """Make a request to the editor with specified url parameter."""
        editor_url = f"{BASE_URL}{ADMIN_PATH}/index.php"
        params = {
            "module": "editor/editor",
            "url": url_param,
            "template": template_param
        }
        return self.session.get(editor_url, params=params, timeout=REQUEST_TIMEOUT)

    def test_no_package_json_content_leak(self):
        """Verify package.json access is blocked (returns 404)."""
        response = self._make_editor_request("package.json")

        # In fixed state: should return 404, not 200
        # This tests that unauthorized file access is blocked
        assert response.status_code == 404, \
            f"Expected 404 for package.json access, got {response.status_code}"

    def test_no_composer_json_content_leak(self):
        """Verify composer.json access is blocked (returns 404)."""
        response = self._make_editor_request("composer.json")

        # In fixed state: should return 404, not 200
        # This tests that unauthorized file access is blocked
        assert response.status_code == 404, \
            f"Expected 404 for composer.json access, got {response.status_code}"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
