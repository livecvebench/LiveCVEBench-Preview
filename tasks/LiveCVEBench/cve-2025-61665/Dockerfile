FROM php:8.2-apache

# Proxy variables can be passed via --build-arg if needed

# Set working directory
WORKDIR /var/www/html

# Install system dependencies (tmux, asciinema, curl, gcc, g++ are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install mysqli pdo pdo_mysql

# Enable Apache modules
RUN a2enmod rewrite

# Clone vulnerable version and remove git history
RUN git clone --depth 1 --branch 3.4.12 https://github.com/LabRedesCefetRJ/WeGIA.git WeGIA && \
    cd WeGIA && \
    rm -rf .git

# Copy configuration files from task-deps
COPY task-deps/config.php /var/www/html/WeGIA/config.php
COPY task-deps/permissao.php /var/www/html/WeGIA/html/permissao/permissao.php
COPY task-deps/conexao.php /var/www/html/WeGIA/html/socio/conexao.php

# Set proper permissions
RUN chown -R www-data:www-data /var/www/html/WeGIA && \
    chmod -R 755 /var/www/html/WeGIA

# Create PHP session directory
RUN mkdir -p /var/lib/php/sessions && \
    chown www-data:www-data /var/lib/php/sessions

# Configure Apache document root
ENV APACHE_DOCUMENT_ROOT=/var/www/html
RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf
RUN sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf