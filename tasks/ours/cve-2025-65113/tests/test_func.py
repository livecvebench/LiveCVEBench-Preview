#!/usr/bin/env python3
"""
Functional tests for ClipBucket v5 flagging system.

These tests verify that the AJAX endpoint responds correctly and the
basic application functionality works. These tests should pass in
both vulnerable and fixed states.
"""

import pytest
import requests
import os
import time

# Base URL for the ClipBucket application
BASE_URL = os.environ.get("TARGET_URL", "http://localhost")

# Timeout for HTTP requests
REQUEST_TIMEOUT = 10


class TestAjaxEndpointAvailability:
    """Test that the AJAX endpoint is available and responds correctly."""

    def test_ajax_endpoint_exists(self):
        """Verify the AJAX endpoint is accessible."""
        url = f"{BASE_URL}/actions/ajax.php"
        # Send a minimal request to check if endpoint exists
        response = requests.post(url, data={"mode": "invalid_mode"}, timeout=REQUEST_TIMEOUT)
        # Should get some response (not 404)
        assert response.status_code != 404, "AJAX endpoint should exist"

    def test_ajax_endpoint_accepts_post(self):
        """Verify the AJAX endpoint accepts POST requests."""
        url = f"{BASE_URL}/actions/ajax.php"
        response = requests.post(
            url,
            data={"mode": "flag_object"},
            timeout=REQUEST_TIMEOUT
        )
        # Should accept POST (may return error but not 405)
        assert response.status_code != 405, "AJAX endpoint should accept POST"

    def test_flag_object_mode_recognized(self):
        """Verify the flag_object mode is recognized by the endpoint."""
        url = f"{BASE_URL}/actions/ajax.php"
        response = requests.post(
            url,
            data={
                "mode": "flag_object",
                "type": "video",
                "id": "1",
                "flag_type": "1"
            },
            timeout=REQUEST_TIMEOUT
        )
        # Should get a meaningful response (not empty or generic error)
        # The response should contain HTML div elements as per the handler
        assert response.status_code == 200
        # Response should contain some content related to the flag action
        # (either success, error about login, or error about missing data)
        response_lower = response.text.lower()
        has_relevant_content = (
            "login" in response_lower or
            "flag" in response_lower or
            "report" in response_lower or
            "success" in response_lower or
            "error" in response_lower or
            "msg" in response_lower or
            "<div" in response_lower
        )
        assert has_relevant_content, f"Response should contain relevant content: {response.text[:200]}"


class TestFlagObjectParameters:
    """Test parameter validation in the flag_object handler."""

    def test_missing_flag_type_parameter(self):
        """Verify appropriate error when flag_type is missing."""
        url = f"{BASE_URL}/actions/ajax.php"
        response = requests.post(
            url,
            data={
                "mode": "flag_object",
                "type": "video",
                "id": "1"
                # flag_type intentionally missing
            },
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        # Should either require login first, or report missing category
        response_lower = response.text.lower()
        has_error_or_login = (
            "login" in response_lower or
            "missing" in response_lower or
            "category" in response_lower or
            "error" in response_lower
        )
        assert has_error_or_login, f"Should show error for missing flag_type: {response.text[:200]}"

    def test_various_object_types_accepted(self):
        """Verify the endpoint accepts different object types."""
        url = f"{BASE_URL}/actions/ajax.php"
        object_types = ["user", "video", "photo", "collection"]

        for obj_type in object_types:
            response = requests.post(
                url,
                data={
                    "mode": "flag_object",
                    "type": obj_type,
                    "id": "1",
                    "flag_type": "1"
                },
                timeout=REQUEST_TIMEOUT
            )
            assert response.status_code == 200, f"Type '{obj_type}' should be accepted"
            # Response should not be empty
            assert len(response.text) > 0, f"Response for type '{obj_type}' should not be empty"


class TestApplicationHealth:
    """Basic health checks for the application."""

    def test_homepage_accessible(self):
        """Verify the main application is running."""
        try:
            response = requests.get(BASE_URL, timeout=REQUEST_TIMEOUT)
            # Should get some response from the homepage
            assert response.status_code in [200, 301, 302, 303, 307, 308]
        except requests.exceptions.ConnectionError:
            pytest.skip("Application not accessible - may not be required for this test")

    def test_response_contains_html(self):
        """Verify AJAX responses contain expected HTML structure."""
        url = f"{BASE_URL}/actions/ajax.php"
        response = requests.post(
            url,
            data={
                "mode": "flag_object",
                "type": "video",
                "id": "1",
                "flag_type": "1"
            },
            timeout=REQUEST_TIMEOUT
        )
        # Response should contain div elements as per the handler code
        # (error, warning, or msg divs)
        response_text = response.text
        has_div = "<div" in response_text.lower()
        # Allow empty response in some edge cases, but if there's content it should have divs
        if len(response_text.strip()) > 0:
            assert has_div or "login" in response_text.lower() or len(response_text) < 50, \
                f"Response should contain HTML div or login message: {response_text[:200]}"
