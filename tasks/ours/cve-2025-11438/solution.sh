#!/bin/bash
# Solution script for OpnForm workspace authorization issue
# Adds missing authorization checks to saveCustomDomain and saveEmailSettings methods

set -e

CONTROLLER_PATH="/var/www/html/api/app/Http/Controllers/WorkspaceController.php"

echo "=== Applying authorization fix to WorkspaceController ==="

# Check if the file exists
if [ ! -f "$CONTROLLER_PATH" ]; then
    echo "Error: WorkspaceController.php not found at $CONTROLLER_PATH"
    exit 1
fi

# Check if fix is already applied (idempotency check)
if grep -q "authorize('adminAction', \$request->workspace)" "$CONTROLLER_PATH"; then
    echo "Fix already applied. Skipping."
else
    echo "Adding authorization check using Python script..."
fi

# If the sed approach didn't work, use a more robust Python script
if ! grep -q "authorize('adminAction', \$request->workspace)" "$CONTROLLER_PATH"; then
    echo "Using alternative fix approach..."

    python3 << 'PYTHON_SCRIPT'
import re

controller_path = "/var/www/html/api/app/Http/Controllers/WorkspaceController.php"

with open(controller_path, 'r') as f:
    content = f.read()

# Pattern to match saveCustomDomain method and insert authorization
# Match: public function saveCustomDomain(CustomDomainRequest $request)
#    {
#        if (!$request->workspace->is_pro)
pattern1 = r'(public function saveCustomDomain\(CustomDomainRequest \$request\)\s*\{\s*)(if \(!\$request->workspace->is_pro\))'
replacement1 = r"\1$this->authorize('adminAction', $request->workspace);\n        \2"
content = re.sub(pattern1, replacement1, content)

# Pattern to match saveEmailSettings method and insert authorization
pattern2 = r'(public function saveEmailSettings\(EmailSettingsRequest \$request\)\s*\{\s*)(if \(!\$request->workspace->is_pro\))'
replacement2 = r"\1$this->authorize('adminAction', $request->workspace);\n        \2"
content = re.sub(pattern2, replacement2, content)

with open(controller_path, 'w') as f:
    f.write(content)

print("Authorization checks added successfully.")
PYTHON_SCRIPT
fi

# Verify the fix was applied
echo "=== Verifying fix ==="
if grep -q "authorize('adminAction', \$request->workspace)" "$CONTROLLER_PATH"; then
    echo "SUCCESS: Authorization check found in WorkspaceController.php"
else
    echo "ERROR: Authorization check not found. Manual fix may be required."
    exit 1
fi

# Clear Laravel caches if artisan is available
echo "=== Clearing Laravel caches ==="
cd /var/www/html/api

if [ -f "artisan" ]; then
    php artisan cache:clear 2>/dev/null || true
    php artisan config:clear 2>/dev/null || true
    php artisan route:clear 2>/dev/null || true
    echo "Laravel caches cleared."
else
    echo "Artisan not found, skipping cache clear."
fi

# Restart PHP-FPM or the application if needed
# OpnForm typically runs with php-fpm, which auto-reloads PHP files
# But we should try to restart the service if possible
echo "=== Restarting application ==="

# Try different methods to restart PHP
if command -v supervisorctl &> /dev/null; then
    supervisorctl restart php-fpm 2>/dev/null || true
elif command -v systemctl &> /dev/null; then
    systemctl restart php-fpm 2>/dev/null || true
elif pgrep -f "php-fpm" > /dev/null; then
    pkill -HUP -f "php-fpm" 2>/dev/null || true
fi

# Give the application time to restart
sleep 2

echo "=== Fix complete ==="
echo "The saveCustomDomain and saveEmailSettings methods now require admin authorization."
