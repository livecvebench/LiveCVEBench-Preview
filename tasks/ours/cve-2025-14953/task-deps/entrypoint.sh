#!/bin/bash
set -e

# Create TUN device if it doesn't exist
if [ ! -e /dev/net/tun ]; then
    mkdir -p /dev/net
    mknod /dev/net/tun c 10 200
    chmod 666 /dev/net/tun
fi

# Try to create ogstun interface (may fail without NET_ADMIN)
ip tuntap add name ogstun mode tun 2>/dev/null || true
ip addr add 10.45.0.1/16 dev ogstun 2>/dev/null || true
ip link set ogstun up 2>/dev/null || true

# Set library path
export LD_LIBRARY_PATH=/app/install/lib:$LD_LIBRARY_PATH

# UPF restart loop
while true; do
    echo "Starting Open5GS UPF..."
    /app/install/bin/open5gs-upfd -c /app/install/etc/open5gs/upf.yaml || true
    echo "UPF exited, restarting in 2 seconds..."
    sleep 2
done
