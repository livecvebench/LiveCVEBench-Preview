# Dockerfile for JEHC-BPM Remote Code Execution Vulnerability
# Multi-stage build for JDK 8 Spring Boot application

# Stage 1: Build
FROM maven:3.8-openjdk-8 AS builder

# Accept proxy settings as build args
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG http_proxy
ARG https_proxy

WORKDIR /build

# Copy Maven settings with proxy configuration
COPY task-deps/settings.xml /root/.m2/settings.xml

# Copy the vulnerable source code from local directory
COPY source-code /build/JEHC-BPM

WORKDIR /build/JEHC-BPM/jehc-djshi

# Copy the Docker-specific application config
COPY task-deps/application-docker.yml /build/JEHC-BPM/jehc-djshi/jehc-api/src/main/resources/application-docker.yml

# Build the application
RUN mvn clean package -DskipTests -Dmaven.test.skip=true

# Stage 2: Runtime
FROM eclipse-temurin:8-jdk

WORKDIR /app

# Install required tools including Maven for solution application
RUN apt-get update && apt-get install -y \
    curl \
    tmux \
    asciinema \
    procps \
    maven \
    && rm -rf /var/lib/apt/lists/*

# Copy the built application and source code
COPY --from=builder /build/JEHC-BPM/jehc-djshi /app/jehc-djshi

# Copy Maven cache from builder to speed up rebuilds
COPY --from=builder /root/.m2 /root/.m2

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create logs directory
RUN mkdir -p /app/logs/jehc

# Expose port
EXPOSE 8082

# Set entrypoint
# ENTRYPOINT ["/entrypoint.sh"]  # Moved to docker-compose.yaml
