#!/bin/bash
set -e

echo "Applying manual fix for CVE-2025-55298 format string vulnerability in InterpretImageFilename..."

cd /app

# The vulnerability is in MagickCore/image.c line 1699:
# count=FormatLocaleString(pattern,sizeof(pattern),q,value);
# where q contains user-controlled format string that can contain %n

# First, backup the original file
cp MagickCore/image.c MagickCore/image.c.backup

# Replace the vulnerable FormatLocaleString call with a safe version
# Instead of passing user input 'q' directly as format string, we build our own safe format
echo "Applying security fix to MagickCore/image.c..."

# Create the fix by replacing the vulnerable line with safe format string construction
sed -i 's/count=FormatLocaleString(pattern,sizeof(pattern),q,value);/{\
          char safe_format[32];\
          size_t specifier_length = cursor - q;\
          if (specifier_length >= sizeof(safe_format)) {\
            \/\* Invalid format specifier too long \*\/\
            (void) CopyMagickString(p+offset,q,MagickPathExtent-offset);\
            break;\
          }\
          \/\* Build safe format string with validated specifier \*\/\
          (void) CopyMagickString(safe_format,q,specifier_length+1);\
          safe_format[specifier_length+1] = '"'"'\\0'"'"';\
          \/\* Only allow safe format specifiers d, o, x \*\/\
          if ((safe_format[specifier_length] == '"'"'d'"'"') || \
              (safe_format[specifier_length] == '"'"'o'"'"') || \
              (safe_format[specifier_length] == '"'"'x'"'"')) {\
            count=FormatLocaleString(pattern,sizeof(pattern),safe_format,value);\
          } else {\
            \/\* Treat invalid specifiers as literal text \*\/\
            count = specifier_length + 1;\
            if ((offset+count) < MagickPathExtent)\
              (void) CopyMagickString(p+offset,q,count+1);\
          }\
        }/g' MagickCore/image.c

echo "Security fix applied, rebuilding ImageMagick..."

# Clean previous build
make clean || true

# Rebuild with the fix
make -j$(nproc)

# Install the fixed binaries
make install

# Update library cache
ldconfig

echo "CVE-2025-55298 fix applied successfully"

# Verify the fix by checking version
echo ""
echo "Verifying installation:"
magick --version
