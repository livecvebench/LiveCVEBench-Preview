#!/bin/bash
# Solution script for Bagisto SSTI vulnerability in product descriptions
# This fix sanitizes Blade template syntax in compileString() when called on untrusted input

set -e

cd /var/www/html

echo "=== Applying fix for product description template injection ==="

# Bagisto uses its own custom BladeCompiler at Webkul\Core\View\Compilers\BladeCompiler
# We need to modify this class to sanitize input in compileString()
# only when not compiling a template file

COMPILER_FILE="packages/Webkul/Core/src/View/Compilers/BladeCompiler.php"

if [ ! -f "$COMPILER_FILE" ]; then
    echo "Error: BladeCompiler not found at $COMPILER_FILE"
    exit 1
fi

# Restore from backup if exists, to start fresh
if [ -f "${COMPILER_FILE}.backup" ]; then
    cp "${COMPILER_FILE}.backup" "$COMPILER_FILE"
fi

# Backup original file
cp "$COMPILER_FILE" "${COMPILER_FILE}.backup"

echo "Patching BladeCompiler to sanitize Blade syntax in untrusted input..."

# Create the patched BladeCompiler
cat > "$COMPILER_FILE" << 'PHPEOF'
<?php

namespace Webkul\Core\View\Compilers;

use Illuminate\View\Compilers\BladeCompiler as BaseBladeCompiler;

class BladeCompiler extends BaseBladeCompiler
{
    /**
     * Flag to indicate if we're currently compiling a file.
     * When true, we should not sanitize the input.
     */
    protected bool $compilingFile = false;

    /**
     * Patterns that indicate Blade template syntax which should be sanitized
     * from user-provided content to prevent SSTI attacks.
     *
     * Note: Block patterns (like @php...@endphp) must come BEFORE their individual parts
     * to remove the entire block including contents.
     */
    protected static array $dangerousPatterns = [
        /* Block patterns - remove entire blocks including contents */
        '/@php.*?@endphp/is',
        '/<\?php.*?\?' . '>/is',
        '/\{\{.*?\}\}/s',
        '/\{!!.*?!!\}/s',
        '/@if\s*\(.*?\).*?@endif/is',
        '/@foreach\s*\(.*?\).*?@endforeach/is',
        '/@for\s*\(.*?\).*?@endfor/is',
        '/@while\s*\(.*?\).*?@endwhile/is',
        '/@switch\s*\(.*?\).*?@endswitch/is',
        '/@auth.*?@endauth/is',
        '/@guest.*?@endguest/is',
        '/@section\s*\(.*?\).*?@endsection/is',

        /* Individual directives - catch any remaining */
        '/@php\b/i',
        '/@endphp\b/i',
        '/@if\b/i',
        '/@endif\b/i',
        '/@else\b/i',
        '/@elseif\b/i',
        '/@foreach\b/i',
        '/@endforeach\b/i',
        '/@for\b/i',
        '/@endfor\b/i',
        '/@while\b/i',
        '/@endwhile\b/i',
        '/@include\b/i',
        '/@extends\b/i',
        '/@section\b/i',
        '/@endsection\b/i',
        '/@yield\b/i',
        '/@push\b/i',
        '/@endpush\b/i',
        '/@stack\b/i',
        '/@inject\b/i',
        '/@auth\b/i',
        '/@endauth\b/i',
        '/@guest\b/i',
        '/@endguest\b/i',
        '/@switch\b/i',
        '/@case\b/i',
        '/@break\b/i',
        '/@default\b/i',
        '/@endswitch\b/i',
        '/<\?php/i',
        '/\?' . '>/i',
        '/\{\{/',
        '/\}\}/',
        '/\{!!/',
        '/!!\}/',
    ];

    /**
     * Sanitize a string by removing Blade template syntax.
     *
     * @param string|null $value
     * @return string
     */
    public static function sanitize(?string $value): string
    {
        if ($value === null) {
            return '';
        }

        return preg_replace(static::$dangerousPatterns, '', $value);
    }

    /**
     * Compile the Blade template file at the given path.
     *
     * @param string|null $path
     * @return void
     */
    public function compile($path = null)
    {
        // Set flag before compiling a file
        $this->compilingFile = true;

        try {
            parent::compile($path);
        } finally {
            // Always reset the flag after compilation
            $this->compilingFile = false;
        }
    }

    /**
     * Compile the given Blade template contents.
     *
     * Override the parent method to sanitize the input string when
     * not compiling a template file (i.e., when called directly with
     * potentially untrusted user input).
     *
     * @param string $value
     * @return string
     */
    public function compileString($value)
    {
        // Only sanitize if we're NOT compiling a file
        // (meaning this is likely untrusted user input)
        if (!$this->compilingFile) {
            $value = static::sanitize($value);
        }

        // Then compile normally
        return parent::compileString($value);
    }

    /**
     * Append the file path to the compiled string.
     *
     * @param  string  $contents
     * @return string
     */
    protected function appendFilePath($contents)
    {
        $tokens = $this->getOpenAndClosingPhpTokens($contents);

        if (
            config('view.tracer')
            && strpos($this->getPath(), 'tracer/style.blade.php') == false
            && strpos($this->getPath(), 'master.blade.php') == false
        ) {
            $finalPath = str_replace('/Providers/..', '', str_replace(base_path(), '', $this->getPath()));

            $contents = '<div class="path-hint" data-toggle="tooltip" data-title="'.$finalPath.'" data-id="'.uniqid().'"><span class="testing"></span>'.$contents.'</div>';
        }

        if (
            $tokens->isNotEmpty()
            && $tokens->last() !== T_CLOSE_TAG
        ) {
            $contents .= ' ?>';
        }

        return $contents."<?php /**PATH {$this->getPath()} ENDPATH**/ ?>";
    }
}
PHPEOF

echo "Patched BladeCompiler with context-aware SSTI sanitization"

# Also apply the fix to the view file for defense in depth
VIEW_FILE="packages/Webkul/Shop/src/Resources/views/products/view.blade.php"
if [ -f "$VIEW_FILE" ]; then
    # Restore from backup if exists
    if [ -f "${VIEW_FILE}.backup" ]; then
        cp "${VIEW_FILE}.backup" "$VIEW_FILE"
    else
        cp "$VIEW_FILE" "${VIEW_FILE}.backup"
    fi

    echo "Applying additional protection to view file..."

    # Use Python to safely replace the vulnerable pattern
    python3 << 'PYEOF'
import re

view_file = "packages/Webkul/Shop/src/Resources/views/products/view.blade.php"

with open(view_file, 'r') as f:
    content = f.read()

# Pattern to match {!! $product->description !!}
pattern = r'\{!!\s*\$product->description\s*!!\}'

# Replacement with inline sanitization
replacement = r"{!! preg_replace('/\{\{|\}\}|@php|@endphp|@if|@endif|@foreach|@endforeach|@for|@endfor|@while|@endwhile|@include|@extends|@section|@endsection|@yield|@push|@endpush|@inject|@auth|@endauth|@guest|@endguest|<\?php|\?>/', '', \$product->description ?? '') !!}"

# Count occurrences before replacement
occurrences = len(re.findall(pattern, content))
print(f"Found {occurrences} occurrence(s) of vulnerable pattern in view file")

# Perform replacement
new_content = re.sub(pattern, replacement, content)

with open(view_file, 'w') as f:
    f.write(new_content)

print(f"Replaced {occurrences} occurrence(s) in view file")
PYEOF
else
    echo "Note: View file not found at $VIEW_FILE"
fi

# Clear OPcache if available
echo "Clearing OPcache..."
php -r "if (function_exists('opcache_reset')) { opcache_reset(); echo \"OPcache cleared\\n\"; } else { echo \"OPcache not available\\n\"; }"

# Clear Laravel caches to ensure the fix takes effect
echo "Clearing Laravel caches..."
php artisan view:clear 2>/dev/null || echo "Note: Could not clear view cache"
php artisan cache:clear 2>/dev/null || echo "Note: Could not clear cache"
php artisan config:clear 2>/dev/null || echo "Note: Could not clear config cache"

# Remove compiled views
rm -rf storage/framework/views/*.php 2>/dev/null || true

echo "=== Fix applied successfully ==="
echo ""
echo "Changes made:"
echo "1. Patched Webkul BladeCompiler with context-aware sanitization"
echo "   - Template files compile normally"
echo "   - Direct compileString() calls sanitize user input"
echo "2. Applied additional sanitization to product view template"
echo "3. Cleared all Laravel caches"
echo ""
echo "Product descriptions will now have Blade template syntax stripped"
echo "before rendering, preventing Server-Side Template Injection."
