#!/bin/bash
set -e

# Wait for the database to be ready
echo "Waiting for database to be ready..."
MAX_RETRIES=30
RETRY_COUNT=0
while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if mysql --skip-ssl -h "$MYSQL_HOST" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" -e "SELECT 1" > /dev/null 2>&1; then
        echo "Database is ready!"
        break
    fi
    RETRY_COUNT=$((RETRY_COUNT + 1))
    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
        echo "Database not ready after $MAX_RETRIES attempts, starting anyway..."
        break
    fi
    echo "Database not ready, waiting... ($RETRY_COUNT/$MAX_RETRIES)"
    sleep 2
done

# Initialize database if tables don't exist
echo "Checking database tables..."
TABLE_COUNT=$(mysql --skip-ssl -h "$MYSQL_HOST" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" -N -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = '$MYSQL_DATABASE'" 2>/dev/null || echo "0")

if [ "$TABLE_COUNT" -eq "0" ] || [ "$TABLE_COUNT" = "0" ]; then
    echo "Initializing database tables..."
    if [ -f /init.sql ]; then
        mysql --skip-ssl -h "$MYSQL_HOST" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" < /init.sql
        echo "Database initialized successfully!"
    else
        echo "Warning: /init.sql not found, skipping database initialization"
    fi
else
    echo "Database already has $TABLE_COUNT tables, skipping initialization"
fi

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
