#!/bin/bash
# Solution script for ModSecurity JSON memory issue
# This script applies the fix to prevent exponential memory growth
# when processing JSON payloads with sanitiseMatchedBytes action
set -e

cd /app

echo "Applying fix for ModSecurity memory issue..."

# 1. Add marked_for_sanitization field to msc_arg struct in modsecurity.h
# Insert the new field after the 'origin' field
if ! grep -q "marked_for_sanitization" apache2/modsecurity.h; then
    echo "Step 1: Adding marked_for_sanitization field to modsecurity.h..."
    sed -i '/const char[[:space:]]*\*origin;/a\    unsigned int             marked_for_sanitization;' apache2/modsecurity.h
else
    echo "Step 1: marked_for_sanitization field already exists in modsecurity.h"
fi

# 2. Initialize the field in msc_json.c when creating JSON arguments
# Add initialization after value_origin_len = 0
if ! grep -q "marked_for_sanitization = 0" apache2/msc_json.c; then
    echo "Step 2: Adding initialization in msc_json.c..."
    sed -i '/arg->value_origin_len = 0;/a\    arg->marked_for_sanitization = 0;' apache2/msc_json.c
else
    echo "Step 2: Initialization already exists in msc_json.c"
fi

# 3. Initialize the field in msc_parsers.c when parsing arguments
# There are multiple places where arguments are created, so we need to find the right ones
if ! grep -q "marked_for_sanitization = 0" apache2/msc_parsers.c; then
    echo "Step 3: Adding initialization in msc_parsers.c..."
    # Add after value_origin_len assignments in argument creation
    sed -i '/arg->value_origin_len = strlen(value);/a\    arg->marked_for_sanitization = 0;' apache2/msc_parsers.c
else
    echo "Step 3: Initialization already exists in msc_parsers.c"
fi

# 4. Modify re_actions.c to check and set the flag
# Change: if (strcasecmp(sargname, arg->name) == 0) {
# To: if (arg->marked_for_sanitization == 0 && strcasecmp(sargname, arg->name) == 0) {
# And add: arg->marked_for_sanitization = 1; after apr_table_addn
echo "Step 4: Modifying re_actions.c to add deduplication check..."

# First, update the condition to check the flag
if ! grep -q "arg->marked_for_sanitization == 0 && strcasecmp" apache2/re_actions.c; then
    sed -i 's/if (strcasecmp(sargname, arg->name) == 0) {/if (arg->marked_for_sanitization == 0 \&\& strcasecmp(sargname, arg->name) == 0) {/g' apache2/re_actions.c
else
    echo "  - Condition check already updated"
fi

# Second, add the flag assignment after apr_table_addn for arguments_to_sanitize
if ! grep -q "arg->marked_for_sanitization = 1;" apache2/re_actions.c; then
    sed -i '/apr_table_addn(msr->arguments_to_sanitize, arg->name, (void \*)arg);/a\                        arg->marked_for_sanitization = 1;' apache2/re_actions.c
else
    echo "  - Flag assignment already exists"
fi

echo "Step 5: Rebuilding ModSecurity..."
# Clean and rebuild
make clean 2>/dev/null || true
make -j$(nproc)
make install

echo "Step 6: Restarting Apache..."
# Kill Apache so the entrypoint can restart it with the new module
pkill -f "apache2" || true
sleep 3

echo ""
echo "Fix applied successfully!"
echo "The server will restart automatically."
