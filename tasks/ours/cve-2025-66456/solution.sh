#!/bin/bash
set -e
cd /app

echo "=== Applying fix for prototype pollution in mergeDeep ==="

# The vulnerable code is in the elysia package's utils.ts (or compiled JS)
# We need to find and fix the mergeDeep function

# Function to apply fix to a file
apply_fix() {
    local file="$1"
    echo "Processing: $file"

    # Check if the file contains the vulnerable pattern
    if grep -q 'skipKeys.*includes(key)' "$file" 2>/dev/null; then
        # Check if it's already fixed
        if grep -q '__proto__.*constructor.*prototype' "$file" 2>/dev/null; then
            echo "  Already fixed: $file"
            return 0
        fi

        # Create a backup
        cp "$file" "${file}.bak"

        # Apply fix using perl for more reliable regex handling
        perl -i -pe 's/if\s*\(skipKeys\?\.includes\(key\)\)\s*continue/if (skipKeys?.includes(key) || ["__proto__", "constructor", "prototype"].includes(key)) continue/g' "$file"

        # Verify fix was applied
        if grep -q '__proto__.*constructor.*prototype' "$file" 2>/dev/null; then
            echo "  Fixed successfully: $file"
            rm -f "${file}.bak"
            return 0
        else
            # Restore and try alternate pattern
            mv "${file}.bak" "$file"
            # Try with sed for simpler pattern
            sed -i 's/if (skipKeys?.includes(key)) continue/if (skipKeys?.includes(key) || ["__proto__", "constructor", "prototype"].includes(key)) continue/g' "$file" 2>/dev/null || true
            if grep -q '__proto__.*constructor.*prototype' "$file" 2>/dev/null; then
                echo "  Fixed successfully (alt): $file"
                return 0
            fi
        fi
    fi
    return 1
}

FIXED=0

# Try common locations for elysia files
for file in \
    "/app/node_modules/elysia/dist/index.js" \
    "/app/node_modules/elysia/dist/index.mjs" \
    "/app/node_modules/elysia/src/utils.ts" \
    "/app/node_modules/elysia/src/utils.js"; do
    if [ -f "$file" ]; then
        if apply_fix "$file"; then
            FIXED=1
        fi
    fi
done

# If no fix applied yet, search more broadly
if [ "$FIXED" -eq 0 ]; then
    echo "Searching for vulnerable files..."
    while IFS= read -r file; do
        if [ -f "$file" ] && grep -q 'skipKeys.*includes(key)' "$file" 2>/dev/null; then
            if apply_fix "$file"; then
                FIXED=1
            fi
        fi
    done < <(find /app/node_modules/elysia -type f \( -name "*.js" -o -name "*.ts" -o -name "*.mjs" \) 2>/dev/null)
fi

# Verify the fix
echo ""
echo "=== Verifying fix ==="
if [ "$FIXED" -eq 1 ]; then
    echo "Fix applied successfully!"
else
    echo "WARNING: Could not find or apply fix to vulnerable files"
    echo "Listing elysia files for debugging:"
    find /app/node_modules/elysia -type f \( -name "*.js" -o -name "*.ts" \) 2>/dev/null | head -10
fi

# Restart the server process so changes take effect
# Bun processes need to be restarted to pick up module changes
echo ""
echo "=== Restarting server ==="
pkill -f "bun.*proto-pollution" || true
pkill -f "bun.*server" || true
pkill -f "bun run" || true
pkill -f "bun" || true

# Give processes time to terminate
sleep 3

echo "Fix applied! The entrypoint should restart the server automatically."
