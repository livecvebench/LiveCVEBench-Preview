"""
Functional tests for OrderConvo file download feature.
These tests verify that the legitimate file download functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import subprocess
import os
import time

BASE_URL = os.environ.get("APP_URL", "http://localhost")


def wait_for_wordpress(timeout=60):
    """Wait for WordPress to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{BASE_URL}/wp-json/", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


class TestPluginFunctionality:
    """Tests to verify OrderConvo plugin is properly installed and functional."""

    @pytest.fixture(scope="class", autouse=True)
    def setup(self):
        """Wait for WordPress to be ready before running tests."""
        assert wait_for_wordpress(), "WordPress did not become ready in time"

    def test_wordpress_running(self):
        """Test that WordPress is running and responding."""
        response = requests.get(f"{BASE_URL}/", timeout=10)
        assert response.status_code == 200, "WordPress is not responding"

    def test_rest_api_available(self):
        """Test that WordPress REST API is accessible."""
        response = requests.get(f"{BASE_URL}/wp-json/", timeout=10)
        assert response.status_code == 200, "REST API is not available"

    def test_wooconvo_namespace_exists(self):
        """Test that the wooconvo REST API namespace is registered."""
        response = requests.get(f"{BASE_URL}/wp-json/", timeout=10)
        # The namespace should be registered if the plugin is active
        # Even if we get an error, the namespace being recognized shows the plugin is loaded
        wooconvo_response = requests.get(f"{BASE_URL}/wp-json/wooconvo/v1/", timeout=10)
        # A 404 on the base namespace or 200 both indicate plugin is registered
        assert wooconvo_response.status_code in [200, 404], \
            f"Unexpected status code: {wooconvo_response.status_code}"

    def test_download_endpoint_exists(self):
        """Test that the download-file endpoint is registered."""
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "nonexistent.txt"},
            timeout=10
        )
        # Endpoint should exist (not 404 for the route itself)
        # Missing file should not crash - returns empty or error, not 500
        assert response.status_code != 500, \
            f"Endpoint crashed with status {response.status_code}"

    def test_download_nonexistent_file_no_crash(self):
        """Test that downloading a non-existent file doesn't crash the server."""
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "999", "filename": "file_that_does_not_exist.pdf"},
            timeout=10
        )
        # Should not return 500 error
        assert response.status_code != 500, \
            "Server crashed when requesting non-existent file"

    def test_download_missing_parameters(self):
        """Test that missing required parameters are handled gracefully."""
        # Missing filename
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1"},
            timeout=10
        )
        assert response.status_code != 500, \
            "Server crashed when missing filename parameter"

        # Missing order_id
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"filename": "test.txt"},
            timeout=10
        )
        assert response.status_code != 500, \
            "Server crashed when missing order_id parameter"

    def test_rest_api_routes_registered(self):
        """Test that REST API routes for wooconvo are properly registered."""
        response = requests.get(f"{BASE_URL}/wp-json/", timeout=10)
        if response.status_code == 200:
            data = response.json()
            # Check if wooconvo namespace exists in namespaces list
            namespaces = data.get('namespaces', [])
            # Plugin may not be activated, so we check for both scenarios
            # If plugin is active, wooconvo/v1 should be present
            # This test mainly verifies WP is functioning
            assert isinstance(namespaces, list), "REST API returned unexpected format"
