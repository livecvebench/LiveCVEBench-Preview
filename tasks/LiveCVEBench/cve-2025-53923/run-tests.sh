#!/bin/bash
set -e
cd "$(dirname "$0")"

# Unset proxy for internal Docker network communication
unset http_proxy HTTP_PROXY https_proxy HTTPS_PROXY
export no_proxy="localhost,127.0.0.1,webserver-nginx,app,db"
export NO_PROXY="localhost,127.0.0.1,webserver-nginx,app,db"

# Set environment variables for the application
# Use webserver-nginx for internal Docker network, localhost:8080 for external
export APP_URL="${APP_URL:-http://webserver-nginx:8080}"
export ADMIN_USER="${ADMIN_USER:-admin}"
export ADMIN_PASS="${ADMIN_PASS:-admin123}"

# Wait for application to be ready (check homepage and admin panel)
echo "Waiting for application to be ready..."
max_attempts=60
attempt=0
while [ $attempt -lt $max_attempts ]; do
    # Check if homepage responds with 200
    if curl -sL -o /dev/null -w "%{http_code}" "$APP_URL" | grep -q "200"; then
        # Also check if admin login page is available (indicates installation completed)
        if curl -sL "$APP_URL/admin/" | grep -q "登录\|login\|signin"; then
            echo "Application is ready"
            break
        fi
    fi
    attempt=$((attempt + 1))
    echo "Attempt $attempt/$max_attempts - waiting for installation to complete..."
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "Warning: Application may not be fully ready, proceeding with tests anyway"
fi

# Extra wait to ensure database is fully populated
sleep 5

# Run tests
echo "Running tests..."
pytest . -rA
