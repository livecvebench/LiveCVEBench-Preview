#!/bin/bash
# Solution script for BentoML SSRF vulnerability
# This script applies the fix by replacing files with pre-patched versions

set -e
cd /app

echo "Applying fix for URL validation (file replacement method)..."

# Find the BentoML installation paths
BENTOML_PATH=$(python3 -c "import bentoml; import os; print(os.path.dirname(bentoml.__file__))")
BENTOML_IMPL_PATH=$(python3 -c "import _bentoml_impl; import os; print(os.path.dirname(_bentoml_impl.__file__))")

URI_FILE="${BENTOML_PATH}/_internal/utils/uri.py"
SERDE_FILE="${BENTOML_IMPL_PATH}/serde.py"

echo "BentoML path: ${BENTOML_PATH}"
echo "BentoML impl path: ${BENTOML_IMPL_PATH}"
echo "URI file: ${URI_FILE}"
echo "Serde file: ${SERDE_FILE}"

# Step 1: Replace uri.py with the fixed version
echo "Step 1: Replacing uri.py with fixed version..."
if [ -f "/app/task-deps/uri_fixed.py" ]; then
    cp /app/task-deps/uri_fixed.py "$URI_FILE"
    echo "Replaced uri.py with fixed version"
else
    echo "ERROR: /app/task-deps/uri_fixed.py not found!"
    exit 1
fi

# Step 2: Replace serde.py with the fixed version
echo "Step 2: Replacing serde.py with fixed version..."
if [ -f "/app/task-deps/serde_fixed.py" ]; then
    cp /app/task-deps/serde_fixed.py "$SERDE_FILE"
    echo "Replaced serde.py with fixed version"
else
    echo "ERROR: /app/task-deps/serde_fixed.py not found!"
    exit 1
fi

# Step 3: Verify the fix was applied
echo "Step 3: Verifying fix..."

if grep -q "def is_safe_url" "$URI_FILE"; then
    echo "URI_FILE: is_safe_url function found"
else
    echo "ERROR: is_safe_url function not found in URI_FILE"
    exit 1
fi

if grep -q "is_safe_url" "$SERDE_FILE" && grep -q "URL not allowed" "$SERDE_FILE"; then
    echo "SERDE_FILE: is_safe_url usage found"
else
    echo "ERROR: is_safe_url usage not found in SERDE_FILE"
    exit 1
fi

echo "Fix verified successfully!"

# Step 4: Restart the BentoML service to apply changes
echo "Step 4: Restarting BentoML service..."

# Kill the existing BentoML service process
pkill -f "bentoml serve" || true
pkill -f "uvicorn" || true
sleep 2

# Restart the service
cd /app
nohup bentoml serve service:FileProcessor --host 0.0.0.0 --port 3000 > /var/log/bentoml.log 2>&1 &

# Wait for service to start
echo "Waiting for service to start..."
MAX_WAIT=60
WAIT_COUNT=0
while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
    if curl -s http://localhost:3000/readyz > /dev/null 2>&1; then
        echo "Service started successfully!"
        break
    fi
    sleep 2
    WAIT_COUNT=$((WAIT_COUNT + 2))
done

if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
    echo "WARNING: Service did not start within timeout, but fix was applied"
fi

echo "Fix applied successfully!"
