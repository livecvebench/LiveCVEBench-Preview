# Dockerfile for soft-serve v0.11.0 (vulnerable version)
# This builds the Go application from source and keeps the toolchain for patching

FROM golang:1.23-bookworm

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    openssh-client \
    ca-certificates \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Clone the vulnerable version and remove git history
RUN git clone --branch v0.11.0 --depth 1 https://github.com/charmbracelet/soft-serve.git . && \
    rm -rf .git

# Download Go dependencies
RUN go mod download

# Build the soft-serve binary
RUN go build -o /usr/local/bin/soft ./cmd/soft

# Create data directory
RUN mkdir -p /soft-serve

# Generate SSH keys for admin access
RUN mkdir -p /root/.ssh && \
    ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N "" && \
    chmod 600 /root/.ssh/id_ed25519 && \
    chmod 644 /root/.ssh/id_ed25519.pub

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV SOFT_SERVE_DATA_PATH=/soft-serve
ENV CI=1


# Use entrypoint script for restart capability
# CMD ["/entrypoint.sh"]
