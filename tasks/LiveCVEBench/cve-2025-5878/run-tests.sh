#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== Installing test dependencies ==="
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

echo ""
echo "=== Waiting for application to be ready ==="
# Give the application time to start (Maven build may take time)
sleep 5

# Check if the test JAR exists
if [ ! -f "/app/target/esapi-test-1.0-SNAPSHOT-jar-with-dependencies.jar" ]; then
    echo "Test JAR not found, building..."
    cd /app
    mvn clean package -q -DskipTests 2>/dev/null || true
    cd "$(dirname "$0")"
fi

echo ""
echo "=== Running tests ==="
uv run pytest . -rA
