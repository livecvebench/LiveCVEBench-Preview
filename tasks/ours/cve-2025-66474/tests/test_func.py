#!/usr/bin/env python3
"""
Functionality tests for XHTMLWikiPrinter.

These tests verify that the basic functionality of the XHTML rendering
component works correctly in both vulnerable and fixed states.
"""

import subprocess
import pytest
import os


JAVA_TEST_DIR = "/tests"
APP_DIR = "/app"
CLASSPATH = f"{APP_DIR}:{APP_DIR}/lib/*:."


def compile_and_run_java_test(test_class: str, method: str = None) -> tuple:
    """
    Compile and run a Java test method.
    Returns (success: bool, output: str)
    """
    # Compile the test helper
    compile_cmd = [
        "javac",
        "-cp", CLASSPATH,
        "-d", ".",
        "PrinterTestHelper.java"
    ]

    result = subprocess.run(
        compile_cmd,
        cwd=JAVA_TEST_DIR,
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        return False, f"Compilation failed: {result.stderr}"

    # Run the test
    run_cmd = [
        "java",
        "-cp", CLASSPATH,
        "PrinterTestHelper",
        test_class
    ]
    if method:
        run_cmd.append(method)

    result = subprocess.run(
        run_cmd,
        cwd=JAVA_TEST_DIR,
        capture_output=True,
        text=True,
        timeout=30
    )

    return result.returncode == 0, result.stdout + result.stderr


def run_escaping_test(input_str: str, expected_output: str, preserve_whitespace: bool = False) -> bool:
    """
    Run an escaping test by invoking the Java helper.
    Returns True if the output matches expected.

    Args:
        input_str: The input string to test
        expected_output: The expected output
        preserve_whitespace: If True, don't strip whitespace from output
    """
    compile_cmd = [
        "javac",
        "-cp", CLASSPATH,
        "-d", ".",
        "PrinterTestHelper.java"
    ]

    result = subprocess.run(
        compile_cmd,
        cwd=JAVA_TEST_DIR,
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        pytest.fail(f"Compilation failed: {result.stderr}")

    run_cmd = [
        "java",
        "-cp", CLASSPATH,
        "PrinterTestHelper",
        "escape",
        input_str
    ]

    result = subprocess.run(
        run_cmd,
        cwd=JAVA_TEST_DIR,
        capture_output=True,
        text=True,
        timeout=30
    )

    if preserve_whitespace:
        actual_output = result.stdout.rstrip('\n')  # Only strip trailing newline
    else:
        actual_output = result.stdout.strip()
    return actual_output == expected_output, actual_output


class TestBasicFunctionality:
    """Test basic XHTML printing functionality."""

    def test_plain_text_passes_through(self):
        """Plain text without special sequences should pass through unchanged."""
        input_str = "Hello, this is a simple text."
        expected = "Hello, this is a simple text."

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_html_entities_preserved(self):
        """HTML entities should be preserved in raw content."""
        input_str = "Text with &amp; and &lt; entities"
        expected = "Text with &amp; and &lt; entities"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_normal_curly_braces(self):
        """Single curly braces used in code should work (though { at end is escaped)."""
        input_str = "function example() { return 1; }"
        # Single { at the end would be escaped, but this one is followed by more text
        expected = "function example() { return 1; }"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_numeric_content(self):
        """Numeric content should pass through unchanged."""
        input_str = "Price: $123.45 or 100%"
        expected = "Price: $123.45 or 100%"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_unicode_content(self):
        """Unicode content should pass through unchanged."""
        input_str = "Unicode: cafÃ©, æ—¥æœ¬èªž, Ã©moji ðŸŽ‰"
        expected = "Unicode: cafÃ©, æ—¥æœ¬èªž, Ã©moji ðŸŽ‰"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"


class TestExistingEscapingBehavior:
    """Test that existing escaping behavior is preserved."""

    def test_exact_closing_sequence_escaped(self):
        """The exact {{/html}} sequence should always be escaped."""
        input_str = "Closing the {{/html}} macro."
        expected = "Closing the &#123;&#123;/html}} macro."

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_single_brace_at_end_escaped(self):
        """A single { at the end should be escaped to prevent combination attacks."""
        input_str = "Starting a macro {"
        expected = "Starting a macro &#123;"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_partial_closing_prefix_escaped(self):
        """Partial {{/h prefix at end should be escaped."""
        input_str = "Partial: {{/h"
        expected = "Partial: {&#123;/h"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_multiple_exact_closing_sequences(self):
        """Multiple exact {{/html}} sequences should all be escaped."""
        input_str = "First {{/html}} and second {{/html}} end"
        expected = "First &#123;&#123;/html}} and second &#123;&#123;/html}} end"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected '{expected}' but got '{actual}'"


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_empty_string(self):
        """Empty string should produce empty output."""
        input_str = ""
        expected = ""

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected empty string but got '{actual}'"

    def test_whitespace_only(self):
        """Whitespace-only content should pass through."""
        input_str = "   "
        expected = "   "

        success, actual = run_escaping_test(input_str, expected, preserve_whitespace=True)
        assert success, f"Expected '{expected}' but got '{actual}'"

    def test_newlines_in_content(self):
        """Newlines should be preserved."""
        input_str = "Line 1\nLine 2\nLine 3"
        expected = "Line 1\nLine 2\nLine 3"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected content with newlines but got '{actual}'"

    def test_tabs_in_content(self):
        """Tabs should be preserved in general content."""
        input_str = "Column1\tColumn2\tColumn3"
        expected = "Column1\tColumn2\tColumn3"

        success, actual = run_escaping_test(input_str, expected)
        assert success, f"Expected content with tabs but got '{actual}'"
