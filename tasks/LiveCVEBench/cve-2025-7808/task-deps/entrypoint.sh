#!/bin/bash
set -e

# Function to wait for MySQL
wait_for_mysql() {
    echo "Waiting for MySQL to be ready..."
    while ! mysqladmin ping -h"db" --silent 2>/dev/null; do
        sleep 2
        echo "Still waiting for MySQL..."
    done
    echo "MySQL is ready!"
}

# Function to setup WordPress
setup_wordpress() {
    cd /var/www/html

    # Check if WordPress is already installed
    if wp core is-installed --allow-root 2>/dev/null; then
        echo "WordPress is already installed."
    else
        echo "Installing WordPress..."
        # Download WordPress if not present
        if [ ! -f /var/www/html/wp-config.php ]; then
            # Wait a bit more for WordPress to be ready
            sleep 5
        fi

        # Install WordPress core
        wp core install \
            --url="http://localhost" \
            --title="CVE-2025-7808 Test Site" \
            --admin_user=admin \
            --admin_password=admin123 \
            --admin_email=admin@example.com \
            --skip-email \
            --allow-root

        echo "WordPress installed successfully!"
    fi
}

# Function to setup WP Shopify plugin
setup_plugin() {
    cd /var/www/html

    # Check if plugin is already installed
    if [ -d /var/www/html/wp-content/plugins/wp-shopify ]; then
        echo "WP Shopify plugin already installed."
    else
        echo "Installing WP Shopify plugin..."
        unzip -o /tmp/wp-shopify-1.5.3.zip -d /var/www/html/wp-content/plugins/
        chown -R www-data:www-data /var/www/html/wp-content/plugins/wp-shopify
        echo "WP Shopify plugin installed!"
    fi

    # Activate plugin
    if wp plugin is-active wp-shopify --allow-root 2>/dev/null; then
        echo "WP Shopify plugin is already active."
    else
        echo "Activating WP Shopify plugin..."
        wp plugin activate wp-shopify --allow-root
        echo "WP Shopify plugin activated!"
    fi

    # Configure plugin settings - use wp eval to properly set the array option
    echo "Configuring WP Shopify plugin settings..."
    wp eval 'update_option("wpsy_db_data", array("wpsy_api_key" => "test-key", "wpsy_password" => "test-password", "wpsy_storefront_shared" => "test-shared", "wpsy_storefront_token" => "test-token", "wpsy_url" => "example.myshopify.com"));' --allow-root
    echo "Plugin configured!"
}

# Function to create test page
create_test_page() {
    cd /var/www/html

    # Check if test page exists
    if wp post list --post_type=page --name=shopify-test --format=count --allow-root 2>/dev/null | grep -q "^[1-9]"; then
        echo "Test page already exists."
    else
        echo "Creating test page..."
        wp post create \
            --post_type=page \
            --post_title="Shopify Test" \
            --post_name="shopify-test" \
            --post_content='[wp-shopify-continue-shopping]' \
            --post_status=publish \
            --allow-root
        echo "Test page created!"
    fi

    # Set permalink structure
    echo "Setting permalink structure..."
    wp rewrite structure '/%postname%/' --allow-root 2>/dev/null || true
    wp rewrite flush --allow-root 2>/dev/null || true
}

# Main entrypoint
main() {
    echo "Starting WordPress setup..."

    # Wait for MySQL
    wait_for_mysql

    # Run the original WordPress entrypoint in the background to set up wp-config.php
    # and then do our setup
    /usr/local/bin/docker-entrypoint.sh apache2-foreground &
    APACHE_PID=$!

    # Wait for WordPress files to be ready
    echo "Waiting for WordPress files..."
    sleep 10

    # Setup WordPress
    setup_wordpress

    # Setup plugin
    setup_plugin

    # Create test page
    create_test_page

    echo "Setup complete! WordPress is running."
    echo "Admin URL: http://localhost/wp-admin/"
    echo "Test page: http://localhost/shopify-test/"
    echo "XSS test: http://localhost/shopify-test/?product=test%22onload=alert(1)//"

    # Wait for Apache process
    wait $APACHE_PID
}

main "$@"
