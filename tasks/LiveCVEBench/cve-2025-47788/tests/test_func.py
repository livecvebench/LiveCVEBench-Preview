"""
Functional tests for Atheos IDE controller.php

These tests verify that the controller routing mechanism works correctly
for legitimate component and plugin requests.
"""

import pytest
import requests
import time
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")
MAX_RETRIES = 30
RETRY_DELAY = 2


@pytest.fixture(scope="module")
def session():
    """Create an authenticated session for testing."""
    s = requests.Session()
    s.headers.update({
        "Content-Type": "application/x-www-form-urlencoded"
    })

    # Wait for application to be ready
    for i in range(MAX_RETRIES):
        try:
            resp = s.get(f"{BASE_URL}/", timeout=5)
            if resp.status_code == 200:
                break
        except requests.exceptions.RequestException:
            pass
        time.sleep(RETRY_DELAY)
    else:
        pytest.fail(f"Application not ready at {BASE_URL} after {MAX_RETRIES * RETRY_DELAY} seconds")

    # Authenticate - Atheos requires login
    # For testing, attempt to authenticate with default/setup credentials
    auth_data = {
        "action": "authenticate",
        "target": "user",
        "username": "admin",
        "password": "admin",
        "remember": "false"
    }

    try:
        resp = s.post(f"{BASE_URL}/controller.php", data=auth_data, timeout=10)
        # If authentication succeeds, great. If not, tests will handle appropriately
    except requests.exceptions.RequestException:
        pass

    return s


class TestControllerRouting:
    """Test that legitimate controller routing works correctly."""

    def test_controller_endpoint_accessible(self, session):
        """Verify the controller.php endpoint is accessible."""
        response = session.get(f"{BASE_URL}/controller.php", timeout=10)
        # Should not return 404 or 500 for the endpoint itself
        assert response.status_code != 404, "controller.php endpoint should exist"

    def test_missing_target_returns_error(self, session):
        """Test that missing target parameter returns appropriate error."""
        data = {
            "action": "test"
            # No target parameter
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should return error status (415 according to source)
        # Accept various error codes as valid - just not 200 success
        assert response.status_code in [400, 403, 415, 500] or \
               "missing" in response.text.lower() or \
               "error" in response.text.lower()

    def test_missing_action_returns_error(self, session):
        """Test that missing action parameter returns appropriate error."""
        data = {
            "target": "filemanager"
            # No action parameter
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should return error for missing action
        assert response.status_code in [400, 403, 415, 500] or \
               "missing" in response.text.lower() or \
               "error" in response.text.lower()

    def test_invalid_target_returns_not_found(self, session):
        """Test that invalid target returns 404 or appropriate error."""
        data = {
            "target": "nonexistent_component_xyz",
            "action": "test"
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should return 404 or error about bad target
        # Note: Atheos returns HTTP 200 with JSON error message in body
        assert response.status_code == 404 or \
               "bad target" in response.text.lower() or \
               "not found" in response.text.lower() or \
               "error" in response.text.lower() or \
               response.status_code >= 400

    def test_valid_component_format(self, session):
        """Test that valid component names don't crash the application."""
        # Test with common component names that should exist in Atheos
        components = ["filemanager", "active", "editor", "settings"]

        for component in components:
            data = {
                "target": component,
                "action": "test"
            }
            response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
            # Should not cause server error (500)
            # May return 404 if component doesn't exist, or other response if it does
            assert response.status_code != 500 or "error" not in response.text.lower()

    def test_simple_alphanumeric_target(self, session):
        """Test that simple alphanumeric targets work correctly."""
        data = {
            "target": "test123",
            "action": "list"
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should return proper response (404 for non-existent, not crash)
        assert response.status_code in [200, 401, 403, 404] or response.status_code < 500


class TestI18nComponent:
    """Test the i18n (internationalization) component."""

    def test_i18n_init_action(self, session):
        """Test that i18n initialization works."""
        data = {
            "target": "i18n",
            "action": "init"
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # i18n init should return 200 with cache data (or 401 if not authenticated)
        assert response.status_code in [200, 401, 403]


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_empty_target(self, session):
        """Test behavior with empty target string."""
        data = {
            "target": "",
            "action": "test"
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should handle gracefully, not crash
        assert response.status_code != 500

    def test_target_with_spaces(self, session):
        """Test behavior with spaces in target."""
        data = {
            "target": "test component",
            "action": "test"
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should handle gracefully
        assert response.status_code in [400, 404, 415] or response.status_code != 500

    def test_unicode_in_target(self, session):
        """Test behavior with unicode characters in target."""
        data = {
            "target": "test组件",
            "action": "test"
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should handle gracefully, not crash
        assert response.status_code != 500

    def test_very_long_target(self, session):
        """Test behavior with very long target string."""
        data = {
            "target": "a" * 1000,
            "action": "test"
        }
        response = session.post(f"{BASE_URL}/controller.php", data=data, timeout=10)
        # Should handle gracefully, return 404 or error
        # Note: Atheos may return 200 with JSON error message
        assert response.status_code in [200, 400, 404, 414, 415, 500]


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
