instruction: |-
  This is the Open5GS 5G Core Network software, providing Session Management Function
  (SMF) and Access and Mobility Management Function (AMF) among other network functions.

  We are experiencing an intermittent AMF crash in our 5G deployment. The crash occurs
  when mobile devices (UEs) move between base stations (gNodeBs). The issue seems to
  happen specifically during mobility scenarios where the UE switches cells multiple times.

  Steps to reproduce:
  1. UE connects to gNodeB1 and establishes a PDU session
  2. UE moves to gNodeB2 - handover completes successfully
  3. UE moves again (back to the same cell or to another cell with similar network config)
     - AMF crashes with exit code 6 (SIGABRT)

  From the AMF logs, we see this fatal error message right before the crash:
  "amf_nsmf_pdusession_handle_update_sm_context: should not be reached"

  The issue appears to be related to how the SMF responds to the AMF during path switch
  operations. In the second handover scenario, something goes wrong in the SMF-AMF
  communication that causes the AMF to reach an unexpected code path.

  We captured a pcap file (pathswitchrequest.pcap) showing the sequence of messages
  during the failure scenario. The crash is reproducible when the handover involves
  the same tunnel configuration as a previous handover.

  Please investigate and fix the bug so that consecutive path switches work reliably
  without crashing the AMF.

author_name: HIT-SCIR-LACG
author_email: xzluo@ir.hit.edu.cn

difficulty: hard
category: bug-fix
tags:
  - 5g-core
  - networking
  - smf
  - ngap
  - protocol-handling
  - assertion-failure
parser_name: pytest

run_tests_in_same_shell: false
