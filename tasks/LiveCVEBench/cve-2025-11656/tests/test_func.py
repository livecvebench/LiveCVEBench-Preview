#!/usr/bin/env python3
"""
Functional tests for the School Management System.
These tests verify that the application works correctly and should PASS
in both vulnerable and fixed states.
"""
import pytest
import requests
import time

BASE_URL = "http://localhost:80/school-management-system"
TIMEOUT = 10


class TestApplicationAccessibility:
    """Tests that verify the application is accessible and functioning."""

    def test_homepage_accessible(self):
        """Test that the application homepage is accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        assert response.status_code == 200, "Homepage should be accessible"

    def test_login_page_exists(self):
        """Test that the login page exists and contains login form."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=TIMEOUT)
        assert response.status_code == 200, "Login page should be accessible"

    def test_assets_directory_accessible(self):
        """Test that the assets directory structure exists."""
        response = requests.get(f"{BASE_URL}/assets/", timeout=TIMEOUT)
        # Either 200 (listing) or 403 (forbidden) are acceptable
        assert response.status_code in [200, 403], "Assets directory should exist"


class TestEndpointExistence:
    """Tests that verify required endpoints exist."""

    def test_edit_notes_endpoint_exists(self):
        """Test that the editNotes.php endpoint exists."""
        response = requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            timeout=TIMEOUT
        )
        # Should not return 404
        assert response.status_code != 404, "editNotes.php should exist"

    def test_upload_notes_endpoint_exists(self):
        """Test that the uploadNotes.php endpoint exists."""
        response = requests.post(
            f"{BASE_URL}/assets/uploadNotes.php",
            timeout=TIMEOUT
        )
        # Should not return 404
        assert response.status_code != 404, "uploadNotes.php should exist"

    def test_notes_uploads_directory_exists(self):
        """Test that the notesUploads directory exists."""
        response = requests.get(
            f"{BASE_URL}/notesUploads/",
            timeout=TIMEOUT
        )
        # Either 200 (directory listing) or 403 (forbidden) indicate existence
        assert response.status_code in [200, 403], "notesUploads directory should exist"


class TestDatabaseConnectivity:
    """Tests that verify database is connected and functional."""

    def test_login_endpoint_responds(self):
        """Test that login processing works (database is connected)."""
        # Attempt login with wrong credentials
        response = requests.post(
            f"{BASE_URL}/login-backend.php",
            data={
                "email": "test@test.com",
                "password": "wrongpassword"
            },
            timeout=TIMEOUT
        )
        # Should get a response (not a connection error)
        assert response.status_code == 200, "Login endpoint should respond"


class TestSessionManagement:
    """Tests that verify session management is functional."""

    def test_session_created_on_login(self):
        """Test that sessions are being managed by the application."""
        session = requests.Session()

        # Access a page that uses sessions
        response = session.get(f"{BASE_URL}/index.php", timeout=TIMEOUT)
        assert response.status_code == 200

        # Check that cookies are being set
        # The application should be managing sessions
        assert session.cookies is not None


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
