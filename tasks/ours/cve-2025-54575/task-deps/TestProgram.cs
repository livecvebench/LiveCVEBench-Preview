using SixLabors.ImageSharp;
using SixLabors.ImageSharp.Formats;

class Program
{
    static int Main(string[] args)
    {
        string gifPath = args.Length > 0 ? args[0] : "malformed_comment.gif";
        string mode = args.Length > 1 ? args[1] : "identify";

        if (!File.Exists(gifPath))
        {
            Console.WriteLine($"Error: File not found: {gifPath}");
            return 1;
        }

        try
        {
            if (mode == "skip-metadata")
            {
                // Test with SkipMetadata option
                var options = new DecoderOptions { SkipMetadata = true };
                using var ms = new MemoryStream(File.ReadAllBytes(gifPath));
                var info = Image.Identify(options, ms);
                Console.WriteLine($"Success: Processed {gifPath} with SkipMetadata=true");
                Console.WriteLine($"Dimensions: {info?.Width}x{info?.Height}");
                return 0;
            }
            else if (mode == "load")
            {
                // Test Image.Load
                using var image = Image.Load(gifPath);
                Console.WriteLine($"Success: Loaded {gifPath}");
                Console.WriteLine($"Dimensions: {image.Width}x{image.Height}");
                return 0;
            }
            else
            {
                // Default: identify mode
                var info = Image.Identify(gifPath);
                Console.WriteLine($"Success: Identified {gifPath}");
                Console.WriteLine($"Dimensions: {info?.Width}x{info?.Height}");
                return 0;
            }
        }
        catch (InvalidImageContentException ex)
        {
            // Expected exception after fix is applied for malformed GIFs
            Console.WriteLine($"Exception: InvalidImageContentException");
            Console.WriteLine($"Message: {ex.Message}");
            return 0;  // Return 0 for expected exception
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.GetType().Name}");
            Console.WriteLine($"Message: {ex.Message}");
            return 1;
        }
    }
}
