FROM ubuntu:22.04

WORKDIR /app

# System dependencies
RUN apt-get update && apt-get install -y \
    cmake \
    clang \
    make \
    git \
    zlib1g-dev \
    pkg-config \
    curl \
    tmux \
    asciinema \
    && rm -rf /var/lib/apt/lists/*

# Clone vulnerable version of Assimp and remove git history
RUN git clone --depth 1 --branch v5.4.0 https://github.com/assimp/assimp.git . \
    && rm -rf .git

# Copy test files
COPY task-deps/ /app/task-deps/

# Build with AddressSanitizer for vulnerability detection
RUN mkdir -p build && cd build && \
    cmake .. \
        -DCMAKE_BUILD_TYPE=Debug \
        -DCMAKE_C_COMPILER=clang \
        -DCMAKE_CXX_COMPILER=clang++ \
        -DCMAKE_C_FLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer" \
        -DCMAKE_CXX_FLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer" \
        -DASSIMP_BUILD_TESTS=OFF \
        -DASSIMP_BUILD_ASSIMP_TOOLS=ON && \
    cmake --build . --parallel $(nproc)

# Set ASAN environment variables
ENV ASAN_OPTIONS="detect_leaks=0:abort_on_error=1:symbolize=1"

# Default command - interactive shell for debugging/testing
CMD ["/bin/bash"]
