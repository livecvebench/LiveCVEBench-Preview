"""
Functional tests for LearnHouse image upload functionality.
These tests verify that the basic upload infrastructure works correctly.
"""

import pytest
import sys
import os
import tempfile
from io import BytesIO
from PIL import Image

# Add the api directory to the path for imports
sys.path.insert(0, '/app/api')


def create_simple_jpeg(color='red', width=100, height=100):
    """Create a simple JPEG image without metadata."""
    img = Image.new('RGB', (width, height), color=color)
    output = BytesIO()
    img.save(output, format='JPEG', quality=85)
    return output.getvalue()


def create_simple_png(color='blue', width=100, height=100):
    """Create a simple PNG image without metadata."""
    img = Image.new('RGBA', (width, height), color=color)
    output = BytesIO()
    img.save(output, format='PNG')
    return output.getvalue()


class TestUploadContentFunctionality:
    """Test the upload_content module can be imported and basic functions exist."""

    def test_upload_content_module_exists(self):
        """Test that the upload_content module can be imported."""
        try:
            from src.services.utils.upload_content import upload_content
            assert upload_content is not None
        except ImportError as e:
            pytest.fail(f"Could not import upload_content: {e}")

    def test_ensure_directory_exists_function(self):
        """Test that ensure_directory_exists function is available."""
        try:
            from src.services.utils.upload_content import ensure_directory_exists
            assert ensure_directory_exists is not None
        except ImportError as e:
            pytest.fail(f"Could not import ensure_directory_exists: {e}")

    def test_upload_content_is_async(self):
        """Test that upload_content is an async function."""
        import asyncio
        from src.services.utils.upload_content import upload_content
        assert asyncio.iscoroutinefunction(upload_content), \
            "upload_content should be an async function"


class TestImageCreation:
    """Test that we can create valid test images."""

    def test_jpeg_image_creation(self):
        """Test that JPEG images can be created for testing."""
        jpeg_data = create_simple_jpeg(color='green', width=200, height=150)

        # Verify it's valid JPEG
        img = Image.open(BytesIO(jpeg_data))
        assert img.format == 'JPEG'
        assert img.size == (200, 150)

    def test_png_image_creation(self):
        """Test that PNG images can be created for testing."""
        png_data = create_simple_png(color='yellow', width=150, height=100)

        # Verify it's valid PNG
        img = Image.open(BytesIO(png_data))
        assert img.format == 'PNG'
        assert img.size == (150, 100)

    def test_image_visual_content(self):
        """Test that images have correct visual content."""
        # Create a simple red image
        original_img = Image.new('RGB', (50, 50), color='red')
        output = BytesIO()
        original_img.save(output, format='JPEG', quality=95)
        jpeg_data = output.getvalue()

        # Reload and check pixel
        loaded_img = Image.open(BytesIO(jpeg_data))
        pixel = loaded_img.getpixel((25, 25))

        # Should be close to red (255, 0, 0) - allow compression tolerance
        assert pixel[0] > 200, "Red channel should be high"
        assert pixel[1] < 50, "Green channel should be low"
        assert pixel[2] < 50, "Blue channel should be low"


class TestDirectoryOperations:
    """Test directory creation functionality."""

    def test_ensure_directory_creates_path(self):
        """Test that ensure_directory_exists creates directories."""
        from src.services.utils.upload_content import ensure_directory_exists

        with tempfile.TemporaryDirectory() as tmpdir:
            test_path = os.path.join(tmpdir, "test", "nested", "dir")
            ensure_directory_exists(test_path)
            assert os.path.exists(test_path)
            assert os.path.isdir(test_path)

    def test_ensure_directory_handles_existing(self):
        """Test that ensure_directory_exists handles existing directories."""
        from src.services.utils.upload_content import ensure_directory_exists

        with tempfile.TemporaryDirectory() as tmpdir:
            # Should not raise for existing directory
            ensure_directory_exists(tmpdir)
            assert os.path.exists(tmpdir)


class TestFileWriteOperations:
    """Test basic file write operations that simulate upload."""

    def test_jpeg_file_can_be_written_and_read(self):
        """Test that JPEG files can be written and read back."""
        jpeg_data = create_simple_jpeg()

        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as f:
            f.write(jpeg_data)
            temp_path = f.name

        try:
            # Read back and verify
            with open(temp_path, 'rb') as f:
                read_data = f.read()

            assert read_data == jpeg_data

            # Verify it's still a valid image
            img = Image.open(BytesIO(read_data))
            assert img.format == 'JPEG'
        finally:
            os.unlink(temp_path)

    def test_png_file_can_be_written_and_read(self):
        """Test that PNG files can be written and read back."""
        png_data = create_simple_png()

        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f:
            f.write(png_data)
            temp_path = f.name

        try:
            # Read back and verify
            with open(temp_path, 'rb') as f:
                read_data = f.read()

            assert read_data == png_data

            # Verify it's still a valid image
            img = Image.open(BytesIO(read_data))
            assert img.format == 'PNG'
        finally:
            os.unlink(temp_path)

    def test_binary_data_preserved_exactly(self):
        """Test that binary data is preserved exactly when written."""
        # Create image with known content
        original_data = create_simple_jpeg(color='blue', width=50, height=50)

        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as f:
            f.write(original_data)
            temp_path = f.name

        try:
            with open(temp_path, 'rb') as f:
                read_data = f.read()

            # Byte-for-byte identical
            assert len(read_data) == len(original_data)
            assert read_data == original_data
        finally:
            os.unlink(temp_path)


class TestFormatDetection:
    """Test file format detection from filenames."""

    def test_jpg_extension_detected(self):
        """Test that .jpg extension is properly extracted."""
        filename = "test_image.jpg"
        file_format = filename.split(".")[-1].strip().lower()
        assert file_format == "jpg"

    def test_jpeg_extension_detected(self):
        """Test that .jpeg extension is properly extracted."""
        filename = "test_image.jpeg"
        file_format = filename.split(".")[-1].strip().lower()
        assert file_format == "jpeg"

    def test_png_extension_detected(self):
        """Test that .png extension is properly extracted."""
        filename = "test_image.png"
        file_format = filename.split(".")[-1].strip().lower()
        assert file_format == "png"

    def test_case_insensitive_extension(self):
        """Test that extension detection is case-insensitive."""
        for ext in ['JPG', 'Jpg', 'JPEG', 'Jpeg', 'PNG', 'Png']:
            filename = f"test_image.{ext}"
            file_format = filename.split(".")[-1].strip().lower()
            assert file_format == ext.lower()


class TestImageIntegrity:
    """
    Tests ensuring image integrity is maintained during file operations.
    These tests verify the image remains valid (should PASS in both states).
    """

    def test_image_still_valid_after_write(self):
        """Test that the image is still valid after being written to disk."""
        # Create a test image with data
        import piexif
        img = Image.new('RGB', (200, 200), color='red')
        exif_dict = {
            "0th": {piexif.ImageIFD.Make: "TestCamera"},
            "Exif": {},
            "GPS": {},
            "1st": {},
            "thumbnail": None
        }
        exif_bytes = piexif.dump(exif_dict)
        output = BytesIO()
        img.save(output, format='JPEG', exif=exif_bytes)
        original = output.getvalue()

        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as f:
            f.write(original)
            temp_path = f.name

        try:
            # Should be able to open the written image
            img = Image.open(temp_path)
            assert img.format == 'JPEG'
            assert img.size == (200, 200)
        finally:
            os.unlink(temp_path)

    def test_image_dimensions_preserved_after_write(self):
        """Test that image dimensions are preserved after writing to disk."""
        import piexif
        img = Image.new('RGB', (100, 100), color='blue')
        exif_dict = {
            "0th": {piexif.ImageIFD.Make: "TestCamera"},
            "Exif": {},
            "GPS": {
                piexif.GPSIFD.GPSLatitude: ((37, 1), (46, 1), (2940, 100)),
                piexif.GPSIFD.GPSLatitudeRef: "N",
            },
            "1st": {},
            "thumbnail": None
        }
        exif_bytes = piexif.dump(exif_dict)
        output = BytesIO()
        img.save(output, format='JPEG', exif=exif_bytes)
        original = output.getvalue()

        original_img = Image.open(BytesIO(original))
        original_size = original_img.size

        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as f:
            f.write(original)
            temp_path = f.name

        try:
            uploaded_img = Image.open(temp_path)
            assert uploaded_img.size == original_size, \
                "Image dimensions should be preserved"
        finally:
            os.unlink(temp_path)

    def test_image_color_mode_preserved_after_write(self):
        """Test that image color mode is preserved after writing to disk."""
        import piexif
        img = Image.new('RGB', (100, 100), color='green')
        exif_dict = {
            "0th": {piexif.ImageIFD.Make: "TestCamera"},
            "Exif": {},
            "GPS": {
                piexif.GPSIFD.GPSLatitude: ((37, 1), (46, 1), (2940, 100)),
                piexif.GPSIFD.GPSLatitudeRef: "N",
            },
            "1st": {},
            "thumbnail": None
        }
        exif_bytes = piexif.dump(exif_dict)
        output = BytesIO()
        img.save(output, format='JPEG', exif=exif_bytes)
        original = output.getvalue()

        original_img = Image.open(BytesIO(original))
        original_mode = original_img.mode

        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as f:
            f.write(original)
            temp_path = f.name

        try:
            uploaded_img = Image.open(temp_path)
            assert uploaded_img.mode == original_mode, \
                "Image color mode should be preserved"
        finally:
            os.unlink(temp_path)
