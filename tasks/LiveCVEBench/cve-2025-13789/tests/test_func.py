#!/usr/bin/env python3
"""
Functionality tests for ZenTao PMS
These tests verify that the application's core functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os
import hashlib

ZENTAO_URL = os.environ.get('ZENTAO_URL', 'http://localhost/zentao')
ZENTAO_USER = os.environ.get('ZENTAO_USER', 'admin')
ZENTAO_PASS = os.environ.get('ZENTAO_PASS', '123456')

# Increase timeout for slow startup
STARTUP_TIMEOUT = 120


def md5_hash(text):
    """Calculate MD5 hash of a string"""
    return hashlib.md5(text.encode()).hexdigest()


def zentao_login(session, base_url, username, password):
    """
    Perform ZenTao login with proper password hashing.
    ZenTao 21.7+ uses md5(md5(password) + rand) for password submission.
    """
    # First, get the login page to establish cookies
    session.get(f"{base_url}/user-login.html", timeout=10)

    # Get the random token for password hashing
    rand_resp = session.get(f"{base_url}/user-refreshRandom.html", timeout=10)
    rand = rand_resp.text.strip()

    # Hash the password: md5(md5(password) + rand)
    hashed_password = md5_hash(md5_hash(password) + rand)

    # Perform login with proper headers (ZenTao requires AJAX-style request)
    login_data = {
        'account': username,
        'password': hashed_password,
        'passwordStrength': '1',
        'referer': '/zentao/',
        'verifyRand': rand,
        'keepLogin': '1'
    }

    headers = {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': 'application/json, text/javascript, */*; q=0.01',
        'Origin': 'http://localhost',
        'Referer': f'{base_url}/user-login.html'
    }

    resp = session.post(
        f"{base_url}/user-login.html",
        data=login_data,
        headers=headers,
        allow_redirects=False,
        timeout=10
    )

    return resp


@pytest.fixture(scope='module')
def wait_for_zentao():
    """Wait for ZenTao to be ready"""
    start_time = time.time()
    while time.time() - start_time < STARTUP_TIMEOUT:
        try:
            resp = requests.get(f"{ZENTAO_URL}/", timeout=5)
            if resp.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    pytest.fail("ZenTao did not start within timeout")


@pytest.fixture(scope='module')
def authenticated_session(wait_for_zentao):
    """Create an authenticated session using ZenTao's hashed password login"""
    session = requests.Session()

    # Perform login with proper password hashing
    resp = zentao_login(session, ZENTAO_URL, ZENTAO_USER, ZENTAO_PASS)

    # ZenTao returns JSON on successful login
    try:
        json_resp = resp.json()
        if json_resp.get('result') != 'success':
            pytest.fail(f"Login failed: {json_resp.get('message', 'unknown error')}")
    except:
        pytest.fail("Login did not return valid JSON response")

    # Verify login was successful by checking if we can access protected pages
    check_resp = session.get(f"{ZENTAO_URL}/my/", timeout=10)

    # If still redirecting to login, authentication failed
    if 'login' in check_resp.url.lower() and 'logout' not in check_resp.text.lower():
        pytest.fail("Failed to login to ZenTao")

    return session


class TestZenTaoBasicFunctionality:
    """Test basic ZenTao functionality"""

    def test_homepage_accessible(self, wait_for_zentao):
        """Test that the homepage is accessible"""
        resp = requests.get(f"{ZENTAO_URL}/", timeout=10)
        assert resp.status_code == 200

    def test_login_page_accessible(self, wait_for_zentao):
        """Test that the login page loads correctly"""
        resp = requests.get(f"{ZENTAO_URL}/user-login.html", timeout=10)
        assert resp.status_code == 200
        # Should contain login form elements
        assert 'account' in resp.text.lower() or 'password' in resp.text.lower()

    def test_authentication_works(self, authenticated_session):
        """Test that we can authenticate successfully"""
        # If we got here, authentication worked
        resp = authenticated_session.get(f"{ZENTAO_URL}/my/", timeout=10)
        assert resp.status_code == 200
        # Should not redirect to login
        assert 'login' not in resp.url.lower() or 'logout' in resp.text.lower()

    def test_dashboard_accessible(self, authenticated_session):
        """Test that dashboard is accessible after login"""
        resp = authenticated_session.get(f"{ZENTAO_URL}/index.html", timeout=10)
        assert resp.status_code == 200


class TestAIModulePresence:
    """Test that the AI module exists in the application"""

    def test_ai_module_directory_exists(self, authenticated_session):
        """Test that accessing AI module doesn't cause a server error"""
        # The AI module should exist even if specific endpoints are removed
        # A 404 is acceptable (function removed), but 500 would indicate breakage
        resp = authenticated_session.get(
            f"{ZENTAO_URL}/ai-index.html",
            timeout=10
        )
        # 200 = module works, 404 = page not found (OK), 403 = permission denied (OK)
        # Only 500+ would indicate a server-side error
        assert resp.status_code < 500, f"AI module caused server error: {resp.status_code}"

    def test_application_remains_stable(self, authenticated_session):
        """Test that the application remains stable (no crashes)"""
        # Access multiple pages to ensure stability
        pages = [
            '/index.html',
            '/my/',
            '/project/',
            '/product/',
        ]

        for page in pages:
            try:
                resp = authenticated_session.get(
                    f"{ZENTAO_URL}{page}",
                    timeout=10
                )
                # Should not get 500 errors
                assert resp.status_code < 500, f"Server error on {page}"
            except requests.exceptions.RequestException as e:
                pytest.fail(f"Request failed for {page}: {e}")


class TestModuleIntegrity:
    """Test that core modules are intact"""

    def test_user_module_works(self, authenticated_session):
        """Test user module functionality"""
        resp = authenticated_session.get(
            f"{ZENTAO_URL}/user-profile.html",
            timeout=10
        )
        assert resp.status_code < 500

    def test_project_module_accessible(self, authenticated_session):
        """Test project module is accessible"""
        resp = authenticated_session.get(
            f"{ZENTAO_URL}/project-index.html",
            timeout=10
        )
        assert resp.status_code < 500


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
