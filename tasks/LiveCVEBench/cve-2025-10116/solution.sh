#!/bin/bash
# Solution script for SiempreCMS file upload path traversal vulnerability
set -e

UPLOAD_FILE="/var/www/html/SiempreCMS/docs/admin/file_upload.php"

echo "Applying fix to $UPLOAD_FILE..."

# Create the fixed version of file_upload.php
cat > "$UPLOAD_FILE" << 'FIXED_PHP'
<?php
/*
 * This file is part of Siempre CMS
 *
 * (c) 2015 Steve Morgan http://siempresolutions.co.uk/
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

require_once('../../admin-includes/admin.security_ajax.inc.php');

header('Content-type: application/json');

$valid_exts = array('jpeg', 'jpg', 'png', 'gif', 'doc', 'docx', 'pdf'); // valid extensions
$max_size = 1600 * 1024; // max file size (1600kb)

// SECURITY FIX: Get the absolute path to the allowed media directory
$allowed_base = realpath(__DIR__ . '/../media');
if ($allowed_base === false) {
    $status = 'Server configuration error!';
    echo json_encode(array('status' => $status));
    exit();
}

$path = $allowed_base . '/'; // default to media directory

// SECURITY FIX: Validate folder-path with proper path canonicalization
if (isset($_POST['folder-path'])) {
    // Calculate what path the user is requesting relative to the admin directory
    $requested_input = $_POST['folder-path'];

    // First check basic prefix for backwards compatibility
    if (substr($requested_input, 0, 9) !== '../media/') {
        $status = 'Bad request in folder path!';
        echo json_encode(array('status' => $status));
        exit();
    }

    // Resolve the full path - use __DIR__ which is docs/admin/
    $resolved_path = realpath(__DIR__ . '/' . $requested_input);

    // If path doesn't exist, try creating the directory structure within media only
    if ($resolved_path === false) {
        // Try to get the parent directory
        $parent_path = dirname(__DIR__ . '/' . $requested_input);
        $resolved_parent = realpath($parent_path);

        if ($resolved_parent === false || strpos($resolved_parent, $allowed_base) !== 0) {
            $status = 'Bad request in folder path!';
            echo json_encode(array('status' => $status));
            exit();
        }
        // Use the resolved parent path
        $path = $resolved_parent . '/';
    } else {
        // SECURITY FIX: Verify the resolved path is within the allowed media directory
        if (strpos($resolved_path, $allowed_base) !== 0) {
            $status = 'Bad request in folder path!';
            echo json_encode(array('status' => $status));
            exit();
        }
        $path = $resolved_path . '/';
    }
} else {
    $status = 'Bad request in folder path!';
    echo json_encode(array('status' => $status));
    exit();
}


if ( $_SERVER['REQUEST_METHOD'] === 'POST' )
{
  if( @is_uploaded_file($_FILES['image']['tmp_name']) )
  {
    // get uploaded file extension
    $ext = strtolower(pathinfo($_FILES['image']['name'], PATHINFO_EXTENSION));
    // looking for format and size validity
    if (in_array($ext, $valid_exts) AND $_FILES['image']['size'] < $max_size)
    {
      // Use original filename (keeping original behavior for file naming)
      // Additional security: sanitize filename to remove path components
      $filename = basename($_FILES['image']['name']);
      $full_path = $path . $filename;

      // move uploaded file from temp to uploads directory
      if (move_uploaded_file($_FILES['image']['tmp_name'], $full_path))
      {
        $status = 'Image successfully uploaded!';
      }
      else {
        $status = 'Upload Fail: Unknown error occurred!';
      }
    }
    else {
      $status = 'Upload Fail: Unsupported file format or It is too large to upload!';
    }
  }
  else {
    $status = 'Upload Fail: File not uploaded!';
  }
}
else {
  $status = 'Bad request!';
}

// echo out json encoded status
echo json_encode(array('status' => $status));
?>
FIXED_PHP

echo "Fix applied successfully!"
echo "Changes made:"
echo "  1. Added realpath() validation to verify paths stay within media directory"
echo "  2. Added path canonicalization to prevent directory traversal"
echo "  3. Added basename() sanitization for uploaded filenames"
