#!/bin/bash
set -e

# Wait for database to be ready
echo "Waiting for database..."
max_retries=30
retry_count=0
until mysqladmin ping -h"$WORDPRESS_DB_HOST" --silent 2>/dev/null; do
    retry_count=$((retry_count + 1))
    if [ $retry_count -ge $max_retries ]; then
        echo "Database not ready after $max_retries attempts. Proceeding anyway..."
        break
    fi
    echo "Waiting for database... ($retry_count/$max_retries)"
    sleep 2
done

# Run the original WordPress entrypoint to set up WordPress files
docker-entrypoint.sh apache2 -v > /dev/null 2>&1 || true

# Wait a moment for WordPress to initialize
sleep 2

# Check if WordPress is installed
if ! wp core is-installed --allow-root 2>/dev/null; then
    echo "Installing WordPress..."
    wp core install \
        --url="http://localhost" \
        --title="CVE-2025-8891 Test Site" \
        --admin_user="admin" \
        --admin_password="admin" \
        --admin_email="admin@localhost.local" \
        --skip-email \
        --allow-root
fi

# Ensure OceanWP theme is in place and activated
if [ -d "/var/www/html/wp-content/themes/oceanwp" ]; then
    echo "Activating OceanWP theme..."
    wp theme activate oceanwp --allow-root 2>/dev/null || true
else
    echo "ERROR: OceanWP theme not found!"
fi

# Ensure proper permissions
chown -R www-data:www-data /var/www/html/wp-content

echo "WordPress setup complete. Starting Apache..."
exec apache2-foreground
