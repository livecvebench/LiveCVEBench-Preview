#!/bin/bash
# Solution script for ImageMagick InterpretImageFilename buffer overflow fix (CVE-2025-53101)
# Applies the fix to MagickCore/image.c manually using sed

set -e

IMAGEMAGICK_DIR="/app"
FILE="$IMAGEMAGICK_DIR/MagickCore/image.c"

echo "=== Applying ImageMagick InterpretImageFilename Fix ==="
echo ""

# Change to ImageMagick source directory
cd "$IMAGEMAGICK_DIR"

# Verify the target file exists
if [ ! -f "$FILE" ]; then
    echo "ERROR: $FILE not found"
    exit 1
fi

# Create a backup
cp "$FILE" "${FILE}.bak"

echo "Patching $FILE..."

# Check if fix is already applied (look for the new "count" variable pattern in the fix)
if grep -q 'count=FormatLocaleString(filename+(p-format-offset)' "$FILE"; then
    echo "Fix already applied, skipping patch..."
else
    # Step 1: Remove field_width from the variable declaration block
    # Change:  field_width,
    #   offset;
    # To:      offset;
    sed -i '/^[[:space:]]*field_width,$/d' "$FILE"

    # Step 2: Remove field_width=0; line
    sed -i '/^[[:space:]]*field_width=0;$/d' "$FILE"

    # Step 3: Remove the if (*q == '0') field_width=... lines
    # These are two lines that need to be removed
    sed -i '/if (\*q == '"'"'0'"'"')$/d' "$FILE"
    sed -i '/field_width=(ssize_t) strtol(q,\&q,10);$/d' "$FILE"

    # Step 4: Change (void) FormatLocaleString to count=FormatLocaleString
    # and add the ssize_t count declaration and bounds check

    # First, add "ssize_t count;" declaration after "case 'x':" / opening brace
    # Find the line with "(void) FormatLocaleString(filename+(p-format-offset)" and transform the block

    # Use a more complex sed to transform the case block
    # Original pattern (across multiple lines):
    #   case 'd':
    #   case 'o':
    #   case 'x':
    #   {
    #     q++;
    #     c=(*q);
    #     *q='\0';
    #     (void) FormatLocaleString(filename+(p-format-offset),(size_t)
    #       (MagickPathExtent-(p-format-offset)),p,value);
    #     offset+=(4-field_width);
    #     *q=c;

    # Target pattern:
    #   case 'd':
    #   case 'o':
    #   case 'x':
    #   {
    #     ssize_t
    #       count;
    #
    #     q++;
    #     c=(*q);
    #     *q='\0';
    #     count=FormatLocaleString(filename+(p-format-offset),(size_t)
    #       (MagickPathExtent-(p-format-offset)),p,value);
    #     if ((count <= 0) || (count > (MagickPathExtent-(p-format-offset))))
    #       return(0);
    #     offset+=(ssize_t) ((q-p)-count);
    #     *q=(char) c;

    # Apply changes using sed with line addresses
    # Find the line number of "(void) FormatLocaleString(filename+(p-format-offset)"
    LINE_NUM=$(grep -n '(void) FormatLocaleString(filename+(p-format-offset)' "$FILE" | head -1 | cut -d: -f1)

    if [ -z "$LINE_NUM" ]; then
        echo "ERROR: Could not find FormatLocaleString pattern to patch"
        exit 1
    fi

    echo "Found FormatLocaleString at line $LINE_NUM"

    # Replace "(void) FormatLocaleString" with "count=FormatLocaleString"
    sed -i "${LINE_NUM}s/(void) FormatLocaleString/count=FormatLocaleString/" "$FILE"

    # Find the line with "offset+=(4-field_width);" and replace it with the new code
    OFFSET_LINE=$(grep -n 'offset+=(4-field_width);' "$FILE" | head -1 | cut -d: -f1)

    if [ -z "$OFFSET_LINE" ]; then
        echo "ERROR: Could not find offset+=(4-field_width) pattern to patch"
        exit 1
    fi

    echo "Found offset calculation at line $OFFSET_LINE"

    # Replace the offset line with bounds check and new offset calculation
    sed -i "${OFFSET_LINE}s/offset+=(4-field_width);/if ((count <= 0) || (count > (MagickPathExtent-(p-format-offset))))\n          return(0);\n        offset+=(ssize_t) ((q-p)-count);/" "$FILE"

    # Find "*q=c;" and change to "*q=(char) c;"
    QC_LINE=$(grep -n '\*q=c;' "$FILE" | grep -v '\*q=(char) c;' | head -1 | cut -d: -f1)
    if [ -n "$QC_LINE" ]; then
        sed -i "${QC_LINE}s/\*q=c;/*q=(char) c;/" "$FILE"
    fi

    # Now add the "ssize_t count;" declaration after the opening brace of the case block
    # Find the line with "case 'x':" and add declaration after the next "{"
    CASE_X_LINE=$(grep -n "case 'x':" "$FILE" | head -1 | cut -d: -f1)
    if [ -n "$CASE_X_LINE" ]; then
        # Find the next line with { after case 'x':
        BRACE_LINE=$((CASE_X_LINE + 1))
        # Insert the declaration after the brace
        sed -i "${BRACE_LINE}a\\        ssize_t\n          count;\n" "$FILE"
    fi

    echo "Patch applied."
fi

echo ""

# Rebuild ImageMagick
echo "Rebuilding ImageMagick..."
make -j$(nproc)

echo ""
echo "Installing rebuilt ImageMagick..."
make install
ldconfig 2>/dev/null || true

echo ""
echo "=== Fix applied successfully ==="
echo ""

# Verify the fix
echo "Verifying fix..."
set +e
output=$(timeout 5 magick mogrify %d%d 2>&1)
exit_code=$?
set -e

echo "Command output: $output"
echo "Exit code: $exit_code"

# Check for crash codes or ASAN errors
if [ $exit_code -eq 139 ] || [ $exit_code -eq 134 ] || [ $exit_code -eq 11 ] || [ $exit_code -eq 6 ]; then
    echo "ERROR: Still crashing after fix (exit code: $exit_code)"
    exit 1
fi

if echo "$output" | grep -q "AddressSanitizer.*stack-buffer-overflow"; then
    echo "ERROR: ASAN detected stack buffer overflow - vulnerability still present"
    exit 1
fi

echo "Fix verified successfully - no crash detected"
echo ""
echo "Fix complete."
