<?php
// Minimal function.php for CVE reproduction
// Original function.php is obfuscated with licensing checks that prevent execution
// This provides the necessary functions for the vulnerable application to run

error_reporting(E_ALL^E_NOTICE);

$webconfig = array(
    'system_title' => '先启幼儿园在线管理系统',
    'system_wanglai' => '幼儿',
    'system_yuangong' => '教职工',
    'system_xiangmu' => '班级',
    'order_interval' => 604800,
    'login_code_open' => '0',
    'system_check' => '1',
    'backrestore_ext' => '.sql',
    'login_sms_open' => '0',
    'eptime_pagesize' => '10',
    'system_name' => '幼儿园管理系统',
    'index_pic' => 'style/images/login-bg.jpg'
);

class LYG {
    public static function ShowMsg($msg, $url = "") {
        header("Content-Type: text/html; charset=utf-8");
        if ($url == "") {
            echo "<script type='text/javascript'>alert('{$msg}');history.go(-1);</script>";
        } elseif ($url == "close") {
            echo "<script type='text/javascript'>alert('{$msg}');window.opener.location.reload();self.close();</script>";
        } else {
            echo "<script type='text/javascript'>alert('{$msg}');location.href='{$url}';</script>";
        }
        exit;
    }

    public static function Jump($url) {
        header("Content-Type: text/html; charset=utf-8");
        echo "<script type='text/javascript'>location.href='{$url}';</script>";
        exit;
    }

    public static function checklogin() {
        if (!isset($_SESSION['eptime_id']) || !isset($_SESSION['eptime_flag'])) {
            echo "<script type='text/javascript'>top.location.href='index.php';</script>";
            exit;
        }
    }

    public static function checkloginm() {
        if (!isset($_SESSION['eptime_id']) || !isset($_SESSION['eptime_flag'])) {
            echo json_encode(array('code'=>-1,'msg'=>'请先登录'));
            exit;
        }
    }

    public static function getTotalPage($total, $pagesize = 10) {
        if ($total < 1) {
            return 0;
        }
        if ($total % $pagesize == 0) {
            return $total / $pagesize;
        } else {
            return floor($total / $pagesize) + 1;
        }
    }

    public static function getPageHtml($page, $total, $pagesize = 10, $params = "") {
        if ($total <= $pagesize) {
            return "<div class='pages'><a class='thispage'>共{$total}条记录</a><a>，每页{$pagesize}条</a></div>";
        }
        $totalpage = self::getTotalPage($total, $pagesize);
        $html = "<div class='pages'><a class='thispage'>共{$total}条记录</a>";

        $start = max(1, $page - 3);
        $end = min($totalpage, $page + 3);

        for ($i = $start; $i < $page; $i++) {
            $p = is_array($params) ? $params : array();
            $p[] = "p=$i";
            $qs = implode('&', $p);
            $html .= "<a href='?{$qs}'>{$i}</a>";
        }

        $html .= "<a class='thispage'>{$page}</a>";

        for ($i = $page + 1; $i <= $end; $i++) {
            $p = is_array($params) ? $params : array();
            $p[] = "p=$i";
            $qs = implode('&', $p);
            $html .= "<a href='?{$qs}'>{$i}</a>";
        }

        $html .= "<a>共{$totalpage}页，每页{$pagesize}条</a></div>";
        return $html;
    }

    public static function readArr($name) {
        $path = APP_PATH . "/config/cfg_{$name}.php";
        if (!file_exists($path)) {
            return array();
        }
        return include $path;
    }

    public static function writeArr($name, $data) {
        $path = APP_PATH . "/config/cfg_{$name}.php";
        $content = "<?php\nreturn " . var_export($data, true) . ";";
        file_put_contents($path, $content);
    }

    public static function writeLog($msg) {
        // Simplified logging - just ignore for CVE reproduction
        return true;
    }

    public static function getIP() {
        if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            return $_SERVER['HTTP_X_FORWARDED_FOR'];
        } elseif (isset($_SERVER['HTTP_CLIENT_IP'])) {
            return $_SERVER['HTTP_CLIENT_IP'];
        } else {
            return $_SERVER['REMOTE_ADDR'];
        }
    }
}

// Common arrays needed by the application
$c_sex = array('男' => '男', '女' => '女');
$c_nation = array(
    '汉族' => '汉族', '蒙古族' => '蒙古族', '回族' => '回族', '藏族' => '藏族',
    '维吾尔族' => '维吾尔族', '苗族' => '苗族', '彝族' => '彝族', '壮族' => '壮族',
    '布依族' => '布依族', '朝鲜族' => '朝鲜族', '满族' => '满族', '侗族' => '侗族',
    '瑶族' => '瑶族', '白族' => '白族', '土家族' => '土家族', '哈尼族' => '哈尼族',
    '哈萨克族' => '哈萨克族', '傣族' => '傣族', '黎族' => '黎族', '傈僳族' => '傈僳族',
    '佤族' => '佤族', '畲族' => '畲族', '高山族' => '高山族', '拉祜族' => '拉祜族',
    '水族' => '水族', '东乡族' => '东乡族', '纳西族' => '纳西族', '景颇族' => '景颇族',
    '柯尔克孜族' => '柯尔克孜族', '土族' => '土族', '达斡尔族' => '达斡尔族',
    '仫佬族' => '仫佬族', '羌族' => '羌族', '布朗族' => '布朗族', '撒拉族' => '撒拉族',
    '毛南族' => '毛南族', '仡佬族' => '仡佬族', '锡伯族' => '锡伯族', '阿昌族' => '阿昌族',
    '普米族' => '普米族', '塔吉克族' => '塔吉克族', '怒族' => '怒族', '乌孜别克族' => '乌孜别克族',
    '俄罗斯族' => '俄罗斯族', '鄂温克族' => '鄂温克族', '德昂族' => '德昂族',
    '保安族' => '保安族', '裕固族' => '裕固族', '京族' => '京族', '塔塔尔族' => '塔塔尔族',
    '独龙族' => '独龙族', '鄂伦春族' => '鄂伦春族', '赫哲族' => '赫哲族',
    '门巴族' => '门巴族', '珞巴族' => '珞巴族', '基诺族' => '基诺族'
);

$c_stuok = array(
    1 => '在读',
    2 => '升班',
    3 => '转出',
    4 => '毕业',
    5 => '退园'
);

$c_isok = array(
    0 => '禁用',
    1 => '启用'
);

function c_classinfo($table) {
    global $con;
    return $con->select("select id,name from #__{$table} where isok=1");
}

function c_classname($table, $id) {
    global $con;
    $row = $con->find("select name from #__{$table} where id={$id}");
    return $row ? $row['name'] : '';
}

function c_adminpwd($pwd) {
    return md5("webxyj2014" . $pwd . "xianqiyuanyi");
}
