FROM php:7.4-apache

WORKDIR /var/www/html

# System dependencies
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    default-mysql-client \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install mysqli pdo pdo_mysql

# Enable output_buffering to fix session_start issues in CMS
RUN echo "output_buffering = 4096" >> /usr/local/etc/php/php.ini

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Clone SiempreCMS at vulnerable version
RUN git clone --branch v1.3.6 --depth 1 https://github.com/SiempreCMS/SiempreCMS.git /var/www/html/SiempreCMS \
    && rm -rf /var/www/html/SiempreCMS/.git

# Set up the admin configuration file for Docker
COPY task-deps/admin.config.docker.inc.php /var/www/html/SiempreCMS/admin-includes/admin.config.inc.php

# Create media directories and set permissions
RUN mkdir -p /var/www/html/SiempreCMS/docs/media/images \
    && mkdir -p /var/www/html/SiempreCMS/docs/media/documents \
    && chmod -R 777 /var/www/html/SiempreCMS/docs/media/ \
    && chmod -R 777 /var/www/html/SiempreCMS/cache/ \
    && chmod -R 777 /var/www/html/SiempreCMS/modules/ \
    && chown -R www-data:www-data /var/www/html/SiempreCMS/

# Configure Apache to allow .htaccess overrides
COPY task-deps/siemprecms.conf /etc/apache2/conf-available/siemprecms.conf
RUN a2enconf siemprecms

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 80

# ENTRYPOINT ["/entrypoint.sh"]
# CMD ["apache2-foreground"]
