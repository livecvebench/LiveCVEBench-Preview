#!/bin/bash

echo "[INFO] Applying FORCE FIX for CVE-2025-55741..."

python3 -c "
import os
import sys

target_file = '/app/packages/Webkul/Admin/src/Http/Controllers/Catalog/ProductController.php'

if not os.path.exists(target_file):
    print(f'[ERROR] File not found: {target_file}')
    sys.exit(1)

with open(target_file, 'r') as f:
    content = f.read()

# 1. 定位 massDestroy 函数
func_name = 'function massDestroy'
start_idx = content.find(func_name)

if start_idx == -1:
    print(f'[ERROR] Could not find {func_name}')
    sys.exit(1)

# 2. 定位函数开始的大括号 {
brace_idx = content.find('{', start_idx)
if brace_idx == -1:
    print('[ERROR] Could not find opening brace {')
    sys.exit(1)

# 3. 【关键修改】只检查大括号后面有没有修过，而不是检查全文
# 读取大括号后的一小段代码来判断
check_window = content[brace_idx:brace_idx+150]

if 'bouncer()->hasPermission' in check_window:
    print('[INFO] Patch is ALREADY applied inside massDestroy. No changes made.')
else:
    print('[INFO] Patching massDestroy...')
    # 4. 执行注入
    patch_code = \"\\n        if (! bouncer()->hasPermission('catalog.products.delete')) { abort(403); }\"
    new_content = content[:brace_idx+1] + patch_code + content[brace_idx+1:]
    
    with open(target_file, 'w') as f:
        f.write(new_content)
    print('[SUCCESS] Code injected!')
"

echo "---------------------------------------------------"
echo "[VERIFICATION] Checking massDestroy content:"
grep -A 5 "function massDestroy" "/app/packages/Webkul/Admin/src/Http/Controllers/Catalog/ProductController.php"
echo "---------------------------------------------------"

php artisan config:clear
php artisan route:clear