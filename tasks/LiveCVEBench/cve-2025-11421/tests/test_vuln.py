"""
Vulnerability tests for the Voting System XSS vulnerability (CVE-2025-11421).

These tests verify that XSS payloads are properly sanitized:
- FAIL in vulnerable state (XSS payload appears unencoded)
- PASS in fixed state (XSS payload is properly HTML-encoded)

NOTE: Payloads avoid single quotes and special characters that might break SQL queries.
"""

import pytest
import requests
import html
import json

# Application configuration
BASE_URL = "http://localhost:80/votesystem"
ADMIN_URL = f"{BASE_URL}/admin"
LOGIN_URL = f"{ADMIN_URL}/login.php"
CANDIDATES_URL = f"{ADMIN_URL}/candidates.php"
CANDIDATES_EDIT_URL = f"{ADMIN_URL}/candidates_edit.php"
CANDIDATES_ADD_URL = f"{ADMIN_URL}/candidates_add.php"
CANDIDATES_ROW_URL = f"{ADMIN_URL}/candidates_row.php"

# Default admin credentials
ADMIN_USERNAME = "codeprojects"
ADMIN_PASSWORD = "password"


def get_admin_session():
    """Create an authenticated admin session."""
    session = requests.Session()
    response = session.post(LOGIN_URL, data={
        "login": "1",
        "username": ADMIN_USERNAME,
        "password": ADMIN_PASSWORD
    }, allow_redirects=True)
    return session


class TestXSSInFirstname:
    """Test XSS vulnerability in the firstname field."""

    @pytest.fixture
    def admin_session(self):
        return get_admin_session()

    def test_basic_script_tag_xss(self, admin_session):
        """Test that basic script tag XSS in firstname is properly encoded."""
        payload = "<script>alert(1)</script>"

        edit_data = {
            "edit": "1",
            "id": "18",
            "firstname": payload,
            "lastname": "TestLastname",
            "position": "9",
            "platform": "Normal platform text"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: unencoded script tag found in response"

    def test_img_onerror_xss(self, admin_session):
        """Test img onerror XSS payload in firstname is properly encoded."""
        payload = "<img src=x onerror=alert(2)>"

        edit_data = {
            "edit": "1",
            "id": "18",
            "firstname": payload,
            "lastname": "TestLastname",
            "position": "9",
            "platform": "Normal platform text"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: unencoded img onerror found in response"

    def test_svg_onload_xss(self, admin_session):
        """Test SVG onload XSS payload in firstname is properly encoded."""
        payload = "<svg onload=alert(3)>"

        edit_data = {
            "edit": "1",
            "id": "18",
            "firstname": payload,
            "lastname": "TestLastname",
            "position": "9",
            "platform": "Normal platform text"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: unencoded svg onload found in response"

    def test_body_onload_xss(self, admin_session):
        """Test body onload event handler XSS in firstname."""
        payload = "<body onload=alert(4)>"

        edit_data = {
            "edit": "1",
            "id": "18",
            "firstname": payload,
            "lastname": "TestLastname",
            "position": "9",
            "platform": "Normal platform text"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: unencoded body onload found in response"


class TestXSSInLastname:
    """Test XSS vulnerability in the lastname field."""

    @pytest.fixture
    def admin_session(self):
        return get_admin_session()

    def test_basic_script_tag_xss(self, admin_session):
        """Test that basic script tag XSS in lastname is properly encoded."""
        payload = "<script>alert(5)</script>"

        edit_data = {
            "edit": "1",
            "id": "19",
            "firstname": "SafeFirstname",
            "lastname": payload,
            "position": "9",
            "platform": "Normal platform text"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: unencoded script tag in lastname"

    def test_img_xss_lastname(self, admin_session):
        """Test img-based XSS payload in lastname."""
        payload = "<img src=x onerror=alert(6)>"

        edit_data = {
            "edit": "1",
            "id": "19",
            "firstname": "SafeFirstname",
            "lastname": payload,
            "position": "9",
            "platform": "Normal platform text"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: unencoded img found in response"

    def test_svg_xss_lastname(self, admin_session):
        """Test svg event handler XSS in lastname."""
        payload = "<svg onload=alert(7)>"

        edit_data = {
            "edit": "1",
            "id": "19",
            "firstname": "SafeFirstname",
            "lastname": payload,
            "position": "9",
            "platform": "Normal platform text"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: unencoded svg found in response"


class TestXSSInPlatform:
    """Test XSS vulnerability in the platform field."""

    @pytest.fixture
    def admin_session(self):
        return get_admin_session()

    def test_basic_script_tag_xss_platform(self, admin_session):
        """Test that script tag XSS in platform is properly encoded."""
        payload = "<script>alert(8)</script>"

        edit_data = {
            "edit": "1",
            "id": "20",
            "firstname": "SafeFirstname",
            "lastname": "SafeLastname",
            "position": "9",
            "platform": payload
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        # Check AJAX endpoint which returns platform data
        response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "20"})

        try:
            data = response.json()
            # If platform contains raw script, it's vulnerable
            assert payload not in str(data.get("platform", "")), \
                f"XSS vulnerability detected: platform contains unencoded script tag"
        except json.JSONDecodeError:
            pass

    def test_img_xss_platform(self, admin_session):
        """Test img onclick event handler XSS in platform."""
        payload = "<img src=x onerror=alert(9)>"

        edit_data = {
            "edit": "1",
            "id": "20",
            "firstname": "SafeFirstname",
            "lastname": "SafeLastname",
            "position": "9",
            "platform": payload
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "20"})

        try:
            data = response.json()
            assert payload not in str(data.get("platform", "")), \
                f"XSS vulnerability detected: platform contains unencoded img tag"
        except json.JSONDecodeError:
            pass

    def test_svg_xss_platform(self, admin_session):
        """Test svg event handler XSS in platform."""
        payload = "<svg onload=alert(10)>"

        edit_data = {
            "edit": "1",
            "id": "20",
            "firstname": "SafeFirstname",
            "lastname": "SafeLastname",
            "position": "9",
            "platform": payload
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "20"})

        try:
            data = response.json()
            assert payload not in str(data.get("platform", "")), \
                f"XSS vulnerability detected: platform contains unencoded svg tag"
        except json.JSONDecodeError:
            pass


class TestXSSWithVariousEncodings:
    """Test XSS with various encoding bypass attempts."""

    @pytest.fixture
    def admin_session(self):
        return get_admin_session()

    def test_uppercase_script_tag(self, admin_session):
        """Test uppercase script tag XSS payload."""
        payload = "<SCRIPT>alert(11)</SCRIPT>"

        edit_data = {
            "edit": "1",
            "id": "21",
            "firstname": payload,
            "lastname": "Test",
            "position": "9",
            "platform": "Normal"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: uppercase script tag not encoded"

    def test_mixed_case_img_tag(self, admin_session):
        """Test mixed case img tag XSS payload."""
        payload = "<ImG sRc=x oNeRrOr=alert(12)>"

        edit_data = {
            "edit": "1",
            "id": "21",
            "firstname": payload,
            "lastname": "Test",
            "position": "9",
            "platform": "Normal"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: mixed case img tag not encoded"

    def test_marquee_tag(self, admin_session):
        """Test marquee tag with event handler."""
        payload = "<marquee onstart=alert(13)>"

        edit_data = {
            "edit": "1",
            "id": "21",
            "firstname": payload,
            "lastname": "Test",
            "position": "9",
            "platform": "Normal"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: marquee tag not encoded"


class TestXSSInMultipleFieldsCombined:
    """Test XSS payloads in multiple fields simultaneously."""

    @pytest.fixture
    def admin_session(self):
        return get_admin_session()

    def test_xss_in_both_firstname_and_lastname(self, admin_session):
        """Test XSS payloads in both name fields at once."""
        firstname_payload = "<script>alert(14)</script>"
        lastname_payload = "<img src=x onerror=alert(15)>"

        edit_data = {
            "edit": "1",
            "id": "22",
            "firstname": firstname_payload,
            "lastname": lastname_payload,
            "position": "9",
            "platform": "Normal platform"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert firstname_payload not in response.text, \
            f"XSS vulnerability detected: firstname script tag unencoded"
        assert lastname_payload not in response.text, \
            f"XSS vulnerability detected: lastname img onerror unencoded"

    def test_xss_in_all_vulnerable_fields(self, admin_session):
        """Test XSS payloads in all three vulnerable fields."""
        firstname_payload = "<script>alert(16)</script>"
        lastname_payload = "<svg onload=alert(17)>"
        platform_payload = "<body onload=alert(18)>"

        edit_data = {
            "edit": "1",
            "id": "23",
            "firstname": firstname_payload,
            "lastname": lastname_payload,
            "position": "9",
            "platform": platform_payload
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert firstname_payload not in response.text, \
            f"XSS vulnerability detected: firstname unencoded"
        assert lastname_payload not in response.text, \
            f"XSS vulnerability detected: lastname unencoded"


class TestXSSJavaScriptContext:
    """Test XSS in JavaScript context via AJAX endpoint."""

    @pytest.fixture
    def admin_session(self):
        return get_admin_session()

    def test_javascript_injection_via_fullname(self, admin_session):
        """Test JavaScript injection in fullname displayed via .html()."""
        # Simple b tag with onmouseover - avoids single quotes
        firstname_payload = "<b onmouseover=alert(19)>test"

        edit_data = {
            "edit": "1",
            "id": "24",
            "firstname": firstname_payload,
            "lastname": "User",
            "position": "9",
            "platform": "Normal"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert firstname_payload not in response.text, \
            f"XSS vulnerability detected: event handler in fullname not encoded"

    def test_script_tag_in_platform(self, admin_session):
        """Test script tag in platform field."""
        payload = "<script>alert(20)</script>"

        edit_data = {
            "edit": "1",
            "id": "24",
            "firstname": "Safe",
            "lastname": "User",
            "position": "9",
            "platform": payload
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "24"})

        try:
            data = response.json()
            assert payload not in str(data.get("platform", "")), \
                f"XSS vulnerability detected: script tag in platform not encoded"
        except json.JSONDecodeError:
            pass


class TestXSSEdgeCases:
    """Test edge cases and unusual XSS payloads."""

    @pytest.fixture
    def admin_session(self):
        return get_admin_session()

    def test_button_xss(self, admin_session):
        """Test button with onclick handler."""
        payload = "<button onclick=alert(21)>"

        edit_data = {
            "edit": "1",
            "id": "25",
            "firstname": payload,
            "lastname": "Test",
            "position": "8",  # Use correct position for candidate 25
            "platform": "Normal"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: button tag not encoded"

    def test_select_xss(self, admin_session):
        """Test select with onchange handler."""
        payload = "<select onchange=alert(22)>"

        edit_data = {
            "edit": "1",
            "id": "26",
            "firstname": payload,
            "lastname": "Test",
            "position": "8",  # Use correct position for candidate 26
            "platform": "Normal"
        }

        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        response = admin_session.get(CANDIDATES_URL)

        assert payload not in response.text, \
            f"XSS vulnerability detected: select tag not encoded"
