# Docker environment for CVE-2025-21622 (ClipBucket V5 path traversal vulnerability)
FROM debian:stable-slim

# Proxy settings for network operations
# ENV http_proxy=http://oversea-squid5.sgp.txyun:11080
# ENV https_proxy=http://oversea-squid5.sgp.txyun:11080

# Environment variables for runtime
ENV DOMAIN_NAME=clipbucket.local
ENV MYSQL_PASSWORD=clipbucket_password
ENV UID=1000
ENV GID=1000

WORKDIR /app

# Add repository for newer PHP versions and install packages
RUN apt-get update && \
    apt-get install -y wget apt-transport-https lsb-release ca-certificates && \
    wget -O /etc/apt/trusted.gpg.d/php.gpg https://packages.sury.org/php/apt.gpg && \
    echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/php.list && \
    apt-get update && \
    apt-get dist-upgrade -y && \
    apt-get install -y \
        nginx-full \
        mariadb-server \
        php8.2-fpm \
        php8.2-curl \
        php8.2-mysqli \
        php8.2-xml \
        php8.2-mbstring \
        php8.2-gd \
        php8.2-common \
        git \
        ffmpeg \
        mediainfo \
        sendmail \
        tmux \
        asciinema \
        curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Get source code and remove git history to prevent solution leakage
RUN git clone https://github.com/MacWarrior/clipbucket-v5.git . && \
    rm -rf .git

# Copy vulnerable version of user.class.php
COPY task-deps/user.class.php.vulnerable upload/includes/classes/user.class.php

# Copy required constants.php for DirPath class
COPY task-deps/constants.php upload/includes/constants.php

# PHP configuration adjustments
RUN sed -i "s/max_execution_time = 30/max_execution_time = 300/g" /etc/php/8.2/fpm/php.ini && \
    sed -i "s/upload_max_filesize = 2M/upload_max_filesize = 100M/g" /etc/php/8.2/fpm/php.ini && \
    sed -i "s/post_max_size = 8M/post_max_size = 100M/g" /etc/php/8.2/fpm/php.ini

# Create containeruser and adjust nginx/php-fpm to use it
RUN groupadd -g $GID containeruser && \
    useradd -u $UID -g $GID -m containeruser && \
    sed -i 's/^user www-data;/user containeruser;/g' /etc/nginx/nginx.conf && \
    sed -i 's/^user = www-data$/user = containeruser/' /etc/php/8.2/fpm/pool.d/www.conf && \
    sed -i 's/^group = www-data$/group = containeruser/' /etc/php/8.2/fpm/pool.d/www.conf

# Configure Nginx
RUN rm -f /etc/nginx/sites-enabled/default && \
    echo 'server { \
        listen 80; \
        server_name localhost; \
        root /app/upload; \
        index index.php; \
        client_max_body_size 100M; \
        \
        location ~* \.php$ { \
            fastcgi_pass unix:/run/php/php8.2-fpm.sock; \
            fastcgi_index index.php; \
            fastcgi_split_path_info ^(.+\.php)(.*)$; \
            include fastcgi_params; \
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; \
        } \
        \
        # Block sensitive directories \
        location ~ ^(.*/)?.(git|github|idea|gitignore|htaccess) { \
            return 403; \
        } \
        location ~* ^(.*/)?(includes|changelog)/ { \
            return 403; \
        } \
        \
        # Direct access to files \
        location ~* ^(.*/)?files/ { \
            try_files $uri $uri/ =404; \
        } \
        \
        # Static files \
        location ~* \.(css|js|jpe?g|png|gif|webp|svg|ico|woff2?|ttf|eot|otf|mp4|webm|ogg|mp3)$ { \
            access_log off; \
            expires max; \
            try_files $uri =404; \
        } \
    }' > /etc/nginx/sites-available/clipbucket && \
    ln -s /etc/nginx/sites-available/clipbucket /etc/nginx/sites-enabled/

# Create required directories and set proper permissions
RUN mkdir -p upload/files/avatars upload/files/photos upload/files/videos upload/files/temp && \
    chown -R containeruser:containeruser upload/files && \
    chmod -R 755 upload/files

# Create basic database configuration
RUN echo '<?php \
define("DB_HOST", "localhost"); \
define("DB_NAME", "clipbucket"); \
define("DB_USER", "clipbucket"); \
define("DB_PASS", "clipbucket_password"); \
define("DB_PREFIX", "cb_"); \
?>' > upload/includes/config.inc.php

# Create simple startup script
RUN echo '#!/bin/bash' > /usr/local/bin/startup.sh && \
    echo 'set -e' >> /usr/local/bin/startup.sh && \
    echo '' >> /usr/local/bin/startup.sh && \
    echo '# Start MariaDB' >> /usr/local/bin/startup.sh && \
    echo 'service mariadb start' >> /usr/local/bin/startup.sh && \
    echo '' >> /usr/local/bin/startup.sh && \
    echo '# Wait for MariaDB to be ready' >> /usr/local/bin/startup.sh && \
    echo 'while ! mysqladmin ping --silent; do' >> /usr/local/bin/startup.sh && \
    echo '    sleep 1' >> /usr/local/bin/startup.sh && \
    echo 'done' >> /usr/local/bin/startup.sh && \
    echo '' >> /usr/local/bin/startup.sh && \
    echo '# Create database and user if not exists' >> /usr/local/bin/startup.sh && \
    echo 'mysql -e "CREATE DATABASE IF NOT EXISTS clipbucket;"' >> /usr/local/bin/startup.sh && \
    echo 'mysql -e "CREATE USER IF NOT EXISTS '\''clipbucket'\''@'\''localhost'\'' IDENTIFIED BY '\''clipbucket_password'\'';"' >> /usr/local/bin/startup.sh && \
    echo 'mysql -e "GRANT ALL PRIVILEGES ON clipbucket.* TO '\''clipbucket'\''@'\''localhost'\'';"' >> /usr/local/bin/startup.sh && \
    echo 'mysql -e "FLUSH PRIVILEGES;"' >> /usr/local/bin/startup.sh && \
    echo '' >> /usr/local/bin/startup.sh && \
    echo '# Start PHP-FPM' >> /usr/local/bin/startup.sh && \
    echo 'service php8.2-fpm start' >> /usr/local/bin/startup.sh && \
    echo '' >> /usr/local/bin/startup.sh && \
    echo '# Start Nginx' >> /usr/local/bin/startup.sh && \
    echo 'service nginx start' >> /usr/local/bin/startup.sh && \
    echo '' >> /usr/local/bin/startup.sh && \
    echo 'echo "ClipBucket environment ready!"' >> /usr/local/bin/startup.sh && \
    echo 'echo "Access at: http://localhost:8088/"' >> /usr/local/bin/startup.sh && \
    echo 'echo "Avatar management: http://localhost:8088/edit_account.php?mode=avatar_bg"' >> /usr/local/bin/startup.sh && \
    echo '' >> /usr/local/bin/startup.sh && \
    echo '# Keep container running' >> /usr/local/bin/startup.sh && \
    echo 'tail -f /var/log/nginx/access.log /var/log/nginx/error.log' >> /usr/local/bin/startup.sh && \
    chmod +x /usr/local/bin/startup.sh

EXPOSE 80

# CMD 