#!/usr/bin/env python3
"""
Functional tests for Find Me On WordPress plugin.
These tests verify the plugin works correctly in both vulnerable and fixed states.
"""

import pytest
import requests
import subprocess
import time
import os

BASE_URL = os.environ.get("WP_URL", "http://localhost")
ADMIN_USER = os.environ.get("WP_ADMIN_USER", "admin")
ADMIN_PASS = os.environ.get("WP_ADMIN_PASS", "admin123")


class WordPressSession:
    """Helper class to manage WordPress authentication."""

    def __init__(self, base_url, username, password):
        self.base_url = base_url.rstrip("/")
        self.username = username
        self.password = password
        self.session = requests.Session()
        self._logged_in = False

    def login(self):
        """Login to WordPress and get session cookies."""
        if self._logged_in:
            return True

        login_url = f"{self.base_url}/wp-login.php"

        # Get the login page first to get any cookies/tokens
        self.session.get(login_url, timeout=10)

        # Perform login
        login_data = {
            "log": self.username,
            "pwd": self.password,
            "wp-submit": "Log In",
            "redirect_to": f"{self.base_url}/wp-admin/",
            "testcookie": "1"
        }

        response = self.session.post(login_url, data=login_data, allow_redirects=True, timeout=10)

        # Check if login was successful
        self._logged_in = "wordpress_logged_in" in str(self.session.cookies) or "wp-admin" in response.url
        return self._logged_in

    def ajax_request(self, action, data=None):
        """Make an AJAX request to WordPress."""
        ajax_url = f"{self.base_url}/wp-admin/admin-ajax.php"
        request_data = {"action": action}
        if data:
            request_data.update(data)
        return self.session.post(ajax_url, data=request_data, timeout=30)


@pytest.fixture(scope="module")
def wp_session():
    """Create and return a logged-in WordPress session."""
    session = WordPressSession(BASE_URL, ADMIN_USER, ADMIN_PASS)

    # Wait for WordPress to be ready
    max_retries = 30
    for i in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/wp-login.php", timeout=5)
            if response.status_code == 200:
                break
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    else:
        pytest.skip("WordPress not available")

    if not session.login():
        pytest.skip("Could not login to WordPress")

    return session


class TestPluginFunctionality:
    """Test basic plugin functionality."""

    def test_wordpress_available(self):
        """Test that WordPress is accessible."""
        response = requests.get(BASE_URL, timeout=10)
        assert response.status_code == 200

    def test_ajax_endpoint_accessible(self, wp_session):
        """Test that the AJAX endpoint is accessible when authenticated."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "99999"})
        # Should return a response (not a WordPress error page)
        assert response.status_code == 200
        # Should not redirect to login page
        assert "wp-login.php" not in response.url

    def test_delete_network_with_valid_id(self, wp_session):
        """Test deleting a network with a valid numeric ID."""
        # Use a non-existent ID to test the function flow
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "99999"})
        assert response.status_code == 200
        # Should get a response indicating the operation (success or "problem deleting")
        assert "statmessage" in response.text or response.text != ""

    def test_delete_network_with_zero_id(self, wp_session):
        """Test with zero ID - should be handled gracefully."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "0"})
        assert response.status_code == 200

    def test_delete_network_with_negative_id(self, wp_session):
        """Test with negative ID - should be handled gracefully."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "-1"})
        assert response.status_code == 200

    def test_response_contains_expected_elements(self, wp_session):
        """Test that the response contains expected JavaScript elements."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "1"})
        assert response.status_code == 200
        # The function returns JavaScript code that updates the UI
        # Either success or error message pattern
        text = response.text.lower()
        assert "statmessage" in text or "invalid" in text or response.text == "0" or response.text == ""


class TestPluginAvailability:
    """Test that the plugin is properly installed and active."""

    def test_plugin_file_exists(self):
        """Verify the plugin file exists in the expected location."""
        # This test runs inside the container context via subprocess if needed
        result = subprocess.run(
            ["test", "-f", "/var/www/html/wp-content/plugins/find-me-on/find-me-on.php"],
            capture_output=True
        )
        # If we're not in container, skip this test
        if result.returncode != 0:
            # Try alternative check via HTTP
            pass  # Skip file check, rely on HTTP tests


class TestInputHandling:
    """Test that various inputs are handled without crashing."""

    def test_empty_link_id(self, wp_session):
        """Test with empty linkId parameter."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": ""})
        assert response.status_code == 200

    def test_whitespace_link_id(self, wp_session):
        """Test with whitespace linkId parameter."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "   "})
        assert response.status_code == 200

    def test_large_valid_id(self, wp_session):
        """Test with a very large but valid numeric ID."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "2147483647"})
        assert response.status_code == 200
        # Should complete without timeout or error

    def test_numeric_string_id(self, wp_session):
        """Test with a valid numeric string."""
        response = wp_session.ajax_request("find_me_on_delete_network", {"linkId": "42"})
        assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
