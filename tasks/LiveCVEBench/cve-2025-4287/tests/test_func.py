"""
Functionality tests for PyTorch NCCL operations.
These tests verify that the PyTorch NCCL module is correctly installed and functional.
Should PASS in both vulnerable and fixed states.

Note: These tests work without CUDA by testing module imports and structure.
"""
import pytest
import subprocess
import sys


class TestNCCLImportability:
    """Tests for import functionality that don't require CUDA."""

    def test_pytorch_installed(self):
        """Test that PyTorch is installed and importable."""
        code = """
import torch
print(f"PyTorch version: {torch.__version__}")
assert torch.__version__.startswith('2.6.0'), f"Expected PyTorch 2.6.0, got {torch.__version__}"
print("SUCCESS")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        assert result.returncode == 0, f"Process failed: {result.stderr.decode()}"
        assert "SUCCESS" in result.stdout.decode()

    def test_nccl_module_importable(self):
        """Test that torch.cuda.nccl module can be imported."""
        code = """
import torch.cuda.nccl as nccl
assert hasattr(nccl, 'reduce')
assert hasattr(nccl, 'all_reduce')
assert hasattr(nccl, 'reduce_scatter')
print("SUCCESS")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        assert result.returncode == 0, f"Process failed: {result.stderr.decode()}"
        assert "SUCCESS" in result.stdout.decode()

    def test_sum_constant_defined(self):
        """Test that SUM constant is defined and equals 0."""
        code = """
from torch.cuda.nccl import SUM
assert SUM == 0, f"Expected SUM=0, got {SUM}"
print("SUCCESS")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        assert result.returncode == 0, f"Process failed: {result.stderr.decode()}"
        assert "SUCCESS" in result.stdout.decode()

    def test_nccl_functions_callable(self):
        """Test that NCCL functions are callable (have correct signature)."""
        code = """
import torch.cuda.nccl as nccl
import inspect

# Check reduce function signature
sig = inspect.signature(nccl.reduce)
params = list(sig.parameters.keys())
assert 'inputs' in params, "reduce should have 'inputs' parameter"
assert 'op' in params, "reduce should have 'op' parameter"

# Check all_reduce function signature
sig = inspect.signature(nccl.all_reduce)
params = list(sig.parameters.keys())
assert 'inputs' in params, "all_reduce should have 'inputs' parameter"
assert 'op' in params, "all_reduce should have 'op' parameter"

# Check reduce_scatter function signature
sig = inspect.signature(nccl.reduce_scatter)
params = list(sig.parameters.keys())
assert 'inputs' in params, "reduce_scatter should have 'inputs' parameter"
assert 'op' in params, "reduce_scatter should have 'op' parameter"

print("SUCCESS")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        assert result.returncode == 0, f"Process failed: {result.stderr.decode()}"
        assert "SUCCESS" in result.stdout.decode()

    def test_nccl_version_function(self):
        """Test that NCCL version function exists."""
        code = """
import torch.cuda.nccl as nccl
# version() should exist and be callable
assert callable(nccl.version), "nccl.version should be callable"
print("SUCCESS")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        assert result.returncode == 0, f"Process failed: {result.stderr.decode()}"
        assert "SUCCESS" in result.stdout.decode()

    def test_nccl_is_available_function(self):
        """Test that is_available function exists."""
        code = """
import torch.cuda.nccl as nccl
# is_available() should exist and be callable
assert callable(nccl.is_available), "nccl.is_available should be callable"
print("SUCCESS")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        assert result.returncode == 0, f"Process failed: {result.stderr.decode()}"
        assert "SUCCESS" in result.stdout.decode()
