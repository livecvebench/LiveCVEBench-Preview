"""
Functional tests for cel-rust parser.

These tests verify that the CEL parser and evaluator work correctly
with valid expressions. They should pass in both vulnerable and fixed states.
"""

import subprocess
import pytest

# The cel-test binary is compiled in /app
APP_DIR = "/app"
TEST_BINARY = "/app/target/release/cel-test"


def run_cel_expression(expr: str, timeout: int = 30) -> subprocess.CompletedProcess:
    """Helper to run a CEL expression through the test harness."""
    return subprocess.run(
        [TEST_BINARY, expr],
        capture_output=True,
        text=True,
        cwd=APP_DIR,
        timeout=timeout
    )


class TestArithmeticExpressions:
    """Test arithmetic operations."""

    def test_addition(self):
        """Test basic addition."""
        result = run_cel_expression("1 + 2")
        assert result.returncode == 0, f"Addition failed: {result.stderr}"
        assert "3" in result.stdout, f"Expected 3 in output: {result.stdout}"

    def test_subtraction(self):
        """Test basic subtraction."""
        result = run_cel_expression("10 - 4")
        assert result.returncode == 0, f"Subtraction failed: {result.stderr}"
        assert "6" in result.stdout, f"Expected 6 in output: {result.stdout}"

    def test_multiplication(self):
        """Test multiplication."""
        result = run_cel_expression("3 * 5")
        assert result.returncode == 0, f"Multiplication failed: {result.stderr}"
        assert "15" in result.stdout, f"Expected 15 in output: {result.stdout}"

    def test_division(self):
        """Test division."""
        result = run_cel_expression("20 / 4")
        assert result.returncode == 0, f"Division failed: {result.stderr}"
        assert "5" in result.stdout, f"Expected 5 in output: {result.stdout}"

    def test_complex_expression(self):
        """Test complex arithmetic expression."""
        result = run_cel_expression("(1 + 2) * 3")
        assert result.returncode == 0, f"Complex expression failed: {result.stderr}"
        assert "9" in result.stdout, f"Expected 9 in output: {result.stdout}"


class TestBooleanExpressions:
    """Test boolean operations."""

    def test_true_literal(self):
        """Test true literal."""
        result = run_cel_expression("true")
        assert result.returncode == 0, f"True literal failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_false_literal(self):
        """Test false literal."""
        result = run_cel_expression("false")
        assert result.returncode == 0, f"False literal failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "false" in output_lower, f"Expected false in output: {result.stdout}"

    def test_logical_and(self):
        """Test logical AND."""
        result = run_cel_expression("true && true")
        assert result.returncode == 0, f"Logical AND failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_logical_or(self):
        """Test logical OR."""
        result = run_cel_expression("false || true")
        assert result.returncode == 0, f"Logical OR failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_logical_not(self):
        """Test logical NOT."""
        result = run_cel_expression("!false")
        assert result.returncode == 0, f"Logical NOT failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"


class TestComparisonExpressions:
    """Test comparison operations."""

    def test_equality_true(self):
        """Test equality that evaluates to true."""
        result = run_cel_expression("1 == 1")
        assert result.returncode == 0, f"Equality failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_equality_false(self):
        """Test equality that evaluates to false."""
        result = run_cel_expression("1 == 2")
        assert result.returncode == 0, f"Equality failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "false" in output_lower, f"Expected false in output: {result.stdout}"

    def test_inequality(self):
        """Test inequality."""
        result = run_cel_expression("1 != 2")
        assert result.returncode == 0, f"Inequality failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_less_than(self):
        """Test less than comparison."""
        result = run_cel_expression("1 < 2")
        assert result.returncode == 0, f"Less than failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_greater_than(self):
        """Test greater than comparison."""
        result = run_cel_expression("5 > 3")
        assert result.returncode == 0, f"Greater than failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"


class TestStringExpressions:
    """Test string operations."""

    def test_string_literal(self):
        """Test string literal."""
        result = run_cel_expression('"hello"')
        assert result.returncode == 0, f"String literal failed: {result.stderr}"
        assert "hello" in result.stdout, f"Expected 'hello' in output: {result.stdout}"

    def test_string_equality(self):
        """Test string equality."""
        result = run_cel_expression('"hello" == "hello"')
        assert result.returncode == 0, f"String equality failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_string_inequality(self):
        """Test string inequality."""
        result = run_cel_expression('"hello" != "world"')
        assert result.returncode == 0, f"String inequality failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"

    def test_string_concatenation(self):
        """Test string concatenation."""
        result = run_cel_expression('"hello" + " world"')
        assert result.returncode == 0, f"String concatenation failed: {result.stderr}"
        assert "hello world" in result.stdout, f"Expected 'hello world' in output: {result.stdout}"


class TestListExpressions:
    """Test list operations."""

    def test_list_literal(self):
        """Test list literal."""
        result = run_cel_expression("[1, 2, 3]")
        assert result.returncode == 0, f"List literal failed: {result.stderr}"

    def test_list_access(self):
        """Test list element access."""
        result = run_cel_expression("[1, 2, 3][0]")
        assert result.returncode == 0, f"List access failed: {result.stderr}"
        assert "1" in result.stdout, f"Expected 1 in output: {result.stdout}"

    def test_list_in(self):
        """Test 'in' operator for lists."""
        result = run_cel_expression("2 in [1, 2, 3]")
        assert result.returncode == 0, f"List 'in' failed: {result.stderr}"
        output_lower = result.stdout.lower()
        assert "true" in output_lower, f"Expected true in output: {result.stdout}"


class TestConditionalExpressions:
    """Test conditional (ternary) expressions."""

    def test_ternary_true(self):
        """Test ternary with true condition."""
        result = run_cel_expression("true ? 1 : 2")
        assert result.returncode == 0, f"Ternary true failed: {result.stderr}"
        assert "1" in result.stdout, f"Expected 1 in output: {result.stdout}"

    def test_ternary_false(self):
        """Test ternary with false condition."""
        result = run_cel_expression("false ? 1 : 2")
        assert result.returncode == 0, f"Ternary false failed: {result.stderr}"
        assert "2" in result.stdout, f"Expected 2 in output: {result.stdout}"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
