"""
Vulnerability tests for the employee pre-registration form.

These tests verify that HTML/script injection is properly mitigated.
- FAIL when vulnerable (injection payloads are reflected unescaped)
- PASS when fixed (injection payloads are escaped/sanitized)
"""

import requests


def get_app_url():
    """Get the base URL for the application."""
    return "http://localhost"


def test_script_injection_msg_e():
    """
    Test that script tags are NOT reflected unescaped in msg_e parameter.

    PASS when fixed: script tags are encoded as &lt;script&gt;
    FAIL when vulnerable: raw <script> tags appear in output
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    payload = "<script>alert('XSS')</script>"

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200, f"Page should load, got {response.status_code}"

    # The raw script tag should NOT appear in the response
    # If it does, the vulnerability exists
    assert payload not in response.text, \
        "VULNERABLE: Script tag is reflected unescaped in msg_e parameter"

    # Verify it's properly encoded or stripped
    # Either &lt;script&gt; appears (htmlspecialchars only)
    # OR the content is properly escaped (quotes encoded, etc.)
    # OR script tags are stripped entirely
    script_tags_encoded = "&lt;script&gt;" in response.text
    content_escaped = ("&amp;" in response.text or "&#39;" in response.text or "&quot;" in response.text)
    no_dangerous_scripts = "<script>" not in response.text

    assert script_tags_encoded or content_escaped or no_dangerous_scripts, \
        "Script injection should be mitigated through encoding or stripping"


def test_script_injection_msg_c():
    """
    Test that script tags are NOT reflected unescaped in msg_c parameter.

    PASS when fixed: script tags are encoded as &lt;script&gt;
    FAIL when vulnerable: raw <script> tags appear in output
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    payload = "<script>alert('XSS')</script>"

    response = requests.get(url, params={"msg_c": payload}, allow_redirects=False)

    assert response.status_code == 200, f"Page should load, got {response.status_code}"

    # The raw script tag should NOT appear in the response
    assert payload not in response.text, \
        "VULNERABLE: Script tag is reflected unescaped in msg_c parameter"


def test_img_onerror_injection():
    """
    Test that img tag with onerror handler is NOT reflected unescaped.

    PASS when fixed: img tags are encoded or stripped
    FAIL when vulnerable: raw <img> tags with event handlers appear
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    payload = "<img src=x onerror=alert(document.domain)>"

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200

    # The raw img tag should NOT appear in the response
    assert payload not in response.text, \
        "VULNERABLE: Image tag with onerror is reflected unescaped"

    # Also check for the onerror attribute specifically
    assert "onerror=alert" not in response.text, \
        "VULNERABLE: onerror event handler is present in output"


def test_svg_onload_injection():
    """
    Test that svg tag with onload handler is NOT reflected unescaped.

    PASS when fixed: svg tags are encoded or stripped
    FAIL when vulnerable: raw <svg> tags with event handlers appear
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    payload = "<svg onload=alert('XSS')>"

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200

    # The raw svg tag should NOT appear in the response
    assert payload not in response.text, \
        "VULNERABLE: SVG tag with onload is reflected unescaped"


def test_attribute_breakout_injection():
    """
    Test that attribute breakout attempts are properly handled.

    PASS when fixed: quotes are encoded preventing attribute breakout
    FAIL when vulnerable: quotes allow breaking out of attribute context
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    # This payload tries to break out of an attribute and inject script
    payload = '"><script>alert(1)</script><div x="'

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200

    # The raw script tag should NOT appear in the response
    assert "<script>alert(1)</script>" not in response.text, \
        "VULNERABLE: Attribute breakout allows script injection"


def test_body_onload_injection():
    """
    Test that body tag with onload is NOT reflected unescaped.
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    payload = "<body onload=alert('XSS')>"

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200

    # Should not have unescaped body tag with onload
    assert payload not in response.text, \
        "VULNERABLE: Body tag with onload is reflected unescaped"


def test_javascript_protocol_injection():
    """
    Test that javascript: protocol URLs are handled safely.
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    payload = '<a href="javascript:alert(1)">click</a>'

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200

    # The raw anchor tag should NOT appear in the response
    assert payload not in response.text, \
        "VULNERABLE: JavaScript protocol link is reflected unescaped"


def test_encoded_payload_handling():
    """
    Test that URL-encoded payloads are properly decoded then sanitized.
    """
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    # When this gets URL decoded by PHP, it becomes <script>alert(1)</script>
    # The URL encoding is handled by requests library
    payload = "<script>alert(1)</script>"

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200

    # After URL decoding and output, script should still be escaped
    assert "<script>alert(1)</script>" not in response.text, \
        "VULNERABLE: Decoded payload is reflected unescaped"
