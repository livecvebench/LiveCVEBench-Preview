"""
Functional tests for the Voting System.
These tests verify that core functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import uuid

BASE_URL = "http://localhost:80"
ADMIN_LOGIN_URL = f"{BASE_URL}/admin/login.php"
ADMIN_INDEX_URL = f"{BASE_URL}/admin/index.php"
VOTERS_URL = f"{BASE_URL}/admin/voters.php"
VOTERS_ADD_URL = f"{BASE_URL}/admin/voters_add.php"
CANDIDATES_URL = f"{BASE_URL}/admin/candidates.php"
CANDIDATES_ADD_URL = f"{BASE_URL}/admin/candidates_add.php"

# Admin credentials
ADMIN_USERNAME = "harie"
ADMIN_PASSWORD = "Admin@123"


class TestAdminAuthentication:
    """Test admin login functionality."""

    def test_admin_login_page_loads(self):
        """Verify the admin login page is accessible."""
        response = requests.get(ADMIN_INDEX_URL)
        assert response.status_code == 200
        # Should show login form or dashboard
        assert "username" in response.text.lower() or "dashboard" in response.text.lower() or "admin" in response.text.lower()

    def test_admin_login_successful(self):
        """Verify admin can log in with valid credentials."""
        session = requests.Session()

        # Perform login
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "login": ""
        }
        response = session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)

        # After successful login, should be redirected to dashboard or stay on index
        assert response.status_code == 200

        # Access protected page to verify session is valid
        voters_response = session.get(VOTERS_URL)
        # Should not be redirected back to login (would contain login form)
        assert "Voters List" in voters_response.text or "voters" in voters_response.text.lower()

    def test_admin_login_invalid_credentials(self):
        """Verify login fails with wrong credentials."""
        session = requests.Session()

        login_data = {
            "username": "invalid_user",
            "password": "wrong_password",
            "login": ""
        }
        response = session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)

        # Should show error or login form again
        assert response.status_code == 200


class TestVotersManagement:
    """Test voter management functionality."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "login": ""
        }
        session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)
        return session

    def test_voters_page_loads(self, admin_session):
        """Verify voters list page loads for authenticated admin."""
        response = admin_session.get(VOTERS_URL)
        assert response.status_code == 200
        assert "Voters" in response.text or "voters" in response.text.lower()

    def test_add_voter_with_normal_data(self, admin_session):
        """Verify admin can add a voter with normal alphanumeric data."""
        unique_suffix = str(uuid.uuid4())[:8]

        voter_data = {
            "firstname": f"TestFirstname{unique_suffix}",
            "lastname": f"TestLastname{unique_suffix}",
            "password": "testpass123",
            "add": ""
        }

        # Add the voter
        response = admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        assert response.status_code == 200

        # Verify the voter appears in the list
        list_response = admin_session.get(VOTERS_URL)
        assert f"TestFirstname{unique_suffix}" in list_response.text
        assert f"TestLastname{unique_suffix}" in list_response.text

    def test_add_voter_with_spaces(self, admin_session):
        """Verify admin can add a voter with spaces in name."""
        unique_suffix = str(uuid.uuid4())[:8]

        voter_data = {
            "firstname": f"Test First {unique_suffix}",
            "lastname": f"Test Last {unique_suffix}",
            "password": "testpass123",
            "add": ""
        }

        response = admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        assert response.status_code == 200

        list_response = admin_session.get(VOTERS_URL)
        assert f"Test First {unique_suffix}" in list_response.text


class TestCandidatesManagement:
    """Test candidate management functionality."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "login": ""
        }
        session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)
        return session

    def test_candidates_page_loads(self, admin_session):
        """Verify candidates list page loads for authenticated admin."""
        response = admin_session.get(CANDIDATES_URL)
        assert response.status_code == 200
        assert "Candidates" in response.text or "candidates" in response.text.lower()


class TestPageStructure:
    """Test basic page structure and navigation."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "login": ""
        }
        session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)
        return session

    def test_voters_page_has_table(self, admin_session):
        """Verify voters page has a data table."""
        response = admin_session.get(VOTERS_URL)
        assert response.status_code == 200
        assert "<table" in response.text.lower()
        assert "Lastname" in response.text or "lastname" in response.text.lower()
        assert "Firstname" in response.text or "firstname" in response.text.lower()

    def test_candidates_page_has_table(self, admin_session):
        """Verify candidates page has a data table."""
        response = admin_session.get(CANDIDATES_URL)
        assert response.status_code == 200
        assert "<table" in response.text.lower()
