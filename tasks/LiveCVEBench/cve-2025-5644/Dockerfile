FROM ubuntu:22.04

WORKDIR /app

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    make \
    pkg-config \
    git \
    curl \
    wget \
    python3 \
    python3-pip \
    ninja-build \
    meson \
    libasan6 \
    tmux \
    asciinema \
    && rm -rf /var/lib/apt/lists/*

# Download and extract radare2 5.9.8
RUN curl -L -o /tmp/radare2-5.9.8.tar.gz \
    https://github.com/radareorg/radare2/archive/refs/tags/5.9.8.tar.gz && \
    tar -xzf /tmp/radare2-5.9.8.tar.gz -C /app && \
    rm /tmp/radare2-5.9.8.tar.gz && \
    cp -a /app/radare2-5.9.8/. /app/ && \
    rm -rf /app/radare2-5.9.8

# Remove .git directory if it exists (prevents solution leakage)
RUN rm -rf /app/.git

# Build with ASAN enabled for vulnerability detection
RUN meson setup build \
    -Db_sanitize=address \
    -Dbuildtype=debug \
    --prefix=/usr/local && \
    ninja -C build -j$(nproc) && \
    ninja -C build install && \
    ldconfig

# Copy POC test files
COPY task-deps/POC1 /tmp/POC1
COPY task-deps/POC2 /tmp/POC2

# Ensure binaries are executable
RUN chmod +x /tmp/POC1 /tmp/POC2

# Set ASAN options for runtime (suppress leak detection to focus on UAF)
ENV ASAN_OPTIONS="detect_leaks=0:allocator_may_return_null=1"

# Ensure radiff2 is in PATH
ENV PATH="/usr/local/bin:$PATH"

# Verify installation
RUN radiff2 -v

# Working directory for tests
WORKDIR /app

# Keep container running
CMD ["/bin/bash", "-c", "tail -f /dev/null"]
