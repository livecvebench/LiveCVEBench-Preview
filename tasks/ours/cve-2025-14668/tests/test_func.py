#!/usr/bin/env python3
"""
Functional tests for the Online Examination System login endpoint.
These tests verify that the login functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import json

BASE_URL = "http://localhost"
LOGIN_ENDPOINT = f"{BASE_URL}/query/loginExe.php"

# Valid test credentials from the database
VALID_CREDENTIALS = [
    ("rogz.nunez2013@gmail.com", "rogz"),
    ("jane@gmail.com", "jane"),
    ("glenn@gmail.com", "glenn"),
    ("maria@gmail.com", "maria"),
    ("dave@gmail.com", "dave"),
]


class TestLoginFunctionality:
    """Test that normal login functionality works correctly."""

    @pytest.mark.parametrize("email,password", VALID_CREDENTIALS)
    def test_login_with_valid_credentials(self, email, password):
        """Login with valid credentials should succeed."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": email, "pass": password},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("res") == "success", f"Expected 'success' for valid login, got: {data}"

    def test_login_with_invalid_password(self):
        """Login with incorrect password should fail."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "rogz.nunez2013@gmail.com", "pass": "wrongpassword"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("res") == "invalid", f"Expected 'invalid' for wrong password, got: {data}"

    def test_login_with_nonexistent_user(self):
        """Login with non-existent user should fail."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "nonexistent@example.com", "pass": "anypassword"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("res") == "invalid", f"Expected 'invalid' for non-existent user, got: {data}"

    def test_login_returns_valid_json(self):
        """Login endpoint should always return valid JSON."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "test@test.com", "pass": "test"},
            timeout=10
        )
        assert response.status_code == 200
        # Should not raise JSONDecodeError
        data = response.json()
        assert "res" in data, "Response should contain 'res' key"

    def test_login_with_empty_credentials(self):
        """Login with empty credentials should fail."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "", "pass": ""},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("res") == "invalid", f"Expected 'invalid' for empty credentials, got: {data}"

    def test_login_with_missing_password(self):
        """Login with missing password field should not crash."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "rogz.nunez2013@gmail.com"},
            timeout=10
        )
        assert response.status_code == 200
        # Either returns invalid or success if password check is bypassed
        # but should not crash (500 error)

    def test_login_with_missing_username(self):
        """Login with missing username field should not crash."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"pass": "rogz"},
            timeout=10
        )
        assert response.status_code == 200
        # Either returns invalid or handles gracefully
        # but should not crash (500 error)

    def test_login_endpoint_accepts_post(self):
        """Login endpoint should accept POST requests."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "test", "pass": "test"},
            timeout=10
        )
        # Should get a proper response, not 405 Method Not Allowed
        assert response.status_code == 200

    def test_login_with_special_but_valid_email(self):
        """Login with valid email containing periods should work."""
        # rogz.nunez2013@gmail.com has periods in the local part
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "rogz.nunez2013@gmail.com", "pass": "rogz"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("res") == "success"

    def test_login_case_sensitivity(self):
        """Test that login is case-sensitive for email (MySQL default behavior)."""
        response = requests.post(
            LOGIN_ENDPOINT,
            data={"username": "ROGZ.NUNEZ2013@GMAIL.COM", "pass": "rogz"},
            timeout=10
        )
        assert response.status_code == 200
        # MySQL is case-insensitive for string comparisons by default
        # so this might succeed - just ensure no crash
        data = response.json()
        assert data.get("res") in ["success", "invalid"]
