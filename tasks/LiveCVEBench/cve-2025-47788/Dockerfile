FROM php:7.4-apache

WORKDIR /var/www/html

# System dependencies (tmux, asciinema, curl required; git for cloning)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    procps \
    gcc g++ wget \
    && rm -rf /var/lib/apt/lists/*

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Configure Apache to allow .htaccess overrides
RUN sed -i 's/AllowOverride None/AllowOverride All/g' /etc/apache2/apache2.conf

# Clone Atheos v601 (vulnerable version) and remove git history
RUN rm -rf /var/www/html/* && \
    git clone --branch v601 --depth 1 https://github.com/Atheos/Atheos.git /var/www/html && \
    rm -rf /var/www/html/.git

# Create required directories if they don't exist and set permissions
RUN mkdir -p /var/www/html/workspace /var/www/html/data /var/www/html/plugins /var/www/html/themes && \
    chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html && \
    chmod -R 777 /var/www/html/workspace /var/www/html/data /var/www/html/plugins /var/www/html/themes

# Pre-configure Atheos with admin user for testing
# Password: admin (bcrypt hash generated with password_hash('admin', PASSWORD_DEFAULT))
COPY task-deps/users.json /var/www/html/data/users.json
RUN chown www-data:www-data /var/www/html/data/users.json

# Copy config.php for Atheos to work without setup wizard
COPY task-deps/config.php /var/www/html/config.php
RUN chown www-data:www-data /var/www/html/config.php

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh


# CMD ["/entrypoint.sh"]
