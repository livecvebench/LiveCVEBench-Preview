"""
Functional tests for the static file server.
These tests verify the server works correctly for legitimate requests.
Should PASS in both vulnerable and fixed states.
"""

import socket
import time
import os
import subprocess
import signal
import tempfile


def send_http_request(host='localhost', port=8000, path='/', timeout=5):
    """
    Send a raw HTTP GET request and return the response.
    Returns tuple of (status_code, headers_dict, body)
    """
    request = f"GET {path} HTTP/1.1\r\nHost: {host}:{port}\r\nConnection: close\r\n\r\n"

    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        sock.connect((host, port))
        sock.sendall(request.encode())

        response = b''
        while True:
            data = sock.recv(4096)
            if not data:
                break
            response += data
        sock.close()

        response_str = response.decode('utf-8', errors='ignore')

        # Parse response
        if '\r\n\r\n' in response_str:
            headers_part, body = response_str.split('\r\n\r\n', 1)
        else:
            headers_part = response_str
            body = ''

        lines = headers_part.split('\r\n')
        status_line = lines[0]

        # Extract status code
        parts = status_line.split(' ', 2)
        if len(parts) >= 2:
            status_code = int(parts[1])
        else:
            status_code = 0

        # Parse headers
        headers = {}
        for line in lines[1:]:
            if ':' in line:
                key, value = line.split(':', 1)
                headers[key.strip().lower()] = value.strip()

        return status_code, headers, body
    except Exception as e:
        return None, {}, str(e)


def test_server_returns_404_for_missing_files():
    """Server should return 404 for non-existent files"""
    status_code, headers, body = send_http_request(path='/nonexistent_file_xyz123.txt')

    assert status_code == 404, f"Expected 404 for missing file, got {status_code}"
    assert '404' in body or 'Not Found' in body, f"Expected 404 message in body, got: {body}"


def test_server_sets_correct_mime_type_for_html():
    """Server should set text/html Content-Type for .html files"""
    # Request the test index page which should exist
    status_code, headers, body = send_http_request(path='/test/index.html')

    # The file might not exist, but if it does, check mime type
    if status_code == 200:
        content_type = headers.get('content-type', '')
        assert 'text/html' in content_type, f"Expected text/html, got {content_type}"


def test_server_sets_correct_mime_type_for_js():
    """Server should set text/javascript Content-Type for .js files"""
    # Request any JS file
    status_code, headers, body = send_http_request(path='/scripts/server.js')

    if status_code == 200:
        content_type = headers.get('content-type', '')
        assert 'javascript' in content_type, f"Expected javascript mime type, got {content_type}"


def test_server_responds_to_root():
    """Server should respond to root path request"""
    status_code, headers, body = send_http_request(path='/')

    # Root might return 200 with directory listing, 404 if no index, or other
    # The key is that the server responds without crashing
    assert status_code is not None, "Server did not respond to root request"
    assert status_code in [200, 404, 403], f"Unexpected status code: {status_code}"


def test_server_handles_test_path_redirect():
    """Server should handle /test/ path specially"""
    status_code, headers, body = send_http_request(path='/test/')

    # According to code, /test/ redirects to /test/index.html internally
    # So we should get either 200 (if file exists) or 404 (if not)
    assert status_code is not None, "Server did not respond"
    assert status_code in [200, 404], f"Expected 200 or 404 for /test/, got {status_code}"


def test_server_handles_multiple_requests():
    """Server should handle multiple sequential requests"""
    for i in range(3):
        status_code, headers, body = send_http_request(path=f'/test{i}.txt')
        assert status_code is not None, f"Server stopped responding on request {i+1}"


def test_server_valid_file_access():
    """Server should correctly serve files within the working directory"""
    # Request the server script itself - it should exist and be serveable
    status_code, headers, body = send_http_request(path='/scripts/server.js')

    if status_code == 200:
        # Verify we got actual JavaScript content
        assert 'http' in body.lower() or 'require' in body.lower(), \
            "Server.js should contain Node.js code"
        assert len(body) > 100, "Response body seems too small for server.js"
