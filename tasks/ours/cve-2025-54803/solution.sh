#!/bin/bash
set -e
cd /app

# This script fixes the prototype pollution vulnerability in js-toml
# by patching both ESM (index.js) and CJS (index.cjs) JavaScript files to use
# Object.create(null) instead of {} for creating objects during TOML parsing.

# Create a Node.js patch script that handles both minified files
cat > /tmp/patch_jstoml.js << 'PATCH_EOF'
const fs = require('fs');

function patchFile(filePath, patterns) {
    if (!fs.existsSync(filePath)) {
        console.log(`Skipping ${filePath} - file not found`);
        return false;
    }

    let content = fs.readFileSync(filePath, 'utf8');
    let modified = false;
    const originalLength = content.length;

    console.log(`\nPatching ${filePath}...`);

    for (const [name, oldStr, newStr] of patterns) {
        if (content.includes(oldStr)) {
            content = content.replace(oldStr, newStr);
            modified = true;
            console.log(`  ✓ Fixed ${name}`);
        }
    }

    if (modified) {
        fs.writeFileSync(filePath, content);
        console.log(`  ✅ Saved (${originalLength} -> ${content.length} bytes)`);
    } else {
        console.log(`  ⚠ No patterns matched`);
        // Debug info
        if (content.includes('Object.create(null)')) {
            console.log(`  Note: File already contains Object.create(null)`);
        }
    }

    return modified;
}

// ESM file patterns (index.js) - uses different variable names
const esmPatterns = [
    // isPlainObject function (Qe)
    ['isPlainObject (Qe)',
     'Qe=r=>r&&r.constructor===Object',
     'Qe=r=>r&&(r.constructor===Object||r.constructor===undefined)'],

    // Root object in toml()
    ['toml root object',
     'toml(e){var n;let t={}',
     'toml(e){var n;let t=Object.create(null)'],

    // tryCreatingObject nested object
    ['tryCreatingObject',
     'else t[e]={},i&&(t[e][i]=!0)',
     'else t[e]=Object.create(null),i&&(t[e][i]=!0)'],

    // inlineTable result object
    ['inlineTable',
     'inlineTable(e){let t={[$]:!0}',
     'inlineTable(e){let t=Object.create(null);t[$]=!0'],

    // arrayTable object creation
    ['arrayTable',
     'let a={};return n.push(a)',
     'let a=Object.create(null);return n.push(a)']
];

// CJS file patterns (index.cjs) - uses different variable names
const cjsPatterns = [
    // isPlainObject function (Mu)
    ['isPlainObject (Mu)',
     'Mu=t=>t&&t.constructor===Object',
     'Mu=t=>t&&(t.constructor===Object||t.constructor===undefined)'],

    // Root object in toml()
    ['toml root object',
     'toml(e){var o;let r={}',
     'toml(e){var o;let r=Object.create(null)'],

    // tryCreatingObject nested object
    ['tryCreatingObject',
     'else r[e]={},n&&(r[e][n]=!0)',
     'else r[e]=Object.create(null),n&&(r[e][n]=!0)'],

    // inlineTable result object
    ['inlineTable',
     'inlineTable(e){let r={[Cn]:!0}',
     'inlineTable(e){let r=Object.create(null);r[Cn]=!0'],

    // arrayTable object creation
    ['arrayTable',
     'let i={};return o.push(i)',
     'let i=Object.create(null);return o.push(i)']
];

const esmPath = '/app/node_modules/js-toml/dist/index.js';
const cjsPath = '/app/node_modules/js-toml/dist/index.cjs';

let esmModified = patchFile(esmPath, esmPatterns);
let cjsModified = patchFile(cjsPath, cjsPatterns);

if (esmModified || cjsModified) {
    console.log('\n✅ Patch applied successfully!');
    console.log('The prototype pollution vulnerability has been fixed.');
} else {
    console.log('\n⚠ Warning: No patterns matched in either file.');
    console.log('The files may already be patched or have a different format.');
}
PATCH_EOF

# Run the patch script
node /tmp/patch_jstoml.js

# Clean up
rm -f /tmp/patch_jstoml.js

# Verify the fix from /app directory where js-toml can be found
echo ""
echo "=== Verifying fix ==="
node -e '
const { load } = require("js-toml");
const before = {}.test;
load("[__proto__]\ntest = true");
const after = {}.test;
console.log("Before parse: {}.test =", before);
console.log("After parse: {}.test =", after);
if (after === undefined) {
    console.log("✓ Fix verified - prototype pollution is BLOCKED");
} else {
    console.log("✗ Fix FAILED - prototype pollution still works");
    process.exit(1);
}
'

echo ""
echo "Fix applied successfully!"
