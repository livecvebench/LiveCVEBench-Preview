#!/bin/bash

# Entrypoint script for Redis CVE-2025-49844 container
# Wraps Redis server in a restart loop so the container survives process restarts

REDIS_CONF="/etc/redis/redis.conf"

# Function to handle shutdown
cleanup() {
    echo "Shutting down Redis..."
    redis-cli shutdown nosave 2>/dev/null
    exit 0
}

trap cleanup SIGTERM SIGINT

# Main restart loop
while true; do
    echo "Starting Redis server..."
    redis-server "$REDIS_CONF" &
    REDIS_PID=$!

    # Wait for Redis process
    wait $REDIS_PID
    EXIT_CODE=$?

    # If exit code is 0, it was a clean shutdown
    if [ $EXIT_CODE -eq 0 ]; then
        echo "Redis exited cleanly (code $EXIT_CODE), restarting..."
    else
        echo "Redis crashed or was killed (code $EXIT_CODE), restarting..."
    fi

    # Brief pause before restart
    sleep 1
done
