"""
Functional tests for Emlog admin store search functionality.
These tests verify that basic search functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os
import re
from urllib.parse import quote, urljoin

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")
ADMIN_USER = os.environ.get("ADMIN_USER", "admin")
ADMIN_PASS = os.environ.get("ADMIN_PASS", "admin123")


class TestStoreSearchFunctionality:
    """Test basic store search functionality"""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup session with admin authentication"""
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

        # Attempt to authenticate
        self._authenticate()
        yield
        self.session.close()

    def _authenticate(self):
        """Authenticate as admin user"""
        login_url = urljoin(BASE_URL, "/admin/account.php?action=dosignin")

        # Get login page first (may have CSRF token)
        try:
            resp = self.session.get(urljoin(BASE_URL, "/admin/"), timeout=10)
        except requests.exceptions.RequestException:
            pytest.skip("Application not accessible")

        # Try to login
        login_data = {
            'user': ADMIN_USER,
            'pw': ADMIN_PASS,
            'persist': '1'
        }

        try:
            resp = self.session.post(login_url, data=login_data, timeout=10, allow_redirects=True)
        except requests.exceptions.RequestException:
            pytest.skip("Login failed - application not accessible")

    def _check_store_accessible(self, url):
        """Check if store page is accessible"""
        try:
            resp = self.session.get(url, timeout=10)
            # Store page may show error if external API is unreachable, but should still render
            return resp.status_code == 200
        except requests.exceptions.RequestException:
            return False

    def test_main_store_page_loads(self):
        """Test that main store page loads successfully"""
        store_url = urljoin(BASE_URL, "/admin/store.php")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Store page returned {resp.status_code}"

        # Check for store page elements
        assert "store.php" in resp.text or "应用商店" in resp.text or "keyword" in resp.text

    def test_template_store_page_loads(self):
        """Test that template store page loads successfully"""
        store_url = urljoin(BASE_URL, "/admin/store.php?action=tpl")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Template store page returned {resp.status_code}"

        # Check for template store elements
        assert "action=tpl" in resp.text or "模板" in resp.text or "keyword" in resp.text

    def test_plugin_store_page_loads(self):
        """Test that plugin store page loads successfully"""
        store_url = urljoin(BASE_URL, "/admin/store.php?action=plu")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Plugin store page returned {resp.status_code}"

        # Check for plugin store elements
        assert "action=plu" in resp.text or "插件" in resp.text or "keyword" in resp.text

    def test_search_form_exists_main_store(self):
        """Test that search form with keyword input exists on main store"""
        store_url = urljoin(BASE_URL, "/admin/store.php")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200

        # Check for keyword input field
        assert 'name="keyword"' in resp.text, "Keyword input field not found"

    def test_search_form_exists_template_store(self):
        """Test that search form with keyword input exists on template store"""
        store_url = urljoin(BASE_URL, "/admin/store.php?action=tpl")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200

        # Check for keyword input field
        assert 'name="keyword"' in resp.text, "Keyword input field not found"

    def test_search_form_exists_plugin_store(self):
        """Test that search form with keyword input exists on plugin store"""
        store_url = urljoin(BASE_URL, "/admin/store.php?action=plu")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200

        # Check for keyword input field
        assert 'name="keyword"' in resp.text, "Keyword input field not found"

    def test_normal_keyword_search_main(self):
        """Test normal keyword search on main store"""
        keyword = "test"
        store_url = urljoin(BASE_URL, f"/admin/store.php?keyword={keyword}")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Search returned {resp.status_code}"

        # Keyword should appear in the response (in the input value)
        assert keyword in resp.text, "Keyword not reflected in response"

    def test_normal_keyword_search_templates(self):
        """Test normal keyword search on template store"""
        keyword = "blog"
        store_url = urljoin(BASE_URL, f"/admin/store.php?action=tpl&keyword={keyword}")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Search returned {resp.status_code}"

        # Keyword should appear in the response
        assert keyword in resp.text, "Keyword not reflected in response"

    def test_normal_keyword_search_plugins(self):
        """Test normal keyword search on plugin store"""
        keyword = "seo"
        store_url = urljoin(BASE_URL, f"/admin/store.php?action=plu&keyword={keyword}")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Search returned {resp.status_code}"

        # Keyword should appear in the response
        assert keyword in resp.text, "Keyword not reflected in response"

    def test_empty_keyword_search(self):
        """Test empty keyword search works without errors"""
        store_url = urljoin(BASE_URL, "/admin/store.php?keyword=")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Empty search returned {resp.status_code}"

    def test_alphanumeric_special_chars_search(self):
        """Test search with alphanumeric and some safe special chars"""
        keyword = "test-app_v2.0"
        store_url = urljoin(BASE_URL, f"/admin/store.php?keyword={quote(keyword)}")

        resp = self.session.get(store_url, timeout=10)
        assert resp.status_code == 200, f"Search returned {resp.status_code}"


class TestApplicationAvailability:
    """Test that the application is available and responsive"""

    def test_application_responds(self):
        """Test that the application responds to requests"""
        try:
            resp = requests.get(BASE_URL, timeout=10)
            assert resp.status_code in [200, 301, 302, 303, 307, 308], \
                f"Application returned unexpected status {resp.status_code}"
        except requests.exceptions.RequestException as e:
            pytest.fail(f"Application not accessible: {e}")

    def test_admin_panel_accessible(self):
        """Test that admin panel is accessible"""
        admin_url = urljoin(BASE_URL, "/admin/")

        try:
            resp = requests.get(admin_url, timeout=10, allow_redirects=True)
            # Should return 200 (login page or dashboard)
            assert resp.status_code == 200, f"Admin panel returned {resp.status_code}"
        except requests.exceptions.RequestException as e:
            pytest.fail(f"Admin panel not accessible: {e}")
