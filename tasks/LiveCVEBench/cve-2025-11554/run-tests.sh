#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== i-Educar Authorization Tests ==="
echo ""

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env 2>/dev/null || true
    export PATH="$HOME/.local/bin:$PATH"
fi

# Initialize uv project if needed
uv init 2>/dev/null || true

# Install test dependencies
echo "Installing test dependencies..."
uv add pytest requests beautifulsoup4 2>/dev/null

# Set default APP_URL if not provided
export APP_URL="${APP_URL:-http://localhost}"
export ADMIN_USER="${ADMIN_USER:-admin}"
export ADMIN_PASSWORD="${ADMIN_PASSWORD:-123456789}"

echo "Testing against: $APP_URL"
echo ""

# Wait for application to be ready
echo "Waiting for application to be ready..."
max_attempts=60
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -s -o /dev/null -w "%{http_code}" "$APP_URL/login" | grep -q "200"; then
        echo "Application is ready!"
        break
    fi
    attempt=$((attempt + 1))
    if [ $attempt -eq $max_attempts ]; then
        echo "ERROR: Application did not become ready in time"
        exit 1
    fi
    sleep 2
done

echo ""

# Create low-privilege test user for vulnerability tests
echo "Creating low-privilege test user..."
php /app/artisan tinker --execute='
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;

$username = "lowprivtest";
$password = "testpassword123";
$hashedPassword = Hash::make($password);

// Check if low-priv user type exists, if not create it
$userType = DB::table("pmieducar.tipo_usuario")->where("nm_tipo", "LowPrivTest")->first();
if (!$userType) {
    $userTypeId = DB::table("pmieducar.tipo_usuario")->insertGetId([
        "nm_tipo" => "LowPrivTest",
        "nivel" => 8, // Non-admin level (8 = Biblioteca, non-privileged)
        "ref_funcionario_cad" => 1,
        "data_cadastro" => now(),
        "ativo" => 1,
    ], "cod_tipo_usuario");
} else {
    $userTypeId = $userType->cod_tipo_usuario;
}

// Check if person exists
$person = DB::table("cadastro.pessoa")->where("nome", "LowPrivTest User")->first();
if (!$person) {
    // Get the max idpes+1 for the new person
    $maxId = DB::table("cadastro.pessoa")->max("idpes") + 1;
    DB::table("cadastro.pessoa")->insert([
        "idpes" => $maxId,
        "nome" => "LowPrivTest User",
        "data_cad" => now(),
        "tipo" => "F",
        "situacao" => "A",
        "origem_gravacao" => "M",
        "operacao" => "I",
    ]);
    $personId = $maxId;
} else {
    $personId = $person->idpes;
}

// Check if fisica record exists (required for funcionario FK)
$fisica = DB::table("cadastro.fisica")->where("idpes", $personId)->first();
if (!$fisica) {
    DB::table("cadastro.fisica")->insert([
        "idpes" => $personId,
        "origem_gravacao" => "M",
        "data_cad" => now(),
        "operacao" => "I",
    ]);
}

// Check if funcionario (employee) exists
$funcionario = DB::table("portal.funcionario")->where("ref_cod_pessoa_fj", $personId)->first();
if (!$funcionario) {
    DB::table("portal.funcionario")->insert([
        "ref_cod_pessoa_fj" => $personId,
        "matricula" => $username,
        "senha" => $hashedPassword,
        "ativo" => 1,
        "email" => "lowpriv@test.com",
    ]);
} else {
    // Update password in case it changed
    DB::table("portal.funcionario")->where("ref_cod_pessoa_fj", $personId)->update([
        "matricula" => $username,
        "senha" => $hashedPassword,
        "ativo" => 1,
    ]);
}

// Check if user exists
$user = DB::table("pmieducar.usuario")->where("cod_usuario", $personId)->first();
if (!$user) {
    DB::table("pmieducar.usuario")->insert([
        "cod_usuario" => $personId,
        "ref_funcionario_cad" => 1,
        "ref_cod_tipo_usuario" => $userTypeId,
        "data_cadastro" => now(),
        "ativo" => 1,
    ]);
} else {
    // Ensure user has correct user type (non-admin)
    DB::table("pmieducar.usuario")->where("cod_usuario", $personId)->update([
        "ref_cod_tipo_usuario" => $userTypeId,
        "ativo" => 1,
    ]);
}

echo "SUCCESS: Low privilege user ready (username: " . $username . ", person_id: " . $personId . ")";
' 2>&1 || echo "Warning: Could not create low-priv test user"

echo ""
echo "Running tests..."
echo ""

# Run pytest with detailed output
uv run pytest . -rA -v --tb=short
