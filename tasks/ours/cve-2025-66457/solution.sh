#!/bin/bash
set -e
cd /app

echo "=== Applying fix for cookie config code injection (CVE-2025-66457) ==="

# The vulnerability is in Elysia versions < 1.4.18.
# Cookie configuration values are interpolated directly into generated code
# without proper escaping, allowing code injection.
#
# The fix adds overrideUnsafeQuote function that properly escapes backticks
# and template literal syntax before embedding strings in generated code.
#
# Vulnerable patterns that need patching:
# 1. signCookie(cookie.value,'${secret}')
# 2. signCookie(_setCookie['${name}'].value,'${secret}')
# 3. typeof cookieMeta.secrets==="string"?`'${cookieMeta.secrets}'`
# 4. `'${b}',` in array reduce
#
# NOTE: We need to patch ALL elysia files:
# - compose.js (CommonJS)
# - compose.mjs (ESM)
# - bun/index.js (Bun-specific bundled version)

patch_compose_file() {
    local TARGET="$1"
    local FILE_TYPE="$2"

    if [ ! -f "$TARGET" ]; then
        echo "Warning: $TARGET not found, skipping..."
        return 0
    fi

    echo "Patching $TARGET..."

    # Check if overrideUnsafeQuote is already present
    if grep -q "overrideUnsafeQuote" "$TARGET"; then
        echo "  File already has overrideUnsafeQuote, skipping function addition..."
    else
        # Add the overrideUnsafeQuote function after allocateIf definition
        sed -i 's/const allocateIf = (value, condition) => condition ? value : "", defaultParsers = \[/const allocateIf = (value, condition) => condition ? value : "", overrideUnsafeQuote = (value) => "\`" + String(value).replace(\/`\/g, "\\\\`").replace(\/\\${\/g, "$\\\\{") + "\`", defaultParsers = [/' "$TARGET"
        echo "  Added overrideUnsafeQuote function"
    fi

    # Replace vulnerable patterns with safe versions
    echo "  Replacing vulnerable patterns..."

    # Pattern 1: signCookie(cookie.value,'${secret}')
    sed -i "s/signCookie(cookie\.value,'\${secret}')/signCookie(cookie.value,overrideUnsafeQuote(secret))/g" "$TARGET"

    # Pattern 2: signCookie(_setCookie['${name}'].value,'${secret}')
    sed -i "s/signCookie(_setCookie\['\${name}'\]\.value,'\${secret}')/signCookie(_setCookie['\${name}'].value,overrideUnsafeQuote(secret))/g" "$TARGET"

    # Pattern 3: typeof cookieMeta.secrets == "string" ? `'${cookieMeta.secrets}'`
    # Using pipe to avoid escaping issues
    cat "$TARGET" | sed "s/typeof cookieMeta.secrets == \"string\" ? \`'\${cookieMeta.secrets}'\`/typeof cookieMeta.secrets == \"string\" ? overrideUnsafeQuote(cookieMeta.secrets)/g" > "$TARGET.tmp" && mv "$TARGET.tmp" "$TARGET"

    # Pattern 4: `'${b}'` for array reduce
    cat "$TARGET" | sed "s/\`'\${b}'\`/overrideUnsafeQuote(b)/g" > "$TARGET.tmp" && mv "$TARGET.tmp" "$TARGET"

    # Verify the function was added
    if grep -q "overrideUnsafeQuote" "$TARGET"; then
        echo "  ✓ overrideUnsafeQuote function present"
    else
        echo "  ✗ Failed to add overrideUnsafeQuote function to $TARGET"
        return 1
    fi

    echo "  ✓ Vulnerable patterns replaced"
    return 0
}

patch_bun_bundle() {
    local TARGET="$1"

    if [ ! -f "$TARGET" ]; then
        echo "Warning: $TARGET not found, skipping..."
        return 0
    fi

    echo "Patching $TARGET (Bun bundle)..."

    # Check if overrideUnsafeQuote is already present
    if grep -q "overrideUnsafeQuote" "$TARGET"; then
        echo "  File already has overrideUnsafeQuote, skipping function addition..."
    else
        # The bun bundle has minified format
        sed -i 's/allocateIf=(value,condition)=>condition?value:"",defaultParsers=/allocateIf=(value,condition)=>condition?value:"",overrideUnsafeQuote=(value)=>"\`"+String(value).replace(\/`\/g,"\\\\`").replace(\/\\${\/g,"$\\\\{")+"\`",defaultParsers=/' "$TARGET"
        echo "  Added overrideUnsafeQuote function"
    fi

    # Replace vulnerable patterns
    echo "  Replacing vulnerable patterns..."

    # Pattern 1: signCookie(cookie.value,'${secret}')
    sed -i "s/signCookie(cookie\.value,'\${secret}')/signCookie(cookie.value,overrideUnsafeQuote(secret))/g" "$TARGET"

    # Pattern 2: signCookie(_setCookie['${name}'].value,'${secret}')
    sed -i "s/signCookie(_setCookie\['\${name}'\]\.value,'\${secret}')/signCookie(_setCookie['\${name}'].value,overrideUnsafeQuote(secret))/g" "$TARGET"

    # Pattern 3: typeof cookieMeta.secrets==="string"?`'${cookieMeta.secrets}'`
    # Using hex escapes for reliable pattern matching
    cat "$TARGET" | sed "s/typeof cookieMeta.secrets===\"string\"?\`\x27\${cookieMeta.secrets}\x27\`/typeof cookieMeta.secrets===\"string\"?overrideUnsafeQuote(cookieMeta.secrets)/g" > "$TARGET.tmp" && mv "$TARGET.tmp" "$TARGET"

    # Pattern 4: `'${b}',` for array reduce
    cat "$TARGET" | sed "s/\`\x27\${b}\x27,\`/overrideUnsafeQuote(b)+\x27,\x27/g" > "$TARGET.tmp" && mv "$TARGET.tmp" "$TARGET"

    # Verify the function was added
    if grep -q "overrideUnsafeQuote" "$TARGET"; then
        echo "  ✓ overrideUnsafeQuote function present"
    else
        echo "  ✗ Failed to add overrideUnsafeQuote function to $TARGET"
        return 1
    fi

    echo "  ✓ Vulnerable patterns replaced"
    return 0
}

# Patch all versions of the compose module

echo ""
echo "=== Patching CommonJS version (compose.js) ==="
patch_compose_file "/app/node_modules/elysia/dist/compose.js" "CommonJS"

echo ""
echo "=== Patching ESM version (compose.mjs) ==="
patch_compose_file "/app/node_modules/elysia/dist/compose.mjs" "ESM"

echo ""
echo "=== Patching Bun-specific bundle (bun/index.js) ==="
patch_bun_bundle "/app/node_modules/elysia/dist/bun/index.js"

echo ""
echo "=== Restarting the application ==="

# Kill the running server so it can restart with fixed code
pkill -f "bun.*app.ts" 2>/dev/null || true
sleep 2

echo ""
echo "=== Fix applied successfully ==="
echo "Cookie configuration values are now properly escaped before"
echo "being embedded in generated JavaScript code."
