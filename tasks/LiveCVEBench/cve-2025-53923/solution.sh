#!/bin/bash
# Solution script to fix the reflected XSS vulnerability in Emlog admin store search
# The vulnerability exists in three view files where the $keyword variable is
# echoed directly into HTML without proper encoding.
#
# Fix: Use htmlspecialchars() with ENT_QUOTES and UTF-8 encoding

set -e
cd /app

# Define the application root (adjust if needed based on actual structure)
APP_ROOT="/app/emlog"

# Check if the standard emlog structure exists
if [ -d "$APP_ROOT/admin/views" ]; then
    VIEWS_DIR="$APP_ROOT/admin/views"
elif [ -d "/app/admin/views" ]; then
    VIEWS_DIR="/app/admin/views"
else
    echo "Error: Could not find admin/views directory"
    exit 1
fi

echo "Fixing files in: $VIEWS_DIR"

# Fix 1: admin/views/store.php
# Replace: value="<?= $keyword ?>"
# With: value="<?= htmlspecialchars($keyword, ENT_QUOTES, 'UTF-8') ?>"
STORE_FILE="$VIEWS_DIR/store.php"
if [ -f "$STORE_FILE" ]; then
    echo "Fixing $STORE_FILE..."
    sed -i 's/value="<?= \$keyword ?>"/value="<?= htmlspecialchars(\$keyword, ENT_QUOTES, '\''UTF-8'\'') ?>"/g' "$STORE_FILE"
    echo "Fixed store.php"
else
    echo "Warning: $STORE_FILE not found"
fi

# Fix 2: admin/views/store_tpl.php
STORE_TPL_FILE="$VIEWS_DIR/store_tpl.php"
if [ -f "$STORE_TPL_FILE" ]; then
    echo "Fixing $STORE_TPL_FILE..."
    sed -i 's/value="<?= \$keyword ?>"/value="<?= htmlspecialchars(\$keyword, ENT_QUOTES, '\''UTF-8'\'') ?>"/g' "$STORE_TPL_FILE"
    echo "Fixed store_tpl.php"
else
    echo "Warning: $STORE_TPL_FILE not found"
fi

# Fix 3: admin/views/store_plu.php
STORE_PLU_FILE="$VIEWS_DIR/store_plu.php"
if [ -f "$STORE_PLU_FILE" ]; then
    echo "Fixing $STORE_PLU_FILE..."
    sed -i 's/value="<?= \$keyword ?>"/value="<?= htmlspecialchars(\$keyword, ENT_QUOTES, '\''UTF-8'\'') ?>"/g' "$STORE_PLU_FILE"
    echo "Fixed store_plu.php"
else
    echo "Warning: $STORE_PLU_FILE not found"
fi

# PHP/Apache/nginx don't need restart for code changes (interpreted language)
# The changes take effect immediately

echo ""
echo "Fix applied successfully!"
echo "All three store view files have been updated to use htmlspecialchars() for the keyword parameter."
