<template>
    <div>
        <div class="card card-custom gutter-b example example-compact" id="tableBody">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-icon">
                        <i class="text-dark-50 flaticon-search-magnifier-interface-symbol"></i>
                    </span>
                    <h3 class="card-label"> 查询区域 </h3>
                </div>
                <div class="card-toolbar">
                    <div class="example-tools justify-content-center">
                        <!-- 
                <span data-toggle="tooltip" class="example-toggle"></span>
                <span data-toggle="tooltip" class="example-copy"></span> 
              -->
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!--查询条件-->
                <div class="m-form m-form--fit m-form--label-align-left m-form--group-seperator-dashed">
                    <div class="m-portlet__body">
                        <div class="form-group m-form__group row">
                            <label class="col-form-label">名称:</label>
                            <div class="col-md-2">
                                <input type="text" class="form-control" v-model="searchForm.name" placeholder="请输入">
                            </div>
                            <b-button :pressed="false" variant="btn btn-primary font-weight-bold mr-2"
                                @click="search()"><span><i class="fa fa-search"></i><span>查询</span></span></b-button>
                            <b-button :pressed="false" variant="btn btn-light font-weight-bold mr-2"
                                @click="resetAll()"> <span><span>清空条件</span></span></b-button>
                        </div>
                    </div>
                    <div class="m-portlet__foot m-portlet__no-border m-portlet__foot--fit">
                        <div class="m-form__actions m-form__actions--solid">
                            <div class="row">
                                <div class="col m--align-left">
                                    <button class="btn btn-light-success font-weight-bold mr-2 " @click="addOmpRedisConfig">
                                        <span><i class="la la-plus la-lg"></i><span>新 增</span></span>
                                    </button>

                                    <button class="btn btn-light-primary font-weight-bold mr-2" @click="updateOmpRedisConfig"
                                        :disabled="this.sels.length != 1">
                                        <span><i class="la la-pen-alt"></i><span>编 辑</span></span>
                                    </button>
                                    <!-- :disabled="this.sels.length === 0" 如果没有数据让删除按钮失效 -->
                                    <button class="btn btn-light-danger font-weight-bold mr-2" @click="delOmpRedisConfig"
                                        :disabled="this.sels.length === 0">
                                        <span><i class="far fa-trash-alt"></i><span>删 除</span></span>
                                    </button>
                                </div>
                                <div class="col m--align-right">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--分页组件-->
            <el-table style="width: 100%" stripe border @selection-change="handleSelectionChange" highlight-current-row
                :data="dataList">
                <!-- 复选框 -->
                <el-table-column type="selection" width="40"></el-table-column>
                <el-table-column label="序号" min-width="50">
                    <template slot-scope="scope">
                        {{ scope.$index + 1 }}
                    </template>
                </el-table-column>
                <el-table-column align="left" prop="name" show-overflow-tooltip label="名称"></el-table-column>
                <el-table-column align="left" prop="host" show-overflow-tooltip label="ip"></el-table-column>
                <el-table-column align="left" prop="port" show-overflow-tooltip label="端口"></el-table-column>
                <el-table-column align="left" prop="password" show-overflow-tooltip label="密码"></el-table-column>
                <el-table-column align="left" prop="runStatus" show-overflow-tooltip label="状态">
                    <template slot-scope="scope">
                        <div v-if="scope.row.runStatus == true">
                            <b-badge class="mr-1" variant="primary">运行中</b-badge>
                        </div>
                        <div v-else>
                            <b-badge class="mr-1" variant="danger">中断</b-badge>
                        </div>
                    </template>
                </el-table-column>
                
                <el-table-column align="left" prop="redisVersion" show-overflow-tooltip label="版本"></el-table-column>
                <el-table-column align="left" prop="connectedClients" show-overflow-tooltip label="连接数"></el-table-column>
                <el-table-column align="left" prop="os" show-overflow-tooltip label="宿主机操作系统" min-width="150"></el-table-column>
                <el-table-column align="left" prop="redisMode" show-overflow-tooltip label="运行模式"></el-table-column>
                <el-table-column align="center" prop="createBy"  label="创建人" min-width="150"></el-table-column>
                <el-table-column align="center" prop="createTime"  label="创建时间" min-width="180"></el-table-column>
                <el-table-column align="center" prop="modifiedBy"  label="修改人" min-width="150"></el-table-column>
                <el-table-column align="center" prop="updateTime"  label="修改时间" min-width="180"></el-table-column>
                <el-table-column align="center" label="操作" fixed="left" min-width="180">
                    <template slot-scope="scope">
                        <!--scope.row当前行的对象-->
                        <a href="javascript:;" @click="getDetail(scope.row)" class="btn btn-sm btn-clean btn-icon"
                            title="详情">
                            <span class="svg-icon svg-icon-primary svg-icon-2x">
                                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                                    width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                        <rect x="0" y="0" width="24" height="24" />
                                        <path
                                            d="M19.2078777,9.84836149 C20.3303823,11.0178941 21,12 21,12 C21,12 16.9090909,18 12,18 C11.6893441,18 11.3879033,17.9864845 11.0955026,17.9607365 L19.2078777,9.84836149 Z"
                                            fill="#000000" fill-rule="nonzero" />
                                        <path
                                            d="M14.5051465,6.49485351 L12,9 C10.3431458,9 9,10.3431458 9,12 L5.52661464,15.4733854 C3.75006453,13.8334911 3,
                                      12 3,12 C3,12 5.45454545,6 12,6 C12.8665422,6 13.7075911,6.18695134 14.5051465,6.49485351 Z"
                                            fill="#000000" fill-rule="nonzero" />
                                        <rect fill="#000000" opacity="0.3"
                                            transform="translate(12.524621, 12.424621) rotate(-45.000000) translate(-12.524621, -12.424621) "
                                            x="3.02462111" y="11.4246212" width="19" height="2" />
                                    </g>
                                </svg>
                            </span>
                        </a>

                        <a href="javascript:;" @click="redisMonitor(scope.row)" class="btn btn-sm btn-clean btn-icon"
                            title="监控">
                            <span class="svg-icon svg-icon-primary svg-icon-2x">
                                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                        <rect x="0" y="0" width="24" height="24"/>
                                        <path d="M5,19 L20,19 C20.5522847,19 21,19.4477153 21,20 C21,20.5522847 20.5522847,
                                        21 20,21 L4,21 C3.44771525,21 3,20.5522847 3,20 L3,4 C3,3.44771525 3.44771525,3 4,3 C4.55228475,3 5,3.44771525 5,
                                        4 L5,19 Z" fill="#000000" fill-rule="nonzero"/>
                                        <path d="M8.7295372,14.6839411 C8.35180695,15.0868534 7.71897114,15.1072675 7.31605887,14.7295372 C6.9131466,
                                        14.3518069 6.89273254,
                                        13.7189711 7.2704628,13.3160589 L11.0204628,9.31605887 C11.3857725,8.92639521 11.9928179,8.89260288 12.3991193,
                                        9.23931335 L15.358855,11.7649545 L19.2151172,6.88035571 C19.5573373,6.44687693 20.1861655,6.37289714 20.6196443,
                                        6.71511723 C21.0531231,7.05733733 21.1271029,7.68616551 20.7848828,8.11964429 L16.2848828,13.8196443 C15.9333973,
                                        14.2648593 15.2823707,14.3288915 14.8508807,13.9606866 L11.8268294,11.3801628 L8.7295372,14.6839411 Z" fill="#000000" fill-rule="nonzero" opacity="0.3"/>
                                    </g>
                                </svg>
                            </span>
                        </a>
                    </template>
                </el-table-column>
            </el-table>
            <div class="block">
                <el-pagination hide-on-single-page @size-change="handleSizeChange" @current-change="handleCurrentChange"
                    :current-page="pageNo" :page-sizes="[5, 10, 30, 50]" :page-size="pageSize"
                    layout="->,total, sizes, prev, pager, next, jumper" :total="totalCount">
                </el-pagination>
            </div>
        </div>
        <OmpRedisConfigAdd ref="ompRedisConfigAddRef" @change="search"></OmpRedisConfigAdd><!--采用父窗口关闭传递的方法-->
        <OmpRedisConfigUpdate ref="ompRedisConfigUpdateRef" @change="search"></OmpRedisConfigUpdate><!--采用父窗口关闭传递的方法-->
        <OmpRedisConfigDetail ref="ompRedisConfigDetailRef"></OmpRedisConfigDetail>
        <OmpRedisMonitor ref="OmpRedisMonitorRef"></OmpRedisMonitor>
    </div>
</template>
  
<script>
import { SET_BREADCRUMB } from "@/store/breadcrumbs.module";
import OmpRedisConfigAdd from "@/view/omp/rds/omp-redis-config/omp-redis-config-add.vue";
import OmpRedisConfigUpdate from "@/view/omp/rds/omp-redis-config/omp-redis-config-update.vue";
import OmpRedisConfigDetail from "@/view/omp/rds/omp-redis-config/omp-redis-config-detail.vue";
import OmpRedisMonitor from "@/view/omp/rds/omp-redis-config/omp-redis-monitor.vue";

import Swal from "sweetalert2";
import apiUtil from "@/core/util/apiUtil.js";
import { handleNotify, handleAlert, handleConfirm, showWating, closeWating } from "@/core/util/jehcUtil.js";
export default {
    data() {
        return {
            searchForm: { name: "" },
            dataList: [],
            sels: [], //当前选框选中的值
            pageNo: 1,      // 默认当前是第一页
            pageSize: 5,    // 当前每页的数据是5条
            totalCount: 0   // 总数默认为0
        }
    },
    components: {
        OmpRedisConfigAdd,
        OmpRedisConfigUpdate,
        OmpRedisConfigDetail,
        OmpRedisMonitor,
    },
    mounted() {
        this.$store.dispatch(SET_BREADCRUMB, [{ title: "Redis配置" }]);
        this.initList();   // 按当前的页号和每页的数据量进行查询
    },
    methods: {
        initList() {
            showWating({ renderBody: "tableBody" });
            var params = {};
            params.usePageNo = true;//采用第几页进行分页（兼容）
            params.pageSize = this.pageSize;//页面显示记录条数，在页面显示每页显示多少项的时候
            params.pageNo = this.pageNo;//开始的记录序号   
            params.searchJson = JSON.stringify(this.searchForm);//为form元素     
            apiUtil.queryPage(process.env.VUE_APP_OMP_API + "/omp/redisConfig/list", params).then(({ data }) => {
                this.dataList = data.data;//给结果集赋值
                this.totalCount = data.total;// 获取当前数据的总数    
            });
        },

        handleSelectionChange(sels) {//获取选中的值
            this.sels = sels;
            console.log("选中的值", sels.map((item) => item.id));
        },
        addOmpRedisConfig() {//新建
            this.$refs.ompRedisConfigAddRef.showModal()
        },
        updateOmpRedisConfig() {// 更新
            if (this.sels.length != 1) {
                handleAlert("请选择一条数据", "warning", 3)
                return;
            }
            let id = this.sels.map((item) => item.id);
            this.$refs.ompRedisConfigUpdateRef.showModal(id);
        },
        delOmpRedisConfig() { // 删除
            if (this.sels.length === 0) {
                handleAlert("请选择删除的数据", "warning", 3)
                return;
            }
            // 删除前提示
            this.$confirm("确认删除记录吗?", "提示", { type: "warning", }).then(() => {
                let ids = this.sels.map((item) => item.id);
                apiUtil.delete(process.env.VUE_APP_OMP_API + "/omp/redisConfig/delete?id=" + ids.join(",")).then(data => {
                    if (data.data.success) {
                        handleAlert("删除成功", "success", 3);
                        this.search();
                    } else {
                        handleAlert("删除失败", "error", 3);
                    }
                });
            }).catch(() => { });//注意这里，这里是重点！！！;        
        },
        handleSizeChange(val) { // 修改每页所存数据量的值所触发的函数
            this.pageSize = val;  // 修改页的大小
            this.initList();       // 按新的pageNo和pageSize进行查询
        },
        handleCurrentChange(val) { // 修改当前页所触发的函数
            this.pageNo = val;       // 更新当前的页
            this.initList();          // 按新的pageNo和pageSize进行查询
        },
        search() {
            this.pageNo = 1;       // 更新当前的页
            this.initList();          // 按新的pageNo和pageSize进行查询
        },
        resetAll() {
            Object.assign(this.$data.searchForm, this.$options.data().searchForm);
            this.search();
        },
        getDetail(row) {
            this.$refs.ompRedisConfigDetailRef.showModal(row.id);
        },
        redisMonitor(row){
            this.$refs.OmpRedisMonitorRef.showModal(row.id,row.host);
        },
    }
};
</script>