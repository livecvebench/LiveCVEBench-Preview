"""
Vulnerability tests for SQL injection in product update functionality.

These tests verify the SQL injection vulnerability status:
- FAIL in vulnerable state (vulnerability is exploitable)
- PASS in fixed state (vulnerability is mitigated)
"""

import requests
import time

BASE_URL = "http://localhost"
TIMEOUT = 15


class TestTimeBasedSQLInjection:
    """
    Test for time-based blind SQL injection.

    The vulnerability allows injecting SLEEP() commands via the 'id' parameter.
    - Before fix: SLEEP() is executed, causing delay
    - After fix: Prepared statements prevent injection, no delay
    """

    def test_sleep_injection_primary(self):
        """Test SLEEP injection via id parameter - primary attack vector."""
        payload = "2' AND SLEEP(3)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay (injection should not work)
        assert elapsed < 2, f"SQL injection detected! Response took {elapsed:.2f}s - SLEEP injection executed"

    def test_sleep_injection_variant_subquery(self):
        """Test SLEEP injection using subquery format."""
        payload = "2' AND (SELECT 2542 FROM (SELECT(SLEEP(3)))XRsk) AND 'UqfZ'='UqfZ"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        assert elapsed < 2, f"SQL injection detected! Subquery SLEEP took {elapsed:.2f}s"

    def test_sleep_injection_benchmark(self):
        """Test using nested SLEEP as alternative timing attack."""
        # Use nested query approach that's proven to work
        payload = "2' AND (SELECT * FROM (SELECT SLEEP(3))a)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # Benchmark typically takes time if vulnerable
        assert elapsed < 2, f"SQL injection detected! Nested SLEEP took {elapsed:.2f}s"

    def test_conditional_sleep(self):
        """Test conditional SLEEP injection with IF statement."""
        payload = "2' AND IF(1=1,SLEEP(3),0)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        assert elapsed < 2, f"SQL injection detected! IF SLEEP took {elapsed:.2f}s"


class TestBooleanBasedSQLInjection:
    """
    Test for boolean-based blind SQL injection.

    In vulnerable state: time-based variant shows injection works
    After fix: no delay occurs, test passes
    """

    def test_boolean_true_false_consistency(self):
        """Test boolean-based injection with time delay for detection."""
        # When vulnerable, this will cause a delay because the condition is evaluated
        payload = "2' AND IF(1=1,SLEEP(3),0) AND '1'='1"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay
        assert elapsed < 2, f"Boolean SQL injection detected! Response took {elapsed:.2f}s"

    def test_or_1_equals_1_injection(self):
        """Test injection with CASE statement and SLEEP."""
        # Using CASE WHEN for conditional SLEEP
        payload = "2' AND CASE WHEN 1=1 THEN SLEEP(3) ELSE 0 END-- -"
        data = {
            "id": payload,
            "name": "Injected",
            "prize": "999",
            "description": "Should not affect multiple rows",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay
        assert elapsed < 2, f"CASE-based SQL injection detected! Response took {elapsed:.2f}s"


class TestErrorBasedSQLInjection:
    """
    Test for error-based SQL injection with time-based verification.
    """

    def test_extractvalue_injection(self):
        """Test injection with ELT function and SLEEP."""
        # Use ELT function with SLEEP
        payload = "2' AND ELT(1,SLEEP(3))-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay
        assert elapsed < 2, f"ELT SQL injection detected! Response took {elapsed:.2f}s"

    def test_updatexml_injection(self):
        """Test injection with MAKE_SET and SLEEP."""
        payload = "2' AND MAKE_SET(1,SLEEP(3))-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay
        assert elapsed < 2, f"MAKE_SET SQL injection detected! Response took {elapsed:.2f}s"


class TestUnionBasedSQLInjection:
    """
    Test for UNION-based SQL injection with time-based verification.
    """

    def test_union_select_injection(self):
        """Test injection with COALESCE and SLEEP."""
        # COALESCE with SLEEP
        payload = "2' AND COALESCE(SLEEP(3),0)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay
        assert elapsed < 2, f"COALESCE SQL injection detected! Response took {elapsed:.2f}s"

    def test_union_column_enumeration(self):
        """Test UNION-based column enumeration with time-based detection."""
        # Use ORDER BY with subquery SLEEP for detection
        payload = "2' AND (SELECT SLEEP(3) FROM DUAL WHERE 1=1)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay
        assert elapsed < 2, f"Column enumeration SQL injection detected! Response took {elapsed:.2f}s"


class TestStackedQueriesInjection:
    """
    Test for SQL injection via alternate methods.
    Note: mysqli_query doesn't support stacked queries, so we use time-based alternative.
    """

    def test_stacked_query_injection(self):
        """Test injection via comment bypass with time-based detection."""
        # Use inline comment with SLEEP for detection
        payload = "2'/**/AND/**/SLEEP(3)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay
        assert elapsed < 2, f"Comment bypass SQL injection may have worked! Took {elapsed:.2f}s"


class TestEncodedPayloads:
    """
    Test injection with various payload formats.
    """

    def test_url_encoded_quote(self):
        """Test with different SLEEP function call."""
        # Use alternative SLEEP syntax
        payload = "2' AND (SELECT SLEEP(3) FROM dual)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        assert elapsed < 2, f"Subquery-based injection may have worked! Took {elapsed:.2f}s"

    def test_double_quote_injection(self):
        """Test injection with hex encoding."""
        # Use hex-encoded value with SLEEP
        payload = "2' AND 0x31=0x31 AND SLEEP(3)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        assert elapsed < 2, f"Hex-encoded injection may have worked! Took {elapsed:.2f}s"


class TestDataExfiltration:
    """
    Test for data exfiltration with time-based detection.
    """

    def test_no_password_leakage(self):
        """Verify injection point works using time-based detection."""
        # Use conditional SLEEP based on database content
        payload = "2' AND IF((SELECT COUNT(*) FROM admininfo)>0,SLEEP(3),0)-- -"
        data = {
            "id": payload,
            "name": "Test",
            "prize": "100",
            "description": "Test",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=TIMEOUT)
        elapsed = time.time() - start_time

        # After fix, should NOT have delay - this proves prepared statements are in use
        assert elapsed < 2, f"Data exfiltration SQL injection detected! Response took {elapsed:.2f}s"
