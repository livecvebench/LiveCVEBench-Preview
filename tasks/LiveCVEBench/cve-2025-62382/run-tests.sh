#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install uv for Python package management
echo "Installing uv..."
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize project and install test dependencies
uv init 2>/dev/null || true
uv add pytest pytest-asyncio requests 2>/dev/null

echo "Waiting for server to be available..."
# Wait for the server to be ready
for i in {1..60}; do
    if curl -s http://localhost:5000/api/exports > /dev/null 2>&1; then
        echo "Server is ready"
        break
    fi
    if [ $i -eq 60 ]; then
        echo "Server did not start in time"
        exit 1
    fi
    sleep 1
done

echo "Running tests..."
uv run pytest . -rA -v
