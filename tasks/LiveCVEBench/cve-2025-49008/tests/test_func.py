"""
Functional tests for Atheos IDE Git integration.
These tests verify that the application works correctly for legitimate use cases.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import os
import time

# API endpoint must be controller.php for proper routing
BASE_URL = os.environ.get("APP_URL", "http://localhost/controller.php")
USERNAME = os.environ.get("ATHEOS_USER", "admin")
PASSWORD = os.environ.get("ATHEOS_PASS", "admin")
TIMEOUT = 10


class TestAuthentication:
    """Test authentication functionality."""

    def test_login_with_valid_credentials(self):
        """Verify user can log in with valid credentials."""
        session = requests.Session()
        response = session.post(
            BASE_URL,
            data={
                "target": "user",
                "action": "authenticate",
                "username": USERNAME,
                "password": PASSWORD
            },
            timeout=TIMEOUT
        )

        # Check we got a response
        assert response.status_code == 200, f"Login request failed: {response.text}"

        # The response should be JSON with success status
        try:
            json_resp = response.json()
            assert json_resp.get("status") == 200 or "success" in str(json_resp).lower(), \
                f"Login response indicates failure: {json_resp}"
        except (ValueError, requests.exceptions.JSONDecodeError):
            # If not JSON, check cookies are set
            assert len(session.cookies) > 0, "No session cookies were set after login"

    def test_login_fails_with_invalid_credentials(self):
        """Verify login fails with wrong password."""
        session = requests.Session()
        response = session.post(
            BASE_URL,
            data={
                "target": "user",
                "action": "authenticate",
                "username": "invalid_user_xyz",
                "password": "wrong_password_123"
            },
            timeout=TIMEOUT
        )

        # Check response indicates failure
        try:
            json_resp = response.json()
            # Should have error status (404 for user not found)
            assert json_resp.get("status") in [404, 451, "error"] or "not found" in str(json_resp).lower(), \
                "Login should fail with invalid credentials"
        except (ValueError, requests.exceptions.JSONDecodeError):
            # Non-JSON response is also acceptable for failed login
            pass


class TestGitRepositoryOperations:
    """Test legitimate Git repository operations."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Set up an authenticated session before each test."""
        self.session = requests.Session()
        response = self.session.post(
            BASE_URL,
            data={
                "target": "user",
                "action": "authenticate",
                "username": USERNAME,
                "password": PASSWORD
            },
            timeout=TIMEOUT
        )
        assert response.status_code == 200, f"Authentication failed: {response.text}"

        # Create test directory path with proper permissions
        import subprocess
        self.test_repo_path = "/var/www/html/workspace/func_test_repo"
        os.makedirs(self.test_repo_path, exist_ok=True)
        subprocess.run(["chown", "-R", "www-data:www-data", self.test_repo_path], check=False)
        subprocess.run(["chmod", "-R", "775", self.test_repo_path], check=False)
        yield

    def test_git_init_repository(self):
        """Test initializing a new Git repository."""
        response = self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "init",
                "type": "repo",
                "repo": self.test_repo_path
            },
            timeout=TIMEOUT
        )

        # Should complete without error (may return 200 or already-exists message)
        assert response.status_code == 200, f"Unexpected status: {response.status_code}"

    def test_git_fetch_with_normal_arguments(self):
        """Test fetch with standard remote and branch names."""
        # First initialize a repo
        self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "init",
                "type": "repo",
                "repo": self.test_repo_path
            },
            timeout=TIMEOUT
        )

        # Perform fetch with normal arguments
        response = self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "transfer",
                "type": "fetch",
                "repo": self.test_repo_path,
                "remote": "origin",
                "branch": "main"
            },
            timeout=TIMEOUT
        )

        # The request should complete (may fail due to no remote, but endpoint works)
        assert response.status_code == 200, f"Unexpected response: {response.status_code}"

    def test_git_pull_with_normal_arguments(self):
        """Test pull with standard remote and branch names."""
        self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "init",
                "type": "repo",
                "repo": self.test_repo_path
            },
            timeout=TIMEOUT
        )

        response = self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "transfer",
                "type": "pull",
                "repo": self.test_repo_path,
                "remote": "origin",
                "branch": "main"
            },
            timeout=TIMEOUT
        )

        # May fail due to no remote configured, but endpoint should respond
        assert response.status_code == 200, f"Unexpected response: {response.status_code}"

    def test_git_push_with_normal_arguments(self):
        """Test push with standard remote and branch names."""
        self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "init",
                "type": "repo",
                "repo": self.test_repo_path
            },
            timeout=TIMEOUT
        )

        response = self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "transfer",
                "type": "push",
                "repo": self.test_repo_path,
                "remote": "origin",
                "branch": "main"
            },
            timeout=TIMEOUT
        )

        # May fail due to no remote configured, but endpoint should respond
        assert response.status_code == 200, f"Unexpected response: {response.status_code}"

    def test_git_operations_with_special_branch_names(self):
        """Test that legitimate branch names with special characters work."""
        self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "init",
                "type": "repo",
                "repo": self.test_repo_path
            },
            timeout=TIMEOUT
        )

        # Test various legitimate branch naming patterns
        special_branches = [
            "feature/new-feature",
            "bugfix/issue-123",
            "release/v1.0.0",
            "hotfix_urgent",
        ]

        for branch in special_branches:
            response = self.session.post(
                BASE_URL,
                data={
                    "target": "codegit",
                    "action": "transfer",
                    "type": "fetch",
                    "repo": self.test_repo_path,
                    "remote": "origin",
                    "branch": branch
                },
                timeout=TIMEOUT
            )

            # Should not crash - response code 200 means endpoint works
            assert response.status_code == 200, \
                f"Unexpected response for branch '{branch}': {response.status_code}"


class TestServerStability:
    """Test that the server remains stable under various inputs."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Set up an authenticated session."""
        self.session = requests.Session()
        self.session.post(
            BASE_URL,
            data={
                "target": "user",
                "action": "authenticate",
                "username": USERNAME,
                "password": PASSWORD
            },
            timeout=TIMEOUT
        )
        import subprocess
        self.test_repo_path = "/var/www/html/workspace/stability_test_repo"
        os.makedirs(self.test_repo_path, exist_ok=True)
        subprocess.run(["chown", "-R", "www-data:www-data", self.test_repo_path], check=False)
        subprocess.run(["chmod", "-R", "775", self.test_repo_path], check=False)

    def test_server_responds_after_invalid_transfer_type(self):
        """Test server handles invalid transfer type gracefully."""
        response = self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "transfer",
                "type": "invalid_type",
                "repo": self.test_repo_path,
                "remote": "origin",
                "branch": "main"
            },
            timeout=TIMEOUT
        )

        # Should return a response (any status means server handled it)
        assert response.status_code in [200, 417, 418, 500], \
            f"Unexpected status: {response.status_code}"

    def test_server_responds_after_missing_parameters(self):
        """Test server handles missing parameters gracefully."""
        response = self.session.post(
            BASE_URL,
            data={
                "target": "codegit",
                "action": "transfer",
                "type": "fetch"
                # Missing repo, remote, branch
            },
            timeout=TIMEOUT
        )

        # Should return 417 for missing parameters - server handled the request
        assert response.status_code in [200, 417], \
            f"Unexpected status: {response.status_code}"


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-rA"])
