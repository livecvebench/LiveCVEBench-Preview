#!/bin/bash
#
# Solution script for ProcessWire ZIP extraction resource exhaustion vulnerability (CVE-2025-60790)
#
# This script applies the fix by adding pre-extraction validation to the unzip() method
# to prevent ZIP bombs and resource exhaustion attacks.
#
set -e

# ProcessWire is installed at /var/www/html
APP_DIR="/var/www/html"
cd "$APP_DIR"

echo "Applying ZIP extraction validation fix..."

# Step 1: Backup the original WireFileTools.php
echo "Backing up original WireFileTools.php..."
cp "$APP_DIR/wire/core/WireFileTools.php" "$APP_DIR/wire/core/WireFileTools.php.bak"

# Step 2: Apply the fix by inserting pre-extraction validation into the unzip() method
# The fix adds validation checks BEFORE extraction to reject:
# - ZIPs with too many files (>1000)
# - ZIPs with excessive uncompressed size (>100MB)
# - ZIPs with excessive directory depth (>10 levels)

echo "Patching WireFileTools.php with validation..."

# Use PHP to patch the file since it's more reliable for complex string replacements
php << 'PHPEOF'
<?php
$filePath = '/var/www/html/wire/core/WireFileTools.php';
$content = file_get_contents($filePath);

// The vulnerable unzip method signature
$oldMethodSignature = 'public function unzip($file, $dst) {';

// Check if already patched
if (strpos($content, 'maxFiles') !== false && strpos($content, 'CVE-2025-60790') !== false) {
    echo "File already patched, skipping...\n";
    exit(0);
}

// Find the unzip method and insert validation code after the initial checks
// We need to add validation BEFORE the extraction loop

// The validation code to insert after initial checks and before the extraction loop
$validationCode = '
		// === CVE-2025-60790 FIX: Pre-extraction validation ===
		// Validate ZIP contents before extraction to prevent resource exhaustion
		$maxFiles = 1000;        // Maximum number of files allowed
		$maxTotalMB = 100;       // Maximum total uncompressed size in MB
		$maxDepth = 10;          // Maximum directory depth

		$numFiles = $zip->numFiles;
		$totalBytes = 0;
		$maxDetectedDepth = 0;

		// Check file count limit
		if($numFiles > $maxFiles) {
			$zip->close();
			$this->filesException(__FUNCTION__, "Too many files in ZIP: $numFiles exceeds limit of $maxFiles");
		}

		// Pre-scan all files to check sizes and depth
		for($j = 0; $j < $numFiles; $j++) {
			$stat = $zip->statIndex($j);
			if($stat !== false) {
				$totalBytes += $stat["size"];
				$depth = substr_count($stat["name"], "/");
				if($depth > $maxDetectedDepth) $maxDetectedDepth = $depth;
			}
		}

		// Check total size limit
		$totalMB = $totalBytes / (1024 * 1024);
		if($totalMB > $maxTotalMB) {
			$zip->close();
			$this->filesException(__FUNCTION__, "ZIP uncompressed size ({$totalMB}MB) exceeds limit of {$maxTotalMB}MB");
		}

		// Check depth limit
		if($maxDetectedDepth > $maxDepth) {
			$zip->close();
			$this->filesException(__FUNCTION__, "ZIP directory depth ($maxDetectedDepth) exceeds limit of $maxDepth");
		}
		// === END CVE-2025-60790 FIX ===

';

// Find the position to insert the validation code
// We want to insert it after: if($res !== true) $this->filesException(__FUNCTION__, "Unable to open ZIP file, error code: $res");
// And before: for($i = 0; $i < $zip->numFiles; $i++)

$searchPattern = 'if($res !== true) $this->filesException(__FUNCTION__, "Unable to open ZIP file, error code: $res");';
$insertAfter = $searchPattern . "\n";

if (strpos($content, $searchPattern) === false) {
    echo "ERROR: Could not find the expected pattern in WireFileTools.php\n";
    echo "Looking for: $searchPattern\n";
    exit(1);
}

// Insert the validation code
$content = str_replace($insertAfter, $insertAfter . $validationCode, $content);

// Save the patched file
file_put_contents($filePath, $content);
echo "WireFileTools.php patched successfully with CVE-2025-60790 fix\n";
PHPEOF

# Verify the patch was applied
echo ""
echo "Verifying patch..."
if grep -q "CVE-2025-60790" "$APP_DIR/wire/core/WireFileTools.php"; then
    echo "✓ Patch verified - CVE-2025-60790 fix is in place"
else
    echo "✗ ERROR: Patch verification failed"
    exit 1
fi

# Check PHP syntax
echo "Checking PHP syntax..."
php -l "$APP_DIR/wire/core/WireFileTools.php" || {
    echo "✗ PHP syntax error detected, restoring backup..."
    cp "$APP_DIR/wire/core/WireFileTools.php.bak" "$APP_DIR/wire/core/WireFileTools.php"
    exit 1
}

echo ""
echo "Fix applied successfully!"
echo "- WireFileTools::unzip() now validates ZIPs before extraction"
echo "- Maximum files: 1000"
echo "- Maximum uncompressed size: 100MB"
echo "- Maximum directory depth: 10"
echo ""
