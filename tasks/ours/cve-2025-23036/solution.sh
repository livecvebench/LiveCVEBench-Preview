#!/bin/bash
# Solution script for fixing the HTML encoding issue in employee pre-registration form
set -e

cd /var/www/html

# Target file
FILE="html/funcionario/pre_cadastro_funcionario.php"

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "Error: File $FILE not found"
    exit 1
fi

# Check if already fixed (idempotency check)
if grep -q "filter_input(INPUT_GET, 'msg_e'" "$FILE"; then
    echo "Fix already applied"
    exit 0
fi

# Apply the fix using sed
# Fix 1: Sanitize msg_c input
sed -i "s/\$msg = \$_GET\['msg_c'\];/\$msg = filter_input(INPUT_GET, 'msg_c', FILTER_SANITIZE_STRING);/" "$FILE"

# Fix 2: Sanitize msg_e input
sed -i "s/\$msg = \$_GET\['msg_e'\];/\$msg = filter_input(INPUT_GET, 'msg_e', FILTER_SANITIZE_STRING);/" "$FILE"

# Fix 3 & 4: Encode output with htmlspecialchars
# Need to be careful with the pattern as it appears twice in similar context
# The pattern is: '. $msg .' inside echo statements
sed -i "s/'\. \$msg \.'/'. htmlspecialchars(\$msg) .'/" "$FILE"

echo "Fix applied successfully"

# Verify the fix was applied
if grep -q "htmlspecialchars(\$msg)" "$FILE" && grep -q "filter_input(INPUT_GET" "$FILE"; then
    echo "Verification: Fix confirmed"
else
    echo "Warning: Fix may not have been applied correctly"
    exit 1
fi
