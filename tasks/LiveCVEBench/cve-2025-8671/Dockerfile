FROM debian:bullseye

WORKDIR /app
RUN if [ -f /etc/apt/sources.list.d/debian.sources ]; then \
    sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources; \
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources; \
elif [ -f /etc/apt/sources.list ]; then \
    sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list; \
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list; \
fi
# Install build dependencies and required tools
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    pkg-config \
    libssl-dev \
    zlib1g-dev \
    libyaml-dev \
    openssl \
    curl \
    procps \
    tmux \
    asciinema \
    ca-certificates \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

# Clone and build h2o at vulnerable commit
RUN git clone https://github.com/h2o/h2o.git . && \
    git checkout db98b59ba7abfcd1dc9b43ea4b9ad1052aba775e && \
    git submodule update --init --recursive && \
    rm -rf .git && \
    cmake . -DWITH_MRUBY=OFF && \
    make h2o -j$(nproc)

# Setup directories
RUN mkdir -p /etc/h2o /var/www/html /var/log/h2o

# Generate SSL certificate
RUN openssl req -x509 -newkey rsa:2048 \
    -keyout /etc/h2o/server.key \
    -out /etc/h2o/server.crt \
    -days 365 -nodes \
    -subj "/CN=localhost"

# Copy configuration
COPY task-deps/h2o.conf /etc/h2o/h2o.conf


COPY task-deps/index.html /var/www/html/index.html
# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 8080 8081

# CMD ["/entrypoint.sh"]
