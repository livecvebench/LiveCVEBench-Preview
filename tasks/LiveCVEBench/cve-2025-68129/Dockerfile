FROM php:8.1-cli

WORKDIR /app

# Install system dependencies (including tmux, asciinema, curl as required)
RUN apt-get update && apt-get install -y \
    libzip-dev \
    unzip \
    git \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Clone vulnerable version of auth0-PHP (8.17.0) and remove git history
RUN git clone --depth 1 --branch 8.17.0 https://github.com/auth0/auth0-PHP.git . \
    && rm -rf .git

# Install composer dependencies with increased memory limit
ENV COMPOSER_MEMORY_LIMIT=-1
RUN composer install --no-interaction

# Copy task-deps files after repository clone to potentially overwrite source files
# These contain the vulnerable version of files needed for testing
COPY task-deps/Token.php /app/src/Token.php
COPY task-deps/InvalidTokenException.php /app/src/Exception/InvalidTokenException.php
COPY task-deps/TokenGenerator.php /app/tests/Utilities/TokenGenerator.php
COPY task-deps/TokenTest.php /app/tests/Unit/TokenTest.php

# Keep container running (library, no server)
# CMD ["tail", "-f", "/dev/null"]
