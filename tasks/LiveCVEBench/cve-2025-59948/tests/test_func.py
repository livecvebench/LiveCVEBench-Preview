"""
Functional tests for FreshRSS query API endpoint.
These tests verify the application works correctly in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os

# Configuration
BASE_URL = os.environ.get("BASE_URL", "http://localhost:80")
TEST_USER = os.environ.get("TEST_USER", "admin")
TEST_TOKEN = os.environ.get("TEST_TOKEN", "testtoken123")

# Wait for application to be ready
MAX_WAIT_TIME = 60
RETRY_INTERVAL = 2


@pytest.fixture(scope="module", autouse=True)
def wait_for_application():
    """Wait for the FreshRSS application to be ready."""
    start_time = time.time()
    while time.time() - start_time < MAX_WAIT_TIME:
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302, 401]:
                # Give it a moment to fully initialize
                time.sleep(2)
                return
        except requests.exceptions.RequestException:
            pass
        time.sleep(RETRY_INTERVAL)
    pytest.fail(f"Application did not become ready within {MAX_WAIT_TIME} seconds")


class TestAPIEndpointAvailability:
    """Test that the query API endpoint is accessible and responds."""

    def test_query_endpoint_exists(self):
        """Verify the query.php endpoint exists and responds."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )
        # Should get a response (even if it's an error about invalid token)
        assert response.status_code in [200, 404, 422, 503], \
            f"Unexpected status code: {response.status_code}"

    def test_query_endpoint_rejects_invalid_format(self):
        """Verify the endpoint rejects invalid format parameter."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "invalid_format"},
            timeout=10
        )
        assert response.status_code == 422, \
            f"Expected 422 for invalid format, got {response.status_code}"
        assert "Invalid format" in response.text

    def test_query_endpoint_rejects_invalid_token(self):
        """Verify the endpoint rejects invalid token format."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": "!@#$%", "f": "html"},
            timeout=10
        )
        assert response.status_code == 422, \
            f"Expected 422 for invalid token, got {response.status_code}"
        assert "Invalid token" in response.text

    def test_query_endpoint_rejects_invalid_user(self):
        """Verify the endpoint rejects invalid user format."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": "!@#$%invalid", "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )
        assert response.status_code == 422, \
            f"Expected 422 for invalid user, got {response.status_code}"
        assert "Invalid user" in response.text


class TestMultipleFormats:
    """Test that different format parameters are accepted."""

    @pytest.mark.parametrize("format_type", ["html", "rss", "atom", "json", "opml"])
    def test_format_accepted(self, format_type):
        """Verify each format type is accepted as a valid parameter."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": format_type},
            timeout=10
        )
        # Should not get 422 for format validation
        # Might get 404 (user/query not found) or 503 (API disabled)
        assert response.status_code != 422 or "Invalid format" not in response.text, \
            f"Format '{format_type}' was unexpectedly rejected"


class TestCORSHeaders:
    """Test that CORS headers are properly set (if implemented by the version)."""

    @pytest.mark.skip(reason="CORS headers not implemented in FreshRSS 1.26.3 - not related to this bug")
    def test_cors_headers_present(self):
        """Verify CORS headers are set for API responses."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )
        # CORS headers should be present regardless of request result
        assert "Access-Control-Allow-Origin" in response.headers, \
            "Missing Access-Control-Allow-Origin header"
        assert response.headers.get("Access-Control-Allow-Origin") == "*", \
            "Access-Control-Allow-Origin should be '*'"

    @pytest.mark.skip(reason="CORS headers not implemented in FreshRSS 1.26.3 - not related to this bug")
    def test_cors_methods_header(self):
        """Verify Access-Control-Allow-Methods header is set."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )
        assert "Access-Control-Allow-Methods" in response.headers, \
            "Missing Access-Control-Allow-Methods header"
        assert "GET" in response.headers.get("Access-Control-Allow-Methods", ""), \
            "Access-Control-Allow-Methods should include GET"


class TestCacheHeaders:
    """Test that cache control headers are properly set."""

    def test_cache_control_present(self):
        """Verify Cache-Control header is set."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )
        assert "Cache-Control" in response.headers, \
            "Missing Cache-Control header"


class TestContentTypeHeaders:
    """Test that correct Content-Type headers are returned for different formats."""

    def test_html_content_type(self):
        """Verify HTML format returns appropriate content type."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )
        # If we get a successful response, check content type
        if response.status_code == 200:
            content_type = response.headers.get("Content-Type", "")
            assert "text/html" in content_type.lower() or response.status_code != 200, \
                f"Expected text/html content type, got {content_type}"

    def test_rss_content_type(self):
        """Verify RSS format returns appropriate content type."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "rss"},
            timeout=10
        )
        if response.status_code == 200:
            content_type = response.headers.get("Content-Type", "")
            assert "xml" in content_type.lower() or "rss" in content_type.lower(), \
                f"Expected XML/RSS content type, got {content_type}"

    def test_json_content_type(self):
        """Verify JSON format returns appropriate content type."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "json"},
            timeout=10
        )
        if response.status_code == 200:
            content_type = response.headers.get("Content-Type", "")
            assert "json" in content_type.lower(), \
                f"Expected JSON content type, got {content_type}"


class TestAPIServiceStatus:
    """Test API service availability."""

    def test_api_responds(self):
        """Verify the API endpoint responds to requests."""
        try:
            response = requests.get(
                f"{BASE_URL}/api/query.php",
                params={"user": "testuser", "t": "abc123", "f": "html"},
                timeout=10
            )
            # Any response means the API is working
            assert response.status_code is not None
        except requests.exceptions.Timeout:
            pytest.fail("API endpoint timed out")
        except requests.exceptions.ConnectionError:
            pytest.fail("Could not connect to API endpoint")
