#!/usr/bin/env python3
"""
Functional tests for OpenVPN CMS Flask application.
These tests verify that the application works correctly and should PASS
in both vulnerable and fixed states.
"""

import os
import pytest
import requests
import time

BASE_URL = os.environ.get("APP_URL", "http://localhost:5000")
DEFAULT_USERNAME = "super"
DEFAULT_PASSWORD = "openvpn@123456"


class TestAuthentication:
    """Test authentication functionality."""

    def test_login_with_valid_credentials(self):
        """Test that login with valid credentials returns a JWT token."""
        login_url = f"{BASE_URL}/cms/user/login"
        params = {"username": DEFAULT_USERNAME, "password": DEFAULT_PASSWORD}

        response = requests.post(login_url, params=params, timeout=10)

        assert response.status_code == 200, f"Login failed with status {response.status_code}: {response.text}"
        data = response.json()
        assert "access_token" in data, f"No access_token in response: {data}"
        assert len(data["access_token"]) > 0, "Access token is empty"

    def test_login_with_invalid_credentials(self):
        """Test that login with invalid credentials fails appropriately."""
        login_url = f"{BASE_URL}/cms/user/login"
        params = {"username": "nonexistent", "password": "wrongpassword"}

        response = requests.post(login_url, params=params, timeout=10)

        # Should not return 200 with valid token
        if response.status_code == 200:
            data = response.json()
            # If it returns 200, it should not have a valid access_token for wrong credentials
            assert data.get("code") != 0 or "access_token" not in data

    def test_protected_endpoint_without_auth(self):
        """Test that protected endpoints require authentication."""
        openvpn_url = f"{BASE_URL}/v1/openvpn"
        payload = {"username": "testuser", "nickname": "test", "summary": "test"}

        response = requests.post(openvpn_url, json=payload, timeout=10)

        # Should fail without authorization header
        assert response.status_code in [401, 403, 422], \
            f"Expected auth failure, got {response.status_code}: {response.text}"


class TestUserCreation:
    """Test user creation functionality."""

    @pytest.fixture
    def auth_token(self):
        """Get authentication token for tests."""
        login_url = f"{BASE_URL}/cms/user/login"
        params = {"username": DEFAULT_USERNAME, "password": DEFAULT_PASSWORD}

        response = requests.post(login_url, params=params, timeout=10)
        assert response.status_code == 200, f"Login failed: {response.text}"
        return response.json()["access_token"]

    def test_create_user_with_valid_alphanumeric_username(self, auth_token):
        """Test creating a user with a valid alphanumeric username."""
        openvpn_url = f"{BASE_URL}/v1/openvpn"
        headers = {"Authorization": f"Bearer {auth_token}"}
        # Use timestamp to make unique username
        unique_suffix = str(int(time.time()))[-6:]
        payload = {
            "username": f"testuser{unique_suffix}",
            "nickname": "Test User",
            "summary": "Test user creation"
        }

        response = requests.post(openvpn_url, headers=headers, json=payload, timeout=10)

        # The endpoint should accept the request (may fail on vpnuser binary but that's OK)
        # We're testing that the API accepts valid usernames
        assert response.status_code in [200, 201, 400, 500], \
            f"Unexpected status code: {response.status_code}"

    def test_create_user_requires_username(self, auth_token):
        """Test that username is required for user creation."""
        openvpn_url = f"{BASE_URL}/v1/openvpn"
        headers = {"Authorization": f"Bearer {auth_token}"}
        payload = {
            "nickname": "Test User",
            "summary": "Test without username"
        }

        response = requests.post(openvpn_url, headers=headers, json=payload, timeout=10)

        # Should fail due to missing username
        assert response.status_code in [400, 422], \
            f"Expected validation error, got {response.status_code}: {response.text}"

    def test_create_user_with_empty_username(self, auth_token):
        """Test that empty username is rejected."""
        openvpn_url = f"{BASE_URL}/v1/openvpn"
        headers = {"Authorization": f"Bearer {auth_token}"}
        payload = {
            "username": "",
            "nickname": "Test User",
            "summary": "Test with empty username"
        }

        response = requests.post(openvpn_url, headers=headers, json=payload, timeout=10)

        # Should fail due to empty username
        assert response.status_code in [400, 422], \
            f"Expected validation error, got {response.status_code}: {response.text}"


class TestApplicationHealth:
    """Test basic application health."""

    def test_application_is_running(self):
        """Test that the application responds to requests."""
        try:
            response = requests.get(BASE_URL, timeout=10)
            # Any response means the app is running
            assert response.status_code is not None
        except requests.exceptions.ConnectionError:
            pytest.fail(f"Cannot connect to application at {BASE_URL}")

    def test_login_endpoint_exists(self):
        """Test that the login endpoint exists."""
        login_url = f"{BASE_URL}/cms/user/login"
        response = requests.post(login_url, params={}, timeout=10)

        # Should not return 404
        assert response.status_code != 404, "Login endpoint not found"

    def test_openvpn_endpoint_exists(self):
        """Test that the openvpn endpoint exists."""
        openvpn_url = f"{BASE_URL}/v1/openvpn"
        response = requests.post(openvpn_url, json={}, timeout=10)

        # Should not return 404 (401/403 for auth failure is expected)
        assert response.status_code != 404, "OpenVPN endpoint not found"
