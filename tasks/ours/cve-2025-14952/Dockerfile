FROM php:7.4-apache

WORKDIR /var/www/html

# Install system dependencies including unzip for extracting the application
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    unzip \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Install mysqli extension for MySQL connectivity
RUN docker-php-ext-install mysqli

# Copy the application zip and extract it
COPY task-deps/Supply_Management_System.zip /tmp/Supply_Management_System.zip
RUN unzip /tmp/Supply_Management_System.zip -d /var/www/html/ && \
    rm /tmp/Supply_Management_System.zip

# Update database configuration to use 'db' as the MySQL host (docker service name)
# Update both config files to ensure consistency
RUN sed -i "s/\$mysql_host='localhost'/\$mysql_host='db'/g" /var/www/html/Supply_Management_System/config.php && \
    sed -i "s/\$mysql_host='localhost'/\$mysql_host='db'/g" /var/www/html/Supply_Management_System/includes/config.php && \
    sed -i "s/sourcecodester_scm_new/campcodes_scm_new/g" /var/www/html/Supply_Management_System/includes/config.php

# Set proper file permissions
RUN chown -R www-data:www-data /var/www/html/

# Enable Apache mod_rewrite (optional, but good practice)
RUN a2enmod rewrite


# Use the default apache foreground command
# CMD moved to docker-compose.yaml
# CMD ["apache2-foreground"]
