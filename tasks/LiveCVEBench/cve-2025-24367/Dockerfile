FROM ubuntu:22.04

WORKDIR /app

RUN apt-get update && apt-get install -y \
    tmux asciinema gcc g++

RUN apt-get update && apt-get install -y wget

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install system dependencies including Python for testing
RUN apt-get update && apt-get install -y \
    apache2 \
    libapache2-mod-php \
    mariadb-client \
    rrdtool \
    librrds-perl \
    snmp \
    snmpd \
    php \
    php-mysql \
    php-snmp \
    php-xml \
    php-mbstring \
    php-gd \
    php-gmp \
    php-zip \
    php-ldap \
    php-intl \
    php-curl \
    git \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Configure PHP
RUN echo "date.timezone = UTC" >> /etc/php/8.1/apache2/php.ini && \
    echo "memory_limit = 800M" >> /etc/php/8.1/apache2/php.ini && \
    echo "max_execution_time = 60" >> /etc/php/8.1/apache2/php.ini

# Enable Apache modules
RUN a2enmod rewrite

# Clone Cacti 1.2.28 source code and remove git history
RUN git clone --depth 1 --branch release/1.2.28 https://github.com/Cacti/cacti.git . && \
    rm -rf .git

# Copy source to web directory
RUN cp -r /app /var/www/html/cacti

# Create Cacti configuration file
RUN cp /var/www/html/cacti/include/config.php.dist /var/www/html/cacti/include/config.php

# Copy Apache virtual host configuration
COPY task-deps/cacti.conf /etc/apache2/sites-available/cacti.conf

# Enable the Cacti site and disable default
RUN a2ensite cacti.conf && a2dissite 000-default.conf

# Set proper permissions for Cacti directories
RUN chown -R www-data:www-data /var/www/html/cacti && \
    chmod -R 755 /var/www/html/cacti && \
    mkdir -p /var/www/html/cacti/rra /var/www/html/cacti/log /var/www/html/cacti/cache && \
    chmod -R 775 /var/www/html/cacti/rra /var/www/html/cacti/log /var/www/html/cacti/cache && \
    chown -R www-data:www-data /var/www/html/cacti/rra /var/www/html/cacti/log /var/www/html/cacti/cache

# Install Python testing dependencies
RUN pip install pytest requests beautifulsoup4

# Copy configuration files
COPY task-deps/config.php /app/config.php
COPY task-deps/init-cacti.sql /app/init-cacti.sql
COPY task-deps/docker-entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh


