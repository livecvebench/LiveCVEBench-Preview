#!/bin/bash
set -e

cd /app/sftpgo

git apply --whitespace=nowarn /tests/test.patch

cd ./internal/sftpd && go test  -timeout 30s -run ^TestRsyncOptions$ github.com/drakkan/sftpgo/v2/internal/sftpd

cd /app/sftpgo

go test -timeout 30s -run '^(TestSupportedSSHCommands|TestCommandGetFsError|TestSCPRecursiveDownloadErrors|TestSSHParseCommandPayload|TestSCPUploadError|TestRemoveNonexistentQuotaScan|TestUploadResumeInvalidOffset|TestMaxUserSessions|TestSCPCreateDirs|TestConfigsFromProvider|TestGetOSOpenFlags|TestTransferCancelFn|TestSCPFileMode|TestSFTPGetUsedQuota|TestSCPParseUploadMessage|TestTransferFailingReader|TestResolveWithRootDir|TestCertCheckerInitErrors|TestRecoverer|TestWithInvalidHome|TestSSHCmdGetFsErrors|TestSupportedSecurityOptions|TestAuthenticationErrors|TestSFTPSubSystem|TestSCPErrorsMockFs|TestUploadError|TestSSHCommandErrors|TestUnsupportedListOP|TestRsyncOptions|TestSCPCommandHandleErrors|TestSCPDownloadFileData|TestSCPTestDownloadProtocolMessages|TestListernerAcceptErrors|TestSCPInvalidEndDir|TestSSHCommandPath|TestReadWriteErrors|TestSCPProtocolMessages|TestCanReadSymlink|TestGitVirtualFolders|TestSystemCommandErrors|TestLoadRevokedUserCertsFile|TestUploadFiles|TestSSHCommandsRemoteFs|TestCommandsWithExtensionsFilter|TestSCPUploadFiledata|TestSCPRecursiveUploadErrors)$' github.com/drakkan/sftpgo/v2/internal/sftpd