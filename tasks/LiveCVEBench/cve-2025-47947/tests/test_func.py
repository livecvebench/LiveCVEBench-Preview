"""
Functional tests for ModSecurity JSON processing.
These tests verify that ModSecurity is working correctly and should
PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import json
import time
import subprocess

# Base URL for the Apache server with ModSecurity
BASE_URL = "http://localhost:80"

# Timeout for requests (in seconds)
REQUEST_TIMEOUT = 10


def wait_for_server(max_retries=30, delay=1):
    """Wait for the server to be ready."""
    for i in range(max_retries):
        try:
            response = requests.get(BASE_URL, timeout=5)
            return True
        except requests.exceptions.ConnectionError:
            time.sleep(delay)
        except requests.exceptions.Timeout:
            time.sleep(delay)
    return False


class TestModSecurityBasic:
    """Basic tests for ModSecurity functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is ready before each test."""
        assert wait_for_server(), "Server did not start in time"

    def test_server_responds(self):
        """Test that the server responds to basic requests."""
        response = requests.get(BASE_URL, timeout=REQUEST_TIMEOUT)
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"

    def test_post_request_basic(self):
        """Test that POST requests are processed."""
        response = requests.post(
            BASE_URL,
            data="test=value",
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"


class TestJSONProcessing:
    """Tests for ModSecurity JSON body processing."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is ready before each test."""
        assert wait_for_server(), "Server did not start in time"

    def test_json_simple_object(self):
        """Test that simple JSON objects are processed."""
        payload = {"name": "testuser", "value": "testdata"}
        response = requests.post(
            BASE_URL,
            json=payload,
            timeout=REQUEST_TIMEOUT
        )
        # Server should respond (may block or allow based on rules)
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"

    def test_json_array_small(self):
        """Test that small JSON arrays are processed correctly."""
        payload = {"items": [f"item{i}" for i in range(5)]}
        response = requests.post(
            BASE_URL,
            json=payload,
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"

    def test_json_nested_object(self):
        """Test that nested JSON objects are processed."""
        payload = {
            "user": {
                "name": "testuser",
                "details": {
                    "email": "test@example.com",
                    "age": 25
                }
            }
        }
        response = requests.post(
            BASE_URL,
            json=payload,
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"

    def test_json_with_special_characters(self):
        """Test JSON with special characters in values."""
        payload = {"text": "Hello <script>alert('test')</script>"}
        response = requests.post(
            BASE_URL,
            json=payload,
            timeout=REQUEST_TIMEOUT
        )
        # May be blocked by ModSecurity rules
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"

    def test_json_content_type_required(self):
        """Test that JSON content-type header is required for JSON parsing."""
        payload = '{"test": "value"}'
        # Send JSON without proper content-type
        response = requests.post(
            BASE_URL,
            data=payload,
            headers={"Content-Type": "text/plain"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"


class TestFormDataProcessing:
    """Tests for non-JSON (form data) processing."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is ready before each test."""
        assert wait_for_server(), "Server did not start in time"

    def test_form_urlencoded(self):
        """Test URL-encoded form data processing."""
        data = {"username": "testuser", "password": "testpass123"}
        response = requests.post(
            BASE_URL,
            data=data,
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"

    def test_multipart_form(self):
        """Test multipart form data processing."""
        files = {"file": ("test.txt", "test content", "text/plain")}
        data = {"description": "test file"}
        response = requests.post(
            BASE_URL,
            files=files,
            data=data,
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"


class TestServerStability:
    """Tests for server stability with various inputs."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is ready before each test."""
        assert wait_for_server(), "Server did not start in time"

    def test_multiple_requests_sequential(self):
        """Test that the server handles multiple sequential requests."""
        for i in range(10):
            payload = {"request_num": i, "data": f"test{i}"}
            response = requests.post(
                BASE_URL,
                json=payload,
                timeout=REQUEST_TIMEOUT
            )
            assert response.status_code in [200, 403, 404], \
                f"Request {i} failed with status: {response.status_code}"

    def test_empty_json_body(self):
        """Test handling of empty JSON body."""
        response = requests.post(
            BASE_URL,
            json={},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"

    def test_json_array_root(self):
        """Test JSON with array at root level."""
        payload = ["item1", "item2", "item3"]
        response = requests.post(
            BASE_URL,
            json=payload,
            timeout=REQUEST_TIMEOUT
        )
        # May be processed differently but should not crash
        assert response.status_code in [200, 400, 403, 404], \
            f"Server returned unexpected status: {response.status_code}"
