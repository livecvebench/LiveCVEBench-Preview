#!/bin/bash
set -e
cd /app

echo "Applying fix for unbounded POST body read..."

# Fix 1: Add attr_reader :bytesize_limit to query_parser.rb
# Insert after "private_constant :PARAMS_LIMIT" line
if ! grep -q "attr_reader :bytesize_limit" /app/lib/rack/query_parser.rb; then
    sed -i '/private_constant :PARAMS_LIMIT/a\
\
    attr_reader :bytesize_limit' /app/lib/rack/query_parser.rb
    echo "Added attr_reader :bytesize_limit to query_parser.rb"
else
    echo "attr_reader :bytesize_limit already present"
fi

# Fix 2: Update error message in query_parser.rb to not expose actual bytesize
# Change from: raise QueryLimitError, "total query size (#{qs.bytesize}) exceeds limit (#{@bytesize_limit})"
# To: raise QueryLimitError, "total query size exceeds limit (#{@bytesize_limit})"
if grep -q 'total query size (#{qs.bytesize}) exceeds' /app/lib/rack/query_parser.rb; then
    sed -i 's/raise QueryLimitError, "total query size (#{qs.bytesize}) exceeds limit (#{@bytesize_limit})"/raise QueryLimitError, "total query size exceeds limit (#{@bytesize_limit})"/' /app/lib/rack/query_parser.rb
    echo "Updated error message format in query_parser.rb"
else
    echo "Error message already in correct format"
fi

# Fix 3: Change unbounded read to bounded read in request.rb
# Change: form_vars = get_header(RACK_INPUT).read
# To: form_vars = get_header(RACK_INPUT).read(query_parser.bytesize_limit + 2) || ''
# Using Ruby for more reliable patching due to multi-line replacement
ruby << 'RUBY_SCRIPT'
req_path = '/app/lib/rack/request.rb'
content = File.read(req_path)

# Check if the vulnerable pattern exists
if content.include?("form_vars = get_header(RACK_INPUT).read\n")
  # Replace the unbounded read with bounded read
  old_code = "form_vars = get_header(RACK_INPUT).read\n"
  new_code = <<~CODE
    # Add 2 bytes. One to check whether it is over the limit, and a second
            # in case the slice! call below removes the last byte
            # If read returns nil, use the empty string
            form_vars = get_header(RACK_INPUT).read(query_parser.bytesize_limit + 2) || ''
  CODE

  content.gsub!(old_code, new_code)
  File.write(req_path, content)
  puts "Fixed unbounded read in request.rb"
else
  puts "request.rb already patched or pattern not found"
end
RUBY_SCRIPT

echo "Fix applied successfully"
