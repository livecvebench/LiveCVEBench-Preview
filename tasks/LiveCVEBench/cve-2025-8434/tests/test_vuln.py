"""
Vulnerability tests for NeonFlix movie streaming application.
Tests verify the authorization bypass vulnerability status.

- FAIL in vulnerable state (vulnerability is exploitable)
- PASS in fixed state (vulnerability is mitigated)
"""

import pytest
import requests
import os
import io
import time

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")


class TestUnauthorizedAdminPageAccess:
    """Test unauthorized access to admin.php page."""

    def test_admin_page_without_session_returns_redirect(self):
        """
        Test that accessing admin.php without any session redirects to login.

        Vulnerable: Returns 200 with admin form
        Fixed: Returns 302 redirect to login page
        """
        # Use fresh session (no cookies)
        response = requests.get(
            f"{BASE_URL}/admin.php",
            allow_redirects=False,
            timeout=10
        )

        # Fixed: Should redirect (302) to login page
        # Vulnerable: Returns 200 with the admin form
        assert response.status_code == 302, \
            f"Expected 302 redirect, got {response.status_code}. Admin page accessible without auth!"

    def test_admin_page_without_session_no_form_content(self):
        """
        Test that admin form is not visible without authentication.

        Vulnerable: Shows "Enter the Movie details" form
        Fixed: Redirects away, form not visible
        """
        response = requests.get(
            f"{BASE_URL}/admin.php",
            allow_redirects=True,  # Follow redirects
            timeout=10
        )

        # After following redirects, should NOT see the admin form
        content = response.text

        # The admin form has this specific heading
        assert "Enter the Movie details" not in content, \
            "Admin form content visible to unauthenticated user!"

    def test_admin_page_redirect_location(self):
        """
        Test that unauthorized access redirects to the correct login page.

        Vulnerable: No redirect
        Fixed: Redirects to user-login.php
        """
        response = requests.get(
            f"{BASE_URL}/admin.php",
            allow_redirects=False,
            timeout=10
        )

        # Should redirect
        assert response.status_code == 302, \
            f"Expected 302 redirect, got {response.status_code}"

        # Should redirect to login page
        location = response.headers.get("Location", "")
        assert "user-login.php" in location or "login" in location.lower(), \
            f"Expected redirect to login page, got: {location}"


class TestUnauthorizedAdminControlEndpoint:
    """Test unauthorized access to backend/admin_control.php."""

    def test_admin_control_post_without_session_returns_403(self):
        """
        Test that POST to admin_control.php without session returns 403.

        Vulnerable: Returns 200 or processes the upload
        Fixed: Returns 403 Forbidden
        """
        # Create minimal fake file data
        files = {
            'image': ('test.jpg', io.BytesIO(b'fake image data'), 'image/jpeg'),
            'video': ('test.mp4', io.BytesIO(b'fake video data'), 'video/mp4')
        }
        data = {
            'upload': '1',
            'mname': 'unauthorized_test_movie',
            'release': '2024',
            'genre': 'test',
            'rtime': '120',
            'desc': 'Unauthorized upload attempt'
        }

        response = requests.post(
            f"{BASE_URL}/backend/admin_control.php",
            files=files,
            data=data,
            allow_redirects=False,
            timeout=10
        )

        # Fixed: Should return 403 Forbidden
        # Vulnerable: Returns 200 or 302 (redirect to homepage after success)
        assert response.status_code == 403, \
            f"Expected 403 Forbidden, got {response.status_code}. Endpoint accepts unauthorized requests!"

    def test_admin_control_returns_access_denied_message(self):
        """
        Test that unauthorized POST returns 'Access denied' message.

        Vulnerable: No access denied message
        Fixed: Contains 'Access denied' in response
        """
        files = {
            'image': ('test.jpg', io.BytesIO(b'test'), 'image/jpeg'),
            'video': ('test.mp4', io.BytesIO(b'test'), 'video/mp4')
        }
        data = {
            'upload': '1',
            'mname': 'test',
            'release': '2024',
            'genre': 'test',
            'rtime': '60',
            'desc': 'test'
        }

        response = requests.post(
            f"{BASE_URL}/backend/admin_control.php",
            files=files,
            data=data,
            timeout=10
        )

        # Fixed version should contain access denied message
        assert response.status_code == 403, \
            f"Expected 403, got {response.status_code}"
        assert "Access denied" in response.text or "access denied" in response.text.lower(), \
            "Expected 'Access denied' message in response"

    def test_admin_control_with_empty_session_cookie(self):
        """
        Test that POST with manipulated empty session is rejected.

        Vulnerable: Accepts the request
        Fixed: Returns 403
        """
        session = requests.Session()

        # Set an empty/fake session cookie
        session.cookies.set('PHPSESSID', 'fakesessionid123')

        files = {
            'image': ('test.jpg', io.BytesIO(b'test data'), 'image/jpeg'),
            'video': ('test.mp4', io.BytesIO(b'test data'), 'video/mp4')
        }
        data = {
            'upload': '1',
            'mname': 'session_manipulation_test',
            'release': '2024',
            'genre': 'hack',
            'rtime': '1',
            'desc': 'Session manipulation attempt'
        }

        response = session.post(
            f"{BASE_URL}/backend/admin_control.php",
            files=files,
            data=data,
            allow_redirects=False,
            timeout=10
        )

        assert response.status_code == 403, \
            f"Expected 403 with fake session, got {response.status_code}"


class TestDirectURLAccess:
    """Test various direct URL access attempts."""

    def test_direct_get_to_admin_control(self):
        """
        Test GET request to admin_control.php returns 403 when protected.

        Vulnerable: Returns 200 (empty but accessible)
        Fixed: Returns 403 Forbidden
        """
        response = requests.get(
            f"{BASE_URL}/backend/admin_control.php",
            allow_redirects=False,
            timeout=10
        )

        # Fixed: Should return 403 for any unauthorized request
        # Vulnerable: Returns 200 (empty page)
        assert response.status_code == 403, \
            f"Expected 403 Forbidden for GET request, got {response.status_code}"

    def test_admin_page_with_regular_user_session_is_rejected(self):
        """
        Test that a logged-in regular user (non-admin) cannot access admin.php.

        Vulnerable: Returns 200 (anyone can access)
        Fixed: Returns 302 redirect to login
        """
        session = requests.Session()

        # Login as regular user (non-admin)
        login_data = {
            "mail": "user@test.com",
            "pass": "user123"
        }
        session.post(
            f"{BASE_URL}/backend/login_control.php",
            data=login_data,
            allow_redirects=True,
            timeout=10
        )

        # Try to access admin page as regular user
        response = session.get(
            f"{BASE_URL}/admin.php",
            allow_redirects=False,
            timeout=10
        )

        # Fixed: Regular users should be redirected
        # Vulnerable: Returns 200 with admin form
        assert response.status_code == 302, \
            f"Expected 302 redirect for non-admin user, got {response.status_code}"


class TestMultipleBypassAttempts:
    """Test multiple bypass techniques."""

    def test_case_sensitivity_bypass_attempt(self):
        """
        Test the main admin.php endpoint is protected (case-sensitive check not applicable on Linux).

        This test verifies the main admin.php endpoint returns 302 when protected.
        On case-sensitive filesystems, case variations (Admin.php, ADMIN.php) return 404,
        so we test the actual admin.php file directly.

        Vulnerable: Returns 200 with admin form
        Fixed: Returns 302 redirect
        """
        response = requests.get(
            f"{BASE_URL}/admin.php",
            allow_redirects=False,
            timeout=10
        )

        # Fixed: Should redirect (302) to login page
        # Vulnerable: Returns 200 with the admin form
        assert response.status_code == 302, \
            f"Expected 302 redirect, got {response.status_code}. Admin page accessible!"

    def test_path_traversal_bypass_attempt(self):
        """
        Test that path traversal doesn't bypass protection.
        """
        urls = [
            f"{BASE_URL}/./admin.php",
            f"{BASE_URL}//admin.php",
            f"{BASE_URL}/backend/../admin.php",
        ]

        for url in urls:
            try:
                response = requests.get(url, allow_redirects=False, timeout=10)
                if response.status_code == 200:
                    assert "Enter the Movie details" not in response.text, \
                        f"Admin form accessible via path manipulation: {url}"
            except requests.RequestException:
                # URL parsing error is acceptable
                pass

    def test_multiple_upload_attempts_all_blocked(self):
        """
        Test that multiple unauthorized upload attempts are all blocked.
        """
        for i in range(3):
            files = {
                'image': ('test.jpg', io.BytesIO(b'fake'), 'image/jpeg'),
                'video': ('test.mp4', io.BytesIO(b'fake'), 'video/mp4')
            }
            data = {
                'upload': '1',
                'mname': f'attack_movie_{i}',
                'release': '2024',
                'genre': 'attack',
                'rtime': '1',
                'desc': f'Attack attempt {i}'
            }

            response = requests.post(
                f"{BASE_URL}/backend/admin_control.php",
                files=files,
                data=data,
                allow_redirects=False,
                timeout=10
            )

            assert response.status_code == 403, \
                f"Upload attempt {i} not blocked: got {response.status_code}"


class TestResponseHeaders:
    """Test that proper security headers are returned."""

    def test_forbidden_response_is_proper_http_403(self):
        """
        Test that the 403 response is a proper HTTP 403 status.
        """
        files = {
            'image': ('test.jpg', io.BytesIO(b'test'), 'image/jpeg'),
            'video': ('test.mp4', io.BytesIO(b'test'), 'video/mp4')
        }
        data = {
            'upload': '1',
            'mname': 'test',
            'release': '2024',
            'genre': 'test',
            'rtime': '60',
            'desc': 'test'
        }

        response = requests.post(
            f"{BASE_URL}/backend/admin_control.php",
            files=files,
            data=data,
            timeout=10
        )

        # Verify it's a proper 403
        assert response.status_code == 403
        # Should have proper Content-Type
        assert 'text/html' in response.headers.get('Content-Type', '')

    def test_redirect_response_has_location_header(self):
        """
        Test that redirect response includes Location header.
        """
        response = requests.get(
            f"{BASE_URL}/admin.php",
            allow_redirects=False,
            timeout=10
        )

        assert response.status_code == 302
        assert 'Location' in response.headers, \
            "Redirect response missing Location header"
