"""
Functional tests for Tautulli image proxy endpoint.

These tests verify that legitimate functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""

import requests
import time
import subprocess
import os

BASE_URL = "http://localhost:8181"


def wait_for_service(timeout=60):
    """Wait for Tautulli service to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            # Try to connect to the service
            response = requests.get(f"{BASE_URL}/status", timeout=5)
            if response.status_code in [200, 401, 403]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(1)
    return False


class TestImageProxyFunctionality:
    """Test legitimate image proxy functionality."""

    @classmethod
    def setup_class(cls):
        """Wait for the service to be available."""
        assert wait_for_service(), "Tautulli service did not start in time"

    def test_service_is_running(self):
        """Verify that Tautulli service is responding."""
        response = requests.get(f"{BASE_URL}/status", timeout=10)
        # May return 200 or other status based on auth, but should not timeout
        assert response.status_code is not None

    def test_pms_image_proxy_endpoint_exists(self):
        """Verify the pms_image_proxy endpoint exists and responds."""
        response = requests.get(
            f"{BASE_URL}/pms_image_proxy",
            params={"img": "nonexistent"},
            timeout=10
        )
        # Should return some response (not connection error)
        assert response.status_code is not None

    def test_valid_image_request_with_valid_prefix(self):
        """Test that requests with valid image prefix are processed."""
        # Request a valid image path (even if file doesn't exist, path should be accepted)
        response = requests.get(
            f"{BASE_URL}/pms_image_proxy",
            params={"img": "interfaces/default/images/poster.png"},
            timeout=10
        )
        # The endpoint should process this request (may return empty if file doesn't exist)
        # But it should not return a 404 error page - the path is valid
        assert response.status_code in [200, 404]

    def test_fallback_image_parameter(self):
        """Test that fallback parameter is accepted."""
        response = requests.get(
            f"{BASE_URL}/pms_image_proxy",
            params={
                "img": "nonexistent",
                "fallback": "poster"
            },
            timeout=10
        )
        # Should accept fallback parameter
        assert response.status_code is not None

    def test_image_proxy_with_rating_key(self):
        """Test that rating_key parameter is accepted."""
        response = requests.get(
            f"{BASE_URL}/pms_image_proxy",
            params={"rating_key": "12345"},
            timeout=10
        )
        # Should accept rating_key parameter (may fail without Plex connection)
        assert response.status_code is not None

    def test_image_proxy_accepts_dimension_parameters(self):
        """Test that width/height parameters are accepted."""
        response = requests.get(
            f"{BASE_URL}/pms_image_proxy",
            params={
                "img": "interfaces/default/images/poster.png",
                "width": "300",
                "height": "400"
            },
            timeout=10
        )
        # Should accept dimension parameters
        assert response.status_code in [200, 404]

    def test_image_proxy_accepts_format_parameter(self):
        """Test that img_format parameter is accepted."""
        response = requests.get(
            f"{BASE_URL}/pms_image_proxy",
            params={
                "img": "interfaces/default/images/poster.png",
                "img_format": "png"
            },
            timeout=10
        )
        # Should accept format parameter
        assert response.status_code in [200, 404]

    def test_cache_header_present(self):
        """Test that cache-control header is set for image proxy."""
        response = requests.get(
            f"{BASE_URL}/pms_image_proxy",
            params={"img": "interfaces/default/images/poster.png"},
            timeout=10
        )
        # Should have cache headers
        assert 'Cache-Control' in response.headers or response.status_code == 404

    def test_api_endpoint_access(self):
        """Test that the API endpoint form works (pms_image_proxy is addtoapi decorated)."""
        response = requests.get(
            f"{BASE_URL}/api/v2",
            params={
                "cmd": "pms_image_proxy",
                "img": "interfaces/default/images/poster.png"
            },
            timeout=10
        )
        # API should respond
        assert response.status_code is not None
