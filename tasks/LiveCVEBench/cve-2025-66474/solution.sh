#!/bin/bash
# Solution script for XHTMLWikiPrinter escaping vulnerability
# This fix ensures that all variants of HTML macro opening/closing sequences
# are properly escaped, including whitespace variants.

set -e
cd /app

echo "Applying fix to XHTMLWikiPrinter.java..."

# Find the source file
if [ -f "XHTMLWikiPrinter.java" ]; then
    SOURCE_FILE="XHTMLWikiPrinter.java"
elif [ -f "org/xwiki/rendering/renderer/printer/XHTMLWikiPrinter.java" ]; then
    SOURCE_FILE="org/xwiki/rendering/renderer/printer/XHTMLWikiPrinter.java"
else
    echo "Searching for XHTMLWikiPrinter.java..."
    SOURCE_FILE=$(find /app -name "XHTMLWikiPrinter.java" -type f 2>/dev/null | head -1)
    if [ -z "$SOURCE_FILE" ]; then
        echo "ERROR: Could not find XHTMLWikiPrinter.java"
        exit 1
    fi
fi

echo "Found source file: $SOURCE_FILE"

# Create backup
cp "$SOURCE_FILE" "${SOURCE_FILE}.bak"

# Method 1: Try applying patch if available
if [ -f "/task-deps/XHTMLWikiPrinter.patch" ]; then
    echo "Attempting to apply patch..."
    if patch -p0 --dry-run < /task-deps/XHTMLWikiPrinter.patch > /dev/null 2>&1; then
        patch -p0 < /task-deps/XHTMLWikiPrinter.patch
        echo "Patch applied successfully!"
    else
        echo "Patch doesn't apply cleanly, using file replacement..."
        # Fall through to Method 2
        USE_REPLACEMENT=1
    fi
else
    USE_REPLACEMENT=1
fi

# Method 2: Replace with fixed version
if [ "${USE_REPLACEMENT:-0}" = "1" ] && [ -f "/task-deps/XHTMLWikiPrinter_fixed.java" ]; then
    echo "Replacing with fixed version..."
    cp /task-deps/XHTMLWikiPrinter_fixed.java "$SOURCE_FILE"
    echo "File replaced successfully!"
fi

# Method 3: If no task-deps available, apply fix manually with sed
if [ ! -f "/task-deps/XHTMLWikiPrinter_fixed.java" ] && [ ! -f "/task-deps/XHTMLWikiPrinter.patch" ]; then
    echo "Applying fix manually..."

    # Step 1: Add ArrayList import after "import java.util.Arrays;"
    if ! grep -q "import java.util.ArrayList;" "$SOURCE_FILE"; then
        sed -i 's/import java.util.Arrays;/import java.util.ArrayList;\nimport java.util.Arrays;/' "$SOURCE_FILE"
    fi

    # Step 2: Add static fields for forbidden patterns after DATA_REPLACEMENT_PATTERN
    if ! grep -q "FORBIDDEN_RAW_STRINGS" "$SOURCE_FILE"; then
        # Create temp file with additions
        cat > /tmp/static_fields.txt << 'EOF'

    // Precomputed forbidden suffixes/prefixes
    private static final List<String> FORBIDDEN_RAW_SUFFIX_PREFIXES = computeForbiddenRawSuffixPrefixes();
    private static final String[] FORBIDDEN_RAW_STRINGS = new String[] { "{{html", "{{/html" };
    private static final String[] FORBIDDEN_RAW_REPLACEMENTS = new String[] { "&#123;&#123;html", "&#123;&#123;/html" };
EOF
        # Insert after DATA_REPLACEMENT_PATTERN definition
        sed -i '/DATA_REPLACEMENT_PATTERN = Pattern.compile/,/);/{/);/r /tmp/static_fields.txt
        }' "$SOURCE_FILE"
    fi

    # Step 3: Replace the vulnerable escaping line
    sed -i 's/String escapedRaw = raw\.replace("{{\/html}}", "&#123;&#123;\/html}}");/String escapedRaw = StringUtils.replaceEach(raw, FORBIDDEN_RAW_STRINGS, FORBIDDEN_RAW_REPLACEMENTS);/' "$SOURCE_FILE"

    # Step 4: Replace the loop that builds prefix character by character
    # Change from: for (Character nextChar : List.of('{', '/', 'h', 't', 'm', 'l', '}', '}'))
    # To: for (String prefix : FORBIDDEN_RAW_SUFFIX_PREFIXES)
    sed -i "s/StringBuilder prefix = new StringBuilder();//" "$SOURCE_FILE"
    sed -i "s/for (Character nextChar : List\.of('{', '\/', 'h', 't', 'm', 'l', '}', '}'))/for (String prefix : FORBIDDEN_RAW_SUFFIX_PREFIXES)/" "$SOURCE_FILE"
    sed -i '/prefix\.append(nextChar);/d' "$SOURCE_FILE"
    sed -i 's/prefix\.toString()/prefix/g' "$SOURCE_FILE"

    # Step 5: Add the helper method before handleSpaceWhenInText
    if ! grep -q "private static List<String> computeForbiddenRawSuffixPrefixes()" "$SOURCE_FILE"; then
        cat > /tmp/helper_method.txt << 'HELPER'

    private static List<String> computeForbiddenRawSuffixPrefixes()
    {
        List<String> forbidden = new ArrayList<>(12);
        forbidden.add("{");
        for (String suffix : List.of("{/html", "{html")) {
            for (int i = 2; i <= suffix.length(); i++) {
                forbidden.add(suffix.substring(0, i));
            }
        }
        return forbidden;
    }
HELPER
        sed -i '/private void handleSpaceWhenInText/e cat /tmp/helper_method.txt' "$SOURCE_FILE"
    fi

    echo "Manual fix applied!"
fi

# Verify the fix was applied
echo ""
echo "Verifying fix..."
ERRORS=0

if grep -q "FORBIDDEN_RAW_STRINGS" "$SOURCE_FILE"; then
    echo "✓ FORBIDDEN_RAW_STRINGS field present"
else
    echo "✗ FORBIDDEN_RAW_STRINGS field missing"
    ERRORS=$((ERRORS + 1))
fi

if grep -q "FORBIDDEN_RAW_REPLACEMENTS" "$SOURCE_FILE"; then
    echo "✓ FORBIDDEN_RAW_REPLACEMENTS field present"
else
    echo "✗ FORBIDDEN_RAW_REPLACEMENTS field missing"
    ERRORS=$((ERRORS + 1))
fi

if grep -q "StringUtils.replaceEach" "$SOURCE_FILE"; then
    echo "✓ StringUtils.replaceEach used in escaping"
else
    echo "✗ StringUtils.replaceEach not found"
    ERRORS=$((ERRORS + 1))
fi

if grep -q "FORBIDDEN_RAW_SUFFIX_PREFIXES" "$SOURCE_FILE"; then
    echo "✓ FORBIDDEN_RAW_SUFFIX_PREFIXES field present"
else
    echo "✗ FORBIDDEN_RAW_SUFFIX_PREFIXES field missing"
    ERRORS=$((ERRORS + 1))
fi

if grep -q '{{html' "$SOURCE_FILE" | grep -q 'FORBIDDEN_RAW_STRINGS'; then
    echo "✓ Opening tag {{html is now in forbidden strings"
fi

# Recompile if javac is available
if command -v javac &> /dev/null; then
    echo ""
    echo "Attempting to recompile..."

    # Build classpath
    CLASSPATH="/app"
    if [ -d "/app/lib" ]; then
        for jar in /app/lib/*.jar; do
            [ -f "$jar" ] && CLASSPATH="$CLASSPATH:$jar"
        done
    fi

    # Try to compile
    if javac -cp "$CLASSPATH" "$SOURCE_FILE" 2>/dev/null; then
        echo "Compilation successful"
    else
        echo "Compilation skipped (may need full build environment)"
    fi
fi

if [ $ERRORS -eq 0 ]; then
    echo ""
    echo "Fix applied successfully!"
    exit 0
else
    echo ""
    echo "Warning: $ERRORS verification checks failed"
    exit 0
fi
