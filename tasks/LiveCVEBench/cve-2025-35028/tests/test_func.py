"""
Functionality tests for HexStrike AI MCP Server.

These tests verify that the server works correctly with normal inputs.
Tests should PASS in both vulnerable and fixed states.
"""

import requests
import pytest
import time

BASE_URL = "http://localhost:8888"
TIMEOUT = 60


@pytest.fixture(scope="module", autouse=True)
def wait_for_server():
    """Wait for server to be ready before running tests"""
    max_retries = 30
    for i in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/health", timeout=5)
            if response.status_code == 200:
                return
        except requests.exceptions.ConnectionError:
            pass
        time.sleep(1)
    pytest.fail(f"Server not ready after {max_retries} seconds")


class TestNmapEndpointFunctionality:
    """Test that the nmap endpoint works correctly with valid inputs"""

    def test_nmap_endpoint_exists(self):
        """Test that nmap endpoint responds to POST requests"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={"target": "127.0.0.1", "scan_type": "-sn"},
            timeout=TIMEOUT
        )
        # Should get a valid response (200 for success, or 400 for validation error)
        assert response.status_code in [200, 400, 500]

    def test_nmap_requires_target(self):
        """Test that target parameter is required"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={"scan_type": "-sV"},
            timeout=10
        )
        assert response.status_code == 400
        data = response.json()
        assert "target" in data.get("error", "").lower()

    def test_nmap_empty_target_rejected(self):
        """Test that empty target is rejected"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={"target": "", "scan_type": "-sn"},
            timeout=10
        )
        assert response.status_code == 400

    def test_nmap_accepts_valid_target(self):
        """Test that valid target is accepted"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={"target": "127.0.0.1", "scan_type": "-sn"},
            timeout=TIMEOUT
        )
        # Should not return 400 (bad request)
        # 200 is success, 500 might occur if nmap is not installed but that's ok
        assert response.status_code in [200, 500]

    def test_nmap_with_ports_parameter(self):
        """Test that ports parameter is accepted"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={
                "target": "127.0.0.1",
                "scan_type": "-sn",
                "ports": "80,443"
            },
            timeout=TIMEOUT
        )
        assert response.status_code in [200, 500]

    def test_nmap_with_additional_args(self):
        """Test that normal additional_args work correctly"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={
                "target": "127.0.0.1",
                "scan_type": "-sn",
                "additional_args": "-v"
            },
            timeout=TIMEOUT
        )
        assert response.status_code in [200, 500]

    def test_nmap_returns_json(self):
        """Test that nmap returns valid JSON response"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={"target": "127.0.0.1", "scan_type": "-sn"},
            timeout=TIMEOUT
        )
        # Should be able to parse as JSON
        data = response.json()
        assert isinstance(data, dict)


class TestHealthEndpoint:
    """Test the health check endpoint"""

    def test_health_endpoint_exists(self):
        """Test that health endpoint responds"""
        response = requests.get(f"{BASE_URL}/health", timeout=10)
        assert response.status_code == 200

    def test_health_returns_json(self):
        """Test that health endpoint returns valid JSON"""
        response = requests.get(f"{BASE_URL}/health", timeout=10)
        data = response.json()
        assert isinstance(data, dict)


class TestAPIEndpointStructure:
    """Test the API endpoint structure"""

    def test_nmap_rejects_get_method(self):
        """Test that nmap endpoint rejects GET requests"""
        response = requests.get(f"{BASE_URL}/api/tools/nmap", timeout=10)
        assert response.status_code == 405  # Method Not Allowed

    def test_nmap_with_json_content_type(self):
        """Test that nmap accepts JSON content type"""
        response = requests.post(
            f"{BASE_URL}/api/tools/nmap",
            json={"target": "127.0.0.1", "scan_type": "-sn"},
            headers={"Content-Type": "application/json"},
            timeout=TIMEOUT
        )
        assert response.status_code in [200, 400, 500]
