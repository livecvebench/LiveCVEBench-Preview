#!/bin/bash
set -e

cd /app

# Wait for PostgreSQL to be ready
echo "Waiting for PostgreSQL..."
max_attempts=30
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if php -r "try { new PDO('pgsql:host=postgres;dbname=ieducar', 'ieducar', 'ieducar'); echo 'OK'; } catch(Exception \$e) { exit(1); }" 2>/dev/null; then
        echo "PostgreSQL is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "Waiting for PostgreSQL... (attempt $attempt/$max_attempts)"
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "ERROR: PostgreSQL did not become ready in time"
    exit 1
fi

# Generate APP_KEY if not set
if ! grep -q "^APP_KEY=base64:" /app/.env; then
    echo "Generating APP_KEY..."
    php artisan key:generate --force
fi

# Run migrations
echo "Running migrations..."
php artisan migrate --force 2>&1 || echo "Migrations may have already been run"

# Run database seeders
echo "Running seeders..."
php artisan db:seed --force 2>&1 || echo "Seeders may have already been run"

# Clear and cache config
echo "Caching configuration..."
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Start PHP-FPM in the background
php-fpm &
PHP_FPM_PID=$!

# Start Nginx in foreground (main process)
nginx -g "daemon off;" &
NGINX_PID=$!

# Function to handle shutdown
shutdown() {
    echo "Shutting down..."
    kill $NGINX_PID 2>/dev/null || true
    kill $PHP_FPM_PID 2>/dev/null || true
    exit 0
}

trap shutdown SIGTERM SIGINT

# Wait for both processes
wait
