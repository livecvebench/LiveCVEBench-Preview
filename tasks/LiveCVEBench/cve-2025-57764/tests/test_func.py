"""
Functional tests for WeGIA cargos.php page.
These tests verify that the page works correctly and displays messages properly.
"""

import pytest
import requests
import urllib.parse
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:80")

# Login credentials (from documentation)
LOGIN_CPF = "admin"
LOGIN_PWD = "wegia"


@pytest.fixture(scope="module")
def authenticated_session():
    """Create an authenticated session for testing."""
    session = requests.Session()

    # Login to the application
    login_data = {
        "cpf": LOGIN_CPF,
        "pwd": LOGIN_PWD
    }
    response = session.post(f"{BASE_URL}/html/login.php", data=login_data, timeout=10)

    # Session should now have the authentication cookie
    return session


class TestPageFunctionality:
    """Tests for basic page functionality."""

    def test_page_loads_without_parameters(self, authenticated_session):
        """Test that cargos.php loads without any parameters."""
        response = authenticated_session.get(f"{BASE_URL}/html/geral/cargos.php", timeout=10)
        # Page should load successfully when authenticated
        assert response.status_code == 200

    def test_page_returns_html_content(self, authenticated_session):
        """Test that the page returns HTML content."""
        response = authenticated_session.get(f"{BASE_URL}/html/geral/cargos.php", timeout=10)
        content_type = response.headers.get("Content-Type", "")
        assert "text/html" in content_type or "<html" in response.text.lower()

    def test_success_message_displayed(self, authenticated_session):
        """Test that success messages (msg_c) are displayed in alert-success div."""
        test_message = "Operation completed successfully"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_c={urllib.parse.quote(test_message)}",
            timeout=10
        )
        assert response.status_code == 200
        assert test_message in response.text or "alert-success" in response.text

    def test_error_message_displayed(self, authenticated_session):
        """Test that error messages (msg_e) are displayed in alert-danger div."""
        test_message = "An error occurred"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(test_message)}",
            timeout=10
        )
        assert response.status_code == 200
        assert test_message in response.text or "alert-danger" in response.text

    def test_plain_text_message_displays_correctly(self, authenticated_session):
        """Test that plain text messages without special characters display correctly."""
        test_message = "This is a simple test message"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e={urllib.parse.quote(test_message)}",
            timeout=10
        )
        assert response.status_code == 200
        assert test_message in response.text

    def test_message_with_numbers_and_letters(self, authenticated_session):
        """Test alphanumeric messages display correctly."""
        test_message = "Record 12345 was updated"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_c={urllib.parse.quote(test_message)}",
            timeout=10
        )
        assert response.status_code == 200
        assert test_message in response.text

    def test_message_with_accented_characters(self, authenticated_session):
        """Test Portuguese accented characters display correctly."""
        test_message = "Operacao concluida com sucesso"
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_c={urllib.parse.quote(test_message)}",
            timeout=10
        )
        assert response.status_code == 200
        assert test_message in response.text

    def test_empty_message_parameter(self, authenticated_session):
        """Test that empty message parameters don't break the page."""
        response = authenticated_session.get(f"{BASE_URL}/html/geral/cargos.php?msg_e=", timeout=10)
        assert response.status_code == 200

    def test_both_parameters_only_one_displayed(self, authenticated_session):
        """Test that when both msg_c and msg_e are provided, only one is shown (msg_c takes precedence)."""
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_c=success&msg_e=error",
            timeout=10
        )
        assert response.status_code == 200
        # Based on the code, msg_c is checked first with if-else
        assert "success" in response.text or "alert-success" in response.text


class TestPageStructure:
    """Tests for page structure and elements."""

    def test_page_contains_cargos_heading(self, authenticated_session):
        """Test that the page contains the Cargos heading."""
        response = authenticated_session.get(f"{BASE_URL}/html/geral/cargos.php", timeout=10)
        assert response.status_code == 200
        assert "Cargos" in response.text

    def test_page_contains_table_structure(self, authenticated_session):
        """Test that the page contains the expected table structure."""
        response = authenticated_session.get(f"{BASE_URL}/html/geral/cargos.php", timeout=10)
        assert response.status_code == 200
        assert "<table" in response.text.lower()

    def test_page_contains_bootstrap_classes(self, authenticated_session):
        """Test that the page uses Bootstrap alert classes."""
        response = authenticated_session.get(
            f"{BASE_URL}/html/geral/cargos.php?msg_e=test",
            timeout=10
        )
        assert response.status_code == 200
        assert "alert" in response.text
