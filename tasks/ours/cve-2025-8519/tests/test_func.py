#!/usr/bin/env python3
"""
Functional tests for Vvveb CMS page editor.
These tests verify that the editor works correctly for legitimate use cases.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os

# Configuration
BASE_URL = os.environ.get("BASE_URL", "http://localhost:80")
ADMIN_PATH = "/vadmin"
ADMIN_USER = os.environ.get("ADMIN_USER", "admin@vvveb.com")
ADMIN_PASS = os.environ.get("ADMIN_PASS", "admin")

# Timeout settings
REQUEST_TIMEOUT = 30


class TestEditorFunctionality:
    """Test legitimate editor functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup for each test - get authenticated session."""
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "Mozilla/5.0 (Test Suite)"
        })
        # Authenticate
        self._login()
        yield
        self.session.close()

    def _login(self):
        """Authenticate to the admin panel."""
        login_url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=user/login"

        # First GET to get the CSRF token
        resp = self.session.get(login_url, timeout=REQUEST_TIMEOUT)

        # Extract CSRF token from response
        import re
        csrf_match = re.search(r'name="csrf"[^>]*value="([^"]+)"', resp.text)
        csrf_token = csrf_match.group(1) if csrf_match else ""

        # Attempt login - field is "user" not "email", and CSRF is required
        login_data = {
            "user": ADMIN_USER,
            "password": ADMIN_PASS,
            "csrf": csrf_token,
            "login": "1"
        }
        resp = self.session.post(login_url, data=login_data, timeout=REQUEST_TIMEOUT, allow_redirects=True)

        # Verify login success by checking if we can access editor module
        editor_url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=editor/editor"
        check = self.session.get(editor_url, timeout=REQUEST_TIMEOUT, allow_redirects=False)

        # Should not redirect to login if authenticated
        if check.status_code == 302 and "login" in check.headers.get("Location", "").lower():
            pytest.skip("Unable to authenticate - check credentials")

    def test_editor_module_accessible(self):
        """Test that the editor module is accessible when authenticated."""
        url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=editor/editor"
        response = self.session.get(url, timeout=REQUEST_TIMEOUT)

        assert response.status_code == 200, f"Expected 200, got {response.status_code}"
        # Editor page should contain editor-related content
        assert "builder" in response.text.lower() or "editor" in response.text.lower()

    def test_editor_loads_valid_html_template(self):
        """Test that editor can load a valid .html template."""
        url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=editor/editor&url=index.html&template=index.html"
        response = self.session.get(url, timeout=REQUEST_TIMEOUT)

        # Should return success (either 200 or redirect to valid page)
        assert response.status_code in [200, 302], f"Unexpected status: {response.status_code}"

    def test_editor_page_structure(self):
        """Test that the editor page has expected structure."""
        url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=editor/editor"
        response = self.session.get(url, timeout=REQUEST_TIMEOUT)

        assert response.status_code == 200
        # Should have HTML content
        assert "<!DOCTYPE" in response.text or "<html" in response.text

    def test_theme_parameter_accepted(self):
        """Test that editor accepts theme parameter for valid themes."""
        url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=editor/editor&theme=starter"
        response = self.session.get(url, timeout=REQUEST_TIMEOUT)

        # Should not error out - either 200 or valid redirect
        assert response.status_code in [200, 302, 404]

    def test_editor_without_url_param(self):
        """Test editor works without explicit URL parameter."""
        url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=editor/editor"
        response = self.session.get(url, timeout=REQUEST_TIMEOUT)

        assert response.status_code == 200
        # Should display editor interface
        assert len(response.text) > 100

    def test_admin_panel_accessible(self):
        """Test that the admin panel is accessible when authenticated."""
        url = f"{BASE_URL}{ADMIN_PATH}/index.php"
        response = self.session.get(url, timeout=REQUEST_TIMEOUT)

        assert response.status_code in [200, 302]


class TestBasicConnectivity:
    """Test basic application connectivity."""

    def test_application_responds(self):
        """Test that the application responds to requests."""
        response = requests.get(BASE_URL, timeout=REQUEST_TIMEOUT, allow_redirects=True)
        assert response.status_code in [200, 301, 302]

    def test_admin_login_page_accessible(self):
        """Test that the admin login page is accessible."""
        url = f"{BASE_URL}{ADMIN_PATH}/index.php?module=user/login"
        response = requests.get(url, timeout=REQUEST_TIMEOUT, allow_redirects=True)
        assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
