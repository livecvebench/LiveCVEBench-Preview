#!/bin/bash
set -e

# Path to the vulnerable file
FILE="/app/common/src/main/java/com/jeesite/common/codec/EncodeUtils.java"

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "Error: EncodeUtils.java not found at $FILE"
    exit 1
fi

# Add 'data' to the protocol blacklist in the XSS filter regex
# This replaces all occurrences of (javascript|vbscript) with (javascript|vbscript|data)
# in line 194 which handles href/src attribute filtering
sed -i 's/(javascript|vbscript)/(javascript|vbscript|data)/g' "$FILE"

# Verify the fix was applied
if grep -q "(javascript|vbscript|data)" "$FILE"; then
    echo "Fix applied successfully - data: protocol is now blocked in href/src attributes"
else
    echo "Error: Fix was not applied correctly"
    exit 1
fi
