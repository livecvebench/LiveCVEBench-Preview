"""
Vulnerability tests for ASN.1 OID integer truncation issue.
These tests verify that the fix properly handles oversized OID arc values.
Should FAIL in vulnerable state (vulnerability exploitable).
Should PASS in fixed state (vulnerability mitigated).
"""
import subprocess
import json
import pytest


def run_node_script(script):
    """Helper to run a Node.js script and return the result."""
    result = subprocess.run(
        ['node', '-e', script],
        capture_output=True,
        text=True,
        cwd='/app',
        timeout=30
    )
    return result


class TestOidToDerBoundsChecking:
    """Test that oidToDer properly rejects values exceeding 32 bits."""

    def test_rejects_value_just_over_32bits(self):
        """Test that oidToDer rejects 2^32 (4294967296)."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        try {
            ASN1.oidToDer("1.2.4294967296");
            console.log("VULNERABLE");
        } catch(e) {
            if(e.message.includes("32-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. Values >32 bits should be rejected."

    def test_rejects_large_64bit_value(self):
        """Test that oidToDer rejects large 64-bit values."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        try {
            ASN1.oidToDer("1.2.18446744073709551615");  // 2^64 - 1
            console.log("VULNERABLE");
        } catch(e) {
            if(e.message.includes("32-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. Large 64-bit values should be rejected."

    def test_rejects_value_causing_wraparound(self):
        """Test that oidToDer rejects values that would cause 32-bit wraparound."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        try {
            // 2^33 = 8589934592 - would wrap to 0 in 32-bit arithmetic
            ASN1.oidToDer("1.2.8589934592");
            console.log("VULNERABLE");
        } catch(e) {
            if(e.message.includes("32-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. Wraparound-causing values should be rejected."

    def test_rejects_multiple_oversized_arcs(self):
        """Test that oidToDer rejects OIDs with multiple oversized arc values."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        try {
            ASN1.oidToDer("1.2.4294967296.4294967297");
            console.log("VULNERABLE");
        } catch(e) {
            if(e.message.includes("32-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. Multiple oversized arcs should be rejected."


class TestDerToOidBoundsChecking:
    """Test that derToOid properly rejects values exceeding MAX_SAFE_INTEGER."""

    def test_rejects_value_exceeding_max_safe_integer(self):
        """Test that derToOid rejects 2^53 (exceeds MAX_SAFE_INTEGER)."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        try {
            // DER for OID 1.2.9007199254740992 (2^53, exceeds MAX_SAFE_INTEGER)
            var der = UTIL.hexToBytes("2a9080808080808000");
            var oid = ASN1.derToOid(der);
            console.log("VULNERABLE: " + oid);
        } catch(e) {
            if(e.message.includes("53-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. Values >MAX_SAFE_INTEGER should be rejected."

    def test_rejects_very_large_der_value(self):
        """Test that derToOid rejects very large DER-encoded values."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        try {
            // DER for an extremely large OID arc value (many continuation bytes)
            var der = UTIL.hexToBytes("2a9f8080808080808000");
            var oid = ASN1.derToOid(der);
            console.log("VULNERABLE: " + oid);
        } catch(e) {
            if(e.message.includes("53-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. Very large DER values should be rejected."

    def test_handles_max_safe_integer_correctly(self):
        """Test that derToOid correctly handles MAX_SAFE_INTEGER (2^53 - 1)."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        try {
            // DER for OID 1.2.9007199254740991 (MAX_SAFE_INTEGER)
            var der = UTIL.hexToBytes("2a8fffffffffffff7f");
            var oid = ASN1.derToOid(der);
            if (oid === "1.2.9007199254740991") {
                console.log("CORRECT");
            } else {
                console.log("WRONG: " + oid);
            }
        } catch(e) {
            console.log("ERROR: " + e.message);
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'CORRECT', f"Expected CORRECT, got {output}. MAX_SAFE_INTEGER should be handled correctly."

    def test_handles_values_just_over_32bits_correctly(self):
        """Test that derToOid correctly handles values just over 32 bits (should work after fix)."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        try {
            // DER for OID 1.2.4294967297 (2^32 + 1)
            var der = UTIL.hexToBytes("2a9080808001");
            var oid = ASN1.derToOid(der);
            if (oid === "1.2.4294967297") {
                console.log("CORRECT");
            } else {
                console.log("WRONG: " + oid);
            }
        } catch(e) {
            console.log("ERROR: " + e.message);
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'CORRECT', f"Expected CORRECT, got {output}. Values >32 bits should decode correctly in fixed version."


class TestBitShiftVsMultiplication:
    """Test that the fix uses multiplication instead of bitwise shift to avoid truncation."""

    def test_detects_truncation_at_boundary(self):
        """Test that values at the 32-bit boundary don't get truncated.
        The DER 2a9080808001 encodes OID 1.2.4294967297 (2^32 + 1).
        In the vulnerable version, this truncates to 1.2.1.
        In the fixed version, this either decodes correctly or throws an error."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        try {
            // DER for OID 1.2.4294967297 (2^32 + 1)
            var der = UTIL.hexToBytes("2a9080808001");
            var oid = ASN1.derToOid(der);
            // The third arc should be 4294967297, NOT 1
            var parts = oid.split(".");
            var thirdArc = parseInt(parts[2]);
            if (thirdArc === 1) {
                // Truncation occurred - this is the vulnerable behavior
                console.log("VULNERABLE: truncated to " + oid);
            } else if (thirdArc === 4294967297) {
                // Correct decoding - this is fixed behavior
                console.log("FIXED");
            } else {
                console.log("UNEXPECTED: " + oid);
            }
        } catch(e) {
            // It's also acceptable if it throws an error for too-large values
            if(e.message.includes("53-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. 32-bit truncation detected (vulnerability exists)."


class TestOidSpoofingPrevention:
    """Test that OID spoofing via integer truncation is prevented."""

    def test_prevents_oid_spoofing_via_wraparound(self):
        """Test that crafted OID values don't alias to trusted OIDs after truncation."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");

        // If we could encode 1.2.(2^32 + 840), a vulnerable implementation
        // might decode it as 1.2.840 due to 32-bit truncation
        // Here we test that oversized values are properly rejected

        try {
            // Try to encode an OID with value that would truncate to 840
            // 2^32 + 840 = 4294968136
            var spoofedOid = "1.2.4294968136";
            var der = ASN1.oidToDer(spoofedOid);
            // If we get here without error, check that derToOid doesn't produce 1.2.840
            var decoded = ASN1.derToOid(der);
            if (decoded === "1.2.840") {
                console.log("VULNERABLE: OID spoofing possible");
            } else if (decoded === spoofedOid) {
                console.log("VULNERABLE: oversized value accepted");
            } else {
                console.log("VULNERABLE: unexpected decode - " + decoded);
            }
        } catch(e) {
            if(e.message.includes("32-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. OID spoofing prevention check failed."

    def test_prevents_zero_aliasing(self):
        """Test that 2^32 doesn't alias to 0 via truncation."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        try {
            // 2^32 = 4294967296 should be rejected, not decoded as 0
            var spoofedOid = "1.2.4294967296";
            var der = ASN1.oidToDer(spoofedOid);
            var decoded = ASN1.derToOid(der);
            // Check if it became 0 due to truncation
            if (decoded === "1.2.0") {
                console.log("VULNERABLE: 2^32 aliased to 0");
            } else {
                console.log("VULNERABLE: oversized value accepted");
            }
        } catch(e) {
            if(e.message.includes("32-bits") || e.message.includes("too large")) {
                console.log("FIXED");
            } else {
                console.log("ERROR: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output == 'FIXED', f"Expected FIXED, got {output}. Zero aliasing prevention check failed."


class TestErrorMessages:
    """Test that appropriate error messages are thrown."""

    def test_oid_to_der_error_message(self):
        """Test that oidToDer throws a meaningful error for oversized values."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        try {
            ASN1.oidToDer("1.2.4294967296");
            console.log("NO_ERROR");
        } catch(e) {
            if(e.message.includes("32-bits")) {
                console.log("CORRECT_MESSAGE");
            } else if(e.message.includes("too large") || e.message.includes("OID")) {
                console.log("ACCEPTABLE_MESSAGE");
            } else {
                console.log("WRONG_MESSAGE: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output in ['CORRECT_MESSAGE', 'ACCEPTABLE_MESSAGE'], \
            f"Expected meaningful error message, got {output}"

    def test_der_to_oid_error_message(self):
        """Test that derToOid throws a meaningful error for oversized values."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        try {
            var der = UTIL.hexToBytes("2a9080808080808000");
            ASN1.derToOid(der);
            console.log("NO_ERROR");
        } catch(e) {
            if(e.message.includes("53-bits")) {
                console.log("CORRECT_MESSAGE");
            } else if(e.message.includes("too large") || e.message.includes("OID")) {
                console.log("ACCEPTABLE_MESSAGE");
            } else {
                console.log("WRONG_MESSAGE: " + e.message);
            }
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout.strip()
        assert output in ['CORRECT_MESSAGE', 'ACCEPTABLE_MESSAGE'], \
            f"Expected meaningful error message, got {output}"


class TestMultipleVectorCombinations:
    """Test various combinations of attack vectors."""

    def test_boundary_values_sequence(self):
        """Test a sequence of values around the 32-bit boundary."""
        boundary_values = [
            ("4294967294", True),   # 2^32 - 2, should work
            ("4294967295", True),   # 2^32 - 1 (32-bit max), should work
            ("4294967296", False),  # 2^32, should be rejected
            ("4294967297", False),  # 2^32 + 1, should be rejected
        ]

        for value, should_work in boundary_values:
            result = run_node_script(f'''
            var ASN1 = require("./lib/asn1");
            try {{
                var oid = "1.2.{value}";
                var der = ASN1.oidToDer(oid);
                var recovered = ASN1.derToOid(der);
                if (recovered === oid) {{
                    console.log("WORKED");
                }} else {{
                    console.log("CORRUPTED: " + recovered);
                }}
            }} catch(e) {{
                console.log("REJECTED");
            }}
            ''')
            assert result.returncode == 0, f"Script failed for value {value}: {result.stderr}"
            output = result.stdout.strip()

            if should_work:
                assert output == 'WORKED', f"Value {value} should work but got {output}"
            else:
                assert output == 'REJECTED', f"Value {value} should be rejected but got {output}"

    def test_different_arc_positions(self):
        """Test oversized values in different arc positions."""
        test_cases = [
            "1.2.4294967296.1",       # Oversized in third position
            "1.2.1.4294967296",       # Oversized in fourth position
            "1.2.1.1.4294967296",     # Oversized in fifth position
        ]

        for oid in test_cases:
            result = run_node_script(f'''
            var ASN1 = require("./lib/asn1");
            try {{
                ASN1.oidToDer("{oid}");
                console.log("VULNERABLE");
            }} catch(e) {{
                if(e.message.includes("32-bits") || e.message.includes("too large")) {{
                    console.log("FIXED");
                }} else {{
                    console.log("ERROR: " + e.message);
                }}
            }}
            ''')
            assert result.returncode == 0, f"Script failed for OID {oid}: {result.stderr}"
            output = result.stdout.strip()
            assert output == 'FIXED', f"OID {oid}: Expected FIXED, got {output}"
