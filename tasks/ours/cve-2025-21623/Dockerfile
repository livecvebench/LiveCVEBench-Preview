FROM php:8.3-apache

# Set working directory to web root
WORKDIR /var/www/html

# Install system dependencies (tmux, asciinema, curl are required by generator)
RUN apt-get update && apt-get install -y \
    git \
    default-mysql-client \
    tmux \
    asciinema \
    curl \
    python3 \
    python3-pip \
    python3-pytest \
    python3-requests \
    && rm -rf /var/lib/apt/lists/*

# Install mysql-connector-python via pip
RUN python3 -m pip install --break-system-packages mysql-connector-python

# Install PHP extensions
RUN docker-php-ext-install mysqli pdo pdo_mysql

# Enable Apache modules
RUN a2enmod rewrite

# Enable PHP error display for debugging
RUN echo "display_errors=On" > /usr/local/etc/php/conf.d/debug.ini && \
    echo "error_reporting=E_ALL" >> /usr/local/etc/php/conf.d/debug.ini

# Clone ClipBucket V5 repository at vulnerable version and remove git history
RUN git clone https://github.com/MacWarrior/clipbucket-v5.git . && \
    git config --global --add safe.directory /var/www/html && \
    git checkout 75d663f010cd8569eb9e278f030838174fb30188~1 && \
    rm -rf .git

# Copy web files from upload/ to document root
RUN cp -r upload/* . && rm -rf upload

# Create database configuration file
RUN echo '<?php\n\
$DBHOST = "db";\n\
$DBNAME = "clipbucket";\n\
$DBUSER = "clipbucket";\n\
$DBPASS = "clipbucket";\n\
define("TABLE_PREFIX", "cb_");\n\
?>' > includes/dbconnect.php

# Bypass installation check by creating the marker file
RUN mkdir -p files/temp && touch files/temp/install.me.not

# Set proper permissions
RUN chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html

# Expose port 80
EXPOSE 80

# # Start Apache
# CMD 