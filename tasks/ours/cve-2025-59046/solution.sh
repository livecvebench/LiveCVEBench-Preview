#!/bin/bash
set -e
cd /app

# Path to the installed package
PKG_PATH="/app/node_modules/interactive-git-checkout/src"

echo "Applying fix to interactive-git-checkout..."

# Fix checkout.js - replace exec with execFile
cat > "$PKG_PATH/checkout.js" << 'EOF'
const { execFile: execFileCb } = require("child_process");
const { promisify } = require("util");

const execFile = promisify(execFileCb);

module.exports = async (targetBranch) => {
  const { stdout, stderr } = await execFile("git", ["checkout", targetBranch]);
  process.stderr.write(stderr);
  process.stdout.write(stdout);
};
EOF

echo "Fixed checkout.js"

# Fix checkoutToNew.js - replace exec with execFile
cat > "$PKG_PATH/checkoutToNew.js" << 'EOF'
const { execFile: execFileCb } = require("child_process");
const { promisify } = require("util");

const execFile = promisify(execFileCb);

module.exports = async (newBranchName) => {
  const { stdout, stderr } = await execFile("git", [
    "checkout",
    "-b",
    newBranchName,
  ]);
  process.stderr.write(stderr);
  process.stdout.write(stdout);
};
EOF

echo "Fixed checkoutToNew.js"

# Fix getBranches.js - replace exec with execFile
cat > "$PKG_PATH/getBranches.js" << 'EOF'
#!/usr/bin/env node
const { execFile: execFileCb } = require("child_process");
const { promisify } = require("util");

const execFile = promisify(execFileCb);

module.exports = async () => {
  const { stdout, stderr } = await execFile("git", ["branch"], {
    encoding: "utf8",
  });
  if (stderr !== "") {
    throw new Error(`Error while running "git branch": ${stderr}`);
  }
  const branches = [];
  let currentBranchIndex;
  const branchLines = stdout.trimEnd().split("\n");
  branchLines.forEach((branchLine, index) => {
    if (branchLine.startsWith("*")) currentBranchIndex = index;
    branches.push(branchLine.substring(2));
  });
  return { branches, currentBranchIndex };
};
EOF

echo "Fixed getBranches.js"

echo "Fix applied successfully"
