instruction: |-
  I discovered a sandbox escape vulnerability in pdfme's expression evaluator
  (@pdfme/common) that allows prototype pollution and arbitrary code execution.

  The library allows dynamic expressions in PDF templates (e.g., `{1+1}` evaluates
  to `2`). I found several security issues with the sandbox implementation:

  1. XSS via Object methods: I can access internal JavaScript objects through
     expressions like `{Object.getPrototypeOf(Object)}`. By chaining
     Object.getOwnPropertyDescriptor and Object.getPrototypeOf, I can obtain the
     Function constructor and execute arbitrary code:
     `{ ((f, g) => f(g(Object), "constructor").value)(Object.getOwnPropertyDescriptor, Object.getPrototypeOf)("return 42")() }`

  2. Legacy accessor methods not blocked: Methods like `__lookupGetter__`,
     `__lookupSetter__`, and `__defineGetter__` are not properly blocked.
     `{{}.__lookupGetter__("__proto__")}` returns the getter function instead
     of the unchanged expression.

  3. Prototype pollution: Using __lookupGetter__ combined with Object.assign,
     I can pollute Object.prototype:
     `{{ assign: Object.assign }.assign({ f: {}.__lookupGetter__("__proto__") }.f(), { polluted: "yes" })}`

  Expected fix:
  - Block dangerous Object methods (getOwnPropertyDescriptor, getPrototypeOf,
    setPrototypeOf, defineProperty, etc.)
  - Block legacy accessor methods (__lookupGetter__, __defineGetter__, etc.)
  - Prevent Object.assign from modifying prototype-related properties
  - Keep safe methods like Object.keys, Object.values working

  The relevant code is in `packages/common/src/expression.ts`.

author_name: HIT-SCIR-LACG
author_email: xzluo@ir.hit.edu.cn

difficulty: medium
category: security
tags:
  - javascript
  - typescript
  - sandbox-escape
  - prototype-pollution
  - xss
parser_name: pytest

run_tests_in_same_shell: false
