#!/usr/bin/env python3
"""
Functional tests for Hush_Util::hostname()

These tests verify that the hostname() function works correctly for legitimate inputs.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import pytest


def run_php_code(code: str) -> tuple:
    """Execute PHP code and return stdout, stderr, returncode."""
    result = subprocess.run(
        ['php', '-r', code],
        capture_output=True,
        text=True,
        timeout=10
    )
    return result.stdout.strip(), result.stderr.strip(), result.returncode


class TestHostnameFunctionality:
    """Test basic hostname() functionality with valid inputs."""

    def test_returns_valid_hostname(self):
        """Test that hostname() returns a valid hostname for normal input."""
        code = '''
        $_SERVER["HOST"] = "example.com";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # Should return the hostname (possibly HTML-encoded after fix)
        assert rc == 0
        assert stdout in ['example.com', 'localhost']
        assert 'Fatal' not in stderr
        assert 'Error' not in stderr

    def test_hostname_with_port(self):
        """Test that hostname() handles port numbers correctly."""
        code = '''
        $_SERVER["HOST"] = "example.com:8080";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        # Should return hostname:port or localhost
        assert stdout in ['example.com:8080', 'localhost']

    def test_hostname_with_subdomain(self):
        """Test that hostname() handles subdomains correctly."""
        code = '''
        $_SERVER["HOST"] = "api.staging.example.com";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert stdout in ['api.staging.example.com', 'localhost']

    def test_hostname_with_hyphen(self):
        """Test that hostname() handles hyphens in hostname."""
        code = '''
        $_SERVER["HOST"] = "my-app.example-domain.com";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert stdout in ['my-app.example-domain.com', 'localhost']

    def test_fallback_to_localhost(self):
        """Test fallback to localhost when no server vars are set."""
        code = '''
        unset($_SERVER["HOST"]);
        unset($_SERVER["HOSTNAME"]);
        unset($_SERVER["SERVER_NAME"]);
        unset($_SERVER["SERVER_ADDR"]);
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert stdout == 'localhost'

    def test_server_name_fallback(self):
        """Test that hostname() falls back to SERVER_NAME when HOST is not set."""
        code = '''
        unset($_SERVER["HOST"]);
        unset($_SERVER["HOSTNAME"]);
        $_SERVER["SERVER_NAME"] = "server.example.com";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert stdout in ['server.example.com', 'localhost']

    def test_server_addr_fallback(self):
        """Test that hostname() falls back to SERVER_ADDR."""
        code = '''
        unset($_SERVER["HOST"]);
        unset($_SERVER["HOSTNAME"]);
        unset($_SERVER["SERVER_NAME"]);
        $_SERVER["SERVER_ADDR"] = "192.168.1.1";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert stdout in ['192.168.1.1', 'localhost']

    def test_numeric_port(self):
        """Test hostname with various valid port numbers."""
        ports = ['80', '443', '8080', '3000', '9000']
        for port in ports:
            code = f'''
            $_SERVER["HOST"] = "example.com:{port}";
            require_once "/app/hush-lib/Hush/Util.php";
            echo Hush_Util::hostname();
            '''
            stdout, stderr, rc = run_php_code(code)
            assert rc == 0
            # Either returns hostname:port or localhost (if fixed and validation fails)
            assert stdout in [f'example.com:{port}', 'localhost']


class TestHostnameIntegration:
    """Test hostname() usage in common scenarios."""

    def test_can_be_used_in_url(self):
        """Test that hostname output can be used in URL construction."""
        code = '''
        $_SERVER["HOST"] = "example.com";
        require_once "/app/hush-lib/Hush/Util.php";
        $host = Hush_Util::hostname();
        $url = "http://" . $host . "/api/endpoint";
        echo $url;
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert stdout in ['http://example.com/api/endpoint', 'http://localhost/api/endpoint']

    def test_used_in_html_anchor(self):
        """Test that hostname works when used in HTML anchor tags."""
        code = '''
        $_SERVER["HOST"] = "example.com";
        require_once "/app/hush-lib/Hush/Util.php";
        $host = Hush_Util::hostname();
        echo "<a href=\\"http://{$host}/\\">Link</a>";
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert 'href="http://' in stdout
        assert 'Link</a>' in stdout

    def test_localhost_default(self):
        """Test that localhost is a valid default."""
        code = '''
        // Clear all server vars
        $_SERVER = array();
        require_once "/app/hush-lib/Hush/Util.php";
        $host = Hush_Util::hostname();
        echo $host;
        '''
        stdout, stderr, rc = run_php_code(code)
        assert rc == 0
        assert stdout == 'localhost'
