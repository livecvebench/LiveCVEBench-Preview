#!/bin/bash
set -e

echo "Applying fix for SQL injection vulnerability..."

TARGET_FILE="/var/www/html/Supply_Management_System/admin/add_retailer.php"

# Verify the file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo "Error: Target file not found: $TARGET_FILE"
    exit 1
fi

# Create backup
cp "$TARGET_FILE" "${TARGET_FILE}.bak"

# Apply the fix using sed
# The vulnerability is on lines 59-67 where the INSERT query uses string interpolation
# We need to replace the vulnerable code with prepared statements

# First, replace the INSERT query line with prepared statement setup
sed -i 's/\$query_addRetailer = "INSERT INTO retailer(username,password,address,area_id,phone,email) VALUES(.*);/$stmt = $con->prepare("INSERT INTO retailer(username,password,address,area_id,phone,email) VALUES(?,?,?,?,?,?)"); $stmt->bind_param("ssssss", $username, $password, $address, $areacode, $phone, $email);/g' "$TARGET_FILE"

# Second, replace mysqli_query with stmt->execute
sed -i 's/if(mysqli_query(\$con,\$query_addRetailer))/if($stmt->execute())/g' "$TARGET_FILE"

# Verify the fix was applied
if grep -q 'prepare("INSERT INTO retailer' "$TARGET_FILE" && grep -q 'bind_param' "$TARGET_FILE"; then
    echo "Fix applied successfully!"
    echo "- Replaced vulnerable string concatenation with prepared statement"
    echo "- Changed mysqli_query to use stmt->execute()"
else
    echo "Warning: Fix may not have been applied correctly. Attempting alternative method..."

    # Alternative: Use a more comprehensive replacement with a heredoc
    # Restore from backup first
    cp "${TARGET_FILE}.bak" "$TARGET_FILE"

    # Create a Python script to do the replacement more reliably
    python3 << 'PYTHON_SCRIPT'
import re

target_file = "/var/www/html/Supply_Management_System/admin/add_retailer.php"

with open(target_file, 'r') as f:
    content = f.read()

# Pattern to find the vulnerable INSERT query and mysqli_query call
old_pattern = r'\$query_addRetailer = "INSERT INTO retailer\(username,password,address,area_id,phone,email\) VALUES\(\'\$username\',\'\$password\',\'\$address\',\'\$areacode\',\'\$phone\',\'\$email\'\)";'

new_code = '''$stmt = $con->prepare("INSERT INTO retailer(username,password,address,area_id,phone,email) VALUES(?,?,?,?,?,?)");
				$stmt->bind_param("ssssss", $username, $password, $address, $areacode, $phone, $email);'''

content = re.sub(old_pattern, new_code, content)

# Replace the mysqli_query call with execute
content = content.replace('if(mysqli_query($con,$query_addRetailer))', 'if($stmt->execute())')

with open(target_file, 'w') as f:
    f.write(content)

print("Fix applied via Python script")
PYTHON_SCRIPT

    # Verify again
    if grep -q 'prepare("INSERT INTO retailer' "$TARGET_FILE" && grep -q 'bind_param' "$TARGET_FILE"; then
        echo "Fix applied successfully with alternative method!"
    else
        echo "Fix verification failed. Manual inspection may be required."
        exit 1
    fi
fi

# Clean up backup
rm -f "${TARGET_FILE}.bak"

echo ""
echo "Fix complete. The cmbAreaCode parameter is now safely handled via prepared statements."
