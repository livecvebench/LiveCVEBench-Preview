# JRuby-OpenSSL Hostname Verification Bypass
# This Dockerfile creates an environment with the vulnerable jruby-openssl 0.15.3 gem

FROM jruby:9.4.11.0-jdk17

WORKDIR /app

# System dependencies (tmux, asciinema, gcc, g++, wget, curl, git are required)
# Using retry mechanism for apt-get to handle network issues
RUN for i in 1 2 3 4 5; do \
        apt-get update && \
        apt-get install -y --no-install-recommends \
            git \
            tmux \
            asciinema \
            curl \
            wget \
            ca-certificates \
            python3 \
            python3-pip \
            gcc \
            g++ \
        && break || sleep 15; \
    done && rm -rf /var/lib/apt/lists/*

# Install pytest for running tests
RUN pip3 install pytest

# Install the vulnerable version of jruby-openssl (0.15.3)
# JRuby 9.4.11.0 may bundle a different version, so explicitly install 0.15.3
RUN jruby -S gem install jruby-openssl -v 0.15.3

# Verify the installation - ensure vulnerable version is present
RUN jruby -e "require 'openssl'; puts 'JOpenSSL version: ' + JOpenSSL::VERSION; exit 1 unless JOpenSSL::VERSION == '0.15.3'"

# Verify hostname verification is disabled (vulnerable state)
RUN jruby -e "require 'openssl'; val = OpenSSL::SSL::SSLContext::DEFAULT_PARAMS[:verify_hostname]; puts 'verify_hostname: ' + val.inspect; exit 1 unless val.nil?"

# Copy poc.rb for manual testing (optional)
COPY task-deps/poc.rb /app/poc.rb

# CMD moved to docker-compose.yaml
# CMD ["bash", "-c", "echo 'JRuby with vulnerable jruby-openssl 0.15.3 ready' && tail -f /dev/null"]
