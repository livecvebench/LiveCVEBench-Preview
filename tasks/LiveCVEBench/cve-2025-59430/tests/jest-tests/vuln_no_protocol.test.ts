import { createLink } from '../Link'

jest.mock('@meshconnect/uwc-bridge-parent', () => ({
  BridgeParent: jest.fn().mockImplementation(() => ({
    destroy: jest.fn()
  }))
}))

describe('Vulnerability: No Protocol', () => {
  beforeEach(() => {
    document.getElementsByTagName('html')[0].innerHTML = ''
  })

  test('URL without protocol should be rejected', () => {
    const exitFunction = jest.fn<void, [string | undefined]>()
    // example.com/path (no protocol)
    const payload = Buffer.from('example.com/path').toString('base64')

    const frontConnection = createLink({
      clientId: 'test',
      onIntegrationConnected: jest.fn(),
      onExit: exitFunction
    })

    frontConnection.openLink(payload)

    expect(exitFunction).toHaveBeenCalledWith('Invalid link token!')
    const iframeElement = document.getElementById('mesh-link-popup__iframe')
    expect(iframeElement).toBeFalsy()
  })

  test('relative path should be rejected', () => {
    const exitFunction = jest.fn<void, [string | undefined]>()
    // /path/to/resource
    const payload = Buffer.from('/path/to/resource').toString('base64')

    const frontConnection = createLink({
      clientId: 'test',
      onIntegrationConnected: jest.fn(),
      onExit: exitFunction
    })

    frontConnection.openLink(payload)

    expect(exitFunction).toHaveBeenCalledWith('Invalid link token!')
    const iframeElement = document.getElementById('mesh-link-popup__iframe')
    expect(iframeElement).toBeFalsy()
  })

  test('protocol-relative URL should be rejected', () => {
    const exitFunction = jest.fn<void, [string | undefined]>()
    // //example.com/path
    const payload = Buffer.from('//example.com/path').toString('base64')

    const frontConnection = createLink({
      clientId: 'test',
      onIntegrationConnected: jest.fn(),
      onExit: exitFunction
    })

    frontConnection.openLink(payload)

    expect(exitFunction).toHaveBeenCalledWith('Invalid link token!')
    const iframeElement = document.getElementById('mesh-link-popup__iframe')
    expect(iframeElement).toBeFalsy()
  })
})
