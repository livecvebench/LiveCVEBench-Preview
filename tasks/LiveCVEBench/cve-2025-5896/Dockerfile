FROM node:18

WORKDIR /app

# System dependencies (git for cloning, python3 for tests, tmux/asciinema/curl required)
RUN apt-get update && apt-get install -y \
    git \
    python3 \
    python3-pip \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Clone Taro repository at vulnerable commit
RUN git clone https://github.com/NervJS/taro.git . && \
    git checkout 490770c203fcf646e6d1310666a426dd270af923 && \
    rm -rf .git

# Set working directory to the vulnerable package
WORKDIR /app/packages/css-to-react-native

# Install production dependencies
RUN npm install

# Install build dependencies
RUN npm install --save-dev @babel/cli @babel/core @babel/preset-env rimraf

# Build the package (bypass pnpm requirement in prebuild script)
RUN rm -rf ./dist && npx babel src --ignore *.spec.js --out-dir ./dist

# Reset working directory
WORKDIR /app

# Keep container running
CMD ["tail", "-f", "/dev/null"]
