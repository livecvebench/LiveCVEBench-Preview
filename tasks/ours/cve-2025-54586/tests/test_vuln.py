"""
Vulnerability tests for GitProxy pack validation.
"""
import subprocess
import os
import pytest

class TestVulnerabilityPoC:
    """Test using the actual TypeScript PoC script."""

    def test_exploit_reproduction(self):
        """
        Run the TypeScript reproduction script using npx tsx.
        This script mocks a hidden commit attack and verifies if the processor catches it.
        """
        script_path = "/app/reproduce_issue.ts"
        
        # Check if script was copied successfully
        if not os.path.exists(script_path):
            # Fallback for local testing if not in /app
            script_path = os.path.join(os.path.dirname(__file__), "reproduce_issue.ts")
        
        # We need to run this in the /app directory so it can find node_modules
        # assuming we are in the container environment where /app exists
        cwd = "/app" if os.path.isdir("/app") else os.getcwd()

        try:
            # Run the TS script
            # We use npx tsx to execute the TypeScript file directly
            result = subprocess.run(
                ["npx", "tsx", script_path],
                cwd=cwd,
                capture_output=True,
                text=True,
                timeout=30
            )
            
            output = result.stdout + result.stderr
            print(f"PoC Output: {output}")

            if "MODULE_NOT_FOUND" in output:
                pytest.fail("Vulnerable: checkHiddenCommits processor module not found.")
            
            if "VULNERABLE" in output:
                pytest.fail(f"Vulnerability Reproduced: {output.strip()}")
                
            if "FIXED" in output:
                # Test passed, vulnerability is fixed
                return
                
            if result.returncode != 0:
                pytest.fail(f"PoC script failed with error: {output}")
                
            pytest.fail(f"Unexpected output from PoC script: {output}")

        except FileNotFoundError:
            # If npx is not found, we might not be in the right environment
            pytest.skip("npx not found, cannot run TypeScript PoC")
