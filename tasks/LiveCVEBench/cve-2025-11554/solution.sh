#!/bin/bash
# Solution script for i-Educar user type authorization fix
# Adds can:view:554, can:modify:554, and can:remove:554 middleware to user type routes
set -e

echo "Applying authorization fix to i-Educar..."

# Define paths (adjust based on actual container structure)
APP_DIR="/app"
ROUTES_FILE="${APP_DIR}/routes/web.php"

# Check if routes file exists
if [ ! -f "$ROUTES_FILE" ]; then
    echo "ERROR: Routes file not found at $ROUTES_FILE"
    exit 1
fi

echo "Patching routes/web.php to add authorization middleware..."

# Backup original file
cp "$ROUTES_FILE" "${ROUTES_FILE}.bak"

# Apply the fix using sed
# The fix adds ->middleware('can:ACTION:554') to each user type route
# Process ID 554 is used for user type management (from AccessLevelController's $this->menu(554))

# Fix GET /usuarios/tipos/novo - needs view permission
sed -i "s|Route::get('/usuarios/tipos/novo', 'AccessLevelController@new')\s*->name('usertype.new');|Route::get('/usuarios/tipos/novo', 'AccessLevelController@new')->middleware('can:view:554')->name('usertype.new');|g" "$ROUTES_FILE"

# Fix GET /usuarios/tipos/{userType} - needs view permission
sed -i "s|Route::get('/usuarios/tipos/{userType}', 'AccessLevelController@show')\s*->name('usertype.show');|Route::get('/usuarios/tipos/{userType}', 'AccessLevelController@show')->middleware('can:view:554')->name('usertype.show');|g" "$ROUTES_FILE"

# Fix POST /usuarios/tipos - needs modify permission
sed -i "s|Route::post('/usuarios/tipos', 'AccessLevelController@create')\s*->name('usertype.create');|Route::post('/usuarios/tipos', 'AccessLevelController@create')->middleware('can:modify:554')->name('usertype.create');|g" "$ROUTES_FILE"

# Fix PUT /usuarios/tipos/{userType} - needs modify permission
sed -i "s|Route::put('/usuarios/tipos/{userType}', 'AccessLevelController@update')\s*->name('usertype.update');|Route::put('/usuarios/tipos/{userType}', 'AccessLevelController@update')->middleware('can:modify:554')->name('usertype.update');|g" "$ROUTES_FILE"

# Fix DELETE /usuarios/tipos/{userType} - needs remove permission
sed -i "s|Route::delete('/usuarios/tipos/{userType}', 'AccessLevelController@delete')\s*->name('usertype.delete');|Route::delete('/usuarios/tipos/{userType}', 'AccessLevelController@delete')->middleware('can:remove:554')->name('usertype.delete');|g" "$ROUTES_FILE"

# Verify the changes were applied
echo "Verifying changes..."
if grep -q "middleware('can:view:554')" "$ROUTES_FILE" && \
   grep -q "middleware('can:modify:554')" "$ROUTES_FILE" && \
   grep -q "middleware('can:remove:554')" "$ROUTES_FILE"; then
    echo "Authorization middleware successfully added to user type routes."
else
    echo "WARNING: Some changes may not have been applied. Attempting alternative fix..."

    # Alternative: Use a more flexible pattern matching
    # This handles cases where routes might have different formatting

    # Restore from backup
    cp "${ROUTES_FILE}.bak" "$ROUTES_FILE"

    # Use perl for more flexible regex
    perl -i -pe "s|(Route::get\('/usuarios/tipos/novo', 'AccessLevelController\@new'\))(?!.*middleware)|\$1->middleware('can:view:554')|g" "$ROUTES_FILE"
    perl -i -pe "s|(Route::get\('/usuarios/tipos/\{userType\}', 'AccessLevelController\@show'\))(?!.*middleware)|\$1->middleware('can:view:554')|g" "$ROUTES_FILE"
    perl -i -pe "s|(Route::post\('/usuarios/tipos', 'AccessLevelController\@create'\))(?!.*middleware)|\$1->middleware('can:modify:554')|g" "$ROUTES_FILE"
    perl -i -pe "s|(Route::put\('/usuarios/tipos/\{userType\}', 'AccessLevelController\@update'\))(?!.*middleware)|\$1->middleware('can:modify:554')|g" "$ROUTES_FILE"
    perl -i -pe "s|(Route::delete\('/usuarios/tipos/\{userType\}', 'AccessLevelController\@delete'\))(?!.*middleware)|\$1->middleware('can:remove:554')|g" "$ROUTES_FILE"
fi

# Clear Laravel route cache
echo "Clearing Laravel route cache..."
if command -v php &> /dev/null; then
    cd "$APP_DIR"
    php artisan route:clear 2>/dev/null || true
    php artisan cache:clear 2>/dev/null || true
    php artisan config:clear 2>/dev/null || true
fi

# Restart PHP-FPM if it's running (for changes to take effect)
echo "Restarting PHP-FPM..."
pkill -f "php-fpm" 2>/dev/null || true
sleep 2

# If using supervisord, restart the service
if command -v supervisorctl &> /dev/null; then
    supervisorctl restart php-fpm 2>/dev/null || true
fi

# If systemctl is available
if command -v systemctl &> /dev/null; then
    systemctl restart php-fpm 2>/dev/null || systemctl restart php8.3-fpm 2>/dev/null || true
fi

echo ""
echo "Fix applied successfully!"
echo ""
echo "Changes made to routes/web.php:"
echo "  - Added middleware('can:view:554') to /usuarios/tipos/novo route"
echo "  - Added middleware('can:view:554') to /usuarios/tipos/{userType} route"
echo "  - Added middleware('can:modify:554') to POST /usuarios/tipos route"
echo "  - Added middleware('can:modify:554') to PUT /usuarios/tipos/{userType} route"
echo "  - Added middleware('can:remove:554') to DELETE /usuarios/tipos/{userType} route"
echo ""
echo "This ensures that only users with the proper permissions (process 554)"
echo "can manage user types, preventing privilege escalation attacks."
