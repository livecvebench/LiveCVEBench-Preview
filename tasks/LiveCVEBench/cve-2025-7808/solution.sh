#!/bin/bash
# Solution script for fixing XSS vulnerability CVE-2025-7808 in WP Shopify plugin
set -e

# Path to the vulnerable file
VULN_FILE="/var/www/html/wp-content/plugins/wp-shopify/inc/functions.php"

# Wait for WordPress to be ready (plugin file to exist)
echo "Waiting for WordPress to be ready..."
MAX_WAIT=120
WAIT_COUNT=0
while [ ! -f "$VULN_FILE" ]; do
    if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
        echo "Error: Timeout waiting for plugin file at $VULN_FILE"
        exit 1
    fi
    sleep 2
    WAIT_COUNT=$((WAIT_COUNT + 2))
    echo "Waiting... ($WAIT_COUNT seconds)"
done

echo "Plugin file found at $VULN_FILE"
echo "Applying fix..."

# Create a backup
cp "$VULN_FILE" "${VULN_FILE}.bak"

# Apply fix using Python for reliability with complex string replacements
python3 << 'PYEOF'
file_path = '/var/www/html/wp-content/plugins/wp-shopify/inc/functions.php'

with open(file_path, 'r') as f:
    content = f.read()

# Fix 1: Sanitize product input
# Original: $product = trim(isset($_GET['product'])?$_GET['product']:(isset($atts['product'])?$atts['product']:''));
# Fixed: $product = isset($_GET['product']) ? sanitize_title_with_dashes(wp_unslash($_GET['product'])) : (isset($atts['product']) ? sanitize_title_with_dashes($atts['product']) : '');
old1 = "$product = trim(isset($_GET['product'])?$_GET['product']:(isset($atts['product'])?$atts['product']:''));"
new1 = "$product = isset($_GET['product']) ? sanitize_title_with_dashes(wp_unslash($_GET['product'])) : (isset($atts['product']) ? sanitize_title_with_dashes($atts['product']) : '');"
content = content.replace(old1, new1)

# Fix 2: Escape URL output with esc_url()
# Original: $product_url = "https://" . $wpsy_db_data['wpsy_url'] . "/products/" . sanitize_text_field($product);
# Fixed: $product_url = esc_url("https://" . $wpsy_db_data['wpsy_url'] . "/products/" . $product);
old2 = '$product_url = "https://" . $wpsy_db_data[\'wpsy_url\'] . "/products/" . sanitize_text_field($product);'
new2 = '$product_url = esc_url("https://" . $wpsy_db_data[\'wpsy_url\'] . "/products/" . $product);'
content = content.replace(old2, new2)

with open(file_path, 'w') as f:
    f.write(content)

print("Fix applied via Python")
PYEOF

# Verify the fix was applied by checking for the new patterns
if grep -q "sanitize_title_with_dashes(wp_unslash" "$VULN_FILE" && grep -q 'esc_url("https://' "$VULN_FILE"; then
    echo "Fix successfully applied!"
else
    echo "Warning: Fix may not have been applied correctly."
    exit 1
fi

# Verify PHP syntax is valid
php -l "$VULN_FILE"

echo "Solution applied successfully!"
