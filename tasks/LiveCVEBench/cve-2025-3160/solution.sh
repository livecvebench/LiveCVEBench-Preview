#!/bin/bash
# Solution script for fixing the null pointer dereference in AddNodeHashes
# Also fixes related assertion failure in BaseImporter.cpp for empty file paths
set -e

cd /app

echo "=== Applying fix to SceneCombiner.cpp ==="

# The fix adds a null pointer check at the beginning of AddNodeHashes function
# This prevents crash when processing malformed LWS files with null nodes

TARGET_FILE="/app/code/Common/SceneCombiner.cpp"
TARGET_FILE2="/app/code/Common/BaseImporter.cpp"

if [ ! -f "$TARGET_FILE" ]; then
    echo "ERROR: Target file not found: $TARGET_FILE"
    exit 1
fi

# Check if fix is already applied
if grep -q "if (node == nullptr)" "$TARGET_FILE"; then
    echo "SceneCombiner fix already applied."
else
    # Apply the fix using sed
    # Insert null check after the function declaration line
    # Note: Use ASSIMP_LOG_ERROR (not ASSIMP_LOG_VERBOSE_ERROR which doesn't exist)
    sed -i '/void SceneCombiner::AddNodeHashes(aiNode \*node, std::set<unsigned int> \&hashes) {/a\    if (node == nullptr) {\n        ASSIMP_LOG_ERROR("Pointer to aiNode is nullptr.");\n        return;\n    }\n' "$TARGET_FILE"

    echo "SceneCombiner fix applied successfully."
fi

# Verify the fix was applied
if grep -q "if (node == nullptr)" "$TARGET_FILE"; then
    echo "=== Verification: SceneCombiner fix is present in source code ==="
else
    echo "ERROR: SceneCombiner fix verification failed!"
    exit 1
fi

echo "=== Applying fix to BaseImporter.cpp ==="

# Fix assertion failure when LoadObject has empty path
# Replace ai_assert(!file.empty()) with proper error handling

if [ ! -f "$TARGET_FILE2" ]; then
    echo "ERROR: Target file not found: $TARGET_FILE2"
    exit 1
fi

# Check if fix is already applied (look for the error message we add)
if grep -q "BatchLoader: empty file path provided" "$TARGET_FILE2"; then
    echo "BaseImporter fix already applied."
else
    # Replace the assertion with a proper check and early return
    sed -i 's/ai_assert(!file.empty());/if (file.empty()) {\n        ASSIMP_LOG_ERROR("BatchLoader: empty file path provided to AddLoadRequest");\n        return 0;\n    }/' "$TARGET_FILE2"

    echo "BaseImporter fix applied successfully."
fi

# Verify the fix was applied
if grep -q "BatchLoader: empty file path provided" "$TARGET_FILE2"; then
    echo "=== Verification: BaseImporter fix is present in source code ==="
else
    echo "ERROR: BaseImporter fix verification failed!"
    exit 1
fi

echo "=== Rebuilding assimp ==="

# Rebuild the library to compile the fix
if [ -f /app/build/Makefile ] || [ -f /app/Makefile ]; then
    # If using Makefile build system
    if [ -d /app/build ]; then
        cd /app/build
        make -j$(nproc) 2>/dev/null || make
    else
        cd /app
        make -j$(nproc) 2>/dev/null || make
    fi
elif [ -f /app/build.ninja ] || [ -f /app/build/build.ninja ]; then
    # If using Ninja build system
    if [ -f /app/build/build.ninja ]; then
        cd /app/build
        ninja
    else
        cd /app
        ninja
    fi
else
    # Try cmake rebuild
    cd /app
    if [ -d build ]; then
        cd build
        cmake --build . -j$(nproc) 2>/dev/null || cmake --build .
    else
        cmake --build . -j$(nproc) 2>/dev/null || cmake --build .
    fi
fi

echo "=== Fix applied and rebuilt successfully ==="
