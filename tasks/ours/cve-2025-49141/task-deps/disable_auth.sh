#!/bin/bash
set -e

echo "Applying authentication bypass patch..."

OPS_FILE="/var/www/html/system/backend/php/lib/Operations.php"
HAXCMS_FILE="/var/www/html/system/backend/php/lib/HAXCMS.php"

# Backup
cp "$OPS_FILE" "${OPS_FILE}.bak"
cp "$HAXCMS_FILE" "${HAXCMS_FILE}.bak"

# 1. Modify validateRequestToken in gitImportSite
echo "1. Bypassing validateRequestToken..."
python3 << 'PYEOF'
import re
with open('/var/www/html/system/backend/php/lib/Operations.php', 'r') as f:
    content = f.read()
content = re.sub(
    r"if \(\$GLOBALS\['HAXCMS'\]->validateRequestToken\(\)\)",
    "if (true)",
    content
)
with open('/var/www/html/system/backend/php/lib/Operations.php', 'w') as f:
    f.write(content)
PYEOF

# 2. Modify validateJWT to return success directly
echo "2. Bypassing validateJWT..."
python3 << 'PYEOF'
import re
with open('/var/www/html/system/backend/php/lib/HAXCMS.php', 'r') as f:
    content = f.read()

# Replace the entire validateJWT function
pattern = r'(public function validateJWT\([^)]*\)[^{]*\{).*?(\n\s{2,4}(?:public|private) function)'
replacement = r'\1\n      return array("id" => "test", "user" => array("name" => "test"));\n    }\n\n\2'
content = re.sub(pattern, replacement, content, flags=re.DOTALL)

with open('/var/www/html/system/backend/php/lib/HAXCMS.php', 'w') as f:
    f.write(content)
PYEOF

# 3. Disable URL filter_var validation (Critical!)
echo "3. Disabling URL validation..."
python3 << 'PYEOF'
import re
with open('/var/www/html/system/backend/php/lib/Operations.php', 'r') as f:
    content = f.read()

# Note: Removed the backslash before $repoUrl here
# Because 'PYEOF' prevents shell expansion, $repoUrl is treated as a literal string
content = re.sub(
    r"if \(filter_var\(\$repoUrl, FILTER_VALIDATE_URL\) !== false &&\s*strpos\(\$repoUrl, '\.git'\)",
    "if (true && strpos($repoUrl, '.git')", 
    content
)
with open('/var/www/html/system/backend/php/lib/Operations.php', 'w') as f:
    f.write(content)
PYEOF

# Verify PHP syntax
echo "4. Verifying syntax..."
php -l "$OPS_FILE" || exit 1
php -l "$HAXCMS_FILE" || exit 1

echo "âœ“ Patch applied successfully"