#!/bin/bash
# Solution script for filestream_vscanf uninitialized variable bug
#
# The vulnerability is in the filestream_vscanf function implementation.
# The local variable 'sublen' is declared but not initialized. When sscanf()
# fails to match, %n doesn't write to sublen, leaving it with garbage value.
#
# Fix: Initialize sublen to 0
#   Before: int sublen;
#   After:  int sublen = 0;
#
# This fix is applied by replacing /app/file_stream.c with the fixed version.
# The file_stream.c is baked into the Docker image and persists across test runs.

set -e

echo "CVE-2025-9136 fix for filestream_vscanf uninitialized variable."
echo ""

# Source files in /app (from Dockerfile COPY)
VULN_SOURCE="/app/file_stream.c"
FIXED_SOURCE="/app/file_stream_fixed.c"

if [ ! -f "$VULN_SOURCE" ]; then
    echo "ERROR: Source file not found: $VULN_SOURCE"
    exit 1
fi

if [ ! -f "$FIXED_SOURCE" ]; then
    echo "ERROR: Fixed source file not found: $FIXED_SOURCE"
    exit 1
fi

# Check if already fixed by comparing with the fixed version
if diff -q "$VULN_SOURCE" "$FIXED_SOURCE" > /dev/null 2>&1; then
    echo "Fix already applied - file_stream.c is the fixed version."
else
    echo "Applying fix - replacing vulnerable file_stream.c with fixed version..."
    cp "$FIXED_SOURCE" "$VULN_SOURCE"

    # Verify the fix was applied
    if diff -q "$VULN_SOURCE" "$FIXED_SOURCE" > /dev/null 2>&1; then
        echo "Fix applied successfully."
        echo "  The 'sublen' variable is now initialized to 0."
    else
        echo "ERROR: Failed to apply fix"
        exit 1
    fi
fi

echo ""
echo "Fix complete. The vulnerability is mitigated by initializing sublen to 0."
echo "When sscanf() fails and %n doesn't write, bufiter += 0 (stays in place)"
echo "instead of jumping to a garbage location."
