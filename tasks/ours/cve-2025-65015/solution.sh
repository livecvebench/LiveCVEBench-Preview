#!/bin/bash
# Solution script for joserfc error message data exposure fix
# Removes raw data from ExceededSizeError exception messages
set -e

cd /app

echo "Applying fix to joserfc size validation error messages..."

# Fix RFC7515 registry (JWS) - 3 methods
# Note: The official fix has "Signature of exceeds" (with "of") as a typo

# Fix validate_header_size
sed -i "s/Header size of '{header!r}' exceeds/Header size exceeds/g" /app/src/joserfc/_rfc7515/registry.py

# Fix validate_payload_size
sed -i "s/Payload size of '{payload!r}' exceeds/Payload size exceeds/g" /app/src/joserfc/_rfc7515/registry.py

# Fix validate_signature_size - matches official fix with "of" retained
sed -i "s/Signature of '{signature!r}' exceeds/Signature of exceeds/g" /app/src/joserfc/_rfc7515/registry.py

# Fix RFC7516 registry (JWE) - 5 methods

# Fix validate_protected_header_size
sed -i "s/Header size of '{header!r}' exceeds/Header size exceeds/g" /app/src/joserfc/_rfc7516/registry.py

# Fix validate_encrypted_key_size
sed -i "s/Encrypted key size of '{ek!r}' exceeds/Encrypted key size exceeds/g" /app/src/joserfc/_rfc7516/registry.py

# Fix validate_initialization_vector_size
sed -i "s/Initialization vector size of '{iv!r}' exceeds/Initialization vector size exceeds/g" /app/src/joserfc/_rfc7516/registry.py

# Fix validate_ciphertext_size
sed -i "s/Ciphertext size of '{ciphertext!r}' exceeds/Ciphertext size exceeds/g" /app/src/joserfc/_rfc7516/registry.py

# Fix validate_auth_tag_size
sed -i "s/Auth tag size of '{tag!r}' exceeds/Auth tag size exceeds/g" /app/src/joserfc/_rfc7516/registry.py

echo "Fix applied successfully."

# Verify the fix was applied correctly
echo "Verifying fix..."

# Check that raw data patterns are removed from RFC7515
if grep -q "'{header!r}'" /app/src/joserfc/_rfc7515/registry.py; then
    echo "ERROR: Fix not applied to header in RFC7515"
    exit 1
fi

if grep -q "'{payload!r}'" /app/src/joserfc/_rfc7515/registry.py; then
    echo "ERROR: Fix not applied to payload in RFC7515"
    exit 1
fi

if grep -q "'{signature!r}'" /app/src/joserfc/_rfc7515/registry.py; then
    echo "ERROR: Fix not applied to signature in RFC7515"
    exit 1
fi

# Check that raw data patterns are removed from RFC7516
if grep -q "'{header!r}'" /app/src/joserfc/_rfc7516/registry.py; then
    echo "ERROR: Fix not applied to header in RFC7516"
    exit 1
fi

if grep -q "'{ek!r}'" /app/src/joserfc/_rfc7516/registry.py; then
    echo "ERROR: Fix not applied to encrypted key in RFC7516"
    exit 1
fi

if grep -q "'{iv!r}'" /app/src/joserfc/_rfc7516/registry.py; then
    echo "ERROR: Fix not applied to IV in RFC7516"
    exit 1
fi

if grep -q "'{ciphertext!r}'" /app/src/joserfc/_rfc7516/registry.py; then
    echo "ERROR: Fix not applied to ciphertext in RFC7516"
    exit 1
fi

if grep -q "'{tag!r}'" /app/src/joserfc/_rfc7516/registry.py; then
    echo "ERROR: Fix not applied to auth tag in RFC7516"
    exit 1
fi

echo "All fixes verified successfully."
