# Dockerfile for CVE-2025-50201 - WeGIA OS Command Injection
# WeGIA version 3.4.1 - Vulnerable to command injection in debug_info.php

FROM php:8.2-apache-bookworm

WORKDIR /var/www/WeGIA

# Environment variables for database
ENV DB_HOST=db \
    DB_NAME=wegia \
    DB_USER=wegiauser \
    DB_PASSWORD=wegia_password

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    ca-certificates \
    default-mysql-client \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libzip-dev \
    libxml2-dev \
    libicu-dev \
    libonig-dev \
    && rm -rf /var/lib/apt/lists/*

# Configure and install PHP extensions
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
    pdo_mysql \
    mysqli \
    gd \
    intl \
    mbstring \
    opcache \
    soap \
    xml \
    zip

# Clone WeGIA version 3.4.1 (vulnerable version)
RUN git clone --depth 1 --branch 3.4.1 https://github.com/LabRedesCefetRJ/WeGIA.git . \
    && rm -rf .git

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Configure Apache
RUN a2enmod rewrite

# Set the DocumentRoot to WeGIA application
RUN sed -i 's|/var/www/html|/var/www/WeGIA|g' /etc/apache2/sites-available/000-default.conf \
    && echo '<Directory /var/www/WeGIA>\n    Options -Indexes +FollowSymLinks\n    AllowOverride All\n    Require all granted\n</Directory>' >> /etc/apache2/apache2.conf

# Set proper permissions
RUN chown -R www-data:www-data /var/www/WeGIA

# Expose port 80
EXPOSE 80

# Run entrypoint script
# CMD ["/entrypoint.sh"]  # Moved to docker-compose.yaml
