FROM ubuntu:22.04

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required + build tools)
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Clone vulnerable version of PCRE2 and remove git history
RUN git clone --depth 1 --branch pcre2-10.45 \
    https://github.com/PCRE2Project/pcre2.git . && \
    rm -rf .git

# Build with AddressSanitizer for vulnerability detection
RUN cmake -B build -DCMAKE_BUILD_TYPE=Debug \
    -DCMAKE_C_FLAGS="-fsanitize=address -g -fno-omit-frame-pointer" \
    -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" \
    -DPCRE2_SUPPORT_JIT=OFF \
    && cmake --build build -j$(nproc)

# Set ASAN options for testing
ENV ASAN_OPTIONS="detect_leaks=0:halt_on_error=0:print_stacktrace=1"

# Default working directory for tests
WORKDIR /app/build

# Keep container running
# CMD ["sleep", "infinity"]
