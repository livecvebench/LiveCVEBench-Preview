"""
Vulnerability Tests - Test that ID tokens are rejected when validated as access tokens

These tests verify that the token validation properly distinguishes between
ID tokens and access tokens. In the vulnerable version, ID tokens pass
validation when used as access tokens.

FAIL in vulnerable state (validation passes when it should fail)
PASS in fixed state (validation correctly rejects ID tokens as access tokens)
"""

import subprocess
import pytest
import os

# Base directory for the application
APP_DIR = "/app"
TESTS_DIR = "/tests"


def run_php_test(test_filter: str) -> subprocess.CompletedProcess:
    """Run a specific PHP test using Pest."""
    result = subprocess.run(
        [
            f"{APP_DIR}/vendor/bin/pest",
            f"{TESTS_DIR}/test_vuln.php",
            "--filter", test_filter,
            "--colors=never",
        ],
        capture_output=True,
        text=True,
        cwd=APP_DIR,
    )
    return result


class TestIDTokenAsAccessTokenRejection:
    """
    Test that ID tokens are properly rejected when validated as access tokens.

    The vulnerability allows ID tokens (which have a 'nonce' claim and audience
    set to clientId) to pass validation when used as access tokens. This is
    because the vulnerable code unconditionally adds clientId to the expected
    audience list for all token types.

    After the fix:
    - Tokens with a 'nonce' claim are rejected when validating as access tokens
    - clientId is only added to audience for non-access tokens or as fallback
    """

    def test_rejects_id_token_with_nonce_as_access_token(self):
        """
        ID token with nonce claim should be rejected when validated as access token.

        This is the core vulnerability test. ID tokens contain a 'nonce' claim
        for replay protection. Access tokens should never have this claim.
        """
        result = run_php_test("rejects ID token with nonce claim when validated as access token")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"

    def test_rejects_id_token_with_any_nonce_value(self):
        """
        ID token with any nonce value should be rejected as access token.

        Tests that the fix doesn't just check for a specific nonce value.
        """
        result = run_php_test("rejects ID token with any nonce value when validated as access token")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"

    def test_rejects_rs256_id_token_as_access_token(self):
        """
        RS256-signed ID token should also be rejected when validated as access token.

        Ensures the fix works regardless of the signing algorithm used.
        """
        result = run_php_test("rejects RS256 ID token when validated as access token")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"

    def test_rejects_id_token_with_empty_nonce(self):
        """
        ID token with empty string nonce should be rejected.

        Edge case: nonce claim exists but with empty string value.
        """
        result = run_php_test("rejects ID token with empty nonce when validated as access token")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"


class TestAudienceValidation:
    """
    Test that audience validation correctly distinguishes token types.

    The vulnerability also allows access tokens with clientId audience to
    pass validation when API audience is configured, because clientId is
    unconditionally added to the expected audience list.
    """

    def test_rejects_access_token_with_clientid_when_api_configured(self):
        """
        Access token with clientId audience should be rejected when API audience is configured.

        When an API audience is configured, access tokens should only be valid
        if their audience matches the API identifier, not the clientId.
        """
        result = run_php_test("rejects access token with clientId audience when API audience is configured")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"

    def test_rejects_token_with_access_format_and_nonce(self):
        """
        Token with both access token format and nonce claim should be rejected.

        Tests the scenario where an attacker creates a hybrid token.
        """
        result = run_php_test("rejects token with both access token format and nonce claim")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"


class TestAttackScenario:
    """
    Test the actual attack scenario where an ID token is used as an access token.

    Attack flow:
    1. Attacker obtains a valid ID token (through normal authentication)
    2. Attacker presents the ID token where an access token is expected
    3. Vulnerable code accepts it because clientId matches the audience
    4. Attacker gains unauthorized access to protected resources
    """

    def test_id_token_audience_does_not_match_access_token_validation(self):
        """
        ID token's audience (clientId) should not match when validating as access token.

        This is the primary attack scenario. In the vulnerable version,
        the SDK adds clientId to the expected audience list, allowing
        ID tokens (with aud=clientId) to pass access token validation.
        """
        result = run_php_test("does not allow ID token audience to match when validating as access token")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"


class TestVariousNonceFormats:
    """
    Test rejection of ID tokens with various nonce formats.

    Ensures the fix handles different nonce value formats that an attacker
    might use.
    """

    def test_rejects_various_nonce_formats(self):
        """
        Rejects tokens with various nonce formats.

        This tests all nonce format variations at once using the PHP data provider test.
        """
        result = run_php_test("various")
        assert result.returncode == 0, f"Test failed - vulnerability exists: {result.stdout}\n{result.stderr}"
