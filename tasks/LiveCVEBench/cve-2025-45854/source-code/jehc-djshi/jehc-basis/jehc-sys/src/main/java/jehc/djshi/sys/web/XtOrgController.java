package jehc.djshi.sys.web;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import jehc.djshi.common.annotation.Auth;
import jehc.djshi.common.base.*;
import jehc.djshi.common.util.ExceptionUtil;
import jehc.djshi.common.util.JsonUtil;
import jehc.djshi.common.util.StringUtil;
import jehc.djshi.sys.model.XtDepartInfo;
import jehc.djshi.sys.model.XtPost;
import jehc.djshi.sys.service.XtDepartInfoService;
import jehc.djshi.sys.service.XtPostService;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import javax.annotation.Resource;
/**
 * 平台组织机构
 * @author邓纯杰
 *
 */
@RestController
@RequestMapping("/xtOrg")
@Api(value = "平台组织机构API",tags = "平台组织机构API",description = "平台组织机构API")
public class XtOrgController extends BaseAction {

	@Resource
	private XtDepartInfoService xtDepartinfoService;

	@Resource
	private XtPostService xtPostService;
	
	/**
	 * 组织机构树列表
	 */
	@ApiOperation(value="组织机构树列表", notes="组织机构树列表")
	@GetMapping(value="/list")
	@Auth(value = "/xtOrg/list",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult orgTree(){
		Map<String, Object> condition = new HashMap<String, Object>();
		List<BaseZTreeEntity> list = new ArrayList<BaseZTreeEntity>();
		List<XtDepartInfo> xtDepartinfoList = xtDepartinfoService.getXtDepartInfoListAll(condition);
		for(int i = 0; i < xtDepartinfoList.size(); i++){
			XtDepartInfo xtDepartInfo = xtDepartinfoList.get(i);
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(xtDepartInfo.getId());
			BaseZTreeEntity.setPId(xtDepartInfo.getParentId());
			BaseZTreeEntity.setText(xtDepartInfo.getName());
			BaseZTreeEntity.setName(xtDepartInfo.getName());
			BaseZTreeEntity.setExpanded(true);
			BaseZTreeEntity.setSingleClickExpand(true);
			BaseZTreeEntity.setTempObject("DEPART");
			list.add(BaseZTreeEntity);
		}
		
		//根岗位遍历
		List<XtPost> xtPostList = xtPostService.getXtPostInfoList(condition);
		for(XtPost xtPost:xtPostList){
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(xtPost.getId());
			BaseZTreeEntity.setPId(xtPost.getDepartInfoId());
			BaseZTreeEntity.setText(xtPost.getName());
			BaseZTreeEntity.setName(xtPost.getName());
			BaseZTreeEntity.setExpanded(true);
			BaseZTreeEntity.setSingleClickExpand(true);
			BaseZTreeEntity.setTempObject("POST");
			list.add(BaseZTreeEntity);
		}
		
		//非根岗位
		xtPostList = xtPostService.getXtPostInfoUnRootList(condition);
		for(XtPost xtPost : xtPostList){
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(xtPost.getId());
			BaseZTreeEntity.setPId(xtPost.getParentId());
			BaseZTreeEntity.setText(xtPost.getName());
			BaseZTreeEntity.setName(xtPost.getName());
			BaseZTreeEntity.setExpanded(true);
			BaseZTreeEntity.setSingleClickExpand(true);
			BaseZTreeEntity.setTempObject("POST");
			list.add(BaseZTreeEntity);
		}
		BaseZTreeEntity baseZTreeEntity = new BaseZTreeEntity();
		List<BaseZTreeEntity> baseZTreeEntityList = baseZTreeEntity.buildTree(list,"0");
		String json = JsonUtil.toFastJson(baseZTreeEntityList);
		return outStr(json);
	}

	/**
	 * 组织机构树列表
	 */
	@ApiOperation(value="组织机构树列表", notes="组织机构树列表")
	@GetMapping(value="/tree")
	@Auth(value = "/xtOrg/tree",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getXtOrgTree(){
		Map<String, Object> condition = new HashMap<String, Object>();
		List<BaseZTreeEntity> list = new ArrayList<BaseZTreeEntity>();
		List<XtDepartInfo> xtDepartInfoList = xtDepartinfoService.getXtDepartInfoListAll(condition);

		for(int i = 0; i < xtDepartInfoList.size(); i++){

			XtDepartInfo xtDepartInfo = xtDepartInfoList.get(i);
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(xtDepartInfo.getId());
			BaseZTreeEntity.setPId(xtDepartInfo.getParentId());
			BaseZTreeEntity.setText(xtDepartInfo.getName());
			BaseZTreeEntity.setName(xtDepartInfo.getName());
			BaseZTreeEntity.setExpanded(false);
			BaseZTreeEntity.setSingleClickExpand(true);
			BaseZTreeEntity.setTempObject("DEPART");
			list.add(BaseZTreeEntity);

		}

		//根岗位遍历
		List<XtPost> xtPostList = xtPostService.getXtPostInfoList(condition);
		for(XtPost xtPost:xtPostList){
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(xtPost.getId());
			BaseZTreeEntity.setPId(xtPost.getDepartInfoId());
			BaseZTreeEntity.setText(xtPost.getName());
			BaseZTreeEntity.setName(xtPost.getName());
			BaseZTreeEntity.setExpanded(false);
			BaseZTreeEntity.setSingleClickExpand(true);
			BaseZTreeEntity.setTempObject("POST");
			list.add(BaseZTreeEntity);
		}

		//非根岗位
		xtPostList = xtPostService.getXtPostInfoUnRootList(condition);
		for(XtPost xtPost : xtPostList){
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(xtPost.getId());
			BaseZTreeEntity.setPId(xtPost.getParentId());
			BaseZTreeEntity.setText(xtPost.getName());
			BaseZTreeEntity.setName(xtPost.getName());
			BaseZTreeEntity.setExpanded(false);
			BaseZTreeEntity.setSingleClickExpand(true);
			BaseZTreeEntity.setTempObject("POST");
			list.add(BaseZTreeEntity);
		}
		BaseZTreeEntity baseZTreeEntity = new BaseZTreeEntity();
		List<BaseZTreeEntity> baseZTreeEntityList = baseZTreeEntity.buildTree(list,"0");
		String json = JsonUtil.toFastJson(baseZTreeEntityList);
		return outStr(json);
	}
	
	/**
	 * 获取静态部门及岗位组成的树
	 * @param id
	 * @param type
	 */
	@ApiOperation(value=" 获取静态部门及岗位组成的树", notes=" 获取静态部门及岗位组成的树")
	@GetMapping(value="/static/xtDepartinfo/post/treegrid/{id}/{type}")
	@Auth(value = "/xtOrg/static/xtDepartinfo/post/treegrid",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getStaticDepartinfoAndPostTreeGrid(@PathVariable("id")String id,@PathVariable("type")String type){
		Map<String, Object> condition = new HashMap<String, Object>();
		List<XtDepartInfo> xtDepartInfoList = xtDepartinfoService.getXtDepartInfoListAll(condition);
		List<XtPost> xtPostList = xtPostService.getXtPostListAll(condition);
		List<BaseTreeGridEntity> list = new ArrayList<BaseTreeGridEntity>();
		for(int i = 0; i < xtDepartInfoList.size(); i++){
			XtDepartInfo xtDepartInfo = xtDepartInfoList.get(i);
			BaseTreeGridEntity BaseTreeGridEntity = new BaseTreeGridEntity();
			BaseTreeGridEntity.setId(xtDepartInfo.getId());
			BaseTreeGridEntity.setPid(xtDepartInfo.getParentId());
			BaseTreeGridEntity.setText(xtDepartInfo.getName());
			BaseTreeGridEntity.setExpanded(false);
			BaseTreeGridEntity.setSingleClickExpand(true);
			BaseTreeGridEntity.setTempObject("部门");
			BaseTreeGridEntity.setContent("");
			BaseTreeGridEntity.setIntegerappend(xtDepartInfo.getId()+"@"+xtDepartInfo.getName());
			BaseTreeGridEntity.setIcon("/deng/images/icons/target.png");
			list.add(BaseTreeGridEntity);
			for(int j = 0; j < xtPostList.size(); j++){
				XtPost xtPost = xtPostList.get(j);
				BaseTreeGridEntity = new BaseTreeGridEntity();
				BaseTreeGridEntity.setId(xtPost.getId());
				BaseTreeGridEntity.setText(xtPost.getName());
				BaseTreeGridEntity.setExpanded(false);
				BaseTreeGridEntity.setSingleClickExpand(true);
				BaseTreeGridEntity.setTempObject("岗位");
				BaseTreeGridEntity.setIcon("/deng/images/icons/target_point.png");
				BaseTreeGridEntity.setContent("");
				BaseTreeGridEntity.setIntegerappend(xtPost.getDepartInfoId()+"@"+xtPost.getDepartInfoName());
				if(xtPost.getDepartInfoId().equals(xtDepartInfo.getId()) && xtPost.getParentId().equals("0")){
					BaseTreeGridEntity.setPid(xtPost.getDepartInfoId());
				}else if(xtPost.getDepartInfoId().equals(xtDepartInfo.getId()) && !xtPost.getParentId().equals("0")){
					BaseTreeGridEntity.setPid(xtPost.getParentId());
				}
				list.add(BaseTreeGridEntity);
			}
		}
		BaseTreeGridEntity baseTreeGridEntity = new BaseTreeGridEntity();
		List<BaseTreeGridEntity> baseTreeGridEntityList = baseTreeGridEntity.buildTree(list,"0");
		String json = JsonUtil.toFastJson(baseTreeGridEntityList);
		return outStr(json);
	}
	
	/**
	* 添加或编辑
	* @param xtDepartInfo
	*/
	@PostMapping(value="/xtDepartinfo/saveOrUpdate")
	@ApiOperation(value=" 添加或编辑部门", notes=" 添加或编辑部门")
	public BaseResult saveOrUpdateXtDepartInfo(@RequestBody XtDepartInfo xtDepartInfo){
		int i = 0;
		if(StringUtil.isEmpty(xtDepartInfo.getParentId())){
			xtDepartInfo.setParentId("0");
		}
		if(StringUtils.isEmpty(xtDepartInfo.getId())){
			xtDepartInfo.setId(toUUID());
			i=xtDepartinfoService.addXtDepartInfo(xtDepartInfo);
		}else{
			//编辑
			i=xtDepartinfoService.updateXtDepartInfo(xtDepartInfo);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}
	
	/**
	* 删除
	* @param map
	*/
	@DeleteMapping(value="/delete")
	@ApiOperation(value=" 删除（多参数传递）", notes=" 删除（多参数传递）")
	public BaseResult delXtOrg(@RequestBody Map<String,String> map){
		int i = 0;
		String tempObject = ""+map.get("tempObject");
		if(StringUtils.isEmpty(tempObject)){
			throw new ExceptionUtil("未能获取到tempObject");
		}
		String id = ""+map.get("id");
		if(StringUtils.isEmpty(id)){
			throw new ExceptionUtil("未能获取到id");
		}
		if(tempObject.equals("DEPART")){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id",id.split(","));
			i=xtDepartinfoService.delXtDepartInfo(condition);
		}else if(tempObject.equals("POST")){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id",id.split(","));
			i=xtPostService.delXtPost(condition);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}
	
	/**
	* 添加
	* @param xtPost
	*/
	@PostMapping(value="/xtPost/saveOrUpdate")
	@ApiOperation(value=" 添加或编辑岗位", notes=" 添加或编辑岗位")
	public BaseResult saveOrUpdateXtPost(@RequestBody XtPost xtPost){
		int i = 0;
		if(StringUtil.isEmpty(xtPost.getParentId())){
			xtPost.setParentId("0");
		}
		if(StringUtils.isEmpty(xtPost.getId())){
			//新增
			xtPost.setId(toUUID());
			i=xtPostService.addXtPost(xtPost);
		}else{
			//编辑
			i=xtPostService.updateXtPost(xtPost);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}

	/**
	 * 部门组织机构
	 */
	@ApiOperation(value="部门组织机构", notes="部门组织机构")
	@GetMapping(value="/depart/tree")
	@Auth(value = "/xtOrg/depart/tree",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult departTree(){
		Map<String, Object> condition = new HashMap<String, Object>();
		List<BaseJSTreeEntity> list = new ArrayList<BaseJSTreeEntity>();
		List<XtDepartInfo> xtDepartInfoList = xtDepartinfoService.getXtDepartInfoListAll(condition);
		for(int i = 0; i < xtDepartInfoList.size(); i++){
			XtDepartInfo xtDepartInfo = xtDepartInfoList.get(i);
			BaseJSTreeEntity baseJSTreeEntity = new BaseJSTreeEntity();
			baseJSTreeEntity.setId(xtDepartInfo.getId());
			baseJSTreeEntity.setParent(xtDepartInfo.getParentId());
			baseJSTreeEntity.setText(xtDepartInfo.getName());
			baseJSTreeEntity.setSingleClickExpand(true);
			baseJSTreeEntity.setTempObject("DEPART");
			list.add(baseJSTreeEntity);
		}
		BaseJSTreeEntity baseJSTreeEntity = new BaseJSTreeEntity();
		List<BaseJSTreeEntity> baseJSTreeEntitiesList = baseJSTreeEntity.buildTree(list,"0");
		/*根目录则显示方法
		BaseJSTree baseJSTree = new BaseJSTree("部门",baseJSTreeEntitiesList,new BaseJSTreeStateEntity(false,false,false));
		return new BaseResult(baseJSTree);
		*/
		return new BaseResult(JsonUtil.toFastJson(baseJSTreeEntitiesList));
	}

	/**
	 * 岗位树（即职务）
	 */
	@ApiOperation(value="岗位树", notes="岗位树")
	@GetMapping(value="/post/tree")
	@Auth(value = "/xtOrg/post/tree",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult postTree(){
		Map<String, Object> condition = new HashMap<String, Object>();
		List<BaseJSTreeEntity> list = new ArrayList<BaseJSTreeEntity>();
		List<XtPost> xtPostList = xtPostService.getXtPostListAll(condition);
		for(XtPost xtPost:xtPostList){
			BaseJSTreeEntity baseJSTreeEntity = new BaseJSTreeEntity();
			baseJSTreeEntity.setId(xtPost.getId());
			baseJSTreeEntity.setParent(xtPost.getParentId());
			baseJSTreeEntity.setText(xtPost.getName());
			baseJSTreeEntity.setSingleClickExpand(true);
			baseJSTreeEntity.setTempObject("POST");
			list.add(baseJSTreeEntity);
		}
		BaseJSTreeEntity baseJSTreeEntity = new BaseJSTreeEntity();
		List<BaseJSTreeEntity> baseJSTreeEntitiesList = baseJSTreeEntity.buildTree(list,"0");
		/*根目录则显示方法
		BaseJSTree baseJSTree = new BaseJSTree("岗位",baseJSTreeEntitiesList,new BaseJSTreeStateEntity(false,false,false));
		return new BaseResult(baseJSTree);
		*/
		return new BaseResult(JsonUtil.toFastJson(baseJSTreeEntitiesList));
	}
}
