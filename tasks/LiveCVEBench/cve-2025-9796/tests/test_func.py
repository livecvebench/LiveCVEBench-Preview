"""
Functionality Tests for EncodeUtils.xssFilter

These tests verify that the xssFilter function correctly handles various inputs:
- Normal HTML content with <!--HTML--> prefix should be preserved
- Script tags should be filtered
- javascript: protocol should be filtered
- vbscript: protocol should be filtered
- Normal content without HTML prefix gets character encoding

These tests should PASS in both vulnerable and fixed versions.
"""

import subprocess
import os
import tempfile
import shutil
import pytest


class TestXSSFilterFunctionality:
    """Test that the xssFilter function works correctly for legitimate use cases"""

    @classmethod
    def setup_class(cls):
        """Set up the test environment - compile the Java test harness"""
        cls.test_dir = tempfile.mkdtemp()
        cls.java_file = os.path.join(cls.test_dir, "XSSFilterFuncTest.java")

        # Create a Java test that reads from the actual EncodeUtils source
        java_code = r'''
import java.util.*;
import java.util.regex.*;
import java.io.*;

public class XSSFilterFuncTest {

    private static List<Pattern> xssPatterns = new ArrayList<>();

    static {
        try {
            loadPatternsFromSource();
        } catch (Exception e) {
            System.err.println("Failed to load patterns: " + e.getMessage());
            // Load default vulnerable patterns as fallback
            loadDefaultPatterns();
        }
    }

    private static void loadPatternsFromSource() throws Exception {
        File file = new File("/app/common/src/main/java/com/jeesite/common/codec/EncodeUtils.java");
        Scanner scanner = new Scanner(file);
        StringBuilder content = new StringBuilder();
        while (scanner.hasNextLine()) {
            content.append(scanner.nextLine()).append("\n");
        }
        scanner.close();

        String src = content.toString();

        // Pattern 1: script/link/style/iframe tags
        xssPatterns.add(Pattern.compile("(<\\s*(script|link|style|iframe)([\\s\\S]*?)(>|</\\s*\\1\\s*>))|(</\\s*(script|link|style|iframe)\\s*>)", Pattern.CASE_INSENSITIVE));

        // Pattern 2: href/src with dangerous protocols - extract from source
        // Look for the line containing href|src pattern
        String hrefSrcPattern = extractHrefSrcPattern(src);
        xssPatterns.add(Pattern.compile(hrefSrcPattern, Pattern.CASE_INSENSITIVE));

        // Pattern 3: event handlers
        xssPatterns.add(Pattern.compile("\\s*/?\\s*on[a-zA-Z]+\\s*=\\s*(['\"]?)(.*?)\\1(?=\\s|>|/>)", Pattern.CASE_INSENSITIVE));

        // Pattern 4: eval/expression
        xssPatterns.add(Pattern.compile("(eval\\((.*?)\\)|expression\\((.*?)\\))", Pattern.CASE_INSENSITIVE));

        // Pattern 5: standalone javascript:/vbscript:
        xssPatterns.add(Pattern.compile("^(javascript:|vbscript:)", Pattern.CASE_INSENSITIVE));
    }

    private static String extractHrefSrcPattern(String src) {
        // Find the pattern line for href|src
        String[] lines = src.split("\n");
        for (String line : lines) {
            if (line.contains("href|src") && line.contains("Pattern.compile")) {
                // Extract pattern between first " after compile( and ", Pattern
                int compileIdx = line.indexOf("Pattern.compile(\"");
                if (compileIdx >= 0) {
                    int start = compileIdx + "Pattern.compile(\"".length();
                    int end = line.indexOf("\", Pattern");
                    if (end > start) {
                        // Convert Java source escaping to actual regex
                        // In Java source: \\s means regex \s, so we need to unescape
                        String pattern = line.substring(start, end);
                        return pattern.replace("\\\\", "\\");
                    }
                }
            }
        }
        // Default vulnerable pattern
        return "\\s*(href|src)\\s*=\\s*(\"\\s*(javascript|vbscript):[^\"]+\"|'\\s*(javascript|vbscript):[^']+'|(javascript|vbscript):[^\\s]+)\\s*(?=>)";
    }

    private static void loadDefaultPatterns() {
        xssPatterns.add(Pattern.compile("(<\\s*(script|link|style|iframe)([\\s\\S]*?)(>|</\\s*\\1\\s*>))|(</\\s*(script|link|style|iframe)\\s*>)", Pattern.CASE_INSENSITIVE));
        xssPatterns.add(Pattern.compile("\\s*(href|src)\\s*=\\s*(\"\\s*(javascript|vbscript):[^\"]+\"|'\\s*(javascript|vbscript):[^']+'|(javascript|vbscript):[^\\s]+)\\s*(?=>)", Pattern.CASE_INSENSITIVE));
        xssPatterns.add(Pattern.compile("\\s*/?\\s*on[a-zA-Z]+\\s*=\\s*(['\"]?)(.*?)\\1(?=\\s|>|/>)", Pattern.CASE_INSENSITIVE));
        xssPatterns.add(Pattern.compile("(eval\\((.*?)\\)|expression\\((.*?)\\))", Pattern.CASE_INSENSITIVE));
        xssPatterns.add(Pattern.compile("^(javascript:|vbscript:)", Pattern.CASE_INSENSITIVE));
    }

    public static String xssFilter(String text) {
        if (text == null) return null;

        String value = text.trim();
        for (Pattern pattern : xssPatterns) {
            Matcher matcher = pattern.matcher(value);
            if (matcher.find()) {
                value = matcher.replaceAll("");
            }
        }

        // Character encoding for non-HTML content
        if (!value.toLowerCase().startsWith("<!--html-->")
            && !value.toLowerCase().startsWith("<?xml ")
            && !(value.startsWith("{") && value.endsWith("}"))
            && !(value.startsWith("[") && value.endsWith("]"))) {
            StringBuilder sb = new StringBuilder();
            for (char c : value.toCharArray()) {
                switch (c) {
                    case '>': sb.append('\uff1e'); break;
                    case '<': sb.append('\uff1c'); break;
                    case '\'': sb.append('\uff07'); break;
                    case '"': sb.append('\uff02'); break;
                    default: sb.append(c);
                }
            }
            value = sb.toString();
        }
        return value;
    }

    public static void main(String[] args) {
        if (args.length == 0) {
            System.out.println("Usage: java XSSFilterFuncTest <test_name>");
            System.exit(1);
        }

        String testName = args[0];
        String result;

        try {
            switch (testName) {
                case "normal_html":
                    result = xssFilter("<!--HTML--><strong>Hello</strong>");
                    System.out.println(result.contains("<strong>") ? "PASS" : "FAIL:html_not_preserved");
                    break;

                case "script_tag":
                    result = xssFilter("<!--HTML--><script>alert(1)</script>text");
                    System.out.println(!result.contains("<script>") && !result.contains("</script>") ? "PASS" : "FAIL:script_not_filtered");
                    break;

                case "javascript_protocol":
                    result = xssFilter("<!--HTML--><a href=\"javascript:alert(1)\">click</a>");
                    System.out.println(!result.contains("javascript:") ? "PASS" : "FAIL:javascript_not_filtered");
                    break;

                case "vbscript_protocol":
                    result = xssFilter("<!--HTML--><a href=\"vbscript:msgbox(1)\">click</a>");
                    System.out.println(!result.contains("vbscript:") ? "PASS" : "FAIL:vbscript_not_filtered");
                    break;

                case "event_handler":
                    result = xssFilter("<!--HTML--><img src=\"x\" onerror=\"alert(1)\">");
                    System.out.println(!result.contains("onerror") ? "PASS" : "FAIL:event_not_filtered");
                    break;

                case "eval_expression":
                    result = xssFilter("<!--HTML-->eval(document.cookie)");
                    System.out.println(!result.contains("eval(") ? "PASS" : "FAIL:eval_not_filtered");
                    break;

                case "iframe":
                    result = xssFilter("<!--HTML--><iframe src=\"malicious.html\"></iframe>text");
                    System.out.println(!result.contains("<iframe") && !result.contains("</iframe>") ? "PASS" : "FAIL:iframe_not_filtered");
                    break;

                case "encoding_without_prefix":
                    result = xssFilter("<div>test</div>");
                    System.out.println(!result.contains("<") && !result.contains(">") ? "PASS" : "FAIL:not_encoded");
                    break;

                default:
                    System.out.println("FAIL:unknown_test:" + testName);
            }
        } catch (Exception e) {
            System.out.println("FAIL:exception:" + e.getMessage());
        }
    }
}
'''

        with open(cls.java_file, 'w') as f:
            f.write(java_code)

        # Compile the Java test
        result = subprocess.run(
            ['javac', cls.java_file],
            cwd=cls.test_dir,
            capture_output=True,
            text=True
        )
        if result.returncode != 0:
            raise RuntimeError(f"Failed to compile Java test: {result.stderr}")

    @classmethod
    def teardown_class(cls):
        """Clean up the test environment"""
        shutil.rmtree(cls.test_dir, ignore_errors=True)

    def run_java_test(self, test_type):
        """Run a specific Java test and return (passed, output)"""
        result = subprocess.run(
            ['java', 'XSSFilterFuncTest', test_type],
            cwd=self.test_dir,
            capture_output=True,
            text=True
        )
        output = result.stdout.strip()
        return output.startswith('PASS'), output

    def test_normal_html_preserved(self):
        """Normal HTML content with <!--HTML--> prefix should be preserved"""
        passed, output = self.run_java_test('normal_html')
        assert passed, f"Normal HTML with prefix should be preserved: {output}"

    def test_script_tags_filtered(self):
        """Script tags should be removed from input"""
        passed, output = self.run_java_test('script_tag')
        assert passed, f"Script tags should be filtered out: {output}"

    def test_javascript_protocol_filtered(self):
        """javascript: protocol in href should be filtered"""
        passed, output = self.run_java_test('javascript_protocol')
        assert passed, f"javascript: protocol should be filtered: {output}"

    def test_vbscript_protocol_filtered(self):
        """vbscript: protocol in href should be filtered"""
        passed, output = self.run_java_test('vbscript_protocol')
        assert passed, f"vbscript: protocol should be filtered: {output}"

    def test_event_handlers_filtered(self):
        """Event handlers (onclick, onerror, etc.) should be filtered"""
        passed, output = self.run_java_test('event_handler')
        assert passed, f"Event handlers should be filtered: {output}"

    def test_eval_expression_filtered(self):
        """eval() and expression() should be filtered"""
        passed, output = self.run_java_test('eval_expression')
        assert passed, f"eval() expressions should be filtered: {output}"

    def test_iframe_tags_filtered(self):
        """iframe tags should be filtered"""
        passed, output = self.run_java_test('iframe')
        assert passed, f"iframe tags should be filtered: {output}"

    def test_encoding_applied_without_prefix(self):
        """Content without HTML prefix should have special chars encoded"""
        passed, output = self.run_java_test('encoding_without_prefix')
        assert passed, f"Special characters should be encoded for non-HTML content: {output}"
