"""
Functionality tests for @digitalocean/do-markdownit callout and fence_environment plugins.

These tests verify that the plugins work correctly for legitimate use cases.
They should PASS in both vulnerable and fixed states.
"""

import subprocess
import json
import pytest

# Test script template with ARRAY configuration (correct configuration)
TEST_SCRIPT_ARRAY_CONFIG = """
const MarkdownIt = require("markdown-it");
const doMD = require("@digitalocean/do-markdownit");

// Configuration with ARRAY values (correct configuration)
const md = MarkdownIt().use(doMD, {
  callout: { allowedClasses: ["admin", "info", "warning", "note"] },
  fence_environment: { allowedEnvironments: ["production", "test", "development"] }
});

const input = %s;
const output = md.render(input);

console.log(JSON.stringify({
  input: input,
  output: output
}));
"""

# Test script with no restrictions (default behavior)
TEST_SCRIPT_NO_RESTRICT = """
const MarkdownIt = require("markdown-it");
const doMD = require("@digitalocean/do-markdownit");

// Configuration without restrictions
const md = MarkdownIt().use(doMD, {
  callout: {},
  fence_environment: {}
});

const input = %s;
const output = md.render(input);

console.log(JSON.stringify({
  input: input,
  output: output
}));
"""


def run_markdown_test(markdown_input, use_array_config=True):
    """Helper function to run markdown rendering test via Node.js"""
    template = TEST_SCRIPT_ARRAY_CONFIG if use_array_config else TEST_SCRIPT_NO_RESTRICT
    script_content = template % json.dumps(markdown_input)

    result = subprocess.run(
        ["node", "-e", script_content],
        capture_output=True,
        text=True,
        cwd="/app",
        timeout=30
    )

    if result.returncode != 0:
        pytest.fail(f"Node.js script failed: {result.stderr}")

    return json.loads(result.stdout)


class TestCalloutFunctionality:
    """Test that callout plugin works correctly for allowed classes"""

    def test_allowed_admin_class_renders(self):
        """
        Test that 'admin' class (in allowed list) renders correctly.
        """
        result = run_markdown_test("<$>[admin]\nAdmin content here<$>")
        output = result["output"]

        assert 'class="callout admin"' in output, \
            "Allowed class 'admin' should render as callout"
        assert "<p>Admin content here</p>" in output

    def test_allowed_info_class_renders(self):
        """
        Test that 'info' class (in allowed list) renders correctly.
        """
        result = run_markdown_test("<$>[info]\nInfo content here<$>")
        output = result["output"]

        assert 'class="callout info"' in output, \
            "Allowed class 'info' should render as callout"

    def test_allowed_warning_class_renders(self):
        """
        Test that 'warning' class renders correctly.
        """
        result = run_markdown_test("<$>[warning]\nWarning message<$>")
        output = result["output"]

        assert 'class="callout warning"' in output, \
            "Allowed class 'warning' should render as callout"

    def test_allowed_note_class_renders(self):
        """
        Test that 'note' class renders correctly.
        """
        result = run_markdown_test("<$>[note]\nNote content<$>")
        output = result["output"]

        assert 'class="callout note"' in output, \
            "Allowed class 'note' should render as callout"

    def test_disallowed_class_blocked_with_array_config(self):
        """
        Test that non-allowed class is blocked when using array config.
        """
        result = run_markdown_test("<$>[hacker]\nShould not render<$>")
        output = result["output"]

        # Non-allowed class should be escaped/blocked
        assert 'class="callout hacker"' not in output, \
            "Non-allowed class 'hacker' should NOT render as callout"

    def test_callout_with_label(self):
        """
        Test callout with label syntax works correctly.
        """
        result = run_markdown_test("<$>[info]\n[label Important!]\nContent here<$>")
        output = result["output"]

        assert 'class="callout info"' in output
        assert 'class="callout-label"' in output
        assert "Important!" in output

    def test_multiline_callout_content(self):
        """
        Test that multiline content in callout renders correctly.
        """
        markdown = """<$>[info]
First line
Second line
Third line
<$>"""
        result = run_markdown_test(markdown)
        output = result["output"]

        assert 'class="callout info"' in output
        assert "First line" in output
        assert "Second line" in output

    def test_callout_with_inline_markdown(self):
        """
        Test that inline markdown works inside callouts.
        """
        result = run_markdown_test("<$>[info]\n**Bold** and *italic* text<$>")
        output = result["output"]

        assert 'class="callout info"' in output
        assert "<strong>Bold</strong>" in output or "<b>Bold</b>" in output


class TestFenceEnvironmentFunctionality:
    """Test that fence_environment plugin works correctly for allowed environments"""

    def test_allowed_production_environment(self):
        """
        Test that 'production' environment (in allowed list) renders correctly.
        """
        result = run_markdown_test("```\n[environment production]\nproduction code\n```")
        output = result["output"]

        assert 'environment-production' in output, \
            "Allowed environment 'production' should render with class"

    def test_allowed_test_environment(self):
        """
        Test that 'test' environment (in allowed list) renders correctly.
        """
        result = run_markdown_test("```\n[environment test]\ntest code\n```")
        output = result["output"]

        assert 'environment-test' in output, \
            "Allowed environment 'test' should render with class"

    def test_allowed_development_environment(self):
        """
        Test that 'development' environment renders correctly.
        """
        result = run_markdown_test("```\n[environment development]\ndev code\n```")
        output = result["output"]

        assert 'environment-development' in output, \
            "Allowed environment 'development' should render with class"

    def test_disallowed_environment_blocked(self):
        """
        Test that non-allowed environment is blocked when using array config.
        """
        result = run_markdown_test("```\n[environment staging]\nshould not render\n```")
        output = result["output"]

        # Non-allowed environment should not get the class
        assert 'environment-staging' not in output, \
            "Non-allowed environment 'staging' should NOT render with class"

    def test_fence_with_language_specifier(self):
        """
        Test that fence with language specifier and environment works.
        """
        result = run_markdown_test("```javascript\n[environment production]\nconsole.log('hi');\n```")
        output = result["output"]

        # Should have both language and environment
        assert 'production' in output or 'environment-production' in output

    def test_fence_without_environment(self):
        """
        Test that regular fence without environment works normally.
        """
        result = run_markdown_test("```\nplain code\n```")
        output = result["output"]

        assert "<pre><code>" in output or "<pre>" in output
        assert "plain code" in output


class TestNoRestrictionMode:
    """Test behavior when no restrictions are configured"""

    def test_any_callout_class_allowed_without_restriction(self):
        """
        When no allowedClasses is set, any class should work.
        """
        result = run_markdown_test("<$>[custom]\nCustom callout<$>", use_array_config=False)
        output = result["output"]

        assert 'class="callout custom"' in output, \
            "Without restrictions, any class should be allowed"

    def test_any_environment_allowed_without_restriction(self):
        """
        When no allowedEnvironments is set, any environment should work.
        """
        result = run_markdown_test("```\n[environment custom]\ncode\n```", use_array_config=False)
        output = result["output"]

        assert 'environment-custom' in output, \
            "Without restrictions, any environment should be allowed"


class TestBasicMarkdownFunctionality:
    """Test that basic markdown features still work"""

    def test_basic_paragraph(self):
        """
        Test basic paragraph rendering.
        """
        result = run_markdown_test("Hello world")
        output = result["output"]

        assert "<p>Hello world</p>" in output

    def test_basic_heading(self):
        """
        Test heading rendering.
        """
        result = run_markdown_test("# Heading 1")
        output = result["output"]

        # The library adds id attributes to headings, so check for <h1 instead of <h1>
        assert "<h1" in output
        assert "Heading 1" in output

    def test_basic_list(self):
        """
        Test list rendering.
        """
        result = run_markdown_test("- Item 1\n- Item 2\n- Item 3")
        output = result["output"]

        assert "<ul>" in output
        assert "<li>" in output

    def test_basic_code_block(self):
        """
        Test basic code block rendering.
        """
        result = run_markdown_test("```\ncode here\n```")
        output = result["output"]

        assert "<pre>" in output or "<code>" in output
        assert "code here" in output

    def test_inline_code(self):
        """
        Test inline code rendering.
        """
        result = run_markdown_test("Use `console.log()` for debugging")
        output = result["output"]

        assert "<code>console.log()</code>" in output

    def test_link_rendering(self):
        """
        Test link rendering.
        """
        result = run_markdown_test("[Click here](https://example.com)")
        output = result["output"]

        assert 'href="https://example.com"' in output
        assert "Click here" in output


class TestMixedContent:
    """Test documents with mixed callouts, environments, and regular content"""

    def test_document_with_callout_and_text(self):
        """
        Test document mixing callouts with regular text.
        """
        markdown = """# Documentation

Some introductory text.

<$>[info]
Important information here.
<$>

More text after the callout."""

        result = run_markdown_test(markdown)
        output = result["output"]

        assert 'class="callout info"' in output
        # The library adds id attributes to headings, so check for <h1 instead of <h1>
        assert "<h1" in output
        assert "introductory text" in output
        assert "More text after" in output

    def test_document_with_multiple_callouts(self):
        """
        Test document with multiple callouts.
        """
        markdown = """<$>[info]
Info callout
<$>

<$>[warning]
Warning callout
<$>

<$>[note]
Note callout
<$>"""

        result = run_markdown_test(markdown)
        output = result["output"]

        assert 'class="callout info"' in output
        assert 'class="callout warning"' in output
        assert 'class="callout note"' in output

    def test_document_with_code_and_environment(self):
        """
        Test document with code blocks and environments.
        """
        markdown = """Here's some code:

```
[environment production]
production config here
```

And another block:

```
[environment test]
test config here
```"""

        result = run_markdown_test(markdown)
        output = result["output"]

        assert 'environment-production' in output
        assert 'environment-test' in output


class TestEdgeCases:
    """Edge case tests for callout class names"""

    def test_empty_class_not_allowed(self):
        """
        Test that empty class name is not allowed.
        """
        result = run_markdown_test("<$>[]\nEmpty class<$>")
        output = result["output"]

        # Empty class should not create a callout
        assert '<div class="callout ">' not in output

    def test_whitespace_only_class(self):
        """
        Test that whitespace-only class name is not allowed.
        """
        result = run_markdown_test("<$>[   ]\nWhitespace class<$>")
        output = result["output"]

        assert '<div class="callout' not in output or 'class="callout ">' not in output

    def test_case_sensitivity(self):
        """
        Test that class matching is case-sensitive.
        'INFO' is not the same as 'info'.
        """
        result = run_markdown_test("<$>[INFO]\nUppercase class<$>")
        output = result["output"]

        # 'INFO' is not in allowed list (only lowercase 'info' is)
        assert 'class="callout INFO"' not in output
