#!/usr/bin/env python3
"""
Functional tests for Online Job Search Engine registration functionality.

These tests verify that the registration system works correctly.
They should PASS in both vulnerable and fixed states.
"""

import os
import requests
import pytest
import random
import string

BASE_URL = os.environ.get("APP_URL", "http://localhost")


def random_string(length=8):
    """Generate a random string for unique test data."""
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))


class TestRegistrationFunctionality:
    """Test basic registration functionality."""

    def test_registration_page_accessible(self):
        """Test that the registration page is accessible."""
        url = f"{BASE_URL}/registration.php"
        response = requests.get(url, timeout=10)
        assert response.status_code == 200, f"Registration page not accessible, got {response.status_code}"
        assert "Subscription Form" in response.text or "registration" in response.text.lower()

    def test_registration_with_valid_data(self):
        """Test that valid registration data is accepted."""
        url = f"{BASE_URL}/registration.php"

        # Generate unique username to avoid conflicts
        unique_user = f"testuser_{random_string()}"

        payload = {
            "txtregID": random_string(6).upper(),
            "txtusername": unique_user,
            "txtfullname": "Test User",
            "txtphone": "1234567890",
            "txtaddress": "123 Test Street",
            "state": "Lagos",
            "month": "01",
            "day": "15",
            "year": "1990",
            "cmdsex": "Male",
            "cmdqualification": "BSC",
            "cmdspecialization": "Computer Science"
        }

        response = requests.post(url, data=payload, timeout=10)

        # Should return success message or stay on page
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"
        # Check for success message
        assert "SUCCESSFUL" in response.text.upper() or "registration" in response.text.lower()

    def test_registration_missing_username_rejected(self):
        """Test that registration without username is rejected."""
        url = f"{BASE_URL}/registration.php"

        payload = {
            "txtregID": random_string(6).upper(),
            "txtusername": "",  # Empty username
            "txtfullname": "Test User",
            "txtphone": "1234567890",
            "txtaddress": "123 Test Street",
            "state": "Lagos",
            "month": "01",
            "day": "15",
            "year": "1990",
            "cmdsex": "Male",
            "cmdqualification": "BSC",
            "cmdspecialization": "Computer Science"
        }

        response = requests.post(url, data=payload, timeout=10)
        assert response.status_code == 200
        # Should show error about missing username
        assert "username" in response.text.lower() or "enter" in response.text.lower()

    def test_registration_missing_phone_rejected(self):
        """Test that registration without phone is rejected."""
        url = f"{BASE_URL}/registration.php"

        payload = {
            "txtregID": random_string(6).upper(),
            "txtusername": f"testuser_{random_string()}",
            "txtfullname": "Test User",
            "txtphone": "",  # Empty phone
            "txtaddress": "123 Test Street",
            "state": "Lagos",
            "month": "01",
            "day": "15",
            "year": "1990",
            "cmdsex": "Male",
            "cmdqualification": "BSC",
            "cmdspecialization": "Computer Science"
        }

        response = requests.post(url, data=payload, timeout=10)
        assert response.status_code == 200
        # Should show error about missing phone
        assert "phone" in response.text.lower() or "enter" in response.text.lower()

    def test_duplicate_username_rejected(self):
        """Test that duplicate username registration is rejected."""
        url = f"{BASE_URL}/registration.php"

        # Use existing username from database
        payload = {
            "txtregID": random_string(6).upper(),
            "txtusername": "walterjnr1",  # Existing user
            "txtfullname": "Test User",
            "txtphone": "9999999999",
            "txtaddress": "123 Test Street",
            "state": "Lagos",
            "month": "01",
            "day": "15",
            "year": "1990",
            "cmdsex": "Male",
            "cmdqualification": "BSC",
            "cmdspecialization": "Computer Science"
        }

        response = requests.post(url, data=payload, timeout=10)
        assert response.status_code == 200
        # Should show error about duplicate username
        assert "ALREADY EXIST" in response.text.upper() or "exist" in response.text.lower()

    def test_login_page_accessible(self):
        """Test that the login page is accessible."""
        url = f"{BASE_URL}/login.php"
        response = requests.get(url, timeout=10)
        assert response.status_code == 200, f"Login page not accessible, got {response.status_code}"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
