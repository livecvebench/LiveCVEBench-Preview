#!/bin/bash
# Solution script for the iframe dimension restriction issue
# This script adds the HTML.ForbiddenAttributes configuration to prevent
# iframe elements from having width and height attributes

set -e
cd /app

OUTPUT_FILE="core/classes/Core/Output.php"

# Check if the file exists
if [ ! -f "$OUTPUT_FILE" ]; then
    echo "Error: $OUTPUT_FILE not found"
    exit 1
fi

# Check if fix is already applied
if grep -q "HTML.ForbiddenAttributes" "$OUTPUT_FILE"; then
    echo "Fix already applied - HTML.ForbiddenAttributes is already present"
    exit 0
fi

# Apply the fix: Add HTML.ForbiddenAttributes line after HTML.AllowedAttributes
# This uses sed to insert a new line after the HTML.AllowedAttributes configuration
sed -i "/\$purifierConfig->set('HTML.AllowedAttributes'/a\\            \$purifierConfig->set('HTML.ForbiddenAttributes', 'iframe@width,iframe@height');" "$OUTPUT_FILE"

# Verify the fix was applied
if grep -q "HTML.ForbiddenAttributes" "$OUTPUT_FILE"; then
    echo "Fix applied successfully!"
    echo "Added: \$purifierConfig->set('HTML.ForbiddenAttributes', 'iframe@width,iframe@height');"
else
    echo "Error: Failed to apply fix"
    exit 1
fi
