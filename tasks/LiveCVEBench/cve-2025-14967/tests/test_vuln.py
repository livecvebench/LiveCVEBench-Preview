#!/usr/bin/env python3
"""
Vulnerability tests for the Student Management System candidates_report.php page.
These tests verify that SQL injection vulnerabilities are properly mitigated.

- FAIL in vulnerable state (SQL injection is exploitable)
- PASS in fixed state (SQL injection is blocked)
"""

import pytest
import requests
import time

BASE_URL = "http://localhost"
TIMEOUT = 15


class TestTimeBasedSQLInjection:
    """Test time-based SQL injection attack vectors."""

    def test_sleep_injection_basic(self):
        """Test basic SLEEP() injection - should not cause delay when fixed."""
        # Using subquery structure that works with MySQL
        payload = "1' AND (SELECT 5678 FROM (SELECT(SLEEP(3)))abcd) AND 'x'='x"
        start_time = time.time()
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time
        # If vulnerable, response takes 3+ seconds due to SLEEP(3)
        assert elapsed < 2.5, f"Possible SQL injection - response took {elapsed:.2f} seconds"

    def test_sleep_injection_longer_delay(self):
        """Test SLEEP() injection with longer delay using subquery."""
        # This format works reliably with MySQL/MariaDB
        payload = "1' AND (SELECT 1234 FROM (SELECT(SLEEP(4)))wxyz) AND 'a'='a"
        start_time = time.time()
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time
        assert elapsed < 3.5, f"Possible SQL injection - response took {elapsed:.2f} seconds"

    def test_conditional_sleep_true_condition(self):
        """Test conditional SLEEP with subquery structure."""
        payload = "1' AND (SELECT 9999 FROM (SELECT(SLEEP(3)))test) AND '1'='1"
        start_time = time.time()
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time
        assert elapsed < 2.5, f"Possible SQL injection - conditional SLEEP triggered, took {elapsed:.2f}s"


class TestUnionBasedSQLInjection:
    """Test UNION-based SQL injection attack vectors."""

    def test_union_extract_user_data(self):
        """Test UNION injection attempting to extract user table data."""
        # Trying to extract username/password from user table
        payload = "' UNION SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,CONCAT(USER,':',PASSWORD),NULL,NULL FROM user-- -"
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": payload},
            timeout=TIMEOUT
        )
        # After fix, injected data should not appear
        # In vulnerable state, both admin and password hash will appear
        assert "admin" not in response.text.lower() or "0192023a7bbd73250516f069df18b500" not in response.text

    def test_union_extract_database_name(self):
        """Test UNION injection to extract database name."""
        payload = "' UNION SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,database(),NULL,NULL-- -"
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": payload},
            timeout=TIMEOUT
        )
        # In vulnerable state, database name appears in output
        assert "grading_db" not in response.text


class TestDataExfiltration:
    """Test SQL injection data exfiltration attempts."""

    def test_extract_version_via_concat(self):
        """Test extracting MySQL version via CONCAT injection."""
        # Column position 21 corresponds to PROGRAM which is displayed in the page
        payload = "' UNION SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,CONCAT('VERSION:',@@version),NULL,NULL-- -"
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": payload},
            timeout=TIMEOUT
        )
        # Version info should not appear in response
        # If SQL injection works, we'd see patterns like "VERSION:5.7" or "VERSION:10." in the table data
        import re
        # Check for actual version extraction - version numbers following VERSION:
        version_extracted = re.search(r'VERSION:\d+\.\d+', response.text)
        assert version_extracted is None, f"SQL injection extracted database version: {version_extracted.group() if version_extracted else ''}"

    def test_extract_all_users(self):
        """Test extracting all users from user table."""
        payload = "' UNION SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,USER,NULL,NULL FROM user-- -"
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": payload},
            timeout=TIMEOUT
        )
        # In vulnerable state, user names appear in output
        # The "admin" user should not appear if properly protected
        assert "admin" not in response.text.lower()


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
