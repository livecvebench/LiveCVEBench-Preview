FROM python:3.11-slim

RUN apt-get update && apt-get install -y \
    tmux asciinema gcc g++ 

RUN apt-get update && apt-get install -y procps lsof

LABEL maintainer="you@example.com" \
      description="Tautulli (Plex 统计/监控工具) Docker 镜像"
      
ARG TAUTULLI_COMMIT=1144bba580fff1fbb220e104b9e66be78482842b
ENV TAUTULLI_REPO=https://github.com/Tautulli/Tautulli.git

# 一些基础环境变量
ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    TZ=Etc/UTC

# 安装系统依赖：git 用来 clone 仓库，curl 用于健康检查，tzdata 处理时区
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git \
        patch curl \
        ca-certificates \
        tzdata && \
    rm -rf /var/lib/apt/lists/*

# 应用目录
WORKDIR /app

# 克隆 Tautulli 源码并切到指定 commit
RUN git clone ${TAUTULLI_REPO} . && \
    git checkout ${TAUTULLI_COMMIT} && \
    rm -rf .git

RUN pip install --no-cache-dir -r requirements.txt

# 创建非 root 用户运行服务，避免直接用 root
# RUN groupadd -g 1000 tautulli && \
#     useradd -u 1000 -g 1000 -d /config -s /bin/sh tautulli && \
#     mkdir -p /config && \
#     chown -R tautulli:tautulli /config /app
# 所有后续操作切换为非 root 用户
# USER tautulli
RUN mkdir -p /config

# Tautulli 默认端口
EXPOSE 8181

# 声明数据卷
VOLUME ["/config"]

# 官方 
# CMD ["python", "Tautulli.py", "--datadir", "/config"]

COPY task-deps/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh
# CMD ["/app/entrypoint.sh"]

# 健康检查
# HEALTHCHECK --start-period=90s CMD \
#     curl -ILfks https://localhost:8181/status > /dev/null || \
#     curl -ILfs http://localhost:8181/status > /dev/null || exit 1