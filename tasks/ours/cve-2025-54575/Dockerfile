FROM mcr.microsoft.com/dotnet/sdk:8.0

WORKDIR /app

# Build args for proxy (passed via --build-arg)
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG http_proxy
ARG https_proxy

# .NET environment settings
ENV DOTNET_CLI_TELEMETRY_OPTOUT=1
ENV DOTNET_NOLOGO=1

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y git tmux asciinema curl procps && rm -rf /var/lib/apt/lists/*

# Clone ImageSharp v3.1.10 (vulnerable version) with submodules for reference
# This source is needed for the fix - solution.sh will modify GifDecoderCore.cs
RUN git clone --depth 1 --branch v3.1.10 --recurse-submodules https://github.com/SixLabors/ImageSharp.git /app/ImageSharp && \
    rm -rf /app/ImageSharp/.git

# Create NuGet.Config for source project to avoid Azure DevOps feed issues
COPY task-deps/NuGet.Config /app/ImageSharp/NuGet.Config

# Fix problematic Azure DevOps NuGet source in ImageSharp shared properties
RUN if [ -f /app/ImageSharp/shared-infrastructure/msbuild/props/SixLabors.Global.props ]; then \
    sed -i '/pkgs.dev.azure.com/d' /app/ImageSharp/shared-infrastructure/msbuild/props/SixLabors.Global.props; \
    fi

# Build ImageSharp from source (required for test project and solution)
RUN dotnet restore /app/ImageSharp/src/ImageSharp/ImageSharp.csproj --configfile /app/ImageSharp/NuGet.Config && \
    dotnet build /app/ImageSharp/src/ImageSharp/ImageSharp.csproj -c Release --no-restore

# Create test harness directory
WORKDIR /app/test
COPY task-deps/ImageTest.csproj /app/test/ImageTest.csproj
COPY task-deps/ImageTestFromSource.csproj /app/test/ImageTestFromSource.csproj
COPY task-deps/TestProgram.cs /app/test/Program.cs
COPY task-deps/NuGet.Config /app/test/NuGet.Config

# Restore and build test project that references ImageSharp source
RUN dotnet restore /app/test/ImageTestFromSource.csproj --configfile /app/test/NuGet.Config && \
    dotnet build /app/test/ImageTestFromSource.csproj -c Release --no-restore

# Publish to get a fast-executing assembly (no JIT on every run)
RUN dotnet publish /app/test/ImageTestFromSource.csproj -c Release -o /app/test/publish --no-build

WORKDIR /app

# Keep container running for tests
CMD ["tail", "-f", "/dev/null"]
