#!/bin/bash
# Solution script for JEHC-BPM authentication bypass fix
# This script changes the @Auth annotation from NOT_REQUIRED_LOGIN to REQUIRED_LOGIN
# on the executeExec endpoints in both ActuatorServer.java and ActuatorClient.java

set -e
cd /app

echo "=== Applying Authentication Fix ==="
echo ""

# Define the paths to the vulnerable files
ACTUATOR_SERVER="/app/jehc-djshi/jehc-basis/jehc-omp-plug/jehc-actuator-server/src/main/java/jehc/djshi/actuator/web/ActuatorServer.java"
ACTUATOR_CLIENT="/app/jehc-djshi/jehc-basis/jehc-omp-plug/jehc-actuator-sdk/src/main/java/jehc/djshi/actuator/web/ActuatorClient.java"

# Verify files exist
if [ ! -f "$ACTUATOR_SERVER" ]; then
    echo "ERROR: ActuatorServer.java not found at $ACTUATOR_SERVER"
    exit 1
fi

if [ ! -f "$ACTUATOR_CLIENT" ]; then
    echo "ERROR: ActuatorClient.java not found at $ACTUATOR_CLIENT"
    exit 1
fi

echo "Found vulnerable files:"
echo "  - $ACTUATOR_SERVER"
echo "  - $ACTUATOR_CLIENT"
echo ""

# Fix ActuatorServer.java - change NOT_REQUIRED_LOGIN to REQUIRED_LOGIN for executeExec endpoint
echo "Fixing ActuatorServer.java..."
# The vulnerable line is:
# @Auth(value = "/actuator/server/executeExec",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
# Change to:
# @Auth(value = "/actuator/server/executeExec",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN)

sed -i 's/@Auth(value = "\/actuator\/server\/executeExec",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)/@Auth(value = "\/actuator\/server\/executeExec",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN)/g' "$ACTUATOR_SERVER"

# Verify the change was applied
if grep -q 'value = "/actuator/server/executeExec",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN' "$ACTUATOR_SERVER"; then
    echo "  ActuatorServer.java fixed successfully"
else
    echo "  WARNING: Could not verify fix in ActuatorServer.java"
fi

# Fix ActuatorClient.java - change NOT_REQUIRED_LOGIN to REQUIRED_LOGIN for executeExec endpoint
echo "Fixing ActuatorClient.java..."
# The vulnerable line is:
# @Auth(value = "/actuator/info/executeExec",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
# Change to:
# @Auth(value = "/actuator/info/executeExec",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN)

sed -i 's/@Auth(value = "\/actuator\/info\/executeExec",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)/@Auth(value = "\/actuator\/info\/executeExec",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN)/g' "$ACTUATOR_CLIENT"

# Verify the change was applied
if grep -q 'value = "/actuator/info/executeExec",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN' "$ACTUATOR_CLIENT"; then
    echo "  ActuatorClient.java fixed successfully"
else
    echo "  WARNING: Could not verify fix in ActuatorClient.java"
fi

echo ""
echo "=== Rebuilding Application ==="
echo ""

# Navigate to the Maven project directory and rebuild
cd /app/jehc-djshi

# Rebuild the application with Maven (skip tests for faster build)
# Maven and JDK are pre-installed in the container, and Maven cache is pre-populated
echo "Running: mvn clean package -DskipTests -o"
mvn clean package -DskipTests -o 2>&1 || {
    echo "Offline build failed, trying online mode..."
    mvn clean package -DskipTests 2>&1 | tail -50
    exit 1
}

echo "Build completed successfully!"

echo ""
echo "=== Restarting Application ==="
echo ""

# Kill the running Java application so entrypoint can restart it
# The entrypoint script monitors the process and will restart automatically
echo "Stopping current application instance..."
pkill -f "java.*jehc-api" || true

# Wait a moment for process to terminate
sleep 3

echo ""
echo "=== Fix Applied Successfully ==="
echo ""
echo "The application will be restarted automatically by the entrypoint script."
echo "After restart, unauthenticated requests to /actuator/info/executeExec"
echo "and /actuator/server/executeExec will be rejected."
