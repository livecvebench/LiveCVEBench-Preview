"""
Functionality Tests for WordPress Make Connector Plugin

These tests verify that the plugin's core upload functionality works correctly.
Tests should PASS in both vulnerable and fixed states.
"""

import os
import pytest
import requests
import subprocess
from datetime import datetime
import time

# Configuration
WP_URL = os.environ.get('WP_URL', 'http://localhost')
API_KEY = os.environ.get('API_KEY', '')


def get_api_key():
    """Get API key from environment or from WordPress database."""
    if API_KEY:
        return API_KEY

    # Try to get from WP-CLI
    try:
        result = subprocess.run(
            ['wp', '--path=/var/www/html', 'option', 'get', 'iwc_api_key', '--allow-root'],
            capture_output=True, text=True, timeout=30
        )
        if result.returncode == 0:
            return result.stdout.strip()
    except Exception:
        pass

    # Fallback: query database directly
    try:
        result = subprocess.run(
            ['wp', '--path=/var/www/html', 'db', 'query',
             "SELECT option_value FROM wp_options WHERE option_name='iwc_api_key';",
             '--allow-root', '--skip-column-names'],
            capture_output=True, text=True, timeout=30
        )
        if result.returncode == 0:
            return result.stdout.strip()
    except Exception:
        pass

    pytest.fail("Could not retrieve API key. Set API_KEY environment variable.")


def get_upload_date_path():
    """Get current YYYY/MM path for uploads directory."""
    now = datetime.now()
    return f"{now.year}/{now.month:02d}"


def create_valid_png():
    """Create a minimal valid PNG file."""
    # Minimal 1x1 red PNG
    png_data = bytes([
        0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A,  # PNG signature
        0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52,  # IHDR chunk
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,  # 1x1 dimensions
        0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53,
        0xDE, 0x00, 0x00, 0x00, 0x0C, 0x49, 0x44, 0x41,  # IDAT chunk
        0x54, 0x08, 0xD7, 0x63, 0xF8, 0xFF, 0xFF, 0x3F,
        0x00, 0x05, 0xFE, 0x02, 0xFE, 0xDC, 0xCC, 0x59,
        0xE7, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E,  # IEND chunk
        0x44, 0xAE, 0x42, 0x60, 0x82
    ])
    return png_data


def create_valid_jpeg():
    """Create a minimal valid JPEG file."""
    # Minimal JPEG (1x1 white pixel)
    jpeg_data = bytes([
        0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46,
        0x49, 0x46, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01,
        0x00, 0x01, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
        0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08,
        0x07, 0x07, 0x07, 0x09, 0x09, 0x08, 0x0A, 0x0C,
        0x14, 0x0D, 0x0C, 0x0B, 0x0B, 0x0C, 0x19, 0x12,
        0x13, 0x0F, 0x14, 0x1D, 0x1A, 0x1F, 0x1E, 0x1D,
        0x1A, 0x1C, 0x1C, 0x20, 0x24, 0x2E, 0x27, 0x20,
        0x22, 0x2C, 0x23, 0x1C, 0x1C, 0x28, 0x37, 0x29,
        0x2C, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1F, 0x27,
        0x39, 0x3D, 0x38, 0x32, 0x3C, 0x2E, 0x33, 0x34,
        0x32, 0xFF, 0xC0, 0x00, 0x0B, 0x08, 0x00, 0x01,
        0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xFF, 0xC4,
        0x00, 0x1F, 0x00, 0x00, 0x01, 0x05, 0x01, 0x01,
        0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0xFF,
        0xC4, 0x00, 0xB5, 0x10, 0x00, 0x02, 0x01, 0x03,
        0x03, 0x02, 0x04, 0x03, 0x05, 0x05, 0x04, 0x04,
        0x00, 0x00, 0x01, 0x7D, 0x01, 0x02, 0x03, 0x00,
        0x04, 0x11, 0x05, 0x12, 0x21, 0x31, 0x41, 0x06,
        0x13, 0x51, 0x61, 0x07, 0x22, 0x71, 0x14, 0x32,
        0x81, 0x91, 0xA1, 0x08, 0x23, 0x42, 0xB1, 0xC1,
        0x15, 0x52, 0xD1, 0xF0, 0x24, 0x33, 0x62, 0x72,
        0x82, 0x09, 0x0A, 0x16, 0x17, 0x18, 0x19, 0x1A,
        0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x34, 0x35,
        0x36, 0x37, 0x38, 0x39, 0x3A, 0x43, 0x44, 0x45,
        0x46, 0x47, 0x48, 0x49, 0x4A, 0x53, 0x54, 0x55,
        0x56, 0x57, 0x58, 0x59, 0x5A, 0x63, 0x64, 0x65,
        0x66, 0x67, 0x68, 0x69, 0x6A, 0x73, 0x74, 0x75,
        0x76, 0x77, 0x78, 0x79, 0x7A, 0x83, 0x84, 0x85,
        0x86, 0x87, 0x88, 0x89, 0x8A, 0x92, 0x93, 0x94,
        0x95, 0x96, 0x97, 0x98, 0x99, 0x9A, 0xA2, 0xA3,
        0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xB2,
        0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA,
        0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9,
        0xCA, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8,
        0xD9, 0xDA, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6,
        0xE7, 0xE8, 0xE9, 0xEA, 0xF1, 0xF2, 0xF3, 0xF4,
        0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFF, 0xDA,
        0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3F, 0x00,
        0xFB, 0xD5, 0xDB, 0x20, 0xA8, 0xF1, 0x7E, 0xE9,
        0xF5, 0x4D, 0xFF, 0xD9
    ])
    return jpeg_data


def create_valid_gif():
    """Create a minimal valid GIF file."""
    # Minimal 1x1 GIF
    gif_data = bytes([
        0x47, 0x49, 0x46, 0x38, 0x39, 0x61,  # GIF89a
        0x01, 0x00, 0x01, 0x00,  # 1x1 dimensions
        0x80, 0x00, 0x00,  # Global color table flag
        0xFF, 0xFF, 0xFF,  # White
        0x00, 0x00, 0x00,  # Black
        0x21, 0xF9, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00,  # Graphic control
        0x2C, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01,  # Image descriptor
        0x00, 0x00, 0x02, 0x02, 0x44, 0x01, 0x00,  # Image data
        0x3B  # Trailer
    ])
    return gif_data


class TestAPIAuthentication:
    """Tests for API authentication functionality."""

    def test_missing_api_key_rejected(self):
        """Test that requests without API key are rejected."""
        response = requests.post(
            f"{WP_URL}/wp-json/wp/v2/media",
            files={"file": ("test.png", create_valid_png(), "image/png")},
            timeout=30
        )
        # Should return 401 Unauthorized
        assert response.status_code == 401, \
            f"Expected 401 for missing API key, got {response.status_code}"

    def test_invalid_api_key_rejected(self):
        """Test that requests with invalid API key are rejected."""
        response = requests.post(
            f"{WP_URL}/wp-json/wp/v2/media",
            headers={"IWC-API-KEY": "invalid_key_12345678901234567890"},
            files={"file": ("test.png", create_valid_png(), "image/png")},
            timeout=30
        )
        # Should return 401 Unauthorized
        assert response.status_code == 401, \
            f"Expected 401 for invalid API key, got {response.status_code}"


class TestLegitimateFileUpload:
    """Tests for legitimate file upload functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup for each test."""
        self.api_key = get_api_key()
        self.headers = {"IWC-API-KEY": self.api_key}
        self.upload_path = get_upload_date_path()
        self.uploaded_files = []
        yield
        # Cleanup uploaded files
        for filename in self.uploaded_files:
            try:
                subprocess.run(
                    ['rm', '-f', f'/var/www/html/wp-content/uploads/{self.upload_path}/{filename}'],
                    capture_output=True, timeout=10
                )
            except Exception:
                pass

    def test_png_upload_succeeds(self):
        """Test that PNG files can be uploaded successfully."""
        filename = f"test_func_png_{int(time.time())}.png"

        response = requests.post(
            f"{WP_URL}/wp-json/wp/v2/media",
            headers=self.headers,
            files={"file": (filename, create_valid_png(), "image/png")},
            timeout=30
        )

        # Should succeed (200 or return with valid data)
        # The plugin returns custom response format, check for success indicators
        assert response.status_code in [200, 201] or 'post_type' in response.text, \
            f"PNG upload should succeed. Status: {response.status_code}, Response: {response.text[:500]}"

        self.uploaded_files.append(filename)

    def test_jpeg_upload_succeeds(self):
        """Test that JPEG files can be uploaded successfully."""
        filename = f"test_func_jpg_{int(time.time())}.jpg"

        response = requests.post(
            f"{WP_URL}/wp-json/wp/v2/media",
            headers=self.headers,
            files={"file": (filename, create_valid_jpeg(), "image/jpeg")},
            timeout=30
        )

        assert response.status_code in [200, 201] or 'post_type' in response.text, \
            f"JPEG upload should succeed. Status: {response.status_code}"

        self.uploaded_files.append(filename)

    def test_gif_upload_succeeds(self):
        """Test that GIF files can be uploaded successfully."""
        filename = f"test_func_gif_{int(time.time())}.gif"

        response = requests.post(
            f"{WP_URL}/wp-json/wp/v2/media",
            headers=self.headers,
            files={"file": (filename, create_valid_gif(), "image/gif")},
            timeout=30
        )

        assert response.status_code in [200, 201] or 'post_type' in response.text, \
            f"GIF upload should succeed. Status: {response.status_code}"

        self.uploaded_files.append(filename)

    def test_upload_with_title_metadata(self):
        """Test that file metadata (title) is preserved."""
        filename = f"test_func_meta_{int(time.time())}.png"
        test_title = "Test Image Title"

        response = requests.post(
            f"{WP_URL}/wp-json/wp/v2/media",
            headers=self.headers,
            files={"file": (filename, create_valid_png(), "image/png")},
            data={"title": test_title},
            timeout=30
        )

        # File should be uploaded successfully
        assert response.status_code in [200, 201] or 'post_type' in response.text, \
            f"Upload with metadata should succeed. Status: {response.status_code}"

        self.uploaded_files.append(filename)


class TestDisallowedFileTypes:
    """Tests for file type rejection messages."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup for each test."""
        self.api_key = get_api_key()
        self.headers = {"IWC-API-KEY": self.api_key}

    def test_disallowed_file_returns_error(self):
        """Test that disallowed file types return an error message."""
        filename = f"test_reject_{int(time.time())}.xyz"

        response = requests.post(
            f"{WP_URL}/wp-json/wp/v2/media",
            headers=self.headers,
            files={"file": (filename, b"test content", "application/octet-stream")},
            timeout=30
        )

        # Should return error status code
        assert response.status_code >= 400, \
            f"Disallowed file type should return error status. Got: {response.status_code}"
