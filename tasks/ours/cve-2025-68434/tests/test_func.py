"""
Functionality Tests for OpenSourcePOS

These tests verify that the application works correctly with security
filters enabled. They should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import re
import time

BASE_URL = "http://localhost"
ADMIN_USER = "admin"
ADMIN_PASS = "pointofsale"


class TestApplicationFunctionality:
    """Test that basic application functionality works correctly."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Wait for application to be ready."""
        max_retries = 30
        for i in range(max_retries):
            try:
                response = requests.get(f"{BASE_URL}/", timeout=5)
                if response.status_code in [200, 302]:
                    break
            except requests.exceptions.ConnectionError:
                pass
            time.sleep(2)
        else:
            pytest.fail("Application did not become ready in time")

    def get_session_and_token(self):
        """Create a session, login, and extract CSRF token if available."""
        session = requests.Session()

        # Get the login page first
        login_page = session.get(f"{BASE_URL}/index.php/login", allow_redirects=True)

        # Perform login
        login_data = {
            "username": ADMIN_USER,
            "password": ADMIN_PASS
        }

        # Try to extract CSRF token from login page
        csrf_token = self.extract_csrf_token(login_page.text)
        if csrf_token:
            login_data["csrf_ospos_v4"] = csrf_token

        login_response = session.post(
            f"{BASE_URL}/index.php/login",
            data=login_data,
            allow_redirects=True
        )

        return session

    def extract_csrf_token(self, html_content):
        """Extract CSRF token from HTML page."""
        # Look for hidden input field
        match = re.search(r'name="csrf_ospos_v4"\s+value="([^"]+)"', html_content)
        if match:
            return match.group(1)

        # Look for meta tag
        match = re.search(r'<meta\s+name="csrf-token"\s+content="([^"]+)"', html_content)
        if match:
            return match.group(1)

        # Look for JavaScript variable
        match = re.search(r'csrf_ospos_v4["\']?\s*[:=]\s*["\']([^"\']+)["\']', html_content)
        if match:
            return match.group(1)

        return None

    def test_application_accessible(self):
        """Test that the application is accessible."""
        response = requests.get(f"{BASE_URL}/", allow_redirects=True)
        assert response.status_code == 200, "Application should be accessible"

    def test_login_page_loads(self):
        """Test that the login page loads correctly."""
        response = requests.get(f"{BASE_URL}/index.php/login", allow_redirects=True)
        assert response.status_code == 200, "Login page should load"
        assert "login" in response.text.lower() or "password" in response.text.lower(), \
            "Login page should contain login form"

    def test_admin_can_login(self):
        """Test that admin can successfully log in."""
        session = self.get_session_and_token()

        # Verify we're logged in by accessing a protected page
        response = session.get(f"{BASE_URL}/index.php/home", allow_redirects=True)

        # Should be able to access home or be on the dashboard
        assert response.status_code == 200, "Should be able to access home after login"

    def test_employees_page_accessible_after_login(self):
        """Test that employees page is accessible after login."""
        session = self.get_session_and_token()

        response = session.get(f"{BASE_URL}/index.php/employees", allow_redirects=True)

        assert response.status_code == 200, "Employees page should be accessible"

    def test_employee_creation_with_valid_token(self):
        """Test that employee creation works with proper authentication."""
        session = self.get_session_and_token()

        # Get the employees page to extract CSRF token
        employees_page = session.get(f"{BASE_URL}/index.php/employees", allow_redirects=True)

        # Try to get the new employee form
        new_employee_page = session.get(f"{BASE_URL}/index.php/employees/view/-1", allow_redirects=True)

        # Extract CSRF token
        csrf_token = self.extract_csrf_token(new_employee_page.text)

        # Generate unique username
        import random
        unique_id = random.randint(10000, 99999)
        username = f"functest_{unique_id}"

        # Prepare employee data
        employee_data = {
            "first_name": "Func",
            "last_name": "Test",
            "username": username,
            "email": f"{username}@test.com",
            "password": "TestPass123!",
            "repeat_password": "TestPass123!",
            "gender": "1",
            "language": ":",
            "grant_home": "home",
            "menu_group_home": "both",
            "honeypot": ""
        }

        # Add CSRF token if available
        if csrf_token:
            employee_data["csrf_ospos_v4"] = csrf_token

        # Submit the form
        response = session.post(
            f"{BASE_URL}/index.php/employees/save/-1",
            data=employee_data,
            allow_redirects=True
        )

        # With proper session and token (if required), should succeed
        # The request should not result in a complete failure
        assert response.status_code in [200, 302], \
            f"Employee creation should be processed, got status {response.status_code}"

    def test_sales_page_accessible(self):
        """Test that sales page is accessible for AJAX operations."""
        session = self.get_session_and_token()

        response = session.get(f"{BASE_URL}/index.php/sales", allow_redirects=True)

        assert response.status_code == 200, "Sales page should be accessible"

    def test_config_page_accessible(self):
        """Test that config/settings page is accessible."""
        session = self.get_session_and_token()

        response = session.get(f"{BASE_URL}/index.php/config", allow_redirects=True)

        # Should either be accessible or redirect appropriately
        assert response.status_code in [200, 302, 403], \
            "Config page should respond appropriately"

    def test_session_persistence(self):
        """Test that sessions persist across multiple requests."""
        session = self.get_session_and_token()

        # Make multiple requests
        for i in range(3):
            response = session.get(f"{BASE_URL}/index.php/home", allow_redirects=True)
            assert response.status_code == 200, f"Request {i+1} should succeed"
            time.sleep(0.5)
