FROM ubuntu:22.04

WORKDIR /app

# System dependencies required for tb framework
RUN apt-get update && apt-get install -y \
    tmux \
    asciinema \
    gcc \
    g++ \
    wget \
    curl \
    git \
    build-essential \
    cmake \
    ninja-build \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Clone Assimp at vulnerable version v5.4.3 and remove git history
RUN git clone --depth 1 --branch v5.4.3 https://github.com/assimp/assimp.git . && \
    rm -rf .git

# Build with CMake and Ninja with AddressSanitizer for vulnerability detection
RUN cmake -B build -G Ninja \
    -DBUILD_SHARED_LIBS=OFF \
    -DASSIMP_BUILD_ZLIB=ON \
    -DASSIMP_BUILD_TESTS=OFF \
    -DASSIMP_BUILD_ASSIMP_TOOLS=ON \
    -DASSIMP_BUILD_SAMPLES=OFF \
    -DASSIMP_WARNINGS_AS_ERRORS=OFF \
    -DCMAKE_CXX_FLAGS="-fsanitize=address -g -fno-omit-frame-pointer" \
    -DCMAKE_C_FLAGS="-fsanitize=address -g -fno-omit-frame-pointer" \
    -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" \
    && cmake --build build -j$(nproc)

# Create standard binary location
RUN mkdir -p /app/bin && ln -sf /app/build/bin/assimp /app/bin/assimp

# Create test files directory and copy PoC files
RUN mkdir -p /app/test_files
COPY task-deps/poc_simple.lws /app/test_files/
COPY task-deps/poc_crash.lws /app/test_files/

# Verify binary exists
RUN /app/bin/assimp --help || true

# Keep container running (handled by docker-compose command)
# CMD ["/bin/bash"]