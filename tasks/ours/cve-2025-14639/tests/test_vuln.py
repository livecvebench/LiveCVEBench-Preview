"""
Vulnerability tests for Student Management System SQL Injection (CVE-2025-14639).
These tests verify the SQL injection vulnerability status:
- FAIL when vulnerable (injection works - response delayed by SLEEP)
- PASS when fixed (injection blocked - response is immediate)

The key indicator is time-based SQL injection using nested subquery SLEEP techniques
which work reliably with this application's query structure.
"""

import requests
import time
import pytest

BASE_URL = "http://localhost"
VULN_ENDPOINT = f"{BASE_URL}/grading/uprec.php"
TIMEOUT = 20
SLEEP_DELAY = 5
THRESHOLD = 3  # seconds - if response takes longer than this, injection worked


class TestSQLInjectionVulnerability:
    """
    Test for SQL injection vulnerability using time-based techniques.

    The application has a SQL injection in uprec.php where the 'id' parameter
    is directly concatenated into queries without sanitization.

    The nested subquery SLEEP technique works because it executes in a subquery
    context that completes before the outer query potentially fails.

    Expected behavior:
    - VULNERABLE: Response takes ~SLEEP_DELAY seconds -> test FAILS
    - FIXED: Response is immediate -> test PASSES
    """

    def test_sql_injection_primary(self):
        """
        Primary SQL injection test using nested SELECT/SLEEP technique.
        Payload: 1' AND (SELECT 5 FROM (SELECT(SLEEP(5)))abc) AND 'x'='x
        """
        payload = {"id": f"1' AND (SELECT {SLEEP_DELAY} FROM (SELECT(SLEEP({SLEEP_DELAY})))abc) AND 'x'='x"}

        start = time.time()
        try:
            response = requests.post(VULN_ENDPOINT, data=payload, timeout=TIMEOUT)
        except requests.exceptions.Timeout:
            pytest.fail("Request timed out - SQL injection vulnerability exists!")
        elapsed = time.time() - start

        assert elapsed < THRESHOLD, (
            f"Response took {elapsed:.2f}s (threshold: {THRESHOLD}s). "
            f"Time-based SQL injection vulnerability detected! "
            f"The 'id' parameter in uprec.php is vulnerable to SQL injection."
        )

    def test_sql_injection_variant(self):
        """
        Variant SQL injection test using SELECT * FROM subquery SLEEP.
        Payload: 1' AND (SELECT * FROM (SELECT SLEEP(5))foo) AND 'x'='x
        """
        payload = {"id": f"1' AND (SELECT * FROM (SELECT SLEEP({SLEEP_DELAY}))foo) AND 'x'='x"}

        start = time.time()
        try:
            response = requests.post(VULN_ENDPOINT, data=payload, timeout=TIMEOUT)
        except requests.exceptions.Timeout:
            pytest.fail("Request timed out - SQL injection variant vulnerability exists!")
        elapsed = time.time() - start

        assert elapsed < THRESHOLD, (
            f"Response took {elapsed:.2f}s. "
            f"SQL injection vulnerability confirmed with variant payload!"
        )

    def test_sql_injection_double_sleep(self):
        """
        Double SLEEP test to ensure consistent vulnerability detection.
        Uses a different sleep duration to confirm injection control.
        """
        short_delay = 3
        payload = {"id": f"1' AND (SELECT {short_delay} FROM (SELECT(SLEEP({short_delay})))xyz) AND 'a'='a"}

        start = time.time()
        try:
            response = requests.post(VULN_ENDPOINT, data=payload, timeout=TIMEOUT)
        except requests.exceptions.Timeout:
            pytest.fail("Request timed out - SQL injection vulnerability exists!")
        elapsed = time.time() - start

        # Using shorter threshold since we're using 3 second delay
        assert elapsed < 2, (
            f"Response took {elapsed:.2f}s with {short_delay}s SLEEP. "
            f"SQL injection vulnerability confirmed!"
        )
