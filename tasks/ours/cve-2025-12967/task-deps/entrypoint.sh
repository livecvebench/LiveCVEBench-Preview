#!/bin/bash
# Entrypoint script for CVE-2025-12967 application container
# Keeps the container running for testing

# Set environment variables for database connection (defaults)
export DB_HOST=${DB_HOST:-db}
export DB_PORT=${DB_PORT:-5432}
export DB_NAME=${DB_NAME:-testdb}
export DB_USER=${DB_USER:-postgres}
export DB_PASS=${DB_PASS:-postgres}

echo "Starting CVE-2025-12967 application container..."
echo "Database: ${DB_HOST}:${DB_PORT}/${DB_NAME}"

# Wait for PostgreSQL to be ready
echo "Waiting for PostgreSQL to be ready..."
max_retries=30
retry_count=0
until pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -q; do
    retry_count=$((retry_count + 1))
    if [ $retry_count -ge $max_retries ]; then
        echo "PostgreSQL is not ready after $max_retries attempts. Exiting."
        exit 1
    fi
    echo "PostgreSQL is not ready yet... (attempt $retry_count/$max_retries)"
    sleep 2
done

echo "PostgreSQL is ready!"
echo "Container is ready for testing."

# Keep the container running
exec tail -f /dev/null
