#!/bin/bash
set -e

# Fix for copyparty ReDoS vulnerability
# This script replaces regex-based filtering with safe string matching

cd /app

# Find the copyparty source directory
if [ -d "copyparty-1.18.8" ]; then
    SRCDIR="copyparty-1.18.8"
elif [ -d "copyparty" ]; then
    SRCDIR="."
else
    # Search for copyparty module
    SRCDIR=$(find . -maxdepth 2 -type d -name "copyparty" -exec dirname {} \; | head -1)
    if [ -z "$SRCDIR" ]; then
        echo "ERROR: Cannot find copyparty source directory"
        exit 1
    fi
fi

cd "$SRCDIR"
echo "Working in $(pwd)"
echo "Applying fix for filter functionality..."

# Step 1: Add str_anchor function to util.py
if grep -q "def str_anchor" copyparty/util.py; then
    echo "str_anchor already exists in util.py, skipping..."
else
    # Add str_anchor function before log_reloc function
    python3 << 'PYEOF'
import re

with open('copyparty/util.py', 'r') as f:
    content = f.read()

str_anchor_func = '''
def str_anchor(txt) -> tuple[int, str]:
    if not txt:
        return 0, ""
    txt = txt.lower()
    a = txt.startswith("^")
    b = txt.endswith("$")
    if not b:
        if not a:
            return 1, txt  # substring match
        return 2, txt[1:]  # prefix match
    if not a:
        return 3, txt[:-1]  # suffix match
    return 4, txt[1:-1]  # exact match


'''

# Insert before def log_reloc
pattern = r'\ndef log_reloc\('
if re.search(pattern, content):
    content = re.sub(pattern, str_anchor_func + 'def log_reloc(', content)
else:
    # Fallback: append at end of file
    content += str_anchor_func

with open('copyparty/util.py', 'w') as f:
    f.write(content)

print("Added str_anchor function to util.py")
PYEOF
fi

# Step 2: Add str_anchor to imports in httpcli.py
if grep -q "str_anchor" copyparty/httpcli.py; then
    echo "str_anchor already imported in httpcli.py, skipping..."
else
    python3 << 'PYEOF'
import re

with open('copyparty/httpcli.py', 'r') as f:
    content = f.read()

# Find "stat_resource," and add "str_anchor," after it
pattern = r'(\s+stat_resource,)\n'
replacement = r'\1\n    str_anchor,\n'
content = re.sub(pattern, replacement, content)

with open('copyparty/httpcli.py', 'w') as f:
    f.write(content)

print("Added str_anchor import to httpcli.py")
PYEOF
fi

# Step 3-5: Fix tx_ups() and tx_rups() functions
python3 << 'PYEOF'
import re

with open('copyparty/httpcli.py', 'r') as f:
    content = f.read()

# Fix tx_ups function: replace zs variable with sfilt, nfi, vfi
# Pattern: zs = self.uparam.get("filter") or ""
#          filt = re.compile(zs, re.I) if zs else None
#          lm = "ups %r" % (zs,)
content = re.sub(
    r'zs = self\.uparam\.get\("filter"\) or ""\s*\n\s*filt = re\.compile\(zs, re\.I\) if zs else None\s*\n\s*lm = "ups %r" % \(zs,\)',
    '''sfilt = self.uparam.get("filter") or ""
        nfi, vfi = str_anchor(sfilt)
        lm = "ups %d%r" % (nfi, sfilt)''',
    content
)

# Fix tx_rups function: replace filt regex with str_anchor
# Pattern: sfilt = self.uparam.get("filter") or ""
#          filt = re.compile(sfilt, re.I) if sfilt else None
#          lm = "ru %r" % (sfilt,)
content = re.sub(
    r'(sfilt = self\.uparam\.get\("filter"\) or "")\s*\n\s*filt = re\.compile\(sfilt, re\.I\) if sfilt else None\s*\n\s*lm = "ru %r" % \(sfilt,\)',
    r'''\1
        nfi, vfi = str_anchor(sfilt)
        lm = "ru %d%r" % (nfi, sfilt)''',
    content
)

# Replace all occurrences of the filter check pattern in loops
# Pattern: if filt and not filt.search(vp):
#              continue
# Fixed logic:
# nfi=0: no filter, include everything
# nfi=1: substring match, skip if vfi NOT in vp
# nfi=2: prefix match, skip if not startswith vfi
# nfi=3: suffix match, skip if not endswith vfi
# nfi=4: exact match, skip if vp != vfi
old_pattern = r'if filt and not filt\.search\(vp\):\s*\n\s*continue'
new_code = '''if nfi == 1 and vfi not in vp.lower():
                    continue
                elif nfi == 2 and not vp.lower().startswith(vfi):
                    continue
                elif nfi == 3 and not vp.lower().endswith(vfi):
                    continue
                elif nfi == 4 and vp.lower() != vfi:
                    continue'''

content = re.sub(old_pattern, new_code, content)

with open('copyparty/httpcli.py', 'w') as f:
    f.write(content)

print("Fixed tx_ups() and tx_rups() functions in httpcli.py")
PYEOF

echo "Fix applied successfully"

# Restart the server to apply changes
# Use pkill to kill copyparty process - procps is installed in container
# Use SIGKILL (-9) to force kill even if stuck in ReDoS
pkill -9 -f "python.*copyparty" 2>/dev/null || true

# Wait for server to restart (entrypoint loop will restart it)
sleep 5

# Verify server is back up (with timeout for curl to avoid hanging)
for i in {1..30}; do
    if curl --max-time 2 -s -o /dev/null -w "%{http_code}" http://localhost:3923/ | grep -q "200\|302"; then
        echo "Server restarted successfully"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "Warning: Server may not be fully restarted"
    fi
    sleep 1
done

echo "Server process terminated and restarted"
