#!/bin/bash
# Solution script for ImageMagick BMP decoder integer overflow fix
# This script applies the fix that adds an overflow check BEFORE the multiplication

set -e

echo "[*] Applying fix to ImageMagick BMP decoder..."

# Find the bmp.c source file
BMP_FILE=""
for path in \
    "/app/coders/bmp.c" \
    "/app/ImageMagick/coders/bmp.c" \
    "/app/ImageMagick-7.1.2-5/coders/bmp.c" \
    "/opt/imagemagick/coders/bmp.c" \
    "/src/ImageMagick/coders/bmp.c"; do
    if [ -f "$path" ]; then
        BMP_FILE="$path"
        break
    fi
done

# If not found in expected locations, search for it
if [ -z "$BMP_FILE" ]; then
    BMP_FILE=$(find /app -name "bmp.c" -path "*/coders/*" 2>/dev/null | head -1)
fi

if [ -z "$BMP_FILE" ] || [ ! -f "$BMP_FILE" ]; then
    echo "[!] Error: Could not find coders/bmp.c"
    echo "[*] Searched in: /app, /opt/imagemagick, /src/ImageMagick"
    exit 1
fi

echo "[*] Found BMP source file: $BMP_FILE"

# Check if fix is already applied
if grep -q "BMPOverflowCheck(image->columns,bmp_info.bits_per_pixel)" "$BMP_FILE"; then
    echo "[*] Fix already applied - skipping"
else
    echo "[*] Applying overflow check fix..."

    # The fix: Add overflow check BEFORE the extent calculation
    # We insert after the line: bmp_info.bits_per_pixel<<=1;
    # The new check: if (BMPOverflowCheck(image->columns,bmp_info.bits_per_pixel) != MagickFalse)
    #                  ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");

    # Use sed to insert the fix after the bits_per_pixel<<=1 line
    sed -i '/bmp_info\.bits_per_pixel<<=1;/a\
    if (BMPOverflowCheck(image->columns,bmp_info.bits_per_pixel) != MagickFalse)\
      ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");' "$BMP_FILE"

    echo "[*] Fix applied successfully"
fi

# Verify the fix was applied
echo "[*] Verifying fix..."
if grep -q "BMPOverflowCheck(image->columns,bmp_info.bits_per_pixel)" "$BMP_FILE"; then
    echo "[+] Verification passed: Overflow check is in place"
else
    echo "[-] Verification failed: Fix may not have been applied correctly"
    exit 1
fi

# Find ImageMagick source root directory
IM_ROOT=$(dirname $(dirname "$BMP_FILE"))
echo "[*] ImageMagick source root: $IM_ROOT"

# Recompile ImageMagick
echo "[*] Recompiling ImageMagick..."
cd "$IM_ROOT"

# Check if Makefile exists
if [ -f "Makefile" ]; then
    make -j$(nproc) 2>&1 | tail -20
    echo "[*] Installing..."
    make install 2>&1 | tail -10

    # Update shared library cache
    if command -v ldconfig &> /dev/null; then
        ldconfig 2>/dev/null || true
    fi

    echo "[+] ImageMagick recompiled and installed"
else
    echo "[!] No Makefile found - assuming pre-built or different build system"
    echo "[!] The source fix has been applied but recompilation may be needed"
fi

echo ""
echo "[+] Fix complete!"
echo "[*] The BMP decoder now checks for integer overflow BEFORE performing"
echo "    the extent calculation (width * bits_per_pixel)."
