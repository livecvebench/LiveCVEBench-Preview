#!/bin/bash
# Solution script for fixing XSS vulnerability in Voting System
# This script applies output encoding to prevent stored XSS attacks

set -e

# Main vulnerable file
FILE="/app/votesystem/admin/candidates.php"

# Check if file exists (might also be at /var/www/html path)
if [ ! -f "$FILE" ]; then
    FILE="/var/www/html/votesystem/admin/candidates.php"
fi

if [ ! -f "$FILE" ]; then
    echo "Error: candidates.php not found"
    exit 1
fi

echo "Fixing XSS vulnerability in $FILE..."

# Create backup
cp "$FILE" "${FILE}.bak"

# Fix 1: Apply htmlspecialchars to firstname output
# Pattern: <td>".$row['firstname']."</td>
# Replace with: <td>".htmlspecialchars($row['firstname'], ENT_QUOTES, 'UTF-8')."</td>
sed -i "s/\"\\.\\\$row\['firstname'\]\\.\"/\".htmlspecialchars(\$row['firstname'], ENT_QUOTES, 'UTF-8').\"/g" "$FILE"

# Fix 2: Apply htmlspecialchars to lastname output
# Pattern: <td>".$row['lastname']."</td>
# Replace with: <td>".htmlspecialchars($row['lastname'], ENT_QUOTES, 'UTF-8')."</td>
sed -i "s/\"\\.\\\$row\['lastname'\]\\.\"/\".htmlspecialchars(\$row['lastname'], ENT_QUOTES, 'UTF-8').\"/g" "$FILE"

# Fix 3: Apply htmlspecialchars to description output (position name)
# Pattern: <td>".$row['description']."</td>
# Replace with: <td>".htmlspecialchars($row['description'], ENT_QUOTES, 'UTF-8')."</td>
sed -i "s/\"\\.\\\$row\['description'\]\\.\"/\".htmlspecialchars(\$row['description'], ENT_QUOTES, 'UTF-8').\"/g" "$FILE"

# Fix 4: Fix JavaScript - change .html() to .text() for platform display
# This prevents XSS when platform content is displayed in modal via AJAX
# Pattern: $('#desc').html(response.platform)
# Replace with: $('#desc').text(response.platform)
sed -i "s/\\\$('#desc').html(response.platform)/\$('#desc').text(response.platform)/g" "$FILE"

# Fix 5: Fix JavaScript - escape HTML in fullname display
# The fullname uses: $('.fullname').html(response.firstname+' '+response.lastname)
# We need to use text() or escape the HTML
# Pattern: $('.fullname').html(response.firstname+' '+response.lastname)
# Replace with: $('.fullname').text(response.firstname+' '+response.lastname)
sed -i "s/\\\$('.fullname').html(response.firstname+' '+response.lastname)/\$('.fullname').text(response.firstname+' '+response.lastname)/g" "$FILE"

echo "XSS vulnerability fix applied successfully!"

# Verify the fixes were applied
echo "Verifying fixes..."

if grep -q "htmlspecialchars.*firstname" "$FILE"; then
    echo "✓ Firstname encoding applied"
else
    echo "⚠ Warning: Firstname encoding may not have been applied correctly"
fi

if grep -q "htmlspecialchars.*lastname" "$FILE"; then
    echo "✓ Lastname encoding applied"
else
    echo "⚠ Warning: Lastname encoding may not have been applied correctly"
fi

if grep -q "\.text(response\.platform)" "$FILE" || ! grep -q "\.html(response\.platform)" "$FILE"; then
    echo "✓ Platform display fix applied"
else
    echo "⚠ Warning: Platform display fix may not have been applied correctly"
fi

if grep -q "\.text(response\.firstname" "$FILE" || ! grep -q "\.html(response\.firstname" "$FILE"; then
    echo "✓ Fullname display fix applied"
else
    echo "⚠ Warning: Fullname display fix may not have been applied correctly"
fi

echo ""
echo "Fix complete. The following changes were made:"
echo "1. Added htmlspecialchars() encoding to firstname, lastname, and description outputs"
echo "2. Changed jQuery .html() to .text() for platform display in modal"
echo "3. Changed jQuery .html() to .text() for fullname display in modal"

# Fix 6: Also fix candidates_row.php to encode JSON data
ROW_FILE="/app/votesystem/admin/candidates_row.php"
if [ ! -f "$ROW_FILE" ]; then
    ROW_FILE="/var/www/html/votesystem/admin/candidates_row.php"
fi

if [ -f "$ROW_FILE" ]; then
    echo ""
    echo "Fixing candidates_row.php to encode JSON output..."
    cp "$ROW_FILE" "${ROW_FILE}.bak"

    # Replace echo json_encode($row) with encoding for vulnerable fields
    # Original: echo json_encode($row);
    # New: Encode firstname, lastname, and platform fields before JSON encoding
    sed -i 's/echo json_encode(\$row);/\$row["firstname"] = htmlspecialchars(\$row["firstname"] ?? "", ENT_QUOTES, "UTF-8");\n\t\t\$row["lastname"] = htmlspecialchars(\$row["lastname"] ?? "", ENT_QUOTES, "UTF-8");\n\t\t\$row["platform"] = htmlspecialchars(\$row["platform"] ?? "", ENT_QUOTES, "UTF-8");\n\t\techo json_encode(\$row);/g' "$ROW_FILE"

    if grep -q "htmlspecialchars" "$ROW_FILE"; then
        echo "✓ candidates_row.php encoding applied"
    else
        echo "⚠ Warning: candidates_row.php encoding may not have been applied correctly"
    fi
fi
