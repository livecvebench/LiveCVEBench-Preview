FROM php:7.4-apache

WORKDIR /app

# System dependencies
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Install PHP mysqli extension
RUN docker-php-ext-install mysqli

# Clone the hashtech repository at the vulnerable commit
RUN git clone https://github.com/henzljw/hashtech.git /app && \
    cd /app && \
    git checkout 5919decaff2681dc250e934814fc3a35f6093ee5 && \
    rm -rf .git

# Update connection.php to use MySQL container hostname and password
RUN sed -i 's/mysqli_connect("localhost", "root", ""/mysqli_connect("mysql", "root", "hashtech123"/' /app/connection.php

# Set up Apache to serve from /app
RUN rm -rf /var/www/html && ln -s /app /var/www/html

# Enable short_open_tag for PHP
RUN echo "short_open_tag = On" > /usr/local/etc/php/conf.d/short-open-tag.ini

# Create writable directories
RUN mkdir -p /app/gadget_images /app/ProofOfPayment && \
    chown -R www-data:www-data /app/gadget_images /app/ProofOfPayment && \
    chmod 755 /app/gadget_images /app/ProofOfPayment

# Copy SQL schema from task-deps
COPY task-deps/hashtech.sql /app/database/hashtech.sql

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Apache configuration - enable mod_rewrite
RUN a2enmod rewrite


# Use entrypoint script to initialize DB and start Apache
# CMD ["/entrypoint.sh"]
