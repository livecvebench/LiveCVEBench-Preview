"""
Functionality tests for GitProxy push processing chain.

These tests verify that the application's core functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""
import subprocess
import os


class TestProxyFunctionality:
    """Test basic GitProxy functionality."""

    def test_chain_module_exists(self):
        """Verify the chain.ts module exists and can be transpiled."""
        chain_path = "/app/src/proxy/chain.ts"
        assert os.path.exists(chain_path), f"chain.ts not found at {chain_path}"

        # Verify it's valid TypeScript by checking basic syntax
        with open(chain_path, 'r') as f:
            content = f.read()

        assert "pushActionChain" in content, "pushActionChain not found in chain.ts"
        assert "executeChain" in content, "executeChain function not found"
        assert "getChain" in content, "getChain function not found"

    def test_write_pack_module_exists(self):
        """Verify writePack.ts module exists."""
        write_pack_path = "/app/src/proxy/processors/push-action/writePack.ts"
        assert os.path.exists(write_pack_path), f"writePack.ts not found"

        with open(write_pack_path, 'r') as f:
            content = f.read()

        assert "exec" in content, "exec function not found in writePack.ts"
        assert "receive-pack" in content, "git receive-pack not referenced"

    def test_action_class_exists(self):
        """Verify Action class exists with required properties."""
        action_path = "/app/src/proxy/actions/Action.ts"
        assert os.path.exists(action_path), f"Action.ts not found"

        with open(action_path, 'r') as f:
            content = f.read()

        assert "class Action" in content, "Action class not found"
        assert "commitFrom" in content, "commitFrom property not found"
        assert "commitTo" in content, "commitTo property not found"
        assert "proxyGitPath" in content, "proxyGitPath property not found"

    def test_push_processors_index_exists(self):
        """Verify the processors index.ts exists and exports required functions."""
        index_path = "/app/src/proxy/processors/push-action/index.ts"
        assert os.path.exists(index_path), f"index.ts not found"

        with open(index_path, 'r') as f:
            content = f.read()

        assert "writePack" in content, "writePack export not found"
        assert "parsePush" in content, "parsePush export not found"
        assert "pullRemote" in content, "pullRemote export not found"

    def test_chain_has_required_processors(self):
        """Verify chain.ts includes essential processors."""
        chain_path = "/app/src/proxy/chain.ts"

        with open(chain_path, 'r') as f:
            content = f.read()

        required_processors = [
            "parsePush",
            "checkRepoInAuthorisedList",
            "pullRemote",
            "writePack",
            "preReceive",
            "getDiff",
        ]

        for processor in required_processors:
            assert processor in content, f"Required processor {processor} not found in chain"

    def test_typescript_compiles(self):
        """Verify TypeScript files can be compiled without errors."""
        result = subprocess.run(
            ["npx", "tsc", "--noEmit", "--skipLibCheck", "--esModuleInterop",
             "/app/src/proxy/chain.ts"],
            cwd="/app",
            capture_output=True,
            text=True
        )
        # Note: We just check the files are syntactically valid
        # Full compilation may fail due to missing dependencies in test env
        # So we're being lenient here - accept common TS compilation issues
        acceptable_errors = [
            "Cannot find module",
            "Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag",
            "Property 'hasOwn' does not exist on type 'ObjectConstructor'",
            "Type 'RegExpStringIterator<RegExpExecArray>' can only be iterated through"
        ]

        if result.returncode == 0:
            # Perfect - no errors
            return

        # Check if errors are acceptable (check both stderr and stdout)
        error_output = result.stderr + result.stdout
        for acceptable_error in acceptable_errors:
            if acceptable_error in error_output:
                return  # These are acceptable compilation issues

        # If we get here, there are unexpected compilation errors
        assert False, f"TypeScript compilation failed with unexpected errors: stdout={result.stdout}, stderr={result.stderr}"


class TestStepClass:
    """Test the Step class functionality."""

    def test_step_class_exists(self):
        """Verify Step class exists."""
        step_path = "/app/src/proxy/actions/Step.ts"
        assert os.path.exists(step_path), f"Step.ts not found"

        with open(step_path, 'r') as f:
            content = f.read()

        assert "class Step" in content or "Step" in content, "Step class not found"


class TestProcessorStructure:
    """Test the processor directory structure."""

    def test_processors_directory_exists(self):
        """Verify processors directory structure."""
        base_path = "/app/src/proxy/processors"
        assert os.path.isdir(base_path), "processors directory not found"

        push_action_path = os.path.join(base_path, "push-action")
        assert os.path.isdir(push_action_path), "push-action directory not found"

    def test_core_processors_exist(self):
        """Verify core processor files exist."""
        push_action_path = "/app/src/proxy/processors/push-action"

        core_files = [
            "parsePush.ts",
            "writePack.ts",
            "pullRemote.ts",
            "preReceive.ts",
            "getDiff.ts",
            "index.ts",
        ]

        for filename in core_files:
            filepath = os.path.join(push_action_path, filename)
            assert os.path.exists(filepath), f"Core processor {filename} not found"


class TestGitProxyConfiguration:
    """Test GitProxy configuration and basic setup."""

    def test_configuration_file_exists(self):
        """Verify proxy.config.json exists with required settings."""
        config_path = "/app/proxy.config.json"
        assert os.path.exists(config_path), "proxy.config.json not found"

        with open(config_path, 'r') as f:
            content = f.read()

        # Check for basic configuration elements
        assert "proxyUrl" in content, "proxyUrl not found in configuration"
        assert "authorisedList" in content, "authorisedList not found in configuration"
        assert "test-org" in content, "test-org not found in authorised list"
        assert "test-repo" in content, "test-repo not found in authorised list"

    def test_data_directory_exists(self):
        """Verify data directory exists for git operations."""
        data_path = "/app/data"
        assert os.path.isdir(data_path), "data directory not found"

    def test_package_json_has_server_script(self):
        """Verify package.json has server script."""
        package_path = "/app/package.json"
        assert os.path.exists(package_path), "package.json not found"

        with open(package_path, 'r') as f:
            content = f.read()

        assert '"server"' in content, "server script not found in package.json"