"""
Vulnerability tests for CVE-2025-48075: Fiber BodyParser Panic on Negative Array Index.

These tests verify that the application handles malformed array indices gracefully
WITHOUT crashing (panic).

TEST BEHAVIOR:
- In VULNERABLE state (v2.52.6): Server crashes/panics on negative indices -> Tests FAIL
- In FIXED state (v2.52.7): Server returns error response gracefully -> Tests PASS

The tests PASS when the server handles negative indices gracefully (returns error).
The tests FAIL when the server crashes (vulnerable behavior).
"""

import pytest
import requests
import time


BASE_URL = "http://localhost:3000"
MAX_RETRIES = 15
RETRY_DELAY = 2


def wait_for_server():
    """Wait for the server to be available."""
    for i in range(MAX_RETRIES):
        try:
            response = requests.post(
                f"{BASE_URL}/",
                data={"nested-content[0].value": "healthcheck"},
                timeout=5
            )
            if response.status_code == 200:
                return True
        except requests.exceptions.ConnectionError:
            if i < MAX_RETRIES - 1:
                time.sleep(RETRY_DELAY)
            continue
        except Exception:
            if i < MAX_RETRIES - 1:
                time.sleep(RETRY_DELAY)
            continue
    return False


def send_negative_index_request(negative_value: str = "Foo", index: int = -1, timeout: int = 10):
    """
    Send a request with a negative array index.

    Returns (success, status_code, error_message):
        - success: True if server responded with an error code (graceful handling)
        - status_code: HTTP status code if response received, None if crashed
        - error_message: Error message if any
    """
    try:
        response = requests.post(
            f"{BASE_URL}/",
            data={f"nested-content[{index}].value": negative_value},
            timeout=timeout
        )
        # Server responded - check if it returned an error status
        if response.status_code in [400, 422, 500]:
            return True, response.status_code, None
        else:
            # Unexpected success status - might indicate bug in test
            return True, response.status_code, f"Unexpected status: {response.status_code}"
    except requests.exceptions.ConnectionError as e:
        # Connection error - server likely crashed
        return False, None, f"ConnectionError: {e}"
    except requests.exceptions.Timeout as e:
        # Timeout - server might be hung
        return False, None, f"Timeout: {e}"
    except Exception as e:
        return False, None, f"Unknown error: {e}"


class TestNegativeIndexHandling:
    """
    Test suite for negative array index handling in form data.

    These tests verify that the server handles negative indices GRACEFULLY by
    returning an error response. If the server crashes (vulnerable behavior),
    these tests will FAIL.
    """

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before each test."""
        assert wait_for_server(), "Server is not available"
        # Small delay to ensure server is fully ready
        time.sleep(0.5)

    def test_negative_index_minus_one(self):
        """Test that negative index -1 is handled gracefully without crashing."""
        success, status_code, error = send_negative_index_request(index=-1)

        assert success, f"Server crashed instead of returning error response. Error: {error}"
        assert status_code in [400, 422, 500], \
            f"Expected error status code (400/422/500), got {status_code}"

    def test_negative_index_minus_ten(self):
        """Test that larger negative index -10 is handled gracefully."""
        success, status_code, error = send_negative_index_request(index=-10)

        assert success, f"Server crashed on negative index -10. Error: {error}"
        assert status_code in [400, 422, 500], \
            f"Expected error status code, got {status_code}"

    def test_negative_index_minus_9999(self):
        """Test that very large negative index is handled gracefully."""
        success, status_code, error = send_negative_index_request(index=-9999)

        assert success, f"Server crashed on very large negative index. Error: {error}"
        assert status_code in [400, 422, 500], \
            f"Expected error status code, got {status_code}"

    def test_multiple_negative_indices(self):
        """Test that multiple negative indices in same request are handled."""
        try:
            response = requests.post(
                f"{BASE_URL}/",
                data={
                    "nested-content[-1].value": "First",
                    "nested-content[-2].value": "Second"
                },
                timeout=10
            )
            assert response.status_code in [400, 422, 500], \
                f"Expected error status code, got {response.status_code}"
        except requests.exceptions.ConnectionError as e:
            pytest.fail(f"Server crashed on multiple negative indices: {e}")
        except requests.exceptions.Timeout as e:
            pytest.fail(f"Server timed out on multiple negative indices: {e}")

    def test_mixed_valid_and_negative_indices(self):
        """Test that mix of valid and negative indices is handled gracefully."""
        try:
            response = requests.post(
                f"{BASE_URL}/",
                data={
                    "nested-content[0].value": "Valid",
                    "nested-content[-1].value": "Invalid"
                },
                timeout=10
            )
            assert response.status_code in [400, 422, 500], \
                f"Expected error status code, got {response.status_code}"
        except requests.exceptions.ConnectionError as e:
            pytest.fail(f"Server crashed on mixed indices: {e}")
        except requests.exceptions.Timeout as e:
            pytest.fail(f"Server timed out on mixed indices: {e}")

    def test_negative_index_url_encoded(self):
        """Test negative index with URL-encoded content type."""
        try:
            response = requests.post(
                f"{BASE_URL}/",
                data="nested-content[-1].value=Encoded",
                headers={"Content-Type": "application/x-www-form-urlencoded"},
                timeout=10
            )
            assert response.status_code in [400, 422, 500], \
                f"Expected error status code, got {response.status_code}"
        except requests.exceptions.ConnectionError as e:
            pytest.fail(f"Server crashed with URL-encoded negative index: {e}")
        except requests.exceptions.Timeout as e:
            pytest.fail(f"Server timed out with URL-encoded negative index: {e}")

    def test_negative_index_multipart_form(self):
        """Test negative index with multipart/form-data encoding."""
        try:
            response = requests.post(
                f"{BASE_URL}/",
                files={"nested-content[-1].value": (None, "Multipart")},
                timeout=10
            )
            assert response.status_code in [400, 422, 500], \
                f"Expected error status code, got {response.status_code}"
        except requests.exceptions.ConnectionError as e:
            pytest.fail(f"Server crashed with multipart negative index: {e}")
        except requests.exceptions.Timeout as e:
            pytest.fail(f"Server timed out with multipart negative index: {e}")

    def test_error_response_contains_meaningful_message(self):
        """Test that error response contains meaningful error information."""
        try:
            response = requests.post(
                f"{BASE_URL}/",
                data={"nested-content[-1].value": "Test"},
                timeout=10
            )

            assert response.status_code in [400, 422, 500], \
                f"Expected error status code, got {response.status_code}"

            # Try to parse JSON response
            try:
                data = response.json()
                assert "error" in data, "Response should contain 'error' field"
                error_msg = data["error"].lower()
                # Error message should mention the issue
                assert any(term in error_msg for term in ["panic", "decode", "schema", "reflect", "slice", "index"]), \
                    f"Error message should be descriptive, got: {data['error']}"
            except ValueError:
                # Not JSON, but at least we got an error status code
                pass

        except requests.exceptions.ConnectionError as e:
            pytest.fail(f"Server crashed instead of returning error: {e}")
        except requests.exceptions.Timeout as e:
            pytest.fail(f"Server timed out: {e}")

    def test_server_survives_single_attack(self):
        """Test that server handles a single negative index attack gracefully."""
        success, status_code, error = send_negative_index_request(index=-1)

        assert success, f"Server crashed on single attack. Error: {error}"
        assert status_code in [400, 422, 500], \
            f"Expected error status code, got {status_code}"
