package jehc.djshi.sys.web;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import jehc.djshi.common.annotation.Auth;
import jehc.djshi.common.base.*;
import jehc.djshi.common.entity.OauthAccountEntity;
import jehc.djshi.common.util.JsonUtil;
import jehc.djshi.sys.model.XtPost;
import jehc.djshi.sys.service.XtPostService;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import com.github.pagehelper.PageInfo;
import com.github.pagehelper.util.StringUtil;
import javax.annotation.Resource;
/**
 * @Desc 用户岗位
 * @Author 邓纯杰
 * @CreateTime 2012-12-12 12:12:12
 */
@RestController
@RequestMapping("/xtPost")
@Api(value = "用户岗位API",tags = "用户岗位API",description = "用户岗位API")
public class XtPostController extends BaseAction {

	@Resource
	private XtPostService xtPostService;
	
	/**
	* 查询岗位列表并分页
	* @param baseSearch
	*/
	@ApiOperation(value="查询岗位列表并分页", notes="查询岗位列表并分页")
	@PostMapping(value="/list")
	@Auth(value = "/xtPost/list",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BasePage<List<XtPost>> getXtPostListByCondition(@RequestBody(required=true)BaseSearch baseSearch){
		Map<String, Object> condition = baseSearch.convert();
		commonHPager(baseSearch);
		List<XtPost> xtPostList = xtPostService.getXtPostListByCondition(condition);
		for(XtPost xtPost:xtPostList){
			if(!StringUtil.isEmpty(xtPost.getCreateId())){
				OauthAccountEntity createBy = getAccount(xtPost.getCreateId());
				if(null != createBy){
					xtPost.setCreateBy(createBy.getName());
				}
			}
			if(!StringUtil.isEmpty(xtPost.getUpdateId())){
				OauthAccountEntity modifiedBy = getAccount(xtPost.getUpdateId());
				if(null != modifiedBy){
					xtPost.setModifiedBy(modifiedBy.getName());
				}
			}
		}
		PageInfo<XtPost> page = new PageInfo<XtPost>(xtPostList);
		return outPageBootStr(page,baseSearch);
	}

	/**
	 * 一级岗位
	 * @param departInfoId
	 */
	@ApiOperation(value="一级岗位", notes="一级岗位")
	@GetMapping(value="/one/level/lists/{departInfoId}")
	@Auth(value = "/xtPost/one/level/lists",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult<List<XtPost>> oneLevelLists(@PathVariable("departInfoId")String departInfoId){
		Map<String,Object> condition = new HashMap<>();
		condition.put("departInfoId",departInfoId);
		List<XtPost> xtPosts = xtPostService.getXtPostInfoList(condition);
		return outDataStr(xtPosts);
	}

	/**
	* 查询单个岗位
	* @param id
	*/
	@ApiOperation(value="查询单个岗位", notes="查询单个岗位")
	@GetMapping(value="/get/{id}")
	@Auth(value = "/xtPost/get",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult<XtPost> getXtPostById(@PathVariable("id")String id){
		XtPost xtPost = xtPostService.getXtPostById(id);
		if(!StringUtil.isEmpty(xtPost.getCreateId())){
			OauthAccountEntity createBy = getAccount(xtPost.getCreateId());
			if(null != createBy){
				xtPost.setCreateBy(createBy.getName());
			}
		}
		if(!StringUtil.isEmpty(xtPost.getUpdateId())){
			OauthAccountEntity modifiedBy = getAccount(xtPost.getUpdateId());
			if(null != modifiedBy){
				xtPost.setModifiedBy(modifiedBy.getName());
			}
		}
		return outDataStr(xtPost);
	}
	
	/**
	* 添加
	* @param xtPost
	*/
	@ApiOperation(value="创建单个岗位", notes="创建单个岗位")
	@PostMapping(value="/add")
	public BaseResult addXtPost(@RequestBody XtPost xtPost){
		int i = 0;
		if(null != xtPost){
			xtPost.setId(toUUID());
			if(StringUtil.isEmpty(xtPost.getParentId())){
				xtPost.setParentId("0");
			}
			i=xtPostService.addXtPost(xtPost);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}
	
	/**
	* 修改
	* @param xtPost
	*/
	@ApiOperation(value="编辑单个岗位", notes="编辑单个岗位")
	@PutMapping(value="/update")
	public BaseResult updateXtPost(@RequestBody XtPost xtPost){
		int i = 0;
		if(null != xtPost){
			if(StringUtil.isEmpty(xtPost.getParentId())){
				xtPost.setParentId("0");
			}
			i=xtPostService.updateXtPost(xtPost);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}
	
	/**
	* 删除
	* @param id
	*/
	@ApiOperation(value="删除岗位", notes="删除岗位")
	@DeleteMapping(value="/delete")
	public BaseResult delXtPost(String id){
		int i = 0;
		if(!StringUtil.isEmpty(id)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id",id.split(","));
			i=xtPostService.delXtPost(condition);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}
	/**
	 * 获取岗位树
	 * @param id
	 */
	@ApiOperation(value="获取岗位树", notes="获取岗位树")
	@GetMapping(value="/tree/{id}")
	@Auth(value = "/xtPost/tree",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getXtPostTree(@PathVariable("id")String id){
		Map<String, Object> condition = new HashMap<String, Object>();
		List<BaseTreeGridEntity> list = new ArrayList<BaseTreeGridEntity>();
		List<XtPost> xtPostList = xtPostService.getXtPostListAll(condition);
		for(int i = 0; i < xtPostList.size(); i++){
			XtPost xtPost = xtPostList.get(i);
			BaseTreeGridEntity BaseTreeGridEntity = new BaseTreeGridEntity();
			BaseTreeGridEntity.setId(xtPost.getId());
			BaseTreeGridEntity.setPid(xtPost.getParentId());
			BaseTreeGridEntity.setText(xtPost.getName());
			BaseTreeGridEntity.setExpanded(true);
			BaseTreeGridEntity.setSingleClickExpand(true);
			BaseTreeGridEntity.setIcon("/deng/images/icons/target.png");
			list.add(BaseTreeGridEntity);
		}
		BaseTreeGridEntity baseTreeGridEntity = new BaseTreeGridEntity();
		List<BaseTreeGridEntity> baseTreeGridEntityList = baseTreeGridEntity.buildTree(list,"0");
		String json = JsonUtil.toFastJson(baseTreeGridEntityList);
		return outStr(json);
	}
	
	/**
	 * 获取岗位树（bootstrap-ztree风格）
	 * @param departInfoId 部门编号
	 */
	@ApiOperation(value="获取岗位树（bootstrap-ztree风格）", notes="获取岗位树（bootstrap-ztree风格）")
	@GetMapping(value="/bztree/{departInfoId}")
	@Auth(value = "/xtPost/bztree",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getXtPostBZTree(@PathVariable("departInfoId")String departInfoId){
		Map<String, Object> condition = new HashMap<String, Object>();
		condition.put("departInfoId", departInfoId);
		List<BaseZTreeEntity> list = new ArrayList<BaseZTreeEntity>();
		List<XtPost> xtPostList = xtPostService.getXtPostListByCondition(condition);
		for(int i = 0; i < xtPostList.size(); i++){
			XtPost xtPost = xtPostList.get(i);
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(xtPost.getId());
			BaseZTreeEntity.setPId(xtPost.getParentId());
			BaseZTreeEntity.setText(xtPost.getName());
			BaseZTreeEntity.setName(xtPost.getName());
			BaseZTreeEntity.setExpanded(true);
			BaseZTreeEntity.setSingleClickExpand(true);
			list.add(BaseZTreeEntity);
		}
		BaseZTreeEntity baseZTreeEntity = new BaseZTreeEntity();
		List<BaseZTreeEntity> baseZTreeEntityList = baseZTreeEntity.buildTree(list,"0");
		String json = JsonUtil.toFastJson(baseZTreeEntityList);
		return outStr(json);
	}
	
	/**
	 * 根据各种情况查找集合不分页（流程设计器中处理组 发起组等使用）
	 * @param id
	 * @return
	 */
	@ApiOperation(value="根据各种情况查找集合不分页", notes="根据各种情况查找集合不分页")
	@GetMapping(value="/list/{id}")
	@Auth(value = "/xtPost/list",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult<List<XtPost>> getXtPostList(@PathVariable("id")String id){
		List<XtPost> list = new ArrayList<XtPost>();
		if(!StringUtil.isEmpty(id)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id", id.split(","));
			list = xtPostService.getXtPostList(condition);
		}
		return  outItemsStr(list);
	}
}
