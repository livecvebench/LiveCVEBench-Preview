# LearnHouse CVE-2025-12276 - EXIF Metadata Exposure Vulnerability
# Simplified backend-only Docker image for CVE testing

FROM python:3.12.3-slim-bookworm

WORKDIR /app/api

# System dependencies (required: tmux, asciinema, curl)
RUN apt-get update && apt-get install -y \
    git \
    build-essential \
    tmux \
    asciinema \
    curl \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Install uv package manager
RUN pip install --upgrade pip && pip install uv

# Clone the repository at the vulnerable commit
RUN git clone https://github.com/learnhouse/learnhouse.git /tmp/learnhouse && \
    cd /tmp/learnhouse && \
    git checkout 98dfad76aad70711a8113f6c1fdabfccf10509ca && \
    rm -rf .git && \
    cp -r apps/api/* /app/api/ && \
    rm -rf /tmp/learnhouse

# Install Python dependencies
RUN uv sync

# Create content directory for file uploads
RUN mkdir -p /app/api/content && chmod 755 /app/api/content

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONIOENCODING=utf-8
ENV LEARNHOUSE_PORT=9000

# Expose the API port
EXPOSE 9000

# Start with the entrypoint script
# CMD ["/entrypoint.sh"]
