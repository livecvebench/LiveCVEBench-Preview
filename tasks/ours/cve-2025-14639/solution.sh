#!/bin/bash
set -e

# Solution for Student Management System input validation issue
# This script fixes the unsafe handling of user input in uprec.php

cd /var/www/html/grading

# The vulnerability is in uprec.php where $_POST['id'] is used directly in SQL queries
# without any validation. Student IDs should be integers, so we add validation.

# Create a backup first
cp uprec.php uprec.php.bak 2>/dev/null || true

# Fix: Add input validation after the $id assignment on line 5
# The $id variable is used in multiple queries, so sanitizing it at the source
# protects all downstream usage.

# Approach: Use intval() to ensure $id is always a valid integer
# This prevents any SQL injection payload from being interpreted

sed -i '/^\$id = \$_POST\['"'"'id'"'"'\];/a\
$id = intval($id); // Sanitize: ensure id is always an integer' uprec.php

# Verify the fix was applied
if grep -q 'intval(\$id)' uprec.php; then
    echo "Fix successfully applied to uprec.php"
else
    echo "Warning: Fix may not have been applied correctly"
    exit 1
fi

# Restart Apache to ensure changes take effect
# (PHP typically doesn't require restart, but this ensures clean state)
if command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
elif command -v apache2ctl &> /dev/null; then
    apache2ctl graceful 2>/dev/null || true
elif command -v service &> /dev/null; then
    service apache2 reload 2>/dev/null || true
fi

echo "Solution applied successfully"
