FROM wordpress:6.4-php8.1-apache

WORKDIR /var/www/html

# Install system dependencies (tb framework requirements)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Install WP-CLI for WordPress management
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
    && chmod +x wp-cli.phar \
    && mv wp-cli.phar /usr/local/bin/wp

# Create themes directory
RUN mkdir -p /var/www/html/wp-content/themes

# Download and install OceanWP theme v4.0.9 (vulnerable version)
RUN curl -L https://github.com/oceanwp/oceanwp/archive/refs/tags/4.0.9.tar.gz | tar -xz -C /tmp \
    && mv /tmp/oceanwp-4.0.9 /var/www/html/wp-content/themes/oceanwp \
    && rm -rf /var/www/html/wp-content/themes/oceanwp/.git \
    && chown -R www-data:www-data /var/www/html/wp-content/themes/oceanwp

# Ensure plugins directory is writable (for CSRF testing)
RUN mkdir -p /var/www/html/wp-content/plugins \
    && chown -R www-data:www-data /var/www/html/wp-content/plugins

# Copy entrypoint script
COPY task-deps/entrypoint.sh /usr/local/bin/custom-entrypoint.sh
RUN chmod +x /usr/local/bin/custom-entrypoint.sh

# Environment variables for WordPress
ENV WORDPRESS_DB_HOST=db
ENV WORDPRESS_DB_USER=wordpress
ENV WORDPRESS_DB_PASSWORD=wordpress
ENV WORDPRESS_DB_NAME=wordpress
ENV WORDPRESS_DEBUG=true

EXPOSE 80

# CMD ["/usr/local/bin/custom-entrypoint.sh"]
