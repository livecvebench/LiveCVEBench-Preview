instruction: |-
  I am using the Auth0 PHP SDK to validate tokens in my application.
  The SDK handles ID tokens (for user identity) and Access tokens (for API authorization).

  I discovered a security vulnerability where an **ID Token** can be successfully validated as an **Access Token**.
  This happens because:
  1. The SDK unconditionally adds the `clientId` to the list of allowed audiences.
  2. ID Tokens typically have `aud` set to `clientId`.
  3. Therefore, an ID Token passes the audience check for Access Token validation.

  Additionally, ID Tokens contain a `nonce` claim (for replay protection) which Access Tokens should never have.
  The validation logic fails to check for this distinction.

  This allows an attacker to use an ID Token (which they can easily obtain) to impersonate an Access Token and gain unauthorized access to APIs.

  Expected behavior:
  - When I call `validate()` expecting an Access Token, it should **REJECT** any token containing a `nonce` claim.
  - The `clientId` should ONLY be added to the allowed audiences for ID Tokens (or as a fallback), not for Access Tokens when an API audience is configured.

author_name: HIT-SCIR-LACG
author_email: xzluo@ir.hit.edu.cn

difficulty: medium
category: bug-fix
tags:
  - php
  - authentication
  - jwt
  - token-validation
parser_name: pytest
run_tests_in_same_shell: false
