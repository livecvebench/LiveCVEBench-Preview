#!/bin/bash
set -e

echo "Applying fix to radiff2 threading warning..."

# Find the radare2 source directory (common locations)
R2_SRC=""
for dir in /app /opt/radare2 /usr/local/src/radare2 /radare2; do
    if [ -f "$dir/libr/main/radiff2.c" ]; then
        R2_SRC="$dir"
        break
    fi
done

if [ -z "$R2_SRC" ]; then
    echo "ERROR: Could not find radare2 source directory"
    exit 1
fi

echo "Found radare2 source at: $R2_SRC"

RADIFF2_FILE="$R2_SRC/libr/main/radiff2.c"

# Check if fix is already applied
if grep -q "Threading support is experimental" "$RADIFF2_FILE"; then
    echo "Fix already applied, skipping..."
else
    echo "Applying fix to $RADIFF2_FILE..."

    # Method 1: Use sed to insert the warning line after "case 'T':"
    # The pattern matches the case statement and adds the warning on the next line
    sed -i "/case 'T':.*imho.*t <=> T/a\\			R_LOG_WARN (\"Threading support is experimental and known to be crashy\");" "$RADIFF2_FILE"

    # Verify the fix was applied
    if grep -q "Threading support is experimental" "$RADIFF2_FILE"; then
        echo "Fix applied successfully to source file"
    else
        echo "ERROR: Fix application failed"
        exit 1
    fi
fi

# Rebuild radare2
echo "Rebuilding radare2..."
cd "$R2_SRC"

if [ -d "build" ]; then
    # Meson build
    ninja -C build
    ninja -C build install
elif [ -f "Makefile" ]; then
    # Make build
    make -j$(nproc)
    make install
else
    echo "ERROR: No build system found"
    exit 1
fi

# Update library cache
ldconfig 2>/dev/null || true

# Verify the fix works at runtime
echo "Verifying fix at runtime..."

# Create test files if they don't exist
TEST_FILE1="/tmp/test_fix_1.bin"
TEST_FILE2="/tmp/test_fix_2.bin"
echo -e '\x7fELF\x01\x01\x01\x00' > "$TEST_FILE1"
echo -e '\x7fELF\x01\x01\x01\x01' > "$TEST_FILE2"

if radiff2 -T "$TEST_FILE1" "$TEST_FILE2" 2>&1 | grep -q "Threading support is experimental"; then
    echo "Runtime verification: WARNING MESSAGE PRESENT"
    echo "Fix successfully applied and verified!"
else
    echo "WARNING: Runtime verification could not confirm fix"
    echo "The warning message was not detected in radiff2 output"
fi

# Cleanup test files
rm -f "$TEST_FILE1" "$TEST_FILE2"

echo ""
echo "Fix complete!"
