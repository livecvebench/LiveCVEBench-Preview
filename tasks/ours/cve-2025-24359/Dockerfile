FROM python:3.10-slim

WORKDIR /app

# Set proxy for network operations
ENV http_proxy=http://oversea-squid5.sgp.txyun:11080
ENV https_proxy=http://oversea-squid5.sgp.txyun:11080

# Set Python environment variables recommended for Docker
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install vulnerable asteval version and pytest for testing
RUN pip install asteval==1.0.5 pytest

# Copy proof of concept exploit and other reference files from task-deps
COPY task-deps/poc_exploit.py /app/poc_exploit.py
COPY task-deps/asteval_vulnerable.py /app/asteval_vulnerable.py
COPY task-deps/astutils_vulnerable.py /app/astutils_vulnerable.py
COPY task-deps/asteval_fixed.py /app/asteval_fixed.py
COPY task-deps/astutils_fixed.py /app/astutils_fixed.py
COPY task-deps/pyproject.toml /app/pyproject.toml


# Default command runs a simple verification and then keeps container running
# CMD ["/bin/bash", "-c", "echo 'Container ready - asteval CVE-2025-24359'; python -c 'import asteval; print(f\"asteval version: {asteval.__version__}\")'; tail -f /dev/null"]