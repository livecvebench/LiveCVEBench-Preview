#!/bin/bash
set -e

# Save the tests directory
TESTS_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$TESTS_DIR"

# Install uv for isolated Python environment
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env 2>/dev/null || true
export PATH="$HOME/.local/bin:$PATH"

# Initialize uv project and add dependencies
uv init 2>/dev/null || true
uv add pytest 2>/dev/null || true

# Ensure the TypeScript application is built
if [ -d "/app" ]; then
    cd /app
    # Check if we need to build
    if [ ! -d "dist" ] || [ "src/tools/queryTools.ts" -nt "dist/src/tools/queryTools.js" ]; then
        echo "Building TypeScript application..."
        npm run build 2>/dev/null || echo "Build may have already been done"
    fi
    cd "$TESTS_DIR"
fi

# Run the tests
uv run pytest . -rA
