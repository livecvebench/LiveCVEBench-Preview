#!/bin/bash
# Solution script for Open5GS SMF PathSwitchRequest N2 Signaling Bug
# This fixes the issue where SMF sends HTTP 204 without N2 buffer when far_update=false

set -e
cd /app

echo "=== Applying fix to Open5GS SMF NGAP handler ==="

NGAP_HANDLER="/app/src/smf/ngap-handler.c"

# Verify the file exists
if [ ! -f "$NGAP_HANDLER" ]; then
    echo "ERROR: $NGAP_HANDLER not found"
    exit 1
fi

# Check if already fixed (idempotency check)
if grep -q "ngap_build_path_switch_request_ack_transfer" "$NGAP_HANDLER" 2>/dev/null; then
    # Also verify the HTTP 204 is removed
    if ! grep -q "ogs_sbi_send_http_status_no_content.*stream" "$NGAP_HANDLER" 2>/dev/null || \
       ! grep -q "ACTIVATED Is NOT Included" "$NGAP_HANDLER" 2>/dev/null; then
        echo "Fix appears to already be applied, verifying..."
        if grep -q "smf_sbi_send_sm_context_updated_data_n2smbuf" "$NGAP_HANDLER" && \
           grep -q "PATH_SWITCH_REQ_ACK" "$NGAP_HANDLER"; then
            echo "Fix verified - already applied"
            echo "Rebuilding to ensure consistency..."
            ninja -C /app/build 2>/dev/null || true
            ninja -C /app/build install 2>/dev/null || true
            exit 0
        fi
    fi
fi

echo "Applying fix..."

# The vulnerable code in ngap_handle_path_switch_request_transfer function:
# Lines 491-493 in v2.7.0-v2.7.3:
#     } else {
#         /* ACTIVATED Is NOT Included in RESPONSE */
#         ogs_assert(true == ogs_sbi_send_http_status_no_content(stream));
#     }
#
# Should be replaced with:
#     } else {
#         ogs_pkbuf_t *n2smbuf =
#             ngap_build_path_switch_request_ack_transfer(sess);
#         ogs_assert(n2smbuf);
#
#         smf_sbi_send_sm_context_updated_data_n2smbuf(sess, stream,
#             OpenAPI_n2_sm_info_type_PATH_SWITCH_REQ_ACK, n2smbuf);
#     }

# Create a backup
cp "$NGAP_HANDLER" "${NGAP_HANDLER}.bak"

# Use perl for reliable multi-line replacement
# This replaces the vulnerable else block with the fixed version
perl -i -0pe '
s{
    (\}\s+else\s+\{)\s*
    /\*\s*ACTIVATED\s+Is\s+NOT\s+Included\s+in\s+RESPONSE\s*\*/\s*
    ogs_assert\s*\(\s*true\s*==\s*ogs_sbi_send_http_status_no_content\s*\(\s*stream\s*\)\s*\)\s*;
}{$1
        ogs_pkbuf_t *n2smbuf =
            ngap_build_path_switch_request_ack_transfer(sess);
        ogs_assert(n2smbuf);

        smf_sbi_send_sm_context_updated_data_n2smbuf(sess, stream,
            OpenAPI_n2_sm_info_type_PATH_SWITCH_REQ_ACK, n2smbuf);
}xms' "$NGAP_HANDLER"

# Verify the fix was applied
if grep -q "ngap_build_path_switch_request_ack_transfer" "$NGAP_HANDLER" && \
   grep -q "smf_sbi_send_sm_context_updated_data_n2smbuf" "$NGAP_HANDLER" && \
   grep -q "PATH_SWITCH_REQ_ACK" "$NGAP_HANDLER"; then
    echo "Fix applied successfully"
else
    echo "WARNING: Fix may not have been applied correctly"
    echo "Attempting alternative fix method..."

    # Restore backup and try sed-based approach
    cp "${NGAP_HANDLER}.bak" "$NGAP_HANDLER"

    # Use sed to find and replace the specific vulnerable pattern
    # First, find the line number containing the vulnerable pattern
    VULN_LINE=$(grep -n "ogs_sbi_send_http_status_no_content.*stream" "$NGAP_HANDLER" | grep -v "^Binary" | head -1 | cut -d: -f1)

    if [ -n "$VULN_LINE" ]; then
        echo "Found vulnerable code at line $VULN_LINE"

        # Find the comment line (should be one line before)
        COMMENT_LINE=$((VULN_LINE - 1))

        # Create the fixed content
        FIXED_CONTENT='        ogs_pkbuf_t *n2smbuf =
            ngap_build_path_switch_request_ack_transfer(sess);
        ogs_assert(n2smbuf);

        smf_sbi_send_sm_context_updated_data_n2smbuf(sess, stream,
            OpenAPI_n2_sm_info_type_PATH_SWITCH_REQ_ACK, n2smbuf);'

        # Delete the two vulnerable lines and insert fixed code
        sed -i "${COMMENT_LINE},${VULN_LINE}d" "$NGAP_HANDLER"

        # Insert the new code at the correct position
        # We need to insert after line COMMENT_LINE-1
        INSERT_LINE=$((COMMENT_LINE - 1))

        # Use a heredoc with sed
        head -n "$INSERT_LINE" "$NGAP_HANDLER" > "${NGAP_HANDLER}.new"
        cat >> "${NGAP_HANDLER}.new" << 'FIXEOF'
        ogs_pkbuf_t *n2smbuf =
            ngap_build_path_switch_request_ack_transfer(sess);
        ogs_assert(n2smbuf);

        smf_sbi_send_sm_context_updated_data_n2smbuf(sess, stream,
            OpenAPI_n2_sm_info_type_PATH_SWITCH_REQ_ACK, n2smbuf);
FIXEOF
        tail -n +$((INSERT_LINE + 1)) "$NGAP_HANDLER" >> "${NGAP_HANDLER}.new"
        mv "${NGAP_HANDLER}.new" "$NGAP_HANDLER"

        echo "Alternative fix applied"
    else
        echo "ERROR: Could not locate vulnerable code pattern"
        echo "Manual fix may be required"
        exit 1
    fi
fi

# Clean up backup
rm -f "${NGAP_HANDLER}.bak"

# Verify fix one more time
if grep -q "ngap_build_path_switch_request_ack_transfer" "$NGAP_HANDLER"; then
    echo "Fix verification: PASSED"
else
    echo "Fix verification: FAILED"
    exit 1
fi

echo ""
echo "=== Rebuilding Open5GS ==="

# Rebuild the project
cd /app
if [ -d "build" ]; then
    ninja -C build
    ninja -C build install
    echo "Rebuild completed successfully"
else
    echo "WARNING: Build directory not found, skipping rebuild"
fi

echo ""
echo "=== Restarting services ==="

# Kill SMF process if running so it restarts with the fix
pkill -f "open5gs-smfd" 2>/dev/null || true

# Give time for the process to terminate
sleep 2

echo "Fix applied and services restarted"
echo "The SMF will now send proper N2 signaling for PathSwitchRequest even when tunnel parameters are unchanged"
