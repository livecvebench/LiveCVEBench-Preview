<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jehc.djshi.sys.dao.XtMessageDao">
	<!--初始化分页-->
	<select id="getXtMessageListByCondition" resultType="jehc.djshi.sys.model.XtMessage" parameterType="map">
		SELECT
			xt_message.id,
			xt_message.from_id AS fromId,
			xt_message.to_id AS toId,
			xt_message.content,
			xt_message.is_read AS isRead,
			xt_message.read_time AS readTime,
			xt_userinfo.name as fromName,
			xtuserinfo.name as toName
		FROM
			xt_message xt_message LEFT JOIN xt_userinfo xt_userinfo ON xt_userinfo.id = xt_message.from_id
			LEFT JOIN xt_userinfo xtuserinfo ON xtuserinfo.id = xt_message.to_id
		WHERE 1=1
			<if test="null != isRead">
				AND xt_message.is_read = #{isRead}
			</if>
			<if test="null != fromId">
				AND xt_message.from_id = #{fromId}
				AND xt_message.from_delete = 0
			</if>
			<if test="null != toId">
				AND xt_message.to_id = #{toId}
				AND xt_message.to_delete = 0
			</if>
			<if test="null != createTimeSt and createTimeSt != ''">
				AND xt_message.create_time &gt;=#{createTimeSt}
			</if>
			<if test="null != createTimeEt and createTimeEt != ''">
				AND xt_message.create_time &lt;=#{createTimeEt}
			</if>
			<if test="null != readTimeSt and readTimeSt != ''">
				AND xt_message.read_time &gt;=#{readTimeSt}
			</if>
			<if test="null != readTimeEt and readTimeEt != ''">
				AND xt_message.read_time &lt;=#{readTimeEt}
			</if>
			ORDER BY xt_message.create_time ASC
	</select>

	<!--统计-->
	<select id="getXtMessageCountByCondition" resultType="jehc.djshi.sys.model.XtMessage" parameterType="map">
		SELECT
			from_id AS fromId,
			COUNT(0) AS count
		FROM
			xt_message AS xt_message
		WHERE 1=1
			<if test="null != isRead">
				AND is_read = #{isRead}
			</if>
			<if test="null != fromId">
				AND from_id = #{fromId}
			</if>
			<if test="null != toId">
				AND to_id = #{toId}
			</if>
			GROUP BY from_id
	</select>

	<!--查询对象-->
	<select id="getXtMessageById" resultType="jehc.djshi.sys.model.XtMessage" parameterType="string">
		SELECT
			xt_message.id,
			xt_message.from_id AS fromId,
			xt_message.to_id AS toId,
			xt_message.content,
			xt_message.is_read AS isRead,
			xt_message.read_time AS readTime,
			xt_userinfo.name as fromName,
			xtuserinfo.name as toName
		FROM
			xt_message xt_message LEFT JOIN xt_userinfo xt_userinfo ON xt_userinfo.id = xt_message.from_id
								  LEFT JOIN xt_userinfo xtuserinfo ON xtuserinfo.id = xt_message.to_id
		WHERE xt_message.id=#{id}
	</select>

	<!--添加-->
	<insert id="addXtMessage" parameterType="jehc.djshi.sys.model.XtMessage">
		INSERT INTO
			xt_message
		(
			id,
			from_id,
			to_id,
			content,
			is_read,
			create_time,
			create_id,
			read_time,
			from_delete,
			to_delete
		)
		VALUES
		(
			#{id},
			#{fromId},
			#{toId},
			#{content},
			0,
			#{createTime},
			#{createId},
			#{readTime},
			0,
			0
		)
	</insert>

	<!--修改-->
	<update id="updateXtMessage" parameterType="jehc.djshi.sys.model.XtMessage">
		UPDATE
			xt_message
		SET
			from_id = #{fromId},
			to_id = #{toId},
			content = #{content},
			isread = #{isRead},
			update_time = #{updateTime},
			update_id = #{updateId},
			readtime = #{readtime}
		WHERE id=#{id}
	</update>

	<!--删除-->
	<delete id="delXtMessage" parameterType="map">
		<if test="null != type">
			UPDATE xt_message SET
			<if test="type == 1">
				from_delete = 1
			</if>
			<if test="type == 2">
				to_delete = 1
			</if>
			WHERE id IN
			<foreach item="item" index="index" collection="id" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
	</delete>

	<!--批量添加-->
	<insert id="addBatchXtMessage" parameterType="list">
		INSERT INTO
		xt_message
		(
		id,
		from_id,
		to_id,
		content,
		is_read,
		create_time,
		create_id,
		read_time,
		from_delete,
		to_delete
		)
		VALUES
		<foreach collection="list" item="item" index="index" separator=",">
			(
			#{item.id},
			#{item.from_id},
			#{item.to_id},
			#{item.content},
			0,
			#{item.createTime},
			#{item.createId},
			#{item.readTime},
			0,
			0
			)
		</foreach>
	</insert>

	<!--批量修改-->
	<update id="updateBatchXtMessage" parameterType="list">
		<foreach collection="list" item="item" index="index" open="" close="" separator=";">
			UPDATE
			xt_message
			SET
			from_id = #{item.fromId},
			to_id = #{item.toId},
			content = #{item.content},
			isread = #{item.isRead},
			readtime = #{item.readTime}
			WHERE id=#{item.id}
		</foreach>
	</update>

	<!-- 更新已读状态 -->
	<update id="updateRead" parameterType="map">
		UPDATE
			xt_message
		SET
			isread = #{isRead},
			readtime = #{readTime}
		WHERE id = #{id}
	</update>
</mapper>