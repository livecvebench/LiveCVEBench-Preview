#!/bin/bash
set -e
cd /var/www/html

CONTROLLER_FILE="vendor/craftcms/cms/src/controllers/UpdaterController.php"

echo "Applying path validation fix to UpdaterController.php..."

# Step 1: Add the FileHelper import after the App import
if ! grep -q 'use craft\\helpers\\FileHelper;' "$CONTROLLER_FILE"; then
    sed -i 's/use craft\\helpers\\App;/use craft\\helpers\\App;\nuse craft\\helpers\\FileHelper;/' "$CONTROLLER_FILE"
    echo "Added FileHelper import"
else
    echo "FileHelper import already exists"
fi

# Step 2: Replace the actionRestoreDb method with the fixed version
php << 'PHPSCRIPT'
<?php
$file = '/var/www/html/vendor/craftcms/cms/src/controllers/UpdaterController.php';
$content = file_get_contents($file);

// Check if fix is already applied
if (strpos($content, 'FileHelper::isWithin($backupPath') !== false) {
    echo "Fix already applied\n";
    exit(0);
}

// Pattern to match the vulnerable actionRestoreDb method start
$vulnerable_pattern = '/public function actionRestoreDb\(\): Response\s*\{\s*try \{\s*Craft::\$app->getDb\(\)->restore\(\$this->data\[\'dbBackupPath\'\]\);/s';

$fixed_code = 'public function actionRestoreDb(): Response
    {
        $backupPath = $this->data[\'dbBackupPath\'];
        if (!file_exists($backupPath) || !FileHelper::isWithin($backupPath, Craft::$app->getPath()->getDbBackupPath())) {
            throw new BadRequestHttpException("Invalid backup path: $backupPath");
        }

        try {
            Craft::$app->getDb()->restore($backupPath);';

if (preg_match($vulnerable_pattern, $content)) {
    $content = preg_replace($vulnerable_pattern, $fixed_code, $content);
    file_put_contents($file, $content);
    echo "Fix applied successfully\n";
} else {
    echo "Could not find vulnerable pattern - file may already be fixed or has unexpected format\n";
    // Try alternative approach
    if (strpos($content, 'Craft::$app->getDb()->restore($this->data[\'dbBackupPath\'])') !== false) {
        echo "Found alternative vulnerable pattern, applying fix...\n";

        $old_restore = 'Craft::$app->getDb()->restore($this->data[\'dbBackupPath\'])';
        $new_restore = 'Craft::$app->getDb()->restore($backupPath)';
        $content = str_replace($old_restore, $new_restore, $content);

        $method_start = '/public function actionRestoreDb\(\): Response\s*\{\s*try \{/s';
        $with_validation = 'public function actionRestoreDb(): Response
    {
        $backupPath = $this->data[\'dbBackupPath\'];
        if (!file_exists($backupPath) || !FileHelper::isWithin($backupPath, Craft::$app->getPath()->getDbBackupPath())) {
            throw new BadRequestHttpException("Invalid backup path: $backupPath");
        }

        try {';

        $content = preg_replace($method_start, $with_validation, $content);
        file_put_contents($file, $content);
        echo "Alternative fix applied\n";
    }
}
?>
PHPSCRIPT

# Verify the fix was applied
echo "Verifying fix..."
if grep -q 'FileHelper::isWithin' "$CONTROLLER_FILE" && grep -q 'file_exists' "$CONTROLLER_FILE"; then
    echo "Fix verified - path validation is now in place"
else
    echo "Warning: Fix verification failed"
    exit 1
fi

# Verify PHP syntax
php -l "$CONTROLLER_FILE"

# Restart Apache to pick up the changes
# Using apache2ctl graceful for graceful restart (no container shutdown)
echo "Restarting Apache gracefully..."
apache2ctl graceful || apachectl graceful || service apache2 reload || true

echo "Fix applied and service restarted successfully"
