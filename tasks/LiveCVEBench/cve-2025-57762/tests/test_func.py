"""
Functional tests for WeGIA document type management.
These tests verify that the application works correctly for normal use cases.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import hashlib
import time
import re
import json


BASE_URL = "http://localhost"
ADMIN_USER = "admin"
ADMIN_PASSWORD = "wegia"


class WeGIAClient:
    """Client helper for WeGIA authentication and requests"""

    def __init__(self, base_url=BASE_URL):
        self.base_url = base_url
        self.session = requests.Session()
        self.authenticated = False

    def login(self, username=ADMIN_USER, password=ADMIN_PASSWORD):
        """Authenticate with WeGIA and return session"""
        # WeGIA uses SHA-256 hash for password verification in the database
        # but the login form sends the plain password which gets hashed server-side
        login_url = f"{self.base_url}/html/login.php"

        # Try login with plain password
        response = self.session.post(login_url, data={
            "cpf": username,
            "pwd": password
        }, allow_redirects=False)

        # Check for successful login (redirect or session set)
        if response.status_code in [200, 302]:
            # Verify we have a session by checking a protected page
            check_response = self.session.get(
                f"{self.base_url}/html/funcionario/dependente_docdependente.php?action=adicionar",
                allow_redirects=False
            )
            if check_response.status_code != 302:  # Not redirected to login
                self.authenticated = True
                return True

        return False

    def add_document_type(self, name):
        """Add a new document type and return response"""
        url = f"{self.base_url}/html/funcionario/dependente_docdependente.php"
        response = self.session.post(url, data={
            "action": "adicionar",
            "nome": name
        })
        return response

    def get_document_types(self):
        """Get list of document types from profile page"""
        url = f"{self.base_url}/html/funcionario/profile_dependente.php"
        response = self.session.get(url, params={"id_dependente": "1"})
        return response


@pytest.fixture(scope="module")
def client():
    """Create authenticated WeGIA client"""
    c = WeGIAClient()
    # Wait for service to be ready
    max_retries = 30
    for i in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302]:
                break
        except requests.exceptions.ConnectionError:
            if i < max_retries - 1:
                time.sleep(2)
            continue

    # Attempt login
    if not c.login():
        pytest.skip("Could not authenticate with WeGIA")

    return c


class TestDocumentTypeCreation:
    """Test normal document type creation functionality"""

    def test_create_simple_document_type(self, client):
        """Test creating a document type with a simple name"""
        doc_name = f"TestDocument_{int(time.time())}"
        response = client.add_document_type(doc_name)

        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

        # Response should be JSON array
        try:
            data = response.json()
            assert isinstance(data, list), "Response should be a list"
        except json.JSONDecodeError:
            # Check if it's an error response
            assert "erro" not in response.text.lower(), f"Error in response: {response.text}"

    def test_create_document_type_with_spaces(self, client):
        """Test creating a document type with spaces"""
        doc_name = f"Birth Certificate {int(time.time())}"
        response = client.add_document_type(doc_name)

        assert response.status_code == 200

        try:
            data = response.json()
            assert isinstance(data, list)
            # Check if our document name appears in the response
            found = any(doc_name in str(item) or "Birth Certificate" in str(item)
                       for item in data)
            # Note: with sanitization, special chars may be encoded but that's OK
        except json.JSONDecodeError:
            pass  # May be OK if server returns different format

    def test_create_document_type_with_accents(self, client):
        """Test creating a document type with accented characters"""
        doc_name = f"CertidÃ£o de Nascimento {int(time.time())}"
        response = client.add_document_type(doc_name)

        assert response.status_code == 200

    def test_create_document_type_with_numbers(self, client):
        """Test creating a document type with numbers"""
        doc_name = f"Document Type 123 - {int(time.time())}"
        response = client.add_document_type(doc_name)

        assert response.status_code == 200


class TestDocumentTypeRetrieval:
    """Test document type display functionality"""

    def test_profile_page_loads(self, client):
        """Test that profile page loads without error"""
        response = client.get_document_types()

        # Page should load (may return 200 or other success code)
        assert response.status_code in [200, 302, 400], \
            f"Unexpected status: {response.status_code}"

    def test_add_and_retrieve_document_type(self, client):
        """Test adding a document type and verifying it appears"""
        doc_name = f"RetrievalTest_{int(time.time())}"

        # Add document type
        add_response = client.add_document_type(doc_name)
        assert add_response.status_code == 200

        # Verify it's in the response
        try:
            data = add_response.json()
            assert isinstance(data, list)
            # The newly added type should appear in the list
            assert len(data) > 0, "Document type list should not be empty"
        except json.JSONDecodeError:
            pass  # May have different format


class TestInputValidation:
    """Test input validation for document types"""

    def test_empty_name_handling(self, client):
        """Test that empty names are handled appropriately"""
        response = client.add_document_type("")

        # Empty name should either:
        # 1. Return 400 error (fixed version)
        # 2. Return 200 with data (vulnerable version)
        assert response.status_code in [200, 400]

    def test_whitespace_only_name(self, client):
        """Test that whitespace-only names are handled"""
        response = client.add_document_type("   ")

        # Should be handled gracefully
        assert response.status_code in [200, 400]

    def test_long_document_name(self, client):
        """Test handling of very long document names"""
        long_name = "A" * 255
        response = client.add_document_type(long_name)

        # Should not crash
        assert response.status_code in [200, 400, 500]


class TestEndpointAvailability:
    """Test that required endpoints are available"""

    def test_document_endpoint_exists(self, client):
        """Test that document management endpoint exists"""
        response = client.session.get(
            f"{BASE_URL}/html/funcionario/dependente_docdependente.php"
        )
        # Should not be 404
        assert response.status_code != 404

    def test_profile_endpoint_exists(self, client):
        """Test that profile endpoint exists"""
        response = client.session.get(
            f"{BASE_URL}/html/funcionario/profile_dependente.php"
        )
        # Should not be 404
        assert response.status_code != 404
