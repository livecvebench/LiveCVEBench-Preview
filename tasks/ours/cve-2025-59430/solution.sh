#!/bin/bash
set -e
cd /app

echo "Applying protocol validation fix to Link.ts..."

LINK_FILE="/app/packages/link/src/Link.ts"

# Check if the fix is already applied
if grep -q "isProtocolValid" "$LINK_FILE"; then
    echo "Fix already applied, skipping..."
    exit 0
fi

# Use Python for reliable multi-line insertion
python3 << 'PYTHON_SCRIPT'
import re

link_file = '/app/packages/link/src/Link.ts'

with open(link_file, 'r') as f:
    content = f.read()

# The fix to insert after "let linkUrl = window.atob(linkToken)"
fix_code = '''
    const isProtocolValid =
      linkUrl.startsWith('http://') || linkUrl.startsWith('https://')
    if (!isProtocolValid) {
      options?.onExit?.('Invalid link token!')
      return
    }'''

# Find the line with atob and add the fix after it
old_pattern = r"(let linkUrl = window\.atob\(linkToken\))"
new_code = r"\1" + fix_code

new_content = re.sub(old_pattern, new_code, content)

# Verify the substitution worked
if 'isProtocolValid' in new_content:
    with open(link_file, 'w') as f:
        f.write(new_content)
    print("Fix applied successfully!")
else:
    print("ERROR: Failed to apply fix - pattern not found")
    exit(1)
PYTHON_SCRIPT

# Verify the fix was applied
if grep -q "isProtocolValid" "$LINK_FILE"; then
    echo "Verification: Protocol validation code found in Link.ts"
else
    echo "ERROR: Fix verification failed!"
    exit 1
fi

echo "Solution applied successfully!"
