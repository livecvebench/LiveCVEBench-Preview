"""
Functional tests for Kanboard authentication system.
These tests verify basic authentication functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import re
import time
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")

# Default credentials for Kanboard
VALID_USERNAME = "admin"
VALID_PASSWORD = "admin"
INVALID_PASSWORD = "wrongpassword12345"


class TestSession:
    """Manage session state for tests"""

    @staticmethod
    def get_session():
        return requests.Session()

    @staticmethod
    def get_csrf_token(session):
        """Extract CSRF token from login page"""
        response = session.get(f"{BASE_URL}/?controller=AuthController&action=login")
        match = re.search(r'name="csrf_token"\s+value="([^"]+)"', response.text)
        if match:
            return match.group(1)
        # Alternative pattern
        match = re.search(r'csrf_token["\']:\s*["\']([^"\']+)', response.text)
        if match:
            return match.group(1)
        return ""


class TestBasicAuthentication:
    """Test basic login/logout functionality"""

    def test_login_page_accessible(self):
        """Login page should be accessible"""
        response = requests.get(f"{BASE_URL}/?controller=AuthController&action=login")
        assert response.status_code == 200
        assert "username" in response.text.lower() or "login" in response.text.lower()

    def test_valid_login_success(self):
        """Valid credentials should result in successful login"""
        session = TestSession.get_session()
        csrf_token = TestSession.get_csrf_token(session)

        response = session.post(
            f"{BASE_URL}/?controller=AuthController&action=check",
            data={
                "username": VALID_USERNAME,
                "password": VALID_PASSWORD,
                "csrf_token": csrf_token
            },
            allow_redirects=True
        )

        # After successful login, should be redirected to dashboard or main page
        # Check for successful login indicators
        assert response.status_code == 200
        # Should NOT see login form error or the login page itself after successful login
        assert "Bad username or password" not in response.text

    def test_invalid_password_fails(self):
        """Invalid password should fail with generic error"""
        session = TestSession.get_session()
        csrf_token = TestSession.get_csrf_token(session)

        response = session.post(
            f"{BASE_URL}/?controller=AuthController&action=check",
            data={
                "username": VALID_USERNAME,
                "password": INVALID_PASSWORD,
                "csrf_token": csrf_token
            },
            allow_redirects=True
        )

        assert response.status_code == 200
        # Should see error message
        assert "Bad username or password" in response.text or "password" in response.text.lower()

    def test_empty_username_rejected(self):
        """Empty username should be rejected"""
        session = TestSession.get_session()
        csrf_token = TestSession.get_csrf_token(session)

        response = session.post(
            f"{BASE_URL}/?controller=AuthController&action=check",
            data={
                "username": "",
                "password": "somepassword",
                "csrf_token": csrf_token
            },
            allow_redirects=True
        )

        assert response.status_code == 200
        # Should see validation error
        assert "required" in response.text.lower() or "username" in response.text.lower()

    def test_empty_password_rejected(self):
        """Empty password should be rejected"""
        session = TestSession.get_session()
        csrf_token = TestSession.get_csrf_token(session)

        response = session.post(
            f"{BASE_URL}/?controller=AuthController&action=check",
            data={
                "username": VALID_USERNAME,
                "password": "",
                "csrf_token": csrf_token
            },
            allow_redirects=True
        )

        assert response.status_code == 200
        # Should see validation error
        assert "required" in response.text.lower() or "password" in response.text.lower()


class TestCaptchaFunctionality:
    """Test CAPTCHA appears after multiple failed attempts"""

    def test_captcha_appears_after_failed_attempts(self):
        """CAPTCHA should appear after 3 failed login attempts"""
        session = TestSession.get_session()

        # Make 3 failed attempts
        for i in range(3):
            csrf_token = TestSession.get_csrf_token(session)
            response = session.post(
                f"{BASE_URL}/?controller=AuthController&action=check",
                data={
                    "username": VALID_USERNAME,
                    "password": f"wrongpassword_{i}",
                    "csrf_token": csrf_token
                },
                allow_redirects=True
            )
            time.sleep(0.2)  # Small delay between attempts

        # After 3 failures, the page should show CAPTCHA
        # Check for CAPTCHA indicators in the response
        has_captcha = (
            'captcha' in response.text.lower() or
            'data:image' in response.text or  # Base64 encoded CAPTCHA image
            'name="captcha"' in response.text
        )

        assert has_captcha, "CAPTCHA should appear after 3 failed login attempts"


class TestLoginFormElements:
    """Test login form contains required elements"""

    def test_login_form_has_csrf_token(self):
        """Login form should include CSRF token"""
        session = TestSession.get_session()
        response = session.get(f"{BASE_URL}/?controller=AuthController&action=login")

        assert "csrf_token" in response.text

    def test_login_form_has_username_field(self):
        """Login form should have username field"""
        response = requests.get(f"{BASE_URL}/?controller=AuthController&action=login")

        assert 'name="username"' in response.text or 'id="username"' in response.text

    def test_login_form_has_password_field(self):
        """Login form should have password field"""
        response = requests.get(f"{BASE_URL}/?controller=AuthController&action=login")

        assert 'name="password"' in response.text or 'id="password"' in response.text


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-rA"])
