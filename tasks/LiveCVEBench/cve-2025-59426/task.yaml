instruction: |-
  Lobe Chat is an open-source AI chat framework that supports SSO/OIDC authentication.
  The application can run behind a reverse proxy and uses X-Forwarded-Host and
  X-Forwarded-Proto headers to correctly construct redirect URLs for authentication flows.

  We've discovered that the OIDC callback handler improperly handles the redirect URL
  construction. When processing authentication callbacks, the handler uses the
  X-Forwarded-Host header value to determine the redirect destination without any
  validation. This means if a client sends a crafted X-Forwarded-Host header with an
  arbitrary domain, the application constructs a redirect URL pointing to that domain.

  For example, when accessing the OIDC callback endpoint with:
    X-Forwarded-Host: untrusted-domain.com

  The application redirects the user to https://untrusted-domain.com/oauth/callback/success
  instead of keeping them on the legitimate application domain.

  Expected behavior: The redirect URL handler should validate that the target host
  matches the configured application domain (APP_URL environment variable) or is a
  trusted subdomain. Requests with untrusted X-Forwarded-Host values should not
  modify the redirect destination.

difficulty: medium
category: security
tags:
  - typescript
  - nextjs
  - oidc
  - authentication
  - url-validation
parser_name: pytest
run_tests_in_same_shell: false
