"""
Vulnerability tests for mruby Array __fill_exec.

These tests verify that the vulnerability has been FIXED:
- FAIL in vulnerable state (crash or no validation)
- PASS in fixed state (ArgumentError raised)
"""

import subprocess
import pytest
import signal


MRUBY_BIN = "/app/bin/mruby"


def run_mruby_code(code: str, timeout: int = 10) -> subprocess.CompletedProcess:
    """Execute mruby code and return the result."""
    test_file = "/tmp/test_vuln.rb"
    with open(test_file, "w") as f:
        f.write(code)

    result = subprocess.run(
        [MRUBY_BIN, test_file],
        capture_output=True,
        timeout=timeout
    )
    return result


class TestNegativeStartValidation:
    """Test that negative start index is properly rejected."""

    def test_negative_start_raises_error(self):
        """
        Test that calling __fill_exec with negative start raises ArgumentError.

        PASS: ArgumentError with "negative" message (fixed)
        FAIL: Crash or no error (vulnerable)
        """
        code = '''
begin
  a = Array.new(20, 0)
  a.__fill_exec(-100000000000, 10, nil)
  puts "NO_ERROR"
rescue ArgumentError => e
  if e.message.include?("negative")
    puts "ARGUMENT_ERROR_OK"
  else
    puts "WRONG_ERROR: #{e.message}"
  end
rescue => e
  puts "OTHER_ERROR: #{e.class}: #{e.message}"
end
'''
        result = run_mruby_code(code)
        stdout = result.stdout.decode("utf-8", errors="ignore")
        stderr = result.stderr.decode("utf-8", errors="ignore")

        # PASS: Fixed version raises ArgumentError
        assert "ARGUMENT_ERROR_OK" in stdout, (
            f"VULNERABLE: Expected ArgumentError for negative start, but got: "
            f"returncode={result.returncode}, stdout={stdout}, stderr={stderr}"
        )


class TestNegativeLengthValidation:
    """Test that negative length is properly rejected."""

    def test_negative_length_raises_error(self):
        """
        Test that calling __fill_exec with negative length raises ArgumentError.

        PASS: ArgumentError with "negative" message (fixed)
        FAIL: Crash or no error (vulnerable)
        """
        code = '''
begin
  a = Array.new(20, 0)
  a.__fill_exec(0, -10, nil)
  puts "NO_ERROR"
rescue ArgumentError => e
  if e.message.include?("negative")
    puts "ARGUMENT_ERROR_OK"
  else
    puts "WRONG_ERROR: #{e.message}"
  end
rescue => e
  puts "OTHER_ERROR: #{e.class}: #{e.message}"
end
'''
        result = run_mruby_code(code)
        stdout = result.stdout.decode("utf-8", errors="ignore")
        stderr = result.stderr.decode("utf-8", errors="ignore")

        # PASS: Fixed version raises ArgumentError
        assert "ARGUMENT_ERROR_OK" in stdout, (
            f"VULNERABLE: Expected ArgumentError for negative length, but got: "
            f"returncode={result.returncode}, stdout={stdout}, stderr={stderr}"
        )


class TestNegativeStartCrash:
    """Test that negative start with large magnitude causes crash in vulnerable version."""

    def test_negative_start_causes_crash(self):
        """
        Test that a large negative start value triggers memory corruption.

        PASS: ArgumentError raised (fixed)
        FAIL: Crash (SIGSEGV/SIGABRT) or silent acceptance (vulnerable)
        """
        code = '''
begin
  a = Array.new(20, 0)
  a.__fill_exec(-100000000, 100, nil)
  puts "NO_ERROR"
rescue ArgumentError => e
  if e.message.include?("negative")
    puts "ARGUMENT_ERROR_OK"
  else
    puts "WRONG_ERROR: #{e.message}"
  end
rescue => e
  puts "OTHER_ERROR: #{e.class}: #{e.message}"
end
'''
        result = run_mruby_code(code)
        stdout = result.stdout.decode("utf-8", errors="ignore")
        stderr = result.stderr.decode("utf-8", errors="ignore")

        # PASS: Fixed version raises ArgumentError
        assert "ARGUMENT_ERROR_OK" in stdout, (
            f"VULNERABLE: Expected ArgumentError for negative start, but got: "
            f"returncode={result.returncode}, stdout={stdout}, stderr={stderr}"
        )


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
