#!/usr/bin/env python3
"""
Functional tests for ImageMagick MNG processing.
These tests verify that ImageMagick works correctly for normal operations.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import tempfile
import pytest


class TestBasicImageOperations:
    """Test basic ImageMagick functionality."""

    def test_imagemagick_installed(self):
        """Verify ImageMagick is installed and accessible."""
        result = subprocess.run(
            ['magick', '-version'],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, "ImageMagick should be installed"
        assert 'ImageMagick' in result.stdout, "Should show ImageMagick version"

    def test_create_simple_image(self):
        """Test creating a simple image with ImageMagick."""
        with tempfile.TemporaryDirectory() as tmpdir:
            output_path = os.path.join(tmpdir, 'test.png')
            result = subprocess.run(
                ['magick', '-size', '100x100', 'xc:red', output_path],
                capture_output=True,
                text=True
            )
            assert result.returncode == 0, f"Should create image: {result.stderr}"
            assert os.path.exists(output_path), "Output file should exist"

    def test_resize_image(self):
        """Test resizing an image."""
        with tempfile.TemporaryDirectory() as tmpdir:
            input_path = os.path.join(tmpdir, 'input.png')
            output_path = os.path.join(tmpdir, 'output.png')

            # Create input image
            subprocess.run(
                ['magick', '-size', '200x200', 'xc:blue', input_path],
                check=True
            )

            # Resize
            result = subprocess.run(
                ['magick', input_path, '-resize', '100x100', output_path],
                capture_output=True,
                text=True
            )
            assert result.returncode == 0, f"Should resize: {result.stderr}"
            assert os.path.exists(output_path), "Output should exist"

    def test_image_with_alpha_channel(self):
        """Test creating and processing images with alpha channels."""
        with tempfile.TemporaryDirectory() as tmpdir:
            input_path = os.path.join(tmpdir, 'alpha.png')
            output_path = os.path.join(tmpdir, 'output.png')

            # Create image with alpha channel
            subprocess.run(
                ['magick', '-size', '100x100', 'xc:transparent',
                 '-fill', 'red', '-draw', 'circle 50,50 50,10', input_path],
                check=True
            )

            # Process the image
            result = subprocess.run(
                ['magick', input_path, '-resize', '50x50', output_path],
                capture_output=True,
                text=True
            )
            assert result.returncode == 0, f"Should handle alpha: {result.stderr}"


class TestMNGFormatSupport:
    """Test MNG format support in ImageMagick."""

    def test_mng_format_recognized(self):
        """Verify MNG format is supported."""
        result = subprocess.run(
            ['magick', '-list', 'format'],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0
        # MNG support depends on libpng being compiled with MNG support
        # This is informational - may or may not be present
        output_lower = result.stdout.lower()
        if 'mng' in output_lower:
            print("MNG format is supported")
        else:
            print("MNG format may not be fully supported in this build")

    def test_basic_mng_creation(self):
        """Test creating a simple animation-like sequence."""
        with tempfile.TemporaryDirectory() as tmpdir:
            # Create individual frames
            for i in range(3):
                frame_path = os.path.join(tmpdir, f'frame{i}.png')
                color = ['red', 'green', 'blue'][i]
                subprocess.run(
                    ['magick', '-size', '50x50', f'xc:{color}', frame_path],
                    check=True
                )

            # This tests basic multi-image handling
            output_path = os.path.join(tmpdir, 'output.gif')
            result = subprocess.run(
                ['magick', os.path.join(tmpdir, 'frame*.png'), output_path],
                capture_output=True,
                text=True,
                shell=False
            )
            # GIF output as alternative test since MNG may not be writable
            assert result.returncode == 0 or 'delegate' in result.stderr.lower()


class TestImageConversion:
    """Test various image conversion scenarios."""

    def test_png_to_jpg_conversion(self):
        """Test PNG to JPEG conversion."""
        with tempfile.TemporaryDirectory() as tmpdir:
            png_path = os.path.join(tmpdir, 'test.png')
            jpg_path = os.path.join(tmpdir, 'test.jpg')

            subprocess.run(
                ['magick', '-size', '100x100', 'xc:green', png_path],
                check=True
            )

            result = subprocess.run(
                ['magick', png_path, jpg_path],
                capture_output=True,
                text=True
            )
            assert result.returncode == 0
            assert os.path.exists(jpg_path)

    def test_identify_command(self):
        """Test the identify command for image info."""
        with tempfile.TemporaryDirectory() as tmpdir:
            img_path = os.path.join(tmpdir, 'test.png')
            subprocess.run(
                ['magick', '-size', '100x100', 'xc:white', img_path],
                check=True
            )

            result = subprocess.run(
                ['magick', 'identify', img_path],
                capture_output=True,
                text=True
            )
            assert result.returncode == 0
            assert '100x100' in result.stdout

    def test_magnify_operation(self):
        """Test magnification operation on images."""
        with tempfile.TemporaryDirectory() as tmpdir:
            input_path = os.path.join(tmpdir, 'small.png')
            output_path = os.path.join(tmpdir, 'magnified.png')

            # Create small input
            subprocess.run(
                ['magick', '-size', '10x10', 'xc:purple', input_path],
                check=True
            )

            # Magnify
            result = subprocess.run(
                ['magick', input_path, '-magnify', output_path],
                capture_output=True,
                text=True
            )
            assert result.returncode == 0, f"Magnify should work: {result.stderr}"
            assert os.path.exists(output_path)


class TestErrorHandling:
    """Test error handling for invalid inputs."""

    def test_nonexistent_file_error(self):
        """Test handling of non-existent input file."""
        result = subprocess.run(
            ['magick', '/nonexistent/path/image.png', 'output.png'],
            capture_output=True,
            text=True
        )
        # Should fail gracefully
        assert result.returncode != 0

    def test_invalid_format_handling(self):
        """Test handling of invalid image data."""
        with tempfile.TemporaryDirectory() as tmpdir:
            invalid_path = os.path.join(tmpdir, 'invalid.png')
            # Create an invalid "image" file
            with open(invalid_path, 'wb') as f:
                f.write(b'not a real image file')

            result = subprocess.run(
                ['magick', invalid_path, os.path.join(tmpdir, 'output.png')],
                capture_output=True,
                text=True
            )
            # Should fail but not crash
            assert result.returncode != 0 or 'error' in result.stderr.lower()


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
