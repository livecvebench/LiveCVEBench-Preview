#!/bin/bash
set -e

# Solution script to fix the access control issue in FreshRSS
# This adds authentication checks to three vulnerable endpoints

FRESHRSS_DIR="/var/www/FreshRSS"
JS_CONTROLLER="${FRESHRSS_DIR}/app/Controllers/javascriptController.php"
TAG_CONTROLLER="${FRESHRSS_DIR}/app/Controllers/tagController.php"

echo "Applying access control fixes to FreshRSS..."

# Create backup files
cp "$JS_CONTROLLER" "${JS_CONTROLLER}.bak"
cp "$TAG_CONTROLLER" "${TAG_CONTROLLER}.bak"

# Use PHP to apply the fix reliably
php << 'PHPFIX'
<?php
// Fix 1 & 2: Add access control to javascriptController.php
$js_file = '/var/www/FreshRSS/app/Controllers/javascriptController.php';
$content = file_get_contents($js_file);

// Check if already fixed
if (strpos($content, 'FreshRSS_Auth::hasAccess()') !== false &&
    strpos($content, 'actualizeAction') !== false &&
    strpos($content, 'Minz_Error::error') !== false) {
    echo "Already fixed, skipping...\n";
    exit(0);
}

// Fix actualizeAction - use FreshRSS's native error handling
$pattern1 = '/(public\s+function\s+actualizeAction\s*\(\s*\)\s*:\s*void\s*\{)(\s*)/';
$replacement1 = '$1$2
		if (!FreshRSS_Auth::hasAccess() && !(FreshRSS_Context::systemConf()->allow_anonymous && FreshRSS_Context::systemConf()->allow_anonymous_refresh)) {
			Minz_Error::error(403, array(), false);
			return;
		}$2';

if (preg_match($pattern1, $content)) {
    $content = preg_replace($pattern1, $replacement1, $content, 1);
    echo "Fixed actualizeAction()\n";
} else {
    echo "Pattern for actualizeAction not found\n";
}

// Fix nbUnreadsPerFeedAction
$pattern2 = '/(public\s+function\s+nbUnreadsPerFeedAction\s*\(\s*\)\s*:\s*void\s*\{)(\s*)/';
$replacement2 = '$1$2
		if (!FreshRSS_Auth::hasAccess() && !FreshRSS_Context::systemConf()->allow_anonymous) {
			Minz_Error::error(403, array(), false);
			return;
		}$2';

if (preg_match($pattern2, $content)) {
    $content = preg_replace($pattern2, $replacement2, $content, 1);
    echo "Fixed nbUnreadsPerFeedAction()\n";
} else {
    echo "Pattern for nbUnreadsPerFeedAction not found\n";
}

file_put_contents($js_file, $content);

// Fix 3: Add access control to tagController.php
$tag_file = '/var/www/FreshRSS/app/Controllers/tagController.php';
$tag_content = file_get_contents($tag_file);

$pattern3 = '/(public\s+function\s+updateAction\s*\(\s*\)\s*:\s*void\s*\{)(\s*)/';
$replacement3 = '$1$2
		if (!FreshRSS_Auth::hasAccess()) {
			Minz_Error::error(403, array(), false);
			return;
		}$2';

if (preg_match($pattern3, $tag_content)) {
    $tag_content = preg_replace($pattern3, $replacement3, $tag_content, 1);
    echo "Fixed updateAction() in tagController\n";
} else {
    echo "Pattern for updateAction not found in tagController\n";
}

file_put_contents($tag_file, $tag_content);
echo "\nFix applied successfully!\n";
?>
PHPFIX

# Verify the fixes
echo ""
echo "Verifying fixes..."
if grep -q "Minz_Error::error(403" "$JS_CONTROLLER"; then
    echo "✓ javascriptController.php has access control checks"
else
    echo "✗ Warning: Access control check not found in javascriptController.php"
fi

if grep -q "Minz_Error::error(403" "$TAG_CONTROLLER"; then
    echo "✓ tagController.php has access control check"
else
    echo "✗ Warning: Access control check not found in tagController.php"
fi

# Check PHP syntax
echo ""
echo "Checking PHP syntax..."
php -l "$JS_CONTROLLER" 2>&1 || { echo "PHP syntax error in javascriptController!"; exit 1; }
php -l "$TAG_CONTROLLER" 2>&1 || { echo "PHP syntax error in tagController!"; exit 1; }

echo ""
echo "Fix completed!"
