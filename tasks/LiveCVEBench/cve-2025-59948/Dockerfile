FROM debian:12-slim

ENV TZ=UTC
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ARG DEBIAN_FRONTEND=noninteractive

# System dependencies required for tb framework
RUN apt-get update && \
    apt-get install --no-install-recommends -y \
    tmux asciinema gcc g++ wget curl git \
    ca-certificates cron \
    apache2 libapache2-mod-php \
    php-curl php-gmp php-intl php-mbstring php-xml php-zip \
    php-sqlite3 && \
    rm -rf /var/lib/apt/lists/*

# Create working directory
RUN mkdir -p /var/www/FreshRSS/ /run/apache2/
WORKDIR /var/www/FreshRSS

# Clone vulnerable version and remove git history
RUN git clone --depth 1 --branch 1.26.3 https://github.com/FreshRSS/FreshRSS.git . && \
    rm -rf .git

# Copy Apache configuration
COPY task-deps/FreshRSS.Apache.conf /etc/apache2/sites-available/FreshRSS.conf

# Configure Apache modules
RUN a2dismod -q -f alias autoindex negotiation status 2>/dev/null || true && \
    a2enmod -q deflate expires filter headers mime remoteip setenvif rewrite && \
    a2disconf -q '*' 2>/dev/null || true && \
    a2dissite -q '*' 2>/dev/null || true && \
    a2ensite -q FreshRSS

# Modify Apache configuration
RUN sed -r -i "/^\s*(CustomLog|ErrorLog|Listen) /s/^/#/" /etc/apache2/apache2.conf && \
    sed -r -i "/^\s*Listen /s/^/#/" /etc/apache2/ports.conf && \
    sed -r -i "\\#disable_update#s#^.*#\t'disable_update' => true,#" ./config.default.php && \
    touch /var/www/FreshRSS/Docker/env.txt && \
    echo "7,37 * * * * . /var/www/FreshRSS/Docker/env.txt; \
        su www-data -s /bin/sh -c 'php /var/www/FreshRSS/app/actualize_script.php' \
        2>> /proc/1/fd/2 > /tmp/FreshRSS.log" > /etc/crontab.freshrss.default

# Set environment variables
ENV COPY_LOG_TO_SYSLOG=On
ENV COPY_SYSLOG_TO_STDERR=On
ENV CRON_MIN=''
ENV DATA_PATH=''
ENV FRESHRSS_ENV=development
ENV LISTEN=''
ENV OIDC_ENABLED=''
ENV TRUSTED_PROXY=''

# Set permissions
RUN chown -R www-data:www-data /var/www/FreshRSS/data && \
    chmod +x ./Docker/entrypoint.sh && \
    chmod +x ./cli/*.sh 2>/dev/null || true

EXPOSE 80

# Entrypoint and CMD (handled by docker-compose command)
# ENTRYPOINT ["./Docker/entrypoint.sh"]
# CMD ["sh", "-c", "([ -z \"$CRON_MIN\" ] || cron) && . /etc/apache2/envvars && exec apache2 -D FOREGROUND"]
