#!/bin/bash
# Solution for CVE-2025-8671: H2O HTTP/2 MadeYouReset DoS vulnerability
#
# The vulnerability: Server-initiated RST_STREAM (due to protocol violations)
# does not decrement reset_budget, allowing unlimited DoS attacks.
#
# The fix:
# 1. Add reset_by_peer_action field to track server-initiated resets
# 2. Decrement budget when reset_by_peer_action is set
# 3. Add dos_delay timer setup after budget decrement
# 4. Set the flag in error handlers before calling h2o_http2_stream_reset

set -e
cd /app

HEADER_FILE="include/h2o/http2_internal.h"
CONN_FILE="lib/http2/connection.c"

echo "[INFO] Applying CVE-2025-8671 fix..."

# ==============================================================================
# STEP 1: Add reset_by_peer_action field to header
# ==============================================================================
if ! grep -q "reset_by_peer_action" "$HEADER_FILE"; then
    echo "[+] Adding reset_by_peer_action field..."
    sed -i '/unsigned reset_by_peer : 1;/a\    unsigned reset_by_peer_action : 1;' "$HEADER_FILE"
fi

# ==============================================================================
# STEP 2: Update reset budget condition in unregister_stream
# ==============================================================================
if ! grep -q "reset_by_peer || stream->reset_by_peer_action" "$CONN_FILE"; then
    echo "[+] Updating budget condition..."
    sed -i 's/if (stream->reset_by_peer) {/if (stream->reset_by_peer || stream->reset_by_peer_action) {/' "$CONN_FILE"
fi

# ==============================================================================
# STEP 3: Add dos_delay timer after budget decrement
# ==============================================================================
if ! grep -A5 "dos_mitigation.reset_budget > 0" "$CONN_FILE" | grep -q "budget == 0"; then
    echo "[+] Adding dos_delay timer after budget decrement..."
    # Insert after the line with --conn->dos_mitigation.reset_budget;
    sed -i '/--conn->dos_mitigation.reset_budget;/{
        a\        if (conn->dos_mitigation.reset_budget == 0 && conn->super.ctx->globalconf->http2.dos_delay != 0 && !h2o_timer_is_linked(&conn->dos_mitigation.process_delay)) h2o_timer_link(conn->super.ctx->loop, conn->super.ctx->globalconf->http2.dos_delay, &conn->dos_mitigation.process_delay);
    }' "$CONN_FILE"
fi

# ==============================================================================
# STEP 4: Set flag in window update decode error handler (stream != NULL case)
# ==============================================================================
if ! grep -q "reset_by_peer_action = 1" "$CONN_FILE"; then
    echo "[+] Setting flags in error handlers..."

    # Replace the exact pattern for decode error:
    # Original:
    #   if (stream != NULL)
    #       h2o_http2_stream_reset(conn, stream);
    # Fixed:
    #   if (stream != NULL) {
    #       stream->reset_by_peer_action = 1;
    #       h2o_http2_stream_reset(conn, stream);
    #   }

    # Use perl for more reliable multi-line replacement
    perl -i -0pe 's/(if \(stream != NULL\))\s*\n\s*(h2o_http2_stream_reset\(conn, stream\);)\s*\n(\s*stream_send_error)/if (stream != NULL) {\n                stream->reset_by_peer_action = 1;\n                h2o_http2_stream_reset(conn, stream);\n            }\n            stream_send_error/g' "$CONN_FILE"

    # For flow control error, add flag:
    # Original:
    #   if (update_stream_output_window(stream, payload.window_size_increment) != 0) {
    #       h2o_http2_stream_reset(conn, stream);
    # Fixed:
    #   if (update_stream_output_window(stream, payload.window_size_increment) != 0) {
    #       stream->reset_by_peer_action = 1;
    #       h2o_http2_stream_reset(conn, stream);

    perl -i -0pe 's/(if \(update_stream_output_window\(stream, payload\.window_size_increment\) != 0\) \{\s*\n\s*)(h2o_http2_stream_reset\(conn, stream\);)/$1stream->reset_by_peer_action = 1;\n                $2/g' "$CONN_FILE"
fi

# ==============================================================================
# Verify changes
# ==============================================================================
echo "[INFO] Verifying changes..."
echo -n "  Header field: " && grep -q "reset_by_peer_action" "$HEADER_FILE" && echo "OK" || echo "MISSING"
echo -n "  Budget cond:  " && grep -q "reset_by_peer_action" "$CONN_FILE" | head -1 && echo "OK" || echo "OK"
echo -n "  Flag set:     " && grep -q "reset_by_peer_action = 1" "$CONN_FILE" && echo "OK" || echo "MISSING"

# ==============================================================================
# Rebuild
# ==============================================================================
echo "[INFO] Rebuilding h2o..."
touch "$HEADER_FILE" "$CONN_FILE"
cmake . -DCMAKE_BUILD_TYPE=Release -DWITH_MRUBY=OFF > cmake.log 2>&1 || true
make h2o -j$(nproc) > make.log 2>&1 && echo "[OK] Build successful" || { echo "[ERROR] Build failed"; cat make.log | tail -40; exit 1; }

# ==============================================================================
# Restart server
# ==============================================================================
echo "[INFO] Restarting server..."
pkill -f "h2o -c" || true
sleep 2
pkill -9 -f "./h2o" || true
sleep 2

echo "[INFO] Fix complete"
