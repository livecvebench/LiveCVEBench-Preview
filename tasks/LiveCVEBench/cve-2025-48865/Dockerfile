# Dockerfile for CVE-2025-48865 - Fabio HTTP Header Manipulation Vulnerability
# Multi-stage build: compile Fabio, then create runtime image

FROM golang:1.24-bookworm AS builder

# Proxy settings for build
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG http_proxy
ARG https_proxy
ARG NO_PROXY
ARG no_proxy

WORKDIR /src

# Install git
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Clone fabio at vulnerable version and remove git history
RUN git clone https://github.com/fabiolb/fabio.git . && \
    git checkout v1.6.5 && \
    rm -rf .git

# Download dependencies and build
RUN go mod download
RUN go build -o fabio .

# Runtime stage
FROM debian:bookworm-slim

WORKDIR /app

# Install required packages: python3 for backend, tmux/asciinema/curl required by spec
RUN apt-get update && apt-get install -y \
    ca-certificates \
    python3 \
    tmux \
    asciinema \
    gcc \
    g++ \
    wget \
    curl \
    git \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Copy built binary
COPY --from=builder /src/fabio /app/fabio

# Copy source directory structure for solution.sh patching
COPY --from=builder /src/proxy /app/proxy/
COPY --from=builder /src/go.mod /app/go.mod
COPY --from=builder /src/go.sum /app/go.sum

# Copy Go toolchain for rebuilding after patches
COPY --from=builder /usr/local/go /usr/local/go
ENV PATH="/usr/local/go/bin:${PATH}"
ENV GOPATH=/go
ENV GOCACHE=/go/cache

# Copy all source for rebuild capability
COPY --from=builder /src /app/src

# Copy backend server and entrypoint
COPY task-deps/backend_server.py /app/backend_server.py
COPY task-deps/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh


# Start services
# CMD ["/app/entrypoint.sh"]
