#!/bin/bash
set -e

# Fix for stored XSS vulnerability in Voting System
# The fix applies htmlspecialchars() to user-controlled output in display pages

echo "Applying fix for output encoding in voters.php and candidates.php..."

# Fix voters.php - escape firstname and lastname output using Python for reliable string replacement
python3 << 'PYEOF'
import re

# Fix voters.php
with open('/var/www/html/admin/voters.php', 'r') as f:
    content = f.read()

# Fix lastname output on line 68
# Original: <td>".$row['lastname']."</td>
# Fixed:   <td>".htmlspecialchars($row['lastname'], ENT_QUOTES, 'UTF-8')."</td>
content = re.sub(
    r'<td>"\.\$row\[\'lastname\'\]\."</td>',
    '<td>".htmlspecialchars($row[\'lastname\'], ENT_QUOTES, \'UTF-8\')."</td>',
    content
)

# Fix firstname output on line 69
# Original: <td>".$row['firstname']."</td>
# Fixed:   <td>".htmlspecialchars($row['firstname'], ENT_QUOTES, 'UTF-8')."</td>
content = re.sub(
    r'<td>"\.\$row\[\'firstname\'\]\."</td>',
    '<td>".htmlspecialchars($row[\'firstname\'], ENT_QUOTES, \'UTF-8\')."</td>',
    content
)

with open('/var/www/html/admin/voters.php', 'w') as f:
    f.write(content)

print("Fixed voters.php")
PYEOF

# Fix candidates.php - escape firstname and lastname output
python3 << 'PYEOF'
import re

# Fix candidates.php
with open('/var/www/html/admin/candidates.php', 'r') as f:
    content = f.read()

# Fix firstname output on line 76
# Original: <td>".$row['firstname']."</td>
# Fixed:   <td>".htmlspecialchars($row['firstname'], ENT_QUOTES, 'UTF-8')."</td>
content = re.sub(
    r'<td>"\.\$row\[\'firstname\'\]\."</td>',
    '<td>".htmlspecialchars($row[\'firstname\'], ENT_QUOTES, \'UTF-8\')."</td>',
    content
)

# Fix lastname output on line 77
# Original: <td>".$row['lastname']."</td>
# Fixed:   <td>".htmlspecialchars($row['lastname'], ENT_QUOTES, 'UTF-8')."</td>
content = re.sub(
    r'<td>"\.\$row\[\'lastname\'\]\."</td>',
    '<td>".htmlspecialchars($row[\'lastname\'], ENT_QUOTES, \'UTF-8\')."</td>',
    content
)

with open('/var/www/html/admin/candidates.php', 'w') as f:
    f.write(content)

print("Fixed candidates.php")
PYEOF

echo "Fix applied successfully!"
echo ""
echo "Changes made:"
echo "  - voters.php: Added htmlspecialchars() to firstname and lastname output"
echo "  - candidates.php: Added htmlspecialchars() to firstname and lastname output"
