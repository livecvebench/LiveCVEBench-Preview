#!/bin/bash
# Solution script for NetAlertX authentication bypass fix (CVE-2025-32440)
# This fixes the include chain vulnerability in index.php

set -e

echo "Applying fix for authentication bypass vulnerability..."

# The vulnerable index.php includes init.php which loads util.php
# This exposes administrative functions to unauthenticated users via /index.php
# The fix removes the init.php include and only includes necessary files

# Backup original file
cp /app/front/index.php /app/front/index.php.bak 2>/dev/null || true

# First, remove the init.php line
sed -i "/require dirname(__FILE__).'\/php\/server\/init.php';/d" /app/front/index.php

# Add db.php and lang.php before security.php
sed -i "s|// check if authenticated|// check if authenticated\n// Be CAREFUL WHEN INCLUDING NEW PHP FILES\nrequire_once \$_SERVER['DOCUMENT_ROOT'] . '/php/server/db.php';\nrequire_once \$_SERVER['DOCUMENT_ROOT'] . '/php/templates/language/lang.php';|" /app/front/index.php

# IMPORTANT: Restore the config file to its original state
# The vulnerable tests modify settings (e.g., disable password protection)
# This ensures the fixed tests run against a clean configuration
if [ -f /app/config/app.conf.orig ]; then
    cp /app/config/app.conf.orig /app/config/app.conf
    chown nginx:www-data /app/config/app.conf 2>/dev/null || true
    echo "Restored original configuration"
fi

echo "Fix applied successfully!"
echo "The login page no longer includes init.php which was exposing utility functions."
