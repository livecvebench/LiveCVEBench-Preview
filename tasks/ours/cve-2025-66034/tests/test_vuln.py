"""
Vulnerability tests for fonttools varLib path traversal issue.
These tests verify that path traversal in variable-font filenames is blocked.

- FAIL in vulnerable state (path traversal succeeds)
- PASS in fixed state (path traversal is blocked)
"""

import os
import sys
import shutil
import tempfile
import pytest


def create_master_font(filepath, family_name="TestFont", style_name="Regular"):
    """Create a minimal TTF font for use as a designspace master."""
    from fontTools.fontBuilder import FontBuilder
    from fontTools.pens.ttGlyphPen import TTGlyphPen

    fb = FontBuilder(1000, isTTF=True)
    fb.setupGlyphOrder([".notdef", "space", "A"])
    fb.setupCharacterMap({32: "space", 65: "A"})

    pen = TTGlyphPen(None)
    pen.moveTo((100, 0))
    pen.lineTo((100, 700))
    pen.lineTo((600, 700))
    pen.lineTo((600, 0))
    pen.closePath()
    glyph = pen.glyph()

    glyphs = {".notdef": glyph, "space": glyph, "A": glyph}
    fb.setupGlyf(glyphs)

    metrics = {".notdef": (600, 100), "space": (300, 0), "A": (700, 100)}
    fb.setupHorizontalMetrics(metrics)
    fb.setupHorizontalHeader(ascent=800, descent=-200)

    name_strings = {
        "familyName": family_name,
        "styleName": style_name,
        "uniqueFontIdentifier": f"{family_name}.{style_name}",
        "fullName": f"{family_name}-{style_name}",
        "psName": f"{family_name}-{style_name}",
        "version": "Version 1.0",
    }
    fb.setupNameTable(name_strings)
    fb.setupOS2(sTypoAscender=800, usWinAscent=800, usWinDescent=200)
    fb.setupPost()
    fb.save(filepath)


def create_malicious_designspace(work_dir, malicious_filename):
    """Create a designspace file with path traversal in the filename attribute."""
    designspace_content = f'''<?xml version='1.0' encoding='UTF-8'?>
<designspace format="5.0">
  <axes>
    <axis tag="wght" name="Weight" minimum="100" default="100" maximum="700"/>
  </axes>
  <sources>
    <source filename="source-light.ttf" name="Light Master">
      <lib copy="1"/>
      <groups copy="1"/>
      <info copy="1"/>
      <location>
        <dimension name="Weight" xvalue="100"/>
      </location>
    </source>
    <source filename="source-bold.ttf" name="Bold Master">
      <location>
        <dimension name="Weight" xvalue="700"/>
      </location>
    </source>
  </sources>
  <variable-fonts>
    <variable-font name="MaliciousVF" filename="{malicious_filename}">
      <axis-subsets>
        <axis-subset name="Weight"/>
      </axis-subsets>
    </variable-font>
  </variable-fonts>
</designspace>
'''
    ds_path = os.path.join(work_dir, "malicious.designspace")
    with open(ds_path, "w") as f:
        f.write(designspace_content)
    return ds_path


def setup_test_environment(work_dir):
    """Set up the test environment with source fonts."""
    os.makedirs(work_dir, exist_ok=True)
    create_master_font(os.path.join(work_dir, "source-light.ttf"), "TestFont", "Light")
    create_master_font(os.path.join(work_dir, "source-bold.ttf"), "TestFont", "Bold")


class TestPathTraversalBlocking:
    """Test that path traversal attacks are blocked."""

    def test_relative_path_traversal_blocked(self):
        """Test that ../../ style path traversal is blocked."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            target_dir = os.path.join(tmpdir, "target")
            os.makedirs(target_dir, exist_ok=True)

            setup_test_environment(work_dir)

            # Create path traversal to escape work_dir
            malicious_filename = "../target/pwned.ttf"
            target_file = os.path.join(target_dir, "pwned.ttf")

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Path traversal should be blocked - file should NOT be in target_dir
            assert not os.path.exists(target_file), \
                f"Path traversal should be blocked! File was written to {target_file}"

            # Instead, only basename should be used - file should be in work_dir
            safe_output = os.path.join(work_dir, "pwned.ttf")
            assert os.path.exists(safe_output), \
                f"File should be written to local directory as 'pwned.ttf', not {malicious_filename}"

    def test_deep_path_traversal_blocked(self):
        """Test that deep path traversal (multiple ../) is blocked."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            # Create deeply nested work directory
            work_dir = os.path.join(tmpdir, "a", "b", "c", "d", "poc")
            target_dir = os.path.join(tmpdir, "pwned_deep")
            os.makedirs(work_dir, exist_ok=True)
            os.makedirs(target_dir, exist_ok=True)

            setup_test_environment(work_dir)

            # Deep traversal to escape all the way out
            malicious_filename = "../../../../pwned_deep/evil.ttf"
            target_file = os.path.join(target_dir, "evil.ttf")

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            assert not os.path.exists(target_file), \
                f"Deep path traversal should be blocked! File was written to {target_file}"

            safe_output = os.path.join(work_dir, "evil.ttf")
            assert os.path.exists(safe_output), \
                "File should be written with only the basename"

    def test_absolute_path_traversal_blocked(self):
        """Test that absolute paths are blocked (only basename used)."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            target_dir = os.path.join(tmpdir, "absolute_target")
            os.makedirs(work_dir, exist_ok=True)
            os.makedirs(target_dir, exist_ok=True)

            setup_test_environment(work_dir)

            # Try absolute path (still should only use basename)
            malicious_filename = f"{target_dir}/absolute.ttf"
            target_file = os.path.join(target_dir, "absolute.ttf")

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Absolute path should also be stripped to basename only
            assert not os.path.exists(target_file), \
                f"Absolute path should be stripped! File was written to {target_file}"

            safe_output = os.path.join(work_dir, "absolute.ttf")
            assert os.path.exists(safe_output), \
                "File should be written with only the basename 'absolute.ttf'"

    def test_tmp_directory_traversal_blocked(self):
        """Test that traversal to /tmp is blocked."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            setup_test_environment(work_dir)

            # Create unique target file in /tmp
            import uuid
            unique_name = f"fonttools_vuln_test_{uuid.uuid4().hex[:8]}.ttf"
            target_file = f"/tmp/{unique_name}"

            # Path traversal attempting to write to /tmp
            malicious_filename = f"../../../../../../../tmp/{unique_name}"

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Clean up if it was written (vulnerability exists)
            try:
                if os.path.exists(target_file):
                    os.remove(target_file)
                    pytest.fail(f"Path traversal to /tmp should be blocked! File was written to {target_file}")
            except Exception:
                pass

            # File should be in work_dir with just the basename
            safe_output = os.path.join(work_dir, unique_name)
            assert os.path.exists(safe_output), \
                f"File should be written locally as {unique_name}"

    def test_hidden_directory_traversal_blocked(self):
        """Test traversal to hidden directories is blocked."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            hidden_dir = os.path.join(tmpdir, ".hidden")
            os.makedirs(work_dir, exist_ok=True)
            os.makedirs(hidden_dir, exist_ok=True)

            setup_test_environment(work_dir)

            malicious_filename = "../.hidden/sneaky.ttf"
            target_file = os.path.join(hidden_dir, "sneaky.ttf")

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            assert not os.path.exists(target_file), \
                f"Traversal to hidden directory should be blocked! File written to {target_file}"

            safe_output = os.path.join(work_dir, "sneaky.ttf")
            assert os.path.exists(safe_output), \
                "File should be written with only the basename 'sneaky.ttf'"

    def test_double_dot_traversal_blocked(self):
        """Test that double-dot style path traversal is blocked."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            target_dir = os.path.join(tmpdir, "dotdot_target")
            os.makedirs(work_dir, exist_ok=True)
            os.makedirs(target_dir, exist_ok=True)

            setup_test_environment(work_dir)

            # Double-dot traversal to escape work_dir
            malicious_filename = "../dotdot_target/dotdot.ttf"

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Path traversal should be blocked - file should NOT be in target_dir
            target_file = os.path.join(target_dir, "dotdot.ttf")
            assert not os.path.exists(target_file), \
                f"Path traversal should be blocked! File was written to {target_file}"

            # Instead, only basename should be used - file should be in work_dir
            safe_output = os.path.join(work_dir, "dotdot.ttf")
            assert os.path.exists(safe_output), \
                "File should be written locally as 'dotdot.ttf'"

    def test_mixed_separators_blocked(self):
        """Test that mixed path separators are handled correctly."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            target_dir = os.path.join(tmpdir, "mixed")
            os.makedirs(work_dir, exist_ok=True)
            os.makedirs(target_dir, exist_ok=True)

            setup_test_environment(work_dir)

            # Mixed path with dots
            malicious_filename = "subdir/../../../mixed/escape.ttf"
            target_file = os.path.join(target_dir, "escape.ttf")

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            assert not os.path.exists(target_file), \
                f"Mixed path traversal should be blocked! File was written to {target_file}"

            safe_output = os.path.join(work_dir, "escape.ttf")
            assert os.path.exists(safe_output), \
                "File should be written with only the basename 'escape.ttf'"

    def test_subdirectory_traversal_blocked(self):
        """Test that subdirectory with traversal is blocked."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            target_dir = os.path.join(tmpdir, "subdir_target")
            os.makedirs(work_dir, exist_ok=True)
            os.makedirs(target_dir, exist_ok=True)

            setup_test_environment(work_dir)

            # Traversal via subdirectory notation
            malicious_filename = "../subdir_target/escaped.ttf"
            target_file = os.path.join(target_dir, "escaped.ttf")

            ds_path = create_malicious_designspace(work_dir, malicious_filename)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Path traversal should be blocked - file should NOT be in target_dir
            assert not os.path.exists(target_file), \
                f"Path traversal should be blocked! File was written to {target_file}"

            # File should be in work_dir with basename only
            safe_output = os.path.join(work_dir, "escaped.ttf")
            assert os.path.exists(safe_output), \
                "File should be written locally as 'escaped.ttf'"

    def test_multiple_variable_fonts_traversal_blocked(self):
        """Test that path traversal is blocked for multiple variable-fonts."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            work_dir = os.path.join(tmpdir, "poc")
            target_dir = os.path.join(tmpdir, "multi_target")
            os.makedirs(work_dir, exist_ok=True)
            os.makedirs(target_dir, exist_ok=True)

            setup_test_environment(work_dir)

            # Designspace with multiple variable-fonts, some with traversal
            designspace_content = f'''<?xml version='1.0' encoding='UTF-8'?>
<designspace format="5.0">
  <axes>
    <axis tag="wght" name="Weight" minimum="100" default="100" maximum="700"/>
  </axes>
  <sources>
    <source filename="source-light.ttf" name="Light Master">
      <lib copy="1"/><groups copy="1"/><info copy="1"/>
      <location><dimension name="Weight" xvalue="100"/></location>
    </source>
    <source filename="source-bold.ttf" name="Bold Master">
      <location><dimension name="Weight" xvalue="700"/></location>
    </source>
  </sources>
  <variable-fonts>
    <variable-font name="SafeVF" filename="safe.ttf">
      <axis-subsets><axis-subset name="Weight"/></axis-subsets>
    </variable-font>
    <variable-font name="MaliciousVF" filename="../multi_target/evil.ttf">
      <axis-subsets><axis-subset name="Weight"/></axis-subsets>
    </variable-font>
  </variable-fonts>
</designspace>
'''
            ds_path = os.path.join(work_dir, "multi.designspace")
            with open(ds_path, "w") as f:
                f.write(designspace_content)

            cwd = os.getcwd()
            os.chdir(work_dir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Safe file should exist
            assert os.path.exists(os.path.join(work_dir, "safe.ttf")), \
                "Safe output file should be created"

            # Malicious target should NOT exist
            assert not os.path.exists(os.path.join(target_dir, "evil.ttf")), \
                "Path traversal should be blocked for second variable-font"

            # Malicious file should be in work_dir with basename only
            assert os.path.exists(os.path.join(work_dir, "evil.ttf")), \
                "Malicious filename should be sanitized to basename only"
