#!/usr/bin/env python3
"""
Vulnerability tests for NetAlertX authentication bypass.

These tests verify that the authentication bypass vulnerability is fixed.
- FAIL in vulnerable state (vulnerability is exploitable)
- PASS in fixed state (vulnerability is mitigated)
"""

import pytest
import requests
import json
import time

BASE_URL = "http://localhost:20211"
TIMEOUT = 15


class TestSaveSettingsAuthBypass:
    """Tests for the savesettings function authentication bypass."""

    def test_savesettings_blocked_via_index(self):
        """
        Test that savesettings function cannot be triggered via index.php.

        In the vulnerable version, POST to /index.php with function=savesettings
        would save settings without authentication.
        After fix, this should NOT work.
        """
        payload = {
            "function": "savesettings",
            "settings": json.dumps([
                ["General", "UI_LANG", "string", "TestBypass1"],
                ["General", "TIMEZONE", "string", "Europe/Berlin"]
            ])
        }

        response = requests.post(
            f"{BASE_URL}/index.php",
            data=payload,
            timeout=TIMEOUT
        )

        # After fix, we should NOT get "OK" response
        # The request should either show the login page or be rejected
        assert response.status_code == 200
        assert "OK" not in response.text, \
            "Vulnerability exists! savesettings succeeded without authentication"

        # Should get login page HTML instead
        assert "loginpassword" in response.text or "Log in" in response.text or \
               "NetAlert" in response.text, \
            "Expected login page response after fix"

    def test_disable_password_blocked(self):
        """
        Test that password protection cannot be disabled without authentication.

        This is a critical attack vector where an attacker could disable
        password protection entirely.
        """
        payload = {
            "function": "savesettings",
            "settings": json.dumps([
                ["SETPWD", "SETPWD_enable_password", "boolean", "False"],
                ["General", "UI_LANG", "string", "English"],
                ["General", "TIMEZONE", "string", "Europe/Berlin"]
            ])
        }

        response = requests.post(
            f"{BASE_URL}/index.php",
            data=payload,
            timeout=TIMEOUT
        )

        assert response.status_code == 200
        assert "OK" not in response.text, \
            "Critical vulnerability! Password protection can be disabled without auth"

    def test_settings_modification_blocked_multiple_settings(self):
        """
        Test that multiple settings cannot be modified via index.php.
        """
        payload = {
            "function": "savesettings",
            "settings": json.dumps([
                ["General", "UI_LANG", "string", "HackedLang"],
                ["General", "TIMEZONE", "string", "UTC"],
                ["General", "UI_THEME", "string", "Dark"]
            ])
        }

        response = requests.post(
            f"{BASE_URL}/index.php",
            data=payload,
            timeout=TIMEOUT
        )

        assert "OK" not in response.text, \
            "Settings modification succeeded without authentication"


class TestFunctionParameterInjection:
    """Tests for various function parameter injection attempts."""

    def test_function_parameter_in_query_string(self):
        """
        Test that function parameter in query string doesn't work.
        """
        payload = {
            "settings": json.dumps([
                ["General", "UI_LANG", "string", "TestQuery"],
                ["General", "TIMEZONE", "string", "Europe/Berlin"]
            ])
        }

        response = requests.post(
            f"{BASE_URL}/index.php?function=savesettings",
            data=payload,
            timeout=TIMEOUT
        )

        assert "OK" not in response.text, \
            "Query string function parameter exploit succeeded"

    def test_mixed_get_post_function(self):
        """
        Test that mixing GET and POST parameters doesn't bypass auth.
        """
        response = requests.post(
            f"{BASE_URL}/index.php?function=savesettings",
            data={
                "function": "savesettings",
                "settings": json.dumps([
                    ["General", "UI_LANG", "string", "TestMixed"],
                    ["General", "TIMEZONE", "string", "Europe/Berlin"]
                ])
            },
            timeout=TIMEOUT
        )

        assert "OK" not in response.text, \
            "Mixed GET/POST parameter exploit succeeded"

    def test_different_function_types(self):
        """
        Test that other function types are also blocked via index.php.
        """
        functions_to_test = [
            "savesettings",
            "getSettings",
            "getConfig",
            "saveConfig"
        ]

        for func in functions_to_test:
            response = requests.post(
                f"{BASE_URL}/index.php",
                data={
                    "function": func,
                    "settings": "[]"
                },
                timeout=TIMEOUT
            )

            # None of these should return "OK" without authentication
            assert "OK" not in response.text or func not in ["savesettings"], \
                f"Function {func} executed without authentication"


class TestEncodedPayloads:
    """Tests for encoded and obfuscated payloads."""

    def test_url_encoded_function(self):
        """
        Test that URL-encoded function parameter doesn't bypass auth.
        """
        response = requests.post(
            f"{BASE_URL}/index.php",
            data="function=savesettings&settings=" + requests.utils.quote(
                json.dumps([
                    ["General", "UI_LANG", "string", "TestEncoded"],
                    ["General", "TIMEZONE", "string", "Europe/Berlin"]
                ])
            ),
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=TIMEOUT
        )

        assert "OK" not in response.text, \
            "URL-encoded payload exploit succeeded"

    def test_json_content_type(self):
        """
        Test that JSON content type doesn't change behavior.
        """
        response = requests.post(
            f"{BASE_URL}/index.php",
            json={
                "function": "savesettings",
                "settings": [
                    ["General", "UI_LANG", "string", "TestJSON"],
                    ["General", "TIMEZONE", "string", "Europe/Berlin"]
                ]
            },
            timeout=TIMEOUT
        )

        # Should not succeed regardless of content type
        assert "OK" not in response.text, \
            "JSON content type exploit succeeded"


class TestAlternativeEntryPoints:
    """Tests for alternative entry point exploitation attempts."""

    def test_index_without_extension(self):
        """
        Test that /index (without .php) doesn't allow bypass.
        Also verifies the main /index.php path is protected.
        """
        # First test /index without extension
        response_no_ext = requests.post(
            f"{BASE_URL}/index",
            data={
                "function": "savesettings",
                "settings": json.dumps([
                    ["General", "UI_LANG", "string", "TestNoExt"],
                    ["General", "TIMEZONE", "string", "Europe/Berlin"]
                ])
            },
            timeout=TIMEOUT
        )

        # /index without extension should not succeed
        assert "OK" not in response_no_ext.text, \
            "No-extension index exploit succeeded"

        # Also verify the main index.php path is protected (critical check)
        response_main = requests.post(
            f"{BASE_URL}/index.php",
            data={
                "function": "savesettings",
                "settings": json.dumps([
                    ["General", "UI_LANG", "string", "TestNoExtMain"],
                    ["General", "TIMEZONE", "string", "Europe/Berlin"]
                ])
            },
            timeout=TIMEOUT
        )
        assert "OK" not in response_main.text, \
            "Main index.php exploit still works - vulnerability exists"

    def test_root_path_with_function(self):
        """
        Test that root path / doesn't allow function parameter.
        """
        response = requests.post(
            f"{BASE_URL}/",
            data={
                "function": "savesettings",
                "settings": json.dumps([
                    ["General", "UI_LANG", "string", "TestRoot"],
                    ["General", "TIMEZONE", "string", "Europe/Berlin"]
                ])
            },
            timeout=TIMEOUT,
            allow_redirects=True
        )

        assert "OK" not in response.text, \
            "Root path function parameter exploit succeeded"


class TestEmptyAndMalformedPayloads:
    """Tests with empty and malformed payloads."""

    def test_empty_settings(self):
        """
        Test behavior with empty settings array.
        """
        response = requests.post(
            f"{BASE_URL}/index.php",
            data={
                "function": "savesettings",
                "settings": "[]"
            },
            timeout=TIMEOUT
        )

        # Even with empty settings, should not indicate success
        assert "OK" not in response.text, \
            "Empty settings still triggered savesettings"

    def test_malformed_json_settings(self):
        """
        Test behavior with malformed JSON.
        """
        response = requests.post(
            f"{BASE_URL}/index.php",
            data={
                "function": "savesettings",
                "settings": "{invalid json["
            },
            timeout=TIMEOUT
        )

        # Should handle gracefully without indicating success
        # In vulnerable state, the function is still called even if JSON parsing fails
        # The key indicator is whether the savesettings code path was reached
        assert response.status_code in [200, 400, 500]
        # Even malformed JSON should NOT trigger "OK" response in fixed version
        # because the function call should be blocked at the include level
        assert "OK" not in response.text, \
            "Malformed JSON still reached savesettings code path - vulnerability exists"

    def test_missing_required_fields(self):
        """
        Test with missing required setting fields.
        """
        response = requests.post(
            f"{BASE_URL}/index.php",
            data={
                "function": "savesettings",
                "settings": json.dumps([
                    ["General", "UI_LANG", "string"]  # Missing value
                ])
            },
            timeout=TIMEOUT
        )

        # Should not succeed with missing fields
        assert response.status_code in [200, 400, 500]
        # In fixed version, the savesettings function should never be reached
        # In vulnerable version, even malformed settings may return "OK" or other indicators
        assert "OK" not in response.text, \
            "Missing required fields still reached savesettings code path - vulnerability exists"


class TestRateLimiting:
    """Tests for multiple rapid requests."""

    def test_multiple_rapid_requests(self):
        """
        Test that multiple rapid requests are all properly blocked.
        """
        payload = {
            "function": "savesettings",
            "settings": json.dumps([
                ["General", "UI_LANG", "string", "TestRapid"],
                ["General", "TIMEZONE", "string", "Europe/Berlin"]
            ])
        }

        # Send 5 rapid requests
        for i in range(5):
            response = requests.post(
                f"{BASE_URL}/index.php",
                data=payload,
                timeout=TIMEOUT
            )

            assert "OK" not in response.text, \
                f"Request {i+1} succeeded - rapid fire bypass found"


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-rA"])
