"""
Vulnerability tests for BentoML pickle deserialization issue (CVE-2025-27520).

These tests verify that the vulnerability is properly mitigated:
- FAIL in vulnerable state (pickle requests are processed, RCE possible)
- PASS in fixed state (pickle requests are blocked with HTTP 415)
"""
import pytest
import requests
import pickle
import os
import time
import subprocess
import uuid

BASE_URL = "http://localhost:3000"
MARKER_DIR = "/tmp"


def wait_for_service(url: str, timeout: int = 60, interval: float = 1.0):
    """Wait for service to become available."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(url, timeout=5)
            if response.status_code in [200, 404]:
                return True
        except requests.exceptions.ConnectionError:
            pass
        except requests.exceptions.Timeout:
            pass
        time.sleep(interval)
    raise TimeoutError(f"Service at {url} did not become available within {timeout}s")


@pytest.fixture(scope="module", autouse=True)
def ensure_service_ready():
    """Ensure the BentoML service is ready before running tests."""
    wait_for_service(BASE_URL)


class RCEPayload:
    """
    Malicious class that exploits pickle's __reduce__ method.
    When unpickled, executes the command via os.system().
    """
    def __init__(self, command: str):
        self.command = command

    def __reduce__(self):
        return (os.system, (self.command,))


class RCEPayloadSubprocess:
    """Alternative RCE payload using subprocess."""
    def __init__(self, command: str):
        self.command = command

    def __reduce__(self):
        import subprocess
        return (subprocess.call, (["/bin/sh", "-c", self.command],))


def create_unique_marker():
    """Create a unique marker filename for testing."""
    return f"{MARKER_DIR}/bentoml_vuln_test_{uuid.uuid4().hex[:8]}"


def cleanup_marker(marker_path: str):
    """Remove marker file if it exists."""
    try:
        if os.path.exists(marker_path):
            os.remove(marker_path)
    except Exception:
        pass


class TestPickleContentTypeBlocking:
    """Test that pickle content type is blocked on main server."""

    def test_pickle_content_type_rejected_echo_endpoint(self):
        """
        Verify pickle content-type requests are rejected with HTTP 415.

        After the fix, requests with Content-Type: application/vnd.bentoml+pickle
        should be rejected with 415 Unsupported Media Type.
        """
        payload = pickle.dumps({"test": "data"})
        response = requests.post(
            f"{BASE_URL}/echo",
            data=payload,
            headers={"Content-Type": "application/vnd.bentoml+pickle"},
            timeout=10
        )
        assert response.status_code == 415, \
            f"Expected 415, got {response.status_code}. Pickle content type should be blocked."

    def test_pickle_content_type_rejected_process_endpoint(self):
        """
        Verify pickle content-type is rejected on /process endpoint.
        """
        payload = pickle.dumps({"data": {"key": "value"}})
        response = requests.post(
            f"{BASE_URL}/process",
            data=payload,
            headers={"Content-Type": "application/vnd.bentoml+pickle"},
            timeout=10
        )
        assert response.status_code == 415, \
            f"Expected 415, got {response.status_code}. Pickle content type should be blocked."

    def test_pickle_content_type_with_charset_rejected(self):
        """
        Verify pickle content-type with charset suffix is also rejected.
        """
        payload = pickle.dumps({"test": "data"})
        response = requests.post(
            f"{BASE_URL}/echo",
            data=payload,
            headers={"Content-Type": "application/vnd.bentoml+pickle; charset=utf-8"},
            timeout=10
        )
        assert response.status_code == 415, \
            f"Expected 415, got {response.status_code}. Pickle with charset should be blocked."

    def test_error_message_content(self):
        """
        Verify the error response contains appropriate message.
        """
        payload = pickle.dumps({"test": "data"})
        response = requests.post(
            f"{BASE_URL}/echo",
            data=payload,
            headers={"Content-Type": "application/vnd.bentoml+pickle"},
            timeout=10
        )
        assert response.status_code == 415
        # Check that response body mentions the issue
        response_text = response.text.lower()
        assert "pickle" in response_text or "not allowed" in response_text or "unsupported" in response_text


class TestRCEPrevention:
    """Test that Remote Code Execution is prevented."""

    def test_rce_via_os_system_prevented(self):
        """
        Verify that arbitrary code execution via os.system is prevented.

        This test sends a malicious pickle payload that would create a file
        if deserialized. After the fix, the request should be rejected
        before deserialization occurs.
        """
        marker_file = create_unique_marker()
        cleanup_marker(marker_file)

        try:
            # Create malicious payload
            payload = pickle.dumps(RCEPayload(f"touch {marker_file}"))

            # Try to exploit
            try:
                response = requests.post(
                    f"{BASE_URL}/echo",
                    data=payload,
                    headers={"Content-Type": "application/vnd.bentoml+pickle"},
                    timeout=10
                )
            except Exception:
                pass

            # Wait a moment for potential file creation
            time.sleep(1)

            # Verify exploit failed - marker file should NOT exist
            assert not os.path.exists(marker_file), \
                f"RCE successful! Marker file {marker_file} was created. Vulnerability NOT fixed!"
        finally:
            cleanup_marker(marker_file)

    def test_rce_via_subprocess_prevented(self):
        """
        Verify that arbitrary code execution via subprocess is prevented.
        """
        marker_file = create_unique_marker()
        cleanup_marker(marker_file)

        try:
            payload = pickle.dumps(RCEPayloadSubprocess(f"touch {marker_file}"))

            try:
                response = requests.post(
                    f"{BASE_URL}/echo",
                    data=payload,
                    headers={"Content-Type": "application/vnd.bentoml+pickle"},
                    timeout=10
                )
            except Exception:
                pass

            time.sleep(1)

            assert not os.path.exists(marker_file), \
                f"RCE successful via subprocess! Vulnerability NOT fixed!"
        finally:
            cleanup_marker(marker_file)

    def test_rce_on_process_endpoint_prevented(self):
        """
        Verify RCE is prevented on all endpoints, not just /echo.
        """
        marker_file = create_unique_marker()
        cleanup_marker(marker_file)

        try:
            payload = pickle.dumps(RCEPayload(f"touch {marker_file}"))

            try:
                response = requests.post(
                    f"{BASE_URL}/process",
                    data=payload,
                    headers={"Content-Type": "application/vnd.bentoml+pickle"},
                    timeout=10
                )
            except Exception:
                pass

            time.sleep(1)

            assert not os.path.exists(marker_file), \
                "RCE successful on /process endpoint! Vulnerability NOT fixed!"
        finally:
            cleanup_marker(marker_file)

    def test_rce_with_file_write_command_prevented(self):
        """
        Verify file write commands via RCE are prevented.
        """
        marker_file = create_unique_marker()
        cleanup_marker(marker_file)

        try:
            # More complex command - write content to file
            payload = pickle.dumps(RCEPayload(f"echo 'exploited' > {marker_file}"))

            try:
                response = requests.post(
                    f"{BASE_URL}/echo",
                    data=payload,
                    headers={"Content-Type": "application/vnd.bentoml+pickle"},
                    timeout=10
                )
            except Exception:
                pass

            time.sleep(1)

            assert not os.path.exists(marker_file), \
                "RCE via echo command successful! Vulnerability NOT fixed!"
        finally:
            cleanup_marker(marker_file)


class TestPayloadVariations:
    """Test various malicious payload variations are blocked."""

    def test_nested_pickle_payload_blocked(self):
        """
        Verify nested pickle objects are blocked.
        """
        marker_file = create_unique_marker()
        cleanup_marker(marker_file)

        try:
            # Create nested payload
            inner = {"nested": RCEPayload(f"touch {marker_file}")}
            payload = pickle.dumps(inner)

            try:
                response = requests.post(
                    f"{BASE_URL}/echo",
                    data=payload,
                    headers={"Content-Type": "application/vnd.bentoml+pickle"},
                    timeout=10
                )
            except Exception:
                pass

            time.sleep(1)

            # Either request is rejected (415) or RCE fails
            if os.path.exists(marker_file):
                pytest.fail("Nested pickle RCE successful! Vulnerability NOT fixed!")
        finally:
            cleanup_marker(marker_file)

    def test_list_of_payloads_blocked(self):
        """
        Verify list containing multiple RCE payloads is blocked.
        """
        marker_files = [create_unique_marker() for _ in range(3)]
        for f in marker_files:
            cleanup_marker(f)

        try:
            payloads = [RCEPayload(f"touch {f}") for f in marker_files]
            payload = pickle.dumps(payloads)

            try:
                response = requests.post(
                    f"{BASE_URL}/echo",
                    data=payload,
                    headers={"Content-Type": "application/vnd.bentoml+pickle"},
                    timeout=10
                )
            except Exception:
                pass

            time.sleep(1)

            for marker_file in marker_files:
                assert not os.path.exists(marker_file), \
                    f"RCE via payload list successful! File {marker_file} created."
        finally:
            for f in marker_files:
                cleanup_marker(f)

    def test_large_pickle_payload_blocked(self):
        """
        Verify large pickle payloads are blocked.
        """
        marker_file = create_unique_marker()
        cleanup_marker(marker_file)

        try:
            # Create large payload with RCE
            large_data = {"key": "x" * 100000, "rce": RCEPayload(f"touch {marker_file}")}
            payload = pickle.dumps(large_data)

            try:
                response = requests.post(
                    f"{BASE_URL}/echo",
                    data=payload,
                    headers={"Content-Type": "application/vnd.bentoml+pickle"},
                    timeout=10
                )
            except Exception:
                pass

            time.sleep(1)

            assert not os.path.exists(marker_file), \
                "Large payload RCE successful! Vulnerability NOT fixed!"
        finally:
            cleanup_marker(marker_file)


class TestEdgeCases:
    """Test edge cases and bypass attempts."""

    def test_empty_pickle_payload_blocked(self):
        """
        Verify even empty pickle payloads with pickle content type are blocked.
        """
        payload = pickle.dumps(None)
        response = requests.post(
            f"{BASE_URL}/echo",
            data=payload,
            headers={"Content-Type": "application/vnd.bentoml+pickle"},
            timeout=10
        )
        assert response.status_code == 415

    def test_pickle_content_type_case_sensitivity(self):
        """
        Test that content type matching is case-insensitive for the check.
        Note: HTTP headers are case-insensitive, but the value might be case-sensitive.
        """
        payload = pickle.dumps({"test": "data"})

        # The standard content type should be blocked
        response = requests.post(
            f"{BASE_URL}/echo",
            data=payload,
            headers={"Content-Type": "application/vnd.bentoml+pickle"},
            timeout=10
        )
        assert response.status_code == 415

    def test_multiple_requests_all_blocked(self):
        """
        Verify multiple consecutive pickle requests are all blocked.
        """
        payload = pickle.dumps({"test": "data"})

        for i in range(5):
            response = requests.post(
                f"{BASE_URL}/echo",
                data=payload,
                headers={"Content-Type": "application/vnd.bentoml+pickle"},
                timeout=10
            )
            assert response.status_code == 415, \
                f"Request {i+1} was not blocked (status: {response.status_code})"

    def test_legitimate_json_still_works_after_pickle_rejection(self):
        """
        Verify service still works normally after rejecting pickle requests.
        """
        # First, send pickle request (should be rejected)
        pickle_payload = pickle.dumps({"test": "data"})
        response = requests.post(
            f"{BASE_URL}/echo",
            data=pickle_payload,
            headers={"Content-Type": "application/vnd.bentoml+pickle"},
            timeout=10
        )
        assert response.status_code == 415

        # Then, send legitimate JSON request (should work)
        response = requests.post(
            f"{BASE_URL}/echo",
            json={"text": "test after pickle"},
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200
