#!/bin/bash
# Solution script for ClipBucket V5 unauthenticated template change vulnerability
# This script applies the security fix to require admin authentication before
# allowing template changes via the set_template parameter.

set -e

VULN_FILE="/var/www/html/includes/classes/ClipBucket.class.php"

# Check if the file exists
if [ ! -f "$VULN_FILE" ]; then
    echo "Error: ClipBucket.class.php not found at $VULN_FILE"
    exit 1
fi

echo "Applying security fix to $VULN_FILE..."

# First, check if fix is already applied (idempotency)
if grep -q "hasAdminAccess" "$VULN_FILE"; then
    echo "Fix already applied."
    exit 0
fi

# Apply the fix using sed with more flexible pattern matching
# Fix line 639: Add admin access check to the if condition
sed -i "s/if (isset(\$_GET\['set_template'\])) {/if (isset(\$_GET['set_template']) \&\& User::getInstance()->hasAdminAccess()) {/" "$VULN_FILE"

# Fix line 640: Change to static method call (optional but matches official fix)
sed -i 's/\$myquery->set_template(\$template);/myquery::getInstance()->set_template(\$template);/' "$VULN_FILE"

# Verify the fix was applied
if grep -q "hasAdminAccess" "$VULN_FILE"; then
    echo "Security fix applied successfully."
    grep -n "set_template" "$VULN_FILE" | head -5

    # Clear PHP OPcache to ensure the fix takes effect immediately
    # Use a PHP script to reset OPcache without restarting Apache
    echo "Clearing PHP OPcache..."
    php -r "if (function_exists('opcache_reset')) { opcache_reset(); echo 'OPcache cleared via CLI.'; }" 2>/dev/null || true

    # Also create a temporary PHP file to clear opcache via web request
    # (CLI and web may have separate opcache instances)
    echo '<?php opcache_reset(); echo "OK"; ?>' > /var/www/html/opcache_clear_temp.php
    curl -s "http://localhost/opcache_clear_temp.php" 2>/dev/null || true
    rm -f /var/www/html/opcache_clear_temp.php
    echo "OPcache cleared."
else
    echo "Warning: Fix may not have been applied correctly."
    echo "Attempting alternative fix method..."

    # Alternative: Use perl for more reliable replacement
    perl -i -pe 's/if \(isset\(\$_GET\[.set_template.\]\)\) \{/if (isset(\$_GET['\''set_template'\'']) \&\& User::getInstance()->hasAdminAccess()) {/' "$VULN_FILE"

    if grep -q "hasAdminAccess" "$VULN_FILE"; then
        echo "Alternative fix applied successfully."

        # Clear PHP OPcache to ensure the fix takes effect immediately
        echo "Clearing PHP OPcache..."
        php -r "if (function_exists('opcache_reset')) { opcache_reset(); echo 'OPcache cleared via CLI.'; }" 2>/dev/null || true

        # Also create a temporary PHP file to clear opcache via web request
        echo '<?php opcache_reset(); echo "OK"; ?>' > /var/www/html/opcache_clear_temp.php
        curl -s "http://localhost/opcache_clear_temp.php" 2>/dev/null || true
        rm -f /var/www/html/opcache_clear_temp.php
        echo "OPcache cleared."
    else
        echo "Error: Could not apply fix. Please apply manually."
        exit 1
    fi
fi

echo "Done."
