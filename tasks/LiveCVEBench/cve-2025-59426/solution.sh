#!/bin/bash
set -e
cd /app

echo "=== Applying fix for OIDC URL redirect validation ==="

# Define the path to the vulnerable file
OIDC_URL_FILE="/app/packages/utils/src/server/correctOIDCUrl.ts"
VALIDATE_HOST_FILE="/app/packages/utils/src/server/validateRedirectHost.ts"

# Step 1: Create the new validateRedirectHost.ts file
echo "Creating validateRedirectHost.ts..."
cat > "$VALIDATE_HOST_FILE" << 'EOF'
import debug from 'debug';

const log = debug('lobe-oidc:validateRedirectHost');

/**
 * Validate if redirect host is in the allowed whitelist
 * Prevent Open Redirect attacks
 */
export const validateRedirectHost = (targetHost: string): boolean => {
  if (!targetHost || targetHost === 'null') {
    log('Invalid target host: %s', targetHost);
    return false;
  }

  // Get configured APP_URL as base domain
  const appUrl = process.env.APP_URL;
  if (!appUrl) {
    log('Warning: APP_URL not configured, rejecting redirect to: %s', targetHost);
    return false;
  }

  try {
    const appUrlObj = new URL(appUrl);
    const appHost = appUrlObj.host;

    log('Validating target host: %s against app host: %s', targetHost, appHost);

    // Exact match
    if (targetHost === appHost) {
      log('Host validation passed: exact match');
      return true;
    }

    // Allow localhost and local addresses (development environment)
    const isLocalhost =
      targetHost === 'localhost' ||
      targetHost.startsWith('localhost:') ||
      targetHost === '127.0.0.1' ||
      targetHost.startsWith('127.0.0.1:') ||
      targetHost === '0.0.0.0' ||
      targetHost.startsWith('0.0.0.0:');

    if (
      isLocalhost &&
      (appHost.includes('localhost') ||
        appHost.includes('127.0.0.1') ||
        appHost.includes('0.0.0.0'))
    ) {
      log('Host validation passed: localhost environment');
      return true;
    }

    // Check if it's a subdomain of the configured domain
    const appDomain = appHost.split(':')[0]; // Remove port number
    const targetDomain = targetHost.split(':')[0]; // Remove port number

    if (targetDomain.endsWith('.' + appDomain)) {
      log('Host validation passed: subdomain of %s', appDomain);
      return true;
    }

    console.error('Host validation failed: %s is not allowed', targetHost);
    return false;
  } catch (error) {
    console.error('Error parsing APP_URL %s: %O', appUrl, error);
    return false;
  }
};
EOF

echo "Created validateRedirectHost.ts"

# Step 2: Replace the correctOIDCUrl.ts file with the fixed version
echo "Updating correctOIDCUrl.ts with validation..."
cat > "$OIDC_URL_FILE" << 'EOF'
import debug from 'debug';
import { NextRequest } from 'next/server';

import { validateRedirectHost } from './validateRedirectHost';

const log = debug('lobe-oidc:correctOIDCUrl');

/**
 * Fix OIDC redirect URL issues in proxy environments
 * @param req - Next.js request object
 * @param url - URL object to fix
 * @returns Fixed URL object
 */
export const correctOIDCUrl = (req: NextRequest, url: URL): URL => {
  const requestHost = req.headers.get('host');
  const forwardedHost = req.headers.get('x-forwarded-host');
  const forwardedProto =
    req.headers.get('x-forwarded-proto') || req.headers.get('x-forwarded-protocol');

  log('Input URL: %s', url.toString());
  log(
    'Request headers - host: %s, x-forwarded-host: %s, x-forwarded-proto: %s',
    requestHost,
    forwardedHost,
    forwardedProto,
  );

  // Determine actual hostname and protocol with fallback values
  const actualHost = forwardedHost || requestHost;
  const actualProto = forwardedProto || (url.protocol === 'https:' ? 'https' : 'http');

  // If unable to determine valid hostname, return original URL
  if (!actualHost || actualHost === 'null') {
    log('Warning: Cannot determine valid host, returning original URL');
    return url;
  }

  // Validate target host for security, prevent Open Redirect attacks
  if (!validateRedirectHost(actualHost)) {
    log('Warning: Target host %s failed validation, returning original URL', actualHost);
    return url;
  }

  // Correct URL if it points to localhost or hostname doesn't match actual request host
  const needsCorrection =
    url.hostname === 'localhost' ||
    url.hostname === '127.0.0.1' ||
    url.hostname === '0.0.0.0' ||
    url.hostname !== actualHost;

  if (needsCorrection) {
    log('URL needs correction. Original hostname: %s, correcting to: %s', url.hostname, actualHost);

    try {
      const correctedUrl = new URL(url.toString());
      correctedUrl.protocol = actualProto + ':';
      correctedUrl.host = actualHost;

      log('Corrected URL: %s', correctedUrl.toString());
      return correctedUrl;
    } catch (error) {
      log('Error creating corrected URL, returning original: %O', error);
      return url;
    }
  }

  log('URL does not need correction, returning original: %s', url.toString());
  return url;
};
EOF

echo "Updated correctOIDCUrl.ts"

# Step 3: Update the exports if there's an index file
INDEX_FILE="/app/packages/utils/src/server/index.ts"
if [ -f "$INDEX_FILE" ]; then
    # Check if validateRedirectHost is already exported
    if ! grep -q "validateRedirectHost" "$INDEX_FILE"; then
        echo "Adding validateRedirectHost export to index.ts..."
        echo "export * from './validateRedirectHost';" >> "$INDEX_FILE"
    fi
fi

echo "=== Fix applied successfully ==="
echo "Changes made:"
echo "  1. Created validateRedirectHost.ts with host validation logic"
echo "  2. Updated correctOIDCUrl.ts to use validateRedirectHost"
echo ""
echo "The fix validates redirect hosts against APP_URL environment variable."
echo "External domains are now rejected, preventing open redirect attacks."
