#!/bin/bash
set -e
cd /app

echo "Applying fix for poll submission input validation..."

# The fix requires:
# 1. Adding import for ValidationError
# 2. Adding size validation check for answerIds array (max 100 elements)

# Target file
TARGET_FILE="/app/src/actions/pollSubmitUserVote.ts"

# Check if the file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo "Error: Target file not found at $TARGET_FILE"
    exit 1
fi

# Check if fix is already applied
if grep -q "input.answerIds.length > 100" "$TARGET_FILE"; then
    echo "Fix already applied, skipping..."
    exit 0
fi

# Step 1: Add the ValidationError import after the existing validation import
# Find the line with throwErrorIfInvalidInput import and add ValidationError import after it
sed -i 's|import {throwErrorIfInvalidInput} from "../imports/validation";|import {throwErrorIfInvalidInput} from "../imports/validation";\nimport {ValidationError} from "../types/ValidationError";|' "$TARGET_FILE"

# Step 2: Add the validation check after the eventName declaration
# The check should reject arrays with more than 100 elements
sed -i '/const eventName = `RespondToPollReqMsg`;/a\
\
  if(Array.isArray(input.answerIds) \&\& input.answerIds.length > 100) {\
    throw new ValidationError('\''Parameter `answerIds` exceeds the maximum allowed limit of 100 options'\'', 400);\
  }' "$TARGET_FILE"

echo "Fix applied successfully."

# Verify the fix was applied
if grep -q "input.answerIds.length > 100" "$TARGET_FILE"; then
    echo "Verification: Fix confirmed in place."
else
    echo "Warning: Fix may not have been applied correctly."
    exit 1
fi

# Restart any running Node.js service if present
if pgrep -f "node.*bbb-graphql-actions" > /dev/null 2>&1; then
    echo "Restarting bbb-graphql-actions service..."
    pkill -f "node.*bbb-graphql-actions" || true
    sleep 2
fi

echo "Solution applied successfully."
