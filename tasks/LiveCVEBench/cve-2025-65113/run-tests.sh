#!/bin/bash
set -e

# Change to tests directory
cd "$(dirname "$0")"

# Install uv package manager
echo "[*] Installing uv package manager..."
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize uv project and install dependencies
echo "[*] Setting up test environment..."
uv init 2>/dev/null || true
uv add pytest requests 2>/dev/null

# Set target URL (default to localhost)
export TARGET_URL="${TARGET_URL:-http://localhost}"
echo "[*] Running tests against: $TARGET_URL"

# Wait for application to be available
echo "[*] Waiting for application to be ready..."
MAX_WAIT=60
WAITED=0
while ! curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL" 2>/dev/null | grep -q "^[23]"; do
    if [ $WAITED -ge $MAX_WAIT ]; then
        echo "[!] Application not available after ${MAX_WAIT}s, proceeding anyway..."
        break
    fi
    sleep 2
    WAITED=$((WAITED + 2))
    echo "[*] Waiting... ($WAITED/$MAX_WAIT seconds)"
done

echo "[*] Running pytest..."
uv run pytest . -rA -v
