FROM wordpress:6.4-php8.1-apache

WORKDIR /var/www/html

# System dependencies required for tests
RUN apt-get update && apt-get install -y \
    default-mysql-client \
    curl \
    tmux \
    asciinema \
    && rm -rf /var/lib/apt/lists/*

# Install WP-CLI for WordPress management
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
    && chmod +x wp-cli.phar \
    && mv wp-cli.phar /usr/local/bin/wp

# Copy the vulnerable plugin
COPY task-deps/custom-admin-menu /var/www/html/wp-content/plugins/custom-admin-menu

# Remove .git directory if exists (prevent solution leakage)
RUN rm -rf /var/www/html/wp-content/plugins/custom-admin-menu/.git

# Copy and setup entrypoint
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Set proper ownership for WordPress files
RUN chown -R www-data:www-data /var/www/html

# WordPress database configuration (via environment variables in compose)
ENV WORDPRESS_DB_HOST=db:3306
ENV WORDPRESS_DB_USER=wordpress
ENV WORDPRESS_DB_PASSWORD=wordpress
ENV WORDPRESS_DB_NAME=wordpress


# CMD ["/entrypoint.sh"]
