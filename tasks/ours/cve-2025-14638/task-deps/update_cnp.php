<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="images/foods/logo.png" rel="shortcut icon">
    <title>ADMIN | Petshop Online Website</title>

    <!-- core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/prettyPhoto.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <link href="css/responsive.css" rel="stylesheet">

</head><!--/head-->
<body>
      <nav class="navbar navbar-inverse" role="banner">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                     <a href="index.php"><img src="images/logo.jpg"  width="35% " /><i class="wow fadeInDown" style="margin-top:-2%; color:#FFF;"></i></a>
                </div>

                <div class="collapse navbar-collapse navbar-right">
                    <ul class="nav navbar-nav">
                        <li class="dropdown active"><a class="dropdown-toggle wow fadeInDown" data-toggle="dropdown" href="#"><span class="glyphicon glyphicon-th"></span> Product <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                              <li><a href="addcnp.php"> Add Product </a></li>
                              <li><a href="update_cnp.php"> Update Product </a></li>
                            </ul>
                        </li>
                        <li id="reservation" class="wow fadeInDown"><a href="index.php"><span class="glyphicon glyphicon-calendar"></span> Orders</a></li>
                        <li id="admin" class="wow fadeInDown"><a href="adminacc.php"><span class="glyphicon glyphicon-user"></span> Admin Account</a></li>
                        <li id="logout" class="wow fadeInDown"><a id="logoutbtn" href='<?php echo "logout_process.php?logout=1"?>'><span class="glyphicon glyphicon-share"></span> Logout</a></li>
                    </ul>
                </div>
            </div><!--/.container-->
        </nav><!--/nav-->
<br>

<div class="container">
    <h3 class="wow fadeInDown">Update Products</h3>
    <hr>
    <table class="table table-responsive table-hover" style="border: 1px dashed #8c8b8b;">
        <thead>
            <tr>
                <th>No.</th>
                <th>Image</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
<?php
session_start();
include('includes/dbconn.php');
$count = 0;

// Check if update action is requested - VULNERABLE: $id is used directly in SQL query
if(isset($_POST['update'])){
    $id = $_POST['id'];
    $name = $_POST['name'];
    $prize = $_POST['prize'];
    $description = $_POST['description'];
    $status = $_POST['status'];

    // VULNERABLE SQL INJECTION - id parameter is not sanitized
    $sql = ("UPDATE tblcnp SET name='$name', prize='$prize', description='$description', status='$status' WHERE id='$id'") or die (mysqli_error());
    $result = mysqli_query($con, $sql);

    if($result){
        echo '<script>alert("Product Updated Successfully!");
              window.location.href="update_cnp.php";</script>';
    } else {
        echo '<script>alert("Error updating product!");
              window.location.href="update_cnp.php";</script>';
    }
}

// Fetch products for display
$sql = "SELECT * FROM tblcnp ORDER BY id DESC" or die (mysqli_error($con));
$result = mysqli_query($con, $sql) or die (mysqli_error($con));

if(mysqli_num_rows($result) >= 0){
    while($row = mysqli_fetch_assoc($result)){
        $id = $row['id'];
        $name = $row['name'];
        $prize = $row['prize'];
        $description = $row['description'];
        $image = $row['image'];
        $status = $row['status'];
        $count++;
?>
        <tr style="border: 1px dashed #8c8b8b;">
            <td><?php echo $count;?></td>
            <td><img src="<?php echo $image?>" width="80px" class="img-responsive img-rounded"></td>
            <td><?php echo $name;?></td>
            <td><?php echo $description;?></td>
            <td><?php echo $prize;?></td>
            <td><?php echo $status;?></td>
            <td>
                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#updateModal<?php echo $id;?>">
                    <i class="glyphicon glyphicon-edit"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteModal<?php echo $id;?>">
                    <i class="glyphicon glyphicon-trash"></i> Delete
                </button>
            </td>
        </tr>

<!-- Update Modal -->
<div class="modal fade" id="updateModal<?php echo $id;?>" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel"><i class="glyphicon glyphicon-edit"></i> UPDATE PRODUCT</h4>
      </div>
      <form method="post" action="update_cnp.php">
      <div class="modal-body">
        <input type="hidden" name="id" value="<?php echo $id;?>">
        <div class="form-group">
            <label>Product Name</label>
            <input type="text" class="form-control" name="name" value="<?php echo $name;?>" required>
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea class="form-control" name="description" required><?php echo $description;?></textarea>
        </div>
        <div class="form-group">
            <label>Price</label>
            <input type="text" class="form-control" name="prize" value="<?php echo $prize;?>" required>
        </div>
        <div class="form-group">
            <label>Status</label>
            <select name="status" class="form-control" required>
                <option value="Available" <?php if($status == 'Available') echo 'selected'; ?>>Available</option>
                <option value="Un-Available" <?php if($status == 'Un-Available') echo 'selected'; ?>>Un-Available</option>
            </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="submit" name="update" class="btn btn-primary"><i class="glyphicon glyphicon-floppy-disk"></i> Save Changes</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal<?php echo $id?>" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel"><i class="glyphicon glyphicon-exclamation-sign"></i> CONFIRMATION</h4>
      </div>
      <form method="post" action="deletemodalprocess.php">
      <div class="modal-body">
       <h3>Are you sure your want to delete <strong style="color:red;"><u><?php echo $name;?></u>?</strong></h3>
       <input type="hidden" name="id" value="<?php echo $id?>">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="submit" name="delete" class="btn btn-danger"><i class="glyphicon glyphicon-trash"></i> Delete</button>
      </div>
      </form>
    </div>
  </div>
</div>

<?php
    }
} else {
    echo '<tr><td colspan="7" style="color:red; text-align:center;">No products available</td></tr>';
}
?>
        </tbody>
    </table>
</div>

<br>
<!--*************************************************** FOOTERS **********************************************-->

    <footer id="footer" class="midnight-blue">
        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <center>&copy; 2019 <a target="_blank" href="#" title="#">Petshop Online Website</a>. All Rights Reserved.</center>
                </div>
            </div>
        </div>
    </footer><!--/#footer-->

</script>

    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.prettyPhoto.js"></script>
    <script src="js/jquery.isotope.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/wow.min.js"></script>
</body>
</html>
