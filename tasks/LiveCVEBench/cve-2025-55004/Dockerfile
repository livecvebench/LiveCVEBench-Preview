FROM ubuntu:22.04

WORKDIR /app

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# System dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    pkg-config \
    autoconf \
    automake \
    libtool \
    libltdl-dev \
    libjpeg-dev \
    libpng-dev \
    libtiff-dev \
    libgif-dev \
    libfreetype6-dev \
    liblcms2-dev \
    libxml2-dev \
    libfontconfig1-dev \
    libx11-dev \
    libxext-dev \
    zlib1g-dev \
    python3 \
    python3-pip \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Clone and checkout vulnerable version
RUN git clone https://github.com/ImageMagick/ImageMagick.git . && \
    git checkout 7.1.2-0 && \
    rm -rf .git

# Build with AddressSanitizer for vulnerability detection
RUN ./configure CC="gcc" \
    CFLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer" \
    LDFLAGS="-fsanitize=address" && \
    make -j$(nproc) && \
    make install && \
    ldconfig /usr/local/lib

# Environment variables
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV ASAN_OPTIONS=detect_leaks=0:halt_on_error=0

# Verify installation
RUN magick -version

# Create workspace for testing
WORKDIR /workspace

# Keep container running
CMD ["bash"]
RUN mkdir -p /tests /oracle
