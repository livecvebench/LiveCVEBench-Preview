#!/bin/bash
# Solution script for tcprewrite use-after-free vulnerability (CVE-2025-9157)
# This script applies the fix to prevent the use-after-free condition that occurs
# when processing truncated packets with --fixlen pad option.
set -e

cd /app

echo "Applying fix for tcprewrite memory issue..."

# Fix: Remove the unsafe safe_realloc() call in edit_packet.c
# The reallocation is unnecessary because the buffer is already large enough
# (allocated with MAX_SNAPLEN + PACKET_HEADROOM in rewrite_packets()).
# This realloc causes use-after-free when it moves the buffer to a new location
# while existing pointers (like ip_hdr) still reference the old location.
#
# The root cause explained:
# 1. Before realloc: ip_hdr points into the packet buffer at some offset
# 2. During realloc: safe_realloc may move buffer to new memory and FREE original
# 3. After realloc: packet pointer is updated, but ip_hdr still points to OLD memory
# 4. Use-after-free: fix_ipv4_checksums() accesses ip_hdr which is freed memory
#
# Why removing realloc is safe:
# - The buffer is already allocated with MAX_SNAPLEN + PACKET_HEADROOM
# - Since pkthdr.len must be <= MAX_SNAPLEN, existing buffer can accommodate padding
# - Without reallocation, all pointers into the buffer remain valid

if grep -q "packet = safe_realloc(packet, pkthdr->len + PACKET_HEADROOM);" src/tcpedit/edit_packet.c; then
    sed -i '/packet = safe_realloc(packet, pkthdr->len + PACKET_HEADROOM);/d' src/tcpedit/edit_packet.c
    echo "Fixed: Removed unsafe realloc in edit_packet.c"
else
    # Try a more flexible pattern in case of whitespace differences
    if grep -q "safe_realloc.*pkthdr->len.*PACKET_HEADROOM" src/tcpedit/edit_packet.c; then
        sed -i '/safe_realloc.*pkthdr->len.*PACKET_HEADROOM/d' src/tcpedit/edit_packet.c
        echo "Fixed: Removed unsafe realloc in edit_packet.c (flexible match)"
    else
        echo "Primary fix already applied or line not found"
    fi
fi

# Rebuild and install the affected binary
echo "Rebuilding tcprewrite..."
make && make install

echo "Fix applied successfully."
