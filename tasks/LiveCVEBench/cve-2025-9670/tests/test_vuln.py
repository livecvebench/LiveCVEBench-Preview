"""
Vulnerability tests for CVE-2025-9670: ReDoS in turndown library.

These tests verify the ReDoS vulnerability is FIXED by checking that
the vulnerable regex patterns have been replaced with safe iterative functions.

The vulnerability occurs in regex patterns:
- /\\n+$/ (listItem rule) 
- /^\\n+|\\n+$/g (blockquote rule)

Test behavior:
- FAIL in vulnerable state: Vulnerable patterns still exist in library code
- PASS in fixed state: Patterns replaced with trimNewlines function
"""

import subprocess
import pytest
import json


def run_node_script(script: str, timeout: int = 30) -> subprocess.CompletedProcess:
    """Execute a Node.js script and return the result."""
    return subprocess.run(
        ['node', '-e', script],
        capture_output=True,
        text=True,
        timeout=timeout,
        cwd='/app'
    )


class TestBlockquoteVulnerability:
    """Test that vulnerable blockquote regex pattern is removed."""

    def test_blockquote_vulnerable_pattern_removed(self):
        """
        Verify the vulnerable blockquote regex is removed.
        - FAIL: Vulnerable pattern found (library is vulnerable)
        - PASS: Vulnerable pattern removed (library is fixed)
        """
        script = r'''
const fs = require('fs');
const libPath = '/app/node_modules/turndown/lib/turndown.cjs.js';
const code = fs.readFileSync(libPath, 'utf8');
const hasVulnerableBlockquote = /content\s*=\s*content\.replace\(\/\^\\n\+\|\\n\+\$\/g,\s*''\)/.test(code);
console.log(JSON.stringify({ hasVulnerableBlockquote }));
'''
        result = run_node_script(script, timeout=10)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout)
        assert not data['hasVulnerableBlockquote'], (
            "VULNERABLE: Blockquote regex /^\\n+|\\n+$/g found. "
            "Fix by replacing with trimNewlines()."
        )


class TestListItemVulnerability:
    """Test that vulnerable listItem regex pattern is removed."""

    def test_listitem_vulnerable_pattern_removed(self):
        """
        Verify the vulnerable listItem regex is removed.
        - FAIL: Vulnerable pattern found (library is vulnerable)
        - PASS: Vulnerable pattern removed (library is fixed)
        """
        script = r'''
const fs = require('fs');
const libPath = '/app/node_modules/turndown/lib/turndown.cjs.js';
const code = fs.readFileSync(libPath, 'utf8');
const hasVulnerableListItem = /\.replace\(\/\\n\+\$\/,\s*'\\n'\)/.test(code);
console.log(JSON.stringify({ hasVulnerableListItem }));
'''
        result = run_node_script(script, timeout=10)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout)
        assert not data['hasVulnerableListItem'], (
            "VULNERABLE: ListItem regex /\\n+$/ found. "
            "Fix by replacing with iterative trimming."
        )


class TestFixApplied:
    """Test that the safe trimming functions are added."""

    def test_trimNewlines_function_exists(self):
        """
        Verify the safe trimNewlines function is added.
        - FAIL: Safe function not found (fix not applied)
        - PASS: Safe function exists (fix applied)
        """
        script = r'''
const fs = require('fs');
const libPath = '/app/node_modules/turndown/lib/turndown.cjs.js';
const code = fs.readFileSync(libPath, 'utf8');
const hasTrimNewlines = code.includes('function trimNewlines');
const usesTrimNewlines = code.includes('trimNewlines(content)');
console.log(JSON.stringify({ hasTrimNewlines, usesTrimNewlines }));
'''
        result = run_node_script(script, timeout=10)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout)
        assert data['hasTrimNewlines'], "FIX NOT APPLIED: trimNewlines function not found."
        assert data['usesTrimNewlines'], "FIX INCOMPLETE: trimNewlines not being used."
