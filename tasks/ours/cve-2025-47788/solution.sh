#!/bin/bash
# Solution script for Atheos controller.php path traversal vulnerability
# This script applies the fix to sanitize the target parameter using Common::cleanPath()

set -e
cd /var/www/html

echo "[*] Applying fix to controller.php..."

# Backup original file
cp controller.php controller.php.bak 2>/dev/null || true

# The fix requires two changes:
# 1. Add $target = Common::cleanPath($target); after $target = POST("target");
# 2. Add $componentPath = Common::cleanPath(...); and use it in file_exists()

# Apply fix using sed:

# Fix 1: Add sanitization right after $target = POST("target");
# Look for the line '$target = POST("target");' and add the cleanPath call after it
sed -i 's/\$target = POST("target");/\$target = POST("target");\n\$target = Common::cleanPath(\$target);/' controller.php

# Fix 2: Add $componentPath variable before the if statement that checks file_exists
# Replace: if (file_exists("components/$target/controller.php")) {
# With:    $componentPath = Common::cleanPath("components/$target/controller.php");
#          if (file_exists($componentPath)) {
sed -i 's/if (file_exists("components\/\$target\/controller\.php")) {/\$componentPath = Common::cleanPath("components\/\$target\/controller.php");\n\nif (file_exists(\$componentPath)) {/' controller.php

# Fix 3: Update the require statement to use $componentPath
# Replace: require("components/$target/controller.php");
# With:    require($componentPath);
sed -i 's/require("components\/\$target\/controller\.php");/require(\$componentPath);/' controller.php

echo "[+] Fix applied to controller.php"

# Verify the fix was applied
if grep -q 'Common::cleanPath(\$target)' controller.php; then
    echo "[+] Verification: cleanPath sanitization found"
else
    echo "[-] Warning: cleanPath sanitization may not have been applied correctly"
fi

if grep -q '\$componentPath' controller.php; then
    echo "[+] Verification: componentPath variable found"
else
    echo "[-] Warning: componentPath variable may not have been applied correctly"
fi

# Restart Apache to ensure changes take effect (PHP with mod_php doesn't require restart,
# but do it anyway for good measure)
if command -v apache2ctl &> /dev/null; then
    apache2ctl graceful 2>/dev/null || true
elif command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
fi

echo "[+] Solution applied successfully"
