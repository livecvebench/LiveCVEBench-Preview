"""
Functional tests for the Online Student Enrollment System.
These tests verify basic functionality works correctly in both vulnerable and fixed states.
"""
import requests
import time
import random
import string
import io


BASE_URL = "http://localhost/student_enrollment"
REGISTER_URL = f"{BASE_URL}/admin/register.php"


def random_string(length=8):
    """Generate a random string for unique test data."""
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))


def create_minimal_jpg():
    """Create a minimal valid JPEG image (1x1 red pixel)."""
    # Minimal JPEG binary data
    return bytes([
        0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01,
        0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
        0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08, 0x07, 0x07, 0x07, 0x09,
        0x09, 0x08, 0x0A, 0x0C, 0x14, 0x0D, 0x0C, 0x0B, 0x0B, 0x0C, 0x19, 0x12,
        0x13, 0x0F, 0x14, 0x1D, 0x1A, 0x1F, 0x1E, 0x1D, 0x1A, 0x1C, 0x1C, 0x20,
        0x24, 0x2E, 0x27, 0x20, 0x22, 0x2C, 0x23, 0x1C, 0x1C, 0x28, 0x37, 0x29,
        0x2C, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1F, 0x27, 0x39, 0x3D, 0x38, 0x32,
        0x3C, 0x2E, 0x33, 0x34, 0x32, 0xFF, 0xC0, 0x00, 0x0B, 0x08, 0x00, 0x01,
        0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xFF, 0xC4, 0x00, 0x1F, 0x00, 0x00,
        0x01, 0x05, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
        0x09, 0x0A, 0x0B, 0xFF, 0xC4, 0x00, 0xB5, 0x10, 0x00, 0x02, 0x01, 0x03,
        0x03, 0x02, 0x04, 0x03, 0x05, 0x05, 0x04, 0x04, 0x00, 0x00, 0x01, 0x7D,
        0x01, 0x02, 0x03, 0x00, 0x04, 0x11, 0x05, 0x12, 0x21, 0x31, 0x41, 0x06,
        0x13, 0x51, 0x61, 0x07, 0x22, 0x71, 0x14, 0x32, 0x81, 0x91, 0xA1, 0x08,
        0x23, 0x42, 0xB1, 0xC1, 0x15, 0x52, 0xD1, 0xF0, 0x24, 0x33, 0x62, 0x72,
        0x82, 0x09, 0x0A, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x25, 0x26, 0x27, 0x28,
        0x29, 0x2A, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3A, 0x43, 0x44, 0x45,
        0x46, 0x47, 0x48, 0x49, 0x4A, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59,
        0x5A, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x73, 0x74, 0x75,
        0x76, 0x77, 0x78, 0x79, 0x7A, 0x83, 0x84, 0x85, 0x86, 0x87, 0x88, 0x89,
        0x8A, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97, 0x98, 0x99, 0x9A, 0xA2, 0xA3,
        0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6,
        0xB7, 0xB8, 0xB9, 0xBA, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9,
        0xCA, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9, 0xDA, 0xE1, 0xE2,
        0xE3, 0xE4, 0xE5, 0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xF1, 0xF2, 0xF3, 0xF4,
        0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFF, 0xDA, 0x00, 0x08, 0x01, 0x01,
        0x00, 0x00, 0x3F, 0x00, 0xFB, 0xD5, 0xDB, 0x20, 0xA8, 0xE8, 0x00, 0x07,
        0xFF, 0xD9
    ])


def create_minimal_png():
    """Create a minimal valid PNG image (1x1 red pixel)."""
    return bytes([
        0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D,
        0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53, 0xDE, 0x00, 0x00, 0x00,
        0x0C, 0x49, 0x44, 0x41, 0x54, 0x08, 0xD7, 0x63, 0xF8, 0xCF, 0xC0, 0x00,
        0x00, 0x00, 0x03, 0x00, 0x01, 0x00, 0x18, 0xDD, 0x8D, 0xB4, 0x00, 0x00,
        0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82
    ])


class TestApplicationAvailability:
    """Test that the application is accessible and running."""

    def test_homepage_accessible(self):
        """Test that the main homepage is accessible."""
        response = requests.get(BASE_URL, timeout=10)
        assert response.status_code == 200, f"Homepage not accessible, got status {response.status_code}"

    def test_registration_page_loads(self):
        """Test that the registration page loads correctly."""
        response = requests.get(REGISTER_URL, timeout=10)
        assert response.status_code == 200, f"Registration page not accessible, got status {response.status_code}"
        assert 'Register' in response.text, "Registration page does not contain expected content"
        assert 'form' in response.text.lower(), "Registration page does not contain a form"

    def test_registration_form_has_required_fields(self):
        """Test that the registration form contains all required input fields."""
        response = requests.get(REGISTER_URL, timeout=10)
        html = response.text.lower()

        assert 'name="name"' in html, "Form missing name field"
        assert 'name="email"' in html, "Form missing email field"
        assert 'name="username"' in html, "Form missing username field"
        assert 'name="password"' in html, "Form missing password field"
        assert 'name="photo"' in html or 'name="photo"' in response.text, "Form missing photo upload field"


class TestValidImageUpload:
    """Test that valid image uploads work correctly."""

    def test_jpg_upload_accepted(self):
        """Test that uploading a valid JPG file is accepted."""
        username = f"testuser{random_string(8)}"
        email = f"test_{random_string(6)}@example.com"

        data = {
            'name': 'Test User',
            'email': email,
            'username': username,
            'password': 'password123',
            'c_password': 'password123',
            'register': 'Register!'
        }

        files = {
            'photo': ('profile.jpg', create_minimal_jpg(), 'image/jpeg')
        }

        response = requests.post(REGISTER_URL, data=data, files=files, allow_redirects=False, timeout=15)

        # Should either succeed with redirect or show the page
        # Success indicated by redirect to ?insert=sucess (note: typo in original code)
        is_success = (
            response.status_code == 302 or
            'insert=sucess' in response.headers.get('Location', '') or
            'insert=sucess' in response.url if hasattr(response, 'url') else False
        )

        # If not redirect, allow the request but verify no critical errors
        if not is_success:
            # Check it wasn't a server error
            assert response.status_code != 500, "Server error when uploading valid JPG"

    def test_png_upload_accepted(self):
        """Test that uploading a valid PNG file is accepted."""
        username = f"testpng{random_string(8)}"
        email = f"png_{random_string(6)}@example.com"

        data = {
            'name': 'PNG Test User',
            'email': email,
            'username': username,
            'password': 'password123',
            'c_password': 'password123',
            'register': 'Register!'
        }

        files = {
            'photo': ('profile.png', create_minimal_png(), 'image/png')
        }

        response = requests.post(REGISTER_URL, data=data, files=files, allow_redirects=False, timeout=15)

        # Should either succeed or show the form (no server error)
        assert response.status_code != 500, "Server error when uploading valid PNG"


class TestFormValidation:
    """Test the form validation requirements."""

    def test_short_username_rejected(self):
        """Test that usernames with 7 or fewer characters are rejected."""
        username = "short"  # Only 5 characters
        email = f"short_{random_string(6)}@example.com"

        data = {
            'name': 'Short Username Test',
            'email': email,
            'username': username,
            'password': 'password123',
            'c_password': 'password123',
            'register': 'Register!'
        }

        files = {
            'photo': ('profile.jpg', create_minimal_jpg(), 'image/jpeg')
        }

        response = requests.post(REGISTER_URL, data=data, files=files, timeout=15)

        # Should NOT redirect to success
        assert 'insert=sucess' not in response.url, "Short username was accepted but should be rejected"
        # Should contain error message about username length
        assert 'charset' in response.text.lower() or 'more than' in response.text.lower() or response.status_code == 200

    def test_short_password_rejected(self):
        """Test that passwords with 7 or fewer characters are rejected."""
        username = f"longusername{random_string(4)}"
        email = f"shortpw_{random_string(6)}@example.com"

        data = {
            'name': 'Short Password Test',
            'email': email,
            'username': username,
            'password': 'short',  # Only 5 characters
            'c_password': 'short',
            'register': 'Register!'
        }

        files = {
            'photo': ('profile.jpg', create_minimal_jpg(), 'image/jpeg')
        }

        response = requests.post(REGISTER_URL, data=data, files=files, timeout=15)

        # Should NOT redirect to success
        assert 'insert=sucess' not in response.url, "Short password was accepted but should be rejected"

    def test_mismatched_passwords_rejected(self):
        """Test that mismatched passwords are rejected."""
        username = f"mismatch{random_string(8)}"
        email = f"mismatch_{random_string(6)}@example.com"

        data = {
            'name': 'Password Mismatch Test',
            'email': email,
            'username': username,
            'password': 'password123',
            'c_password': 'differentpassword',  # Different
            'register': 'Register!'
        }

        files = {
            'photo': ('profile.jpg', create_minimal_jpg(), 'image/jpeg')
        }

        response = requests.post(REGISTER_URL, data=data, files=files, timeout=15)

        # Should NOT redirect to success
        assert 'insert=sucess' not in response.url, "Mismatched passwords were accepted but should be rejected"
        # Should show error about password mismatch
        assert 'wrong' in response.text.lower() or 'mismatch' in response.text.lower() or response.status_code == 200
