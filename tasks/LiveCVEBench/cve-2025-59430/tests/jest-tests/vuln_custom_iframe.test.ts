import { createLink } from '../Link'

jest.mock('@meshconnect/uwc-bridge-parent', () => ({
  BridgeParent: jest.fn().mockImplementation(() => ({
    destroy: jest.fn()
  }))
}))

describe('Vulnerability: Custom Iframe with Malicious URL', () => {
  beforeEach(() => {
    document.getElementsByTagName('html')[0].innerHTML = ''
  })

  test('javascript: with customIframeId should still be rejected', () => {
    const customIframeId = 'target-iframe'
    const customIframe = document.createElement('iframe')
    customIframe.id = customIframeId
    document.body.appendChild(customIframe)

    const exitFunction = jest.fn<void, [string | undefined]>()
    const payload = Buffer.from('javascript:alert(document.domain)//').toString('base64')

    const frontConnection = createLink({
      clientId: 'test',
      onIntegrationConnected: jest.fn(),
      onExit: exitFunction
    })

    frontConnection.openLink(payload, customIframeId)

    expect(exitFunction).toHaveBeenCalledWith('Invalid link token!')

    // Custom iframe src should NOT be set to malicious URL
    const iframeSrc = customIframe.attributes.getNamedItem('src')?.nodeValue
    // When fix is applied, src should be undefined (never set) or at least not contain javascript:
    expect(iframeSrc === undefined || !iframeSrc.includes('javascript:')).toBe(true)
  })

  test('data: with customIframeId should still be rejected', () => {
    const customIframeId = 'target-iframe-2'
    const customIframe = document.createElement('iframe')
    customIframe.id = customIframeId
    document.body.appendChild(customIframe)

    const exitFunction = jest.fn<void, [string | undefined]>()
    const payload = Buffer.from('data:text/html,<script>alert(1)</script>').toString('base64')

    const frontConnection = createLink({
      clientId: 'test',
      onIntegrationConnected: jest.fn(),
      onExit: exitFunction
    })

    frontConnection.openLink(payload, customIframeId)

    expect(exitFunction).toHaveBeenCalledWith('Invalid link token!')

    // Custom iframe src should NOT be set to data: URL
    const iframeSrc = customIframe.attributes.getNamedItem('src')?.nodeValue
    // When fix is applied, src should be undefined (never set) or at least not contain data:
    expect(iframeSrc === undefined || !iframeSrc.includes('data:')).toBe(true)
  })
})
