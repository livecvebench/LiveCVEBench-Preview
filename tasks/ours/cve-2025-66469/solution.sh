#!/bin/bash
set -e

echo "Applying fix for HTML injection vulnerability in NiceGUI CSS functions..."

# Find the installed nicegui path
NICEGUI_PATH=$(python -c "import nicegui; print(nicegui.__path__[0])")
echo "NiceGUI installed at: ${NICEGUI_PATH}"

STYLE_FILE="${NICEGUI_PATH}/functions/style.py"
INDEX_FILE="${NICEGUI_PATH}/templates/index.html"

echo "Patching ${STYLE_FILE}..."

# Create the fixed style.py content
cat > "${STYLE_FILE}" << 'STYLE_EOF'
from pathlib import Path
from typing import Union

from .. import helpers, json
from .html import add_head_html


def add_css(content: Union[str, Path], *, shared: bool = False) -> None:
    """Add CSS style definitions to the page.

    This function can be used to add CSS style definitions to the head of the HTML page.

    *Added in version 2.0.0*

    :param content: CSS content (string or file path)
    :param shared: whether to add the code to all pages (default: ``False``, *added in version 2.14.0*)
    """
    if helpers.is_file(content):
        content = Path(content).read_text(encoding='utf-8')
    safe_content = json.dumps(content).replace('<', r'\u003c')
    add_head_html(f'<script>addStyle({safe_content});</script>', shared=shared)


def add_scss(content: Union[str, Path], *, indented: bool = False, shared: bool = False) -> None:  # DEPRECATED
    """Add SCSS style definitions to the page (deprecated).

    This function can be used to add SCSS style definitions to the head of the HTML page.

    *Added in version 2.0.0*

    **Note: This function is deprecated and will be removed in NiceGUI 4.0. Use add_css instead.**

    :param content: SCSS content (string or file path)
    :param indented: whether the content is indented (SASS) or not (SCSS) (default: `False`)
    :param shared: whether to add the code to all pages (default: ``False``, *added in version 2.14.0*)
    """
    content = Path(content).read_text(encoding='utf-8') if helpers.is_file(content) else str(content).strip()
    syntax = 'indented' if indented else 'scss'
    safe_content = json.dumps(content).replace('<', r'\u003c')
    add_head_html(f'''
    <script type="module">
    import * as sass from "sass";
    addStyle(sass.compileString({safe_content}, {{syntax: "{syntax}"}}).css);
    </script>
    ''', shared=shared)


def add_sass(content: Union[str, Path], *, shared: bool = False) -> None:  # DEPRECATED
    """Add SASS style definitions to the page (deprecated).

    This function can be used to add SASS style definitions to the head of the HTML page.

    *Added in version 2.0.0*

    **Note: This function is deprecated and will be removed in NiceGUI 4.0. Use add_css instead.**

    :param content: SASS content (string or file path)
    :param shared: whether to add the code to all pages (default: ``False``, *added in version 2.14.0*)
    """
    add_scss(content, indented=True, shared=shared)
STYLE_EOF

echo "Patching ${INDEX_FILE} to add addStyle function..."

# Add the addStyle function to index.html if not already present
if ! grep -q "addStyle" "${INDEX_FILE}"; then
    # Insert the addStyle script before </head>
    sed -i 's|</head>|<script>addStyle = (c) => document.head.append(Object.assign(document.createElement("style"), { textContent: c }));</script>\n</head>|' "${INDEX_FILE}"
    echo "Added addStyle function to index.html"
else
    echo "addStyle function already present in index.html"
fi

echo "Fix applied successfully!"

# Clear Python bytecode cache to ensure the new code takes effect
echo "Clearing Python bytecode cache..."
find "${NICEGUI_PATH}" -type f -name "*.pyc" -delete 2>/dev/null || true
find "${NICEGUI_PATH}" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

# Restart the NiceGUI application using Python to send SIGTERM
# (pkill/kill not available in slim Python image)
echo "Restarting NiceGUI application..."
python -c "
import os
import signal

# Find and kill the app.py process
for pid_dir in os.listdir('/proc'):
    if pid_dir.isdigit():
        try:
            with open(f'/proc/{pid_dir}/cmdline', 'r') as f:
                cmdline = f.read()
                if 'app.py' in cmdline and pid_dir != str(os.getpid()):
                    print(f'Killing process {pid_dir}')
                    os.kill(int(pid_dir), signal.SIGTERM)
        except (IOError, ProcessLookupError, PermissionError):
            pass
" 2>/dev/null || true

# Wait for the entrypoint to restart the application
sleep 3

echo "Fix complete! Application restarted."
