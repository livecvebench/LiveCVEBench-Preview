#!/bin/bash
# Wait for WordPress files to be ready and set up the environment

set -e

echo "WordPress setup script started..."

# Wait for WordPress docker-entrypoint to copy files
echo "Waiting for WordPress files to be ready..."
max_tries=60
count=0
while [ ! -f /var/www/html/wp-includes/version.php ]; do
    count=$((count+1))
    if [ $count -gt $max_tries ]; then
        echo "ERROR: WordPress files not ready after $max_tries attempts"
        exit 1
    fi
    echo "Waiting for WordPress files... ($count/$max_tries)"
    sleep 2
done

echo "WordPress files are ready!"

# Wait for database to be available
echo "Waiting for database connection..."
max_tries=60
count=0
while ! mysql -h"$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" -e "SELECT 1" >/dev/null 2>&1; do
    count=$((count+1))
    if [ $count -gt $max_tries ]; then
        echo "ERROR: Could not connect to database after $max_tries attempts"
        exit 1
    fi
    echo "Waiting for database... ($count/$max_tries)"
    sleep 2
done

echo "Database connection successful!"

# Give the WordPress entrypoint time to create wp-config.php
sleep 5

# Copy the LatePoint plugin to the plugins directory
if [ -d /usr/src/latepoint-plugin/latepoint ] && [ ! -d /var/www/html/wp-content/plugins/latepoint ]; then
    echo "Copying LatePoint plugin..."
    cp -r /usr/src/latepoint-plugin/latepoint /var/www/html/wp-content/plugins/
    chown -R www-data:www-data /var/www/html/wp-content/plugins/latepoint
    echo "LatePoint plugin copied successfully!"
fi

# Check if WordPress is already installed
if ! wp core is-installed --allow-root --path=/var/www/html 2>/dev/null; then
    echo "Installing WordPress..."

    # Install WordPress (using localhost without port for internal container access)
    wp core install \
        --url="http://localhost" \
        --title="CVE-2025-6715 Test Site" \
        --admin_user="admin" \
        --admin_password="admin123" \
        --admin_email="admin@example.com" \
        --allow-root \
        --path=/var/www/html

    echo "WordPress installed successfully!"

    # Set permalinks to post name for clean URLs
    wp rewrite structure '/%postname%/' --allow-root --path=/var/www/html
    wp rewrite flush --allow-root --path=/var/www/html

    echo "Permalinks configured!"
else
    echo "WordPress is already installed."
fi

# Activate LatePoint plugin if not already active
if [ -d /var/www/html/wp-content/plugins/latepoint ]; then
    echo "Activating LatePoint plugin..."
    wp plugin activate latepoint --allow-root --path=/var/www/html 2>/dev/null || echo "Plugin may already be active"
    echo "LatePoint plugin activation attempted!"
fi

# Check if customer-cabinet page exists, if not create it
if ! wp post list --post_type=page --name=customer-cabinet --allow-root --path=/var/www/html 2>/dev/null | grep -q "customer-cabinet"; then
    echo "Creating Customer Cabinet page..."
    wp post create \
        --post_type=page \
        --post_title='Customer Cabinet' \
        --post_name='customer-cabinet' \
        --post_status=publish \
        --post_content='[latepoint_customer_cabinet]' \
        --allow-root \
        --path=/var/www/html
    echo "Customer Cabinet page created!"
else
    echo "Customer Cabinet page already exists."
fi

# Ensure proper permissions
chown -R www-data:www-data /var/www/html/wp-content
chmod -R 755 /var/www/html/wp-content

echo "WordPress setup complete!"
