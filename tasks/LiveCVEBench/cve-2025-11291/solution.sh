#!/bin/bash
set -e

echo "Applying fix for map.php parameter handling..."

# The file is at /var/www/html/map.php (as per Dockerfile: COPY task-deps/ /var/www/html/)
FILE="/var/www/html/map.php"

if [ ! -f "$FILE" ]; then
    echo "ERROR: $FILE not found"
    exit 1
fi

# Use Python for more reliable string replacement (handles complex escaping better than PHP -r)
python3 << 'PYTHON_SCRIPT'
import sys

filepath = '/var/www/html/map.php'

with open(filepath, 'r') as f:
    content = f.read()

original_content = content

# Fix 1: Add ctype_digit validation to trid parameter check
# Change: if(isset($_GET['trid'])){
# To:     if(isset($_GET['trid']) && ctype_digit($_GET['trid'])){
content = content.replace(
    "if(isset($_GET['trid'])){",
    "if(isset($_GET['trid']) && ctype_digit($_GET['trid'])){"
)

# Fix 2: Sanitize trid output with intval()
# Change: trIdFilter = <?php echo $_GET['trid']; ?>
# To:     trIdFilter = <?php echo intval($_GET['trid']); ?>
content = content.replace(
    "trIdFilter = <?php echo $_GET['trid']; ?>",
    "trIdFilter = <?php echo intval($_GET['trid']); ?>"
)

# Fix 3: Fix the data parameter - use json_encode for safe JavaScript embedding
# Change: var postedData = '<?php echo $_GET['data'];?>';
# To:     var postedData = <?php echo json_encode($_GET['data']); ?>;
content = content.replace(
    "var postedData = '<?php echo $_GET['data'];?>';",
    "var postedData = <?php echo json_encode($_GET['data']); ?>;"
)

if content == original_content:
    print("WARNING: No changes were made. The patterns may not have matched.")
    print("Please verify the file content.")
    sys.exit(1)

with open(filepath, 'w') as f:
    f.write(content)

print("Fix applied successfully to map.php")
PYTHON_SCRIPT

# Verify the fix was applied
echo ""
echo "Verifying fix..."

if grep -q "ctype_digit" "$FILE"; then
    echo "  [OK] ctype_digit validation added for trid parameter"
else
    echo "  [FAIL] ctype_digit validation not found"
    exit 1
fi

if grep -q 'intval($_GET' "$FILE"; then
    echo "  [OK] intval() sanitization added for trid output"
else
    echo "  [FAIL] intval() sanitization not found"
    exit 1
fi

if grep -q 'json_encode($_GET' "$FILE"; then
    echo "  [OK] json_encode() added for data parameter"
else
    echo "  [FAIL] json_encode() not found for data parameter"
    exit 1
fi

echo ""
echo "All fixes applied and verified successfully!"
