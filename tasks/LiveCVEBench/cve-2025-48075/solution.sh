#!/bin/bash
# Solution script to fix the panic vulnerability in Fiber's BodyParser
# The fix adds panic recovery to the Decode method in decoder.go
set -e

# Ensure Go is in PATH (golang:1.20 image stores go at /usr/local/go/bin)
export PATH=$PATH:/usr/local/go/bin

cd /app

# The file is in the vendor directory since we use go mod vendor
DECODER_FILE="vendor/github.com/gofiber/fiber/v2/internal/schema/decoder.go"

# Check if file exists
if [ ! -f "$DECODER_FILE" ]; then
    echo "Error: $DECODER_FILE not found"
    exit 1
fi

# Backup original file
cp "$DECODER_FILE" "${DECODER_FILE}.bak"

# Step 1: Update function signature to use named return value
# Change: func (d *Decoder) Decode(dst interface{}, src map[string][]string) error {
# To:     func (d *Decoder) Decode(dst interface{}, src map[string][]string) (err error) {
sed -i 's/) error {$/) (err error) {/' "$DECODER_FILE"

# Step 2: Create the defer block to insert
# The block needs to be inserted after the validation check, right before "v = v.Elem()"
# We'll find "v = v.Elem()" and insert before it

# Use awk to insert the defer block before "v = v.Elem()"
awk '
/^[[:space:]]*v = v\.Elem\(\)$/ && !done {
    print "\t// Catch panics from the decoder and return them as an error."
    print "\t// This is needed because the decoder calls reflect and reflect panics"
    print "\tdefer func() {"
    print "\t\tif r := recover(); r != nil {"
    print "\t\t\tif e, ok := r.(error); ok {"
    print "\t\t\t\terr = e"
    print "\t\t\t} else {"
    print "\t\t\t\terr = fmt.Errorf(\"schema: panic while decoding: %v\", r)"
    print "\t\t\t}"
    print "\t\t}"
    print "\t}()"
    print ""
    done = 1
}
{ print }
' "$DECODER_FILE" > "${DECODER_FILE}.tmp" && mv "${DECODER_FILE}.tmp" "$DECODER_FILE"

# Verify the changes were applied
if ! grep -q "(err error)" "$DECODER_FILE"; then
    echo "Error: Function signature not updated"
    mv "${DECODER_FILE}.bak" "$DECODER_FILE"
    exit 1
fi

if ! grep -q "defer func()" "$DECODER_FILE"; then
    echo "Error: defer block not inserted"
    mv "${DECODER_FILE}.bak" "$DECODER_FILE"
    exit 1
fi

echo "Fix applied successfully to $DECODER_FILE"

# Rebuild the application with vendor flag
echo "Rebuilding the application..."
go build -mod=vendor -o server main.go

# Kill the existing server process so entrypoint can restart with fixed code
echo "Restarting the server..."
pkill -f "./server" || true
sleep 3

echo "Fix complete. Server will restart automatically via entrypoint."
