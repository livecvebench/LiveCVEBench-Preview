"""
Functional tests for the image resizing service.
These tests verify that the application works correctly in both vulnerable and fixed states.
"""

import pytest
import requests
import os
import time

BASE_URL = os.environ.get("BASE_URL", "http://localhost:8080")


class TestBasicFunctionality:
    """Basic functionality tests that should pass in both states."""

    def test_endpoint_responds(self):
        """The image_resized.php endpoint should respond with HTTP 200."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "nonexistent.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_returns_image_content_type_on_error(self):
        """When an image doesn't exist, should return an error image (PNG)."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "nonexistent_image_12345.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200
        assert response.headers.get('content-type') == 'image/png'

    def test_error_image_contains_error_text(self):
        """Error response should be a valid PNG image."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "definitely_not_here.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200
        # PNG magic bytes
        assert response.content[:8] == b'\x89PNG\r\n\x1a\n'

    def test_default_format_is_jpg(self):
        """When format is not specified, should default to jpg."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "test.jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_accepts_various_formats(self):
        """Should accept various image format parameters."""
        formats = ["jpg", "jpeg", "png", "gif", "webp"]
        for fmt in formats:
            response = requests.get(
                f"{BASE_URL}/image_resized.php",
                params={"imgfile": "test.jpg", "format": fmt},
                timeout=10
            )
            assert response.status_code == 200, f"Failed for format: {fmt}"

    def test_accepts_dimension_parameters(self):
        """Should accept width and height parameters."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "test.jpg", "format": "jpg", "w": "100", "h": "100"},
            timeout=10
        )
        assert response.status_code == 200

    def test_accepts_quality_parameter(self):
        """Should accept quality parameter."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "test.jpg", "format": "jpg", "q": "85"},
            timeout=10
        )
        assert response.status_code == 200

    def test_quality_max_100(self):
        """Quality parameter should be capped at 100."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "test.jpg", "format": "jpg", "q": "150"},
            timeout=10
        )
        assert response.status_code == 200


class TestLegitimateImagePaths:
    """Tests for legitimate image paths that should work."""

    def test_simple_relative_path(self):
        """Simple relative paths should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "img/test.jpg", "format": "jpg"},
            timeout=10
        )
        # Should return 200 regardless of whether the file exists
        assert response.status_code == 200

    def test_subdirectory_path(self):
        """Paths with subdirectories should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "uploads/images/photo.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_filename_only(self):
        """Simple filename should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "photo.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_alphanumeric_filename(self):
        """Alphanumeric filenames should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "image123.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_underscore_in_filename(self):
        """Filenames with underscores should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "my_image_file.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_hyphen_in_filename(self):
        """Filenames with hyphens should be accepted."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "my-image-file.jpg", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200


class TestEmptyAndMissingInput:
    """Tests for edge cases with empty or missing input."""

    def test_missing_imgfile_parameter(self):
        """When imgfile is missing, should use default."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_empty_imgfile_parameter(self):
        """When imgfile is empty string, should handle gracefully."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": "", "format": "jpg"},
            timeout=10
        )
        assert response.status_code == 200

    def test_no_parameters(self):
        """Request with no parameters should still work (use defaults)."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            timeout=10
        )
        assert response.status_code == 200
