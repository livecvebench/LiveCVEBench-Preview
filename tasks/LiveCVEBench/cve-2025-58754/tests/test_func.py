"""
Functionality tests for axios data: URI handling.
These tests verify that normal data: URI operations work correctly.
Should PASS in both vulnerable and fixed states.
"""
import subprocess
import pytest
import os
import json


def run_node_test(script: str, timeout: int = 30) -> dict:
    """Run a Node.js script and return the result."""
    result = subprocess.run(
        ['node', '--input-type=module', '-e', script],
        capture_output=True,
        text=True,
        timeout=timeout,
        cwd='/app'
    )
    return {
        'returncode': result.returncode,
        'stdout': result.stdout.strip(),
        'stderr': result.stderr.strip()
    }


class TestDataURIBasicFunctionality:
    """Test that basic data: URI functionality works."""

    def test_simple_text_data_url(self):
        """Simple text data: URL should return the text content."""
        script = '''
import axios from 'axios';

// Note: axios data: URIs require ;base64, format or use MIME;charset format
// Simple "data:text/plain,text" may not work in all axios versions
const text = 'Hello World';
const base64 = Buffer.from(text).toString('base64');
const url = `data:text/plain;base64,${base64}`;
try {
    const response = await axios.get(url, { responseType: 'text' });
    if (response.status === 200 && response.data === text) {
        console.log('SUCCESS');
        process.exit(0);
    } else {
        console.log('FAIL: status=' + response.status + ' data=' + JSON.stringify(response.data));
        process.exit(1);
    }
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_base64_encoded_data_url(self):
        """Base64 encoded data: URL should decode correctly."""
        script = '''
import axios from 'axios';

// "Hello World" in base64
const base64 = Buffer.from('Hello World').toString('base64');
const url = `data:text/plain;base64,${base64}`;

try {
    const response = await axios.get(url, { responseType: 'text' });
    if (response.status === 200 && response.data === 'Hello World') {
        console.log('SUCCESS');
        process.exit(0);
    } else {
        console.log('FAIL: status=' + response.status + ' data=' + JSON.stringify(response.data));
        process.exit(1);
    }
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_data_url_with_mime_type(self):
        """Data URL with MIME type should work correctly."""
        script = '''
import axios from 'axios';

const jsonData = JSON.stringify({test: "value"});
const base64 = Buffer.from(jsonData).toString('base64');
const url = `data:application/json;base64,${base64}`;

try {
    const response = await axios.get(url);
    if (response.status === 200) {
        const parsed = JSON.parse(response.data);
        if (parsed.test === 'value') {
            console.log('SUCCESS');
            process.exit(0);
        }
    }
    console.log('FAIL: unexpected response');
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']


class TestDataURIWithLimits:
    """Test that data: URIs work correctly within configured limits."""

    def test_data_url_within_max_content_length(self):
        """Data URL within maxContentLength limit should succeed."""
        script = '''
import axios from 'axios';

// 5 bytes of data
const data = 'Hello';
const base64 = Buffer.from(data).toString('base64');
const url = `data:text/plain;base64,${base64}`;

try {
    const response = await axios.get(url, {
        maxContentLength: 1000,  // 1KB limit, data is only 5 bytes
        responseType: 'text'
    });
    if (response.status === 200 && response.data === data) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: unexpected response');
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_data_url_exactly_at_limit(self):
        """Data URL exactly at maxContentLength limit should succeed."""
        script = '''
import axios from 'axios';

// Create exactly 100 bytes
const data = 'X'.repeat(100);
const base64 = Buffer.from(data).toString('base64');
const url = `data:text/plain;base64,${base64}`;

try {
    const response = await axios.get(url, {
        maxContentLength: 100  // Exactly 100 bytes
    });
    if (response.status === 200 && response.data.length === 100) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: unexpected response');
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_data_url_with_unlimited_max_content_length(self):
        """Data URL with maxContentLength=-1 (unlimited) should succeed."""
        script = '''
import axios from 'axios';

const data = 'X'.repeat(5000);
const base64 = Buffer.from(data).toString('base64');
const url = `data:text/plain;base64,${base64}`;

try {
    const response = await axios.get(url, {
        maxContentLength: -1  // Unlimited
    });
    if (response.status === 200 && response.data.length === 5000) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: unexpected response');
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']


class TestDataURINonGetMethods:
    """Test that non-GET methods on data: URIs return 405."""

    def test_post_returns_405(self):
        """POST to data: URI should return 405 Method Not Allowed."""
        script = '''
import axios from 'axios';

const url = 'data:text/plain,test';

try {
    const response = await axios.post(url);
    if (response.status === 405) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: expected 405, got ' + response.status);
    process.exit(1);
} catch (err) {
    if (err.response && err.response.status === 405) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_put_returns_405(self):
        """PUT to data: URI should return 405 Method Not Allowed."""
        script = '''
import axios from 'axios';

const url = 'data:text/plain,test';

try {
    const response = await axios.put(url);
    if (response.status === 405) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: expected 405, got ' + response.status);
    process.exit(1);
} catch (err) {
    if (err.response && err.response.status === 405) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']


class TestDataURIEncodings:
    """Test various data: URI encoding formats."""

    def test_url_encoded_data(self):
        """URL-encoded data in base64 format should be decoded properly."""
        script = '''
import axios from 'axios';

// Use base64 encoding since plain data URLs may not work in all axios versions
const text = 'Hello World!';
const base64 = Buffer.from(text).toString('base64');
const url = `data:text/plain;base64,${base64}`;

try {
    const response = await axios.get(url, { responseType: 'text' });
    if (response.status === 200 && response.data === text) {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: data=' + JSON.stringify(response.data));
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_base64_with_padding(self):
        """Base64 data with = padding should work."""
        script = '''
import axios from 'axios';

// "M" encoded in base64 = "TQ==" (with padding)
const url = 'data:text/plain;base64,TQ==';

try {
    const response = await axios.get(url, { responseType: 'text' });
    if (response.status === 200 && response.data === 'M') {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: data=' + JSON.stringify(response.data));
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_base64_with_url_encoded_padding(self):
        """Base64 data with URL-encoded = padding (%3D) should work."""
        script = '''
import axios from 'axios';

// "M" encoded in base64 = "TQ==" with URL-encoded padding
const url = 'data:text/plain;base64,TQ%3D%3D';

try {
    const response = await axios.get(url, { responseType: 'text' });
    if (response.status === 200 && response.data === 'M') {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: data=' + JSON.stringify(response.data));
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_empty_data_url(self):
        """Empty base64 data: URL should return empty string."""
        script = '''
import axios from 'axios';

// Empty string in base64
const url = 'data:text/plain;base64,';

try {
    const response = await axios.get(url, { responseType: 'text' });
    if (response.status === 200 && response.data === '') {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: data=' + JSON.stringify(response.data));
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']


class TestResponseTypes:
    """Test different response types with data: URIs."""

    def test_response_type_text(self):
        """Data URL with responseType='text' should return string."""
        script = '''
import axios from 'axios';

const data = 'Test String';
const base64 = Buffer.from(data).toString('base64');
const url = `data:text/plain;base64,${base64}`;

try {
    const response = await axios.get(url, { responseType: 'text' });
    if (response.status === 200 && response.data === data && typeof response.data === 'string') {
        console.log('SUCCESS');
        process.exit(0);
    }
    console.log('FAIL: type=' + typeof response.data + ' data=' + JSON.stringify(response.data));
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']

    def test_response_type_stream(self):
        """Data URL with responseType='stream' should return readable stream."""
        script = '''
import axios from 'axios';
import { Readable } from 'stream';

const data = 'Stream Data';
const base64 = Buffer.from(data).toString('base64');
const url = `data:text/plain;base64,${base64}`;

try {
    const response = await axios.get(url, { responseType: 'stream' });
    if (response.status === 200 && response.data instanceof Readable) {
        // Read stream to verify content
        const chunks = [];
        for await (const chunk of response.data) {
            chunks.push(chunk);
        }
        const result = Buffer.concat(chunks).toString();
        if (result === data) {
            console.log('SUCCESS');
            process.exit(0);
        }
    }
    console.log('FAIL');
    process.exit(1);
} catch (err) {
    console.log('ERROR: ' + err.message);
    process.exit(1);
}
'''
        result = run_node_test(script)
        assert result['returncode'] == 0, f"Test failed: {result['stdout']} {result['stderr']}"
        assert 'SUCCESS' in result['stdout']
