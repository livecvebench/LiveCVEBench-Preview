#!/bin/bash
# Solution script for fixing the path validation issue in the export API
set -e
cd /app

EXPORT_PY="/app/frigate/api/export.py"

echo "Applying fix to $EXPORT_PY..."

# Check if file exists
if [ ! -f "$EXPORT_PY" ]; then
    echo "Error: $EXPORT_PY not found"
    exit 1
fi

# Check if fix is already applied (idempotency check)
if grep -q "from pathvalidate import sanitize_filepath" "$EXPORT_PY"; then
    echo "Fix already applied (pathvalidate import exists)"
    exit 0
fi

# 1. Add pathvalidate import after the JSONResponse import
sed -i '/from fastapi.responses import JSONResponse/a from pathvalidate import sanitize_filepath' "$EXPORT_PY"

# 2. Update the const import to include CLIPS_DIR
sed -i 's/from frigate\.const import EXPORT_DIR$/from frigate.const import CLIPS_DIR, EXPORT_DIR/' "$EXPORT_PY"

# 3. Replace the vulnerable line with the fixed version using Python
# This is more reliable than sed for multi-line replacements
python3 << 'PYEOF'
import re

export_py_path = "/app/frigate/api/export.py"

with open(export_py_path, "r") as f:
    content = f.read()

# Find and replace the vulnerable assignment
old_pattern = r"    existing_image = body\.image_path\n"
new_code = """    existing_image = sanitize_filepath(body.image_path) if body.image_path else None

    # Ensure that existing_image is a valid path
    if existing_image and not existing_image.startswith(CLIPS_DIR):
        return JSONResponse(
            content=({"success": False, "message": "Invalid image path"}),
            status_code=400,
        )

"""

# Check if the vulnerable pattern exists
if re.search(old_pattern, content):
    content = re.sub(old_pattern, new_code, content)
    with open(export_py_path, "w") as f:
        f.write(content)
    print("Successfully applied path validation fix")
else:
    print("Vulnerable pattern not found - may already be fixed")

PYEOF

# Verify the fix was applied
if grep -q "sanitize_filepath" "$EXPORT_PY" && grep -q "not existing_image.startswith(CLIPS_DIR)" "$EXPORT_PY"; then
    echo "Fix verification: SUCCESS"
else
    echo "Fix verification: FAILED"
    exit 1
fi

# Restart the test server after patching
# The entrypoint.sh script will automatically restart the server
echo "Restarting test server..."
pkill -f "python.*test_server" || true
sleep 3

# Wait for server to be back up
for i in {1..30}; do
    if curl -s http://localhost:5000/api/exports > /dev/null 2>&1; then
        echo "Server restarted successfully"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "Warning: Server may not have restarted properly"
    fi
    sleep 1
done

echo "Fix applied successfully"
