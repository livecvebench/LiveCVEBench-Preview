"""
Functional tests for AstrBot file download endpoint.

These tests verify that the application works correctly and normal
file access functionality is preserved after the fix is applied.
Tests should PASS in both vulnerable and fixed states.
"""

import os
import time
import requests

BASE_URL = os.environ.get("APP_URL", "http://localhost:6185")
TIMEOUT = 10


def wait_for_app(max_retries=30, delay=2):
    """Wait for the application to be ready."""
    for _ in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302, 401]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
    return False


class TestEndpointAvailability:
    """Test that the file endpoint is accessible."""

    def test_endpoint_responds(self):
        """Test that the get_file endpoint responds to requests."""
        assert wait_for_app(), "Application did not start in time"

        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "test.jpg"},
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Should respond (not timeout or connection error)
        # Valid responses include: 200 (file found), 401 (auth required), or error response
        assert response.status_code in [200, 401, 403, 404]

    def test_missing_filename_parameter(self):
        """Test that missing filename parameter returns appropriate error."""
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Should return an error about missing filename
        assert response.status_code in [200, 400]
        if response.status_code == 200:
            data = response.json() if response.headers.get('content-type', '').startswith('application/json') else {"message": response.text}
            # Check for error in response (custom Response class returns {"status": "error", "message": ...})
            assert "error" in str(data).lower() or "missing" in str(data).lower()


class TestFileAccess:
    """Test normal file access patterns."""

    def test_nonexistent_file_returns_error(self):
        """Test that requesting a nonexistent file returns proper error."""
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "definitely_nonexistent_file_12345.jpg"},
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Should return error (file not found or similar)
        # Not 500 server error
        assert response.status_code != 500
        if response.status_code == 200:
            # If 200, should contain error message
            content = response.text.lower()
            assert "error" in content or "not found" in content or "access" in content

    def test_simple_filename_accepted(self):
        """Test that simple filenames without path components are accepted."""
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "image.png"},
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Should not return 500 (server error)
        assert response.status_code != 500
        # 200 with error (file not found) or 401/404 is acceptable
        assert response.status_code in [200, 401, 403, 404]

    def test_wav_file_request(self):
        """Test that .wav file requests are handled properly."""
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "audio.wav"},
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Should not crash - return proper response
        assert response.status_code != 500

    def test_jpeg_file_request(self):
        """Test that .jpeg file requests are handled properly."""
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "photo.jpeg"},
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Should not crash - return proper response
        assert response.status_code != 500


class TestResponseFormat:
    """Test that the API returns properly formatted responses."""

    def test_error_response_format(self):
        """Test that error responses follow expected format."""
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "nonexistent_test_file.txt"},
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Should not be a server error
        assert response.status_code != 500

        if response.status_code == 200:
            # Try to parse as JSON (custom Response class format)
            try:
                data = response.json()
                # Should have status field for error responses
                if "status" in data:
                    assert data["status"] in ["ok", "error"]
            except:
                # Raw text response is also acceptable
                pass


class TestAppFunctionality:
    """Test that the main application functionality works."""

    def test_dashboard_accessible(self):
        """Test that the main dashboard is accessible."""
        response = requests.get(
            f"{BASE_URL}/",
            allow_redirects=True,
            timeout=TIMEOUT
        )
        # Dashboard should be accessible
        assert response.status_code in [200, 302, 401]

    def test_auth_endpoint_exists(self):
        """Test that the auth endpoint exists and responds."""
        response = requests.post(
            f"{BASE_URL}/api/auth/login",
            json={"username": "test", "password": "test"},
            timeout=TIMEOUT
        )
        # Should respond (even with auth failure)
        assert response.status_code in [200, 400, 401, 403]
