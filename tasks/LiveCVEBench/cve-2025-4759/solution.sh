#!/bin/bash
# Solution script for package name validation bypass fix
# This script applies a one-line fix to add a trailing slash after the package name
# in the URL pattern matching, preventing prefix matching bypass attacks.

set -e

TARGET_FILE="/app/src/validators/ValidatePackageNames.js"

echo "Applying fix to ValidatePackageNames.js..."

# The vulnerability is on line 56 where the expectedURLBeginning is constructed
# without a trailing slash, allowing prefix matches to bypass validation.
#
# Before: const expectedURLBeginning = `${packageResolvedURL.origin}/${packageNameOnly}`
# After:  const expectedURLBeginning = `${packageResolvedURL.origin}/${packageNameOnly}/`
#
# The fix adds a trailing slash after packageNameOnly to enforce exact package name matching.

# Apply the fix using sed - add trailing slash before the closing backtick
sed -i 's|\(const expectedURLBeginning = `\${packageResolvedURL\.origin}/\${packageNameOnly}\)`|\1/`|' "$TARGET_FILE"

# Verify the fix was applied
if grep -q 'const expectedURLBeginning = `\${packageResolvedURL.origin}/\${packageNameOnly}/`' "$TARGET_FILE"; then
    echo "Fix applied successfully!"
    echo "Package name validation now requires exact match with trailing slash boundary."
else
    echo "ERROR: Fix may not have been applied correctly."
    echo "Checking current state of the file..."
    grep -n "expectedURLBeginning" "$TARGET_FILE"
    exit 1
fi
