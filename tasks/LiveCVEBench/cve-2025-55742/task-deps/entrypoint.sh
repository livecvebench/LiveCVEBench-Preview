#!/bin/bash
set -e

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready..."
max_attempts=30
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if php -r "try { new PDO('mysql:host=mysql;port=3306;dbname=unopim', 'unopim', 'unopim'); echo 'Connected'; exit(0); } catch (Exception \$e) { exit(1); }" 2>/dev/null; then
        echo "MySQL is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "Waiting for MySQL... (attempt $attempt/$max_attempts)"
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "Failed to connect to MySQL after $max_attempts attempts"
    exit 1
fi

cd /var/www/html

# Run initialization only once
if [ ! -f "/var/lock/unopim.lock" ]; then
    echo "Running first-time initialization..."

    # Generate app key if not set
    php artisan key:generate --force

    # Run the unopim installer (creates tables, seeds data, creates admin user)
    php artisan unopim:install -n || {
        echo "unopim:install failed, trying manual setup..."
        php artisan migrate --force
        php artisan db:seed --force || true
    }

    # Create storage link
    php artisan storage:link || true

    # Ensure proper permissions
    chown -R www-data:www-data storage bootstrap/cache
    chmod -R 775 storage bootstrap/cache

    touch /var/lock/unopim.lock
    echo "Initialization complete!"
fi

# Keep the container running with the Laravel development server
# Using a loop so the container stays alive even if the server restarts
while true; do
    # Check for and apply solution.sh before starting server
    if [ -f "/app/solution.sh" ] && [ ! -f "/var/lock/solution.applied" ]; then
        echo "Applying solution.sh..."
        bash /app/solution.sh && touch /var/lock/solution.applied
        echo "Solution applied successfully!"
    fi

    echo "Starting Laravel development server..."

    # Run server - use timeout to periodically restart and check for solution
    # The server will automatically restart after 600 seconds or if it exits
    timeout 600 php artisan serve --host=0.0.0.0 --port=8000 || true

    echo "Server stopped. Checking for updates and restarting..."
    sleep 2
done
