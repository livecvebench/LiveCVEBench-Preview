"""
Vulnerability tests for ImageMagick format string handling.

These tests verify the format string vulnerability status:
- FAIL on vulnerable version (vulnerability is exploitable)
- PASS on fixed version (vulnerability is mitigated)
"""

import subprocess
import os
import tempfile
import signal
import pytest


class TestFormatStringVulnerability:
    """Test format string vulnerability in InterpretImageFilename."""

    @pytest.fixture(autouse=True)
    def setup_teardown(self):
        """Setup and teardown for each test."""
        self.test_dir = tempfile.mkdtemp()
        yield
        # Cleanup
        import shutil
        shutil.rmtree(self.test_dir, ignore_errors=True)

    def _run_with_timeout(self, cmd, timeout=5):
        """
        Run a command with timeout and return result info.
        Returns tuple: (crashed, timed_out, return_code, stderr)
        """
        try:
            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=timeout
            )
            # Check for crash indicators
            crashed = result.returncode < 0  # Negative = killed by signal
            return (crashed, False, result.returncode, result.stderr)
        except subprocess.TimeoutExpired:
            return (False, True, None, "Timeout expired")
        except Exception as e:
            return (True, False, -1, str(e))

    def test_format_string_n_specifier(self):
        """
        Test that %n format specifier does not cause memory corruption.

        The %n specifier writes to memory in printf-family functions.
        On vulnerable versions: mogrify '%o%n' causes heap corruption/crash
        On fixed versions: %n should be treated as literal text or rejected safely
        """
        # Test with %o%n pattern - the classic exploit vector
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', '%o%n'],
            timeout=5
        )

        # The vulnerability is FIXED if:
        # 1. No crash (returncode >= 0 or controlled exit)
        # 2. No timeout (indicating potential infinite loop)

        if crashed:
            pytest.fail(
                f"Vulnerability detected: Process crashed with signal. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail(
                f"Vulnerability detected: Process timed out (possible infinite loop). "
                f"stderr: {stderr}"
            )

        # If we get here, the format string was handled safely
        # Return code 1 is acceptable (file not found error is fine)
        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_format_string_d_n_combination(self):
        """
        Test %d%n format specifier combination.

        Similar to %o%n, this should not cause crashes on fixed version.
        """
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', '%d%n'],
            timeout=5
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: Process crashed. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_format_string_x_n_combination(self):
        """
        Test %x%n format specifier combination.

        The %x specifier combined with %n should not cause crashes.
        """
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', '%x%n'],
            timeout=5
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: Process crashed. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_format_string_multiple_n(self):
        """
        Test multiple %n specifiers.

        Multiple %n specifiers can be used for more sophisticated attacks.
        Fixed version should handle these safely.
        """
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', '%d%n%n%n'],
            timeout=5
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: Multiple %n caused crash. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_convert_format_string(self):
        """
        Test format string vulnerability via convert command.

        The vulnerability exists in InterpretImageFilename which is used
        by multiple ImageMagick commands.
        """
        input_path = os.path.join(self.test_dir, 'test_input.png')

        # Create a test image first
        subprocess.run(
            ['convert', '-size', '10x10', 'xc:red', input_path],
            check=True,
            timeout=10
        )

        # Try to convert with malicious output filename
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['convert', input_path, '%o%n'],
            timeout=5
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: convert crashed. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_positional_format_specifier(self):
        """
        Test positional format specifiers like %1$n.

        Positional parameters can be used for more precise memory writes.
        The %o%n pattern is the classic trigger for this vulnerability.
        """
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', '%o%n'],
            timeout=5
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: Positional format caused crash. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_format_string_with_width(self):
        """
        Test format string with width specifier and %n.

        Width specifiers can be used to control the value written by %n.
        """
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', '%100d%n'],
            timeout=5
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: Width + %n caused crash. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_half_word_write_specifier(self):
        """
        Test %hn (half-word write) specifier.

        %hn writes only 2 bytes, commonly used in format string exploits
        for precise memory manipulation.
        """
        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', '%d%hn'],
            timeout=5
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: %hn caused crash. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"

    def test_long_format_string(self):
        """
        Test handling of long format strings.

        Long format strings could potentially cause buffer overflows
        or other memory issues.
        """
        # Create a long pattern with multiple specifiers
        long_pattern = '%d' + '%n' * 50

        crashed, timed_out, returncode, stderr = self._run_with_timeout(
            ['mogrify', long_pattern],
            timeout=10
        )

        if crashed:
            pytest.fail(
                f"Vulnerability detected: Long format string caused crash. "
                f"Return code: {returncode}, stderr: {stderr}"
            )

        if timed_out:
            pytest.fail("Vulnerability detected: Process timed out")

        assert returncode >= 0, f"Process terminated abnormally: {stderr}"
