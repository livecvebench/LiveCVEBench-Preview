#!/bin/bash
# Solution script for CMSimple_XH HTML encoding vulnerability
# This script fixes the reflected XSS vulnerability by ensuring user-controlled
# URL path segments are properly HTML-encoded before being inserted into HTML.
set -e
cd /app

echo "Applying HTML encoding fixes for URL path handling..."

# Fix 1: ml() function in functions.php (line 841)
# Original: $t .= '<a href="' . $sn . '?&amp;' . $i . '">';
# Fixed:    $t .= '<a href="' . XH_hsc($sn) . '?&amp;' . $i . '">';
sed -i "s/\. \$sn \. '?&amp;'/. XH_hsc(\$sn) . '?\\&amp;'/g" cmsimple/functions.php
echo "Fixed ml() function in functions.php"

# Fix 2: searchbox() function in tplfuncs.php (line 238)
# Original: return '<form id="searchbox" action="' . $sn . '"'
# Fixed:    return '<form id="searchbox" action="' . XH_hsc($sn) . '"'
sed -i "s/action=\"' \. \$sn \. '\" method/action=\"' . XH_hsc(\$sn) . '\" method/g" cmsimple/tplfuncs.php
echo "Fixed searchbox() function in tplfuncs.php"

# Fix 3: a() function in functions.php - this outputs page links
# The function returns '<a href="' . $a_href . $x . '">'
# where $a_href comes from XH_getPageURL() which returns $sn
# We need to encode $a_href before inserting into HTML
sed -i "s/return '<a href=\"' \. \$a_href \. \$x \. '\">'/return '<a href=\"' . XH_hsc(\$a_href . \$x) . '\">'/g" cmsimple/functions.php
echo "Fixed a() function in functions.php"

# Fix 4: XH_printUrl() function in tplfuncs.php (line 299)
# Original: return $sn . '?' . $t;
# Fixed:    return XH_hsc($sn) . '?' . $t;
# Note: $t is already XH_hsc() encoded on line 298
sed -i "s/return \$sn \. '?' \. \$t;/return XH_hsc(\$sn) . '?' . \$t;/g" cmsimple/tplfuncs.php
echo "Fixed XH_printUrl() function in tplfuncs.php"

# Fix 5: login form in functions.php (line 1387)
# action="' . $sn . '?' needs encoding
sed -i "s/action=\"' \. \$sn \. '?' \. \$su/action=\"' . XH_hsc(\$sn) . '?' . \$su/g" cmsimple/functions.php
echo "Fixed login form action in functions.php"

# Fix 6: forgotten password link in functions.php (line 1396)
# '<a href="' . $sn . '?&function=forgotten">'
sed -i "s/'<a href=\"' \. \$sn \. '?\&function=forgotten\">'/'<a href=\"' . XH_hsc(\$sn) . '?\\&function=forgotten\">'/" cmsimple/functions.php
echo "Fixed forgotten password link in functions.php"

# Fix 7: back link in functions.php (line 1403)
# '<a href="' . "$sn$query" . '">'
sed -i 's/<a href="'"'"' \. "\$sn\$query" \. '"'"'">/<a href="'"'"' . XH_hsc("\$sn\$query") . '"'"'">/g' cmsimple/functions.php
echo "Fixed back link in functions.php"

# Fix 8: previouspage() function in tplfuncs.php (line 487)
# Original: '<a href="' . XH_getPageURL($index) . '"'
# Fixed:    '<a href="' . XH_hsc(XH_getPageURL($index)) . '"'
sed -i 's/<a href="'"'"' \. XH_getPageURL(\$index) \. '"'"'" rel="prev">/<a href="'"'"' . XH_hsc(XH_getPageURL(\$index)) . '"'"'" rel="prev">/g' cmsimple/tplfuncs.php
echo "Fixed previouspage() function in tplfuncs.php"

# Fix 9: nextpage() function in tplfuncs.php (line 505)
# Original: '<a href="' . XH_getPageURL($index) . '"'
# Fixed:    '<a href="' . XH_hsc(XH_getPageURL($index)) . '"'
sed -i 's/<a href="'"'"' \. XH_getPageURL(\$index) \. '"'"'" rel="next">/<a href="'"'"' . XH_hsc(XH_getPageURL(\$index)) . '"'"'" rel="next">/g' cmsimple/tplfuncs.php
echo "Fixed nextpage() function in tplfuncs.php"

# Fix 10: prev link meta in tplfuncs.php (line 26)
# Original: '<link rel="prev" href="' . XH_getPageURL($index) . '">'
# Fixed:    '<link rel="prev" href="' . XH_hsc(XH_getPageURL($index)) . '">'
sed -i 's/<link rel="prev" href="'"'"' \. XH_getPageURL(\$index) \. '"'"'">/<link rel="prev" href="'"'"' . XH_hsc(XH_getPageURL(\$index)) . '"'"'">/g' cmsimple/tplfuncs.php
echo "Fixed prev link meta in tplfuncs.php"

# Fix 11: next link meta in tplfuncs.php (line 43)
# Original: '<link rel="next" href="' . XH_getPageURL($index) . '">'
# Fixed:    '<link rel="next" href="' . XH_hsc(XH_getPageURL($index)) . '">'
sed -i 's/<link rel="next" href="'"'"' \. XH_getPageURL(\$index) \. '"'"'">/<link rel="next" href="'"'"' . XH_hsc(XH_getPageURL(\$index)) . '"'"'">/g' cmsimple/tplfuncs.php
echo "Fixed next link meta in tplfuncs.php"

# Verify no PHP syntax errors
echo ""
echo "Verifying PHP syntax..."
php -l cmsimple/functions.php
php -l cmsimple/tplfuncs.php

# Verify fixes were applied
echo ""
echo "Verifying fixes..."

if grep -q 'XH_hsc(\$sn)' cmsimple/functions.php; then
    echo "✓ functions.php XH_hsc(\$sn) fix verified"
else
    echo "⚠ functions.php XH_hsc(\$sn) fix may not have applied correctly"
fi

if grep -q 'XH_hsc(\$sn)' cmsimple/tplfuncs.php; then
    echo "✓ tplfuncs.php XH_hsc(\$sn) fix verified"
else
    echo "⚠ tplfuncs.php XH_hsc(\$sn) fix may not have applied correctly"
fi

if grep -q 'XH_hsc(\$a_href' cmsimple/functions.php; then
    echo "✓ functions.php a() function fix verified"
else
    echo "⚠ functions.php a() function fix may not have applied correctly"
fi

if grep -q 'XH_hsc(XH_getPageURL' cmsimple/tplfuncs.php; then
    echo "✓ tplfuncs.php XH_getPageURL fix verified"
else
    echo "⚠ tplfuncs.php XH_getPageURL fix may not have applied correctly"
fi

echo ""
echo "Fix applied successfully!"
echo "The application now properly HTML-encodes URL path segments in HTML output."
