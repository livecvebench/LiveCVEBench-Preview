#!/bin/bash
# WordPress initialization script for CVE-2025-12684
# This script:
# 1. Waits for MySQL to be ready
# 2. Completes WordPress installation
# 3. Creates admin user
# 4. Activates URL Shortify plugin

set -e

# Wait for database to be ready (skip SSL for local connection)
echo "Waiting for database to be ready..."
until mysql -h "$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" --skip-ssl -e "SELECT 1" 2>/dev/null; do
    echo "Database not ready yet, waiting..."
    sleep 2
done
echo "Database is ready!"

# Give MySQL a moment to fully initialize
sleep 3

# Check if WordPress is already installed
cd /var/www/html

if ! wp core is-installed --allow-root 2>/dev/null; then
    echo "Installing WordPress..."
    wp core install \
        --url="http://localhost" \
        --title="CVE-2025-12684 Test Site" \
        --admin_user=admin \
        --admin_password=admin \
        --admin_email=admin@example.com \
        --skip-email \
        --allow-root
    echo "WordPress installed successfully!"
else
    echo "WordPress is already installed."
fi

# Activate the URL Shortify plugin
echo "Activating URL Shortify plugin..."
if wp plugin is-active url-shortify --allow-root 2>/dev/null; then
    echo "URL Shortify plugin is already active."
else
    wp plugin activate url-shortify --allow-root
    echo "URL Shortify plugin activated!"
fi

# Verify plugin is active
echo "Verifying plugin status..."
wp plugin list --allow-root | grep url-shortify

# Skip Freemius activation (required for plugin pages to be accessible)
echo "Skipping Freemius activation opt-in..."
php -r '
require("/var/www/html/wp-load.php");
$fs_accounts = get_option("fs_accounts", array());
if (!isset($fs_accounts["plugin_data"])) {
    $fs_accounts["plugin_data"] = array();
}
if (!isset($fs_accounts["plugin_data"]["url-shortify"])) {
    $fs_accounts["plugin_data"]["url-shortify"] = array();
}
$fs_accounts["plugin_data"]["url-shortify"]["is_anonymous"] = array(
    "is" => true,
    "timestamp" => time()
);
update_option("fs_accounts", $fs_accounts);
echo "Freemius activation skipped.\n";
'

echo "WordPress initialization complete!"
