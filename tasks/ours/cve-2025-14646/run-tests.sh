#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== Setting up test environment ==="

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env
fi

# Initialize uv project if needed
uv init 2>/dev/null || true

# Add test dependencies
echo "Installing test dependencies..."
uv add pytest requests 2>/dev/null

# Wait for web server to be ready
echo "=== Waiting for web server ==="
for i in {1..30}; do
    if curl -s http://localhost/ > /dev/null 2>&1; then
        echo "Web server is ready!"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "ERROR: Web server did not become ready in 30 seconds"
        exit 1
    fi
    echo "Waiting for web server... ($i/30)"
    sleep 1
done

# Wait a bit more for database to be fully initialized
sleep 2

echo "=== Running tests ==="
uv run pytest . -rA
