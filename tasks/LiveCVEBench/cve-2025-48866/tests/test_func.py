#!/usr/bin/env python3
"""
Functional Tests for ModSecurity Protected Web Server

These tests verify basic functionality of the ModSecurity-protected Apache server.
They should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import subprocess
import time
import os

# Base URL for the test server
BASE_URL = os.environ.get("TEST_URL", "http://localhost:8080")
TEST_ENDPOINT = f"{BASE_URL}/test.php"


class TestServerAvailability:
    """Tests to verify the server is running and accessible"""

    def test_server_responds_to_get(self):
        """Verify server responds to GET requests"""
        response = requests.get(TEST_ENDPOINT, timeout=10)
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

    def test_server_responds_to_post(self):
        """Verify server responds to POST requests"""
        response = requests.post(
            TEST_ENDPOINT,
            data={"test": "value"},
            timeout=10
        )
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

    def test_server_accepts_form_data(self):
        """Verify server accepts form-encoded data"""
        response = requests.post(
            TEST_ENDPOINT,
            data={"username": "testuser", "password": "testpass"},
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=10
        )
        assert response.status_code == 200


class TestBasicPostProcessing:
    """Tests for basic POST request handling"""

    def test_simple_post_returns_json(self):
        """Verify simple POST returns valid JSON"""
        response = requests.post(
            TEST_ENDPOINT,
            data={"test": "value"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert "method" in data
        assert data["method"] == "POST"

    def test_multiple_params_accepted(self):
        """Verify server handles multiple distinct parameters"""
        params = {
            "field1": "value1",
            "field2": "value2",
            "field3": "value3",
            "field4": "value4",
            "field5": "value5"
        }
        response = requests.post(TEST_ENDPOINT, data=params, timeout=10)
        assert response.status_code == 200
        data = response.json()
        assert data["param_count"] >= 5

    def test_small_duplicate_params_work(self):
        """Verify server handles small number of duplicate params"""
        # Small number of duplicate params should work fine
        payload = [("password", f"val_{i}") for i in range(5)]
        response = requests.post(
            TEST_ENDPOINT,
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=10
        )
        assert response.status_code == 200

    def test_moderate_load_completes(self):
        """Verify server handles moderate number of parameters"""
        # 20 parameters should be handled without issue
        payload = [(f"param_{i}", f"value_{i}") for i in range(20)]
        response = requests.post(
            TEST_ENDPOINT,
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=15
        )
        assert response.status_code == 200


class TestResponseContent:
    """Tests for response content correctness"""

    def test_response_contains_timestamp(self):
        """Verify response contains timestamp"""
        response = requests.post(
            TEST_ENDPOINT,
            data={"test": "value"},
            timeout=10
        )
        data = response.json()
        assert "timestamp" in data

    def test_response_shows_post_method(self):
        """Verify response correctly identifies POST method"""
        response = requests.post(
            TEST_ENDPOINT,
            data={"test": "value"},
            timeout=10
        )
        data = response.json()
        assert data["method"] == "POST"


class TestServerStability:
    """Tests for basic server stability"""

    def test_consecutive_requests_work(self):
        """Verify server handles multiple consecutive requests"""
        for i in range(5):
            response = requests.post(
                TEST_ENDPOINT,
                data={"request": f"number_{i}"},
                timeout=10
            )
            assert response.status_code == 200, f"Request {i} failed"

    def test_server_recovers_after_request(self):
        """Verify server is still responsive after requests"""
        # Send some requests first
        for i in range(3):
            requests.post(TEST_ENDPOINT, data={"test": f"val_{i}"}, timeout=10)

        # Give it a moment
        time.sleep(1)

        # Server should still respond
        response = requests.get(TEST_ENDPOINT, timeout=10)
        assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
