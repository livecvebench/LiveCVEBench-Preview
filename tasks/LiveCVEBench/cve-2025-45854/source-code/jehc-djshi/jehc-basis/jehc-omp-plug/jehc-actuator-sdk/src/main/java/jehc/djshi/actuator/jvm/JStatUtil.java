package jehc.djshi.actuator.jvm;

import jehc.djshi.actuator.vo.KV;
import jehc.djshi.actuator.util.ExecuteCmd;
import jehc.djshi.actuator.util.ActuatorSDKUtil;
import java.io.BufferedReader;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
/**
 * @Desc 堆快照
 * @Author 邓纯杰
 * @CreateTime 2013-10-05 17:15:42
 */
public class JStatUtil {

    /**
     * Jstat 模板方法
     * @param strings 命令
     * @return 集合
     */
    private static List<KV> jstat(String[] strings) throws Exception {
        List<KV> list = new ArrayList<>();
        String s = ExecuteCmd.execute(strings);
        assert s != null;
        BufferedReader reader = new BufferedReader(new StringReader(s));
        String[] keys = ActuatorSDKUtil.trim(reader.readLine().split("\\s+|\t"));
        String[] values = ActuatorSDKUtil.trim(reader.readLine().split("\\s+|\t"));
        // 特殊情况
        if (strings[1].equals("-compiler")) {
            for (int i = 0; i < 4; i++) {
                list.add(new KV(keys[i], values[i]));
            }
            return list;
        }
        // 正常流程
        for (int i = 0; i < keys.length; i++) {
            list.add(new KV(keys[i], values[i]));
        }
        return list;
    }

    /**
     * 类加载信息
     * X轴为时间，Y轴为值的变化
     * @return
     */
    public static List<KV> jstatClass() throws Exception {
        String id = ActuatorSDKUtil.getPid();
        List<KV> jstatClass = jstat(new String[]{"jstat", "-class", id});
        List<KV> jstatCompiler = jstat(new String[]{"jstat", "-compiler", id});
        jstatClass.addAll(jstatCompiler);
        return jstatClass;
    }

    /**
     * 堆内存信息
     * X轴为时间，Y轴为值的变化
     * @return
     */
    public static List<KV> jstatGc() throws Exception {
        String id = ActuatorSDKUtil.getPid();
        return jstat(new String[]{"jstat", "-gc", id});
    }

    /**
     * 堆内存百分比
     * 实时监控
     * @return
     */
    public static List<KV> jstatUtil() throws Exception {
        String id = ActuatorSDKUtil.getPid();
        return jstat(new String[]{"jstat", "-gcutil", id});
    }

}
