#!/bin/bash
set -e
cd /app

# Fix the missing authentication on admin pages
# The cleanest approach is to add authentication check to header_admin_index.php
# since it's included by all admin pages (admin_index.php, user_list.php, gadget_list.php, etc.)

# Create the authentication check that will be prepended
AUTH_CHECK='<?php
session_start();
if (!isset($_SESSION['"'"'admin_email_address'"'"'])) {
    header('"'"'Location: admin_login.php'"'"');
    exit;
}
?>
'

# Fix header_admin_index.php - this protects all admin pages at once
# The file currently starts with <html>
# We need to prepend the PHP authentication block

if [ -f "/app/header_admin_index.php" ]; then
    # Check if fix already applied (idempotent)
    if ! grep -q "session_start()" /app/header_admin_index.php; then
        # Create temp file with auth check + original content
        echo "$AUTH_CHECK" > /tmp/header_fixed.php
        cat /app/header_admin_index.php >> /tmp/header_fixed.php
        mv /tmp/header_fixed.php /app/header_admin_index.php
        echo "Fixed header_admin_index.php - added authentication check"
    else
        echo "header_admin_index.php already has session check"
    fi
fi

# Also fix admin_index.php directly in case it doesn't use the header include properly
# The file currently starts with <!DOCTYPE html>
if [ -f "/app/admin_index.php" ]; then
    # Check if fix already applied (idempotent)
    if ! grep -q "session_start()" /app/admin_index.php; then
        # Create temp file with auth check + original content
        echo "$AUTH_CHECK" > /tmp/admin_index_fixed.php
        cat /app/admin_index.php >> /tmp/admin_index_fixed.php
        mv /tmp/admin_index_fixed.php /app/admin_index.php
        echo "Fixed admin_index.php - added authentication check"
    else
        echo "admin_index.php already has session check"
    fi
fi

# Fix user_list.php - add auth check before the connection include
if [ -f "/app/user_list.php" ]; then
    if ! grep -q "admin_email_address" /app/user_list.php; then
        # Insert session check at the very beginning
        # The file starts with <?php which we need to replace with our auth block
        sed -i '1s|^<?php|<?php\nsession_start();\nif (!isset($_SESSION['"'"'admin_email_address'"'"'])) {\n    header('"'"'Location: admin_login.php'"'"');\n    exit;\n}\n|' /app/user_list.php
        echo "Fixed user_list.php - added authentication check"
    else
        echo "user_list.php already has session check"
    fi
fi

# Fix gadget_list.php - add auth check before the connection include
if [ -f "/app/gadget_list.php" ]; then
    if ! grep -q "admin_email_address" /app/gadget_list.php; then
        # Insert session check at the very beginning
        sed -i '1s|^<?php|<?php\nsession_start();\nif (!isset($_SESSION['"'"'admin_email_address'"'"'])) {\n    header('"'"'Location: admin_login.php'"'"');\n    exit;\n}\n|' /app/gadget_list.php
        echo "Fixed gadget_list.php - added authentication check"
    else
        echo "gadget_list.php already has session check"
    fi
fi

echo "Fix applied successfully"
echo "All admin pages now require authentication via session check for admin_email_address"
