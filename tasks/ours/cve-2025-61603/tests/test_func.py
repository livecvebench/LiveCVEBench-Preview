"""
Functional tests for WeGIA product management module.
These tests verify that basic product operations work correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import uuid

BASE_URL = "http://localhost:80"


class TestProductFunctionality:
    """Test basic product management functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test session with authentication."""
        self.session = requests.Session()
        # The test environment should have session bypass or pre-authenticated session
        # For testing, we'll set a cookie that simulates logged-in state
        self.session.cookies.set('PHPSESSID', 'test_session_id')

    def test_api_endpoint_accessible(self):
        """Test that the control.php endpoint is accessible."""
        response = self.session.get(f"{BASE_URL}/controle/control.php", timeout=10)
        # Even without valid params, endpoint should respond (may return error for missing params)
        assert response.status_code in [200, 400, 401, 403, 500]

    def test_product_creation_valid_data(self):
        """Test creating a product with valid data."""
        unique_id = str(uuid.uuid4())[:8]
        payload = {
            "nomeClasse": "ProdutoControle",
            "metodo": "incluir",
            "descricao": f"Test Product {unique_id}",
            "codigo": f"PROD{unique_id}",
            "preco": "10.99",
            "id_categoria": "1",
            "id_unidade": "1"
        }

        start_time = time.time()
        response = self.session.post(f"{BASE_URL}/controle/control.php", data=payload, timeout=30)
        elapsed = time.time() - start_time

        # Response should complete in reasonable time (not hanging)
        assert elapsed < 10, f"Request took too long: {elapsed}s"
        # Request should complete (may redirect or show success/error message)
        assert response.status_code in [200, 302, 400, 401, 403]

    def test_product_creation_with_special_chars_in_name(self):
        """Test that products with legitimate special characters in description work."""
        unique_id = str(uuid.uuid4())[:8]
        # Legitimate special chars that should be allowed
        payload = {
            "nomeClasse": "ProdutoControle",
            "metodo": "incluir",
            "descricao": f"Test Product - Model #123 (New) {unique_id}",
            "codigo": f"PROD{unique_id}",
            "preco": "25.50",
            "id_categoria": "1",
            "id_unidade": "1"
        }

        start_time = time.time()
        response = self.session.post(f"{BASE_URL}/controle/control.php", data=payload, timeout=30)
        elapsed = time.time() - start_time

        assert elapsed < 10, f"Request took too long: {elapsed}s"
        assert response.status_code in [200, 302, 400, 401, 403]

    def test_product_list_endpoint(self):
        """Test that product listing works."""
        payload = {
            "nomeClasse": "ProdutoControle",
            "metodo": "listarDescricao",
            "nextPage": "/html/matPat/listar_produto.php"
        }

        response = self.session.post(f"{BASE_URL}/controle/control.php", data=payload, timeout=30)
        # Should return a response
        assert response.status_code in [200, 302, 400, 401, 403]

    def test_empty_description_rejected(self):
        """Test that empty product description is properly rejected."""
        unique_id = str(uuid.uuid4())[:8]
        payload = {
            "nomeClasse": "ProdutoControle",
            "metodo": "incluir",
            "descricao": "",
            "codigo": f"PROD{unique_id}",
            "preco": "10.99",
            "id_categoria": "1",
            "id_unidade": "1"
        }

        response = self.session.post(f"{BASE_URL}/controle/control.php", data=payload, timeout=30)
        # Should handle gracefully - either redirect with error or return error response
        assert response.status_code in [200, 302, 400, 401, 403]

    def test_numeric_product_code(self):
        """Test that numeric product codes work correctly."""
        unique_id = str(uuid.uuid4())[:8]
        payload = {
            "nomeClasse": "ProdutoControle",
            "metodo": "incluir",
            "descricao": f"Numeric Code Product {unique_id}",
            "codigo": "123456",
            "preco": "15.00",
            "id_categoria": "1",
            "id_unidade": "1"
        }

        start_time = time.time()
        response = self.session.post(f"{BASE_URL}/controle/control.php", data=payload, timeout=30)
        elapsed = time.time() - start_time

        assert elapsed < 10, f"Request took too long: {elapsed}s"
        assert response.status_code in [200, 302, 400, 401, 403]


class TestApplicationHealth:
    """Test that the application is healthy and responding."""

    def test_application_responds(self):
        """Test that the application is running and responds."""
        response = requests.get(BASE_URL, timeout=10)
        # Should get some response from the web server
        assert response.status_code in [200, 302, 403, 404]

    def test_control_endpoint_exists(self):
        """Test that the control endpoint exists."""
        response = requests.get(f"{BASE_URL}/controle/control.php", timeout=10)
        # Endpoint should exist (might require auth but shouldn't 404)
        assert response.status_code != 404
