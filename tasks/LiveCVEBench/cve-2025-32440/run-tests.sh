#!/bin/sh
cd "$(dirname "$0")"

# Unset proxy for localhost connections
unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY

echo "=== NetAlertX Authentication Bypass Tests ==="
echo ""

# Wait for the application to be ready
echo "Waiting for application to be ready..."
attempt=0
max_attempts=40
while [ $attempt -lt $max_attempts ]; do
    attempt=$((attempt + 1))

    # Use timeout to forcibly kill hung curl
    response=$(timeout 5 curl -s -o /dev/null -w "%{http_code}" http://localhost:20211/ 2>/dev/null || echo "000")

    if [ "$response" = "200" ] || [ "$response" = "302" ]; then
        echo "Application responding with HTTP $response"
        sleep 2
        break
    fi

    if [ $((attempt % 5)) -eq 0 ]; then
        echo "Attempt $attempt/$max_attempts (response: $response)"
    fi
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "WARNING: Application may not be ready after $max_attempts attempts"
    ps aux 2>/dev/null | grep -E "(nginx|php|python)" | head -10 || true
fi

echo ""
echo "=== Running Tests ==="
echo ""

# Run functionality tests first, then vulnerability tests
python3 -m pytest test_func.py test_vuln.py -v -rA --tb=short

echo ""
echo "=== All tests completed ==="
