#!/usr/bin/env python3
"""
Functionality tests for Cacti network monitoring application.
These tests verify that core functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import os
import re
import pytest
import requests
from bs4 import BeautifulSoup

# Configuration
CACTI_URL = os.environ.get("CACTI_URL", "http://localhost/cacti")
CACTI_USER = os.environ.get("CACTI_USER", "admin")
CACTI_PASS = os.environ.get("CACTI_PASS", "admin")


class CactiSession:
    """Helper class to manage Cacti sessions with CSRF handling"""

    def __init__(self):
        self.session = requests.Session()
        self.csrf_token = None

    def get_csrf_token(self, html_content):
        """Extract CSRF token from page content"""
        match = re.search(r'var csrfMagicToken\s*=\s*"(sid:[a-z0-9]+,[a-z0-9]+)', html_content)
        if match:
            return match.group(1)
        return None

    def login(self):
        """Login to Cacti and return True if successful"""
        # Get login page and CSRF token
        res = self.session.get(f"{CACTI_URL}/index.php", timeout=30)
        self.csrf_token = self.get_csrf_token(res.text)

        if not self.csrf_token:
            return False

        login_data = {
            '__csrf_magic': self.csrf_token,
            'action': 'login',
            'login_username': CACTI_USER,
            'login_password': CACTI_PASS
        }

        res = self.session.post(f"{CACTI_URL}/index.php", data=login_data, timeout=30)

        # Check if login was successful
        return 'You are now logged into' in res.text or 'Console' in res.text


@pytest.fixture(scope="module")
def cacti_session():
    """Create and login a Cacti session for tests"""
    session = CactiSession()
    if not session.login():
        pytest.skip("Could not login to Cacti - check credentials")
    return session


def test_cacti_web_accessible():
    """Test that Cacti web interface is accessible"""
    response = requests.get(f"{CACTI_URL}/index.php", timeout=30)
    assert response.status_code == 200
    assert "Cacti" in response.text or "cacti" in response.text.lower()


def test_cacti_login(cacti_session):
    """Test that authentication to Cacti works correctly"""
    # If we got here, the fixture already logged in successfully
    assert cacti_session.session is not None
    assert cacti_session.csrf_token is not None


def test_graph_templates_accessible(cacti_session):
    """Test that graph templates page is accessible after login"""
    response = cacti_session.session.get(f"{CACTI_URL}/graph_templates.php", timeout=30)
    assert response.status_code == 200
    # Should see graph templates content
    assert "graph_templates.php" in response.text or "Graph Templates" in response.text


def test_graph_template_list(cacti_session):
    """Test that graph templates can be listed"""
    response = cacti_session.session.get(f"{CACTI_URL}/graph_templates.php", timeout=30)
    soup = BeautifulSoup(response.text, "html.parser")

    # Look for template checkboxes or table rows
    template_elements = soup.find_all("input", id=re.compile(r"chk_\d+"))

    # Should have at least one template
    assert len(template_elements) >= 1, "Expected at least one graph template"


def test_graph_template_edit_accessible(cacti_session):
    """Test that a graph template can be opened for editing"""
    # First find a template ID
    response = cacti_session.session.get(f"{CACTI_URL}/graph_templates.php", timeout=30)
    soup = BeautifulSoup(response.text, "html.parser")
    elem = soup.find("input", id=re.compile(r"chk_\d+"))

    if not elem:
        pytest.skip("No graph template found")

    template_id = int(elem["id"].split("_")[1])

    # Try to access the template edit page
    response = cacti_session.session.get(
        f"{CACTI_URL}/graph_templates.php?action=template_edit&id={template_id}",
        timeout=30
    )
    assert response.status_code == 200
    assert "template" in response.text.lower()


def test_legitimate_template_modification(cacti_session):
    """Test that a graph template can be modified with normal values"""
    # Find a template ID
    response = cacti_session.session.get(f"{CACTI_URL}/graph_templates.php", timeout=30)
    soup = BeautifulSoup(response.text, "html.parser")
    elem = soup.find("input", id=re.compile(r"chk_\d+"))

    if not elem:
        pytest.skip("No graph template found")

    template_id = int(elem["id"].split("_")[1])

    # Get the template edit page and new CSRF token
    response = cacti_session.session.get(
        f"{CACTI_URL}/graph_templates.php?action=template_edit&id={template_id}",
        timeout=30
    )
    csrf_token = cacti_session.get_csrf_token(response.text)

    if not csrf_token:
        pytest.skip("Could not get CSRF token for template edit")

    # Submit a modification with a normal right_axis_label (no newlines)
    template_data = {
        "__csrf_magic": csrf_token,
        "name": "Unix - Logged in Users",
        "graph_template_id": template_id,
        "graph_template_graph_id": template_id,
        "save_component_template": "1",
        "title": "|host_description| - Logged in Users",
        "vertical_label": "users",
        "image_format_id": "3",
        "height": "200",
        "width": "700",
        "base_value": "1000",
        "slope_mode": "on",
        "auto_scale": "on",
        "auto_scale_opts": "2",
        "upper_limit": "100",
        "lower_limit": "0",
        "right_axis": "",
        "right_axis_label": "Normal Label",  # No newlines - legitimate value
        "right_axis_format": "0",
        "action": "save"
    }

    response = cacti_session.session.post(
        f"{CACTI_URL}/graph_templates.php?header=false",
        data=template_data,
        allow_redirects=True,
        timeout=30
    )

    # Should succeed without errors
    assert response.status_code == 200
    # Should not see SQL error or critical failure
    assert "SQL Error" not in response.text
    assert "Fatal error" not in response.text


def test_graph_json_endpoint(cacti_session):
    """Test that graph JSON endpoint responds"""
    response = cacti_session.session.get(
        f"{CACTI_URL}/graph_json.php?rra_id=0&local_graph_id=1&graph_start=1&graph_end=9999999999&graph_height=200&graph_width=700",
        timeout=30
    )
    # Should get a response (may be JSON or error depending on graph availability)
    assert response.status_code in [200, 400, 404]


def test_console_page_accessible(cacti_session):
    """Test that console/dashboard page is accessible"""
    response = cacti_session.session.get(f"{CACTI_URL}/index.php", timeout=30)
    assert response.status_code == 200
    # Should be logged in and see console content
    assert "Console" in response.text or "console" in response.text.lower() or "Dashboard" in response.text
