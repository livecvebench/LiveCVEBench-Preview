#!/bin/bash
# Solution script for fixing the SQL injection vulnerability in loginExe.php
# This script replaces the vulnerable file with a secure version using prepared statements

set -e

# The vulnerable file location in the container
VULNERABLE_FILE="/var/www/html/query/loginExe.php"

# Create the fixed version of loginExe.php using prepared statements
cat > "$VULNERABLE_FILE" << 'FIXED_PHP'
<?php
session_start();
include("../conn.php");

// Safely retrieve and sanitize input parameters
$username = isset($_POST['username']) ? trim($_POST['username']) : '';
$pass = isset($_POST['pass']) ? trim($_POST['pass']) : '';

// Use prepared statements to prevent SQL injection
$stmt = $conn->prepare("SELECT * FROM examinee_tbl WHERE exmne_email = :username AND exmne_password = :pass");
$stmt->bindParam(':username', $username, PDO::PARAM_STR);
$stmt->bindParam(':pass', $pass, PDO::PARAM_STR);
$stmt->execute();

$selAccRow = $stmt->fetch(PDO::FETCH_ASSOC);

if($stmt->rowCount() > 0)
{
    $_SESSION['examineeSession'] = array(
        'exmne_id' => $selAccRow['exmne_id'],
        'examineenakalogin' => true
    );
    $res = array("res" => "success");
}
else
{
    $res = array("res" => "invalid");
}

echo json_encode($res);
?>
FIXED_PHP

echo "Fix applied successfully to $VULNERABLE_FILE"
