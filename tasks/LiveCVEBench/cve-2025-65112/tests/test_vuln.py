"""
Vulnerability tests for PubNet package upload endpoint.

These tests verify the vulnerability status:
- FAIL in vulnerable state (unauthenticated upload succeeds)
- PASS in fixed state (unauthenticated upload is rejected)
"""
import requests
import tarfile
import io
import pytest
import time
import random
import string

BASE_URL = "http://localhost"


def create_dart_package(name=None, version="1.0.0"):
    """Create a minimal valid Dart package tar.gz in memory"""
    if name is None:
        # Generate unique package name to avoid conflicts
        suffix = ''.join(random.choices(string.ascii_lowercase, k=8))
        name = f"test_pkg_{suffix}"

    pubspec = f"""name: {name}
version: {version}
description: Test package for security verification
environment:
  sdk: '>=2.12.0 <4.0.0'
"""
    tar_buffer = io.BytesIO()
    with tarfile.open(fileobj=tar_buffer, mode='w:gz') as tar:
        info = tarfile.TarInfo(name='pubspec.yaml')
        data = pubspec.encode('utf-8')
        info.size = len(data)
        tar.addfile(info, io.BytesIO(data))
    tar_buffer.seek(0)
    return tar_buffer


class TestUnauthenticatedUpload:
    """Test that unauthenticated uploads are rejected after fix"""

    def test_upload_without_authentication_rejected(self):
        """
        Unauthenticated upload with arbitrary author-id should be rejected.

        VULNERABLE: Returns 204 (upload accepted)
        FIXED: Returns 400 with InvalidSignedUrl error
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}  # Attempting to spoof author-id
        )

        # Fixed system should reject with 400 (InvalidSignedUrl)
        # Vulnerable system accepts with 204
        assert response.status_code == 400, \
            f"Expected 400 (rejected), got {response.status_code}. " \
            f"If 204, the endpoint is still vulnerable to unauthenticated uploads."

        # Verify the rejection reason mentions signature validation
        response_text = response.text.lower()
        assert 'invalidsignedurl' in response_text or 'signature' in response_text or 'signed' in response_text, \
            f"Expected signature validation error, got: {response.text}"

    def test_upload_spoofing_admin_author_rejected(self):
        """
        Attempt to upload package as admin (author-id=1) without authentication.

        VULNERABLE: Upload succeeds, package attributed to admin
        FIXED: Request rejected before author lookup
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}  # Spoofing admin user
        )

        assert response.status_code != 204, \
            "Upload should NOT succeed without proper authentication. " \
            "The endpoint is vulnerable to identity spoofing."

    def test_upload_spoofing_various_author_ids_rejected(self):
        """
        Test multiple author ID spoofing attempts are all rejected.
        """
        for author_id in ['1', '2', '3', '10', '100']:
            package = create_dart_package()
            response = requests.post(
                f"{BASE_URL}/api/storage/upload",
                files={'file': ('test.tar.gz', package, 'application/gzip')},
                data={'author-id': author_id}
            )

            assert response.status_code != 204, \
                f"Spoofing author-id={author_id} should be rejected, but upload succeeded."


class TestQueryParameterManipulation:
    """Test that URL parameter manipulation is detected"""

    def test_unsigned_url_with_authorid_query_param_rejected(self):
        """
        Attempt to bypass by using query parameter authorId alongside form data.

        VULNERABLE: Returns 204 (upload accepted via form data)
        FIXED: ValidateSignature() rejects requests without valid signature
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload?authorId=1",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}  # Form data that vulnerable version uses
        )

        assert response.status_code == 400, \
            f"Upload with query param should be rejected. Got {response.status_code}"

    def test_tampered_signature_rejected(self):
        """
        Attempt with a fake/tampered signature parameter but valid form data.

        VULNERABLE: Returns 204 (form data accepted, signature ignored)
        FIXED: Signature validation fails
        """
        package = create_dart_package()
        # Try with a made-up signature value but also include form author-id
        response = requests.post(
            f"{BASE_URL}/api/storage/upload?authorId=1&signature=fakesig123",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}  # Vulnerable version uses this
        )

        assert response.status_code == 400, \
            f"Tampered signature should be rejected. Got {response.status_code}"

    def test_empty_signature_rejected(self):
        """
        Attempt with empty signature parameter but valid form data.

        VULNERABLE: Returns 204 (form data accepted)
        FIXED: Signature validation fails
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload?authorId=1&signature=",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}  # Vulnerable version uses this
        )

        assert response.status_code == 400, \
            f"Empty signature should be rejected. Got {response.status_code}"


class TestFormDataBypass:
    """Test various form data bypass attempts"""

    def test_form_data_author_id_ignored(self):
        """
        Form data author-id should be ignored in fixed version.
        Fixed version uses query parameter authorId from signed URL only.
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}
        )

        # Should be rejected because no valid signed URL
        assert response.status_code == 400, \
            f"Form data author-id should not authorize upload. Got {response.status_code}"

    def test_both_form_and_query_author_id_rejected(self):
        """
        Even if both form data and query parameter are provided,
        without valid signature it should be rejected.
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload?authorId=1",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}
        )

        assert response.status_code == 400, \
            f"Request with both form and query author-id (unsigned) should be rejected. Got {response.status_code}"


class TestMultipleUploadAttempts:
    """Test multiple rapid upload attempts are all rejected"""

    def test_rapid_upload_attempts_all_rejected(self):
        """
        Multiple rapid unauthenticated upload attempts should all fail.
        """
        results = []
        for i in range(5):
            package = create_dart_package()
            response = requests.post(
                f"{BASE_URL}/api/storage/upload",
                files={'file': ('test.tar.gz', package, 'application/gzip')},
                data={'author-id': '1'}
            )
            results.append(response.status_code)

        # All attempts should be rejected (400)
        successful_uploads = [r for r in results if r == 204]
        assert len(successful_uploads) == 0, \
            f"Some unauthenticated uploads succeeded: {results}"

    def test_different_author_ids_all_rejected(self):
        """
        Cycling through different author IDs should all be rejected.
        """
        for author_id in range(1, 11):
            package = create_dart_package()
            response = requests.post(
                f"{BASE_URL}/api/storage/upload",
                files={'file': ('test.tar.gz', package, 'application/gzip')},
                data={'author-id': str(author_id)}
            )

            assert response.status_code == 400, \
                f"Upload as author-id={author_id} should be rejected. Got {response.status_code}"


class TestResponseContent:
    """Verify response content indicates proper rejection"""

    def test_rejection_response_contains_signature_error(self):
        """
        Rejection response should indicate signature validation failure.
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}
        )

        assert response.status_code == 400

        # Check response body mentions signature issue
        response_lower = response.text.lower()
        has_signature_error = any(term in response_lower for term in [
            'invalidsignedurl', 'signature', 'signed', 'invalid'
        ])

        assert has_signature_error, \
            f"Response should mention signature validation error. Got: {response.text}"

    def test_location_header_not_returned_on_rejection(self):
        """
        Rejected uploads should not return a Location header with finalize URL.

        VULNERABLE: Returns 204 with Location header (upload accepted)
        FIXED: Returns 400 without Location header
        """
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '1'}
        )

        # Fixed version should reject (400) and not have Location header
        # Vulnerable version returns 204 with Location header
        assert response.status_code == 400, \
            f"Upload should be rejected with 400. Got {response.status_code}"

        location = response.headers.get('Location')
        assert location is None, \
            f"Rejected request should not have Location header. Got: {location}"
