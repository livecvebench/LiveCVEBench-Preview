#!/bin/bash
set -e

cd "$(dirname "$0")"

# The Dockerfile has already installed:
# - social-auth-app-django==5.5.0 (vulnerable version)
# - pytest, pytest-django
# So we just use those directly

export DJANGO_SETTINGS_MODULE=test_settings
export PYTHONPATH="/tests:$PYTHONPATH"

echo "=== Verifying environment ==="
python -c "import social_django; print(f'social-auth-app-django version: {social_django.__version__}')"

# Clean database for fresh test state
echo "=== Cleaning test database ==="
rm -f test.db

echo "=== Running migrations ==="
python -c "
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'test_settings')
import django
django.setup()
from django.core.management import call_command
call_command('migrate', '--run-syncdb', verbosity=0)
"

# Run both test files together with pytest -rA to get a summary
echo "=== Running all tests ==="
pytest test_func.py test_vuln.py -v --tb=no -rA 2>&1 || true

echo "=== Tests completed ==="
