#!/bin/bash
# Entrypoint script with restart loop for Flask app
# This allows solution.sh to restart the service after applying fixes

cd /app

# Wait for MySQL to be ready
echo "Waiting for MySQL..."
while ! mysqladmin ping -h mysql -u root -popenvpn --silent 2>/dev/null; do
    sleep 1
done
echo "MySQL is ready!"

# Initialize database tables and create super user if not exists
python -c "
from app.app import create_app
from lin.db import db
from lin.core import User

app = create_app(environment='production')
with app.app_context():
    # Tables are created in create_app already
    # Check if super user exists
    existing = User.query.filter_by(username='super').first()
    if not existing:
        with db.auto_commit():
            user = User()
            user.username = 'super'
            user.password = 'openvpn@123456'
            user.email = 'hello_openvpn@163.com'
            user.admin = 2
            db.session.add(user)
        print('Super user created')
    else:
        print('Super user already exists')
"

# Start Flask in a restart loop
while true; do
    echo "Starting Flask application..."
    python starter.py
    exit_code=$?
    echo "Flask exited with code $exit_code. Restarting in 2 seconds..."
    sleep 2
done
