"""
Functional tests for Student Management System.
These tests verify the application works correctly and should PASS
in both vulnerable and fixed states.
"""

import requests
import time
import pytest

BASE_URL = "http://localhost"
TIMEOUT = 10


class TestApplicationAvailability:
    """Test that the application is accessible and running."""

    def test_login_page_accessible(self):
        """Verify the login page loads successfully."""
        response = requests.get(f"{BASE_URL}/grading/login.php", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Student Management System" in response.text or "CHMSC" in response.text

    def test_uprec_endpoint_exists(self):
        """Verify the uprec.php endpoint exists and responds."""
        response = requests.post(
            f"{BASE_URL}/grading/uprec.php",
            data={"id": "1"},
            timeout=TIMEOUT
        )
        # The endpoint should respond (may return error due to missing fields, but should not 404)
        assert response.status_code != 404

    def test_index_page_accessible(self):
        """Verify index.php is accessible."""
        response = requests.get(f"{BASE_URL}/grading/", timeout=TIMEOUT)
        assert response.status_code == 200


class TestDatabaseConnection:
    """Test that database connectivity is working."""

    def test_no_database_error_on_login_page(self):
        """Verify no database connection errors on login page."""
        response = requests.get(f"{BASE_URL}/grading/login.php", timeout=TIMEOUT)
        assert response.status_code == 200
        # Check for common database error indicators
        response_lower = response.text.lower()
        assert "unable to connect" not in response_lower
        assert "connection refused" not in response_lower
        assert "access denied" not in response_lower


class TestNormalOperation:
    """Test normal application operations with valid input."""

    def test_uprec_with_valid_numeric_id(self):
        """Verify uprec.php works with valid numeric ID."""
        response = requests.post(
            f"{BASE_URL}/grading/uprec.php",
            data={"id": "1"},
            timeout=TIMEOUT,
            allow_redirects=False
        )
        # Should respond without hanging (within timeout)
        # Response time should be reasonable for a simple query
        assert response.status_code in [200, 302, 303]

    def test_uprec_with_different_valid_ids(self):
        """Verify uprec.php accepts various valid numeric IDs."""
        valid_ids = ["1", "2", "10", "100", "999"]
        for test_id in valid_ids:
            response = requests.post(
                f"{BASE_URL}/grading/uprec.php",
                data={"id": test_id},
                timeout=TIMEOUT,
                allow_redirects=False
            )
            assert response.status_code in [200, 302, 303], f"Failed for id={test_id}"

    def test_uprec_response_time_with_valid_input(self):
        """Verify response time is reasonable with valid input."""
        start_time = time.time()
        response = requests.post(
            f"{BASE_URL}/grading/uprec.php",
            data={"id": "1"},
            timeout=TIMEOUT,
            allow_redirects=False
        )
        elapsed = time.time() - start_time
        # Normal request should complete in under 2 seconds
        assert elapsed < 2, f"Response took too long: {elapsed:.2f}s"


class TestApplicationIntegrity:
    """Test that the application maintains its core functionality."""

    def test_static_assets_available(self):
        """Verify CSS/JS assets are available."""
        # Just verify the grading directory serves content
        response = requests.get(f"{BASE_URL}/grading/login.php", timeout=TIMEOUT)
        assert response.status_code == 200
        # Should contain HTML structure
        assert "<html" in response.text.lower()
        assert "<form" in response.text.lower()

    def test_php_execution(self):
        """Verify PHP is executing (not showing source)."""
        response = requests.get(f"{BASE_URL}/grading/login.php", timeout=TIMEOUT)
        assert response.status_code == 200
        # Should not show raw PHP code
        assert "<?php" not in response.text
        assert "<?=" not in response.text

    def test_form_elements_present(self):
        """Verify login form elements are present."""
        response = requests.get(f"{BASE_URL}/grading/login.php", timeout=TIMEOUT)
        assert response.status_code == 200
        # Check for form elements
        assert "user" in response.text.lower()
        assert "password" in response.text.lower() or "pwd" in response.text.lower()
