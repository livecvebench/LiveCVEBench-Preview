#!/bin/bash
set -e

# Wait for database to be ready (optional, for future use)
if [ -n "$DB_HOST" ]; then
    echo "Waiting for database to be ready..."
    for i in {1..30}; do
        if mysqladmin ping -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" --silent 2>/dev/null; then
            echo "Database is ready!"
            break
        fi
        echo "Waiting for database... ($i/30)"
        sleep 2
    done
fi

# Create config.php from template if it doesn't exist
if [ ! -f /var/www/WeGIA/config.php ]; then
    cp /var/www/WeGIA/config.php.init /var/www/WeGIA/config.php

    # Update database host
    sed -i "s/define( 'DB_HOST', 'localhost');/define( 'DB_HOST', '${DB_HOST:-db}');/" /var/www/WeGIA/config.php
    sed -i "s/define( 'DB_NAME', 'wegia' );/define( 'DB_NAME', '${DB_NAME:-wegia}' );/" /var/www/WeGIA/config.php
    sed -i "s/define( 'DB_USER', 'wegiauser' );/define( 'DB_USER', '${DB_USER:-wegiauser}' );/" /var/www/WeGIA/config.php
    sed -i "s/define( 'DB_PASSWORD', 'senha' );/define( 'DB_PASSWORD', '${DB_PASSWORD:-wegia_password}' );/" /var/www/WeGIA/config.php
    sed -i "s|define( 'WWW', 'https://demo.wegia.org/');|define( 'WWW', 'http://localhost/');|" /var/www/WeGIA/config.php
fi

# Initialize Git repository if not exists (REQUIRED for vulnerability)
cd /var/www/WeGIA
if [ ! -d .git ]; then
    # Set global git config (safe for container)
    export HOME=/root
    git config --global user.email "docker@example.com"
    git config --global user.name "Docker Container"
    git config --global init.defaultBranch master
    # Add the directory to safe directories to avoid dubious ownership error
    git config --global --add safe.directory /var/www/WeGIA

    git init
    # Only add a few essential files to avoid huge commit
    git add html/configuracao/debug_info.php config.php 2>/dev/null || git add html/configuracao/debug_info.php
    git commit -m "Initial commit" --allow-empty 2>/dev/null || true
    echo "Git repository initialized."
else
    echo "Git repository already exists."
fi

# Modify debug_info.php to bypass authentication and permissions for testing
DEBUG_FILE="/var/www/WeGIA/html/configuracao/debug_info.php"
if [ -f "$DEBUG_FILE" ]; then
    # Use perl for cleaner regex replacement (handles special characters better)
    # 1. Replace the session check condition with always-false
    perl -i -pe "s/if\(!isset\(.*\['usuario'\]\)\)\{/if(false){ \/\/ Auth bypass/" "$DEBUG_FILE"

    # 2. Add mock session variables after session_start();
    perl -i -pe 's/(session_start\(\);)/$1\n    \$_SESSION["usuario"] = "test"; \$_SESSION["id_pessoa"] = 1;/' "$DEBUG_FILE"

    # 3. Comment out permission check if it exists
    perl -i -pe 's/permissao\(\$_SESSION/\/\/ permissao(\$_SESSION/g' "$DEBUG_FILE"

    # 4. Mock the getGitHubBranches function to return empty array (avoid slow API call)
    # Replace the function body to just return an empty array
    perl -i -0777 -pe 's/function getGitHubBranches\(\$owner, \$repo\)\s*\{[^}]*\}/function getGitHubBranches(\$owner, \$repo) { return array(array("name" => "master")); }/s' "$DEBUG_FILE"

    echo "Authentication and permission bypass applied to debug_info.php"
fi

# Permissions are set in Dockerfile - update git directory for proper access
chown -R www-data:www-data /var/www/WeGIA/.git 2>/dev/null || true

# Create backup directory
mkdir -p /var/www/bkpWeGIA
chown www-data:www-data /var/www/bkpWeGIA

echo "Starting Apache..."
exec apache2-foreground
