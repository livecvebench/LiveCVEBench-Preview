FROM php:8.2-apache

WORKDIR /var/www/html

# Install system dependencies (tmux, asciinema, curl, gcc, g++ are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    default-mysql-client \
    libzip-dev \
    libpng-dev \
    libonig-dev \
    && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install \
    pdo_mysql \
    mysqli \
    mbstring \
    gd \
    zip

# Enable Apache modules
RUN a2enmod rewrite

# Get source code and remove git history
RUN git clone --branch v3.2.6 --depth 1 https://github.com/LabRedesCefetRJ/WeGIA.git . && \
    rm -rf .git

# Create backup directory
RUN mkdir -p /var/www/bkpWeGIA && \
    chown -R www-data:www-data /var/www/html && \
    chown -R www-data:www-data /var/www/bkpWeGIA

# Copy corrected config.php with proper WWW setting
COPY task-deps/config.php config.php

# Copy modified PHP file with authentication bypass for testing
COPY task-deps/pre_cadastro_funcionario.php html/funcionario/pre_cadastro_funcionario.php

# Copy minimal personalizacao_display.php to avoid require errors
COPY task-deps/personalizacao_display.php html/personalizacao_display.php

# Fix permissions for www-data
RUN chown -R www-data:www-data /var/www/html