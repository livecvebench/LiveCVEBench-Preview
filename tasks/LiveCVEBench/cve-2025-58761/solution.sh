#!/bin/bash
set -e

echo "=== Applying path traversal fix to Tautulli ==="

cd /app/tautulli

# Step 1: Add the is_subdir helper function to plexpy/helpers.py
echo "Adding is_subdir helper function..."

# Check if is_subdir function already exists (idempotency check)
if ! grep -q "def is_subdir" plexpy/helpers.py; then
    cat >> plexpy/helpers.py << 'EOF'


def is_subdir(child: str, parent: str) -> bool:
    """Check if child path is a subdirectory of parent path."""
    child = os.path.abspath(child)
    parent = os.path.abspath(parent)
    return os.path.commonpath([parent]) == os.path.commonpath([parent, child])
EOF
    echo "Added is_subdir function to helpers.py"
else
    echo "is_subdir function already exists in helpers.py"
fi

# Step 2: Patch the real_pms_image_proxy function in webserve.py
echo "Patching real_pms_image_proxy function in webserve.py..."

# Create the patch for the vulnerable code section
# The vulnerable code block:
#   if isinstance(img, str) and img.startswith('interfaces/default/images'):
#       fp = os.path.join(plexpy.PROG_DIR, 'data', img)
#       ...
#       return serve_file(path=fp, content_type=content_type)

# First, check if the patch has already been applied
if grep -q "helpers.is_subdir" plexpy/webserve.py; then
    echo "Fix already applied to webserve.py"
else
    # Apply the fix using sed
    # Replace the vulnerable code with the fixed version

    # Step 2a: Replace "fp = os.path.join(plexpy.PROG_DIR, 'data', img)" with the new validation block
    sed -i "s/fp = os.path.join(plexpy.PROG_DIR, 'data', img)/resource_dir = os.path.join(plexpy.PROG_DIR, 'data\/interfaces\/default\/images')\n            img_path = os.path.join(plexpy.PROG_DIR, 'data', img)\n            if not helpers.is_subdir(img_path, resource_dir):\n                return/g" plexpy/webserve.py

    # Step 2b: Replace "return serve_file(path=fp," with "return serve_file(path=img_path,"
    sed -i "s/return serve_file(path=fp,/return serve_file(path=img_path,/g" plexpy/webserve.py

    echo "Applied fix to webserve.py"
fi

# Step 3: Restart Tautulli to apply changes
echo "Restarting Tautulli service..."

# Kill the running Tautulli process so the entrypoint can restart it
pkill -f "python.*Tautulli.py" || true
pkill -f "Tautulli.py" || true

# Give it time to shut down
sleep 3

echo "=== Fix applied successfully ==="
echo "Tautulli will be restarted by the container entrypoint."
