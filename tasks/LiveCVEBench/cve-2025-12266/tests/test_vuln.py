"""
Vulnerability tests for CVE-2025-12266 - ThinkPHP Code Injection.

These tests verify that the code injection vulnerability is properly mitigated.
- FAIL in vulnerable state (exploitation succeeds)
- PASS in fixed state (exploitation is blocked)

CVE-2025-12266 specifically affects ThinkPHP 5.0.x namespace injection via
the invokefunction controller method.
"""
import requests
import pytest
import os

# Base URL for the application
BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")

# Indicators of successful command execution
COMMAND_EXECUTION_INDICATORS = [
    'uid=',           # Linux id command output
    'gid=',           # Group ID from id command
    'groups=',        # Groups from id command
]

# Indicators of PHP code execution
PHP_EXECUTION_INDICATORS = [
    'PHP Version',    # phpinfo() output
    'Configuration File', # phpinfo configuration section
]


def contains_execution_indicator(text, indicators):
    """Check if response text contains any execution indicators."""
    text_lower = text.lower()
    for indicator in indicators:
        if indicator.lower() in text_lower:
            return True, indicator
    return False, None


class TestThinkPHPNamespaceInjection:
    """
    Test ThinkPHP namespace injection vulnerability (CVE-2025-12266).

    This vulnerability allows attackers to invoke arbitrary PHP functions
    by manipulating the controller namespace path via the 's' parameter.
    """

    def test_invokefunction_system_via_index(self):
        """Test namespace injection to call system() via index module."""
        payload = "/index.php?s=/index/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, indicator = contains_execution_indicator(response.text, COMMAND_EXECUTION_INDICATORS)
        assert not found, \
            f"Command execution detected! Found '{indicator}' in response. Namespace injection should be blocked."

    def test_invokefunction_system_via_auth(self):
        """Test namespace injection to call system() via auth module."""
        payload = "/index.php?s=/auth/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, indicator = contains_execution_indicator(response.text, COMMAND_EXECUTION_INDICATORS)
        assert not found, \
            f"Command execution detected! Found '{indicator}' in response."

    def test_invokefunction_passthru(self):
        """Test namespace injection with passthru() function."""
        payload = "/index.php?s=/auth/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=passthru&vars[1][]=id"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, indicator = contains_execution_indicator(response.text, COMMAND_EXECUTION_INDICATORS)
        assert not found, \
            f"Command execution detected via passthru! Found '{indicator}'."

    def test_invokefunction_shell_exec(self):
        """Test namespace injection with shell_exec() function."""
        payload = "/index.php?s=/auth/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=shell_exec&vars[1][]=id"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, indicator = contains_execution_indicator(response.text, COMMAND_EXECUTION_INDICATORS)
        assert not found, \
            f"Command execution detected via shell_exec!"

    def test_invokefunction_exec(self):
        """Test namespace injection with exec() function."""
        payload = "/index.php?s=/auth/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=exec&vars[1][]=id"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, indicator = contains_execution_indicator(response.text, COMMAND_EXECUTION_INDICATORS)
        assert not found, \
            f"Command execution detected via exec!"

    def test_invokefunction_phpinfo(self):
        """Test namespace injection to call phpinfo()."""
        payload = "/index.php?s=/index/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=-1"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, indicator = contains_execution_indicator(response.text, PHP_EXECUTION_INDICATORS)
        assert not found, \
            f"PHP code execution detected! Found '{indicator}'. phpinfo() should not be callable."

    def test_mixed_case_bypass_think(self):
        """Test mixed case 'ThInK' to bypass potential filters."""
        payload = "/index.php?s=/auth/\\ThInK\\ApP/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, _ = contains_execution_indicator(response.text, COMMAND_EXECUTION_INDICATORS)
        assert not found, f"Mixed case bypass succeeded"

    def test_uppercase_bypass_think(self):
        """Test uppercase 'THINK' to bypass potential filters."""
        payload = "/index.php?s=/auth/\\THINK\\APP/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id"
        response = requests.get(f"{BASE_URL}{payload}", timeout=15)

        found, _ = contains_execution_indicator(response.text, COMMAND_EXECUTION_INDICATORS)
        assert not found, f"Uppercase bypass succeeded"
