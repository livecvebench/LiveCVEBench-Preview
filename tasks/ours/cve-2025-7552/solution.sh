#!/bin/bash
# Fix for authentication bypass via URL encoding in AuthorizationInterceptor
# The fix changes getRequestURI() to getServletPath() for proper URL decoding
#
# This script uses an efficient approach:
# 1. Patch the source file
# 2. Compile just the single changed class
# 3. Update it directly in the JAR (no full Maven rebuild)
# 4. Restart the application

echo "=== Applying CVE-2025-7552 Fix ==="

INTERCEPTOR_FILE="/app/northstar-main/src/main/java/org/dromara/northstar/web/interceptor/AuthorizationInterceptor.java"
JAR_FILE="/app/northstar-dist/northstar-7.3.5.jar"
CLASS_PATH="BOOT-INF/classes/org/dromara/northstar/web/interceptor/AuthorizationInterceptor.class"

# Step 1: Check and patch source file
echo ""
echo "Step 1: Patching source file..."

if [ ! -f "$INTERCEPTOR_FILE" ]; then
    echo "Error: Source file not found at $INTERCEPTOR_FILE"
    exit 1
fi

# Check if already fixed
if grep -q "req\.getServletPath()" "$INTERCEPTOR_FILE"; then
    echo "Source file already patched (getServletPath found)"
else
    if grep -q "req\.getRequestURI()" "$INTERCEPTOR_FILE"; then
        echo "Found vulnerable code: req.getRequestURI()"
        sed -i 's/req\.getRequestURI()/req.getServletPath()/g' "$INTERCEPTOR_FILE"
        echo "Patched: Changed getRequestURI() to getServletPath()"
    else
        echo "Error: Cannot find expected vulnerable pattern"
        exit 1
    fi
fi

# Verify source was patched
if ! grep -q "req\.getServletPath()" "$INTERCEPTOR_FILE"; then
    echo "Error: Source patch verification failed"
    exit 1
fi

# Step 2: Compile the modified class
echo ""
echo "Step 2: Compiling modified class..."

cd /app

# Create temporary directory for compilation
WORK_DIR=$(mktemp -d)
echo "Work directory: $WORK_DIR"

# Extract classpath libraries from JAR
echo "Extracting dependencies..."
jar xf "$JAR_FILE" BOOT-INF/lib BOOT-INF/classes

# Build classpath from extracted libs
CLASSPATH="BOOT-INF/classes"
for jar in BOOT-INF/lib/*.jar; do
    CLASSPATH="$CLASSPATH:$jar"
done

# Compile the patched file
echo "Compiling AuthorizationInterceptor.java..."
javac -d "$WORK_DIR" -cp "$CLASSPATH" \
    -source 21 -target 21 \
    "$INTERCEPTOR_FILE" 2>&1 || {
    echo "Compilation failed, trying with different options..."
    # Try without explicit source/target
    javac -d "$WORK_DIR" -cp "$CLASSPATH" "$INTERCEPTOR_FILE" 2>&1 || {
        echo "Error: Compilation failed"
        rm -rf "$WORK_DIR" BOOT-INF
        exit 1
    }
}

# Verify the compiled class
if [ ! -f "$WORK_DIR/org/dromara/northstar/web/interceptor/AuthorizationInterceptor.class" ]; then
    echo "Error: Compiled class not found"
    rm -rf "$WORK_DIR" BOOT-INF
    exit 1
fi

# Check that the compiled class has the fix
if strings "$WORK_DIR/org/dromara/northstar/web/interceptor/AuthorizationInterceptor.class" | grep -q "getServletPath"; then
    echo "Verification: Compiled class contains getServletPath()"
else
    echo "Error: Compiled class does not contain the fix"
    rm -rf "$WORK_DIR" BOOT-INF
    exit 1
fi

# Step 3: Update the JAR with the new class
echo ""
echo "Step 3: Updating JAR file..."

# Copy compiled class to correct location
mkdir -p BOOT-INF/classes/org/dromara/northstar/web/interceptor/
cp "$WORK_DIR/org/dromara/northstar/web/interceptor/AuthorizationInterceptor.class" \
   "BOOT-INF/classes/org/dromara/northstar/web/interceptor/"

# Update the JAR
echo "Updating $JAR_FILE..."
jar uf "$JAR_FILE" "$CLASS_PATH"

# Verify the JAR was updated
jar xf "$JAR_FILE" "$CLASS_PATH"
if strings "BOOT-INF/classes/org/dromara/northstar/web/interceptor/AuthorizationInterceptor.class" | grep -q "getServletPath"; then
    echo "Verification: JAR contains fixed class with getServletPath()"
else
    echo "Error: JAR update verification failed"
    rm -rf "$WORK_DIR" BOOT-INF
    exit 1
fi

# Cleanup
rm -rf "$WORK_DIR" BOOT-INF

# Step 4: Restart the application
echo ""
echo "Step 4: Restarting application..."

# Kill the running Java process
pkill -f "java.*northstar-7.3.5.jar" || true
sleep 2

# The entrypoint.sh loop will restart the app automatically
echo "Application process killed - entrypoint will restart it"

# Wait for the app to restart (up to 60 seconds)
echo "Waiting for application to restart..."
MAX_WAIT=60
WAITED=0

while [ $WAITED -lt $MAX_WAIT ]; do
    sleep 2
    WAITED=$((WAITED + 2))

    # Check if app is responding
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:80/northstar/log" 2>/dev/null || echo "000")
    if [ "$HTTP_CODE" = "401" ]; then
        echo "Application is ready! (protected endpoint returns 401)"
        break
    fi

    if [ $((WAITED % 10)) -eq 0 ]; then
        echo "Waiting for application... ($WAITED/$MAX_WAIT seconds)"
    fi
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo "Warning: Application may not be fully ready after ${MAX_WAIT} seconds"
fi

echo ""
echo "=== Fix Applied Successfully ==="
echo "The AuthorizationInterceptor now uses getServletPath() instead of getRequestURI()"
echo "This ensures URL-encoded characters are decoded before path checks"
