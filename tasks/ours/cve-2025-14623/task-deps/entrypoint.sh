#!/bin/bash
set -e

# Start MySQL/MariaDB service
service mariadb start

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready..."
for i in {1..30}; do
    if mysql -e "SELECT 1" &>/dev/null; then
        echo "MySQL is ready!"
        break
    fi
    echo "Waiting... ($i/30)"
    sleep 1
done

# Configure MySQL to allow root login without password
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY ''; FLUSH PRIVILEGES;" 2>/dev/null || true

# Initialize database
echo "Initializing database..."
mysql -e "CREATE DATABASE IF NOT EXISTS db_sfms;"
mysql db_sfms < /var/www/html/SFMS/db/db_sfms.sql

echo "Database initialized successfully!"

# Set proper permissions for files directory
chmod -R 777 /var/www/html/SFMS/files/ 2>/dev/null || true

# Start Apache in foreground
echo "Starting Apache..."
exec apache2ctl -D FOREGROUND
