#!/usr/bin/env python3
"""
Vulnerability Tests for ImageSharp GIF Decoder

These tests verify vulnerability status:
- FAIL in vulnerable state (application hangs/times out)
- PASS in fixed state (proper exception is thrown quickly)

The vulnerability is that malformed GIF files with comment blocks
missing the block terminator cause an infinite loop in ReadComments().
"""

import subprocess
import os
import tempfile
import struct
import pytest
import time

# Path to the application in container
APP_DIR = "/app/test"
TEST_DIR = "/tests"

# Timeout for vulnerability detection (seconds)
# Vulnerable code hangs forever; fixed code throws exception immediately
VULN_TIMEOUT = 5


def create_malformed_gif_no_terminator(comment: bytes = b"test!") -> bytes:
    """
    Create a malformed GIF with comment block missing block terminator.
    This triggers the infinite loop vulnerability.
    """
    gif_data = bytearray()

    # GIF Header
    gif_data.extend(b'GIF89a')

    # Logical Screen Descriptor
    gif_data.extend(struct.pack('<H', 1))  # Width
    gif_data.extend(struct.pack('<H', 1))  # Height
    gif_data.append(0x00)  # No global color table
    gif_data.append(0x00)  # Background color
    gif_data.append(0x00)  # Aspect ratio

    # Comment Extension Block (MALFORMED - missing terminator)
    gif_data.append(0x21)  # Extension Introducer
    gif_data.append(0xFE)  # Comment Label
    gif_data.append(len(comment))  # Sub-block size
    gif_data.extend(comment)  # Comment data
    # INTENTIONALLY MISSING: 0x00 block terminator

    return bytes(gif_data)


def create_malformed_gif_truncated_mid_comment() -> bytes:
    """
    Create a GIF that's truncated in the middle of a comment sub-block.
    """
    gif_data = bytearray()

    # GIF Header
    gif_data.extend(b'GIF89a')

    # Logical Screen Descriptor
    gif_data.extend(struct.pack('<H', 1))
    gif_data.extend(struct.pack('<H', 1))
    gif_data.append(0x00)
    gif_data.append(0x00)
    gif_data.append(0x00)

    # Comment block - says 10 bytes but only provides 5
    gif_data.append(0x21)
    gif_data.append(0xFE)
    gif_data.append(10)  # Claims 10 bytes
    gif_data.extend(b'short')  # Only 5 bytes - truncated!

    return bytes(gif_data)


def create_malformed_gif_multiple_subblocks_no_terminator() -> bytes:
    """
    Create a GIF with multiple comment sub-blocks but no final terminator.
    """
    gif_data = bytearray()

    # GIF Header
    gif_data.extend(b'GIF89a')

    # Logical Screen Descriptor
    gif_data.extend(struct.pack('<H', 1))
    gif_data.extend(struct.pack('<H', 1))
    gif_data.append(0x00)
    gif_data.append(0x00)
    gif_data.append(0x00)

    # Comment Extension
    gif_data.append(0x21)
    gif_data.append(0xFE)

    # Multiple sub-blocks
    gif_data.append(5)
    gif_data.extend(b'first')
    gif_data.append(6)
    gif_data.extend(b'second')
    gif_data.append(5)
    gif_data.extend(b'third')
    # NO TERMINATOR

    return bytes(gif_data)


def create_malformed_gif_large_comment_no_terminator() -> bytes:
    """
    Create a GIF with a 255-byte comment block and no terminator.
    """
    gif_data = bytearray()

    # GIF Header
    gif_data.extend(b'GIF89a')

    # Logical Screen Descriptor
    gif_data.extend(struct.pack('<H', 1))
    gif_data.extend(struct.pack('<H', 1))
    gif_data.append(0x00)
    gif_data.append(0x00)
    gif_data.append(0x00)

    # Comment Extension with max-size sub-block
    gif_data.append(0x21)
    gif_data.append(0xFE)
    gif_data.append(255)  # Max sub-block size
    gif_data.extend(b'A' * 255)
    # NO TERMINATOR

    return bytes(gif_data)


def run_dotnet_test(gif_path: str, timeout: int = VULN_TIMEOUT) -> tuple:
    """
    Run the dotnet application with the given GIF file using SkipMetadata=true.
    The vulnerability only triggers with SkipMetadata=true.
    Returns (return_code, stdout, stderr, timed_out)
    """
    try:
        start = time.time()
        result = subprocess.run(
            ["dotnet", "/app/test/publish/ImageTestFromSource.dll", gif_path, "skip-metadata"],
            capture_output=True,
            text=True,
            timeout=timeout,
            cwd=APP_DIR
        )
        elapsed = time.time() - start
        return (result.returncode, result.stdout, result.stderr, False, elapsed)
    except subprocess.TimeoutExpired:
        return (None, "", "TIMEOUT", True, timeout)


class TestMalformedGifHandling:
    """Tests for malformed GIF handling - should throw exception, not hang."""

    def test_missing_block_terminator_basic(self):
        """
        Test GIF with comment block missing the 0x00 terminator.

        Expected behavior:
        - Vulnerable: Hangs forever (times out)
        - Fixed: Throws InvalidImageContentException quickly
        """
        gif_data = create_malformed_gif_no_terminator(b"test!")

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(temp_path)

            # FAIL condition: timed out (vulnerable - infinite loop)
            assert not timed_out, (
                f"Vulnerable: Application hung for {VULN_TIMEOUT}s processing malformed GIF. "
                f"Expected: Quick exception. Got: Timeout (infinite loop detected)"
            )

            # PASS condition: should return quickly with error about malformed content
            assert elapsed < VULN_TIMEOUT - 1, (
                f"Application took {elapsed:.1f}s to respond - may still be vulnerable"
            )

            # Should indicate an error was thrown
            assert retcode != 0 or "exception" in stdout.lower() or "error" in stdout.lower() or "invalid" in stdout.lower(), (
                f"Expected exception for malformed GIF. Got: retcode={retcode}, stdout={stdout}"
            )

        finally:
            os.unlink(temp_path)

    def test_missing_block_terminator_long_comment(self):
        """
        Test GIF with a longer comment and missing terminator.
        """
        long_comment = b"This is a longer comment string for testing " * 3
        gif_data = create_malformed_gif_no_terminator(long_comment)

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(temp_path)

            assert not timed_out, (
                f"Vulnerable: Infinite loop detected with long comment. "
                f"Application hung for {VULN_TIMEOUT}s."
            )
            assert elapsed < VULN_TIMEOUT - 1

        finally:
            os.unlink(temp_path)

    def test_truncated_mid_comment(self):
        """
        Test GIF truncated in the middle of a comment sub-block.
        """
        gif_data = create_malformed_gif_truncated_mid_comment()

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(temp_path)

            assert not timed_out, (
                f"Vulnerable: Infinite loop on truncated comment. "
                f"Application hung for {VULN_TIMEOUT}s."
            )

        finally:
            os.unlink(temp_path)

    def test_multiple_subblocks_no_terminator(self):
        """
        Test GIF with multiple comment sub-blocks but no final terminator.
        """
        gif_data = create_malformed_gif_multiple_subblocks_no_terminator()

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(temp_path)

            assert not timed_out, (
                f"Vulnerable: Infinite loop with multiple sub-blocks. "
                f"Application hung for {VULN_TIMEOUT}s."
            )

        finally:
            os.unlink(temp_path)

    def test_max_size_subblock_no_terminator(self):
        """
        Test GIF with maximum-size (255 byte) comment sub-block and no terminator.
        """
        gif_data = create_malformed_gif_large_comment_no_terminator()

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(temp_path)

            assert not timed_out, (
                f"Vulnerable: Infinite loop with 255-byte sub-block. "
                f"Application hung for {VULN_TIMEOUT}s."
            )

        finally:
            os.unlink(temp_path)


class TestEofHandling:
    """Tests specifically for end-of-file handling in comment parsing."""

    def test_eof_after_comment_label(self):
        """Test GIF that ends immediately after the comment label byte."""
        gif_data = bytearray()
        gif_data.extend(b'GIF89a')
        gif_data.extend(struct.pack('<H', 1))
        gif_data.extend(struct.pack('<H', 1))
        gif_data.append(0x00)
        gif_data.append(0x00)
        gif_data.append(0x00)
        gif_data.append(0x21)  # Extension Introducer
        gif_data.append(0xFE)  # Comment Label
        # EOF here - no sub-blocks at all

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(bytes(gif_data))
            temp_path = f.name

        try:
            retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(temp_path)

            assert not timed_out, (
                f"Vulnerable: Infinite loop when EOF immediately after comment label. "
                f"Application hung for {VULN_TIMEOUT}s."
            )

        finally:
            os.unlink(temp_path)

    def test_eof_after_subblock_size(self):
        """Test GIF that ends after providing the sub-block size but before data."""
        gif_data = bytearray()
        gif_data.extend(b'GIF89a')
        gif_data.extend(struct.pack('<H', 1))
        gif_data.extend(struct.pack('<H', 1))
        gif_data.append(0x00)
        gif_data.append(0x00)
        gif_data.append(0x00)
        gif_data.append(0x21)
        gif_data.append(0xFE)
        gif_data.append(10)  # Says 10 bytes follow
        # EOF here - no actual data

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(bytes(gif_data))
            temp_path = f.name

        try:
            retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(temp_path)

            assert not timed_out, (
                f"Vulnerable: Infinite loop on EOF after sub-block size byte."
            )

        finally:
            os.unlink(temp_path)


class TestDifferentApiPaths:
    """Test both Image.Identify and Image.Load with malformed GIFs."""

    def test_identify_malformed_gif(self):
        """Test Image.Identify with malformed GIF."""
        gif_data = create_malformed_gif_no_terminator(b"identify test")

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            # Run with identify mode using skip-metadata to trigger vulnerability
            try:
                result = subprocess.run(
                    ["dotnet", "/app/test/publish/ImageTestFromSource.dll", temp_path, "skip-metadata"],
                    capture_output=True,
                    text=True,
                    timeout=VULN_TIMEOUT,
                    cwd=APP_DIR
                )
                assert "exception" in result.stdout.lower() or result.returncode != 0
            except subprocess.TimeoutExpired:
                pytest.fail(
                    f"Vulnerable: Image.Identify hung on malformed GIF for {VULN_TIMEOUT}s"
                )
        finally:
            os.unlink(temp_path)

    def test_load_malformed_gif(self):
        """Test Image.Load with malformed GIF."""
        gif_data = create_malformed_gif_no_terminator(b"load test")

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            try:
                result = subprocess.run(
                    ["dotnet", "/app/test/publish/ImageTestFromSource.dll", temp_path, "skip-metadata"],
                    capture_output=True,
                    text=True,
                    timeout=VULN_TIMEOUT,
                    cwd=APP_DIR
                )
                assert "exception" in result.stdout.lower() or result.returncode != 0
            except subprocess.TimeoutExpired:
                pytest.fail(
                    f"Vulnerable: Image.Load hung on malformed GIF for {VULN_TIMEOUT}s"
                )
        finally:
            os.unlink(temp_path)


class TestSkipMetadataOption:
    """Test that vulnerability exists even with SkipMetadata option."""

    def test_skip_metadata_still_vulnerable(self):
        """
        Test that SkipMetadata=true doesn't prevent the vulnerability.
        The vulnerable code path is still executed with this option.
        """
        gif_data = create_malformed_gif_no_terminator(b"skip metadata test")

        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as f:
            f.write(gif_data)
            temp_path = f.name

        try:
            try:
                result = subprocess.run(
                    ["dotnet", "/app/test/publish/ImageTestFromSource.dll", temp_path, "skip-metadata"],
                    capture_output=True,
                    text=True,
                    timeout=VULN_TIMEOUT,
                    cwd=APP_DIR
                )
                # Should get an exception, not hang
                assert "exception" in result.stdout.lower() or result.returncode != 0
            except subprocess.TimeoutExpired:
                pytest.fail(
                    f"Vulnerable: Even with SkipMetadata=true, the application hung"
                )
        finally:
            os.unlink(temp_path)


class TestProvidedMalformedGif:
    """Test using the pre-generated malformed GIF from task-deps."""

    def test_provided_malformed_gif_file(self):
        """
        Test with the malformed_comment.gif file if it exists in the container.
        """
        malformed_path = f"{APP_DIR}/malformed_comment.gif"

        if not os.path.exists(malformed_path):
            # Try alternate location
            malformed_path = "/tests/malformed_comment.gif"
            if not os.path.exists(malformed_path):
                pytest.skip("malformed_comment.gif not found in container")

        retcode, stdout, stderr, timed_out, elapsed = run_dotnet_test(malformed_path)

        assert not timed_out, (
            f"Vulnerable: Application hung on malformed_comment.gif for {VULN_TIMEOUT}s. "
            f"The infinite loop vulnerability is present."
        )

        # Should indicate error handling worked
        assert elapsed < VULN_TIMEOUT - 1


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
