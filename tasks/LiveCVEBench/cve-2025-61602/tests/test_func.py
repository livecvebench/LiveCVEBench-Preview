"""
Functional Tests for Chat Message Reaction Handlers

These tests verify that the reaction system works correctly with valid inputs.
Tests should PASS in both vulnerable and fixed states.
"""

import subprocess
import json
import pytest
import os


# Helper to run TypeScript tests via ts-node
def run_ts_test(test_code: str) -> dict:
    """
    Execute TypeScript test code and return the result.
    Returns a dict with 'success', 'output', and 'error' keys.
    """
    # Create a temporary test file
    test_file = "/tmp/ts_test_runner.ts"

    # Full test wrapper with module setup
    full_code = '''
import buildSendReaction from '/app/src/actions/chatSendMessageReaction';
import buildDeleteReaction from '/app/src/actions/chatDeleteMessageReaction';

const sessionVars = {
    'x-hasura-meetingid': 'meeting-123',
    'x-hasura-userid': 'user-456',
    'x-hasura-moderatorinmeeting': 'meeting-123',
    'x-hasura-presenterinmeeting': ''
};

async function runTest() {
    try {
''' + test_code + '''
    } catch (e: any) {
        console.log(JSON.stringify({
            success: false,
            error: e.message,
            errorType: e.constructor.name,
            status: e.status || null
        }));
    }
}

runTest();
'''

    with open(test_file, 'w') as f:
        f.write(full_code)

    result = subprocess.run(
        ['npx', 'tsx', test_file],
        capture_output=True,
        text=True,
        cwd='/app',
        timeout=30
    )

    output = result.stdout.strip()
    if output:
        try:
            return json.loads(output.split('\n')[-1])
        except json.JSONDecodeError:
            pass

    return {
        'success': False,
        'output': result.stdout,
        'error': result.stderr
    }


class TestSendReactionFunctional:
    """Test chatSendMessageReaction with valid inputs"""

    def test_valid_emoji_reaction_accepted(self):
        """Valid emoji reaction should be accepted and message built successfully"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'üòÄ',
            reactionEmojiId: 'grinning'  // May or may not be used
        };

        const message = buildSendReaction(sessionVars, input);

        if (message.eventName === 'SendGroupChatMessageReactionReqMsg' &&
            message.body.chatId === 'MAIN-PUBLIC-GROUP-CHAT' &&
            message.body.messageId === 'msg-001' &&
            message.body.reactionEmoji === 'üòÄ') {
            console.log(JSON.stringify({
                success: true,
                eventName: message.eventName,
                bodyKeys: Object.keys(message.body)
            }));
        } else {
            console.log(JSON.stringify({
                success: false,
                error: 'Message not built correctly'
            }));
        }
        ''')

        assert result['success'] == True, f"Valid emoji should be accepted: {result}"
        assert result['eventName'] == 'SendGroupChatMessageReactionReqMsg'

    def test_various_valid_emojis(self):
        """Test various valid emoji characters"""
        emojis = ['üòÄ', 'üëç', '‚ù§Ô∏è', 'üéâ', 'üëè', 'üòÇ', 'üî•', 'üíØ']

        for emoji in emojis:
            result = run_ts_test(f'''
            const input = {{
                chatId: 'MAIN-PUBLIC-GROUP-CHAT',
                messageId: 'msg-001',
                reactionEmoji: '{emoji}',
                reactionEmojiId: 'test'
            }};

            try {{
                const message = buildSendReaction(sessionVars, input);
                console.log(JSON.stringify({{
                    success: true,
                    emoji: '{emoji}'
                }}));
            }} catch (e: any) {{
                console.log(JSON.stringify({{
                    success: false,
                    error: e.message
                }}));
            }}
            ''')

            assert result['success'] == True, f"Emoji {emoji} should be accepted: {result}"

    def test_invalid_emoji_rejected(self):
        """Invalid emoji (non-emoji string) should be rejected with ValidationError"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'not_an_emoji',
            reactionEmojiId: 'test'
        };

        const message = buildSendReaction(sessionVars, input);
        console.log(JSON.stringify({
            success: true,
            error: 'Should have thrown'
        }));
        ''')

        assert result['success'] == False, "Invalid emoji should be rejected"
        assert result.get('errorType') == 'ValidationError' or 'invalid Emoji' in result.get('error', '')

    def test_missing_chatid_rejected(self):
        """Missing chatId should be rejected"""
        result = run_ts_test('''
        const input = {
            messageId: 'msg-001',
            reactionEmoji: 'üòÄ',
            reactionEmojiId: 'grinning'
        };

        const message = buildSendReaction(sessionVars, input);
        console.log(JSON.stringify({
            success: true,
            error: 'Should have thrown'
        }));
        ''')

        assert result['success'] == False, "Missing chatId should be rejected"
        assert 'chatId' in result.get('error', '')

    def test_missing_messageid_rejected(self):
        """Missing messageId should be rejected"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            reactionEmoji: 'üòÄ',
            reactionEmojiId: 'grinning'
        };

        const message = buildSendReaction(sessionVars, input);
        console.log(JSON.stringify({
            success: true,
            error: 'Should have thrown'
        }));
        ''')

        assert result['success'] == False, "Missing messageId should be rejected"
        assert 'messageId' in result.get('error', '')

    def test_missing_reaction_emoji_rejected(self):
        """Missing reactionEmoji should be rejected"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmojiId: 'grinning'
        };

        const message = buildSendReaction(sessionVars, input);
        console.log(JSON.stringify({
            success: true,
            error: 'Should have thrown'
        }));
        ''')

        assert result['success'] == False, "Missing reactionEmoji should be rejected"
        assert 'reactionEmoji' in result.get('error', '')


class TestDeleteReactionFunctional:
    """Test chatDeleteMessageReaction with valid inputs"""

    def test_valid_delete_reaction(self):
        """Valid delete reaction should be accepted"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'üòÄ',
            reactionEmojiId: 'grinning'
        };

        const message = buildDeleteReaction(sessionVars, input);

        if (message.eventName === 'DeleteGroupChatMessageReactionReqMsg' &&
            message.body.chatId === 'MAIN-PUBLIC-GROUP-CHAT') {
            console.log(JSON.stringify({
                success: true,
                eventName: message.eventName
            }));
        } else {
            console.log(JSON.stringify({
                success: false,
                error: 'Message not built correctly'
            }));
        }
        ''')

        assert result['success'] == True, f"Valid delete reaction should be accepted: {result}"
        assert result['eventName'] == 'DeleteGroupChatMessageReactionReqMsg'

    def test_delete_missing_fields_rejected(self):
        """Missing required fields in delete should be rejected"""
        result = run_ts_test('''
        const input = {
            messageId: 'msg-001',
            reactionEmoji: 'üòÄ'
        };

        const message = buildDeleteReaction(sessionVars, input);
        console.log(JSON.stringify({
            success: true,
            error: 'Should have thrown'
        }));
        ''')

        assert result['success'] == False, "Missing chatId should be rejected"


class TestMessageStructure:
    """Test the structure of generated messages"""

    def test_send_message_has_correct_routing(self):
        """Send message should have correct routing structure"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'üòÄ',
            reactionEmojiId: 'grinning'
        };

        const message = buildSendReaction(sessionVars, input);

        if (message.routing.meetingId === 'meeting-123' &&
            message.routing.userId === 'user-456') {
            console.log(JSON.stringify({
                success: true,
                routing: message.routing
            }));
        } else {
            console.log(JSON.stringify({
                success: false,
                error: 'Routing incorrect'
            }));
        }
        ''')

        assert result['success'] == True, f"Routing should be correct: {result}"

    def test_send_message_has_correct_header(self):
        """Send message should have correct header structure"""
        result = run_ts_test('''
        const input = {
            chatId: 'MAIN-PUBLIC-GROUP-CHAT',
            messageId: 'msg-001',
            reactionEmoji: 'üòÄ',
            reactionEmojiId: 'grinning'
        };

        const message = buildSendReaction(sessionVars, input);

        if (message.header.name === 'SendGroupChatMessageReactionReqMsg' &&
            message.header.meetingId === 'meeting-123') {
            console.log(JSON.stringify({
                success: true,
                header: message.header
            }));
        } else {
            console.log(JSON.stringify({
                success: false,
                error: 'Header incorrect'
            }));
        }
        ''')

        assert result['success'] == True, f"Header should be correct: {result}"
