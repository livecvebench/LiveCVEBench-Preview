#!/bin/bash
# Solution script for fixing SQL injection vulnerability in delete_student.php
# This script replaces the vulnerable file with a fixed version using prepared statements

set -e

echo "Applying fix to /var/www/html/admin/delete_student.php..."

# Create the fixed version with prepared statements
cat > /var/www/html/admin/delete_student.php << 'EOF'
<?php
	require_once 'conn.php';

	if(ISSET($_POST['stud_id'])){
		// Validate input is numeric to prevent SQL injection
		$stud_id = intval($_POST['stud_id']);

		// Use prepared statement for SELECT query
		$stmt = mysqli_prepare($conn, "SELECT * FROM `student` WHERE `stud_id` = ?");
		mysqli_stmt_bind_param($stmt, "i", $stud_id);
		mysqli_stmt_execute($stmt);
		$result = mysqli_stmt_get_result($stmt);
		$fetch = mysqli_fetch_array($result);
		mysqli_stmt_close($stmt);

		if($fetch) {
			$stud_no = $fetch['stud_no'];

			if(file_exists("../files/".$stud_no)){
				removeDir("../files/".$stud_no);

				// Use prepared statement for DELETE from student
				$del_stmt = mysqli_prepare($conn, "DELETE FROM `student` WHERE `stud_id` = ?");
				mysqli_stmt_bind_param($del_stmt, "i", $stud_id);
				mysqli_stmt_execute($del_stmt);
				mysqli_stmt_close($del_stmt);

				// Use prepared statement for DELETE from storage
				$del_storage = mysqli_prepare($conn, "DELETE FROM `storage` WHERE `stud_no` = ?");
				mysqli_stmt_bind_param($del_storage, "i", $stud_no);
				mysqli_stmt_execute($del_storage);
				mysqli_stmt_close($del_storage);
			}
		}
	}

	function removeDir($dir) {
		$items = scandir($dir);
		foreach ($items as $item) {
			if ($item === '.' || $item === '..') {
				continue;
			}
			$path = $dir.'/'.$item;
			if (is_dir($path)) {
				xrmdir($path);
			} else {
				unlink($path);
			}
		}
		rmdir($dir);
	}
?>
EOF

echo "Fix applied successfully!"
echo "Changes made:"
echo "  - Added input validation with intval()"
echo "  - Converted all queries to use prepared statements"
echo "  - Used parameterized queries with mysqli_stmt_bind_param()"
