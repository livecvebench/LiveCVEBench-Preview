FROM debian:bookworm

WORKDIR /app

# System dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libpcap-dev \
    autoconf \
    automake \
    libtool \
    autogen \
    git \
    python3 \
    python3-pip \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Clone repository and checkout vulnerable version
RUN git clone https://github.com/appneta/tcpreplay.git . && \
    git checkout a1778a25a2f8dc4de879782567abab6b923e9694 && \
    rm -rf .git

# Build tcpreplay suite with AddressSanitizer to detect use-after-free
RUN ./autogen.sh && \
    CFLAGS="-fsanitize=address -g -O1" LDFLAGS="-fsanitize=address" ./configure && \
    make && \
    make install

# Copy task-deps files (poc.pcap for vulnerability testing)
COPY task-deps/ /task-deps/

# Keep container alive (CLI tool, not a service)
CMD ["tail", "-f", "/dev/null"]
