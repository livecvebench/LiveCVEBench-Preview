"""
Functionality tests for WP Shopify continue-shopping shortcode.
These tests verify the shortcode works correctly with normal inputs.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os

BASE_URL = os.environ.get("TARGET_URL", "http://localhost")
TEST_PAGE_PATH = "/shopify-test/"


def wait_for_wordpress(timeout=120):
    """Wait for WordPress to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(BASE_URL, timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


@pytest.fixture(scope="module", autouse=True)
def setup():
    """Wait for WordPress to be ready before running tests."""
    assert wait_for_wordpress(), "WordPress did not become ready in time"


class TestShortcodeBasicFunctionality:
    """Test that the shortcode renders and works correctly."""

    def test_page_loads_successfully(self):
        """Test that the test page with shortcode loads without errors."""
        response = requests.get(f"{BASE_URL}{TEST_PAGE_PATH}", timeout=10)
        assert response.status_code == 200, f"Page should load successfully, got {response.status_code}"

    def test_shortcode_wrapper_present(self):
        """Test that the shortcode outputs its wrapper div."""
        response = requests.get(f"{BASE_URL}{TEST_PAGE_PATH}", timeout=10)
        assert response.status_code == 200
        assert "wp-shopify-continue-shopping-wrapper" in response.text, \
            "Shortcode wrapper should be present in output"

    def test_iframe_element_present(self):
        """Test that the shortcode outputs an iframe element."""
        response = requests.get(f"{BASE_URL}{TEST_PAGE_PATH}", timeout=10)
        assert response.status_code == 200
        assert "wp-shopify-continue-shopping-iframe" in response.text, \
            "Iframe with correct class should be present"

    def test_iframe_has_src_attribute(self):
        """Test that the iframe has a src attribute."""
        response = requests.get(f"{BASE_URL}{TEST_PAGE_PATH}", timeout=10)
        assert response.status_code == 200
        # The iframe should have a src attribute pointing to a Shopify URL
        assert 'src="https://' in response.text or "src='https://" in response.text, \
            "Iframe should have a src attribute with HTTPS URL"


class TestProductParameterFunctionality:
    """Test that the product parameter works correctly with valid inputs."""

    def test_simple_product_name(self):
        """Test with a simple alphanumeric product name."""
        response = requests.get(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": "test-product"},
            timeout=10
        )
        assert response.status_code == 200
        # Product name should appear in the iframe src
        assert "test-product" in response.text, \
            "Simple product name should be included in output"

    def test_product_name_with_numbers(self):
        """Test with a product name containing numbers."""
        response = requests.get(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": "product-123"},
            timeout=10
        )
        assert response.status_code == 200
        assert "product-123" in response.text, \
            "Product name with numbers should be included"

    def test_product_name_with_dashes(self):
        """Test with a product name containing dashes (slug format)."""
        response = requests.get(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": "my-awesome-product"},
            timeout=10
        )
        assert response.status_code == 200
        assert "my-awesome-product" in response.text, \
            "Product name with dashes should work correctly"

    def test_product_name_with_underscores(self):
        """Test with a product name containing underscores."""
        response = requests.get(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": "product_item_v2"},
            timeout=10
        )
        assert response.status_code == 200
        # Underscores might be converted to dashes depending on sanitization
        assert "product" in response.text.lower(), \
            "Product name with underscores should be processed"

    def test_empty_product_parameter(self):
        """Test with empty product parameter."""
        response = requests.get(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": ""},
            timeout=10
        )
        assert response.status_code == 200
        assert "wp-shopify-continue-shopping-wrapper" in response.text, \
            "Page should still render with empty product parameter"

    def test_no_product_parameter(self):
        """Test without product parameter."""
        response = requests.get(f"{BASE_URL}{TEST_PAGE_PATH}", timeout=10)
        assert response.status_code == 200
        assert "wp-shopify-continue-shopping-wrapper" in response.text, \
            "Page should render correctly without product parameter"


class TestIframeURLConstruction:
    """Test that the iframe URL is constructed correctly."""

    def test_iframe_url_structure(self):
        """Test that iframe src follows expected URL structure."""
        response = requests.get(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": "sample-item"},
            timeout=10
        )
        assert response.status_code == 200
        # URL should contain /products/ path
        assert "/products/" in response.text, \
            "Iframe src should contain /products/ path"

    def test_iframe_uses_https(self):
        """Test that iframe src uses HTTPS."""
        response = requests.get(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": "secure-product"},
            timeout=10
        )
        assert response.status_code == 200
        # Should use HTTPS in the iframe src
        html_lower = response.text.lower()
        assert 'src="https://' in html_lower or "src='https://" in html_lower, \
            "Iframe should use HTTPS protocol"
