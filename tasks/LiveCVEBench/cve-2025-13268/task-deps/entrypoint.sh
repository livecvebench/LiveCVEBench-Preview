#!/bin/bash

# Entrypoint script for dataCompare application
# Supports restart capability for solution.sh testing

# Wait for MySQL to be ready
wait_for_mysql() {
    echo "Waiting for MySQL to be ready..."
    for i in {1..60}; do
        if mysqladmin ping -h mysql -u root -p123456 --silent 2>/dev/null; then
            echo "MySQL is ready!"
            return 0
        fi
        echo "Waiting for MySQL... ($i/60)"
        sleep 2
    done
    echo "MySQL connection timeout"
    return 1
}

# Run the application in a restart loop
run_app() {
    while true; do
        echo "Starting dataCompare application..."
        java -jar /app/target/dataCompare.jar \
            --spring.datasource.druid.master.url="jdbc:mysql://mysql:3306/dataCompare?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true" \
            --spring.datasource.druid.master.username=root \
            --spring.datasource.druid.master.password=123456

        exit_code=$?
        echo "Application exited with code $exit_code"

        # If killed by signal (137 = SIGKILL, 143 = SIGTERM), restart after delay
        if [ $exit_code -eq 137 ] || [ $exit_code -eq 143 ] || [ $exit_code -ne 0 ]; then
            echo "Application was terminated, restarting in 2 seconds..."
            sleep 2
        else
            echo "Application exited cleanly, not restarting"
            break
        fi
    done
}

# Main execution
wait_for_mysql
run_app
