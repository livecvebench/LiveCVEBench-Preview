services:
  client:
    build:
      dockerfile: Dockerfile
    image: ${T_BENCH_TASK_DOCKER_CLIENT_IMAGE_NAME}
    container_name: ${T_BENCH_TASK_DOCKER_CLIENT_CONTAINER_NAME}
    command: ["/entrypoint.sh"]
    restart: unless-stopped
    environment:
    - TEST_DIR=${T_BENCH_TEST_DIR}
    - DATABASE_URL=postgresql://postgres:postgres@db:5432/simstudio
    - BETTER_AUTH_URL=http://localhost:3000
    - NEXT_PUBLIC_APP_URL=http://localhost:3000
    - BETTER_AUTH_SECRET=cve-2025-7107-secret-key-for-testing-32chars
    - ENCRYPTION_KEY=cve20257107encryptionkey32chars!
    volumes:
    - ${T_BENCH_TASK_LOGS_PATH}:${T_BENCH_CONTAINER_LOGS_PATH}
    - ${T_BENCH_TASK_AGENT_LOGS_PATH}:${T_BENCH_CONTAINER_AGENT_LOGS_PATH}
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:17
    container_name: ${T_BENCH_TASK_DOCKER_CLIENT_CONTAINER_NAME}-db
    environment:
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_DB=simstudio
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
    - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
  uploads: