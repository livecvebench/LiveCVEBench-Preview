FROM python:3.11-slim

WORKDIR /app

# Install system dependencies (curl for testing, procps for process management, tmux and asciinema as required)
RUN apt-get update && apt-get install -y \
    curl \
    git \
    tmux \
    asciinema \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Download and extract copyparty v1.18.8
RUN curl -L https://github.com/9001/copyparty/archive/refs/tags/v1.18.8.tar.gz | tar -xz

# Install copyparty and test dependencies
WORKDIR /app/copyparty-1.18.8
RUN pip install --no-cache-dir -e . pytest requests

# Remove git directory if exists (prevent solution leakage)
RUN rm -rf .git

# Create data directory with sample content for recent uploads
RUN mkdir -p /data && \
    echo "sample content for testing" > /data/sample.txt && \
    echo "another test file" > /data/test.txt

WORKDIR /app/copyparty-1.18.8

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 3923

# Start copyparty with entrypoint script for restart capability
# CMD ["/entrypoint.sh"]
