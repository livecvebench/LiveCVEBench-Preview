FROM python:3.11-slim-bookworm

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required per guidelines)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    ffmpeg \
    sqlite3 \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Clone Frigate v0.16.1 (vulnerable version) and remove git history
RUN git clone --depth 1 --branch v0.16.1 https://github.com/blakeblackshear/frigate.git . && \
    rm -rf .git

# Create required directories
RUN mkdir -p /media/frigate/clips/export \
    /media/frigate/exports \
    /media/frigate/recordings \
    /config \
    /tmp/cache

# Install Python dependencies needed for the CVE reproduction
# Core API dependencies + pathvalidate for the fix
# Note: pytest will be installed via uv in run-tests.sh
RUN pip install --no-cache-dir \
    fastapi>=0.115.0 \
    uvicorn \
    peewee \
    psutil \
    ruamel.yaml \
    pydantic \
    pathvalidate \
    aiofiles \
    starlette

# Copy test secret file from task-deps (avoid inline creation)
COPY task-deps/test_secret.txt /etc/test_secret.txt

# Copy the test server and entrypoint
COPY task-deps/test_server.py /app/test_server.py
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Run the test server via entrypoint (allows restart after patching)
# ENTRYPOINT ["/entrypoint.sh"]
