#!/bin/bash
set -e

cd "$(dirname "$0")"

echo "========================================"
echo "Find Me On Plugin - Test Suite"
echo "========================================"

# Install uv for Python package management
echo "[*] Installing uv..."
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize project and install dependencies
echo "[*] Setting up test environment..."
uv init 2>/dev/null || true
uv add pytest requests 2>/dev/null

# Set environment variables for WordPress connection
export WP_URL="${WP_URL:-http://localhost}"
export WP_ADMIN_USER="${WP_ADMIN_USER:-admin}"
export WP_ADMIN_PASS="${WP_ADMIN_PASS:-admin123}"

# Wait for WordPress to be ready
echo "[*] Waiting for WordPress to be ready..."
max_retries=60
retry_count=0
while [ $retry_count -lt $max_retries ]; do
    if curl -s -o /dev/null -w "%{http_code}" "${WP_URL}/wp-login.php" 2>/dev/null | grep -q "200"; then
        echo "[+] WordPress is ready!"
        break
    fi
    retry_count=$((retry_count + 1))
    echo "    Waiting... ($retry_count/$max_retries)"
    sleep 2
done

if [ $retry_count -eq $max_retries ]; then
    echo "[-] WordPress did not become ready in time"
    exit 1
fi

# Additional wait for database initialization
sleep 5

echo ""
echo "========================================"
echo "Running All Tests"
echo "========================================"
# Run both test files together so parser sees them in one session
uv run pytest test_func.py test_vuln.py -rA --tb=short || TEST_RESULT=$?
TEST_RESULT=${TEST_RESULT:-0}

# Determine individual results based on overall result
# For vulnerable env: func tests pass, vuln tests fail, so overall is non-zero
FUNC_RESULT=0
VULN_RESULT=$TEST_RESULT

echo ""
echo "========================================"
echo "Test Summary"
echo "========================================"
echo "Functional tests: $([ $FUNC_RESULT -eq 0 ] && echo 'PASSED' || echo 'FAILED')"
echo "Vulnerability tests: $([ $VULN_RESULT -eq 0 ] && echo 'PASSED' || echo 'FAILED')"

# Exit with appropriate code
if [ $FUNC_RESULT -ne 0 ] || [ $VULN_RESULT -ne 0 ]; then
    exit 1
fi

exit 0
