FROM debian:bookworm-slim

WORKDIR /app

# System dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    make \
    python3 \
    git \
    wget \
    ca-certificates \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Get QuickJS source at vulnerable version and remove git history
RUN git clone https://github.com/bellard/quickjs.git /app/quickjs \
    && cd /app/quickjs \
    && git checkout eb2c89087def1829ed99630cb14b549d7a98408c \
    && rm -rf .git

# Build QuickJS (without ASAN for cleaner test output)
WORKDIR /app/quickjs
RUN make

# Verify build - qjs returns exit code 1 for --help, so we check the binary exists
RUN test -x ./qjs && ./qjs -e 'print("QuickJS ready")'

# Set back to /app for general use
WORKDIR /app

# Add qjs to PATH
ENV PATH="/app/quickjs:${PATH}"

# Keep container running
CMD ["tail", "-f", "/dev/null"]
