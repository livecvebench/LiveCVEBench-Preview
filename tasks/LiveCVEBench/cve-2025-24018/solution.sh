#!/bin/bash
set -e
cd /app

# File to patch
FILE="tools/attach/libs/attach.lib.php"

# Check if the file exists
if [ ! -f "$FILE" ]; then
    echo "Error: $FILE not found"
    exit 1
fi

# Check if already fixed (idempotent)
if grep -q 'htmlspecialchars(\$this->file)' "$FILE"; then
    echo "Fix already applied"
    exit 0
fi

# Create a backup
cp "$FILE" "${FILE}.bak"

# The vulnerable code is in the showFileNotExits() function (around line 652-655)
# Original:
#     public function showFileNotExits()
#     {
#         echo "<a href=\"" . $this->wiki->href("upload", $this->wiki->GetPageTag(), "file=$this->file") . "\" class=\"btn btn-primary\"><i class=\"fa fa-upload icon-upload icon-white\"></i> " . _t('UPLOAD_FILE') . ' ' . $this->file . "</a>";
#     }
#
# Fixed:
#     public function showFileNotExits()
#     {
#         $filename = htmlspecialchars($this->file);
#         echo '<a href="' . $this->wiki->href('upload', $this->wiki->GetPageTag(), "file=$filename") . '" class="btn btn-primary"><i class="fa fa-upload icon-upload icon-white"></i> ' . _t('UPLOAD_FILE') . ' ' . $filename . '</a>';
#     }

# Use PHP to apply the fix, which handles the escaping properly
php << 'PHPEOF'
<?php
$file = 'tools/attach/libs/attach.lib.php';
$content = file_get_contents($file);

// Pattern to find the vulnerable showFileNotExits function
$pattern = '/public function showFileNotExits\(\)\s*\{[^}]+echo\s*"<a href=\\""\s*\.\s*\$this->wiki->href\("upload",\s*\$this->wiki->GetPageTag\(\),\s*"file=\$this->file"\)\s*\.\s*\\""\s*class=\\"btn btn-primary\\"><i class=\\"fa fa-upload icon-upload icon-white\\"><\/i>\s*"\s*\.\s*_t\(\'UPLOAD_FILE\'\)\s*\.\s*\'\s*\'\s*\.\s*\$this->file\s*\.\s*"<\/a>";[^}]*\}/s';

$replacement = 'public function showFileNotExits()
        {
            $filename = htmlspecialchars($this->file);
            echo \'<a href="\' . $this->wiki->href(\'upload\', $this->wiki->GetPageTag(), "file=$filename") . \'" class="btn btn-primary"><i class="fa fa-upload icon-upload icon-white"></i> \' . _t(\'UPLOAD_FILE\') . \' \' . $filename . \'</a>\';
        }';

$newContent = preg_replace($pattern, $replacement, $content, 1, $count);

if ($count > 0) {
    file_put_contents($file, $newContent);
    echo "Fix applied successfully using regex replacement.\n";
    exit(0);
} else {
    // Fallback: try simpler line-based replacement
    $lines = explode("\n", $content);
    $output = [];
    $inFunction = false;
    $functionStart = -1;
    $braceCount = 0;
    $modified = false;

    for ($i = 0; $i < count($lines); $i++) {
        $line = $lines[$i];

        // Detect start of showFileNotExits function
        if (preg_match('/public\s+function\s+showFileNotExits\s*\(\s*\)/', $line)) {
            $inFunction = true;
            $functionStart = $i;
            $braceCount = 0;
        }

        if ($inFunction) {
            // Count braces
            $braceCount += substr_count($line, '{') - substr_count($line, '}');

            // If we've closed the function
            if ($braceCount <= 0 && strpos($line, '}') !== false) {
                // Replace the entire function
                // Remove from functionStart to current line
                $indent = str_repeat(' ', 8);
                $replacement = [
                    $indent . 'public function showFileNotExits()',
                    $indent . '{',
                    $indent . '    $filename = htmlspecialchars($this->file);',
                    $indent . '    echo \'<a href="\' . $this->wiki->href(\'upload\', $this->wiki->GetPageTag(), "file=$filename") . \'" class="btn btn-primary"><i class="fa fa-upload icon-upload icon-white"></i> \' . _t(\'UPLOAD_FILE\') . \' \' . $filename . \'</a>\';',
                    $indent . '}'
                ];

                // Remove old function lines
                for ($j = $functionStart; $j <= $i; $j++) {
                    array_pop($output);
                }

                // Add new function
                foreach ($replacement as $newLine) {
                    $output[] = $newLine;
                }

                $inFunction = false;
                $modified = true;
                continue;
            }
        }

        $output[] = $line;
    }

    if ($modified) {
        file_put_contents($file, implode("\n", $output));
        echo "Fix applied successfully using line-based replacement.\n";
        exit(0);
    }

    echo "Could not apply fix - function pattern not found.\n";
    exit(1);
}
?>
PHPEOF

echo "Fix applied"
