FROM python:3.12-slim

WORKDIR /app

# Proxy settings are provided via build args by the check script

# System dependencies (tmux, asciinema, curl, gcc, g++ are required)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    unixodbc-dev \
    && rm -rf /var/lib/apt/lists/*

# Get source code at vulnerable version and remove git history
RUN git clone --depth 1 --branch v0.1.4 https://github.com/defog-ai/introspect.git . && \
    rm -rf .git

# Copy requirements from task-deps if the repository file is missing
COPY task-deps/requirements.txt /tmp/requirements_backup.txt

# Use repository requirements if available, otherwise use backup
RUN if [ -f backend/requirements.txt ]; then \
        pip install --no-cache-dir -r backend/requirements.txt; \
    else \
        pip install --no-cache-dir -r /tmp/requirements_backup.txt; \
    fi

# Environment variables
ENV PYTHONPATH=/app/backend
ENV PYTHONUNBUFFERED=true

# Default working directory for testing
WORKDIR /app/backend