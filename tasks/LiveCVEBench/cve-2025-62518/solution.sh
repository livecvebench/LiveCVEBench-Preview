#!/bin/bash
set -e

# Source cargo environment
. "$HOME/.cargo/env" 2>/dev/null || true
export PATH="/usr/local/cargo/bin:$PATH"

cd /app

echo "=== Applying fix for PAX size precedence bug ==="

# Apply the patch to src/archive.rs
# The patch modifies poll_next_raw to accept and use PAX extension data
# for determining the correct file size instead of relying solely on ustar headers

patch -p1 < /task-deps/fix.patch

echo "=== Generating test archive ==="
# Create the test archive directory
mkdir -p tests/archives

# Generate the test tar file for the pax_precedence test
python3 /task-deps/generate_test_tar.py tests/archives/pax-header-precedence.tar

echo "=== Building the fixed library ==="
cargo build --release

echo "=== Verifying the fix ==="
# Run the pax_precedence test to verify the fix works
cargo test --release pax_precedence -- --nocapture

echo "=== Fix applied successfully ==="
