#!/bin/bash

pkill -f "Tautulli.py"
kill -9 $(lsof -t -i:8181)

python3 Tautulli.py --datadir /config &

set -e  

echo "[*] Setting up environment inside container..."

# apt-get update > /dev/null 2>&1
# apt-get install -y curl > /dev/null 2>&1

# 安装 uv
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh
source $HOME/.local/bin/env

# 检查工作目录
if [ "$PWD" = "/" ]; then
    echo "Error: No working directory set. Please set a WORKDIR in your Dockerfile before running this script."
    exit 1
fi

# 创建并激活 venv
uv venv .tbench-testing
source .tbench-testing/bin/activate


echo "[*] Installing Python dependencies..."

uv pip install pytest==8.4.1 requests


# 容器刚启动时，Tautulli 可能还在初始化。
# 如果直接运行 pytest，会因为 Connection Refused 而报错。
echo "[*] Waiting for Tautulli to be ready on port 8181..."
TIMEOUT=30
COUNTER=0

until curl -s --head http://localhost:8181 > /dev/null; do
    if [ $COUNTER -ge $TIMEOUT ]; then
        echo "[-] Timeout: Service failed to start within $TIMEOUT seconds."
        exit 1
    fi
    printf '.'
    sleep 1
    COUNTER=$((COUNTER+1))
done
echo " Service is Up!"

# ==========================================
# 4. 执行测试
# ==========================================
# 假设你会在宿主机先把测试文件 copy 到容器的 tests/ 目录下
TEST_FILE="/tests/test_output.py"

if [ ! -f "$TEST_FILE" ]; then
    echo "[-] Error: Cannot find $TEST_FILE"
    echo "    Please make sure you copied the 'tests' directory into the container!"
    ls -R
    exit 1
fi

echo "[*] Running Pytest..."
# -v: 详细模式
# -s: 显示打印输出 (非常重要，否则你看不到我们脚本里的 print 调试信息)
# -rA: 显示所有测试结果摘要
uv run pytest $TEST_FILE -v -s -rA