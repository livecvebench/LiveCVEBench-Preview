"""
Vulnerability tests for SiempreCMS file upload path traversal.
These tests verify vulnerability status:
- FAIL in vulnerable state (path traversal is possible)
- PASS in fixed state (path traversal is blocked)
"""

import pytest
import requests
import os
import tempfile
import time
import hashlib
import random
import string


BASE_URL = os.environ.get("APP_URL", "http://localhost/SiempreCMS")


def random_filename(ext="jpg"):
    """Generate a random filename for testing."""
    random_part = ''.join(random.choices(string.ascii_lowercase + string.digits, k=12))
    return f"test_{random_part}.{ext}"


class TestDirectoryTraversal:
    """Test directory traversal vulnerability in file upload."""

    def test_traversal_to_modules_directory(self, authenticated_session):
        """
        Test directory traversal to modules directory.
        Vulnerable: File is uploaded to modules/helloworld/
        Fixed: Request is rejected with "Bad request in folder path!"
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            # Create unique content to verify file location
            unique_content = f"TRAVERSAL_TEST_{filename}".encode()
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(unique_content)
            temp_path = f.name

        try:
            # Attempt directory traversal
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/../../modules/helloworld/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # After fix, should be rejected
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Directory traversal should be blocked! Got: {json_data}. " \
                   f"Traversal path '../media/../../modules/helloworld/' should be rejected."

        finally:
            os.unlink(temp_path)

    def test_traversal_to_includes_directory(self, authenticated_session):
        """
        Test directory traversal to includes directory.
        This attempts to upload to the includes directory which is even more sensitive.
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"INCLUDES_TEST_{filename}".encode())
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/../../includes/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # After fix, should be rejected
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Directory traversal to includes/ should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)

    def test_traversal_with_double_encoding(self, authenticated_session):
        """
        Test directory traversal with multiple ../
        Attempts: ../media/../media/../modules/
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"DOUBLE_TRAVERSAL_{filename}".encode())
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/../media/../modules/helloworld/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # After fix, should be rejected
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Double traversal should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)

    def test_traversal_to_cache_directory(self, authenticated_session):
        """
        Test directory traversal to cache directory.
        Attempts: ../media/../../cache/pages/
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"CACHE_TEST_{filename}".encode())
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/../../cache/pages/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # After fix, should be rejected
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Traversal to cache directory should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)

    def test_traversal_to_admin_includes(self, authenticated_session):
        """
        Test directory traversal to admin-includes directory.
        Attempts: ../media/../../admin-includes/
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"ADMIN_INCLUDES_{filename}".encode())
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/../../admin-includes/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # After fix, should be rejected
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Traversal to admin-includes should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)


class TestPathBypassAttempts:
    """Test various path bypass techniques."""

    def test_url_encoded_traversal(self, authenticated_session):
        """
        Test URL-encoded directory traversal.
        Attempts: ../media/%2e%2e/%2e%2e/modules/
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"URL_ENCODED_{filename}".encode())
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/%2e%2e/%2e%2e/modules/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # URL encoding should either be rejected or handled safely
            assert "Bad request" in status or "folder path" in status.lower() or \
                   "Unknown error" in status or "successfully" in status.lower(), \
                   f"URL-encoded traversal test failed: {json_data}"

        finally:
            os.unlink(temp_path)

    def test_triple_traversal(self, authenticated_session):
        """
        Test triple directory traversal.
        Attempts: ../media/../../../tmp/
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"TRIPLE_TRAVERSAL_{filename}".encode())
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/../../../tmp/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # Should be rejected - we can't access /tmp
            assert "Bad request" in status or "folder path" in status.lower() or \
                   "Unknown error" in status, \
                   f"Triple traversal to /tmp should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_very_long_traversal_path(self, authenticated_session):
        """
        Test very long directory traversal path.
        This tests buffer handling and path normalization.
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"LONG_PATH_{filename}".encode())
            temp_path = f.name

        try:
            # Create a very long traversal path
            long_traversal = "../media/" + ("../" * 20) + "modules/"
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": long_traversal},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # Should be rejected
            assert "Bad request" in status or "folder path" in status.lower() or \
                   "Unknown error" in status, \
                   f"Very long traversal path should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)

    def test_dot_slash_variations(self, authenticated_session):
        """
        Test ./  and ../  variations.
        Attempts: ../media/./../../modules/
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"DOT_SLASH_{filename}".encode())
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/./../../modules/helloworld/"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # After fix, should be rejected
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Dot-slash traversal should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)

    def test_traversal_with_trailing_slash_variations(self, authenticated_session):
        """
        Test traversal with various trailing slash patterns.
        """
        filename = random_filename("jpg")

        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            f.write(f"TRAILING_SLASH_{filename}".encode())
            temp_path = f.name

        try:
            # Test without trailing slash
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/../../modules/helloworld"},
                files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")

            # After fix, should be rejected
            assert "Bad request" in status or "folder path" in status.lower() or \
                   "Unknown error" in status, \
                   f"Traversal without trailing slash should be blocked! Got: {json_data}"

        finally:
            os.unlink(temp_path)


class TestMultipleFilesAttack:
    """Test attacks involving multiple file uploads."""

    def test_rapid_traversal_uploads(self, authenticated_session):
        """
        Test rapid consecutive traversal upload attempts.
        This tests rate limiting and consistent rejection.
        """
        results = []

        for i in range(3):
            filename = random_filename("jpg")

            with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
                f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
                f.write(f"RAPID_TEST_{i}_{filename}".encode())
                temp_path = f.name

            try:
                response = authenticated_session.post(
                    f"{BASE_URL}/docs/admin/file_upload.php",
                    data={"folder-path": "../media/../../modules/helloworld/"},
                    files={"image": (filename, open(temp_path, "rb"), "image/jpeg")}
                )
                results.append(response.json())
            finally:
                os.unlink(temp_path)

            time.sleep(0.1)  # Brief delay between requests

        # All requests should be consistently blocked after fix
        for i, result in enumerate(results):
            status = result.get("status", "")
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Request {i} should be blocked: {result}"
