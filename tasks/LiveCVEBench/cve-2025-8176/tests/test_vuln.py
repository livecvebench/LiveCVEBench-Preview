"""
Vulnerability tests for CVE-2025-8176 in tiffmedian tool.

This vulnerability is a use-after-free/heap-buffer-overflow in quant_fsdither().
The tests verify that the ASan-enabled build detects memory errors:
- FAIL in vulnerable state (ASan detects heap-use-after-free)
- PASS in fixed state (no ASan errors)

The vulnerability is triggered by images with sufficient color diversity to
create multiple color cells in the quantization algorithm. Images that are
too small or too uniform may not trigger the bug.
"""

import subprocess
import os
import pytest


# Path to the tiffmedian binary (ASan-enabled build for vulnerability detection)
TIFFMEDIAN = "/app/mybuild_asan/tools/tiffmedian"
TIFFINFO = "/app/mybuild_asan/tools/tiffinfo"


def create_test_tiff(filepath, width=64, height=64):
    """
    Create a test RGB TIFF file using PIL.
    Uses a gradient pattern that reliably triggers the CVE-2025-8176 vulnerability.
    """
    try:
        from PIL import Image
        img = Image.new('RGB', (width, height))
        for y in range(height):
            for x in range(width):
                # This gradient pattern triggers the vulnerability consistently
                r = (y * 4) % 256
                g = (x * 4) % 256
                b = ((x + y) * 2) % 256
                img.putpixel((x, y), (r, g, b))
        img.save(filepath, format='TIFF')
        return True
    except Exception as e:
        print(f"Failed to create test TIFF: {e}")
        return False


def run_tiffmedian_with_asan(input_file, output_file, extra_args=None):
    """
    Run tiffmedian (ASan build) with appropriate settings.
    Returns (returncode, stdout, stderr, has_asan_error).

    The ASan build at /app/mybuild_asan is already compiled with ASan,
    so we don't need LD_PRELOAD.
    """
    env = os.environ.copy()
    env["ASAN_OPTIONS"] = "detect_leaks=0:halt_on_error=0:print_summary=1"
    # Set library path for ASan build
    env["LD_LIBRARY_PATH"] = "/app/mybuild_asan/libtiff:" + env.get("LD_LIBRARY_PATH", "")

    cmd = [TIFFMEDIAN, "-f"]
    if extra_args:
        cmd.extend(extra_args)
    cmd.extend([input_file, output_file])

    result = subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        timeout=60,
        env=env
    )

    # Check for ASan error signatures
    has_asan_error = (
        "AddressSanitizer" in result.stderr or
        "heap-use-after-free" in result.stderr or
        "heap-buffer-overflow" in result.stderr or
        "SUMMARY: AddressSanitizer" in result.stderr
    )

    return result.returncode, result.stdout, result.stderr, has_asan_error


class TestVulnerability:
    """
    Tests that verify the heap-use-after-free vulnerability is present.

    CVE-2025-8176: In quant_fsdither(), an off-by-one error in the loop
    causes access to freed memory. With ASan, this is detected as
    heap-use-after-free at tiffmedian.c:952.

    These tests use image sizes that reliably trigger the vulnerability.
    A test FAILS when ASan detects memory errors (vulnerability exists).
    A test PASSES when no ASan errors occur (vulnerability is fixed).
    """

    @pytest.fixture(autouse=True)
    def setup(self, tmp_path):
        self.tmp_path = tmp_path
        self.input_file = str(tmp_path / "input.tif")
        self.output_file = str(tmp_path / "output.tif")

    def test_standard_image_64x64(self):
        """
        Test with 64x64 image - reliably triggers the vulnerability.
        """
        assert create_test_tiff(self.input_file, 64, 64), "Failed to create test image"

        returncode, stdout, stderr, has_asan_error = run_tiffmedian_with_asan(
            self.input_file, self.output_file
        )

        # In fixed version, there should be no ASan errors
        assert not has_asan_error, \
            f"ASan detected memory error (vulnerability exists):\n{stderr[:1000]}"

    def test_large_image_128x128(self):
        """
        Test with 128x128 image - more color diversity, reliably triggers bug.
        """
        assert create_test_tiff(self.input_file, 128, 128), "Failed to create test image"

        returncode, stdout, stderr, has_asan_error = run_tiffmedian_with_asan(
            self.input_file, self.output_file
        )

        assert not has_asan_error, \
            f"ASan detected memory error:\n{stderr[:1000]}"

    def test_large_image_256x256(self):
        """
        Test with 256x256 image - stress test with many colors.
        """
        assert create_test_tiff(self.input_file, 256, 256), "Failed to create test image"

        returncode, stdout, stderr, has_asan_error = run_tiffmedian_with_asan(
            self.input_file, self.output_file
        )

        assert not has_asan_error, \
            f"ASan detected memory error:\n{stderr[:1000]}"

    def test_repeated_processing(self):
        """
        Process the same image multiple times - should not trigger ASan errors.
        """
        assert create_test_tiff(self.input_file, 64, 64), "Failed to create test image"

        for i in range(3):
            output_file = str(self.tmp_path / f"output_{i}.tif")

            returncode, stdout, stderr, has_asan_error = run_tiffmedian_with_asan(
                self.input_file, output_file
            )

            assert not has_asan_error, \
                f"ASan error on iteration {i}:\n{stderr[:1000]}"

    def test_sequential_sizes(self):
        """
        Process images of different sizes that trigger the vulnerability.
        """
        sizes = [(64, 64), (100, 100), (128, 128)]

        for w, h in sizes:
            input_file = str(self.tmp_path / f"input_{w}x{h}.tif")
            output_file = str(self.tmp_path / f"output_{w}x{h}.tif")

            if not create_test_tiff(input_file, w, h):
                continue

            returncode, stdout, stderr, has_asan_error = run_tiffmedian_with_asan(
                input_file, output_file
            )

            assert not has_asan_error, \
                f"ASan error for size {w}x{h}:\n{stderr[:1000]}"

    def test_boundary_64x64(self):
        """
        Specific boundary test with 64x64 image.
        """
        assert create_test_tiff(self.input_file, 64, 64), "Failed to create test image"

        returncode, stdout, stderr, has_asan_error = run_tiffmedian_with_asan(
            self.input_file, self.output_file
        )

        assert not has_asan_error, \
            f"ASan detected memory error:\n{stderr[:1000]}"

    def test_asymmetric_100x50(self):
        """
        Test with asymmetric dimensions.
        """
        assert create_test_tiff(self.input_file, 100, 50), "Failed to create test image"

        returncode, stdout, stderr, has_asan_error = run_tiffmedian_with_asan(
            self.input_file, self.output_file
        )

        assert not has_asan_error, \
            f"ASan detected memory error:\n{stderr[:1000]}"
