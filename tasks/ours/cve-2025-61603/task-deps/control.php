<?php
// Simplified control.php for CVE testing - bypasses authentication checks
// This allows testing the SQL injection vulnerability without full auth setup

if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Set session ID for testing if not already set
if (!isset($_SESSION['id_pessoa'])) {
    $_SESSION['id_pessoa'] = 1;
}

require_once dirname(__FILE__, 2) . DIRECTORY_SEPARATOR . 'config.php';

function processaRequisicao($nomeClasse, $metodo, $modulo = null)
{
    if ($nomeClasse && $metodo) {
        // Controladoras permitidas
        $controladorasRecursos = [
            'ProdutoControle' => [22, 23, 24],
            'CategoriaControle' => [21, 2],
            'UnidadeControle' => [22],
        ];

        if (!array_key_exists($nomeClasse, $controladorasRecursos)) {
            throw new InvalidArgumentException('Controladora inválida', 400);
        }

        // PERMISSION CHECK BYPASSED FOR CVE TESTING
        // Original code would check MiddlewareDAO->verificarPermissao()

        $pathRequire = '';

        if ($modulo) {
            $pathRequire = $modulo . DIRECTORY_SEPARATOR;
        }

        $pathRequire .= $nomeClasse . ".php";

        if (!file_exists($pathRequire)) {
            throw new InvalidArgumentException('O arquivo para requisição da classe não existe.', 400);
        }

        require_once($pathRequire);

        if (!class_exists($nomeClasse)) {
            throw new InvalidArgumentException('A classe informada não existe no sistema.', 400);
        }

        // Cria uma instância da classe e chama o método
        $objeto = new $nomeClasse();

        if (!method_exists($objeto, $metodo)) {
            throw new InvalidArgumentException('O método informado não existe na classe.', 400);
        }

        $objeto->$metodo();
    } else {
        throw new InvalidArgumentException('O método e a controladora não podem ser vazios', 400);
    }
}

try {
    // SESSION CHECK BYPASSED FOR CVE TESTING
    // Original code: if (!isset($_SESSION['id_pessoa'])) { throw... }

    $nomeClasse = '';
    $metodo = '';
    $modulo = '';

    if (isset($_SERVER['CONTENT_TYPE']) && strpos($_SERVER['CONTENT_TYPE'], 'application/json') !== false) {
        // Recebe o JSON da requisição
        $json = file_get_contents('php://input');
        // Decodifica o JSON
        $data = json_decode($json, true);

        // Extrai as variáveis do array $data
        $nomeClasse = $data['nomeClasse'] ?? null;
        $metodo = $data['metodo'] ?? null;
        $modulo = $data['modulo'] ?? null;
    } else {
        // Recebe os dados do formulário normalmente
        $nomeClasse = $_REQUEST['nomeClasse'] ?? null;
        $metodo = $_REQUEST['metodo'] ?? null;
        $modulo = $_REQUEST['modulo'] ?? null;
    }

    processaRequisicao($nomeClasse, $metodo, $modulo);
} catch (Exception $e) {
    header('Content-Type: application/json');
    echo json_encode(['erro' => $e->getMessage()]);
}
