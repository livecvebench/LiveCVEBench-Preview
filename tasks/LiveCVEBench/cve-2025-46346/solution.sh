#!/bin/bash
# Fix HTML escaping issue in wiki formatter
# Applies htmlspecialchars() to user content in markdown processing

set -e

WAKKA_FILE="/app/formatters/wakka.php"

if [ ! -f "$WAKKA_FILE" ]; then
    echo "Error: $WAKKA_FILE not found"
    exit 1
fi

echo "Applying fix to $WAKKA_FILE..."

# Fix 1: Markdown titles (line ~406)
# Change: return $this->titleHeader($nb_hash_tags) . $matches[2] . $this->titleHeader($nb_hash_tags);
# To:     return $this->titleHeader($nb_hash_tags) . htmlspecialchars($matches[2]) . $this->titleHeader($nb_hash_tags);
sed -i 's/return $this->titleHeader($nb_hash_tags) \. $matches\[2\] \. $this->titleHeader($nb_hash_tags);/return $this->titleHeader($nb_hash_tags) . htmlspecialchars($matches[2]) . $this->titleHeader($nb_hash_tags);/g' "$WAKKA_FILE"

# Fix 2 & 3: Markdown italic (underscore and asterisk, lines ~410 and ~414)
# Both have the same pattern:
# Change: return $this->inLineTag('i') . $matches[1] . $this->inLineTag('i');
# To:     return $this->inLineTag('i') . htmlspecialchars($matches[1]) . $this->inLineTag('i');
sed -i "s/return \$this->inLineTag('i') \. \$matches\[1\] \. \$this->inLineTag('i');/return \$this->inLineTag('i') . htmlspecialchars(\$matches[1]) . \$this->inLineTag('i');/g" "$WAKKA_FILE"

# Verify the fix was applied
if grep -q "htmlspecialchars(\$matches\[2\])" "$WAKKA_FILE" && \
   grep -q "htmlspecialchars(\$matches\[1\])" "$WAKKA_FILE"; then
    echo "Fix applied successfully"
else
    echo "Warning: Fix may not have been applied correctly"
    echo "Checking current state of the file..."
    grep -n "titleHeader\|inLineTag" "$WAKKA_FILE" | head -20
fi

echo "Done"
