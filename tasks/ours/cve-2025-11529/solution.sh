#!/bin/bash
# Solution script for ChurchCRM API authentication middleware fix
# Fixes the path validation logic in AuthMiddleware.php

set -e

cd /var/www/html

MIDDLEWARE_FILE="ChurchCRM/Slim/Middleware/AuthMiddleware.php"

echo "Applying fix to AuthMiddleware.php..."

# Check if the file exists
if [ ! -f "$MIDDLEWARE_FILE" ]; then
    echo "ERROR: $MIDDLEWARE_FILE not found"
    exit 1
fi

# Check if already fixed (idempotency check)
if grep -q "str_starts_with(\$request->getUri()->getPath()" "$MIDDLEWARE_FILE"; then
    echo "Fix already applied - middleware is using correct path validation"
    exit 0
fi

# Apply the fix:
# Change: if (!str_contains($request->getUri(), 'api/public'))
# To:     if (!str_starts_with($request->getUri()->getPath(), '/api/public'))
#
# The fix addresses two issues:
# 1. Uses str_starts_with() instead of str_contains() to ensure the path STARTS with the public prefix
# 2. Uses ->getPath() to extract only the path component, ignoring query parameters

sed -i "s/str_contains(\$request->getUri(), 'api\/public')/str_starts_with(\$request->getUri()->getPath(), '\/api\/public')/" "$MIDDLEWARE_FILE"

# Verify the fix was applied
if grep -q "str_starts_with(\$request->getUri()->getPath()" "$MIDDLEWARE_FILE"; then
    echo "Fix applied successfully!"
    echo "The middleware now properly validates the request path."
else
    echo "ERROR: Fix could not be verified"
    exit 1
fi

echo "Done."