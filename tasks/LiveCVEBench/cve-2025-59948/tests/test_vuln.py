"""
Vulnerability tests for FreshRSS query API endpoint.
Tests verify the presence of Content-Security-Policy headers.

These tests:
- FAIL in vulnerable state (CSP headers missing)
- PASS in fixed state (CSP headers present)
"""

import pytest
import requests
import time
import os

# Configuration
BASE_URL = os.environ.get("BASE_URL", "http://localhost:80")
TEST_USER = os.environ.get("TEST_USER", "admin")
TEST_TOKEN = os.environ.get("TEST_TOKEN", "testtoken123")

MAX_WAIT_TIME = 60
RETRY_INTERVAL = 2


@pytest.fixture(scope="module", autouse=True)
def wait_for_application():
    """Wait for the FreshRSS application to be ready."""
    start_time = time.time()
    while time.time() - start_time < MAX_WAIT_TIME:
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302, 401]:
                time.sleep(2)
                return
        except requests.exceptions.RequestException:
            pass
        time.sleep(RETRY_INTERVAL)
    pytest.fail(f"Application did not become ready within {MAX_WAIT_TIME} seconds")


class TestHTMLFormatCSPHeader:
    """Test Content-Security-Policy header on HTML format responses."""

    def test_html_format_has_csp_header(self):
        """
        Verify HTML format response includes Content-Security-Policy header.

        The HTML format was missing CSP headers, allowing inline scripts to execute.
        After the fix, CSP headers should be present to block inline script execution.
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert csp_header != "", \
            "Content-Security-Policy header is missing from HTML format response"

    def test_html_format_csp_blocks_inline_scripts(self):
        """
        Verify CSP header does not allow unsafe-inline scripts.

        The CSP must not include 'unsafe-inline' in script-src or default-src
        to prevent execution of inline event handlers like onloadstart.
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert csp_header != "", \
            "Content-Security-Policy header is missing"

        # CSP should not allow unsafe-inline
        assert "unsafe-inline" not in csp_header, \
            f"CSP should not allow 'unsafe-inline'. Got: {csp_header}"

    def test_html_format_csp_has_default_src(self):
        """
        Verify CSP header includes default-src directive.

        A proper CSP should define default-src to restrict resource loading.
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert "default-src" in csp_header, \
            f"CSP should include 'default-src' directive. Got: {csp_header}"

    def test_html_format_csp_prevents_framing(self):
        """
        Verify CSP header includes frame-ancestors directive.

        The frame-ancestors directive should prevent clickjacking attacks.
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert "frame-ancestors" in csp_header, \
            f"CSP should include 'frame-ancestors' directive. Got: {csp_header}"


class TestOtherFormatsCSPHeaders:
    """Test that other format types also have CSP headers."""

    def test_rss_format_has_csp_header(self):
        """Verify RSS format response includes CSP header."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "rss"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert csp_header != "", \
            "Content-Security-Policy header is missing from RSS format response"

    def test_atom_format_has_csp_header(self):
        """Verify Atom format response includes CSP header."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "atom"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert csp_header != "", \
            "Content-Security-Policy header is missing from Atom format response"

    def test_json_format_has_csp_header(self):
        """Verify JSON format response includes CSP header."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "json"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert csp_header != "", \
            "Content-Security-Policy header is missing from JSON format response"

    def test_opml_format_has_csp_header(self):
        """Verify OPML format response includes CSP header."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "opml"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert csp_header != "", \
            "Content-Security-Policy header is missing from OPML format response"


class TestCSPPolicyStrength:
    """Test that CSP policies are appropriately restrictive."""

    def test_html_csp_self_restriction(self):
        """
        Verify HTML format CSP restricts default-src appropriately.

        For HTML format, default-src should be 'self' to allow page assets
        while blocking external scripts.
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        # Should have default-src 'self' for HTML
        assert "'self'" in csp_header or "default-src 'none'" in csp_header, \
            f"CSP should restrict default-src to 'self' or 'none'. Got: {csp_header}"

    def test_rss_csp_strict_policy(self):
        """
        Verify RSS/Atom format has strict CSP policy.

        Data formats should have very restrictive CSP (default-src 'none').
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "rss"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        # RSS should have very restrictive CSP
        assert "default-src 'none'" in csp_header or "sandbox" in csp_header, \
            f"RSS format should have restrictive CSP. Got: {csp_header}"

    def test_json_csp_strict_policy(self):
        """
        Verify JSON format has strict CSP policy.

        Data formats should have very restrictive CSP.
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "json"},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        # JSON should have very restrictive CSP
        assert "default-src 'none'" in csp_header or "sandbox" in csp_header, \
            f"JSON format should have restrictive CSP. Got: {csp_header}"


class TestXContentTypeOptions:
    """Test X-Content-Type-Options header presence."""

    def test_x_content_type_options_header(self):
        """
        Verify X-Content-Type-Options header is set.

        This header prevents MIME-type sniffing attacks.
        """
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
            timeout=10
        )

        x_content_type = response.headers.get("X-Content-Type-Options", "")

        assert x_content_type == "nosniff", \
            f"X-Content-Type-Options should be 'nosniff'. Got: '{x_content_type}'"


class TestMultipleRequestsConsistency:
    """Test that security headers are consistently applied across requests."""

    def test_consistent_csp_across_multiple_requests(self):
        """
        Verify CSP header is consistently present across multiple requests.

        Security headers should not be intermittent.
        """
        for i in range(3):
            response = requests.get(
                f"{BASE_URL}/api/query.php",
                params={"user": TEST_USER, "t": TEST_TOKEN, "f": "html"},
                timeout=10
            )

            csp_header = response.headers.get("Content-Security-Policy", "")

            assert csp_header != "", \
                f"CSP header missing on request {i + 1}"
            assert "default-src" in csp_header, \
                f"CSP header malformed on request {i + 1}"

    @pytest.mark.parametrize("format_type", ["html", "rss", "atom", "json"])
    def test_all_formats_have_csp(self, format_type):
        """Verify all format types have CSP headers."""
        response = requests.get(
            f"{BASE_URL}/api/query.php",
            params={"user": TEST_USER, "t": TEST_TOKEN, "f": format_type},
            timeout=10
        )

        csp_header = response.headers.get("Content-Security-Policy", "")

        assert csp_header != "", \
            f"CSP header missing for format '{format_type}'"
