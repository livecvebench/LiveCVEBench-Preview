#!/usr/bin/env python3
"""
Functionality Tests for ClipBucket V5 Playlist Management

These tests verify that the core playlist functionality works correctly
both before and after the security fix is applied.
"""

import pytest
import requests
import time
import os

BASE_URL = os.environ.get("BASE_URL", "http://localhost")
DEFAULT_USER = os.environ.get("CB_USER", "admin")
DEFAULT_PASS = os.environ.get("CB_PASS", "admin")


class TestClipBucketBasicFunctionality:
    """Test basic ClipBucket functionality to ensure the app is working."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test session."""
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Test Suite)'
        })
        # Allow time for server to be ready
        self._wait_for_server()

    def _wait_for_server(self, timeout=60):
        """Wait for the server to be ready."""
        start_time = time.time()
        while time.time() - start_time < timeout:
            try:
                response = self.session.get(f"{BASE_URL}/", timeout=5)
                if response.status_code in [200, 302]:
                    return True
            except requests.RequestException:
                pass
            time.sleep(2)
        pytest.fail(f"Server at {BASE_URL} not ready after {timeout} seconds")

    def _login(self, username=None, password=None):
        """Authenticate to ClipBucket."""
        username = username or DEFAULT_USER
        password = password or DEFAULT_PASS

        login_url = f"{BASE_URL}/signup.php?mode=login"
        login_data = {
            'username': username,
            'password': password,
            'login': 'login'
        }

        response = self.session.post(login_url, data=login_data, allow_redirects=True)
        return response

    def test_homepage_accessible(self):
        """Test that the ClipBucket homepage is accessible."""
        response = self.session.get(f"{BASE_URL}/")
        assert response.status_code in [200, 302], \
            f"Homepage returned unexpected status: {response.status_code}"

    def test_login_page_accessible(self):
        """Test that the login page is accessible."""
        response = self.session.get(f"{BASE_URL}/signup.php?mode=login")
        assert response.status_code == 200, \
            f"Login page returned unexpected status: {response.status_code}"
        # Check for login form elements
        assert 'username' in response.text.lower() or 'login' in response.text.lower(), \
            "Login page does not contain expected elements"

    def test_authentication_works(self):
        """Test that user authentication works."""
        response = self._login()
        # Check for successful login indicators
        # After login, user should be redirected or see dashboard content
        assert response.status_code in [200, 302], \
            f"Login returned unexpected status: {response.status_code}"

        # Try accessing a protected page
        protected_response = self.session.get(f"{BASE_URL}/manage_playlists.php")
        # Should not be redirected to login
        assert 'login' not in protected_response.url.lower() or \
               protected_response.status_code == 200, \
            "Could not access protected page after login"


class TestPlaylistFunctionality:
    """Test playlist management functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test session and login."""
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Test Suite)'
        })
        self._wait_for_server()
        self._login()

    def _wait_for_server(self, timeout=60):
        """Wait for the server to be ready."""
        start_time = time.time()
        while time.time() - start_time < timeout:
            try:
                response = self.session.get(f"{BASE_URL}/", timeout=5)
                if response.status_code in [200, 302]:
                    return True
            except requests.RequestException:
                pass
            time.sleep(2)
        pytest.fail(f"Server at {BASE_URL} not ready after {timeout} seconds")

    def _login(self, username=None, password=None):
        """Authenticate to ClipBucket."""
        username = username or DEFAULT_USER
        password = password or DEFAULT_PASS

        login_url = f"{BASE_URL}/signup.php?mode=login"
        login_data = {
            'username': username,
            'password': password,
            'login': 'login'
        }

        self.session.post(login_url, data=login_data, allow_redirects=True)

    def test_manage_playlists_page_accessible(self):
        """Test that the manage playlists page is accessible after login."""
        response = self.session.get(f"{BASE_URL}/manage_playlists.php")
        assert response.status_code == 200, \
            f"Manage playlists page returned unexpected status: {response.status_code}"

    def test_edit_playlist_page_accessible(self):
        """Test that the edit playlist page is accessible."""
        # Access edit playlist with arbitrary pid (may not exist, but page should load)
        response = self.session.get(f"{BASE_URL}/manage_playlists.php?mode=edit_playlist&pid=1")
        assert response.status_code == 200, \
            f"Edit playlist page returned unexpected status: {response.status_code}"
        # Should show playlist form or playlist not found message
        assert 'playlist' in response.text.lower(), \
            "Edit playlist page does not contain expected content"

    def test_create_playlist_page_accessible(self):
        """Test that the create playlist page is accessible."""
        response = self.session.get(f"{BASE_URL}/manage_playlists.php?mode=add_playlist")
        assert response.status_code == 200, \
            f"Create playlist page returned unexpected status: {response.status_code}"

    def test_playlist_list_displays(self):
        """Test that the playlist list displays correctly."""
        response = self.session.get(f"{BASE_URL}/manage_playlists.php")
        assert response.status_code == 200
        # Page should load without server error
        assert '500' not in str(response.status_code), \
            "Server returned 500 error on playlist listing"


class TestAdminAreaFunctionality:
    """Test admin area functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test session and login as admin."""
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Test Suite)'
        })
        self._wait_for_server()
        self._login()

    def _wait_for_server(self, timeout=60):
        """Wait for the server to be ready."""
        start_time = time.time()
        while time.time() - start_time < timeout:
            try:
                response = self.session.get(f"{BASE_URL}/", timeout=5)
                if response.status_code in [200, 302]:
                    return True
            except requests.RequestException:
                pass
            time.sleep(2)
        pytest.fail(f"Server at {BASE_URL} not ready after {timeout} seconds")

    def _login(self, username=None, password=None):
        """Authenticate to ClipBucket as admin."""
        username = username or DEFAULT_USER
        password = password or DEFAULT_PASS

        login_url = f"{BASE_URL}/signup.php?mode=login"
        login_data = {
            'username': username,
            'password': password,
            'login': 'login'
        }

        self.session.post(login_url, data=login_data, allow_redirects=True)

    def test_admin_area_accessible(self):
        """Test that admin area is accessible."""
        response = self.session.get(f"{BASE_URL}/admin_area/")
        # Should either show admin panel or redirect to admin login
        assert response.status_code in [200, 302], \
            f"Admin area returned unexpected status: {response.status_code}"

    def test_admin_playlist_management_accessible(self):
        """Test that admin playlist management is accessible."""
        response = self.session.get(f"{BASE_URL}/admin_area/manage_playlist.php")
        # Should load without server error
        assert response.status_code in [200, 302], \
            f"Admin playlist management returned unexpected status: {response.status_code}"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
