var ajaxObj,constructLastContributed=function(){submitQuery([{constraint1:"quickLink",constraint2:"lastSubmission"}]),jQuery(".search-parameters-container").text("Last contributed traceroutes")},constructViaNSACity=function(){submitQuery([{constraint1:"quickLink",constraint2:"viaNSACity"}]),jQuery(".search-parameters-container").text("Goes via an NSA city")},constructBoomerangs=function(){var a=[{constraint1:"quickLink",constraint2:"boomerang"}];myCountry.length>0?(a[0].constraint4=myCountry,jQuery(".search-parameters-container").text("Does Originate in "+myCountry+" AND Does Go via Another Country AND Does Terminate in "+myCountry)):(a[0].constraint4="CA",jQuery().toastmessage("showWarningToast","We were unable to determine your location - submitting a Canadian boomerang query instead"),jQuery(".search-parameters-container").text("Does Originate in CA AND Does Go via Another Country AND Does Terminate in CA")),submitQuery(a)},constructFromMyIsp=function(){if(myAsn){var a=[{constraint1:"does",constraint2:"originate",constraint3:"asnum",constraint4:myAsn,constraint5:"and"}];populateBSFieldsForSearch(a),submitQuery(a)}else jQuery().toastmessage("showErrorToast","We were unable to determine your ISP - please try a different query")},constructFromMyCity=function(){if(myCity){var a=[{constraint1:"does",constraint2:"originate",constraint3:"city",constraint4:myCity,constraint5:"and"}];populateBSFieldsForSearch(a),submitQuery(a)}else jQuery().toastmessage("showErrorToast","We were unable to determine your city - please try a different query")},constructFromMyCountry=function(){if(myCountry){var a=[{constraint1:"does",constraint2:"originate",constraint3:"country",constraint4:myCountry,constraint5:"and"}];populateBSFieldsForSearch(a),submitQuery(a)}else jQuery().toastmessage("showErrorToast","We were unable to determine your country - please try a different query")},submitUrlTrId=function(a){jQuery("#userloc").hide(),submitQuery([{constraint1:"quickLink",constraint2:"singleRoute",constraint3:a}])},constructBS=function(){var a=[],b=1;jQuery("#bs-via-popup .bs-input").each(function(c,d){if(""!=jQuery(d).val()){var e=jQuery(d).val();if("NSA"===jQuery(d).data("constraint"))"yes"===e||"no"===e?_.each(nsaCities,function(c,d){var f={constraint1:"",constraint2:"contain",constraint3:"city",constraint4:c,constraint5:"or"};"yes"===e?f.constraint1="does":"no"===e?f.constraint1="doesNot":console.error("We shouldnt be able to get here"),d+1===nsaCities.length&&(f.constraint5="and"),a.push(f),b++}):jQuery().toastmessage("showErrorToast",'When filling in the NSA field, please include either "yes" or "no"');else{var f={constraint1:"does",constraint2:"goVia",constraint3:jQuery(d).data("constraint"),constraint4:jQuery(d).val(),constraint5:"and"};a.push(f),b++}}}),jQuery("#bs-originate-popup .bs-input").each(function(c,d){if(""!=jQuery(d).val()){var e="";e="submitter"==jQuery(d).data("constraint")?"contain":"originate";var f={constraint1:"does",constraint2:e,constraint3:jQuery(d).data("constraint"),constraint4:jQuery(d).val(),constraint5:"and"};a.push(f),b++}}),jQuery("#bs-terminate-popup .bs-input").each(function(c,d){if(""!=jQuery(d).val()){var e="";e="destHostname"==jQuery(d).data("constraint")?"contain":"terminate";var f={constraint1:"does",constraint2:e,constraint3:jQuery(d).data("constraint"),constraint4:jQuery(d).val(),constraint5:"and"};a.push(f),b++}}),_.isEmpty(a)?jQuery().toastmessage("showErrorToast","Please fill in at least one search term field to query the database."):submitQuery(a)},constructAS=function(){var a=[],b=0,c=0;jQuery(".constraint").removeClass("blank-field-error"),jQuery("#as-search-container .input-holder").each(function(d,e){b++;var f=0;console.log(d,jQuery(e));var g={};_.each(jQuery(e).children(".constraint-container"),function(a){f++;var b=jQuery(a).find(".constraint-value");jQuery(b).val()?g["constraint"+f]=b.val():(c++,jQuery(a).children().addClass("blank-field-error"))}),a.push(g)}),0===c?submitQuery(a):jQuery().toastmessage("showErrorToast","One or more fields were not filled. Submission canceled.")},outputSubmissionParametersToMap=function(a){if(jQuery(".searchsettings").removeClass("hidden"),jQuery(".refine-search-container").addClass("hidden"),"quickLink"!=a[0].constraint1){jQuery(".advanced.input-holder").remove(),jQuery(".search-parameters-container").html(""),jQuery(".refine-search-container").removeClass("hidden");var b="";_.each(a,function(c,d){0==d?createASRow("first",c):createASRow("",c),b+=c.constraint1[0].toUpperCase()+c.constraint1.slice(1)+" ",b+=c.constraint2+" ",b+=c.constraint3+" ",b+=c.constraint4+" ",b+=c.constraint5,d+1!==a.length&&(b+=" || ")});var c=jQuery("<span/>").text(b);jQuery(".search-parameters-container").append(c)}},populateBSFieldsForSearch=function(a){"asnum"==a[0].constraint3?jQuery("#bs-originate-popup input[data-constraint='ISP']").val(a[0].constraint4):jQuery("#bs-originate-popup input[data-constraint='"+a[0].constraint3+"']").val(a[0].constraint4)},createASRow=function(a,b){jQuery("#as-search-container").unbind("keypress"),jQuery("#as-search-container").on("keypress","input",function(a){13==a.keyCode&&jQuery("#as-submit-btn").click()});var c=jQuery("<div/>");c.addClass("advanced input-holder"),_.each(constraints,function(a){var b=jQuery("<div/>");if(b.addClass("advanced-input constraint-container constraint-"+a.name),jQuery(b).data("constraint",a.name),jQuery(c).append(b),"input"===a.name){jQuery(b).append('<div class="ui fluid input"><input class="constraint-value" type="text" placeholder="Submitter name"></div>')}else{var d=jQuery("<select/>");d.addClass("constraint-value ui fluid dropdown"),_.each(a.options,function(a){d.append(new Option(a.display,a.value))}),d.prop("selectedIndex",0),"kind"===a.name&&d.change(function(a){var b=jQuery(this).parent().next().find("input"),c=jQuery(a.target).val();_.each(constraints[2].options,function(a){a.value===c&&jQuery(b).attr("placeholder",a.display)}),bindAutocomplete(b,c)}),jQuery(b).append(d)}});var d=jQuery("<div/>");d.addClass("advanced-input constraint-buttons");var e=jQuery("<button/>");e.addClass("circular ui icon button");var f=jQuery(c).find(".constraint-input").find("input");"first"===a?(jQuery(e).append('<i class="create-search-row-btn icon settings"><img src="_assets/img/icn-add.svg" alt="add"></i>'),jQuery(e).click(function(){createASRow()})):(jQuery(e).append('<i class="destroy-search-row-btn icon settings"><img src="_assets/img/icn-remove.svg" alt="remove"></i>'),jQuery(e).click(function(){jQuery(c).remove()}),bindAutocomplete(f,"submitter")),b&&(jQuery(c).find(".constraint-boolean select").val(b.constraint1),jQuery(c).find(".constraint-position select").val(b.constraint2),jQuery(c).find(".constraint-kind select").val(b.constraint3),jQuery(c).find(".constraint-input input").val(b.constraint4),bindAutocomplete(f,b.constraint3),jQuery(c).find(".constraint-join select").val(b.constraint5)),jQuery(d).append(e),jQuery(c).append(d),jQuery("#as-search-container").append(c)},submitQuery=function(a){console.log("Submitting...",a),showLoader(),jQuery("#filter-results-content").fadeOut("fast"),jQuery("#filter-results-empty").show(),outputSubmissionParametersToMap(a);var b={maxTrCount:jQuery("#search-result-count-limit").val()};a.push(b),ajaxObj=jQuery.ajax(config.url_base+"/application/controller/map.php",{type:"post",data:JSON.stringify(a),success:function(a){console.log("Query response received: "+a);try{data=JSON.parse(a),0!=data.trsReturned&&void 0!=data.result?(ixmapsDataJson=JSON.parse(data.result),buildTrSummaryTable(),jQuery("#tot-results").html(data.trsReturned),jQuery("#tot-results-found").html(data.trsFound),jQuery("#my-ip").html(myIp),console.log("Total TRs: "+data.trsReturned),console.log("Total Hops: "+data.totHops),console.log("Execution Time: "+data.execTime+" Sec."),loadMapData(),hideLoader(),jQuery("#filter-results-empty").hide(),jQuery(".sidebar.vertical.legend").removeClass("overlay animating visible"),jQuery("#filter-results-content").fadeIn("fast")):(errText="No routes were found with the criteria you provided. Adjust the query options to be more inclusive, then click Search",showResponseErrors(errText))}catch(a){errText="Malformed JSON returned - something went wrong on the backend!",showResponseErrors(errText)}},error:function(a){errText="Search timed out. Try a simpler query",showResponseErrors(errText)},timeout:12e4})},showResponseErrors=function(a){hideLoader(),jQuery.toast({text:'<span style="font-size: 20px;">'+a+"</span>",hideAfter:1e4,allowToastClose:!0,position:"mid-center",icon:"error"})},userLocQueryOptions={},dataSearch={},usrLocQuery={},submitUserLocObject=function(){submitQuery(Object.values(usrLocQuery))},buildInitialMapEntryQuery=function(a){console.log("buildInitialMapEntryQuery",a),resetUserLocQueryOptions();var b;if("first"==a)myAsn||myCity?(myAsn&&(b={constraint1:"does",constraint2:"originate",constraint3:"asnum",constraint4:myAsn,constraint5:"and"},usrLocQuery.myAsn=b),myCity&&(b={constraint1:"does",constraint2:"originate",constraint3:"city",constraint4:myCity,constraint5:"and"},usrLocQuery.myCity=b),loadingUsrLocQuery(),submitInitialMapEntryQuery(usrLocQuery)):jQuery(".opening.modal").modal("hide");else{usrLocQuery={};var c=jQuery(".userloc-submitter").val(),d=jQuery(".userloc-city").val(),e=jQuery(".userloc-country").val();if(jQuery(".userloc-asn-chkbox").is(":checked")){var b={constraint1:"does",constraint2:"originate",constraint3:"asnum",constraint4:userLocQueryOptions.myAsn.value,constraint5:"and"};usrLocQuery.myAsn=b}if(""!=e&&jQuery(".userloc-country-chkbox").is(":checked")){var b={constraint1:"does",constraint2:"originate",constraint3:"country",constraint4:e,constraint5:"and"};usrLocQuery.myCountry=b}if(""!=d&&jQuery(".userloc-city-chkbox").is(":checked")){var b={constraint1:"does",constraint2:"originate",constraint3:"city",constraint4:d,constraint5:"and"};usrLocQuery.myCity=b}if(""!=c&&jQuery(".userloc-submitter-chkbox").is(":checked")){var b={constraint1:"does",constraint2:"contain",constraint3:"submitter",constraint4:c,constraint5:"and"};usrLocQuery.submitter=b}loadingUsrLocQuery(),submitInitialMapEntryQuery(usrLocQuery)}},submitInitialMapEntryQuery=function(a){ajaxObj=jQuery.ajax(config.url_base+"/application/controller/map_entry_search.php",{type:"post",data:a,success:function(a){console.log("submitInitialMapEntryQuery OK"),results=jQuery.parseJSON(a),console.log(results),renderInitialMapEntryResults(results)},error:function(a){console.log("Error! submitInitialMapEntryQuery")}})},resetUserLocQueryOptions=function(a){userLocQueryOptions={submitter:{value:"",total:0,checked:!1},myAsn:{value:"",total:0,checked:!1},myCity:{value:"",total:0,checked:!1},myCountry:{value:"",total:0,checked:!1}},userLocQueryOptions.myAsn.value=myAsn;var b=jQuery(".userloc-city").val(),c=jQuery(".userloc-country").val();userLocQueryOptions.myCountry.value=c,myCountry&&(""!=c&&c!=myCountry?(jQuery(".userloc-country-flag").removeClass("flag"),jQuery(".userloc-country-flag").removeClass(myCountry.toLowerCase()),jQuery(".userloc-country-flag").addClass(c.toLowerCase()),jQuery(".userloc-country-flag").addClass("flag")):(jQuery(".userloc-country").val(myCountry),jQuery(".userloc-country-flag").addClass(myCountry.toLowerCase()),jQuery(".userloc-country-flag").addClass("flag"))),jQuery(".userloc-ip").text(myIp),jQuery(".userloc-isp").text(myIsp),jQuery(".userloc-asn").text(myAsn),""!=b&&b!=myCity?(jQuery(".userloc-city").val(b),userLocQueryOptions.myCity.value=b):(jQuery(".userloc-city").val(myCity),userLocQueryOptions.myCity.value=myCity)},renderInitialMapEntryResults=function(a){void 0!==usrLocQuery.submitter&&(userLocQueryOptions.submitter.total=a.results.submitter.total,0==a.results.submitter.total&&delete usrLocQuery.submitter),void 0!==usrLocQuery.myAsn&&(userLocQueryOptions.myAsn.total=a.results.myAsn.total,0==a.results.myAsn.total&&delete usrLocQuery.myAsn),void 0!==usrLocQuery.myCity&&(userLocQueryOptions.myCity.total=a.results.myCity.total,0==a.results.myCity.total&&delete usrLocQuery.myCity),void 0!==usrLocQuery.myCountry&&(userLocQueryOptions.myCountry.total=a.results.myCountry.total,0==a.results.myCountry.total&&delete usrLocQuery.myCountry),jQuery(".userloc-trs-tot").html(a.total),jQuery(".userloc-submitter-tot").html(userLocQueryOptions.submitter.total),0!=userLocQueryOptions.submitter.total&&(jQuery(".userloc-submitter-chkbox").prop("checked",!0),userLocQueryOptions.submitter.checked=!0),jQuery(".userloc-asn-tot").html(userLocQueryOptions.myAsn.total),0!=userLocQueryOptions.myAsn.total&&(jQuery(".userloc-asn-chkbox").prop("checked",!0),userLocQueryOptions.myAsn.checked=!0),jQuery(".userloc-city-tot").html(userLocQueryOptions.myCity.total),0!=userLocQueryOptions.myCity.total&&(jQuery(".userloc-city-chkbox").prop("checked",!0),userLocQueryOptions.myCity.checked=!0),jQuery(".userloc-country-tot").html(userLocQueryOptions.myCountry.total),0!=userLocQueryOptions.myCountry.total&&(jQuery(".userloc-country-chkbox").prop("checked",!0),userLocQueryOptions.myCountry.checked=!0),0!=a.total?(jQuery("#myloc-contribute-btn").removeClass("blue"),jQuery("#myloc-submit-btn").addClass("blue"),jQuery("#myloc-submit-btn").unbind("click"),jQuery("#myloc-submit-btn").click(function(){submitUserLocObject(),jQuery(".opening.modal").modal("hide")})):(jQuery("#myloc-submit-btn").unbind("click"),jQuery("#myloc-submit-btn").removeClass("blue"),jQuery("#myloc-contribute-btn").addClass("blue"))},loadingUsrLocQuery=function(){var a='<img width="20px" src="/_assets/img/icn-loading.gif"/>';void 0!==usrLocQuery.submitter&&jQuery(".userloc-submitter-tot").html(a),void 0!==usrLocQuery.myAsn&&jQuery(".userloc-asn-tot").html(a),void 0!==usrLocQuery.myCountry&&jQuery(".userloc-country-tot").html(a),void 0!==usrLocQuery.myCity&&jQuery(".userloc-city-tot").html(a),jQuery(".userloc-trs-tot").html(a),jQuery("#myloc-submit-btn").removeClass("blue")};