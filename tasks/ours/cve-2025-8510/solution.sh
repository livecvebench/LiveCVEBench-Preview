#!/bin/bash
set -e

# This script applies the fix for the parameter handling issue in the
# enrollment listing page. The vulnerable code uses a foreach loop that
# assigns ALL GET parameters to object properties without validation.
# The fix replaces this with explicit parameter extraction using
# Laravel's request()->integer() method for type-safe handling.

# Navigate to the correct application directory
cd /var/www/ieducar

VULN_FILE="ieducar/intranet/educar_matricula_lst.php"

# Check if the file exists
if [ ! -f "$VULN_FILE" ]; then
    echo "Error: Vulnerable file not found at $VULN_FILE"
    exit 1
fi

# Check if fix is already applied (idempotent check)
if grep -q "request()->integer('ref_cod_aluno')" "$VULN_FILE"; then
    echo "Fix already applied, skipping..."
    exit 0
fi

# Create the fix using PHP to handle the multi-line replacement properly
php << 'PHPSCRIPT'
<?php
$file = 'ieducar/intranet/educar_matricula_lst.php';
$content = file_get_contents($file);

if ($content === false) {
    echo "Error: Could not read file\n";
    exit(1);
}

// The vulnerable pattern - using exact match including the Portuguese comment
$vulnerable_pattern = <<<'PATTERN'
        foreach ($_GET as $var => $val) { // passa todos os valores obtidos no GET para atributos do objeto
            $this->$var = ($val === '') ? null : $val;
        }
PATTERN;

// Also try without the Portuguese comment (in case file differs)
$vulnerable_pattern_alt = <<<'PATTERN'
        foreach ($_GET as $var => $val) {
            $this->$var = ($val === '') ? null : $val;
        }
PATTERN;

// Also try with the VULNERABLE CODE comment added by analyzer
$vulnerable_pattern_with_comment = <<<'PATTERN'
        // VULNERABLE CODE: passes all GET values to object attributes without validation
        foreach ($_GET as $var => $val) { // passa todos os valores obtidos no GET para atributos do objeto
            $this->$var = ($val === '') ? null : $val;
        }
PATTERN;

// The fixed code - explicitly extract only the needed parameters with integer casting
// This includes all parameters that the application legitimately uses for filtering
$fixed_code = <<<'FIXED'
        $this->ref_cod_aluno = request()->integer('ref_cod_aluno');
        $this->ref_cod_escola = request()->integer('ref_cod_escola');
        $this->ref_cod_instituicao = request()->integer('ref_cod_instituicao');
        $this->ref_cod_curso = request()->integer('ref_cod_curso');
        $this->ref_ref_cod_serie = request()->integer('ref_ref_cod_serie');
FIXED;

// Try each pattern
$replaced = false;

if (strpos($content, $vulnerable_pattern_with_comment) !== false) {
    $content = str_replace($vulnerable_pattern_with_comment, $fixed_code, $content);
    $replaced = true;
} elseif (strpos($content, $vulnerable_pattern) !== false) {
    $content = str_replace($vulnerable_pattern, $fixed_code, $content);
    $replaced = true;
} elseif (strpos($content, $vulnerable_pattern_alt) !== false) {
    $content = str_replace($vulnerable_pattern_alt, $fixed_code, $content);
    $replaced = true;
}

if (!$replaced) {
    // Try regex as fallback for any whitespace variations
    $pattern = '/\s*(?:\/\/[^\n]*\n)?\s*foreach\s*\(\s*\$_GET\s+as\s+\$var\s*=>\s*\$val\s*\)\s*\{[^}]*\$this->\$var[^}]*\}/s';
    $content = preg_replace($pattern, "\n" . $fixed_code, $content, 1, $count);

    if ($count > 0) {
        $replaced = true;
    }
}

if (!$replaced) {
    echo "Error: Could not find vulnerable code pattern to replace\n";
    exit(1);
}

if (file_put_contents($file, $content) === false) {
    echo "Error: Could not write fixed file\n";
    exit(1);
}

echo "Fix applied successfully!\n";
PHPSCRIPT

# Verify the fix was applied
if grep -q "request()->integer('ref_cod_aluno')" "$VULN_FILE"; then
    echo "Verification: Fix confirmed in $VULN_FILE"
else
    echo "Error: Fix verification failed"
    exit 1
fi

# Restart PHP-FPM if running (for the fix to take effect)
# PHP-FPM typically handles opcache automatically, but a restart ensures it
if pgrep -x "php-fpm" > /dev/null; then
    echo "Restarting PHP-FPM to apply changes..."
    pkill -USR2 -x "php-fpm" 2>/dev/null || true
    sleep 2
fi

echo "Fix applied successfully!"
