"""
Vulnerability tests for MDC Renderer Base Tag XSS.

These tests verify the vulnerability status:
- FAIL in vulnerable state (vulnerability is exploitable - base tag renders)
- PASS in fixed state (vulnerability is mitigated - base tag is sanitized)
"""

import pytest
import requests
import time
import re
import urllib.parse
from typing import Optional

BASE_URL = "http://localhost:3000"
TIMEOUT = 10


def wait_for_server(max_attempts: int = 30, delay: float = 1.0) -> bool:
    """Wait for the Nuxt server to be ready."""
    for _ in range(max_attempts):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
    return False


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure server is ready before running tests."""
    if not wait_for_server():
        pytest.skip("Server not available")


def get_rendered_html(content: str) -> str:
    """Send content to the test endpoint and get rendered HTML."""
    encoded = urllib.parse.quote(content, safe='')
    response = requests.get(f"{BASE_URL}/test?content={encoded}", timeout=TIMEOUT)
    assert response.status_code == 200, f"Request failed with status {response.status_code}"
    return response.text


def check_base_tag_sanitized(html: str) -> bool:
    """
    Check if base tag is properly sanitized.
    Returns True if sanitized (safe), False if raw base tag is present (vulnerable).
    """
    html_lower = html.lower()

    # Check for dangerous tag class (indicates proper sanitization)
    if "mdc-renderer-dangerous-tag" in html_lower:
        return True

    # Check for raw base tag in the HTML
    # Pattern matches: <base href="..." or <base href='...'
    raw_base_pattern = r'<base\s+href\s*=\s*["\'][^"\']+["\']'
    if re.search(raw_base_pattern, html_lower):
        return False  # Vulnerable - raw base tag found

    # Also check for just <base> without href
    if re.search(r'<base[^>]*>', html_lower):
        # Check if it's inside a <pre> tag (safe)
        if '<pre' in html_lower and '</pre>' in html_lower:
            pre_match = re.search(r'<pre[^>]*>(.*?)</pre>', html_lower, re.DOTALL)
            if pre_match and '<base' in pre_match.group(1):
                return True  # Safe - base tag is inside pre
        return False  # Vulnerable

    return True  # No base tag found, considered safe


class TestBaseTagVulnerability:
    """Test that base tags are properly sanitized."""

    def test_basic_base_tag_injection(self):
        """Test basic base tag injection is blocked."""
        payload = '<base href="https://attacker.example.com">'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Raw <base> tag found in rendered HTML. Base tags should be sanitized."

    def test_base_tag_with_single_quotes(self):
        """Test base tag with single quotes is blocked."""
        payload = "<base href='https://evil.example.com'>"
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Raw <base> tag with single quotes found. Should be sanitized."

    def test_base_tag_with_target(self):
        """Test base tag with target attribute is blocked."""
        payload = '<base href="https://malicious.com" target="_blank">'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Raw <base> tag with target found. Should be sanitized."

    def test_base_tag_uppercase(self):
        """Test uppercase BASE tag is blocked."""
        payload = '<BASE href="https://attacker.com">'
        html = get_rendered_html(payload)

        # Check both lowercase and original
        html_lower = html.lower()
        has_raw_base = re.search(r'<base\s+href', html_lower) is not None
        has_sanitized = "mdc-renderer-dangerous-tag" in html_lower or "<pre" in html_lower

        assert not has_raw_base or has_sanitized, \
            "VULNERABLE: Uppercase <BASE> tag not sanitized."

    def test_base_tag_mixed_case(self):
        """Test mixed case BaSe tag is blocked."""
        payload = '<BaSe href="https://attacker.com">'
        html = get_rendered_html(payload)

        html_lower = html.lower()
        has_raw_base = re.search(r'<base\s+href', html_lower) is not None
        has_sanitized = "mdc-renderer-dangerous-tag" in html_lower or "<pre" in html_lower

        assert not has_raw_base or has_sanitized, \
            "VULNERABLE: Mixed case <BaSe> tag not sanitized."


class TestBaseTagWithOtherContent:
    """Test base tag injection combined with other content."""

    def test_base_tag_with_regular_content(self):
        """Test base tag mixed with regular markdown content."""
        payload = """# Hello World

<base href="https://attacker.com">

This is some regular content.
"""
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag not sanitized when mixed with markdown content."

    def test_base_tag_before_links(self):
        """Test base tag injection before relative links."""
        payload = """<base href="https://evil.com">

[Click here](/malicious-path)
"""
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag not sanitized. Could affect relative URL resolution."

    def test_base_tag_with_images(self):
        """Test base tag injection with image references."""
        payload = """<base href="https://attacker-cdn.com">

![Logo](/images/logo.png)
"""
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag not sanitized. Could redirect image loading."

    def test_multiple_base_tags(self):
        """Test multiple base tag injections."""
        payload = """<base href="https://first.evil.com">
Some content
<base href="https://second.evil.com">
More content
"""
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Multiple base tags not sanitized."


class TestBaseTagVariations:
    """Test various base tag syntax variations."""

    def test_base_tag_extra_spaces(self):
        """Test base tag with extra spaces."""
        payload = '<base   href="https://attacker.com"   >'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag with extra spaces not sanitized."

    def test_base_tag_newlines(self):
        """Test base tag with newlines."""
        payload = '''<base
href="https://attacker.com"
>'''
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag with newlines not sanitized."

    def test_base_tag_tabs(self):
        """Test base tag with tabs."""
        payload = '<base\thref="https://attacker.com">'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag with tabs not sanitized."

    def test_self_closing_base_tag(self):
        """Test self-closing base tag."""
        payload = '<base href="https://attacker.com" />'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Self-closing base tag not sanitized."

    def test_base_tag_no_closing(self):
        """Test base tag without closing (valid HTML5)."""
        payload = '<base href="https://attacker.com">content here'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag (no closing) not sanitized."


class TestBaseTagEvasionAttempts:
    """Test potential evasion attempts."""

    def test_base_tag_data_uri(self):
        """Test base tag with data URI scheme."""
        payload = '<base href="data:text/html,<script>alert(1)</script>">'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag with data URI not sanitized."

    def test_base_tag_javascript_uri(self):
        """Test base tag with javascript URI scheme."""
        payload = '<base href="javascript:alert(1)">'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag with javascript URI not sanitized."

    def test_base_tag_protocol_relative(self):
        """Test base tag with protocol-relative URL."""
        payload = '<base href="//attacker.com">'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag with protocol-relative URL not sanitized."

    def test_base_tag_file_protocol(self):
        """Test base tag with file protocol."""
        payload = '<base href="file:///etc/passwd">'
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag with file protocol not sanitized."


class TestDangerousTagClass:
    """Test that the fix applies correct sanitization class."""

    def test_dangerous_tag_class_present_for_base(self):
        """Test that base tags get the dangerous tag class after fix."""
        payload = '<base href="https://attacker.com">'
        html = get_rendered_html(payload)

        # After fix, base tags should be wrapped in pre with the class
        # OR at minimum, should not be raw base tags
        if "mdc-renderer-dangerous-tag" in html:
            assert True, "Properly sanitized with mdc-renderer-dangerous-tag class"
        elif "<pre" in html.lower() and "base" in html.lower():
            assert True, "Base tag is inside a pre element"
        else:
            # Check no raw base tag
            has_raw = re.search(r'<base\s+href\s*=', html.lower())
            assert not has_raw, \
                "VULNERABLE: Base tag should be sanitized with mdc-renderer-dangerous-tag class"

    def test_both_base_and_script_sanitized(self):
        """Test that both base and script tags are sanitized together."""
        payload = """<base href="https://attacker.com">
<script>alert('xss')</script>
"""
        html = get_rendered_html(payload)

        # Both should be sanitized
        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Base tag not sanitized when combined with script tag."


class TestRealWorldScenarios:
    """Test real-world attack scenarios."""

    def test_phishing_redirect_attack(self):
        """Test phishing attack via base tag URL redirect."""
        payload = """# Welcome to Our Site

<base href="https://phishing-site.evil.com">

Please [login here](/login) to continue.

Or visit your [account dashboard](/dashboard).
"""
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Phishing redirect attack possible via base tag."

    def test_resource_hijacking_attack(self):
        """Test resource hijacking via base tag."""
        payload = """<base href="https://malicious-cdn.com">

<img src="/logo.png">
<link rel="stylesheet" href="/styles.css">
"""
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Resource hijacking possible via base tag."

    def test_form_action_hijacking(self):
        """Test form action hijacking via base tag."""
        payload = """<base href="https://credential-stealer.com">

Please submit your feedback below:

<form action="/submit-feedback" method="POST">
  <input type="text" name="feedback">
  <button type="submit">Submit</button>
</form>
"""
        html = get_rendered_html(payload)

        assert check_base_tag_sanitized(html), \
            "VULNERABLE: Form action hijacking possible via base tag."
