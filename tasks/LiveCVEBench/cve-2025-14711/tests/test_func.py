"""
Functional tests for the Hotel Search API.
These tests verify that the API works correctly for normal operations.
Should PASS in both vulnerable and fixed states.
"""

import requests
import pytest
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:80")
API_ENDPOINT = f"{BASE_URL}/controller/api/hotelList.php"
API_KEY = "TheHotelReversationApplication"


class TestHotelSearchFunctionality:
    """Tests for hotel search API functionality."""

    def test_api_endpoint_responds(self):
        """Test that the API endpoint is accessible and responds."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "杭州",
                "page": "1",
                "size": "10",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert "code" in data

    def test_search_by_city_returns_results(self):
        """Test that searching by city returns valid results."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "杭州",
                "page": "1",
                "size": "100",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        assert "data" in data
        # Verify results are from the requested city
        if data["data"]:
            for hotel in data["data"]:
                assert "杭州" in hotel.get("address", "") or "浙江" in hotel.get("address", "")

    def test_search_by_hotel_name(self):
        """Test hotel name search (request type 5)."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "5",
                "pickedHotelName": "酒店",
                "cityName": "杭州",
                "page": "1",
                "size": "50",
                "pickedStar": "不限",
                "pickedPrice": "不限",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        assert "data" in data
        # Verify results contain the searched name
        if data["data"]:
            for hotel in data["data"]:
                assert "酒店" in hotel.get("hotelName", "") or hotel.get("hotelName", "") != ""

    def test_search_by_hotel_type(self):
        """Test hotel type search (request type 3)."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "3",
                "cityName": "杭州",
                "type": "1",
                "page": "1",
                "size": "50",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        assert "data" in data
        # Verify results match the requested type
        if data["data"]:
            for hotel in data["data"]:
                assert str(hotel.get("kindType", "")) == "1"

    def test_search_by_type_only(self):
        """Test hotel type search without city filter (request type 4)."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "4",
                "cityName": "",
                "type": "3",
                "page": "1",
                "size": "50",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        assert "data" in data
        # Verify results match the requested type
        if data["data"]:
            for hotel in data["data"]:
                assert str(hotel.get("kindType", "")) == "3"

    def test_pagination_works(self):
        """Test that pagination returns different results for different pages."""
        response_page1 = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "杭州",
                "page": "1",
                "size": "3",
            },
            timeout=10
        )
        response_page2 = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "杭州",
                "page": "2",
                "size": "3",
            },
            timeout=10
        )

        data1 = response_page1.json()
        data2 = response_page2.json()

        assert data1["code"] == 200
        assert data2["code"] == 200

        # If both pages have data, they should be different
        if data1.get("data") and data2.get("data"):
            ids1 = [h.get("id") for h in data1["data"]]
            ids2 = [h.get("id") for h in data2["data"]]
            # At least some IDs should be different
            assert ids1 != ids2

    def test_invalid_key_rejected(self):
        """Test that requests with invalid API key are rejected."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": "InvalidKey",
                "request": "2",
                "cityName": "杭州",
                "page": "1",
                "size": "10",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        # Should return error code for invalid key
        assert data["code"] != 200

    def test_search_beijing_hotels(self):
        """Test searching for hotels in Beijing."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "北京",
                "page": "1",
                "size": "50",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        assert "data" in data
        # Verify results are from Beijing
        if data["data"]:
            for hotel in data["data"]:
                assert "北京" in hotel.get("address", "")

    def test_search_shanghai_hotels(self):
        """Test searching for hotels in Shanghai."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "上海",
                "page": "1",
                "size": "50",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        assert "data" in data
        if data["data"]:
            for hotel in data["data"]:
                assert "上海" in hotel.get("address", "")

    def test_subject_hotel_search(self):
        """Test subject-based hotel search (request type 1)."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "1",
                "subjectId": "10",
                "cityName": "杭州",
                "page": "1",
                "size": "50",
            },
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        # Verify results match the subject
        if data.get("data"):
            for hotel in data["data"]:
                assert str(hotel.get("subject", "")) == "10"


class TestAPIResponseFormat:
    """Tests for API response format."""

    def test_response_has_required_fields(self):
        """Test that API response contains all required fields."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "杭州",
                "page": "1",
                "size": "10",
            },
            timeout=10
        )
        data = response.json()
        assert "code" in data
        assert "message" in data
        assert "data" in data

    def test_hotel_data_structure(self):
        """Test that hotel data contains expected fields."""
        response = requests.post(
            API_ENDPOINT,
            data={
                "key": API_KEY,
                "request": "2",
                "cityName": "杭州",
                "page": "1",
                "size": "10",
            },
            timeout=10
        )
        data = response.json()
        if data.get("data") and len(data["data"]) > 0:
            hotel = data["data"][0]
            # Check for common hotel fields
            assert "id" in hotel
            assert "hotelName" in hotel
            assert "address" in hotel
