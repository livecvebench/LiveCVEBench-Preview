#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install uv if not present
if ! command -v uv &> /dev/null; then
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env 2>/dev/null || true
fi

# Initialize uv project if needed
uv init 2>/dev/null || true

# Add test dependencies - asteval should already be installed in the container
# but we add pytest for running the tests
uv add pytest 2>/dev/null

# The asteval package is installed system-wide in the container.
# We need to ensure uv's environment can access it via --system-site-packages
# Alternative: directly use the system python with pytest

# Check if asteval is available
if python -c "import asteval" 2>/dev/null; then
    echo "asteval package found in system Python"
    # Use system pytest with system packages
    pip install pytest -q 2>/dev/null || true
    python -m pytest . -rA
else
    echo "asteval not found in system, trying uv environment..."
    uv add asteval 2>/dev/null || true
    uv run pytest . -rA
fi
