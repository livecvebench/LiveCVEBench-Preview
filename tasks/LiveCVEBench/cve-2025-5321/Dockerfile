# Dockerfile for CVE-2025-5321: Aim Sandbox Escape Vulnerability
# Vulnerable version: 3.29.1

FROM python:3.10-slim

WORKDIR /app

# Environment variables for Aim
# Note: AIM_REPO should be the parent of the .aim directory
ENV AIM_REPO=/app
ENV PYTHONUNBUFFERED=1
ENV AIM_SERVER_HOST=0.0.0.0
ENV AIM_SERVER_PORT=43800

# Install system dependencies
# - git: for cloning (if needed)
# - build-essential: for compiling Cython extensions
# - python3-dev: for building Python C extensions
# - curl: for health checks and testing
# - tmux, asciinema: required by system
RUN apt-get update && apt-get install -y \
    git \
    build-essential \
    python3-dev \
    curl \
    tmux \
    asciinema \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Install Aim from PyPI (includes pre-built wheels for native extensions)
RUN pip install --no-cache-dir aim==3.29.1

# Find and store the Aim installation path
RUN python -c "import aim; import os; print(os.path.dirname(aim.__file__))" > /tmp/aim_path

# Copy vulnerable files to the Aim installation
# query.py.vulnerable -> aim/storage/query.py
COPY task-deps/query.py.vulnerable /tmp/query.py.vulnerable
RUN cp /tmp/query.py.vulnerable $(cat /tmp/aim_path)/storage/query.py

# Copy query_utils.py to the Aim installation
COPY task-deps/query_utils.py /tmp/query_utils.py
RUN cp /tmp/query_utils.py $(cat /tmp/aim_path)/sdk/query_utils.py

# Note: Aim repository initialization is done in entrypoint.sh at runtime
# This ensures it works correctly and allows re-initialization if needed

# Copy sample data creation script
COPY task-deps/create_sample_data.py /app/create_sample_data.py

# Copy entrypoint script
COPY task-deps/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Expose the Aim server port
EXPOSE 43800

# Use entrypoint script for restart capability
# CMD ["/app/entrypoint.sh"]  # Moved to docker-compose.yaml
