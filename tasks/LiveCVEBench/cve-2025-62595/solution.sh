#!/bin/bash
set -e
cd /app

# Fix the open redirect bypass vulnerability in lib/response.js
# The vulnerability is in the _getBackReferrer() method which incorrectly treats
# protocol-relative URLs (//evil.com) as safe relative paths because they start with '/'
#
# The fix removes the special case handling for paths starting with '/' and routes
# all referrers through URL parsing and origin validation

# Use node to apply the fix - more reliable than sed for multi-line changes
node -e "
const fs = require('fs');
let content = fs.readFileSync('lib/response.js', 'utf8');

// Remove the vulnerable code block that skips validation for URLs starting with '/'
// The vulnerable code is:
//   // referrer is a relative path
//   if (referrer.startsWith('/')) {
//     return referrer;
//   }
//
// This block must be removed so ALL referrers go through URL parsing and host validation

const vulnerablePattern = /      \/\/ referrer is a relative path\n      if \(referrer\.startsWith\('\/'\)\) \{\n        return referrer;\n      \}\n\n/;

if (vulnerablePattern.test(content)) {
    content = content.replace(vulnerablePattern, '');
    fs.writeFileSync('lib/response.js', content);
    console.log('Fix applied successfully: removed vulnerable startsWith check');
} else {
    // Check if already fixed
    if (!content.includes(\"if (referrer.startsWith('/'))\")) {
        console.log('Fix already applied or code structure different');
    } else {
        console.error('Could not apply fix - pattern not found');
        process.exit(1);
    }
}
"

# Restart the Node.js application so the fix takes effect
# The entrypoint will restart it automatically
echo "Restarting application..."
pkill -f "node.*server.js" || pkill -f "node.*app.js" || pkill -f "node.*index.js" || true
sleep 2

echo "Fix complete - open redirect bypass vulnerability has been patched"
