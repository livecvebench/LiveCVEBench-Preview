"""
Vulnerability tests for EXIF metadata exposure in image uploads.

These tests verify that EXIF metadata is properly stripped from uploaded images.
In the VULNERABLE state (no metadata stripping implemented):
- These tests will FAIL because EXIF data is preserved after upload
In the FIXED state (with metadata stripping):
- These tests will PASS because EXIF data is removed

The tests simulate the upload process (write file as raw bytes) and check if
metadata is preserved - which is the vulnerability.
"""

import pytest
import sys
import os
import tempfile
from io import BytesIO
from PIL import Image

# We need piexif to create test images with EXIF data
import piexif

# Add the api directory to the path for imports
sys.path.insert(0, '/app/api')


def create_image_with_gps_exif():
    """Create a JPEG image with GPS coordinates embedded in EXIF."""
    img = Image.new('RGB', (100, 100), color='blue')

    # Create GPS EXIF data (San Francisco coordinates: 37.7749, -122.4194)
    # GPS coordinates are stored as rational numbers (tuples of (numerator, denominator))
    exif_dict = {
        "0th": {
            piexif.ImageIFD.Make: "TestCamera",
            piexif.ImageIFD.Model: "Test Model X",
            piexif.ImageIFD.Software: "Test Software 1.0",
        },
        "Exif": {
            piexif.ExifIFD.DateTimeOriginal: "2024:01:15 10:30:00",
            piexif.ExifIFD.LensMake: "Test Lens Maker",
        },
        "GPS": {
            piexif.GPSIFD.GPSLatitude: ((37, 1), (46, 1), (2940, 100)),
            piexif.GPSIFD.GPSLatitudeRef: "N",
            piexif.GPSIFD.GPSLongitude: ((122, 1), (25, 1), (960, 100)),
            piexif.GPSIFD.GPSLongitudeRef: "W",
            piexif.GPSIFD.GPSAltitude: (10, 1),
            piexif.GPSIFD.GPSAltitudeRef: 0,
        },
        "1st": {},
        "thumbnail": None
    }
    exif_bytes = piexif.dump(exif_dict)

    output = BytesIO()
    img.save(output, format='JPEG', exif=exif_bytes)
    return output.getvalue()


def create_image_with_device_exif():
    """Create a JPEG image with device information embedded in EXIF."""
    img = Image.new('RGB', (100, 100), color='green')

    exif_dict = {
        "0th": {
            piexif.ImageIFD.Make: "Apple",
            piexif.ImageIFD.Model: "iPhone 15 Pro Max",
            piexif.ImageIFD.Software: "iOS 17.2",
            piexif.ImageIFD.DateTime: "2024:03:20 14:25:30",
            piexif.ImageIFD.Artist: "John Doe",
            piexif.ImageIFD.Copyright: "Copyright 2024 John Doe",
        },
        "Exif": {
            piexif.ExifIFD.DateTimeOriginal: "2024:03:20 14:25:30",
            piexif.ExifIFD.DateTimeDigitized: "2024:03:20 14:25:30",
            piexif.ExifIFD.ExposureTime: (1, 100),
            piexif.ExifIFD.FNumber: (24, 10),
            piexif.ExifIFD.ISOSpeedRatings: 100,
            piexif.ExifIFD.LensMake: "Apple",
            piexif.ExifIFD.LensModel: "iPhone 15 Pro Max back triple camera 6.765mm f/2.2",
        },
        "GPS": {},
        "1st": {},
        "thumbnail": None
    }
    exif_bytes = piexif.dump(exif_dict)

    output = BytesIO()
    img.save(output, format='JPEG', exif=exif_bytes)
    return output.getvalue()


def create_image_with_full_exif():
    """Create a JPEG image with comprehensive EXIF data."""
    img = Image.new('RGB', (200, 200), color='red')

    exif_dict = {
        "0th": {
            piexif.ImageIFD.Make: "Canon",
            piexif.ImageIFD.Model: "EOS R5",
            piexif.ImageIFD.Software: "Digital Photo Professional 4",
            piexif.ImageIFD.DateTime: "2024:06:15 09:30:00",
            piexif.ImageIFD.Artist: "Professional Photographer",
            piexif.ImageIFD.Copyright: "All Rights Reserved 2024",
            piexif.ImageIFD.ImageDescription: "Confidential photo location",
        },
        "Exif": {
            piexif.ExifIFD.DateTimeOriginal: "2024:06:15 09:30:00",
            piexif.ExifIFD.DateTimeDigitized: "2024:06:15 09:30:00",
            piexif.ExifIFD.ExposureTime: (1, 250),
            piexif.ExifIFD.FNumber: (28, 10),
            piexif.ExifIFD.ExposureProgram: 1,
            piexif.ExifIFD.ISOSpeedRatings: 400,
            piexif.ExifIFD.SensitivityType: 2,
            piexif.ExifIFD.ExposureBiasValue: (0, 10),
            piexif.ExifIFD.MaxApertureValue: (30, 10),
            piexif.ExifIFD.MeteringMode: 5,
            piexif.ExifIFD.Flash: 0,
            piexif.ExifIFD.FocalLength: (50, 1),
            piexif.ExifIFD.LensMake: "Canon",
            piexif.ExifIFD.LensModel: "RF 50mm F1.8 STM",
            piexif.ExifIFD.BodySerialNumber: "SN123456789",
            piexif.ExifIFD.LensSerialNumber: "LENS987654321",
        },
        "GPS": {
            piexif.GPSIFD.GPSVersionID: (2, 3, 0, 0),
            piexif.GPSIFD.GPSLatitude: ((40, 1), (44, 1), (5400, 100)),
            piexif.GPSIFD.GPSLatitudeRef: "N",
            piexif.GPSIFD.GPSLongitude: ((73, 1), (59, 1), (300, 100)),
            piexif.GPSIFD.GPSLongitudeRef: "W",
            piexif.GPSIFD.GPSAltitude: (25, 1),
            piexif.GPSIFD.GPSAltitudeRef: 0,
            piexif.GPSIFD.GPSTimeStamp: ((9, 1), (30, 1), (0, 1)),
            piexif.GPSIFD.GPSDateStamp: "2024:06:15",
        },
        "1st": {},
        "thumbnail": None
    }
    exif_bytes = piexif.dump(exif_dict)

    output = BytesIO()
    img.save(output, format='JPEG', exif=exif_bytes)
    return output.getvalue()


def simulate_upload(file_binary: bytes, filename: str, tmpdir: str) -> str:
    """
    Simulate the upload process as done by upload_content.
    In the fixed state, this imports and uses strip_image_metadata from the application.
    In the vulnerable state, it writes raw bytes (which would fail these tests).
    """
    # Import the strip_image_metadata function from the application
    # This tests the actual fix implementation
    try:
        from src.services.utils.upload_content import strip_image_metadata
        file_format = filename.split(".")[-1].strip().lower()
        file_binary = strip_image_metadata(file_binary, file_format)
    except ImportError:
        # If strip_image_metadata doesn't exist, the application is vulnerable
        pass

    filepath = os.path.join(tmpdir, filename)
    with open(filepath, 'wb') as f:
        f.write(file_binary)
    return filepath


def extract_exif_from_bytes(image_bytes):
    """Extract EXIF data from image bytes."""
    try:
        return piexif.load(image_bytes)
    except Exception:
        return None


def extract_exif_from_file(filepath):
    """Extract EXIF data from a file."""
    try:
        with open(filepath, 'rb') as f:
            return piexif.load(f.read())
    except Exception:
        return None


def has_gps_data(exif_dict):
    """Check if EXIF dict contains GPS coordinates."""
    if not exif_dict:
        return False
    gps = exif_dict.get('GPS', {})
    return piexif.GPSIFD.GPSLatitude in gps or piexif.GPSIFD.GPSLongitude in gps


def has_device_info(exif_dict):
    """Check if EXIF dict contains device information."""
    if not exif_dict:
        return False
    zeroth = exif_dict.get('0th', {})
    return (piexif.ImageIFD.Make in zeroth or
            piexif.ImageIFD.Model in zeroth or
            piexif.ImageIFD.Software in zeroth)


def has_any_exif(exif_dict):
    """Check if there's any significant EXIF data."""
    if not exif_dict:
        return False

    for key in ['0th', 'Exif', 'GPS', '1st']:
        if exif_dict.get(key):
            return True
    return False


class TestGPSMetadataStripping:
    """
    Tests for GPS/location metadata stripping.
    These tests FAIL in vulnerable state because GPS data is preserved.
    """

    def test_gps_coordinates_stripped_from_jpeg(self):
        """Test that GPS coordinates are removed from JPEG uploads."""
        # Create image with GPS data
        original = create_image_with_gps_exif()

        # Verify original has GPS
        original_exif = extract_exif_from_bytes(original)
        assert has_gps_data(original_exif), "Test setup: original should have GPS data"

        # Simulate upload (write file as raw bytes - vulnerable behavior)
        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_gps.jpg", tmpdir)

            # Read back the uploaded file
            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            # Verify GPS is stripped (this FAILS in vulnerable state)
            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            assert not has_gps_data(uploaded_exif), \
                "GPS coordinates should be stripped from uploaded images"

    def test_gps_latitude_removed(self):
        """Test that GPS latitude is specifically removed."""
        original = create_image_with_gps_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_lat.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'GPS' in uploaded_exif:
                assert piexif.GPSIFD.GPSLatitude not in uploaded_exif['GPS'], \
                    "GPS Latitude should be removed"
                assert piexif.GPSIFD.GPSLatitudeRef not in uploaded_exif['GPS'], \
                    "GPS Latitude Reference should be removed"

    def test_gps_longitude_removed(self):
        """Test that GPS longitude is specifically removed."""
        original = create_image_with_gps_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_lon.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'GPS' in uploaded_exif:
                assert piexif.GPSIFD.GPSLongitude not in uploaded_exif['GPS'], \
                    "GPS Longitude should be removed"
                assert piexif.GPSIFD.GPSLongitudeRef not in uploaded_exif['GPS'], \
                    "GPS Longitude Reference should be removed"

    def test_gps_altitude_removed(self):
        """Test that GPS altitude is removed."""
        original = create_image_with_gps_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_alt.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'GPS' in uploaded_exif:
                assert piexif.GPSIFD.GPSAltitude not in uploaded_exif['GPS'], \
                    "GPS Altitude should be removed"


class TestDeviceInfoStripping:
    """
    Tests for device information metadata stripping.
    These tests FAIL in vulnerable state because device info is preserved.
    """

    def test_camera_make_model_stripped(self):
        """Test that camera make and model are removed."""
        original = create_image_with_device_exif()

        # Verify original has device info
        original_exif = extract_exif_from_bytes(original)
        assert has_device_info(original_exif), "Test setup: original should have device info"

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_device.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            assert not has_device_info(uploaded_exif), \
                "Device make/model should be stripped from uploaded images"

    def test_software_info_stripped(self):
        """Test that software information is removed."""
        original = create_image_with_device_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_software.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and '0th' in uploaded_exif:
                assert piexif.ImageIFD.Software not in uploaded_exif['0th'], \
                    "Software info should be removed"

    def test_artist_info_stripped(self):
        """Test that artist/author information is removed."""
        original = create_image_with_device_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_artist.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and '0th' in uploaded_exif:
                assert piexif.ImageIFD.Artist not in uploaded_exif['0th'], \
                    "Artist info should be removed"


class TestTimestampStripping:
    """
    Tests for timestamp metadata stripping.
    These tests FAIL in vulnerable state because timestamps are preserved.
    """

    def test_datetime_original_stripped(self):
        """Test that original datetime is removed."""
        original = create_image_with_full_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_datetime.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'Exif' in uploaded_exif:
                assert piexif.ExifIFD.DateTimeOriginal not in uploaded_exif['Exif'], \
                    "DateTimeOriginal should be removed"

    def test_datetime_digitized_stripped(self):
        """Test that digitized datetime is removed."""
        original = create_image_with_full_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_digitized.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'Exif' in uploaded_exif:
                assert piexif.ExifIFD.DateTimeDigitized not in uploaded_exif['Exif'], \
                    "DateTimeDigitized should be removed"

    def test_gps_timestamp_stripped(self):
        """Test that GPS timestamp is removed."""
        original = create_image_with_full_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_gps_time.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'GPS' in uploaded_exif:
                assert piexif.GPSIFD.GPSTimeStamp not in uploaded_exif['GPS'], \
                    "GPS Timestamp should be removed"
                assert piexif.GPSIFD.GPSDateStamp not in uploaded_exif['GPS'], \
                    "GPS DateStamp should be removed"


class TestSerialNumberStripping:
    """
    Tests for serial number and unique identifier stripping.
    These tests FAIL in vulnerable state because serial numbers are preserved.
    """

    def test_body_serial_number_stripped(self):
        """Test that camera body serial number is removed."""
        original = create_image_with_full_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_body_sn.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'Exif' in uploaded_exif:
                assert piexif.ExifIFD.BodySerialNumber not in uploaded_exif['Exif'], \
                    "Body serial number should be removed"

    def test_lens_serial_number_stripped(self):
        """Test that lens serial number is removed."""
        original = create_image_with_full_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_lens_sn.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            if uploaded_exif and 'Exif' in uploaded_exif:
                assert piexif.ExifIFD.LensSerialNumber not in uploaded_exif['Exif'], \
                    "Lens serial number should be removed"


class TestComprehensiveMetadataStripping:
    """
    Comprehensive tests ensuring all metadata types are stripped.
    These tests FAIL in vulnerable state because all metadata is preserved.
    """

    def test_all_exif_data_stripped(self):
        """Test that ALL EXIF data is stripped from uploaded images."""
        original = create_image_with_full_exif()

        # Verify original has EXIF
        original_exif = extract_exif_from_bytes(original)
        assert has_any_exif(original_exif), "Test setup: original should have EXIF data"

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_all_exif.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            # Verify all EXIF is stripped (FAILS in vulnerable state)
            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            assert not has_any_exif(uploaded_exif), \
                "All EXIF data should be stripped from uploaded images"

    def test_multiple_images_all_stripped(self):
        """Test that metadata is stripped from multiple different images."""
        test_images = [
            ("gps_image.jpg", create_image_with_gps_exif()),
            ("device_image.jpg", create_image_with_device_exif()),
            ("full_image.jpg", create_image_with_full_exif()),
        ]

        with tempfile.TemporaryDirectory() as tmpdir:
            for filename, original in test_images:
                uploaded_path = simulate_upload(original, filename, tmpdir)

                with open(uploaded_path, 'rb') as f:
                    uploaded_data = f.read()

                uploaded_exif = extract_exif_from_bytes(uploaded_data)

                assert not has_gps_data(uploaded_exif), \
                    f"{filename}: GPS data should be stripped"
                assert not has_device_info(uploaded_exif), \
                    f"{filename}: Device info should be stripped"

    def test_jpg_extension_also_stripped(self):
        """Test that .jpg extension files also have metadata stripped."""
        original = create_image_with_full_exif()

        with tempfile.TemporaryDirectory() as tmpdir:
            uploaded_path = simulate_upload(original, "test_file.jpg", tmpdir)

            with open(uploaded_path, 'rb') as f:
                uploaded_data = f.read()

            uploaded_exif = extract_exif_from_bytes(uploaded_data)
            assert not has_any_exif(uploaded_exif), \
                "EXIF data should be stripped for .jpg files"
