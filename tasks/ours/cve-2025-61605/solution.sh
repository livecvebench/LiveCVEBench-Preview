#!/bin/bash
# Solution script for pet profile input validation fix
set -e

FILE="/var/www/html/html/pet/profile_pet.php"

echo "Applying fix to $FILE..."

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "Error: File $FILE not found"
    exit 1
fi

# Create a backup
cp "$FILE" "${FILE}.bak"

# Create the fixed version of the file header
# The fix adds input sanitization using filter_input() and validates the id_pet parameter

# Read the current file content
CURRENT_CONTENT=$(cat "$FILE")

# Create the new header section that replaces the vulnerable code
# This replaces lines 1-21 approximately with the fixed version
cat > /tmp/fixed_header.php << 'FIXED_HEADER'
<?php
if (session_status() === PHP_SESSION_NONE) {
  session_start();
}

require_once "../../dao/Conexao.php";
$pdo = Conexao::connect();

if (!isset($_SESSION['usuario'])) {
  header("Location: ../index.php");
  exit();
}else{
  session_regenerate_id();
}

require_once "../permissao/permissao.php";
permissao($_SESSION['id_pessoa'], 63, 7);

$id_pet = filter_input(INPUT_GET, 'id_pet', FILTER_VALIDATE_INT);

if($id_pet === false || $id_pet === null || $id_pet < 1){
  http_response_code(400);
  echo json_encode('O id do pet informado não é válido.');
  exit();
}

if (!isset($_SESSION['pet'])) {
  header('Location: ../../controle/control.php?modulo=pet&metodo=listarUm&nomeClasse=PetControle&nextPage=' . WWW . '/html/pet/profile_pet.php?id_pet=' . $id_pet);
} else {
  $petDados = $_SESSION['pet'];
  unset($_SESSION['pet']);
  $pet = json_encode($petDados);
}

$config_path = "config.php";
if (file_exists($config_path)) {
  require_once($config_path);
} else {
  while (true) {
    $config_path = "../" . $config_path;
    if (file_exists($config_path)) break;
  }
  require_once($config_path);
}

require_once "../personalizacao_display.php";
require_once "../../dao/Conexao.php";
require_once "../geral/msg.php";

// Lógica para listar os adotantes

try {
  $conexao = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME, DB_USER, DB_PASSWORD);
  $conexao->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

  $sqlListarAdotantes = "SELECT id_pessoa, nome, sobrenome FROM pessoa;";

  $stmt = $conexao->prepare($sqlListarAdotantes);
  $stmt->execute();

  $resultadosListarAdotantes = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
  echo 'Erro ao conectar ao banco de dados: ' . $e->getMessage();
}

// Lógica para buscar ficha médica
$fichaMedica = null;

// Também vamos buscar dados da adoção do pet
$adocaoPet = null;

if (isset($_GET['id_pet'])) {

  try {

    $stmtFicha = $conexao->prepare("SELECT id_ficha_medica, castrado, necessidades_especiais FROM pet_ficha_medica WHERE id_pet = :idPet");
    $stmtFicha->bindParam(':idPet', $id_pet, PDO::PARAM_INT);
    $stmtFicha->execute();

    $fichaMedica = $stmtFicha->fetch(PDO::FETCH_ASSOC);

    // BUSCA ADOTAÇÃO DO PET
    $stmtAdocao = $conexao->prepare("
          SELECT a.data_adocao, a.id_pessoa, p.nome
          FROM pet_adocao a
          INNER JOIN pessoa p ON a.id_pessoa = p.id_pessoa
          WHERE a.id_pet = :idPet
          LIMIT 1
      ");
    $stmtAdocao->bindParam(':idPet', $id_pet, PDO::PARAM_INT);
    $stmtAdocao->execute();

    $adocaoPet = $stmtAdocao->fetch(PDO::FETCH_ASSOC);
  } catch (PDOException $e) {
    echo "Erro ao buscar ficha médica ou adoção: " . $e->getMessage();
  }
}

?>
FIXED_HEADER

# Find where the HTML/script section begins (after the closing ?> of PHP section)
# We need to replace everything from start until just before "<!-- Agora injetamos"
# or before the HTML section

# Use awk to extract everything from "<!-- Agora injetamos" onwards
awk '/<!-- Agora injetamos/,0' "$FILE" > /tmp/rest_of_file.txt

# Combine fixed header with rest of file
cat /tmp/fixed_header.php /tmp/rest_of_file.txt > "$FILE"

# Clean up temp files
rm -f /tmp/fixed_header.php /tmp/rest_of_file.txt

# Additionally, we need to replace any remaining $_GET['id_pet'] usages with $id_pet
# in the HTML portion (there are a few inline PHP uses)
sed -i "s/\$_GET\['id_pet'\]/\$id_pet/g" "$FILE"

echo "Fix applied successfully"

# Verify the fix was applied
if grep -q "filter_input(INPUT_GET, 'id_pet'" "$FILE"; then
    echo "Verification: Input sanitization is in place"
else
    echo "Warning: Could not verify fix was applied correctly"
fi

# Since this is a PHP file served by Apache, no process restart is needed
# PHP files are interpreted on each request

echo "Fix complete"
