FROM node:20-slim

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y git tmux asciinema curl procps && rm -rf /var/lib/apt/lists/*

# Copy package files
COPY package*.json ./

# Install dependencies (solid-js@1.9.3 is vulnerable version)
RUN npm install

# Copy configuration and source
COPY vite.config.js ./
COPY src/ ./src/
COPY server.js ./

# Build the SSR bundle
RUN npm run build

# Remove compile-time escape() calls from the built output to expose the SSR runtime vulnerability
# The SSR runtime in solid-js@1.9.3 dist/server.js doesn't escape in Suspense/ErrorBoundary paths
# But the babel plugin adds escape() at compile time which masks the vulnerability
# We remove these to demonstrate the actual SSR runtime vulnerability
RUN sed -i 's/escape(data())/data()/g' /app/dist/App.js && \
    sed -i 's/, escape//g' /app/dist/App.js

# Copy task-deps for solution script
COPY task-deps/ ./task-deps/

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV NODE_ENV=production
ENV PORT=3000


# Health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s \
  CMD curl -f http://localhost:3000/ || exit 1

# CMD ["/entrypoint.sh"]
