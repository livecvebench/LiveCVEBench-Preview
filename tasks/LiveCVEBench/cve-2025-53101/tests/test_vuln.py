"""
Vulnerability tests for CVE-2025-53101: Stack Buffer Overflow in InterpretImageFilename.

These tests verify the vulnerability status:
- FAIL in vulnerable state (process crashes with SIGSEGV/SIGABRT or ASAN detects overflow)
- PASS in fixed state (process handles input safely)

The vulnerability is triggered when processing multiple consecutive format
specifiers (%d, %o, %x) in filename templates. The incorrect offset calculation
causes buffer underwrite, leading to crashes.

NOTE: Only patterns that reach the vulnerable InterpretImageFilename() code path
trigger the vulnerability. Patterns with prefixes/suffixes may fail at file lookup
before reaching the vulnerable code.
"""

import subprocess
import signal
import pytest


# Exit codes indicating a crash
CRASH_EXIT_CODES = [
    139,  # 128 + SIGSEGV (11)
    134,  # 128 + SIGABRT (6)
    -signal.SIGSEGV,  # -11
    -signal.SIGABRT,  # -6
    11,   # SIGSEGV on some systems
    6,    # SIGABRT on some systems
]


def is_vulnerability_triggered(result):
    """Check if the vulnerability was triggered (crash or ASAN detection)."""
    # Check for traditional crash exit codes
    if result.returncode in CRASH_EXIT_CODES:
        return True
    # Check for AddressSanitizer detection (ASAN returns exit code 1)
    if "AddressSanitizer" in result.stderr and "stack-buffer-overflow" in result.stderr:
        return True
    return False


class TestDoubleFormatSpecifier:
    """Test cases with two consecutive format specifiers."""

    def test_dd_basic(self):
        """Test basic %d%d pattern - the minimal trigger."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%d'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"


class TestMultipleFormatSpecifiers:
    """Test cases with multiple consecutive format specifiers."""

    def test_three_d_specifiers(self):
        """Test %d%d%d pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%d%d'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_four_d_specifiers(self):
        """Test %d%d%d%d pattern - more specifiers = larger offset error."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%d%d%d'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_many_d_specifiers(self):
        """Test many %d specifiers to maximize offset error."""
        pattern = '%d' * 10
        result = subprocess.run(
            ['magick', 'mogrify', pattern],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"


class TestMixedFormatSpecifiers:
    """Test cases with mixed format specifiers (%d, %o, %x)."""

    def test_d_o_mix(self):
        """Test %d%o mixed pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%o'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_d_x_mix(self):
        """Test %d%x mixed pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%x'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_o_x_mix(self):
        """Test %o%x mixed pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%o%x'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_all_three_specifiers(self):
        """Test %d%o%x all three specifier types."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%o%x'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_repeated_mixed_specifiers(self):
        """Test repeated mixed specifiers pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%o%x%d%o%x'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"


class TestOctalSpecifiers:
    """Test cases specifically with octal (%o) specifiers."""

    def test_double_o(self):
        """Test %o%o pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%o%o'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_triple_o(self):
        """Test %o%o%o pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%o%o%o'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"


class TestHexSpecifiers:
    """Test cases specifically with hex (%x) specifiers."""

    def test_double_x(self):
        """Test %x%x pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%x%x'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_triple_x(self):
        """Test %x%x%x pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%x%x%x'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"


class TestOtherImageMagickCommands:
    """Test the vulnerability through other ImageMagick commands."""

    def test_convert_output_pattern(self):
        """Test convert with vulnerable output pattern."""
        result = subprocess.run(
            ['magick', 'xc:white', '%d%d.png'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered in convert! Process crashed with code {result.returncode}"

    def test_montage_output_pattern(self):
        """Test montage with vulnerable output pattern."""
        result = subprocess.run(
            ['magick', 'montage', 'xc:white', '%d%d.png'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered in montage! Process crashed with code {result.returncode}"


class TestEdgeCases:
    """Edge case tests for the vulnerability."""

    def test_specifier_at_start(self):
        """Test specifiers at the start of pattern."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%d_file.png'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"

    def test_specifiers_separated_by_char(self):
        """Test specifiers separated by single character."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d_%d'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Process crashed with code {result.returncode}"

    def test_mixed_padding(self):
        """Test with mixed padded and unpadded specifiers."""
        result = subprocess.run(
            ['magick', 'mogrify', '%d%04d'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert not is_vulnerability_triggered(result), \
            f"Vulnerability triggered! Process crashed with code {result.returncode}"


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
