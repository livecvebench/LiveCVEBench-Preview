FROM debian:bookworm

WORKDIR /app

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies and required tools
RUN apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    automake \
    libtool \
    pkg-config \
    libjpeg-dev \
    libtiff-dev \
    zlib1g-dev \
    wget \
    curl \
    git \
    tmux \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install asciinema and pytest via pip
RUN pip3 install --break-system-packages asciinema pytest

# Download and extract DjVuLibre 3.5.28 (vulnerable version)
RUN wget -q "https://downloads.sourceforge.net/project/djvu/DjVuLibre/3.5.28/djvulibre-3.5.28.tar.gz" \
    && tar -xzf djvulibre-3.5.28.tar.gz \
    && rm djvulibre-3.5.28.tar.gz \
    && cp -a djvulibre-3.5.28/. . \
    && rm -rf djvulibre-3.5.28

# Build and install DjVuLibre
RUN ./configure --prefix=/usr && make -j$(nproc) && make install && ldconfig

# Create task-deps directory
RUN mkdir -p /app/task-deps


# Keep container running for testing
CMD ["tail", "-f", "/dev/null"]
