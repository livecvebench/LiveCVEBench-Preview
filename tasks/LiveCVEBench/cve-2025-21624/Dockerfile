FROM debian:stable-slim

WORKDIR /srv/http/clipbucket

# Environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV DOMAIN_NAME=localhost
ENV MYSQL_PASSWORD=clipbucket_password

# Install basic dependencies and add Sury PHP repository
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
    && curl -sSLo /tmp/debsuryorg-archive-keyring.deb https://packages.sury.org/debsuryorg-archive-keyring.deb \
    && dpkg -i /tmp/debsuryorg-archive-keyring.deb \
    && rm /tmp/debsuryorg-archive-keyring.deb \
    && echo "deb [signed-by=/usr/share/keyrings/deb.sury.org-php.gpg] https://packages.sury.org/php/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/php.list \
    && apt-get update \
    && rm -rf /var/lib/apt/lists/*

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    nginx-full \
    mariadb-server \
    php8.2-fpm \
    php8.2-curl \
    php8.2-mysqli \
    php8.2-xml \
    php8.2-mbstring \
    php8.2-gd \
    php8.2-fileinfo \
    php8.2-zip \
    php8.2-intl \
    ffmpeg \
    mediainfo \
    git \
    tmux \
    asciinema \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Copy custom PHP configuration
COPY task-deps/php-custom.ini /etc/php/8.2/fpm/conf.d/99-custom.ini

# Copy custom PHP-FPM pool configuration
COPY task-deps/www-custom.conf /etc/php/8.2/fpm/pool.d/zz-custom.conf
# Clone vulnerable ClipBucket version
RUN git clone https://github.com/MacWarrior/clipbucket-v5.git . && \
    git checkout 75d663f010cd8569eb9e278f030838174fb30188 && \
    rm -rf .git

# Create necessary directories
RUN mkdir -p /srv/http/clipbucket/upload/images/playlist_covers && \
    mkdir -p /srv/http/clipbucket/upload/files && \
    mkdir -p /srv/http/clipbucket/upload/cache && \
    mkdir -p /run/php && \
    mkdir -p /var/run/mysqld && \
    chown mysql:mysql /var/run/mysqld

# Copy nginx configuration
COPY task-deps/nginx.conf /etc/nginx/sites-available/default

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Set permissions
RUN chown -R www-data:www-data /srv/http/clipbucket && \
    chmod -R 777 /srv/http/clipbucket/upload/images && \
    chmod -R 777 /srv/http/clipbucket/upload/files && \
    chmod -R 777 /srv/http/clipbucket/upload/cache

# Initialize MariaDB data directory
RUN mysql_install_db --user=mysql --datadir=/var/lib/mysql

EXPOSE 80

# CMD ["/entrypoint.sh"]
