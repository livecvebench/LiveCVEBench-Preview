"""
Functional tests for DjVuLibre MMR decoder.

These tests verify that the DjVu tools work correctly with valid files
and are properly installed. Tests should pass in both vulnerable and fixed states.
"""

import subprocess
import os
import tempfile
import pytest


class TestDjVuToolsAvailable:
    """Test that DjVu tools are properly installed."""

    def test_ddjvu_available(self):
        """Test that ddjvu command is available."""
        result = subprocess.run(
            ['which', 'ddjvu'],
            capture_output=True,
            timeout=10
        )
        assert result.returncode == 0, "ddjvu command not found in PATH"

    def test_djvudump_available(self):
        """Test that djvudump command is available."""
        result = subprocess.run(
            ['which', 'djvudump'],
            capture_output=True,
            timeout=10
        )
        assert result.returncode == 0, "djvudump command not found in PATH"

    def test_ddjvu_help(self):
        """Test that ddjvu responds to --help."""
        result = subprocess.run(
            ['ddjvu', '--help'],
            capture_output=True,
            timeout=10
        )
        # ddjvu may return non-zero on --help but should produce output
        output = result.stdout.decode('utf-8', errors='replace') + \
                 result.stderr.decode('utf-8', errors='replace')
        assert 'ddjvu' in output.lower() or 'djvu' in output.lower() or \
               'usage' in output.lower(), \
               f"ddjvu --help should produce help output, got: {output[:500]}"


class TestMMRDecoderBasicFunctionality:
    """Test basic MMR decoder functionality with valid inputs."""

    def test_decoder_handles_empty_output(self):
        """Test decoder can write to /dev/null without issues for valid operations."""
        # This tests that the decoder infrastructure works
        # Even with the PoC file, it should either succeed or fail gracefully
        poc_file = '/tests/fuzzer-poc.djvu'

        if not os.path.exists(poc_file):
            pytest.skip(f"PoC file not found at {poc_file}")

        # Just ensure the command can be executed (doesn't hang indefinitely)
        result = subprocess.run(
            ['ddjvu', poc_file, '/dev/null'],
            capture_output=True,
            timeout=30
        )
        # We don't assert success here - the malformed file may fail
        # This test just verifies the decoder runs and terminates
        assert True, "Decoder executed without hanging"

    def test_djvudump_can_process_file(self):
        """Test that djvudump can inspect file structure."""
        poc_file = '/tests/fuzzer-poc.djvu'

        if not os.path.exists(poc_file):
            pytest.skip(f"PoC file not found at {poc_file}")

        result = subprocess.run(
            ['djvudump', poc_file],
            capture_output=True,
            timeout=30
        )
        # djvudump should produce some output about the file structure
        # even if the file content is malformed
        output = result.stdout.decode('utf-8', errors='replace') + \
                 result.stderr.decode('utf-8', errors='replace')
        # The command should complete without hanging
        assert True, "djvudump executed without hanging"


class TestDecoderRobustness:
    """Test decoder robustness with edge cases."""

    def test_nonexistent_file_handled(self):
        """Test that decoder properly handles nonexistent input file."""
        result = subprocess.run(
            ['ddjvu', '/nonexistent/file.djvu', '/dev/null'],
            capture_output=True,
            timeout=10
        )
        assert result.returncode != 0, "Should fail for nonexistent file"

    def test_decoder_timeout_behavior(self):
        """Test that decoder doesn't hang indefinitely on any input."""
        poc_file = '/tests/fuzzer-poc.djvu'

        if not os.path.exists(poc_file):
            pytest.skip(f"PoC file not found at {poc_file}")

        try:
            result = subprocess.run(
                ['ddjvu', '-format=ppm', poc_file, '/dev/null'],
                capture_output=True,
                timeout=60  # Allow generous timeout
            )
            # Command completed within timeout - this is good
            assert True
        except subprocess.TimeoutExpired:
            pytest.fail("Decoder hung for more than 60 seconds")
