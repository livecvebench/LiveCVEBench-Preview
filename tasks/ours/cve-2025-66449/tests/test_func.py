"""
Functional tests for ConvertX file upload functionality.
These tests verify that the upload feature works correctly with normal filenames.
Should PASS in both vulnerable and fixed states.
"""
import os
import re
import time
import requests
import subprocess

BASE_URL = "http://localhost:3000"
TEST_EMAIL = f"testuser_{int(time.time())}@example.com"
TEST_PASSWORD = "TestPassword123!"


class ConvertXClient:
    """Helper class to interact with ConvertX API."""

    def __init__(self, base_url=BASE_URL):
        self.base_url = base_url
        self.session = requests.Session()
        self.user_id = None
        self.job_id = None

    def register(self, email, password):
        """Register a new user."""
        response = self.session.post(
            f"{self.base_url}/register",
            data={"email": email, "password": password},
            allow_redirects=False
        )
        return response

    def login(self, email, password):
        """Login and get session cookies."""
        response = self.session.post(
            f"{self.base_url}/login",
            data={"email": email, "password": password},
            allow_redirects=False
        )
        return response

    def create_job(self):
        """Create a new conversion job by visiting the root page with POST."""
        # First visit the root page to initialize
        response = self.session.get(f"{self.base_url}/")

        # Create a job by posting to the root with converter selection
        response = self.session.post(
            f"{self.base_url}/",
            data={
                "converter": "imagemagick",
                "outputFormat": "png"
            },
            allow_redirects=False
        )

        # Check if we got a jobId cookie
        if "jobId" in self.session.cookies:
            self.job_id = self.session.cookies.get("jobId")

        return response

    def upload_file(self, filename, content):
        """Upload a file with the given filename and content."""
        files = {
            "file": (filename, content, "application/octet-stream")
        }
        response = self.session.post(
            f"{self.base_url}/upload",
            files=files,
            allow_redirects=False
        )
        return response

    def get_user_id_from_jwt(self):
        """Extract user_id from JWT token in cookies if possible."""
        # The user_id is typically embedded in the application state
        # For testing purposes we'll check file system
        return None


def get_authenticated_client():
    """Create and authenticate a ConvertX client."""
    client = ConvertXClient()

    # Register a new user
    email = f"func_test_{int(time.time() * 1000)}@example.com"
    password = "TestPassword123!"

    client.register(email, password)
    client.login(email, password)
    client.create_job()

    return client


class TestNormalUpload:
    """Test normal file upload functionality."""

    def test_upload_simple_filename(self):
        """Test uploading a file with a simple, valid filename."""
        client = get_authenticated_client()

        filename = "test_file.txt"
        content = b"Hello, ConvertX! This is a test file."

        response = client.upload_file(filename, content)

        # Should return success (200 or redirect to results)
        assert response.status_code in [200, 302], f"Upload failed with status {response.status_code}"

        # If 200, check for success message
        if response.status_code == 200:
            assert "success" in response.text.lower() or "uploaded" in response.text.lower(), \
                f"Expected success message in response: {response.text[:200]}"

    def test_upload_filename_with_spaces(self):
        """Test uploading a file with spaces in the filename."""
        client = get_authenticated_client()

        filename = "test file with spaces.txt"
        content = b"File content with spaces in filename."

        response = client.upload_file(filename, content)

        assert response.status_code in [200, 302], f"Upload failed with status {response.status_code}"

    def test_upload_filename_with_special_chars(self):
        """Test uploading a file with allowed special characters."""
        client = get_authenticated_client()

        # These characters should be allowed after sanitization
        filename = "test-file_123.txt"
        content = b"File with dashes and underscores."

        response = client.upload_file(filename, content)

        assert response.status_code in [200, 302], f"Upload failed with status {response.status_code}"

    def test_upload_multiple_files(self):
        """Test uploading multiple files at once."""
        client = get_authenticated_client()

        files = [
            ("file", ("file1.txt", b"Content 1", "application/octet-stream")),
            ("file", ("file2.txt", b"Content 2", "application/octet-stream")),
        ]

        response = client.session.post(
            f"{BASE_URL}/upload",
            files=files,
            allow_redirects=False
        )

        assert response.status_code in [200, 302], f"Multiple upload failed with status {response.status_code}"

    def test_upload_binary_file(self):
        """Test uploading a binary file."""
        client = get_authenticated_client()

        filename = "binary_data.bin"
        content = bytes(range(256))  # All byte values 0-255

        response = client.upload_file(filename, content)

        assert response.status_code in [200, 302], f"Binary upload failed with status {response.status_code}"


class TestAuthenticationRequired:
    """Test that authentication is properly required for uploads."""

    def test_upload_without_auth_rejected(self):
        """Test that upload without authentication is rejected."""
        # Create a fresh session without login
        session = requests.Session()

        files = {
            "file": ("test.txt", b"test content", "application/octet-stream")
        }

        response = session.post(
            f"{BASE_URL}/upload",
            files=files,
            allow_redirects=False
        )

        # Should redirect to login/home or return unauthorized
        # 422 is also acceptable - Elysia validation fails without proper auth
        assert response.status_code in [302, 401, 403, 422], \
            f"Expected redirect or unauthorized, got {response.status_code}"

    def test_upload_without_job_id_rejected(self):
        """Test that upload without a valid job ID is rejected."""
        client = ConvertXClient()

        # Register and login but don't create a job
        email = f"nojob_test_{int(time.time() * 1000)}@example.com"
        password = "TestPassword123!"

        client.register(email, password)
        client.login(email, password)

        # Try to upload without creating a job first
        files = {
            "file": ("test.txt", b"test content", "application/octet-stream")
        }

        response = client.session.post(
            f"{BASE_URL}/upload",
            files=files,
            allow_redirects=False
        )

        # Should redirect because no jobId
        assert response.status_code in [302, 400, 401, 403], \
            f"Expected redirect/error without job ID, got {response.status_code}"


class TestFilenameHandling:
    """Test that various filename formats are handled properly."""

    def test_upload_empty_filename_handled(self):
        """Test that empty filename is handled gracefully."""
        client = get_authenticated_client()

        # Empty filename should be handled without crashing
        response = client.upload_file("", b"content")

        # Should not crash - either success with generated name or error
        # Note: 500 is acceptable as empty filenames can cause write errors
        assert response.status_code in [200, 302, 400, 500], \
            f"Unexpected status {response.status_code} for empty filename"

    def test_upload_unicode_filename(self):
        """Test uploading a file with unicode characters in filename."""
        client = get_authenticated_client()

        filename = "文件测试_日本語_тест.txt"
        content = b"Unicode filename test content."

        response = client.upload_file(filename, content)

        # Should handle unicode gracefully
        assert response.status_code in [200, 302, 400], \
            f"Unexpected status {response.status_code} for unicode filename"

    def test_upload_very_long_filename(self):
        """Test uploading a file with a very long filename."""
        client = get_authenticated_client()

        # Create a filename that's 300 characters long
        filename = "a" * 280 + ".txt"
        content = b"Long filename test."

        response = client.upload_file(filename, content)

        # Should handle gracefully - either accept, truncate, or reject
        # 500 is acceptable - application may error on very long filenames
        assert response.status_code in [200, 302, 400, 413, 500], \
            f"Unexpected status {response.status_code} for long filename"
