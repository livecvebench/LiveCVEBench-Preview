#!/bin/bash
# Solution script to fix the reflected XSS vulnerability in Custom Admin Menu plugin
# The vulnerability is in adminmenu.php where the msg parameter is output without escaping

set -e

PLUGIN_FILE="/var/www/html/wp-content/plugins/custom-admin-menu/adminmenu.php"

echo "Applying fix to Custom Admin Menu plugin..."

# Check if the file exists
if [ ! -f "$PLUGIN_FILE" ]; then
    echo "Error: Plugin file not found at $PLUGIN_FILE"
    exit 1
fi

# Check if already fixed (idempotent)
if grep -q "esc_html( str_replace( '+', ' ', \$_REQUEST\['msg'\] ) )" "$PLUGIN_FILE" 2>/dev/null; then
    echo "Fix already applied - skipping"
    exit 0
fi

# The vulnerable line is:
# <p><strong><?php echo str_replace( '+', ' ', $_REQUEST['msg'] ); ?></strong></p>
#
# We need to wrap it with esc_html():
# <p><strong><?php echo esc_html( str_replace( '+', ' ', $_REQUEST['msg'] ) ); ?></strong></p>

# Use sed to apply the fix
# Escape special characters properly for sed
sed -i "s/echo str_replace( '+', ' ', \$_REQUEST\['msg'\] );/echo esc_html( str_replace( '+', ' ', \$_REQUEST['msg'] ) );/g" "$PLUGIN_FILE"

# Verify the fix was applied
if grep -q "esc_html( str_replace( '+', ' ', \$_REQUEST\['msg'\] ) )" "$PLUGIN_FILE"; then
    echo "Fix applied successfully!"
else
    echo "Warning: Fix may not have been applied correctly, attempting alternative method..."

    # Alternative approach using Python for more reliable replacement
    python3 - <<'PYEOF'
import re

file_path = "/var/www/html/wp-content/plugins/custom-admin-menu/adminmenu.php"

with open(file_path, 'r') as f:
    content = f.read()

# Pattern to find the vulnerable line
old_pattern = r"echo str_replace\( '\+', ' ', \$_REQUEST\['msg'\] \);"
new_code = "echo esc_html( str_replace( '+', ' ', $_REQUEST['msg'] ) );"

# Replace
new_content = re.sub(old_pattern, new_code, content)

with open(file_path, 'w') as f:
    f.write(new_content)

print("Fix applied using Python fallback")
PYEOF
fi

echo "Fix complete. The msg parameter output is now HTML-escaped using esc_html()."
