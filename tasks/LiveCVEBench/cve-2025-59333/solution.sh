#!/bin/bash
set -e

# Path to the vulnerable file
FILE="/app/src/tools/queryTools.ts"

echo "Applying fix to queryTools.ts..."

# Create the fixed version using a heredoc
cat > "$FILE" << 'EOF'
import { dbAll, dbRun, dbExec } from '../db/index.js';
import { formatErrorResponse, formatSuccessResponse, convertToCSV } from '../utils/formatUtils.js';

/**
 * List of dangerous PostgreSQL functions that should not be allowed in read queries.
 * These functions can cause denial of service, terminate processes, or have other
 * dangerous side effects.
 */
const DANGEROUS_FUNCTIONS = [
  'pg_terminate_backend',
  'pg_cancel_backend',
  'pg_sleep',
  'pg_reload_conf',
  'pg_rotate_logfile'
];

/**
 * Execute a read-only SQL query
 * @param query SQL query to execute
 * @returns Query results
 */
export async function readQuery(query: string) {
  try {
    const trimmedQuery = query.trim().toLowerCase();

    // Block multiple statements (prevent query chaining attacks)
    if (trimmedQuery.includes(';')) {
      throw new Error("Multiple SQL statements are not allowed");
    }

    // Block dangerous PostgreSQL functions
    for (const func of DANGEROUS_FUNCTIONS) {
      if (trimmedQuery.includes(func.toLowerCase())) {
        throw new Error(`Function ${func} is not allowed in read_query`);
      }
    }

    if (!trimmedQuery.startsWith("select")) {
      throw new Error("Only SELECT queries are allowed with read_query");
    }

    const result = await dbAll(query);
    return formatSuccessResponse(result);
  } catch (error: any) {
    throw new Error(`SQL Error: ${error.message}`);
  }
}

/**
 * Execute a data modification SQL query
 * @param query SQL query to execute
 * @returns Information about affected rows
 */
export async function writeQuery(query: string) {
  try {
    const lowerQuery = query.trim().toLowerCase();

    if (lowerQuery.startsWith("select")) {
      throw new Error("Use read_query for SELECT operations");
    }

    if (!(lowerQuery.startsWith("insert") || lowerQuery.startsWith("update") || lowerQuery.startsWith("delete"))) {
      throw new Error("Only INSERT, UPDATE, or DELETE operations are allowed with write_query");
    }

    const result = await dbRun(query);
    return formatSuccessResponse({ affected_rows: result.changes });
  } catch (error: any) {
    throw new Error(`SQL Error: ${error.message}`);
  }
}

/**
 * Export query results to CSV or JSON format
 * @param query SQL query to execute
 * @param format Output format (csv or json)
 * @returns Formatted query results
 */
export async function exportQuery(query: string, format: string) {
  try {
    if (!query.trim().toLowerCase().startsWith("select")) {
      throw new Error("Only SELECT queries are allowed with export_query");
    }

    const result = await dbAll(query);

    if (format === "csv") {
      const csvData = convertToCSV(result);
      return {
        content: [{
          type: "text",
          text: csvData
        }],
        isError: false,
      };
    } else if (format === "json") {
      return formatSuccessResponse(result);
    } else {
      throw new Error("Unsupported export format. Use 'csv' or 'json'");
    }
  } catch (error: any) {
    throw new Error(`Export Error: ${error.message}`);
  }
}
EOF

echo "Fix applied to queryTools.ts"

# Rebuild the TypeScript project
cd /app
echo "Rebuilding TypeScript project..."
npm run build

echo "Fix complete!"
