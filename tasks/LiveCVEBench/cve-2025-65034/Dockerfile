FROM node:20

WORKDIR /app

# System dependencies including Python for tests
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    openssl \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install Python test dependencies
RUN pip3 install --break-system-packages pytest requests psycopg2-binary

# Enable pnpm
RUN corepack enable && corepack prepare pnpm@10.9.0 --activate

# Clone the vulnerable version (keep .git for build scripts)
RUN git clone --branch v4.5.3 --depth 1 https://github.com/lukevella/rallly.git .

# Install dependencies
RUN pnpm install --frozen-lockfile

# Generate Prisma client
RUN pnpm db:generate

# Build environment variables
ENV SKIP_ENV_VALIDATION=1
ENV SELF_HOSTED=true
ENV NEXT_PUBLIC_SELF_HOSTED=true
ENV NEXT_PUBLIC_APP_VERSION=4.5.3
ENV NEXT_TELEMETRY_DISABLED=1

# Disable Sentry (these ensure it won't try to upload source maps)
ENV SENTRY_SUPPRESS_TURBOPACK_WARNING=1
ENV SENTRY_IGNORE_ERROR=true
ENV SENTRY_DSN=""

# Build the web application using direct turbo command (bypass inject-version.js git dependency)
RUN NEXT_PUBLIC_APP_VERSION=4.5.3 NEXT_PUBLIC_SELF_HOSTED=true pnpm turbo run build --filter=@rallly/web --env-mode=loose

# Now remove .git directory to prevent solution leakage
RUN rm -rf .git

# Install prisma globally for runtime migrations
RUN npm install -g prisma@6

# Copy startup script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Application port
EXPOSE 3000

# Entrypoint that supports restart
# CMD ["/entrypoint.sh"]
