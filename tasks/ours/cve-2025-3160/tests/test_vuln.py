"""
Vulnerability tests for CVE-2025-3160.
Tests for null pointer dereference in AddNodeHashes function.

These tests should:
- FAIL in vulnerable state (crash or ASAN error)
- PASS in fixed state (handles invalid input gracefully)
"""
import subprocess
import os
import tempfile
import pytest
import signal


ASSIMP_BIN = "/app/bin/assimp"
# PoC files are now in /app/test_files (copied from task-deps in Dockerfile)
POC_FILE = "/app/test_files/poc_crash.lws"
POC_SIMPLE = "/app/test_files/poc_simple.lws"
TIMEOUT = 60


def run_assimp_test(input_file):
    """
    Run assimp on the input file and return results.
    Returns (return_code, stdout, stderr, crashed)
    """
    try:
        result = subprocess.run(
            [ASSIMP_BIN, "info", input_file],
            capture_output=True,
            timeout=TIMEOUT
        )
        stdout = result.stdout.decode('utf-8', errors='ignore')
        stderr = result.stderr.decode('utf-8', errors='ignore')

        # Check for crash indicators
        crashed = (
            result.returncode < 0 or  # Negative return = signal (crash)
            result.returncode == 139 or  # SIGSEGV
            result.returncode == 134 or  # SIGABRT
            "SEGV" in stderr or
            "AddressSanitizer" in stderr or
            "ASAN" in stderr or
            "null pointer" in stderr.lower() or
            "segmentation fault" in stderr.lower() or
            "stack-buffer-overflow" in stderr or
            "heap-buffer-overflow" in stderr or
            "ai_assert failure" in stderr  # Assertion failures count as crashes
        )

        return (result.returncode, stdout, stderr, crashed)
    except subprocess.TimeoutExpired:
        return (-1, "", "Timeout", False)


class TestLWSVulnerability:
    """
    Test for vulnerabilities when processing malformed LWS files.

    In vulnerable version (v5.4.3), malformed LWS files can trigger:
    - Null pointer dereference in AddNodeHashes
    - Assertion failures in input validation
    - Memory safety issues

    These tests verify that malformed input causes crashes in the vulnerable version.
    After the fix, these should pass (handle errors gracefully).
    """

    def test_poc_simple_lws(self):
        """
        Test simple malformed LWS with incomplete LoadObject.

        This triggers an assertion failure in vulnerable versions because
        the LoadObject command has no path, causing invalid scene construction.
        """
        assert os.path.exists(POC_SIMPLE), f"PoC file not found at {POC_SIMPLE}"

        returncode, stdout, stderr, crashed = run_assimp_test(POC_SIMPLE)

        # After fix, should NOT crash
        assert not crashed, (
            f"Application crashed processing malformed LWS.\n"
            f"Return code: {returncode}\n"
            f"Stderr: {stderr[:1000]}"
        )

    def test_poc_crash_lws(self):
        """
        Test complex malformed LWS file designed to trigger crash.

        This file contains binary garbage and malformed commands.
        """
        assert os.path.exists(POC_FILE), f"PoC file not found at {POC_FILE}"

        returncode, stdout, stderr, crashed = run_assimp_test(POC_FILE)

        # After fix, should NOT crash
        assert not crashed, (
            f"Application crashed processing malformed LWS.\n"
            f"Return code: {returncode}\n"
            f"Stderr: {stderr[:1000]}"
        )

    def test_lws_truncated_loadobject(self):
        """
        Test LWS file truncated after LoadObject command.

        This should cause the parser to fail gracefully, not crash.
        """
        with tempfile.NamedTemporaryFile(mode='w', suffix='.lws', delete=False) as f:
            f.write("LWSC\n")
            f.write("5\n")
            f.write("\n")
            f.write("FirstFrame 0\n")
            f.write("LastFrame 60\n")
            f.write("FrameStep 1\n")
            f.write("\n")
            f.write("LoadObject\n")  # Truncated - no object path
            poc_path = f.name

        try:
            returncode, stdout, stderr, crashed = run_assimp_test(poc_path)
            assert not crashed, f"Crashed with truncated file: {stderr[:500]}"
        finally:
            os.unlink(poc_path)

    def test_lws_with_garbage_loadobject(self):
        """
        Test LWS with garbage data after LoadObject command.

        Binary garbage should not cause crashes.
        """
        with tempfile.NamedTemporaryFile(mode='wb', suffix='.lws', delete=False) as f:
            f.write(b"LWSC\n5\n\n")
            f.write(b"FirstFrame 0\nLastFrame 60\nFrameStep 1\n\n")
            f.write(b"LoadObject ")
            # Write garbage that might cause parsing issues
            f.write(bytes([i % 256 for i in range(1000)]))
            f.write(b"\nAddNullObject ")
            f.write(bytes([i % 256 for i in range(500)]))
            poc_path = f.name

        try:
            returncode, stdout, stderr, crashed = run_assimp_test(poc_path)
            assert not crashed, f"Crashed with garbage data: {stderr[:500]}"
        finally:
            os.unlink(poc_path)


if __name__ == "__main__":
    pytest.main([__file__, "-v"])