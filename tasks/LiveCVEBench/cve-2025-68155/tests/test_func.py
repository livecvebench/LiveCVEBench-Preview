"""
Functionality tests for Vite RSC application.
These tests verify that the application works correctly in both vulnerable and fixed states.
"""

import requests
import time
import os

BASE_URL = os.environ.get("TARGET_URL", "http://localhost:5173")
TIMEOUT = 15


class TestApplicationFunctionality:
    """Tests that verify the application works correctly."""

    def test_application_responds(self):
        """Verify the Vite dev server is responding."""
        response = requests.get(BASE_URL, timeout=TIMEOUT)
        assert response.status_code == 200, "Application should be accessible"
        content_type = response.headers.get("content-type", "")
        assert "text/html" in content_type, "Should return HTML content"

    def test_application_returns_html(self):
        """Verify the application returns valid HTML content."""
        response = requests.get(BASE_URL, timeout=TIMEOUT)
        assert response.status_code == 200
        # Check for typical Vite/React app markers
        html = response.text
        assert "<html" in html.lower() or "<!doctype" in html.lower(), "Should contain HTML structure"

    def test_vite_client_script_present(self):
        """Verify Vite client-side scripts are present."""
        response = requests.get(BASE_URL, timeout=TIMEOUT)
        assert response.status_code == 200
        # Vite injects its client script in dev mode
        html = response.text
        assert "vite" in html.lower() or "@vite" in html or "modulepreload" in html.lower(), \
            "Should include Vite-related scripts or assets"


class TestSourceMapEndpoint:
    """Tests for the source map endpoint functionality."""

    def test_endpoint_exists(self):
        """Verify the source map endpoint exists and responds."""
        response = requests.get(
            f"{BASE_URL}/__vite_rsc_findSourceMapURL",
            params={"filename": "nonexistent", "environmentName": "Server"},
            timeout=TIMEOUT
        )
        # Should return 404 for non-existent files, not 500 or connection error
        assert response.status_code in [200, 404], \
            f"Endpoint should exist and respond (got {response.status_code})"

    def test_endpoint_returns_json(self):
        """Verify the endpoint returns JSON content."""
        response = requests.get(
            f"{BASE_URL}/__vite_rsc_findSourceMapURL",
            params={"filename": "test", "environmentName": "Server"},
            timeout=TIMEOUT
        )
        content_type = response.headers.get("content-type", "")
        assert "application/json" in content_type, "Should return JSON content type"
        # Should be valid JSON
        try:
            response.json()
        except Exception as e:
            assert False, f"Response should be valid JSON: {e}"

    def test_client_environment_request(self):
        """Verify the endpoint handles Client environment requests."""
        response = requests.get(
            f"{BASE_URL}/__vite_rsc_findSourceMapURL",
            params={
                "filename": f"{BASE_URL}/src/root.tsx",
                "environmentName": "Client"
            },
            timeout=TIMEOUT
        )
        # Should respond without error (200 or 404)
        assert response.status_code in [200, 404], \
            f"Should handle Client environment requests (got {response.status_code})"

    def test_server_environment_request(self):
        """Verify the endpoint handles Server environment requests."""
        response = requests.get(
            f"{BASE_URL}/__vite_rsc_findSourceMapURL",
            params={
                "filename": f"{BASE_URL}/src/root.tsx",
                "environmentName": "Server"
            },
            timeout=TIMEOUT
        )
        # Should respond without error (200 or 404)
        assert response.status_code in [200, 404], \
            f"Should handle Server environment requests (got {response.status_code})"


class TestStaticAssets:
    """Tests for static asset serving."""

    def test_vite_svg_accessible(self):
        """Verify static assets are accessible."""
        response = requests.get(f"{BASE_URL}/vite.svg", timeout=TIMEOUT)
        # May or may not exist depending on setup, but shouldn't error
        assert response.status_code in [200, 404], "Static asset request should not error"
