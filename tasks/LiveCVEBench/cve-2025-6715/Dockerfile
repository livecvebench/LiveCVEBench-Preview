FROM wordpress:6.4-php8.1-apache

WORKDIR /var/www/html
# Install required system packages including WP-CLI
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    subversion \
    default-mysql-client \
    less \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install WP-CLI
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
    && chmod +x wp-cli.phar \
    && mv wp-cli.phar /usr/local/bin/wp

# Download LatePoint plugin version 5.1.93 (vulnerable version) to staging area
# Will be moved to wp-content/plugins by entrypoint script after WordPress files are ready
RUN mkdir -p /usr/src/latepoint-plugin \
    && curl -L -o /tmp/latepoint.zip "https://downloads.wordpress.org/plugin/latepoint.5.1.93.zip" \
    && unzip /tmp/latepoint.zip -d /usr/src/latepoint-plugin/ \
    && rm /tmp/latepoint.zip

# Copy setup script that runs after WordPress is initialized
COPY task-deps/setup-wordpress.sh /usr/local/bin/setup-wordpress.sh
RUN chmod +x /usr/local/bin/setup-wordpress.sh

# Environment variables for WordPress
ENV WORDPRESS_DB_HOST=db
ENV WORDPRESS_DB_USER=wordpress
ENV WORDPRESS_DB_PASSWORD=wordpress
ENV WORDPRESS_DB_NAME=wordpress

# Enable Apache mod_rewrite for permalinks
RUN a2enmod rewrite

# The default WordPress entrypoint will handle initial setup
# Our setup script runs as a background process after Apache starts
# CMD ["sh", "-c", "/usr/local/bin/setup-wordpress.sh & docker-entrypoint.sh apache2-foreground"]
