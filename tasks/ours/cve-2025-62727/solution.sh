#!/bin/bash
# solution.sh - Fix for Range header parsing performance issue
# Replaces O(n^2) regex-based parsing with O(n) string-based parsing
set -e

RESPONSES_FILE="/app/starlette/responses.py"

echo "Applying fix to $RESPONSES_FILE..."

# Apply the fix using Python for precise text manipulation
python3 << 'PYEOF'
import sys

responses_file = "/app/starlette/responses.py"

with open(responses_file, 'r') as f:
    content = f.read()

# 1. Remove 'import re' line
# Match the line that imports re (could be standalone or with other imports)
import re as regex_module
content = regex_module.sub(r'^import re\n', '', content, flags=regex_module.MULTILINE)

# 2. Remove _RANGE_PATTERN definition
# This line appears after the exception classes and before FileResponse
content = regex_module.sub(
    r'\n_RANGE_PATTERN = re\.compile\(r"\(\\d\*\)-\(\\d\*\)"\)\n\n',
    '\n',
    content
)

# 3. Change @staticmethod to @classmethod for _parse_range_header
content = content.replace(
    '@staticmethod\n    def _parse_range_header(http_range: str, file_size: int)',
    '@classmethod\n    def _parse_range_header(cls, http_range: str, file_size: int)'
)

# 4. Replace the vulnerable regex-based list comprehension with method call
old_ranges_code = '''        ranges = [
            (
                int(_[0]) if _[0] else file_size - int(_[1]),
                int(_[1]) + 1 if _[0] and _[1] and int(_[1]) < file_size else file_size,
            )
            for _ in _RANGE_PATTERN.findall(range_)
            if _ != ("", "")
        ]'''

new_ranges_code = '''        ranges = cls._parse_ranges(range_, file_size)'''

if old_ranges_code in content:
    content = content.replace(old_ranges_code, new_ranges_code)
else:
    print("WARNING: Could not find the vulnerable list comprehension code")
    print("The code may already be patched or has a different format")

# 5. Add the new _parse_ranges classmethod before generate_multipart
new_method = '''
    @classmethod
    def _parse_ranges(cls, range_: str, file_size: int) -> list[tuple[int, int]]:
        ranges: list[tuple[int, int]] = []

        for part in range_.split(","):
            part = part.strip()

            # If the range is empty or a single dash, we ignore it.
            if not part or part == "-":
                continue

            # If the range is not in the format "start-end", we ignore it.
            if "-" not in part:
                continue

            start_str, end_str = part.split("-", 1)
            start_str = start_str.strip()
            end_str = end_str.strip()

            try:
                start = int(start_str) if start_str else file_size - int(end_str)
                end = int(end_str) + 1 if start_str and end_str and int(end_str) < file_size else file_size
                ranges.append((start, end))
            except ValueError:
                # If the range is not numeric, we ignore it.
                continue

        return ranges

'''

# Check if _parse_ranges METHOD DEFINITION already exists (not just the call)
if 'def _parse_ranges(' not in content:
    # Insert before generate_multipart method
    if '    def generate_multipart(' in content:
        content = content.replace(
            '    def generate_multipart(',
            new_method + '    def generate_multipart('
        )
    else:
        print("WARNING: Could not find generate_multipart method to insert before")
else:
    print("NOTE: _parse_ranges method already exists")

# Write the patched content
with open(responses_file, 'w') as f:
    f.write(content)

print("Fix applied successfully!")

# Verify the fix
with open(responses_file, 'r') as f:
    patched = f.read()

if '_parse_ranges' in patched and '_RANGE_PATTERN' not in patched:
    print("Verification: Fix applied correctly")
    print("  - _RANGE_PATTERN removed: YES")
    print("  - _parse_ranges added: YES")
else:
    print("WARNING: Fix may not have been applied correctly")
    if '_RANGE_PATTERN' in patched:
        print("  - _RANGE_PATTERN still present")
    if '_parse_ranges' not in patched:
        print("  - _parse_ranges not found")
    sys.exit(1)

PYEOF

echo ""
echo "Fix complete."
