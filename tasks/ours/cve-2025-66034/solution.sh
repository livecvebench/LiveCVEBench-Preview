#!/bin/bash
set -e

echo "Applying fix for fonttools varLib path traversal issue..."

# Find the fontTools varLib module path
python3 << 'PYTHON_SCRIPT'
import fontTools.varLib
import os

# Get the path to the __init__.py file
varlib_path = os.path.join(os.path.dirname(fontTools.varLib.__file__), "__init__.py")
print(f"Found varLib at: {varlib_path}")

# Read the file
with open(varlib_path, 'r') as f:
    content = f.read()

# The vulnerable code pattern (single line)
old_code = '            filename = vf.filename if vf.filename is not None else vf.name + ".{ext}"'

# The fixed code pattern (multi-line with basename sanitization)
new_code = '''            if vf.filename is not None:
                # Only use basename to prevent path traversal attacks
                filename = os.path.basename(vf.filename)
            else:
                filename = vf.name + ".{ext}"'''

# Check if already fixed
if old_code not in content:
    if "os.path.basename(vf.filename)" in content:
        print("Fix already applied - skipping")
    else:
        print("WARNING: Could not find vulnerable code pattern. File may have different version.")
        exit(1)
else:
    # Apply the fix
    content = content.replace(old_code, new_code)

    # Write back
    with open(varlib_path, 'w') as f:
        f.write(content)

    print(f"Fix applied successfully to {varlib_path}")

# Verify the fix
with open(varlib_path, 'r') as f:
    verify_content = f.read()

if "os.path.basename(vf.filename)" in verify_content:
    print("Verification: Fix confirmed present in file")
else:
    print("ERROR: Fix verification failed")
    exit(1)
PYTHON_SCRIPT

echo "Fix completed successfully"
