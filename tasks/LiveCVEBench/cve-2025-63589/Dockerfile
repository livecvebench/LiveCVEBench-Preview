FROM php:8.2-cli

WORKDIR /app

# Install system dependencies (tmux, asciinema, curl are required)
RUN apt-get update && \
    apt-get install -y git unzip tmux asciinema curl procps && \
    rm -rf /var/lib/apt/lists/*

# Note: json is bundled in PHP 8.x, session is built-in (files handler)
# mbstring may need to be installed
RUN docker-php-ext-install mbstring || true

# Copy and extract the source code from task-deps
COPY task-deps/cmsimple-xh-1.8.0.zip /tmp/
RUN unzip /tmp/cmsimple-xh-1.8.0.zip -d /tmp && \
    mv /tmp/cmsimple-xh-1.8.0/* /app/ && \
    rm -rf /tmp/cmsimple-xh-1.8.0.zip /tmp/cmsimple-xh-1.8.0

# Ensure content directories are writable
RUN chmod -R 777 /app/content/ /app/userfiles/ 2>/dev/null || \
    chmod -R 777 /app/content/ 2>/dev/null || true

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose port (for documentation, not required for internal testing)
EXPOSE 8080

# Use entrypoint script that supports service restart
# CMD ["/entrypoint.sh"]
