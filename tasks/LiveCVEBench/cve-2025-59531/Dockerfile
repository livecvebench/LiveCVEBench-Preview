FROM golang:1.24.6-alpine

# Ensure Go is in PATH for all processes (including subprocesses in tests)
ENV PATH="/usr/local/go/bin:/go/bin:${PATH}"

WORKDIR /app

# System dependencies (tmux, asciinema, curl, gcc, g++ are required)
RUN apk add --no-cache git make bash tmux asciinema curl wget gcc g++ python3 py3-pip coreutils && \
    pip3 install --break-system-packages --no-cache-dir pytest && \
    ln -sf /usr/local/go/bin/go /usr/local/bin/go && \
    ln -sf /usr/local/go/bin/gofmt /usr/local/bin/gofmt

# Pre-compile pytest to avoid import delays
RUN python3 -c "import pytest; print('pytest ready')"

# Get source code at vulnerable version and remove git history
RUN git clone --depth 1 --branch v2.14.19 https://github.com/argoproj/argo-cd.git . && \
    rm -rf .git

# Download Go dependencies
RUN go mod download

# The vulnerable webhook.go should already be at v2.14.19
# Verify the vulnerable pattern exists (unsafe type assertion)
RUN grep -q 'Links\["clone"\]\.(.*interface.*' util/webhook/webhook.go || \
    (echo "Vulnerable pattern not found in webhook.go" && exit 1)

# Expose webhook port for testing
EXPOSE 8080