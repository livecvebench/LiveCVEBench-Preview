FROM php:7.4-apache

WORKDIR /var/www/html

# Install system dependencies
RUN apt-get update && apt-get install -y \
    unzip \
    default-mysql-client \
    tmux \
    asciinema \
    curl \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    gcc g++ wget git \
    && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install pdo pdo_mysql
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install gd

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Copy application archive and extract
# Using || true because unzip may return exit code 1 due to Chinese character encoding warnings
COPY task-deps/xqyeyzxglxt_v2.0.zip /tmp/
RUN unzip /tmp/xqyeyzxglxt_v2.0.zip -d /var/www/html/ || true && rm /tmp/xqyeyzxglxt_v2.0.zip

# Copy docker-specific database configuration
COPY task-deps/database-docker.php /var/www/html/include/database.php

# Replace obfuscated function.php with simplified version for CVE reproduction
# Original function.php has licensing checks that prevent execution
COPY task-deps/function-simple.php /var/www/html/include/function.php

# Create install lock file to skip installation
RUN touch /var/www/html/install/install_lock.txt

# Create session directory
RUN mkdir -p /var/lib/php/sessions && chmod 777 /var/lib/php/sessions

# Set file permissions for web server
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html \
    && chmod -R 777 /var/www/html/kindeditor/attached 2>/dev/null || true \
    && chmod -R 777 /var/www/html/Data 2>/dev/null || true


# Use Apache default command
# CMD ["apache2-foreground"]
