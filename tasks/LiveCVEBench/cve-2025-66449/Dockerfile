FROM debian:trixie-slim AS base
LABEL org.opencontainers.image.source="https://github.com/C4illin/ConvertX"
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    unzip \
    git \
    tmux \
    asciinema \
    && rm -rf /var/lib/apt/lists/*

# Install latest Bun using official installer
RUN curl -fsSL https://bun.sh/install | bash && \
    ln -s /root/.bun/bin/bun /usr/local/bin/bun && \
    ln -s /root/.bun/bin/bunx /usr/local/bin/bunx

# Clone vulnerable version and remove git history
RUN git clone --branch v0.15.1 --depth 1 https://github.com/C4illin/ConvertX.git . && \
    rm -rf .git

# Install dependencies
RUN bun install

# Build the application (CSS + TypeScript)
RUN bun run build

# Create data directory for uploads and database
RUN mkdir -p data

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV QTWEBENGINE_CHROMIUM_FLAGS="--no-sandbox"
ENV NODE_ENV=production

# CMD ["/entrypoint.sh"]
