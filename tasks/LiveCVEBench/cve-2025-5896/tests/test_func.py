"""
Functionality tests for css-to-react-native transformation.
These tests verify that the CSS transformation works correctly
for normal inputs. Should PASS both before and after the fix.
"""

import subprocess
import json
import pytest


APP_DIR = '/app/packages/css-to-react-native'


def run_node_script(script, timeout=30):
    """Execute a Node.js script and return output."""
    try:
        result = subprocess.run(
            ['node', '-e', script],
            capture_output=True,
            text=True,
            timeout=timeout,
            cwd=APP_DIR
        )
        return result.stdout.strip(), result.stderr.strip(), result.returncode
    except subprocess.TimeoutExpired:
        raise TimeoutError(f"Script timed out after {timeout}s")


class TestBasicTransformation:
    """Tests for basic CSS transformation functionality."""

    def test_basic_px_transform(self):
        """Test that basic px values are transformed correctly."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { width: 100px; height: 200px; }';
        const result = transform(css);
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        # The transform should process the values
        assert result['test'] is not None

    def test_basic_rem_transform(self):
        """Test that rem values are converted to px (multiplied by 16)."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { font-size: 2rem; }';
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        # 2rem should become 32 (2 * 16)
        assert result['test']['fontSize'] == 32

    def test_decimal_rem_transform(self):
        """Test that decimal rem values work correctly."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { margin: 1.5rem; }';
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        # 1.5rem should become 24 (1.5 * 16)
        assert result['test']['marginTop'] == 24

    def test_multiple_values(self):
        """Test transformation of multiple CSS properties."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.box { width: 50px; height: 100px; padding: 10px; margin: 20px; }';
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'box' in result
        box = result['box']
        assert box['width'] == 50
        assert box['height'] == 100


class TestScalableOption:
    """Tests for the scalable option functionality."""

    def test_scalable_false_transforms_px_to_uppercase(self):
        """Test that scalable:false transforms px to PX."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { width: 100px; }';
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        # The value should be processed with uppercase PX
        # The exact format may vary based on implementation

    def test_scalable_true_keeps_normal_px(self):
        """Test that scalable:true wraps px values with scalePx2dp."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { width: 100px; }';
        const result = transform(css, { scalable: true });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        # With scalable:true (default), values are wrapped with scalePx2dp
        assert result['test']['width'] == "scalePx2dp(100)"

    def test_scalable_default(self):
        """Test default behavior without scalable option wraps values."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { width: 50px; }';
        const result = transform(css);
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        # Default behavior wraps px values with scalePx2dp
        assert result['test']['width'] == "scalePx2dp(50)"


class TestMultipleClasses:
    """Tests for transforming multiple CSS classes."""

    def test_multiple_css_classes(self):
        """Test transformation of multiple CSS classes."""
        script = """
        const transform = require('./dist/index').default;
        const css = `
            .header { height: 60px; }
            .content { padding: 20px; }
            .footer { height: 40px; }
        `;
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'header' in result
        assert 'content' in result
        assert 'footer' in result
        assert result['header']['height'] == 60
        assert result['footer']['height'] == 40

    def test_complex_css_structure(self):
        """Test transformation of complex CSS with various properties."""
        script = """
        const transform = require('./dist/index').default;
        const css = `
            .card {
                width: 300px;
                height: 200px;
                border-radius: 8px;
                padding: 16px;
            }
        `;
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'card' in result
        card = result['card']
        assert card['width'] == 300
        assert card['height'] == 200


class TestEdgeCases:
    """Tests for edge cases in CSS transformation."""

    def test_zero_values(self):
        """Test transformation of zero values."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { margin: 0px; padding: 0; }';
        const result = transform(css);
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result

    def test_mixed_units(self):
        """Test transformation with mixed units (px and rem)."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { width: 100px; font-size: 1rem; }';
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        assert result['test']['width'] == 100
        assert result['test']['fontSize'] == 16  # 1rem = 16px

    def test_normal_string_values(self):
        """Test that normal property values process correctly."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { width: 50px; }';
        const result = transform(css, { scalable: false });
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result

    def test_viewport_units(self):
        """Test transformation with viewport units."""
        script = """
        const transform = require('./dist/index').default;
        const css = '.test { width: 100vw; height: 50vh; }';
        const result = transform(css);
        console.log(JSON.stringify(result));
        """
        stdout, stderr, rc = run_node_script(script)
        assert rc == 0, f"Script failed with: {stderr}"
        result = json.loads(stdout)
        assert 'test' in result
        # Viewport units should be tracked
        assert '__viewportUnits' in result or 'test' in result


class TestBaselinePerformance:
    """Baseline tests to ensure normal inputs process quickly."""

    def test_normal_input_is_fast(self):
        """
        Verify that normal CSS input processes quickly.
        This is a sanity check - should always pass.
        """
        script = """
        const transform = require('./dist/index').default;
        const cssString = `
            .normal { width: 100px; height: 200px; font-size: 1rem; }
        `;
        const start = Date.now();
        transform(cssString, { scalable: false });
        console.log('DURATION:' + (Date.now() - start));
        """
        stdout, stderr, rc = run_node_script(script, timeout=5)

        assert rc == 0, f"Normal input failed: {stderr}"
        if stdout and stdout.startswith('DURATION:'):
            duration_ms = int(stdout.split(':')[1])
            assert duration_ms < 500, f"Normal input unexpectedly slow: {duration_ms}ms"

    def test_moderate_input_is_fast(self):
        """
        Verify that moderately long but valid input is fast.
        """
        script = """
        const transform = require('./dist/index').default;
        const cssString = `
            .test { width: 12345678px; height: 87654321px; }
        `;
        const start = Date.now();
        transform(cssString, { scalable: false });
        console.log('DURATION:' + (Date.now() - start));
        """
        stdout, stderr, rc = run_node_script(script, timeout=5)

        assert rc == 0, f"Moderate input failed: {stderr}"
        if stdout and stdout.startswith('DURATION:'):
            duration_ms = int(stdout.split(':')[1])
            assert duration_ms < 500, f"Moderate input unexpectedly slow: {duration_ms}ms"


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
