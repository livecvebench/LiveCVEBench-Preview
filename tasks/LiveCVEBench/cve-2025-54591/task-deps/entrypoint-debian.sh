#!/bin/bash

ln -snf "/usr/share/zoneinfo/$TZ" /etc/localtime
echo "$TZ" >/etc/timezone

# PHP configuration (find PHP ini files in Debian locations)
for php_ini in /usr/local/etc/php/php.ini /usr/local/etc/php/conf.d/*.ini; do
    if [ -f "$php_ini" ]; then
        sed -i -E \
            -e "s#^;?date.timezone.*#date.timezone = $TZ#" \
            -e "s#^;?post_max_size.*#post_max_size = 32M#" \
            -e "s#^;?upload_max_filesize.*#upload_max_filesize = 32M#" "$php_ini" 2>/dev/null || true
    fi
done

# Create PHP ini with settings if not exists
if [ ! -f /usr/local/etc/php/conf.d/freshrss.ini ]; then
    cat > /usr/local/etc/php/conf.d/freshrss.ini << EOF
date.timezone = $TZ
post_max_size = 32M
upload_max_filesize = 32M
EOF
fi

# Ensure data directory exists and has proper permissions
mkdir -p /var/www/FreshRSS/data
chown -R www-data:www-data /var/www/FreshRSS/data

# Run access permissions script
cd /var/www/FreshRSS
./cli/access-permissions.sh

# Prepare FreshRSS
php -f ./cli/prepare.php >/dev/null

if [ -n "$FRESHRSS_INSTALL" ]; then
    # Run install script with the environment variable options
    INSTALL_OPTS=$(echo "$FRESHRSS_INSTALL" | sed -r 's/[\r\n]+/\n/g' | paste -s -)
    php -f ./cli/do-install.php -- $INSTALL_OPTS
    EXITCODE=$?

    if [ $EXITCODE -eq 3 ]; then
        echo 'FreshRSS already installed; no change performed.'
    elif [ $EXITCODE -eq 0 ]; then
        echo 'FreshRSS successfully installed.'
    else
        echo 'FreshRSS error during installation!'
        exit $EXITCODE
    fi
fi

if [ -n "$FRESHRSS_USER" ]; then
    # Create user with the environment variable options
    USER_OPTS=$(echo "$FRESHRSS_USER" | sed -r 's/[\r\n]+/\n/g' | paste -s -)
    php -f ./cli/create-user.php -- $USER_OPTS
    EXITCODE=$?

    if [ $EXITCODE -eq 3 ]; then
        echo 'FreshRSS user already exists; no change performed.'
    elif [ $EXITCODE -eq 0 ]; then
        echo 'FreshRSS user successfully created.'
        ./cli/list-users.php | xargs -n1 ./cli/actualize-user.php --user
    else
        echo 'FreshRSS error during the creation of a user!'
        exit $EXITCODE
    fi
fi

# Run permissions again after setup
./cli/access-permissions.sh

exec "$@"
