#!/bin/bash
set -e

cd /app

echo "=== Applying fix for scope initialization bug ==="

# The bug is in mrbgems/mruby-compiler/core/codegen.c
# In the scope_new function, nlocals is set but nregs is not initialized
# Fix: initialize both nlocals and nregs to s->sp

CODEGEN_FILE="mrbgems/mruby-compiler/core/codegen.c"

if [ ! -f "$CODEGEN_FILE" ]; then
    echo "ERROR: $CODEGEN_FILE not found!"
    exit 1
fi

# Check if already fixed
if grep -q "s->nlocals = s->nregs = s->sp;" "$CODEGEN_FILE"; then
    echo "Fix already applied."
else
    # Apply the fix: change "s->nlocals = s->sp;" to "s->nlocals = s->nregs = s->sp;"
    sed -i 's/s->nlocals = s->sp;/s->nlocals = s->nregs = s->sp;/' "$CODEGEN_FILE"

    echo "Fix applied to $CODEGEN_FILE"

    # Verify the fix was applied
    if grep -q "s->nlocals = s->nregs = s->sp;" "$CODEGEN_FILE"; then
        echo "Verified: fix successfully applied."
    else
        echo "ERROR: Failed to apply fix!"
        exit 1
    fi
fi

echo ""
echo "=== Rebuilding mruby ==="

# Clean and rebuild
rake clean
rake

echo ""
echo "=== Verifying rebuild ==="
if [ -f "build/host/bin/mruby" ]; then
    echo "mruby binary rebuilt successfully."
    ./build/host/bin/mruby --version || true
else
    echo "ERROR: mruby binary not found after rebuild!"
    exit 1
fi

echo ""
echo "=== Fix complete ==="
