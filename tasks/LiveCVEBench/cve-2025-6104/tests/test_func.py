"""
Functional tests for PMS Check endpoint.

These tests verify that the PMS connectivity check feature works correctly
for valid inputs. Should PASS in both vulnerable and fixed states.
"""

import requests
import pytest
import os

BASE_URL = os.environ.get("BASE_URL", "http://localhost:8080")


class TestPMSCheckFunctionality:
    """Test basic functionality of PMS check endpoint."""

    def test_endpoint_responds(self):
        """Test that the endpoint is accessible and responds."""
        response = requests.get(f"{BASE_URL}/billing/pms_check.php", timeout=10)
        assert response.status_code == 200
        assert "Response" in response.text or "PMS" in response.text

    def test_localhost_ipv4_ping(self):
        """Test pinging localhost (127.0.0.1) returns success."""
        response = requests.get(
            f"{BASE_URL}/billing/pms_check.php",
            params={"ipaddress": "127.0.0.1"},
            timeout=15,
        )
        assert response.status_code == 200
        # Localhost should always be reachable
        assert "PMS test success" in response.text

    def test_valid_private_ip_format(self):
        """Test that valid private IP address format is accepted."""
        response = requests.get(
            f"{BASE_URL}/billing/pms_check.php",
            params={"ipaddress": "192.168.1.1"},
            timeout=15,
        )
        assert response.status_code == 200
        # May succeed or fail depending on network, but should respond properly
        assert "Response" in response.text or "PMS" in response.text

    def test_valid_public_ip_format(self):
        """Test that valid public IP address format is accepted."""
        response = requests.get(
            f"{BASE_URL}/billing/pms_check.php",
            params={"ipaddress": "8.8.8.8"},
            timeout=15,
        )
        assert response.status_code == 200
        # May succeed or fail depending on network, but should respond properly
        assert "Response" in response.text or "PMS" in response.text

    def test_empty_parameter_returns_error(self):
        """Test that empty ipaddress parameter returns appropriate error."""
        response = requests.get(
            f"{BASE_URL}/billing/pms_check.php",
            params={"ipaddress": ""},
            timeout=10,
        )
        assert response.status_code == 200
        assert "No IP address provided" in response.text or "failed" in response.text.lower()

    def test_missing_parameter_returns_error(self):
        """Test that missing ipaddress parameter returns appropriate error."""
        response = requests.get(f"{BASE_URL}/billing/pms_check.php", timeout=10)
        assert response.status_code == 200
        assert "No IP address provided" in response.text or "failed" in response.text.lower()

    def test_loopback_ip_success(self):
        """Test that loopback IP (127.0.0.1) works correctly."""
        response = requests.get(
            f"{BASE_URL}/billing/pms_check.php",
            params={"ipaddress": "127.0.0.1"},
            timeout=15,
        )
        assert response.status_code == 200
        # Loopback should always succeed
        assert "success" in response.text.lower()

    def test_response_contains_xml_format(self):
        """Test that response contains expected XML-like format."""
        response = requests.get(
            f"{BASE_URL}/billing/pms_check.php",
            params={"ipaddress": "127.0.0.1"},
            timeout=15,
        )
        assert response.status_code == 200
        # Response should contain XML-style formatting
        assert "<?xml" in response.text or "Response" in response.text


class TestPMSCheckHTTPMethods:
    """Test different HTTP methods for PMS check endpoint."""

    def test_get_method_works(self):
        """Test that GET method works for the endpoint."""
        response = requests.get(
            f"{BASE_URL}/billing/pms_check.php",
            params={"ipaddress": "127.0.0.1"},
            timeout=15,
        )
        assert response.status_code == 200
        assert "Response" in response.text

    def test_post_method_works(self):
        """Test that POST method also works (uses REQUEST superglobal)."""
        response = requests.post(
            f"{BASE_URL}/billing/pms_check.php",
            data={"ipaddress": "127.0.0.1"},
            timeout=15,
        )
        assert response.status_code == 200
        assert "Response" in response.text
