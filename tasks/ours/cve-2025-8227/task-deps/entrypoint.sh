#!/usr/bin/env bash
set -e

# Initialize database on first run
if [ ! -f /tmp/.db_initialized ]; then
    echo "[init] Waiting for MySQL to be ready..."
    sleep 5

    echo "[init] Importing database schema..."
    if [ -f /app/data/init.sql ]; then
        mysql -h mysql -u root -prootpassword chancms < /app/data/init.sql 2>/dev/null || true
        touch /tmp/.db_initialized
        echo "[init] Database initialized"
    else
        echo "[init] No init.sql found, skipping database initialization"
    fi
fi

# Entrypoint script for ChanCMS that supports restart via killing the process
# This allows solution.sh to restart the app after applying fixes

trap "exit 0" SIGTERM

# Disable exit-on-error for the restart loop so killing the process doesn't exit the script
set +e

while true; do
    echo "[entrypoint] Starting ChanCMS..."
    node --env-file=.env.dev app.js &
    APP_PID=$!
    echo "[entrypoint] ChanCMS started with PID $APP_PID"

    # Wait for the process to exit
    wait $APP_PID
    EXIT_CODE=$?

    echo "[entrypoint] ChanCMS exited with code $EXIT_CODE, restarting in 2 seconds..."
    sleep 2
done
