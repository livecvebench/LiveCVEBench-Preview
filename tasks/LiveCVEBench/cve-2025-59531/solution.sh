#!/bin/bash
set -e

# Fix: Add safe type assertions in Bitbucket Server webhook handler
# The vulnerable code performs unsafe type assertions that panic on malformed input:
#   payload.Repository.Links["clone"].([]interface{})
# The fix uses safe type assertions with ok checks:
#   clone, ok := payload.Repository.Links["clone"].([]any)

WEBHOOK_FILE="/app/util/webhook/webhook.go"

if [ ! -f "$WEBHOOK_FILE" ]; then
    echo "ERROR: Webhook file not found at $WEBHOOK_FILE"
    exit 1
fi

echo "Applying fix to $WEBHOOK_FILE..."

# Create a Python script to perform the fix
python3 << 'PYEOF'
import re
import sys

webhook_file = "/app/util/webhook/webhook.go"

with open(webhook_file, 'r') as f:
    content = f.read()

# Check if already fixed
if 'clone, ok := payload.Repository.Links["clone"].([]any)' in content:
    print("Code already fixed - safe type assertion present")
    sys.exit(0)

# Check for vulnerable pattern
if 'for _, l := range payload.Repository.Links["clone"].([]interface{})' not in content:
    print("WARNING: Expected vulnerable pattern not found")
    # Check for alternative patterns
    if '["clone"].([]interface{})' in content:
        print("Found alternative vulnerable pattern")
    else:
        print("Code may already be fixed or uses different pattern")
        sys.exit(0)

# The vulnerable block we need to replace:
#     for _, l := range payload.Repository.Links["clone"].([]interface{}) {
#         link := l.(map[string]interface{})
#         if link["name"] == "http" {
#             webURLs = append(webURLs, link["href"].(string))
#         }
#         if link["name"] == "ssh" {
#             webURLs = append(webURLs, link["href"].(string))
#         }
#     }

# Replace the vulnerable block with the safe version
old_block = '''			for _, l := range payload.Repository.Links["clone"].([]interface{}) {
				link := l.(map[string]interface{})
				if link["name"] == "http" {
					webURLs = append(webURLs, link["href"].(string))
				}
				if link["name"] == "ssh" {
					webURLs = append(webURLs, link["href"].(string))
				}
			}'''

new_block = '''			clone, ok := payload.Repository.Links["clone"].([]any)
			if ok {
				for _, l := range clone {
					link := l.(map[string]any)
					if link["name"] == "http" || link["name"] == "ssh" {
						if href, ok := link["href"].(string); ok {
							webURLs = append(webURLs, href)
						}
					}
				}
			}'''

new_content = content.replace(old_block, new_block)

if new_content == content:
    print("ERROR: Could not apply fix - pattern mismatch")
    print("Trying alternative replacement...")

    # Try with different whitespace
    import re

    # Pattern for the vulnerable for loop
    pattern = r'for _, l := range payload\.Repository\.Links\["clone"\]\.\(\[\]interface\{\}\) \{[^}]+\{[^}]+\}[^}]+\{[^}]+\}[^}]+\}'

    if re.search(pattern, content, re.DOTALL):
        # Found pattern - do manual line replacement
        lines = content.split('\n')
        new_lines = []
        i = 0
        while i < len(lines):
            line = lines[i]
            if 'for _, l := range payload.Repository.Links["clone"].([]interface{})' in line:
                # Found the vulnerable line - replace the block
                # Skip lines until we close this for loop
                brace_count = 1
                i += 1
                while i < len(lines) and brace_count > 0:
                    brace_count += lines[i].count('{') - lines[i].count('}')
                    i += 1

                # Insert fixed code
                new_lines.append('\t\t\tclone, ok := payload.Repository.Links["clone"].([]any)')
                new_lines.append('\t\t\tif ok {')
                new_lines.append('\t\t\t\tfor _, l := range clone {')
                new_lines.append('\t\t\t\t\tlink := l.(map[string]any)')
                new_lines.append('\t\t\t\t\tif link["name"] == "http" || link["name"] == "ssh" {')
                new_lines.append('\t\t\t\t\t\tif href, ok := link["href"].(string); ok {')
                new_lines.append('\t\t\t\t\t\t\twebURLs = append(webURLs, href)')
                new_lines.append('\t\t\t\t\t\t}')
                new_lines.append('\t\t\t\t\t}')
                new_lines.append('\t\t\t\t}')
                new_lines.append('\t\t\t}')
                continue
            new_lines.append(line)
            i += 1
        new_content = '\n'.join(new_lines)
    else:
        sys.exit(1)

with open(webhook_file, 'w') as f:
    f.write(new_content)

print("Fix applied successfully")
PYEOF

# Verify the fix
if grep -q 'clone, ok := payload.Repository.Links\["clone"\]' "$WEBHOOK_FILE"; then
    echo "Verification: Safe type assertion for clone field is present"
else
    echo "ERROR: Fix verification failed"
    exit 1
fi

echo "Solution applied successfully"
