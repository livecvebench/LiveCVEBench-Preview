#!/bin/bash
# Entrypoint script for Fabio CVE reproduction environment
# Starts backend server and Fabio proxy with restart capability

# Start backend server in background
python3 /app/backend_server.py &
BACKEND_PID=$!

# Wait for backend to be ready
sleep 2

# Function to start fabio
start_fabio() {
    /app/fabio -proxy.addr :9999 -registry.backend static -registry.static.routes 'route add test / http://localhost:8080/'
}

# Run fabio in a loop so it can be restarted after rebuilding
while true; do
    start_fabio
    EXIT_CODE=$?
    echo "Fabio exited with code $EXIT_CODE, restarting in 2 seconds..."
    sleep 2
done
