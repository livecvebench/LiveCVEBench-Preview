package jehc.djshi.oauth.service.impl;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import jehc.djshi.common.cache.redis.RedisUtil;
import jehc.djshi.common.constant.CacheConstant;
import jehc.djshi.common.session.HttpSessionUtils;
import jehc.djshi.common.util.JsonUtil;
import jehc.djshi.common.util.StringUtil;
import jehc.djshi.oauth.model.OauthKeyInfo;
import jehc.djshi.oauth.param.OauthAccountTenantParam;
import jehc.djshi.oauth.service.OauthAccountTenantService;
import jehc.djshi.oauth.service.OauthSysModeService;
import jehc.djshi.common.base.BaseService;
import jehc.djshi.common.util.ExceptionUtil;
import jehc.djshi.oauth.dao.OauthSysModeDao;
import jehc.djshi.oauth.model.OauthSysMode;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
/**
 * @Desc 授权中心子系统标记
 * @Author 邓纯杰
 * @CreateTime 2012-12-12 12:12:12
 */
@Service
@Slf4j
public class OauthSysModeServiceImpl extends BaseService implements OauthSysModeService {

	@Resource
	private OauthSysModeDao oauthSysModeDao;

	@Resource
	private RedisUtil redisUtil;

	@Resource
	HttpSessionUtils httpSessionUtils;

	@Resource
	OauthAccountTenantService oauthAccountTenantService;

	/**
	* 分页
	* @param condition 
	* @return
	*/
	public List<OauthSysMode> getOauthSysModeListByCondition(Map<String,Object> condition){
		try{
			return oauthSysModeDao.getOauthSysModeListByCondition(condition);
		} catch (Exception e) {
			throw new ExceptionUtil(e.getMessage(),e.getCause());
		}
	}

	/**
	* 查询对象
	* @param id
	* @return
	*/
	public OauthSysMode getOauthSysModeById(String id){
		try{
			OauthSysMode oauthSysMode = oauthSysModeDao.getOauthSysModeById(id);
			return oauthSysMode;
		} catch (Exception e) {
			throw new ExceptionUtil(e.getMessage(),e.getCause());
		}
	}

	/**
	* 添加
	* @param oauthSysMode 
	* @return
	*/
	public int addOauthSysMode(OauthSysMode oauthSysMode){
		int i = 0;
		try {
			oauthSysMode.setCreateTime(getDate());
			oauthSysMode.setCreateId(getXtUid());
			if(!StringUtil.isEmpty(oauthSysMode.getKeyInfoId())){
				Map<String,Object> map = new HashMap<>();
				map.put("keyInfoId",oauthSysMode.getKeyInfoId());
				if(!oauthSysModeDao.getOauthSysModeListByCondition(map).isEmpty()){
					throw new ExceptionUtil("秘钥已被其他产品线使用");
				}
			}
			i = oauthSysModeDao.addOauthSysMode(oauthSysMode);
			sync();
		} catch (Exception e) {
			throw new ExceptionUtil(e.getMessage(),e.getCause());
		}
		return i;
	}

	/**
	* 修改
	* @param oauthSysMode 
	* @return
	*/
	public int updateOauthSysMode(OauthSysMode oauthSysMode){
		int i = 0;
		try {
			oauthSysMode.setUpdateId(getXtUid());
			oauthSysMode.setUpdateTime(getDate());
			String oldKeyInfoId = oauthSysModeDao.getOauthSysModeById(oauthSysMode.getId()).getKeyInfoId();
			if(!StringUtil.isEmpty(oauthSysMode.getKeyInfoId()) && !oauthSysMode.getKeyInfoId().equals(oldKeyInfoId)){
				Map<String,Object> map = new HashMap<>();
				map.put("keyInfoId",oauthSysMode.getKeyInfoId());
				if(!oauthSysModeDao.getOauthSysModeListByCondition(map).isEmpty()){
					throw new ExceptionUtil("秘钥已被其他产品线使用");
				}
			}
			i = oauthSysModeDao.updateOauthSysMode(oauthSysMode);
			sync();
		} catch (Exception e) {
			throw new ExceptionUtil(e.getMessage(),e.getCause());
		}
		return i;
	}

	/**
	* 删除
	* @param condition 
	* @return
	*/
	public int delOauthSysMode(Map<String,Object> condition){
		int i = 0;
		try {
			i = oauthSysModeDao.delOauthSysMode(condition);
			OauthAccountTenantParam oauthAccountTenantParam = new OauthAccountTenantParam();
			oauthAccountTenantParam.setBatchSysModeId((String[]) condition.get("id"));
			oauthAccountTenantService.delOauthAccountTenantBySysModeId(oauthAccountTenantParam);
			sync();
		} catch (Exception e) {
			throw new ExceptionUtil(e.getMessage(),e.getCause());
		}
		return i;
	}

	/**
	 * 获取SysModeId
	 * @param request
	 * @return
	 */
	public String getSysModeId(HttpServletRequest request){
		String key = null;
		String pass = null;
		Enumeration<String> headerNames = request.getHeaderNames();
		while (headerNames.hasMoreElements()) {
			String k = (String) headerNames.nextElement();
			if(k.toLowerCase().equals(CacheConstant.JEHC_CLOUD_KEY.toLowerCase())){
				key = request.getHeader(k);
			}
			if(k.toLowerCase().equals(CacheConstant.JEHC_CLOUD_SECURITY.toLowerCase())){
				pass = request.getHeader(k);
			}
		}
		if(StringUtil.isEmpty(key)){
			return null;
		}
		if(StringUtil.isEmpty(pass)){
			return null;
		}
		String oauthKeyInfoJson = httpSessionUtils.getHashAttribute(CacheConstant.OAUTH_KEY,key);
		OauthKeyInfo oauthKeyInfo = JsonUtil.fromFJson(oauthKeyInfoJson,OauthKeyInfo.class);
		String appSecret = oauthKeyInfo.getAppSecret();
		if(StringUtil.isEmpty(appSecret)){
			return null;
		}
		if(!pass.equals(appSecret)){
			return null;
		}

		String oauthSysModeJson = httpSessionUtils.getAttribute(CacheConstant.OAUTH_SYS_MODE);
		if(StringUtil.isEmpty(oauthSysModeJson)){
			return null;
		}
		List<OauthSysMode> oauthSysModeList = JsonUtil.toFList(oauthSysModeJson,OauthSysMode.class);
		for(OauthSysMode oauthSysMode:oauthSysModeList){
			if(oauthKeyInfo.getId().equals(oauthSysMode.getKeyInfoId())){
				return oauthSysMode.getId();
			}
		}
		return null;
	}

	/**
	 * 同步缓存
	 * @return
	 */
	public boolean sync(){
		try {
			List<OauthSysMode> oauthSysModeList = getOauthSysModeListByCondition(new HashMap<>());
			redisUtil.set(CacheConstant.OAUTH_SYS_MODE,JsonUtil.toFastJson(oauthSysModeList));
			return true;
		}catch (Exception e){
			log.info("同步授权中心子系统缓存失败，错误信息：{}",e);
			return false;
		}
	}
}
