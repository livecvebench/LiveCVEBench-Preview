"""
Vulnerability tests for WP Shopify continue-shopping shortcode.
Tests that XSS payloads are properly handled.

These tests should:
- FAIL in vulnerable state (XSS payloads are reflected unsanitized)
- PASS in fixed state (XSS payloads are sanitized/escaped)
"""

import pytest
import requests
import time
import os
import re
import urllib.parse

BASE_URL = os.environ.get("TARGET_URL", "http://localhost")
TEST_PAGE_PATH = "/shopify-test/"


def make_request_with_retry(url, params=None, max_retries=3, timeout=10):
    """Make a GET request with retry logic for transient 503 errors."""
    for attempt in range(max_retries):
        try:
            response = requests.get(url, params=params, timeout=timeout)
            if response.status_code != 503 or attempt == max_retries - 1:
                return response
            # Wait before retry on 503
            time.sleep(1)
        except requests.exceptions.RequestException:
            if attempt == max_retries - 1:
                raise
            time.sleep(1)
    return response


def wait_for_wordpress(timeout=120):
    """Wait for WordPress to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(BASE_URL, timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


@pytest.fixture(scope="module", autouse=True)
def setup():
    """Wait for WordPress to be ready before running tests."""
    assert wait_for_wordpress(), "WordPress did not become ready in time"


class TestAttributeBreakoutPrevention:
    """Test that attribute breakout attacks are prevented."""

    def test_double_quote_breakout_basic(self):
        """Test basic double quote attribute breakout is blocked."""
        # Payload: test"onload=alert(1)//
        payload = 'test"onload=alert(1)//'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200

        # The onload event handler should NOT appear in the output
        assert 'onload=' not in response.text.lower(), \
            "Event handler 'onload=' should be sanitized out"

        # Double quote should be escaped or removed
        # Check that we don't have the pattern that breaks out of src attribute
        assert 'src="https://' in response.text or "src='https://" in response.text, \
            "The src attribute should remain intact"
        # The payload should not create a new attribute
        assert '" onload=' not in response.text and '"onload=' not in response.text, \
            "Double quote followed by onload should not appear"

    def test_double_quote_with_space_breakout(self):
        """Test double quote with space breakout is blocked."""
        # Payload: test" onload="alert(document.domain)" data-x="
        payload = 'test" onload="alert(document.domain)" data-x="'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200

        # Should not have event handlers
        assert 'onload=' not in response.text.lower(), \
            "onload event handler should be sanitized"
        assert 'alert(' not in response.text, \
            "alert() function call should not appear"
        assert 'document.domain' not in response.text, \
            "document.domain should not appear in output"

    def test_single_quote_breakout(self):
        """Test single quote attribute breakout is blocked."""
        payload = "test'onload='alert(1)'//"
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200

        assert 'onload=' not in response.text.lower(), \
            "onload should be sanitized even with single quotes"


class TestEventHandlerInjection:
    """Test that various event handler injections are blocked."""

    def test_onload_handler(self):
        """Test onload event handler injection is blocked."""
        payload = 'x"onload="alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onload=' not in response.text.lower()

    def test_onerror_handler(self):
        """Test onerror event handler injection is blocked."""
        payload = 'x"onerror="alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onerror=' not in response.text.lower()

    def test_onfocus_handler(self):
        """Test onfocus event handler injection is blocked."""
        payload = 'x"onfocus="alert(1)"autofocus="'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onfocus=' not in response.text.lower()
        # Check that autofocus doesn't appear as an HTML attribute (with = sign)
        # The word "autofocus" in a sanitized URL slug is harmless
        assert 'autofocus=' not in response.text.lower() and 'autofocus "' not in response.text.lower()

    def test_onmouseover_handler(self):
        """Test onmouseover event handler injection is blocked."""
        payload = 'x"onmouseover="alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onmouseover=' not in response.text.lower()

    def test_onclick_handler(self):
        """Test onclick event handler injection is blocked."""
        payload = 'x"onclick="alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onclick=' not in response.text.lower()


class TestScriptTagInjection:
    """Test that script tag and attribute injection patterns are blocked."""

    def test_basic_script_tag(self):
        """Test that attribute breakout with script-like payload is blocked.

        The actual vulnerability is attribute breakout using double quotes.
        We check that the double quote doesn't break out of the src attribute.
        """
        # Using a payload that attempts attribute breakout
        payload = 'test"onanimationend="alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The onanimationend event handler should NOT appear as an attribute
        assert 'onanimationend=' not in response.text.lower(), \
            "Event handler 'onanimationend=' should be sanitized out"

    def test_script_tag_with_src(self):
        """Test that attribute breakout with external reference is blocked.

        The actual vulnerability allows breaking out of src attribute.
        """
        # Using attribute breakout to add a new attribute
        payload = 'test"ondrag="alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The ondrag event handler should NOT appear as an attribute
        assert 'ondrag=' not in response.text.lower(), \
            "Event handler 'ondrag=' should be sanitized out"

    def test_svg_script_injection(self):
        """Test SVG with script injection is blocked."""
        # This payload uses attribute breakout to inject onload
        payload = 'test"onload="alert(1)"'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The onload handler should NOT appear as an attribute
        assert 'onload=' not in response.text.lower()

    def test_img_tag_injection(self):
        """Test img tag with onerror injection is blocked."""
        # Using attribute breakout with onerror handler
        payload = 'test"onerror="alert(1)"'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The onerror handler should NOT appear as an attribute
        assert 'onerror=' not in response.text.lower()


class TestEncodedPayloads:
    """Test that encoded XSS payloads are handled correctly."""

    def test_html_encoded_quotes(self):
        """Test that double quotes break out of attribute context."""
        # Using a simple attribute breakout payload
        payload = 'test"onmouseenter="alert(1)"'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The onmouseenter handler should NOT appear as an attribute
        assert 'onmouseenter=' not in response.text.lower()

    def test_unicode_quotes(self):
        """Test unicode quote characters."""
        # Using unicode quote character
        payload = 'test\u0022onload=alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onload=' not in response.text.lower()

    def test_mixed_case_event_handler(self):
        """Test mixed case event handler bypass attempt."""
        payload = 'test"OnLoAd="alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onload=' not in response.text.lower()


class TestSpecialCharacterHandling:
    """Test that special characters are properly escaped."""

    def test_angle_brackets_escaped(self):
        """Test that attribute breakout with various payloads is blocked."""
        # Using attribute breakout to inject an event handler
        payload = 'test"onkeyup="alert(1)"'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The event handler should NOT appear as an attribute
        assert 'onkeyup=' not in response.text.lower()

    def test_double_quotes_in_url(self):
        """Test that double quotes don't break out of URL attribute."""
        payload = 'test"breakout'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200

        # Check that the HTML structure is valid
        # The iframe src should still be properly quoted
        # Look for malformed attribute pattern
        malformed_pattern = r'src="[^"]*"[^>]*breakout'
        assert not re.search(malformed_pattern, response.text), \
            "Double quotes should not break out of src attribute"

    def test_javascript_protocol_blocked(self):
        """Test that javascript: protocol URLs are blocked."""
        payload = 'javascript:alert(1)'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # javascript: protocol should not appear in a functional form
        # esc_url() should sanitize this
        html_lower = response.text.lower()
        # Either javascript: is removed or the whole thing is encoded
        iframe_src_match = re.search(r'src="([^"]*)"[^>]*class="wp-shopify-continue-shopping-iframe"', response.text)
        if iframe_src_match:
            src_value = iframe_src_match.group(1).lower()
            assert 'javascript:' not in src_value, \
                "javascript: protocol should not be in iframe src"


class TestComplexPayloads:
    """Test complex/combined attack payloads."""

    def test_nested_quotes_payload(self):
        """Test payload with nested quotes for attribute breakout."""
        # Attribute breakout using quotes
        payload = 'test"onchange="alert(1)"'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The onchange handler should NOT appear as an attribute
        assert 'onchange=' not in response.text.lower()

    def test_data_uri_payload(self):
        """Test data: URI injection attempt."""
        payload = '"><iframe src="data:text/html,<script>alert(1)</script>">'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # data: URI should be sanitized
        assert 'data:text/html' not in response.text.lower()

    def test_template_literal_payload(self):
        """Test JavaScript template literal injection."""
        payload = 'test`${alert(1)}`'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # Backticks and template syntax should be sanitized
        assert '${' not in response.text or 'alert' not in response.text

    def test_expression_payload(self):
        """Test JavaScript expression injection."""
        payload = 'test"onload="eval(atob(\'YWxlcnQoMSk=\'))'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        assert 'onload=' not in response.text.lower()
        assert 'eval(' not in response.text
        assert 'atob(' not in response.text


class TestURLEscaping:
    """Test that URL escaping (esc_url) is properly applied."""

    def test_url_special_chars_escaped(self):
        """Test that special characters for attribute breakout are escaped."""
        # Attribute breakout with double quote
        payload = 'test"onpointerdown="alert(1)"'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The onpointerdown handler should NOT appear as an attribute
        assert 'onpointerdown=' not in response.text.lower()

    def test_proper_url_format_maintained(self):
        """Test that attribute breakout using data attribute is blocked."""
        # Attribute breakout attempting to inject custom data attribute with JS
        payload = 'test"oncut="alert(1)"'
        response = make_request_with_retry(
            f"{BASE_URL}{TEST_PAGE_PATH}",
            params={"product": payload}
        )
        assert response.status_code == 200
        # The oncut handler should NOT appear as an attribute
        assert 'oncut=' not in response.text.lower()
