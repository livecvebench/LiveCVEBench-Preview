"""
Vulnerability tests for OrderConvo file download path traversal issue.
These tests verify that path traversal attacks are blocked.

FAIL in vulnerable state (path traversal is exploitable)
PASS in fixed state (path traversal is blocked)
"""

import pytest
import requests
import os
import time

BASE_URL = os.environ.get("APP_URL", "http://localhost")


def wait_for_wordpress(timeout=60):
    """Wait for WordPress to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{BASE_URL}/wp-json/", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


class TestPathTraversalVulnerability:
    """Tests to verify path traversal attacks are blocked."""

    @pytest.fixture(scope="class", autouse=True)
    def setup(self):
        """Wait for WordPress to be ready before running tests."""
        assert wait_for_wordpress(), "WordPress did not become ready in time"

    def test_path_traversal_wp_config(self):
        """
        Test that path traversal to wp-config.php is blocked.

        Path: /var/www/html/wp-content/uploads/wooconvo/1/../../../../wp-config.php
        Resolves to: /var/www/html/wp-config.php

        Vulnerable: Returns wp-config.php contents containing DB_PASSWORD
        Fixed: Returns error or empty response
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-config.php"},
            timeout=10
        )

        # wp-config.php contains database credentials
        # If vulnerable, these strings will be present
        content = response.text

        assert "DB_PASSWORD" not in content, \
            "Path traversal vulnerability: wp-config.php was leaked (DB_PASSWORD found)"

    def test_path_traversal_etc_passwd(self):
        """
        Test that path traversal to /etc/passwd is blocked.

        Path: /var/www/html/wp-content/uploads/wooconvo/1/../../../../../../../etc/passwd
        Resolves to: /etc/passwd

        Vulnerable: Returns /etc/passwd contents (contains root: and user entries)
        Fixed: Returns error or empty response
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../../../../etc/passwd"},
            timeout=10
        )

        content = response.text

        assert "root:" not in content, \
            "Path traversal vulnerability: /etc/passwd was leaked (root: found)"

    def test_path_traversal_different_order_ids(self):
        """
        Test path traversal with different order_id values.

        The vulnerability should be blocked regardless of order_id.
        """
        for order_id in ["1", "99999", "0", "-1"]:
            response = requests.get(
                f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
                params={"order_id": order_id, "filename": "../../../../wp-config.php"},
                timeout=10
            )

            content = response.text

            assert "DB_PASSWORD" not in content, \
                f"Path traversal vulnerable with order_id={order_id}"

    def test_path_traversal_dotslash_variant(self):
        """
        Test path traversal with ./ prefix variant.

        The ./.././../... pattern is equivalent to ../../...
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "./.././.././.././../wp-config.php"},
            timeout=10
        )

        content = response.text

        assert "DB_PASSWORD" not in content, \
            "Path traversal bypass successful with ./ prefix"

    def test_read_wp_includes_file(self):
        """
        Test path traversal to WordPress core files.

        wp-includes/version.php contains the WP version.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-includes/version.php"},
            timeout=10
        )

        content = response.text

        # version.php defines $wp_version
        assert "$wp_version" not in content, \
            "Path traversal to WordPress core files successful"

    def test_path_traversal_with_subdirectory(self):
        """
        Test path traversal when accessing files in subdirectories.

        Tries to access a file in wp-admin directory.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-admin/includes/class-wp-filesystem-base.php"},
            timeout=10
        )

        content = response.text

        # This file defines the WP_Filesystem_Base class
        assert "WP_Filesystem_Base" not in content, \
            "Path traversal to wp-admin files successful"

    def test_path_traversal_db_config(self):
        """
        Test that DB_NAME constant is not exposed via path traversal.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-config.php"},
            timeout=10
        )

        content = response.text

        assert "DB_NAME" not in content, \
            "Path traversal vulnerability: DB_NAME was leaked"

    def test_path_traversal_db_user(self):
        """
        Test that DB_USER constant is not exposed via path traversal.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-config.php"},
            timeout=10
        )

        content = response.text

        assert "DB_USER" not in content, \
            "Path traversal vulnerability: DB_USER was leaked"

    def test_path_traversal_auth_keys(self):
        """
        Test that AUTH_KEY constant is not exposed via path traversal.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-config.php"},
            timeout=10
        )

        content = response.text

        assert "AUTH_KEY" not in content, \
            "Path traversal vulnerability: AUTH_KEY was leaked"

    def test_path_traversal_passwd_daemon(self):
        """
        Test that system user 'daemon' is not exposed via /etc/passwd traversal.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../../../../etc/passwd"},
            timeout=10
        )

        content = response.text

        assert "daemon:" not in content, \
            "Path traversal vulnerability: /etc/passwd was leaked (daemon: found)"

    def test_path_traversal_passwd_www_data(self):
        """
        Test that www-data user is not exposed via /etc/passwd traversal.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../../../../etc/passwd"},
            timeout=10
        )

        content = response.text

        assert "www-data" not in content, \
            "Path traversal vulnerability: /etc/passwd was leaked (www-data found)"

    def test_path_traversal_wp_settings(self):
        """
        Test path traversal to wp-settings.php.

        This file initializes WordPress and contains important includes.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-settings.php"},
            timeout=10
        )

        content = response.text

        assert "WPINC" not in content, \
            "Path traversal vulnerability: wp-settings.php was leaked"

    def test_path_traversal_wp_load(self):
        """
        Test path traversal to wp-load.php.

        This file bootstraps WordPress.
        """
        response = requests.get(
            f"{BASE_URL}/wp-json/wooconvo/v1/download-file",
            params={"order_id": "1", "filename": "../../../../wp-load.php"},
            timeout=10
        )

        content = response.text

        # wp-load.php contains references to wp-config.php
        assert "wp-config.php" not in content, \
            "Path traversal vulnerability: wp-load.php was leaked"
