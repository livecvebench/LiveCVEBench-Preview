"""
Functional tests for the Voting System application.
These tests verify that core functionality works correctly
in both vulnerable and fixed states.
"""

import pytest
import requests
from urllib.parse import urljoin

# Application configuration
BASE_URL = "http://localhost:80/votesystem"
ADMIN_URL = f"{BASE_URL}/admin"
LOGIN_URL = f"{ADMIN_URL}/login.php"
CANDIDATES_URL = f"{ADMIN_URL}/candidates.php"
CANDIDATES_EDIT_URL = f"{ADMIN_URL}/candidates_edit.php"
CANDIDATES_ADD_URL = f"{ADMIN_URL}/candidates_add.php"
CANDIDATES_ROW_URL = f"{ADMIN_URL}/candidates_row.php"

# Default admin credentials
ADMIN_USERNAME = "codeprojects"
ADMIN_PASSWORD = "password"


class TestAuthentication:
    """Test authentication functionality."""

    def test_admin_login_successful(self):
        """Test that admin can login with correct credentials."""
        session = requests.Session()

        # Perform login
        response = session.post(LOGIN_URL, data={
            "login": "1",
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD
        }, allow_redirects=True)

        # Should be redirected to home.php or remain logged in
        assert response.status_code == 200
        # After successful login, accessing admin page should work
        admin_response = session.get(f"{ADMIN_URL}/home.php")
        assert admin_response.status_code == 200
        # Should see admin content, not login form
        assert "Dashboard" in admin_response.text or "Welcome" in admin_response.text or "Log Out" in admin_response.text

    def test_admin_login_failed_wrong_password(self):
        """Test that login fails with wrong password."""
        session = requests.Session()

        response = session.post(LOGIN_URL, data={
            "login": "1",
            "username": ADMIN_USERNAME,
            "password": "wrongpassword"
        }, allow_redirects=True)

        # Should show error or remain on login page
        assert response.status_code == 200
        # Should contain login form or error message
        assert "login" in response.text.lower() or "incorrect" in response.text.lower() or "error" in response.text.lower() or "username" in response.text.lower()


class TestCandidatesPage:
    """Test candidates page functionality."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        session.post(LOGIN_URL, data={
            "login": "1",
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD
        }, allow_redirects=True)
        return session

    def test_candidates_page_loads(self, admin_session):
        """Test that candidates page loads successfully."""
        response = admin_session.get(CANDIDATES_URL)

        assert response.status_code == 200
        # Page should contain candidates table or candidates-related content
        assert "Candidates" in response.text or "candidates" in response.text.lower()

    def test_candidates_page_shows_table(self, admin_session):
        """Test that candidates page displays a data table."""
        response = admin_session.get(CANDIDATES_URL)

        assert response.status_code == 200
        # Should contain table element
        assert "<table" in response.text.lower()

    def test_candidates_page_has_add_button(self, admin_session):
        """Test that candidates page has an add button."""
        response = admin_session.get(CANDIDATES_URL)

        assert response.status_code == 200
        # Should have some kind of add functionality
        assert "add" in response.text.lower() or "new" in response.text.lower()


class TestCandidateEditing:
    """Test candidate editing functionality."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        session.post(LOGIN_URL, data={
            "login": "1",
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD
        }, allow_redirects=True)
        return session

    def test_edit_candidate_with_normal_data(self, admin_session):
        """Test editing a candidate with normal, safe data."""
        # Use candidate ID 18 which should exist in default data
        edit_data = {
            "edit": "1",
            "id": "18",
            "firstname": "John",
            "lastname": "Smith",
            "position": "9",
            "platform": "I support education reform and community development."
        }

        response = admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        # Should succeed and redirect or show success
        assert response.status_code == 200

        # Verify the change was applied by checking candidates page
        candidates_response = admin_session.get(CANDIDATES_URL)
        assert "John" in candidates_response.text
        assert "Smith" in candidates_response.text

    def test_edit_candidate_preserves_data(self, admin_session):
        """Test that edited data is correctly stored and displayed."""
        unique_name = "TestFunc"

        edit_data = {
            "edit": "1",
            "id": "18",
            "firstname": unique_name,
            "lastname": "FuncUser",
            "position": "9",
            "platform": "Platform for testing functionality."
        }

        response = admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)
        assert response.status_code == 200

        # Check AJAX endpoint to verify data was stored correctly
        row_response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "18"})
        assert row_response.status_code == 200

        # The response should contain our data
        assert unique_name in row_response.text


class TestCandidateAjaxEndpoint:
    """Test the AJAX endpoint for candidate data."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        session.post(LOGIN_URL, data={
            "login": "1",
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD
        }, allow_redirects=True)
        return session

    def test_candidates_row_returns_json(self, admin_session):
        """Test that candidates_row.php returns JSON data."""
        response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "18"})

        assert response.status_code == 200
        # Should return JSON
        try:
            data = response.json()
            assert "firstname" in data or "lastname" in data or "platform" in data or "canid" in data
        except:
            # If not JSON, it should at least contain candidate data
            assert "firstname" in response.text.lower() or response.text.strip() != ""

    def test_candidates_row_returns_correct_candidate(self, admin_session):
        """Test that AJAX endpoint returns data for the requested candidate."""
        # First set known data
        edit_data = {
            "edit": "1",
            "id": "19",
            "firstname": "AjaxTest",
            "lastname": "User",
            "position": "9",
            "platform": "Testing AJAX functionality."
        }
        admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)

        # Now request that candidate's data
        response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "19"})

        assert response.status_code == 200
        assert "AjaxTest" in response.text


class TestSpecialCharactersInContent:
    """Test that special characters are handled correctly (but safely displayed)."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        session.post(LOGIN_URL, data={
            "login": "1",
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD
        }, allow_redirects=True)
        return session

    def test_ampersand_in_name(self, admin_session):
        """Test that ampersand in name is handled correctly."""
        edit_data = {
            "edit": "1",
            "id": "20",
            "firstname": "Johnson",
            "lastname": "Smith",
            "position": "9",
            "platform": "Research & Development support."
        }

        response = admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)
        assert response.status_code == 200

        # Data should be stored
        candidates_response = admin_session.get(CANDIDATES_URL)
        assert response.status_code == 200
        # The name should appear (possibly with HTML entity encoding)
        assert "Johnson" in candidates_response.text

    def test_quotes_in_platform(self, admin_session):
        """Test that quotes in platform text are handled correctly."""
        edit_data = {
            "edit": "1",
            "id": "21",
            "firstname": "Mary",
            "lastname": "Johnson",
            "position": "9",
            "platform": 'I believe in "fair" treatment for all.'
        }

        response = admin_session.post(CANDIDATES_EDIT_URL, data=edit_data, allow_redirects=True)
        assert response.status_code == 200

        # Verify data is accessible
        row_response = admin_session.post(CANDIDATES_ROW_URL, data={"id": "21"})
        assert row_response.status_code == 200
