"""
Functionality tests for OceanWP theme AJAX endpoints.
These tests verify that the AJAX endpoints work correctly when accessed properly.
Tests should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os
import re

# WordPress configuration
WP_URL = os.environ.get("WP_URL", "http://localhost")
ADMIN_USER = os.environ.get("WP_ADMIN_USER", "admin")
ADMIN_PASS = os.environ.get("WP_ADMIN_PASS", "admin")


def get_wp_nonce(session, wp_url, nonce_action):
    """
    Fetch a valid WordPress nonce for the given action.
    This is needed for AJAX requests after the CSRF fix is applied.
    """
    # Get the admin page to extract nonce
    admin_response = session.get(f"{wp_url}/wp-admin/", timeout=30)

    # Try to get a generic ajax nonce from the admin page
    # WordPress embeds nonces in various places
    nonce_pattern = r'wp\.ajax\.settings\s*=\s*\{[^}]*"_nonce"\s*:\s*"([^"]+)"'
    match = re.search(nonce_pattern, admin_response.text)
    if match:
        return match.group(1)

    # Alternative: create a nonce via wp_ajax
    # WordPress allows creating nonces via admin-ajax with proper auth
    nonce_response = session.post(
        f"{wp_url}/wp-admin/admin-ajax.php",
        data={
            "action": "rest-nonce",
        },
        timeout=30
    )
    if nonce_response.status_code == 200 and len(nonce_response.text) < 20:
        return nonce_response.text.strip()

    return None


class TestWordPressSetup:
    """Tests to verify WordPress is set up correctly"""

    def test_wordpress_is_running(self):
        """Verify WordPress is accessible"""
        response = requests.get(f"{WP_URL}/", timeout=30)
        assert response.status_code == 200, "WordPress should be accessible"

    def test_admin_ajax_endpoint_exists(self):
        """Verify the admin-ajax.php endpoint exists"""
        response = requests.post(f"{WP_URL}/wp-admin/admin-ajax.php",
                                 data={"action": "heartbeat"},
                                 timeout=30)
        # Admin-ajax returns 200 even for unknown actions
        assert response.status_code == 200, "admin-ajax.php should be accessible"


class TestAJAXEndpointExists:
    """Tests to verify the OceanWP AJAX endpoints exist and respond"""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Set up session for each test"""
        self.session = requests.Session()
        self.admin_ajax_url = f"{WP_URL}/wp-admin/admin-ajax.php"

        # Log in as admin
        login_url = f"{WP_URL}/wp-login.php"
        login_data = {
            "log": ADMIN_USER,
            "pwd": ADMIN_PASS,
            "wp-submit": "Log In",
            "redirect_to": f"{WP_URL}/wp-admin/",
            "testcookie": "1"
        }

        # First, get the login page to set up cookies
        self.session.get(login_url, timeout=30)

        # Then submit login
        response = self.session.post(login_url, data=login_data, allow_redirects=True, timeout=30)

        # Verify we're logged in by checking for wp-admin access
        admin_response = self.session.get(f"{WP_URL}/wp-admin/", timeout=30)
        assert admin_response.status_code == 200, "Should be able to access wp-admin after login"

    def _endpoint_responds(self, action):
        """
        Test that an endpoint exists and responds.
        After the CSRF fix, endpoints require a valid nonce and will return 403/-1 without one.
        Both 200 (vulnerable) and 403 (fixed, missing nonce) indicate the endpoint exists.
        """
        response = self.session.post(
            self.admin_ajax_url,
            data={"action": action},
            timeout=30
        )
        # Endpoint exists if it returns:
        # - 200: endpoint works (vulnerable state or proper nonce provided)
        # - 403: endpoint exists but rejected due to nonce check (fixed state)
        # An unknown action would return 200 with "0" or empty response
        endpoint_exists = response.status_code in [200, 403]

        # If 200, also verify it's not just an empty/default response
        if response.status_code == 200:
            # Empty or "0" response typically means unknown action
            response_text = response.text.strip()
            # Valid responses include: JSON success, "-1" (nonce fail), actual content
            if response_text == "0":
                endpoint_exists = False

        return endpoint_exists, response.status_code

    def test_oceanwp_notice_button_click_endpoint_exists(self):
        """Test that oceanwp_notice_button_click endpoint exists and responds"""
        exists, status = self._endpoint_responds("oceanwp_notice_button_click")
        assert exists, f"Endpoint should exist and respond (got status {status})"

    def test_oceanwp_dismissed_notice_endpoint_exists(self):
        """Test that oceanwp_dismissed_notice endpoint exists"""
        exists, status = self._endpoint_responds("oceanwp_dismissed_notice")
        assert exists, f"Endpoint should exist and respond (got status {status})"

    def test_oceanwp_check_notice_actions_endpoint_exists(self):
        """Test that oceanwp_check_notice_actions endpoint exists"""
        exists, status = self._endpoint_responds("oceanwp_check_notice_actions")
        assert exists, f"Endpoint should exist and respond (got status {status})"

    def test_oceanwp_panel_notice_button_click_endpoint_exists(self):
        """Test that oceanwp_panel_notice_button_click endpoint exists"""
        exists, status = self._endpoint_responds("oceanwp_panel_notice_button_click")
        assert exists, f"Endpoint should exist and respond (got status {status})"


class TestNonAdminAccess:
    """Tests to verify non-admin users cannot access privileged endpoints"""

    def test_unauthenticated_user_cannot_trigger_actions(self):
        """
        Test that unauthenticated users cannot trigger plugin installation.
        This should return empty or error response.
        """
        session = requests.Session()
        response = session.post(
            f"{WP_URL}/wp-admin/admin-ajax.php",
            data={"action": "oceanwp_notice_button_click"},
            timeout=30
        )

        # For unauthenticated users, WordPress returns 0, empty response, or error status
        # This behavior is the same before and after fix
        # The endpoint should not return success with plugin installation
        response_text = response.text.strip()

        # Check if response indicates rejection (not a success)
        is_rejected = (
            response_text == "0" or
            response_text == "-1" or
            response_text == "" or
            response.status_code in [400, 401, 403]
        )

        # Also check if any JSON response indicates success (shouldn't happen)
        if response_text:
            try:
                json_response = response.json()
                if isinstance(json_response, dict) and json_response.get("success") == True:
                    if json_response.get("data", {}).get("status") == "active":
                        is_rejected = False
            except:
                # Non-JSON response is acceptable for unauth users
                pass

        assert is_rejected, \
            f"Unauthenticated users should not be able to trigger actions. Status: {response.status_code}, Response: {response_text[:200]}"


class TestThemeFilesExist:
    """Tests to verify the theme files are correctly installed"""

    def test_oceanwp_theme_active(self):
        """Verify OceanWP theme is installed by checking for theme-specific elements"""
        response = requests.get(f"{WP_URL}/", timeout=30)
        # OceanWP theme adds specific classes or elements we can check
        assert response.status_code == 200, "WordPress should be accessible"
        # The theme should be loaded - we just verify the site works
        assert len(response.text) > 0, "Page should have content"
