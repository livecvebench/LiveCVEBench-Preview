"""
Functionality tests for Tautulli image serving.
These tests verify that the application correctly serves legitimate images.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost:8181"
STARTUP_TIMEOUT = 60


def wait_for_server():
    """Wait for the Tautulli server to be ready."""
    start_time = time.time()
    while time.time() - start_time < STARTUP_TIMEOUT:
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302, 401]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure the server is ready before running tests."""
    if not wait_for_server():
        pytest.skip("Tautulli server not available")


class TestImageEndpointFunctionality:
    """Test that the /image endpoint serves valid images correctly."""

    def test_server_is_accessible(self):
        """Verify the Tautulli server is running and accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=10)
        assert response.status_code in [200, 302, 401], \
            f"Server not accessible, status code: {response.status_code}"

    def test_valid_image_path_returns_response(self):
        """Request a valid image path - should return some response."""
        # The images directory should exist and be accessible
        response = requests.get(f"{BASE_URL}/image/images/logo.png", timeout=10)
        # We accept 200 (image found) or empty/404 (image not present)
        # The key is the endpoint is reachable
        assert response.status_code in [200, 404, 500] or response.content == b'', \
            f"Unexpected response: {response.status_code}"

    def test_image_endpoint_basic_access(self):
        """Verify the /image endpoint is accessible."""
        response = requests.get(f"{BASE_URL}/image/test", timeout=10)
        # Should get some response from the endpoint
        assert response.status_code in [200, 404, 500] or response.content == b''

    def test_nested_image_path(self):
        """Test accessing nested image paths within the images directory."""
        response = requests.get(f"{BASE_URL}/image/images/icons/test.png", timeout=10)
        # Should return image or empty, not an error
        assert response.status_code in [200, 404] or response.content == b''

    def test_image_with_hash(self):
        """Test accessing an image by hash."""
        response = requests.get(f"{BASE_URL}/image/somehash.png", timeout=10)
        # Should handle gracefully (might not find image)
        assert response.status_code in [200, 404, 500] or response.content == b''

    def test_content_type_for_valid_image(self):
        """Verify proper content-type header for image requests."""
        response = requests.get(f"{BASE_URL}/image/images/logo.png", timeout=10)
        if response.status_code == 200 and len(response.content) > 0:
            content_type = response.headers.get('Content-Type', '')
            assert 'image' in content_type.lower() or content_type == '', \
                f"Unexpected content type: {content_type}"

    def test_legitimate_image_request_works(self):
        """Ensure legitimate image requests work (sanity check)."""
        response = requests.get(f"{BASE_URL}/image/images/logo.png", timeout=10)
        # Should either return an image or empty (if file doesn't exist)
        # Key thing is it shouldn't error
        assert response.status_code in [200, 404] or response.content == b''


class TestAPIEndpoints:
    """Test basic API functionality remains intact."""

    def test_root_endpoint(self):
        """Verify root endpoint is accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=10, allow_redirects=False)
        assert response.status_code in [200, 302, 303, 401]

    def test_api_endpoint_exists(self):
        """Test that API endpoints respond (even with auth required)."""
        # Try the status endpoint which typically doesn't require auth
        response = requests.get(f"{BASE_URL}/status", timeout=10)
        # Should get some response - 200, 401, 403, 404 are all acceptable
        # 400 is also acceptable if parameters are missing
        assert response.status_code in [200, 400, 401, 403, 404, 500]
