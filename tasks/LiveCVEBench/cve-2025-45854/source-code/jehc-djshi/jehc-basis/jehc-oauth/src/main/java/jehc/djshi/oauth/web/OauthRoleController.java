package jehc.djshi.oauth.web;
import java.util.ArrayList;
import java.util.List;
import java.util.HashMap;
import java.util.Map;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import jehc.djshi.common.annotation.Auth;
import jehc.djshi.common.base.*;
import jehc.djshi.common.entity.OauthAccountEntity;
import jehc.djshi.common.entity.RoleInfoEntity;
import jehc.djshi.common.idgeneration.UUID;
import jehc.djshi.common.util.JsonUtil;
import jehc.djshi.common.util.StringUtil;
import jehc.djshi.oauth.model.*;
import jehc.djshi.oauth.service.*;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.*;
import com.github.pagehelper.PageInfo;
import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
/**
 * @Desc 角色模块
 * @Author 邓纯杰
 * @CreateTime 2012-12-12 12:12:12
 */
@RestController
@RequestMapping("/oauthRole")
@Api(value = "授权中心角色模块API",tags = "授权中心角色模块API",description = "授权中心角色模块API")
public class OauthRoleController extends BaseAction {

	@Resource
	private OauthRoleService oauthRoleService;

	@Resource
	private OauthSysModeService oauthSysModeService;

	@Resource
	private OauthResourcesService oauthResourcesService;

	@Resource
	private OauthFunctionInfoService oauthFunctionInfoService;

	@Resource
	private OauthFunctionRoleService oauthFunctionRoleService;

	@Resource
	private OauthResourcesRoleService oauthResourcesRoleService;

	@Resource
	private OauthAccountRoleService oauthAccountRoleService;

	@Resource
	private OauthAccountTypeService oauthAccountTypeService;

	/**
	 * 查询角色列表并分页
	 * @param baseSearch
	 * @param delFlag
	 * @return
	 */
	@ApiOperation(value="查询角色列表并分页", notes="查询角色列表并分页")
	@PostMapping(value="/list")
	@Auth(value = "/oauthRole/list",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BasePage<List<OauthRole>> getOauthRoleListByCondition(@RequestBody BaseSearch baseSearch, String delFlag ){
		Map<String, Object> condition = baseSearch.convert();
		condition.put("delFlag", delFlag);
		commonHPager(baseSearch);
		List<OauthRole> oauthRoleList = oauthRoleService.getOauthRoleListByCondition(condition);
		for(OauthRole oauthRole:oauthRoleList){
			if(!StringUtil.isEmpty(oauthRole.getCreateId())){
				OauthAccountEntity createBy = getAccount(oauthRole.getCreateId());
				if(null != createBy){
					oauthRole.setCreateBy(createBy.getName());
				}
			}
			if(!StringUtil.isEmpty(oauthRole.getUpdateId())){
				OauthAccountEntity modifiedBy = getAccount(oauthRole.getUpdateId());
				if(null != modifiedBy){
					oauthRole.setModifiedBy(modifiedBy.getName());
				}
			}
		}
		PageInfo<OauthRole> page = new PageInfo<OauthRole>(oauthRoleList);
		return outPageBootStr(page,baseSearch);
	}

	/**
	* 查询单个角色
	* @param id
	*/
	@ApiOperation(value="查询单个角色", notes="查询单个角色")
	@GetMapping(value="/get/{id}")
	@Auth(value = "/oauthRole/get",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult<OauthRole> getOauthRoleById(@PathVariable("id")String id){
		OauthRole oauthRole = oauthRoleService.getOauthRoleById(id);
		if(!StringUtil.isEmpty(oauthRole.getCreateId())){
			OauthAccountEntity createBy = getAccount(oauthRole.getCreateId());
			if(null != createBy){
				oauthRole.setCreateBy(createBy.getName());
			}
		}
		if(!StringUtil.isEmpty(oauthRole.getUpdateId())){
			OauthAccountEntity modifiedBy = getAccount(oauthRole.getUpdateId());
			if(null != modifiedBy){
				oauthRole.setModifiedBy(modifiedBy.getName());
			}
		}
		return outDataStr(oauthRole);
	}

	/**
	* 添加
	* @param oauthRole 
	*/
	@ApiOperation(value="创建单个角色", notes="创建单个角色")
	@PostMapping(value="/add")
	public BaseResult addOauthRole(@RequestBody OauthRole oauthRole){
		int i = 0;
		if(null != oauthRole){
			i=oauthRoleService.addOauthRole(oauthRole);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}

	/**
	* 修改
	* @param oauthRole 
	*/
	@ApiOperation(value="编辑单个角色", notes="编辑单个角色")
	@PutMapping(value="/update")
	public BaseResult updateOauthRole(@RequestBody OauthRole oauthRole){
		int i = 0;
		if(null != oauthRole){
			i=oauthRoleService.updateOauthRole(oauthRole);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}

	/**
	* 删除
	* @param id
	*/
	@ApiOperation(value="删除角色", notes="删除角色")
	@DeleteMapping(value="/delete")
	public BaseResult delOauthRole(String id){
		int i = 0;
		if(!StringUtil.isEmpty(id)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id",id.split(","));
			i=oauthRoleService.delOauthRole(condition);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}

	/**
	 * 恢复
	 * @param id
	 * @return
	 */
	@PutMapping(value="/recover")
	@ApiOperation(value="恢复", notes="恢复")
	public BaseResult recoverOauthRole(String id){
		int i = 0;
		if(!StringUtil.isEmpty(id)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id",id.split(","));
			i=oauthRoleService.recoverOauthRole(condition);
		}
		if(i>0){
			return outAudStr(true);
		}else{
			return outAudStr(false);
		}
	}

	/**
	 * 读取所有资源
	 * @param request
	 */
	@ApiOperation(value="读取所有资源", notes="读取所有资源")
	@GetMapping(value="/resources")
	@Auth(value = "/oauthRole/resources",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getOauthResourcesListAll(HttpServletRequest request){
		//1获取所有菜单
		Map<String, Object> condition = new HashMap<String, Object>();
		String roleId = request.getParameter("roleId");
		String sysModeId = request.getParameter("sysModeId");
		String expanded = request.getParameter("expanded");
		String singleClickExpand = request.getParameter("singleClickExpand");
		List<BaseZTreeEntity> list = new ArrayList<BaseZTreeEntity>();
		condition.put("isSys", "0");
		condition.put("sysModeId", sysModeId);
		List<OauthResources> oauthResourcesList = oauthResourcesService.getOauthResourcesListAll(condition);
		condition = new HashMap<String, Object>();
		condition.put("isFilter", "1");
		List<OauthFunctionInfo> oauthFunctionInfoList = oauthFunctionInfoService.getOauthFunctionInfoList(condition);
		//2获取所有已权限菜单
		condition.put("roleId", roleId);
		condition.put("sysModeId", sysModeId);
		List<OauthResources> oauthResourcesRoleList = oauthResourcesService.getOauthResourcesListAll(condition);
		String resourcesId = resultOauthSourcesId(oauthResourcesRoleList);
		for(int i = 0; i < oauthResourcesList.size(); i++){
			OauthResources oauthResources = oauthResourcesList.get(i);
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(oauthResources.getId());
			BaseZTreeEntity.setPId(oauthResources.getParentId());
			BaseZTreeEntity.setText(oauthResources.getName());
			BaseZTreeEntity.setName(oauthResources.getName());
			if(resourcesId.indexOf(oauthResources.getId())<0){
				BaseZTreeEntity.setChecked(false);
			}else{
				BaseZTreeEntity.setChecked(true);
			}
//			if("0".equals(oauthResources.getResources_leaf())){
//				BaseZTreeEntity.setHasLeaf(false);
//			}else{
//				BaseZTreeEntity.setHasLeaf(true);
//				//当菜单为末级时判断是否存在功能
//				if(hasLeaf(oauthFunctionInfoList, oauthResources.getResources_id())){
//					BaseZTreeEntity.setHasLeaf(false);
//				}else{
//					BaseZTreeEntity.setHasLeaf(true);
//				}
//			}
//			BaseZTreeEntity.setIcon("../../../../deng/images/icons/"+xtMenuinfo.getXt_menuinfo_images());
			BaseZTreeEntity.setTempObject("Sources");
			if(("true").equals(expanded)){
				BaseZTreeEntity.setExpanded(true);
			}else{
				BaseZTreeEntity.setExpanded(false);
			}
			if("true".equals(singleClickExpand)){
				BaseZTreeEntity.setSingleClickExpand(true);
			}else{
				BaseZTreeEntity.setSingleClickExpand(false);
			}
			list.add(BaseZTreeEntity);
		}
		condition = new HashMap<String, Object>();
		condition.put("roleId", roleId.split(","));
		List<OauthFunctionRole> oauthFunctionRoleList = oauthFunctionRoleService.getOauthFunctionRoleListByCondition(condition);
		for(int i = 0; i < oauthFunctionInfoList.size(); i++){
			OauthFunctionInfo oauthFunctionInfo = oauthFunctionInfoList.get(i);
			BaseZTreeEntity BaseZTreeEntity = new BaseZTreeEntity();
			BaseZTreeEntity.setId(oauthFunctionInfo.getId()+"@"+oauthFunctionInfo.getResourcesId()+"@2");
			BaseZTreeEntity.setPId(oauthFunctionInfo.getResourcesId());
			BaseZTreeEntity.setText(oauthFunctionInfo.getName());
			BaseZTreeEntity.setName(oauthFunctionInfo.getName());
			BaseZTreeEntity.setIcon("/deng/images/icons/target_point.png");
			BaseZTreeEntity.setTempObject("Function");
			BaseZTreeEntity.setContent(""+oauthFunctionInfo.getName());
			BaseZTreeEntity.setIntegerappend(oauthFunctionInfo.getIsAuthority()+","+oauthFunctionInfo.getIsFilter());
			if(("true").equals(expanded)){
				BaseZTreeEntity.setExpanded(true);
			}else{
				BaseZTreeEntity.setExpanded(false);
			}
			if("true".equals(singleClickExpand)){
				BaseZTreeEntity.setSingleClickExpand(true);
			}else{
				BaseZTreeEntity.setSingleClickExpand(false);
			}
			for(OauthFunctionRole oauthFunctionRole:oauthFunctionRoleList){
				if(oauthFunctionRole.getFunctionInfoId().equals(oauthFunctionInfo.getId())){
					BaseZTreeEntity.setChecked(true);
					break;
				}
			}
			BaseZTreeEntity.setHasLeaf(true);
			list.add(BaseZTreeEntity);
		}


		BaseZTreeEntity baseZTreeEntity = new BaseZTreeEntity();
		List<BaseZTreeEntity> baseZTreeEntityList = baseZTreeEntity.buildTree(list,"0");
		String json = JsonUtil.toFastJson(baseZTreeEntityList);
		return outStr(json);

//		return outStr(BaseZTreeEntity.buildTree(list,true));
	}

	/**
	 * 判断资源下面是否有功能
	 * @param oauthFunctionInfoList
	 * @param resourcesId
	 * @return
	 */
	public boolean hasLeaf(List<OauthFunctionInfo> oauthFunctionInfoList,String resourcesId){
		boolean flag = false;
		for(int i = 0; i < oauthFunctionInfoList.size(); i++){
			if(oauthFunctionInfoList.get(i).getResourcesId().equals(resourcesId)){
				return true;
			}
		}
		return flag;
	}

	/**
	 * 解析已有权限资源ID编号
	 * @param oauthResourcesList
	 * @return
	 */
	public String resultOauthSourcesId(List<OauthResources> oauthResourcesList){
		StringBuffer ids = new StringBuffer();
		for(int i = 0; i < oauthResourcesList.size(); i++){
			OauthResources oauthResources = oauthResourcesList.get(i);
			if(null != ids){
				ids.append(","+oauthResources.getId());
			}else{
				ids.append(oauthResources.getId());
			}
		}
		return ids.toString();
	}

	/**
	 * 保存资源
	 * @param roleinfoEntity
	 */
	@ApiOperation(value="保存资源", notes="保存资源")
	@PutMapping(value="/saveOauthRR")
	public BaseResult saveOauthRR(@RequestBody RoleInfoEntity roleinfoEntity){
		int i = 0;
		List<OauthResourcesRole> oauthResourcesRoleList = new ArrayList<OauthResourcesRole>();
		List<OauthFunctionRole> oauthFunctionRoleList = new ArrayList<OauthFunctionRole>();
		if(!StringUtil.isEmpty(roleinfoEntity.getResourcesId())){
			String[] idList = roleinfoEntity.getResourcesId().split(",");
			for(int j = 0; j < idList.length; j++){
				if(idList[j].split("@").length == 1){
					//资源
					String uuid = UUID.toUUID();
					OauthResourcesRole oauthResourcesRole = new OauthResourcesRole();
					oauthResourcesRole.setResourcesId(idList[j]);
					oauthResourcesRole.setId(uuid);
					oauthResourcesRole.setRoleId(roleinfoEntity.getRoleId());
					oauthResourcesRoleList.add(oauthResourcesRole);
				}else{
					//功能
					String uuid = UUID.toUUID();
					OauthFunctionRole oauthFunctionRole = new OauthFunctionRole();
					oauthFunctionRole.setResourcesId(idList[j].split("@")[1]);
					oauthFunctionRole.setId(uuid);
					oauthFunctionRole.setRoleId(roleinfoEntity.getRoleId());
					oauthFunctionRole.setFunctionInfoId(idList[j].split("@")[0]);
					oauthFunctionRoleList.add(oauthFunctionRole);
				}
			}
		}
		i=oauthResourcesRoleService.addOauthResourcesRole(oauthResourcesRoleList,oauthFunctionRoleList,roleinfoEntity.getRoleId());
		if(i>0){
			return BaseResult.success();
		}else{
			return BaseResult.fail();
		}
	}

	/**
	 * 读取账户角色列表【账户对角色】
	 * @param baseSearch
	 */
	@ApiOperation(value="读取账户", notes="读取账户")
	@PostMapping(value="/account/list")
	@Auth(value = "/oauthRole/account/list",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BasePage getAccountListByCondition(@RequestBody BaseSearch baseSearch){
		Map<String, Object> condition = baseSearch.convert();
		if(null != baseSearch.ConvertToMap().get("accountTypeId")){
			condition.put("id", baseSearch.ConvertToMap().get("id"));
		}
		if("2".equals(condition.get("flag"))){
			//根据角色获取当前系统中隶属于其账户类型
			Map<String,Object> map = new HashMap<>();
			map.put("roleId",condition.get("roleId"));
			StringBuilder accountTypeIds = new StringBuilder();
			List<OauthAccountType> oauthAccountTypes = oauthAccountTypeService.getAccountTypeListByRoleId(map);
			if(!CollectionUtils.isEmpty(oauthAccountTypes)){
				for(OauthAccountType oauthAccountType: oauthAccountTypes){
					if(StringUtils.isEmpty(accountTypeIds.toString())){
						accountTypeIds.append(oauthAccountType.getId());
					}else{
						accountTypeIds.append(","+oauthAccountType.getId());
					}
				}
				condition.put("accountTypeIds",accountTypeIds.toString());
			}
		}
		commonHPager(baseSearch);
		List<OauthAccount> oauthAccountList = oauthAccountRoleService.getOauthARListByCondition(condition);
		PageInfo<OauthAccount> page = new PageInfo<OauthAccount>(oauthAccountList);
		return outPageBootStr(page,baseSearch);
	}

	/**
	 * 导入账户信息
	 * @param roleinfoEntity
	 */
	@ApiOperation(value="导入账户信息", notes="导入账户信息")
	@PostMapping(value="/addOauthAR")
	@Auth(value = "/oauthRole/addOauthAR",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult addOauthAR(@RequestBody RoleInfoEntity roleinfoEntity){
		List<OauthAccountRole> oauthAccountRoleList = new ArrayList<OauthAccountRole>();
		if(!StringUtil.isEmpty(roleinfoEntity.getAccountId()) && !StringUtil.isEmpty(roleinfoEntity.getRoleId())){
			String[] idList = roleinfoEntity.getAccountId().split(",");
			for(int j = 0; j < idList.length; j++){
				String uuid = UUID.toUUID();
				OauthAccountRole oauthAccountRole = new OauthAccountRole();
				oauthAccountRole.setAccountId(idList[j]);
				oauthAccountRole.setId(uuid);
				oauthAccountRole.setRoleId(roleinfoEntity.getRoleId());
				oauthAccountRoleList.add(oauthAccountRole);
			}
		}
		int i=oauthAccountRoleService.addOauthAccountRole(roleinfoEntity,oauthAccountRoleList);
		if(i>0){
			return outAudStr(true, "导入账户成功！");
		}else{
			return outAudStr(false, "导入账户失败！");
		}
	}

	/**
	 * 移除账户信息
	 * @param roleInfoEntity
	 */
	@ApiOperation(value="移除账户信息", notes="移除账户信息")
	@DeleteMapping(value="/delOauthAR")
	public BaseResult delOauthAR(RoleInfoEntity roleInfoEntity){
		Map<String, Object> condition = new HashMap<String, Object>();
		condition.put("accountId", roleInfoEntity.getAccountId().split(","));
		condition.put("roleId", roleInfoEntity.getRoleId());
		int i=oauthAccountRoleService.delOauthAccountRole(condition);
		if(i>0){
			return outAudStr(true, "移除账户成功！");
		}else{
			return outAudStr(false, "移除账户失败！");
		}
	}

	/**
	 * 查询指定用户全部角色
	 * @param accountId
	 * @return
	 */
	@ApiOperation(value="查询指定用户全部角色", notes="查询指定用户全部角色")
	@PostMapping(value="/roleList/{accountId}")
	@Auth(value = "/roleList/get",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getOauthRoleList(@PathVariable("accountId")String accountId){
		if(StringUtil.isEmpty(accountId)){
			return new BaseResult();
		}
		Map<String,Object> condition = new HashMap<>();
		condition.put("accountId",accountId);
		List<OauthAccountRole>  oauthAccountRoles = oauthAccountRoleService.getOauthAccountRoleListByCondition(condition);
		if(!CollectionUtils.isEmpty(oauthAccountRoles)){
			for(OauthAccountRole oauthAccountRole:oauthAccountRoles){
				OauthRole oauthRole = oauthRoleService.getOauthRoleById(oauthAccountRole.getRoleId());
				if(null != oauthRole){
					oauthAccountRole.setRoleName(oauthRole.getName());
				}
			}
		}
		return new BaseResult(oauthAccountRoles);
	}

	/**
	 * 角色树
	 */
	@ApiOperation(value="角色树列表", notes="角色树列表")
	@GetMapping(value="/trees")
	@Auth(value = "/roleList/trees",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getAllRoles(){
		Map<String,Object> condition = new HashMap<>();
		List<BaseJSTreeEntity> list = new ArrayList<BaseJSTreeEntity>();
		List<OauthRole> oauthRoles = oauthRoleService.getOauthRoleListByCondition(condition);

//		//1.筛选模块
//		List<OauthSysMode> oauthSysModes = oauthSysModeService.getOauthSysModeListByCondition(condition);
//		for(OauthSysMode oauthSysMode: oauthSysModes){
//			BaseJSTreeEntity baseJSTreeEntity = new BaseJSTreeEntity();
//			baseJSTreeEntity.setId(oauthSysMode.getSys_mode_id());
//			baseJSTreeEntity.setParent("0");
//			baseJSTreeEntity.setText(oauthSysMode.getSysname());
//			baseJSTreeEntity.setSingleClickExpand(true);
//			baseJSTreeEntity.setState(new BaseJSTreeStateEntity(false,false,false));
//			baseJSTreeEntity.setTempObject("SYSMODE");
//			list.add(baseJSTreeEntity);
//		}

		//2.筛选角色
		for(OauthRole oauthRole: oauthRoles){
			BaseJSTreeEntity baseJSTreeEntity = new BaseJSTreeEntity();
			baseJSTreeEntity.setId(oauthRole.getId());
//			baseJSTreeEntity.setParent(oauthRole.getSysmode_id());
			baseJSTreeEntity.setParent("0");
			baseJSTreeEntity.setText(oauthRole.getName());
			baseJSTreeEntity.setSingleClickExpand(true);
			baseJSTreeEntity.setTempObject("ROLE");
			list.add(baseJSTreeEntity);
		}
		BaseJSTreeEntity baseJSTreeEntity = new BaseJSTreeEntity();
		List<BaseJSTreeEntity> baseJSTreeEntitiesList = baseJSTreeEntity.buildTree(list,"0");
		return new BaseResult(JsonUtil.toFastJson(baseJSTreeEntitiesList));
	}

	/**
	 * 根据各种情况查找集合不分页（流程设计器中处理组 发起组等使用）
	 * @param roleId
	 * @return
	 */
	@ApiOperation(value="根据各种情况查找集合不分页", notes="根据各种情况查找集合不分页")
	@GetMapping(value="/list/{roleId}")
	@Auth(value = "/roleList/list/roleId",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	public BaseResult getXtPostList(@PathVariable("roleId")String roleId){
		List<OauthRole> list = new ArrayList<OauthRole>();
		if(!StringUtil.isEmpty(roleId)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("roleId", roleId);
			list = oauthRoleService.getOauthRoleListByCondition(condition);
		}
		return  outItemsStr(list);
	}
}
