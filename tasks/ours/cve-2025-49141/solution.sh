#!/bin/bash
# Solution script for HAXcms PHP command injection vulnerability
# This fix removes the vulnerable gitImportSite function from Operations.php
set -e
cd /var/www/html

OPERATIONS_FILE="/var/www/html/system/backend/php/lib/Operations.php"

# Verify the file exists
if [ ! -f "$OPERATIONS_FILE" ]; then
    echo "Error: Operations.php not found at $OPERATIONS_FILE"
    exit 1
fi

# Create backup
cp "$OPERATIONS_FILE" "${OPERATIONS_FILE}.bak"

# The fix: Remove the vulnerable gitImportSite function entirely
# The function spans from line ~2067 (OpenAPI doc) to line ~2174 (closing brace)
# We'll use PHP to safely remove it

php << 'PHPFIX'
<?php
$file = '/var/www/html/system/backend/php/lib/Operations.php';
$content = file_get_contents($file);

if ($content === false) {
    echo "Error: Could not read Operations.php\n";
    exit(1);
}

// Pattern to match the entire gitImportSite function including its OpenAPI documentation
// This matches from the OpenAPI @OA\Post annotation for gitImportSite through the function body
$pattern = '/\/\*\*\s*\n(?:\s*\*[^\n]*\n)*?\s*\*\s*@OA\\\\Post\(\s*\n\s*\*\s*path="\/gitImportSite"[^}]*?public function gitImportSite\(\)\s*\{[^}]*(?:\{[^}]*\}[^}]*)*\}\s*\n/s';

// First, let's try a simpler approach - find and remove the function
// Search for the gitImportSite OpenAPI block and function

// Find the start of gitImportSite documentation (search for @OA\Post with gitImportSite path)
$searchStart = 'path="/gitImportSite"';
$posPath = strpos($content, $searchStart);

if ($posPath === false) {
    echo "gitImportSite endpoint not found - may already be fixed\n";
    exit(0);
}

// Find the start of the docblock (go backwards to find /**)
$docStart = strrpos(substr($content, 0, $posPath), '/**');
if ($docStart === false) {
    echo "Could not find docblock start\n";
    exit(1);
}

// Find the function definition
$funcStart = strpos($content, 'public function gitImportSite()', $posPath);
if ($funcStart === false) {
    echo "Could not find gitImportSite function\n";
    exit(1);
}

// Find the end of the function - need to count braces
$searchPos = strpos($content, '{', $funcStart);
if ($searchPos === false) {
    echo "Could not find function body start\n";
    exit(1);
}

$braceCount = 1;
$pos = $searchPos + 1;
$len = strlen($content);

while ($pos < $len && $braceCount > 0) {
    $char = $content[$pos];
    if ($char === '{') {
        $braceCount++;
    } elseif ($char === '}') {
        $braceCount--;
    }
    $pos++;
}

if ($braceCount !== 0) {
    echo "Could not find matching brace\n";
    exit(1);
}

$funcEnd = $pos;

// Find the next newline after the closing brace
while ($funcEnd < $len && $content[$funcEnd] !== "\n") {
    $funcEnd++;
}
$funcEnd++; // Include the newline

// Remove the function (from docblock start to function end)
$before = substr($content, 0, $docStart);
$after = substr($content, $funcEnd);

// Add a comment indicating the function was removed
$replacement = "  // gitImportSite function removed for security - unsafe URL handling\n";

$newContent = $before . $replacement . $after;

// Write the modified content
if (file_put_contents($file, $newContent) === false) {
    echo "Error: Could not write to Operations.php\n";
    exit(1);
}

echo "Successfully removed gitImportSite function\n";
?>
PHPFIX

# Verify PHP syntax is still valid
php -l "$OPERATIONS_FILE"

# Verify the function was removed
if grep -q "function gitImportSite" "$OPERATIONS_FILE"; then
    echo "Warning: gitImportSite function may still be present"
    # Fallback: Comment out the dangerous line
    sed -i 's/@$repo->set_remote("origin", $repoUrl);/\/\/ PATCHED: @$repo->set_remote("origin", escapeshellarg($repoUrl));/' "$OPERATIONS_FILE"
    echo "Applied fallback patch to comment out dangerous set_remote call"
fi

echo "Fix applied successfully"
