#!/bin/bash
# Solution script to fix the output encoding vulnerability in UTM Grabber plugin
set -e

PLUGIN_FILE="/var/www/html/wp-content/plugins/handl-utm-grabber/handl-utm-grabber.php"

echo "Applying fix to UTM Grabber plugin..."

# Check if the plugin file exists
if [ ! -f "$PLUGIN_FILE" ]; then
    echo "Error: Plugin file not found at $PLUGIN_FILE"
    exit 1
fi

# Use PHP to apply the fix safely - this handles the complex regex patterns properly
php << 'PHPSCRIPT'
<?php
$plugin_file = '/var/www/html/wp-content/plugins/handl-utm-grabber/handl-utm-grabber.php';
$content = file_get_contents($plugin_file);

if ($content === false) {
    echo "Error: Could not read plugin file\n";
    exit(1);
}

// Fix 1: Replace the main shortcode handler
// Original: add_shortcode($field, function() use ($field) {return urldecode($_COOKIE[$field]);});
$old1 = 'add_shortcode($field, function() use ($field) {return urldecode($_COOKIE[$field]);});';
$new1 = 'add_shortcode($field, function() use ($field) {
			if (!isset($_COOKIE[$field])) {
				return \'\';
			}
			return esc_html($_COOKIE[$field]);
		});';
$content = str_replace($old1, $new1, $content);

// Fix 2: Replace the _i shortcode handler
// Original: add_shortcode($field."_i", function($atts,$content) use ($field) {return sprintf($content,urldecode($_COOKIE[preg_replace("/_i$/","",$field)]));});
$old2 = 'add_shortcode($field."_i", function($atts,$content) use ($field) {return sprintf($content,urldecode($_COOKIE[preg_replace("/_i$/","",$field)]));});';
$new2 = 'add_shortcode($field."_i", function($atts,$content) use ($field) {
			$clean_field = preg_replace("/_i$/", "", $field);
			if (!isset($_COOKIE[$clean_field])) {
				return \'\';
			}
			return sprintf($content, esc_html($_COOKIE[$clean_field]));
		});';
$content = str_replace($old2, $new2, $content);

// Fix 3: Replace the Gravity Forms filter
// Original: add_filter( 'gform_field_value_'.$field, function() use ($field) {return urldecode($_COOKIE[$field]); } );
$old3 = "add_filter( 'gform_field_value_'.\$field, function() use (\$field) {return urldecode(\$_COOKIE[\$field]); } );";
$new3 = "add_filter( 'gform_field_value_'.\$field, function() use (\$field) {
			if (!isset(\$_COOKIE[\$field])) {
				return '';
			}
			return esc_html(\$_COOKIE[\$field]);
		});";
$content = str_replace($old3, $new3, $content);

// Write the fixed content back
if (file_put_contents($plugin_file, $content) === false) {
    echo "Error: Could not write to plugin file\n";
    exit(1);
}

echo "Fix applied successfully!\n";
echo "Changes made:\n";
echo "  - Replaced urldecode() with esc_html() in main shortcode handler\n";
echo "  - Replaced urldecode() with esc_html() in _i shortcode handler\n";
echo "  - Replaced urldecode() with esc_html() in Gravity Forms filter\n";
echo "  - Added null checks for cookie values\n";
?>
PHPSCRIPT

echo "Fix complete."
