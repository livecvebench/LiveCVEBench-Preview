#!/bin/bash
set -e

# Apply fix to Hush Framework's Util.php hostname() function
# The function needs to validate and sanitize hostname values to prevent injection attacks

UTIL_FILE="/app/hush-lib/Hush/Util.php"

echo "Applying fix to $UTIL_FILE..."

if [ ! -f "$UTIL_FILE" ]; then
    echo "Error: File not found: $UTIL_FILE"
    exit 1
fi

# Create a temporary PHP script to apply the fix
cat > /tmp/apply_fix.php << 'PHPEOF'
<?php
$file = "/app/hush-lib/Hush/Util.php";

if (!file_exists($file)) {
    echo "Error: File not found: $file\n";
    exit(1);
}

$content = file_get_contents($file);

// Fixed version of the hostname() function with input validation and HTML encoding
$fixed_function = '	public static function hostname ()
	{
		$hostname = null;

		if (isset($_SERVER["HOST"])) $hostname = $_SERVER["HOST"];
		elseif (isset($_SERVER["HOSTNAME"])) $hostname = $_SERVER["HOSTNAME"];
		elseif (isset($_SERVER["SERVER_NAME"])) $hostname = $_SERVER["SERVER_NAME"];
		elseif (isset($_SERVER["SERVER_ADDR"])) $hostname = $_SERVER["SERVER_ADDR"];
		else return "localhost";

		// Validate hostname format - only allow valid hostname characters
		if (!preg_match(\'/^[a-zA-Z0-9.-]+(:[0-9]+)?$/\', $hostname)) {
			return "localhost";
		}

		// HTML-encode to prevent XSS when output in HTML context
		return htmlspecialchars($hostname, ENT_QUOTES, "UTF-8");
	}';

// Find and replace the hostname function using line-based approach
$lines = explode("\n", $content);
$output = [];
$inFunction = false;
$braceCount = 0;
$functionFound = false;

for ($i = 0; $i < count($lines); $i++) {
    $line = $lines[$i];

    if (!$inFunction && preg_match('/public\s+static\s+function\s+hostname\s*\(/', $line)) {
        $inFunction = true;
        $braceCount = 0;
        $functionFound = true;
    }

    if ($inFunction) {
        $braceCount += substr_count($line, '{') - substr_count($line, '}');
        if ($braceCount <= 0 && strpos($line, '}') !== false) {
            // End of function found, insert the fixed function
            $output[] = $fixed_function;
            $inFunction = false;
            continue;
        }
        // Skip lines inside the old function
        continue;
    }

    $output[] = $line;
}

if (!$functionFound) {
    echo "Error: hostname() function not found in file\n";
    exit(1);
}

$newContent = implode("\n", $output);
file_put_contents($file, $newContent);
echo "Fix applied successfully to hostname() function\n";
?>
PHPEOF

# Run the PHP script
php /tmp/apply_fix.php

# Cleanup
rm -f /tmp/apply_fix.php

echo "Fix applied successfully!"
