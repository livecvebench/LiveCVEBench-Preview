#!/bin/bash
# Solution script for type confusion vulnerability in @digitalocean/do-markdownit
# This fixes the validation logic in callout and fence_environment plugins
set -e

cd /app

echo "=== Applying fix for type confusion vulnerability ==="

# File paths for the vulnerable files
CALLOUT_FILE="/app/node_modules/@digitalocean/do-markdownit/rules/embeds/callout.js"
FENCE_ENV_FILE="/app/node_modules/@digitalocean/do-markdownit/modifiers/fence_environment.js"

# Fix 1: callout.js - Add Array.isArray() check that BLOCKS when not array
# The vulnerability: when allowedClasses is a string, .includes() performs substring matching
# The fix: If allowedClasses exists but is NOT an array, block the class (secure default)
# If it IS an array, use .includes() for exact matching
echo "Fixing callout.js..."

if [ -f "$CALLOUT_FILE" ]; then
    # Replace the vulnerable line with the fixed version
    # Original: if (optsObj.allowedClasses && !optsObj.allowedClasses.includes(className)) return false;
    # Fixed:    if (optsObj.allowedClasses && (!Array.isArray(optsObj.allowedClasses) || !optsObj.allowedClasses.includes(className))) return false;
    sed -i 's/if (optsObj\.allowedClasses && !optsObj\.allowedClasses\.includes(className)) return false;/if (optsObj.allowedClasses \&\& (!Array.isArray(optsObj.allowedClasses) || !optsObj.allowedClasses.includes(className))) return false;/' "$CALLOUT_FILE"
    echo "  - Fixed allowedClasses validation in callout.js"
else
    echo "  - WARNING: callout.js not found at expected location"
fi

# Fix 2: fence_environment.js - Add Array.isArray() check that BLOCKS when not array
# Same issue: string .includes() does substring matching, array .includes() does exact matching
# Same fix: If allowedEnvironments exists but is NOT an array, block the environment
echo "Fixing fence_environment.js..."

if [ -f "$FENCE_ENV_FILE" ]; then
    # Replace the vulnerable line with the fixed version
    # Original: if (!name || (optsObj.allowedEnvironments && !optsObj.allowedEnvironments.includes(name)))
    # Fixed:    if (!name || (optsObj.allowedEnvironments && (!Array.isArray(optsObj.allowedEnvironments) || !optsObj.allowedEnvironments.includes(name))))
    sed -i 's/if (!name || (optsObj\.allowedEnvironments && !optsObj\.allowedEnvironments\.includes(name)))/if (!name || (optsObj.allowedEnvironments \&\& (!Array.isArray(optsObj.allowedEnvironments) || !optsObj.allowedEnvironments.includes(name))))/' "$FENCE_ENV_FILE"
    echo "  - Fixed allowedEnvironments validation in fence_environment.js"
else
    echo "  - WARNING: fence_environment.js not found at expected location"
fi

echo ""
echo "=== Fix applied successfully ==="
echo "The validation logic now ensures that allowedClasses and allowedEnvironments"
echo "are blocked when configured as strings (type confusion attack prevented)"
echo "and properly validated when configured as arrays."
