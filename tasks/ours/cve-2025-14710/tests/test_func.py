"""
Functionality tests for the Hotel Order List API.
These tests verify that the order listing functionality works correctly
with valid inputs. Should PASS in both vulnerable and fixed states.
"""
import requests
import pytest
import time

BASE_URL = "http://localhost"
API_ENDPOINT = f"{BASE_URL}/controller/api/orderList.php"

# Known valid telephone numbers from the sample database
VALID_TELEPHONES = ["15757118111", "15757118174", "15757118133"]


@pytest.fixture(scope="module")
def wait_for_server():
    """Wait for the web server to be ready"""
    for i in range(30):
        try:
            response = requests.get(BASE_URL, timeout=2)
            return True
        except requests.exceptions.RequestException:
            time.sleep(1)
    pytest.fail("Web server did not become ready in time")


class TestOrderListFunctionality:
    """Test basic order listing functionality"""

    def test_order_list_with_valid_telephone(self, wait_for_server):
        """Test that valid telephone returns orders correctly"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        assert "data" in data

    def test_order_list_another_valid_telephone(self, wait_for_server):
        """Test with another valid telephone from database"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118174",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert response.status_code == 200
        data = response.json()
        # May return 200 with data or 201 if user doesn't exist
        assert data["code"] in [200, 201]

    def test_order_list_empty_telephone_rejected(self, wait_for_server):
        """Test that empty telephone is rejected"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "",
            "page": "1",
            "size": "10"
        }, timeout=10)

        data = response.json()
        # Empty telephone should be rejected
        assert data["code"] == 201

    def test_order_list_with_pagination(self, wait_for_server):
        """Test that pagination parameters work"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111",
            "page": "1",
            "size": "5"
        }, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200
        # Verify data is returned (might be empty list or orders)
        assert "data" in data

    def test_order_list_with_order_type(self, wait_for_server):
        """Test filtering by order type"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111",
            "page": "1",
            "size": "10",
            "orderType": "1"
        }, timeout=10)

        assert response.status_code == 200
        data = response.json()
        # Should succeed even if no orders match the type
        assert data["code"] == 200

    def test_order_list_page_two(self, wait_for_server):
        """Test accessing second page of results"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111",
            "page": "2",
            "size": "5"
        }, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert data["code"] == 200

    def test_api_returns_json(self, wait_for_server):
        """Test that API returns valid JSON"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111",
            "page": "1",
            "size": "10"
        }, timeout=10)

        # Should be able to parse as JSON
        try:
            data = response.json()
            assert "code" in data
        except ValueError:
            pytest.fail("API did not return valid JSON")

    def test_nonexistent_telephone_handled(self, wait_for_server):
        """Test that non-existent but valid format telephone is handled"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "11111111111",  # Valid format but doesn't exist
            "page": "1",
            "size": "10"
        }, timeout=10)

        data = response.json()
        # Should return error code since user doesn't exist
        assert data["code"] == 201
