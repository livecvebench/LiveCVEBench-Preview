#!/bin/bash
set -e
cd /app

BUNDLE_FILE="/app/node_modules/expr-eval/dist/bundle.js"

# Check if the file exists
if [ ! -f "$BUNDLE_FILE" ]; then
    echo "Error: bundle.js not found at $BUNDLE_FILE"
    exit 1
fi

# Check if fix has already been applied (idempotent)
if grep -q "prototype access detected" "$BUNDLE_FILE"; then
    echo "Fix already applied"
    exit 0
fi

# Apply the fix: Add prototype access check after the IVAR type check
# The fix blocks access to dangerous property names: __proto__, prototype, constructor
# These properties can be used for prototype pollution attacks

sed -i '/} else if (type === IVAR) {/a\
        if (/^__proto__|prototype|constructor$/.test(item.value)) {\
          throw new Error('\''prototype access detected'\'');\
        }' "$BUNDLE_FILE"

# Verify the fix was applied
if grep -q "prototype access detected" "$BUNDLE_FILE"; then
    echo "Fix applied successfully"
else
    echo "Error: Fix was not applied correctly"
    exit 1
fi
