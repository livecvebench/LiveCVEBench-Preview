#!/bin/bash
#
# Solution script for CVE-2025-5896
# Fixes ReDoS vulnerability in css-to-react-native package
#
# The fix adds negative lookbehind assertions to regex patterns to prevent
# catastrophic backtracking on pathological inputs.
#
set -e

echo "=== Applying fix for regex performance issue ==="

cd /app/packages/css-to-react-native

# ============================================================================
# Fix 1: packages/css-to-react-native/src/index.js
# ============================================================================
# Change line 60: /(\d+)px/.test(value) -> /(?<!\d)(\d+)px/.test(value)
# Change line 62: value.replace(/(\d+)px/g, '$1PX') -> value.replace(/(?<!\d)(\d+)px/g, '$1PX')
#
# The fix adds negative lookbehind (?<!\d) to establish a clear boundary,
# preventing the regex engine from backtracking through digit sequences.

echo "Fixing src/index.js..."

# Use cat with heredoc to ensure exact content replacement
# First, read the current file and make the specific replacements
cat > /tmp/fix_index.js << 'SCRIPT'
const fs = require('fs');
const filePath = '/app/packages/css-to-react-native/src/index.js';
let content = fs.readFileSync(filePath, 'utf8');

// Fix the .test() call on line 60
content = content.replace(
    /\/\(\\d\+\)px\/\.test\(value\)/g,
    '/(?<!\\d)(\\d+)px/.test(value)'
);

// Fix the .replace() call on line 62
content = content.replace(
    /value\.replace\(\/\(\\d\+\)px\/g,\s*'\$1PX'\)/g,
    "value.replace(/(?<!\\d)(\\d+)px/g, '$1PX')"
);

fs.writeFileSync(filePath, content);
console.log('Fixed src/index.js');
SCRIPT

node /tmp/fix_index.js

# ============================================================================
# Fix 2: packages/css-to-react-native/src/transforms/rem.js
# ============================================================================
# Change: /(\d*\.?\d+)rem/g -> /(?<!\d)((?:\d*\.\d+)|\d+)rem/g
#
# The original pattern has nested optionality (\d*\.?\d+) that causes
# exponential backtracking. The fix:
# 1. Adds negative lookbehind (?<!\d) for boundary
# 2. Uses explicit alternation ((?:\d*\.\d+)|\d+) instead of optional matching

echo "Fixing src/transforms/rem.js..."

cat > /app/packages/css-to-react-native/src/transforms/rem.js << 'EOF'
export const remToPx = value => {
  return value.replace(/(?<!\d)((?:\d*\.\d+)|\d+)rem/g, (match, m1) => parseFloat(m1, 10) * 16 + 'px')
}
EOF

echo "Fixed src/transforms/rem.js"

# ============================================================================
# Rebuild the package
# ============================================================================
# CRITICAL: The main entry point is dist/index.js, not src/index.js
# The package must be rebuilt for changes to take effect
#
# NOTE: We run the build commands directly because the package.json scripts
# use pnpm which may not be available in all environments. The build process is:
# 1. Clean: rimraf ./dist
# 2. Build: babel src --ignore *.spec.js --out-dir ./dist

echo ""
echo "=== Rebuilding package ==="
cd /app/packages/css-to-react-native

# Clean the dist directory
echo "Cleaning dist directory..."
./node_modules/.bin/rimraf ./dist

# Run babel to transpile src to dist
echo "Transpiling with babel..."
./node_modules/.bin/babel src --ignore "*.spec.js" --out-dir ./dist

echo ""
echo "=== Fix applied successfully ==="
echo "The regex patterns have been optimized with negative lookbehind assertions"
echo "to prevent catastrophic backtracking on pathological inputs."
