"""
Functionality tests for BentoML service.

These tests verify that the BentoML service works correctly for normal operations.
Should PASS in both vulnerable and fixed states.
"""
import pytest
import requests
import time

BASE_URL = "http://localhost:3000"


def wait_for_service(url: str, timeout: int = 60, interval: float = 1.0):
    """Wait for service to become available."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(url, timeout=5)
            if response.status_code in [200, 404]:
                return True
        except requests.exceptions.ConnectionError:
            pass
        except requests.exceptions.Timeout:
            pass
        time.sleep(interval)
    raise TimeoutError(f"Service at {url} did not become available within {timeout}s")


@pytest.fixture(scope="module", autouse=True)
def ensure_service_ready():
    """Ensure the BentoML service is ready before running tests."""
    wait_for_service(BASE_URL)


class TestServiceHealth:
    """Test service health and basic availability."""

    def test_service_root_endpoint(self):
        """Verify root endpoint responds successfully."""
        response = requests.get(f"{BASE_URL}/", timeout=10)
        assert response.status_code == 200

    def test_service_health_head_request(self):
        """Verify HEAD request to root works."""
        response = requests.head(f"{BASE_URL}/", timeout=10)
        assert response.status_code == 200


class TestEchoEndpoint:
    """Test the /echo endpoint functionality."""

    def test_echo_with_json_content_type(self):
        """Verify echo endpoint works with JSON content type."""
        response = requests.post(
            f"{BASE_URL}/echo",
            json={"text": "Hello, World!"},
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200
        assert "Hello" in response.text or "Echo" in response.text

    def test_echo_default_value(self):
        """Verify echo endpoint works with default value."""
        response = requests.post(
            f"{BASE_URL}/echo",
            json={},
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200

    def test_echo_various_strings(self):
        """Verify echo works with various string inputs."""
        test_strings = [
            "simple text",
            "123456",
            "special chars: !@#$%^&*()",
            "unicode: \u4e2d\u6587 \u65e5\u672c\u8a9e",
            "",
        ]
        for text in test_strings:
            response = requests.post(
                f"{BASE_URL}/echo",
                json={"text": text},
                headers={"Content-Type": "application/json"},
                timeout=10
            )
            assert response.status_code == 200


class TestProcessEndpoint:
    """Test the /process endpoint functionality."""

    def test_process_simple_dict(self):
        """Verify process endpoint handles simple dict."""
        response = requests.post(
            f"{BASE_URL}/process",
            json={"data": {"key": "value"}},
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200
        result = response.json()
        assert "status" in result or "processed" in response.text.lower()

    def test_process_nested_dict(self):
        """Verify process endpoint handles nested dict."""
        response = requests.post(
            f"{BASE_URL}/process",
            json={"data": {"level1": {"level2": {"level3": "value"}}}},
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200

    def test_process_empty_dict(self):
        """Verify process endpoint handles empty dict."""
        response = requests.post(
            f"{BASE_URL}/process",
            json={"data": {}},
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200


class TestContentTypeHandling:
    """Test that various valid content types work correctly."""

    def test_json_content_type_with_charset(self):
        """Verify JSON with charset works."""
        response = requests.post(
            f"{BASE_URL}/echo",
            json={"text": "test"},
            headers={"Content-Type": "application/json; charset=utf-8"},
            timeout=10
        )
        assert response.status_code == 200

    def test_json_content_type_explicit(self):
        """Verify explicit application/json works."""
        response = requests.post(
            f"{BASE_URL}/echo",
            data='{"text": "test"}',
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200
