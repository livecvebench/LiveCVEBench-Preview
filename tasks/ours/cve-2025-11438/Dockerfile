FROM php:8.3-cli

WORKDIR /var/www/html

# System dependencies - tmux, asciinema, curl required
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    curl \
    tmux \
    asciinema \
    libpq-dev \
    libzip-dev \
    libpng-dev \
    libicu-dev \
    libjpeg-dev \
    libfreetype6-dev \
    postgresql-client \
    redis-tools \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install pdo_pgsql bcmath gd intl zip pcntl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Redis PHP extension from source
RUN curl -L -o /tmp/redis.tar.gz https://github.com/phpredis/phpredis/archive/refs/tags/6.0.2.tar.gz \
    && mkdir -p /tmp/redis \
    && tar -xzf /tmp/redis.tar.gz -C /tmp/redis --strip-components=1 \
    && cd /tmp/redis \
    && phpize \
    && ./configure \
    && make \
    && make install \
    && docker-php-ext-enable redis \
    && rm -rf /tmp/redis /tmp/redis.tar.gz

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Clone OpnForm v1.9.3 and remove git history (prevents solution leakage)
RUN git clone --branch v1.9.3 --depth 1 https://github.com/JhumanJ/OpnForm.git . \
    && rm -rf .git

# Install PHP dependencies
WORKDIR /var/www/html/api
RUN composer install --no-dev --optimize-autoloader --ignore-platform-reqs

# Create storage directories and set permissions
RUN mkdir -p storage/framework/{sessions,views,cache} storage/logs bootstrap/cache \
    && chmod -R 775 storage bootstrap/cache

# Copy .env.example to .env and generate app key
RUN cp .env.example .env 2>/dev/null || touch .env

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV APP_NAME=OpnForm
ENV APP_ENV=local
ENV APP_DEBUG=true
ENV APP_URL=http://localhost:8000
ENV SELF_HOSTED=true
ENV THROTTLE_DISABLED=true

ENV DB_CONNECTION=pgsql
ENV DB_HOST=postgres
ENV DB_PORT=5432
ENV DB_DATABASE=opnform
ENV DB_USERNAME=opnform
ENV DB_PASSWORD=secret

ENV CACHE_DRIVER=redis
ENV SESSION_DRIVER=redis
ENV QUEUE_CONNECTION=sync

ENV REDIS_HOST=redis
ENV REDIS_PASSWORD=null
ENV REDIS_PORT=6379

ENV LOG_CHANNEL=stderr
ENV LOG_LEVEL=debug

# CMD ["/entrypoint.sh"]
