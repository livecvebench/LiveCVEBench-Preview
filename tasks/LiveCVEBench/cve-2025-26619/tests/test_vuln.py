"""
Vulnerability tests for CVE-2025-26619.
These tests verify the vulnerability status of the getScale function.

In VULNERABLE state: Tests should FAIL (function arguments are accepted and returned)
In FIXED state: Tests should PASS (function arguments return undefined)
"""
import subprocess
import pytest
import os

# Path to the test helper script
TEST_HELPER_DIR = "/tests"


class TestGetScaleFunctionArgument:
    """
    Test that getScale properly rejects function arguments.

    The vulnerability allows passing arbitrary functions to getScale(),
    which then returns them directly. This enables calling window functions
    like setTimeout with attacker-controlled arguments.
    """

    def test_getscale_rejects_anonymous_function(self):
        """
        Test that getScale returns undefined when an anonymous function is passed.

        In vulnerable version: returns the function
        In fixed version: returns undefined
        """
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "anonymous_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for function" in result.stdout, \
            f"getScale should return undefined for function arguments. Got: {result.stdout}"

    def test_getscale_rejects_arrow_function(self):
        """
        Test that getScale returns undefined when an arrow function is passed.

        Arrow functions are commonly used in attack payloads.
        """
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "arrow_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for arrow function" in result.stdout, \
            f"getScale should return undefined for arrow functions. Got: {result.stdout}"

    def test_getscale_rejects_named_function(self):
        """
        Test that getScale returns undefined when a named function is passed.
        """
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "named_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for named function" in result.stdout, \
            f"getScale should return undefined for named functions. Got: {result.stdout}"

    def test_getscale_rejects_builtin_function(self):
        """
        Test that getScale returns undefined when a built-in function like setTimeout is passed.

        This is the actual attack vector - passing event.view.setTimeout.
        """
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "builtin_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for builtin function" in result.stdout, \
            f"getScale should return undefined for built-in functions. Got: {result.stdout}"

    def test_getscale_rejects_constructor_function(self):
        """
        Test that getScale returns undefined when a constructor function is passed.
        """
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "constructor_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for constructor" in result.stdout, \
            f"getScale should return undefined for constructor functions. Got: {result.stdout}"

    def test_getscale_rejects_bound_function(self):
        """
        Test that getScale returns undefined when a bound function is passed.

        Bound functions (created with .bind()) are still functions.
        """
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "bound_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for bound function" in result.stdout, \
            f"getScale should return undefined for bound functions. Got: {result.stdout}"


class TestScaleFunctionIntegration:
    """
    Integration tests for the scale() expression function behavior.

    These tests verify that the scale() function properly handles invalid inputs
    without executing them as callable functions.
    """

    def test_scale_does_not_invoke_function_argument(self):
        """
        Test that calling scale() with a function argument does not invoke that function.

        In vulnerable version: the function is invoked with the second argument
        In fixed version: the function is not invoked
        """
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_scale_invocation.js"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: function not invoked" in result.stdout, \
            f"scale() should not invoke function arguments. Got: {result.stdout}"


class TestMultipleFunctionTypes:
    """
    Test various function types to ensure comprehensive protection.
    """

    def test_async_function_rejected(self):
        """Test that async functions are rejected."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "async_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for async function" in result.stdout, \
            f"getScale should return undefined for async functions. Got: {result.stdout}"

    def test_generator_function_rejected(self):
        """Test that generator functions are rejected."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "generator_function"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for generator function" in result.stdout, \
            f"getScale should return undefined for generator functions. Got: {result.stdout}"

    def test_class_method_rejected(self):
        """Test that class methods are rejected."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_vuln_function_arg.js", "class_method"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for class method" in result.stdout, \
            f"getScale should return undefined for class methods. Got: {result.stdout}"
