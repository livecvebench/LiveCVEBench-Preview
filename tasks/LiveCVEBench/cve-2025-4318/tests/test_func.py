"""
Functionality tests for the Amplify code generator.

These tests verify that the code generator works correctly for legitimate
component schemas. They should PASS in both vulnerable and fixed states.
"""

import subprocess
import json
import os
import pytest


class TestCodeGeneratorFunctionality:
    """Test that the code generator produces valid output for safe components."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Set up test environment."""
        self.app_dir = "/workspace"
        self.package_dir = os.path.join(self.app_dir, "packages", "codegen-ui-react")

    def run_codegen_test(self, component_json):
        """
        Run a code generation test with the given component JSON.
        Returns the generated code output.
        """
        # Create a test script that uses the code generator
        test_script = f"""
const {{ AmplifyRenderer }} = require('{self.package_dir}');

const component = {json.dumps(component_json)};

try {{
    const renderer = new AmplifyRenderer(component, {{}});
    const result = renderer.renderComponent();
    console.log(JSON.stringify({{
        success: true,
        componentText: result.componentText || '',
        declaration: result.declaration || ''
    }}));
}} catch (error) {{
    console.log(JSON.stringify({{
        success: false,
        error: error.message
    }}));
}}
"""
        result = subprocess.run(
            ["node", "-e", test_script],
            capture_output=True,
            text=True,
            cwd=self.app_dir,
            timeout=30
        )

        if result.returncode != 0:
            # Try to parse any output, or return error
            if result.stdout.strip():
                try:
                    return json.loads(result.stdout.strip())
                except json.JSONDecodeError:
                    pass
            return {"success": False, "error": result.stderr or "Unknown error"}

        try:
            return json.loads(result.stdout.strip())
        except json.JSONDecodeError:
            return {"success": False, "error": f"Invalid JSON output: {result.stdout}"}

    def test_simple_property_binding(self):
        """Test that simple property bindings work correctly."""
        component = {
            "id": "test-001",
            "name": "SimpleComponent",
            "componentType": "Text",
            "schemaVersion": "1.0",
            "properties": {
                "content": {
                    "bindingProperties": {
                        "property": "user",
                        "field": "name"
                    }
                }
            },
            "bindingProperties": {
                "user": {
                    "type": "Data",
                    "bindingProperties": {
                        "model": "User"
                    }
                }
            },
            "variants": [],
            "overrides": {},
            "children": []
        }

        result = self.run_codegen_test(component)

        # Either successful generation or graceful error handling is acceptable
        # The key is that the generator doesn't crash
        assert result is not None, "Code generator returned no result"

        if result.get("success"):
            # If generation succeeded, verify the output contains expected patterns
            output = result.get("componentText", "") + result.get("declaration", "")
            # Should contain the component name or function
            assert "SimpleComponent" in output or "function" in output.lower() or output != ""

    def test_static_value_property(self):
        """Test that static value properties work correctly."""
        component = {
            "id": "test-002",
            "name": "StaticComponent",
            "componentType": "Text",
            "schemaVersion": "1.0",
            "properties": {
                "content": {
                    "value": "Hello World"
                },
                "color": {
                    "value": "blue"
                }
            },
            "bindingProperties": {},
            "variants": [],
            "overrides": {},
            "children": []
        }

        result = self.run_codegen_test(component)

        assert result is not None, "Code generator returned no result"

        if result.get("success"):
            output = result.get("componentText", "") + result.get("declaration", "")
            # Static values should appear in output
            assert "Hello World" in output or "StaticComponent" in output or output != ""

    def test_multiple_bindings(self):
        """Test that components with multiple bindings work correctly."""
        component = {
            "id": "test-003",
            "name": "MultiBindingComponent",
            "componentType": "Card",
            "schemaVersion": "1.0",
            "properties": {
                "userName": {
                    "bindingProperties": {
                        "property": "user",
                        "field": "name"
                    }
                },
                "userEmail": {
                    "bindingProperties": {
                        "property": "user",
                        "field": "email"
                    }
                },
                "userAge": {
                    "bindingProperties": {
                        "property": "user",
                        "field": "age"
                    }
                }
            },
            "bindingProperties": {
                "user": {
                    "type": "Data",
                    "bindingProperties": {
                        "model": "User"
                    }
                }
            },
            "variants": [],
            "overrides": {},
            "children": []
        }

        result = self.run_codegen_test(component)

        assert result is not None, "Code generator returned no result"
        # Multiple bindings should not cause errors

    def test_nested_children_components(self):
        """Test that nested component structures work correctly."""
        component = {
            "id": "test-004",
            "name": "ParentComponent",
            "componentType": "Flex",
            "schemaVersion": "1.0",
            "properties": {
                "direction": {
                    "value": "column"
                }
            },
            "bindingProperties": {},
            "variants": [],
            "overrides": {},
            "children": [
                {
                    "componentType": "Text",
                    "name": "ChildText",
                    "properties": {
                        "content": {
                            "value": "Child content"
                        }
                    }
                }
            ]
        }

        result = self.run_codegen_test(component)

        assert result is not None, "Code generator returned no result"

    def test_alphanumeric_property_names(self):
        """Test that valid alphanumeric property names work."""
        valid_names = ["user", "userData", "user123", "my_data", "UserInfo"]

        for name in valid_names:
            component = {
                "id": f"test-alpha-{name}",
                "name": "AlphaComponent",
                "componentType": "Text",
                "schemaVersion": "1.0",
                "properties": {
                    "content": {
                        "bindingProperties": {
                            "property": name,
                            "field": "value"
                        }
                    }
                },
                "bindingProperties": {
                    name: {
                        "type": "Data",
                        "bindingProperties": {
                            "model": "DataModel"
                        }
                    }
                },
                "variants": [],
                "overrides": {},
                "children": []
            }

            result = self.run_codegen_test(component)
            assert result is not None, f"Code generator failed for property name: {name}"

    def test_reserved_keyword_handling(self):
        """Test that JavaScript reserved keywords are handled appropriately."""
        # These are JavaScript reserved words that should be handled specially
        keywords = ["class", "function", "return", "const", "let", "var"]

        for keyword in keywords:
            component = {
                "id": f"test-keyword-{keyword}",
                "name": "KeywordComponent",
                "componentType": "Text",
                "schemaVersion": "1.0",
                "properties": {
                    "content": {
                        "bindingProperties": {
                            "property": keyword,
                            "field": "data"
                        }
                    }
                },
                "bindingProperties": {
                    keyword: {
                        "type": "Data",
                        "bindingProperties": {
                            "model": "Model"
                        }
                    }
                },
                "variants": [],
                "overrides": {},
                "children": []
            }

            result = self.run_codegen_test(component)
            # Should handle reserved keywords without crashing
            assert result is not None, f"Code generator crashed on reserved keyword: {keyword}"


class TestCodeGeneratorEdgeCases:
    """Test edge cases for the code generator."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Set up test environment."""
        self.app_dir = "/workspace"
        self.package_dir = os.path.join(self.app_dir, "packages", "codegen-ui-react")

    def run_codegen_test(self, component_json):
        """Run a code generation test with the given component JSON."""
        test_script = f"""
const {{ AmplifyRenderer }} = require('{self.package_dir}');

const component = {json.dumps(component_json)};

try {{
    const renderer = new AmplifyRenderer(component, {{}});
    const result = renderer.renderComponent();
    console.log(JSON.stringify({{
        success: true,
        componentText: result.componentText || '',
        declaration: result.declaration || ''
    }}));
}} catch (error) {{
    console.log(JSON.stringify({{
        success: false,
        error: error.message
    }}));
}}
"""
        result = subprocess.run(
            ["node", "-e", test_script],
            capture_output=True,
            text=True,
            cwd=self.app_dir,
            timeout=30
        )

        if result.returncode != 0 and not result.stdout.strip():
            return {"success": False, "error": result.stderr}

        try:
            return json.loads(result.stdout.strip())
        except json.JSONDecodeError:
            return {"success": False, "error": "Invalid JSON output"}

    def test_empty_property_value(self):
        """Test handling of empty property values."""
        component = {
            "id": "test-empty",
            "name": "EmptyComponent",
            "componentType": "Text",
            "schemaVersion": "1.0",
            "properties": {
                "content": {
                    "bindingProperties": {
                        "property": "",
                        "field": "data"
                    }
                }
            },
            "bindingProperties": {},
            "variants": [],
            "overrides": {},
            "children": []
        }

        result = self.run_codegen_test(component)
        # Should handle empty values gracefully
        assert result is not None

    def test_whitespace_in_property(self):
        """Test handling of whitespace in property values."""
        component = {
            "id": "test-whitespace",
            "name": "WhitespaceComponent",
            "componentType": "Text",
            "schemaVersion": "1.0",
            "properties": {
                "content": {
                    "bindingProperties": {
                        "property": "  user  ",
                        "field": "data"
                    }
                }
            },
            "bindingProperties": {
                "user": {
                    "type": "Data",
                    "bindingProperties": {
                        "model": "User"
                    }
                }
            },
            "variants": [],
            "overrides": {},
            "children": []
        }

        result = self.run_codegen_test(component)
        assert result is not None

    def test_unicode_property_value(self):
        """Test handling of unicode in property values."""
        component = {
            "id": "test-unicode",
            "name": "UnicodeComponent",
            "componentType": "Text",
            "schemaVersion": "1.0",
            "properties": {
                "content": {
                    "value": "Hello"
                }
            },
            "bindingProperties": {},
            "variants": [],
            "overrides": {},
            "children": []
        }

        result = self.run_codegen_test(component)
        assert result is not None
