instruction: |-
  This is mruby, a lightweight implementation of the Ruby language. It provides an
  interpreter (mruby), an interactive shell (mirb), and a bytecode compiler (mrbc).

  When running certain Ruby code patterns involving module definitions with invalid
  control flow statements inside, the interpreter crashes. For example, the following
  code causes a segmentation fault or memory corruption error:

    module K retry
    end

  Running this with `./build/host/bin/mruby crash_example.rb` results in an immediate
  crash. Instead of a proper error message about invalid use of `retry` outside a
  rescue block, the program crashes unexpectedly.

  When compiled with AddressSanitizer, the output shows:
    ERROR: AddressSanitizer: heap-buffer-overflow
    WRITE of size 8 at address ...
    #0 ... in stack_clear src/vm.c:101

  We expect mruby to handle such invalid code gracefully by raising a syntax or
  runtime error, not by crashing with memory corruption.

  Note: The issue appears to be related to how the compiler initializes internal
  data structures when creating new scopes. The interpreter should properly handle
  malformed input without memory safety issues.

difficulty: medium
category: bug-fix
tags:
  - memory-safety
  - compiler
  - c
  - initialization
parser_name: pytest

run_tests_in_same_shell: false
