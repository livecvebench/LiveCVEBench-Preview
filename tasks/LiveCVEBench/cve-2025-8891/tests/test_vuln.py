"""
Vulnerability tests for OceanWP theme CSRF issue.
These tests verify that AJAX endpoints properly validate request authenticity.

- FAIL in vulnerable state (requests without proper validation succeed)
- PASS in fixed state (requests without proper validation are rejected)
"""

import pytest
import requests
import time
import os

# WordPress configuration
WP_URL = os.environ.get("WP_URL", "http://localhost")
ADMIN_USER = os.environ.get("WP_ADMIN_USER", "admin")
ADMIN_PASS = os.environ.get("WP_ADMIN_PASS", "admin")


def get_admin_session():
    """Create an authenticated admin session"""
    session = requests.Session()
    login_url = f"{WP_URL}/wp-login.php"
    login_data = {
        "log": ADMIN_USER,
        "pwd": ADMIN_PASS,
        "wp-submit": "Log In",
        "redirect_to": f"{WP_URL}/wp-admin/",
        "testcookie": "1"
    }

    # Get login page first
    session.get(login_url, timeout=30)
    # Submit login
    session.post(login_url, data=login_data, allow_redirects=True, timeout=30)

    return session


class TestCSRFProtectionNoticeButtonClick:
    """
    Tests for CSRF protection on oceanwp_notice_button_click endpoint.
    This is the primary endpoint that installs/activates the Ocean Extra plugin.
    """

    @pytest.fixture(autouse=True)
    def setup(self):
        """Set up admin session"""
        self.admin_session = get_admin_session()
        self.admin_ajax_url = f"{WP_URL}/wp-admin/admin-ajax.php"

    def test_request_without_nonce_is_rejected(self):
        """
        Test that requests without nonce are rejected.
        This simulates a CSRF attack where the attacker cannot include a valid nonce.
        """
        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_notice_button_click"},
            timeout=30
        )

        # After fix: should fail with -1 or 403 (nonce validation failure)
        # The check_ajax_referer() function dies with -1 on failure
        response_text = response.text.strip()

        # WordPress check_ajax_referer returns -1 or 0 on failure
        is_rejected = (
            response_text == "-1" or
            response_text == "0" or
            response.status_code == 403 or
            (response.status_code == 200 and response_text == "")
        )

        # If we get a JSON success response, the vulnerability exists
        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, \
            f"Request without nonce should be rejected. Got: {response_text[:200]}"

    def test_request_with_invalid_nonce_is_rejected(self):
        """
        Test that requests with invalid nonce are rejected.
        Even if attacker tries to guess a nonce, it should fail.
        """
        invalid_nonces = [
            "invalid_nonce_123",
            "abcdef1234567890",
            "1234567890",
            "",
            "null",
        ]

        for invalid_nonce in invalid_nonces:
            response = self.admin_session.post(
                self.admin_ajax_url,
                data={
                    "action": "oceanwp_notice_button_click",
                    "_ajax_nonce": invalid_nonce,
                    "_wpnonce": invalid_nonce,
                },
                timeout=30
            )

            response_text = response.text.strip()

            # Should be rejected
            is_rejected = (
                response_text == "-1" or
                response_text == "0" or
                response.status_code == 403
            )

            try:
                json_data = response.json()
                if json_data.get("success") == True:
                    is_rejected = False
            except:
                pass

            assert is_rejected, \
                f"Request with invalid nonce '{invalid_nonce}' should be rejected. Got: {response_text[:200]}"

    def test_cross_origin_request_simulation(self):
        """
        Simulate cross-origin request by sending request with external referer.
        This mimics what happens during a CSRF attack.
        """
        headers = {
            "Referer": "https://evil-attacker-site.com/csrf-page.html",
            "Origin": "https://evil-attacker-site.com",
        }

        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_notice_button_click"},
            headers=headers,
            timeout=30
        )

        response_text = response.text.strip()

        # After fix: nonce check should fail regardless of referer
        is_rejected = (
            response_text == "-1" or
            response_text == "0" or
            response.status_code == 403
        )

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, \
            f"Cross-origin request simulation should be rejected. Got: {response_text[:200]}"


class TestCSRFProtectionDismissedNotice:
    """Tests for CSRF protection on oceanwp_dismissed_notice endpoint"""

    @pytest.fixture(autouse=True)
    def setup(self):
        self.admin_session = get_admin_session()
        self.admin_ajax_url = f"{WP_URL}/wp-admin/admin-ajax.php"

    def test_dismissed_notice_without_nonce_is_rejected(self):
        """Test that dismissing notice without nonce is rejected"""
        response = self.admin_session.post(
            self.admin_ajax_url,
            data={
                "action": "oceanwp_dismissed_notice",
                "action_type": "skip_only"
            },
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, \
            f"Request without nonce should be rejected. Got: {response_text[:200]}"


class TestCSRFProtectionCheckNoticeActions:
    """Tests for CSRF protection on oceanwp_check_notice_actions endpoint"""

    @pytest.fixture(autouse=True)
    def setup(self):
        self.admin_session = get_admin_session()
        self.admin_ajax_url = f"{WP_URL}/wp-admin/admin-ajax.php"

    def test_check_notice_actions_without_nonce_is_rejected(self):
        """Test that checking notice actions without nonce is rejected"""
        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_check_notice_actions"},
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, \
            f"Request without nonce should be rejected. Got: {response_text[:200]}"


class TestCSRFProtectionPanelEndpoints:
    """Tests for CSRF protection on panel notice endpoints"""

    @pytest.fixture(autouse=True)
    def setup(self):
        self.admin_session = get_admin_session()
        self.admin_ajax_url = f"{WP_URL}/wp-admin/admin-ajax.php"

    def test_panel_notice_button_click_without_nonce_is_rejected(self):
        """Test oceanwp_panel_notice_button_click without nonce is rejected"""
        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_panel_notice_button_click"},
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, \
            f"Request without nonce should be rejected. Got: {response_text[:200]}"

    def test_dismissed_panel_notice_without_nonce_is_rejected(self):
        """Test oceanwp_dismissed_panel_notice without nonce is rejected"""
        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_dismissed_panel_notice"},
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        # No success check needed - this endpoint just calls wp_die()

        assert is_rejected, \
            f"Request without nonce should be rejected. Got: {response_text[:200]}"

    def test_check_panel_notice_actions_without_nonce_is_rejected(self):
        """Test oceanwp_check_panel_notice_actions without nonce is rejected"""
        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_check_panel_notice_actions"},
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, \
            f"Request without nonce should be rejected. Got: {response_text[:200]}"


class TestMultipleAttackVectors:
    """
    Test various attack vectors that could be used in CSRF attacks.
    These test different ways an attacker might try to bypass protections.
    """

    @pytest.fixture(autouse=True)
    def setup(self):
        self.admin_session = get_admin_session()
        self.admin_ajax_url = f"{WP_URL}/wp-admin/admin-ajax.php"

    def test_post_request_via_form_submission(self):
        """
        Simulate form-based CSRF attack (auto-submit form from external site).
        This is the most common CSRF attack vector.
        """
        # Form submission typically sends these headers
        headers = {
            "Content-Type": "application/x-www-form-urlencoded",
            "Referer": "https://malicious-site.com/attack.html",
        }

        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_notice_button_click"},
            headers=headers,
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, "Form-based CSRF attack should be blocked"

    def test_ajax_request_from_external_origin(self):
        """
        Simulate AJAX-based CSRF (if CORS was misconfigured).
        Tests that even with AJAX-style request, nonce is still required.
        """
        headers = {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
            "Origin": "https://attacker-controlled-domain.com",
        }

        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_notice_button_click"},
            headers=headers,
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, "AJAX request without nonce should be blocked"

    def test_request_with_spoofed_wp_nonce_header(self):
        """
        Test that spoofed/guessed nonce in header doesn't work.
        Some systems accept nonce in X-WP-Nonce header.
        """
        headers = {
            "X-WP-Nonce": "fake_nonce_12345",
        }

        response = self.admin_session.post(
            self.admin_ajax_url,
            data={"action": "oceanwp_notice_button_click"},
            headers=headers,
            timeout=30
        )

        response_text = response.text.strip()
        is_rejected = response_text in ["-1", "0"] or response.status_code == 403

        try:
            json_data = response.json()
            if json_data.get("success") == True:
                is_rejected = False
        except:
            pass

        assert is_rejected, "Spoofed nonce header should not work"

    def test_replay_with_empty_nonce_variations(self):
        """Test various empty/null nonce values don't bypass protection"""
        empty_variations = [
            {"_ajax_nonce": ""},
            {"_wpnonce": ""},
            {"_ajax_nonce": None},
            {"security": ""},
            {"nonce": ""},
        ]

        for nonce_data in empty_variations:
            data = {"action": "oceanwp_notice_button_click"}
            # Only add non-None values
            data.update({k: v for k, v in nonce_data.items() if v is not None})

            response = self.admin_session.post(
                self.admin_ajax_url,
                data=data,
                timeout=30
            )

            response_text = response.text.strip()
            is_rejected = response_text in ["-1", "0"] or response.status_code == 403

            try:
                json_data = response.json()
                if json_data.get("success") == True:
                    is_rejected = False
            except:
                pass

            assert is_rejected, \
                f"Empty nonce variation {nonce_data} should be rejected"

    def test_all_sensitive_endpoints_require_nonce(self):
        """
        Verify all sensitive AJAX endpoints require nonce validation.
        This is a comprehensive check of all handlers.
        """
        sensitive_actions = [
            "oceanwp_notice_button_click",
            "oceanwp_dismissed_notice",
            "oceanwp_check_notice_actions",
            "oceanwp_panel_notice_button_click",
            "oceanwp_dismissed_panel_notice",
            "oceanwp_check_panel_notice_actions",
        ]

        for action in sensitive_actions:
            response = self.admin_session.post(
                self.admin_ajax_url,
                data={"action": action},
                timeout=30
            )

            response_text = response.text.strip()
            is_rejected = response_text in ["-1", "0"] or response.status_code == 403

            try:
                json_data = response.json()
                if json_data.get("success") == True:
                    is_rejected = False
            except:
                pass

            assert is_rejected, \
                f"Endpoint '{action}' should require nonce validation"
