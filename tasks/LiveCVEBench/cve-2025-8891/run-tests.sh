#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install uv for package management
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize project and add dependencies
uv init 2>/dev/null || true
uv add pytest requests 2>/dev/null

# Wait for WordPress to be ready
echo "Waiting for WordPress to be ready..."
MAX_WAIT=120
WAITED=0
until curl -s http://localhost/wp-login.php > /dev/null 2>&1; do
    if [ $WAITED -ge $MAX_WAIT ]; then
        echo "Timeout waiting for WordPress"
        exit 1
    fi
    sleep 2
    WAITED=$((WAITED + 2))
    echo "Waiting... ($WAITED seconds)"
done
echo "WordPress is ready!"

# Give it a bit more time to fully initialize
sleep 5

# Export environment variables for tests
export WP_URL="http://localhost"
export WP_ADMIN_USER="admin"
export WP_ADMIN_PASS="admin"

# Run all tests
uv run pytest . -rA -v
