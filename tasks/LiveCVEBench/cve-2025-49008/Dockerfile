FROM php:8.0-apache

# Install required system packages
# - git: Required for CodeGit component (the vulnerable component)
# - tmux, asciinema, curl: Required by Builder spec
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Set working directory to Apache document root
WORKDIR /var/www/html

# Configure git to trust the working directory
RUN git config --global --add safe.directory /var/www/html

# Clone Atheos repository and checkout vulnerable version (v603 = commit e0f06379)
RUN git clone https://github.com/Atheos/Atheos.git . && \
    git checkout e0f06379 && \
    rm -rf .git

# Enable Apache mod_rewrite for .htaccess support
RUN a2enmod rewrite

# Configure Apache to allow .htaccess overrides
RUN sed -i '/<Directory \/var\/www\/>/,/<\/Directory>/ s/AllowOverride None/AllowOverride All/' \
    /etc/apache2/apache2.conf

# Create necessary directories and set permissions
RUN mkdir -p data workspace plugins themes data/cache data/log && \
    chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html

# Create pre-configured config.php for automated testing
# This bypasses the setup wizard
COPY task-deps/config.php /var/www/html/config.php
RUN chown www-data:www-data /var/www/html/config.php

# Create users.json with admin user (password: admin)
# Using php -r to generate proper bcrypt hash dynamically
RUN php -r "echo json_encode(['admin' => ['password' => password_hash('admin', PASSWORD_DEFAULT), 'resetPassword' => false, 'activeProject' => '', 'activePath' => '', 'activeName' => '', 'creationDate' => '2025-01-01', 'lastLogin' => '', 'permissions' => ['admin' => true]]]);" > /var/www/html/data/users.json && \
    chown www-data:www-data /var/www/html/data/users.json

# Create projects.json with an empty project list
COPY task-deps/projects.json /var/www/html/data/projects.json
RUN chown www-data:www-data /var/www/html/data/projects.json

# Ensure www-data owns all files
RUN chown -R www-data:www-data /var/www/html

# Configure Git globally for www-data
RUN git config --global user.email "admin@atheos.local" && \
    git config --global user.name "Admin" && \
    git config --global --add safe.directory '*'

# Expose HTTP port
EXPOSE 80

# Start Apache
# CMD ["apache2-foreground"]  # Moved to docker-compose.yaml
