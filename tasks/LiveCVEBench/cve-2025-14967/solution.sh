#!/bin/bash
# Solution script to fix the SQL injection vulnerability in candidates_report.php
# This script replaces direct query interpolation with prepared statements
set -e

cd /var/www/html

echo "Applying fix to candidates_report.php..."

# Create the fixed version using Python for reliable string replacement
python3 << 'PYEOF'
import re

file_path = '/var/www/html/candidates_report.php'

with open(file_path, 'r') as f:
    content = f.read()

# The vulnerable code pattern (lines 66-67)
old_code = '''    $sy = $_GET['school_year'];
    $sql= mysqli_query($conn,"SELECT *,CONCAT(LASTNAME,', ',FIRSTNAME, ' ', MIDDLENAME) as name from promotion_candidates left join student_info on promotion_candidates.STUDENT_ID=student_info.STUDENT_ID   left join program on student_info.PROGRAM = program.PROGRAM_ID where SY = '$sy' order by name");'''

# The fixed code using prepared statements
new_code = '''    $sy = $_GET['school_year'];
    $stmt = mysqli_prepare($conn, "SELECT *,CONCAT(LASTNAME,', ',FIRSTNAME, ' ', MIDDLENAME) as name from promotion_candidates left join student_info on promotion_candidates.STUDENT_ID=student_info.STUDENT_ID   left join program on student_info.PROGRAM = program.PROGRAM_ID where SY = ? order by name");
    mysqli_stmt_bind_param($stmt, "s", $sy);
    mysqli_stmt_execute($stmt);
    $sql = mysqli_stmt_get_result($stmt);'''

if old_code in content:
    content = content.replace(old_code, new_code)
    with open(file_path, 'w') as f:
        f.write(content)
    print("Fix applied successfully!")
else:
    # Check if already fixed
    if "mysqli_prepare" in content and "mysqli_stmt_bind_param" in content:
        print("File appears to already be fixed.")
    else:
        print("WARNING: Could not find the expected vulnerable code pattern.")
        print("Attempting alternative fix method...")

        # Alternative: Use regex-based replacement
        # Pattern to match the vulnerable query construction
        pattern = r'\$sql=\s*mysqli_query\(\$conn,"SELECT \*,CONCAT\(LASTNAME.*?where SY = \'\$sy\' order by name"\);'

        replacement = '''$stmt = mysqli_prepare($conn, "SELECT *,CONCAT(LASTNAME,', ',FIRSTNAME, ' ', MIDDLENAME) as name from promotion_candidates left join student_info on promotion_candidates.STUDENT_ID=student_info.STUDENT_ID   left join program on student_info.PROGRAM = program.PROGRAM_ID where SY = ? order by name");
    mysqli_stmt_bind_param($stmt, "s", $sy);
    mysqli_stmt_execute($stmt);
    $sql = mysqli_stmt_get_result($stmt);'''

        new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)

        if new_content != content:
            with open(file_path, 'w') as f:
                f.write(new_content)
            print("Fix applied via regex method!")
        else:
            print("ERROR: Could not apply fix. Manual intervention required.")
            exit(1)

PYEOF

echo "Fix complete."
