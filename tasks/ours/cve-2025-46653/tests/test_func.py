"""
Functional tests for the file upload service.
These tests verify that the upload functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import os
import time
import pytest
import requests

BASE_URL = os.environ.get("BASE_URL", "http://localhost:3000")

def wait_for_server(max_retries=30, delay=1):
    """Wait for the server to be ready."""
    for _ in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/health", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
    return False


class TestBasicUpload:
    """Test basic file upload functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is running before each test."""
        assert wait_for_server(), "Server did not become ready"

    def test_single_file_upload(self):
        """Test uploading a single text file."""
        files = {"file": ("test.txt", b"Hello, World!", "text/plain")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert "files" in data
        assert len(data["files"]) == 1
        assert "newFilename" in data["files"][0]

    def test_upload_with_extension_preserved(self):
        """Test that file extensions are preserved when keepExtensions is true."""
        files = {"file": ("document.pdf", b"PDF content here", "application/pdf")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert len(data["files"]) == 1
        filename = data["files"][0]["newFilename"]
        assert filename.endswith(".pdf"), f"Expected .pdf extension, got: {filename}"

    def test_upload_multiple_files_sequentially(self):
        """Test uploading multiple files in sequence."""
        filenames = []
        for i in range(3):
            files = {"file": (f"file{i}.txt", f"Content {i}".encode(), "text/plain")}
            response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

            assert response.status_code == 200
            data = response.json()
            filenames.append(data["files"][0]["newFilename"])

        # All files should have been uploaded with unique names
        assert len(set(filenames)) == 3, "All filenames should be unique"

    def test_upload_different_file_types(self):
        """Test uploading various file types."""
        test_cases = [
            ("image.jpg", b"fake image data", "image/jpeg", ".jpg"),
            ("script.js", b"console.log('hello');", "application/javascript", ".js"),
            ("data.json", b'{"key": "value"}', "application/json", ".json"),
        ]

        for original_name, content, mime_type, expected_ext in test_cases:
            files = {"file": (original_name, content, mime_type)}
            response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

            assert response.status_code == 200
            data = response.json()
            filename = data["files"][0]["newFilename"]
            assert filename.endswith(expected_ext), \
                f"Expected {expected_ext} extension for {original_name}, got: {filename}"

    def test_filename_length(self):
        """Test that generated filenames have the expected length (25 chars + extension)."""
        files = {"file": ("test.txt", b"Test content", "text/plain")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        filename = data["files"][0]["newFilename"]

        # Remove extension
        name_without_ext = filename.rsplit(".", 1)[0] if "." in filename else filename
        # Generated ID should be 25 characters
        assert len(name_without_ext) == 25, \
            f"Expected 25-char filename, got {len(name_without_ext)}: {name_without_ext}"

    def test_upload_binary_file(self):
        """Test uploading a binary file."""
        binary_content = bytes(range(256))
        files = {"file": ("binary.bin", binary_content, "application/octet-stream")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert len(data["files"]) == 1


class TestFileMetadata:
    """Test file metadata handling."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is running before each test."""
        assert wait_for_server(), "Server did not become ready"

    def test_original_filename_preserved_in_metadata(self):
        """Test that original filename is preserved in file metadata."""
        original_name = "my_original_file.txt"
        files = {"file": (original_name, b"Test content", "text/plain")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert data["files"][0]["originalFilename"] == original_name

    def test_mimetype_detected(self):
        """Test that MIME type is correctly passed through."""
        files = {"file": ("test.png", b"PNG content", "image/png")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert data["files"][0]["mimetype"] == "image/png"


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is running before each test."""
        assert wait_for_server(), "Server did not become ready"

    def test_filename_with_special_characters_in_extension(self):
        """Test uploading files with complex extensions."""
        files = {"file": ("archive.tar.gz", b"Compressed content", "application/gzip")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        filename = data["files"][0]["newFilename"]
        # Should preserve the extension pattern
        assert ".tar.gz" in filename or ".gz" in filename

    def test_upload_small_file(self):
        """Test uploading a very small file (1 byte)."""
        files = {"file": ("tiny.txt", b"x", "text/plain")}
        response = requests.post(f"{BASE_URL}/upload", files=files, timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert len(data["files"]) == 1
