#!/bin/bash
set -e

echo "Starting Bagisto setup..."

# Check if app files are deployed to the volume
if [ ! -f "/var/www/html/composer.json" ]; then
    echo "Deploying Bagisto files to volume..."
    rsync -a /app-build/ /var/www/html/
    chown -R www-data:www-data /var/www/html
    echo "Files deployed successfully!"
fi

# Wait for MySQL to be ready
echo "Waiting for MySQL..."
max_retries=60
count=0
while ! mysql -h"$DB_HOST" -u"$DB_USERNAME" -p"$DB_PASSWORD" --skip-ssl -e "SELECT 1" > /dev/null 2>&1; do
    count=$((count + 1))
    if [ $count -ge $max_retries ]; then
        echo "ERROR: MySQL did not become ready within expected time"
        exit 1
    fi
    echo "MySQL is not ready yet (attempt $count/$max_retries). Waiting..."
    sleep 2
done
echo "MySQL is ready!"

# Check if Bagisto is already installed (check for installed flag file)
if [ ! -f "/var/www/html/.bagisto_installed" ]; then
    echo "Running Bagisto installation..."

    cd /var/www/html

    echo "Generating application key..."
    php artisan key:generate --force

    echo "Running Bagisto installer..."
    php artisan bagisto:install --skip-env-check --skip-admin-creation

    echo "Creating admin user..."
    # Create admin user via tinker if not exists
    php artisan tinker --execute="
    use Illuminate\Support\Facades\Hash;
    use Webkul\User\Models\Admin;
    if (!Admin::where('email', 'admin@example.com')->exists()) {
        Admin::create([
            'name' => 'Admin',
            'email' => 'admin@example.com',
            'password' => Hash::make('admin123'),
            'role_id' => 1,
            'status' => 1,
        ]);
        echo 'Admin user created.';
    } else {
        echo 'Admin user already exists.';
    }
    " || echo "Could not create admin user via tinker"

    echo "Creating storage link..."
    php artisan storage:link || true

    echo "Setting permissions..."
    chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
    chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache

    # Mark as installed
    touch /var/www/html/.bagisto_installed

    echo "Bagisto installation complete!"
else
    echo "Bagisto already installed, running migrations..."
    cd /var/www/html
    php artisan migrate --force || true
fi

# Clear and cache
echo "Clearing and caching configuration..."
cd /var/www/html
php artisan config:cache || true
php artisan route:cache || true
php artisan view:clear || true

echo "Starting PHP-FPM..."
exec "$@"
