"""
Functionality tests for FreshRSS application.
These tests verify that the application works correctly and should PASS in both
vulnerable and fixed states.
"""

import pytest
import requests
import time
import re

BASE_URL = "http://localhost"
TIMEOUT = 10


class TestApplicationAccessibility:
    """Tests to verify the application is running and accessible."""

    def test_homepage_accessible(self):
        """Test that the homepage loads successfully."""
        response = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        # Should redirect to login or show main page
        assert response.status_code in [200, 302, 303], \
            f"Homepage not accessible, got status {response.status_code}"

    def test_login_page_accessible(self):
        """Test that the login page is accessible."""
        response = requests.get(f"{BASE_URL}/i/?c=auth&a=login", timeout=TIMEOUT)
        # Login page should load or redirect
        assert response.status_code in [200, 302, 303], \
            f"Login page not accessible, got status {response.status_code}"

    def test_favicon_exists(self):
        """Test that static resources are served."""
        response = requests.get(f"{BASE_URL}/favicon.ico", timeout=TIMEOUT)
        # Favicon might be 200 or 404 depending on setup, but server should respond
        assert response.status_code in [200, 404], \
            f"Server not responding to static requests, got {response.status_code}"


class TestPublicEndpoints:
    """Tests for endpoints that should always be publicly accessible."""

    def test_nonce_endpoint_for_login(self):
        """Test that the nonce endpoint works for login flow."""
        # Nonce endpoint is used during login, should work without auth
        # but requires a valid username parameter
        response = requests.get(f"{BASE_URL}/i/?c=javascript&a=nonce&user=admin", timeout=TIMEOUT)
        # Should return JSON with nonce data (200) even if user doesn't exist
        assert response.status_code == 200, \
            f"Nonce endpoint failed, got status {response.status_code}"
        # Should be JSON
        assert "application/json" in response.headers.get("Content-Type", ""), \
            "Nonce endpoint should return JSON"


class TestCoreRouting:
    """Tests to verify core URL routing is functional."""

    def test_controller_routing_works(self):
        """Test that controller routing is functional."""
        # Test various controller routes respond
        routes_to_test = [
            "/i/?c=index&a=index",
            "/i/?c=auth&a=login",
        ]
        for route in routes_to_test:
            response = requests.get(f"{BASE_URL}{route}", timeout=TIMEOUT, allow_redirects=False)
            # Should get a valid HTTP response (not 500)
            assert response.status_code != 500, \
                f"Route {route} returned server error"

    def test_invalid_controller_handled(self):
        """Test that invalid controllers are handled gracefully."""
        response = requests.get(f"{BASE_URL}/i/?c=nonexistent&a=test", timeout=TIMEOUT)
        # Should return 404 or similar, not crash
        assert response.status_code in [404, 403, 302], \
            f"Invalid controller not handled properly, got {response.status_code}"

    def test_invalid_action_handled(self):
        """Test that invalid actions are handled gracefully."""
        response = requests.get(f"{BASE_URL}/i/?c=index&a=nonexistent", timeout=TIMEOUT)
        # Should return 404 or similar, not crash
        assert response.status_code in [404, 403, 302], \
            f"Invalid action not handled properly, got {response.status_code}"


class TestErrorHandling:
    """Tests for error handling behavior."""

    def test_404_handling_for_tag(self):
        """Test that non-existent tags return 404."""
        # Request a tag with a very high ID that likely doesn't exist
        response = requests.get(f"{BASE_URL}/i/?c=tag&a=update&id=999999", timeout=TIMEOUT)
        # Should return 404 (not found) or 403 (forbidden) - either is acceptable
        # After fix: 403 (auth check fails first)
        # Before fix with invalid tag: 404
        assert response.status_code in [403, 404], \
            f"Non-existent tag should return 403 or 404, got {response.status_code}"

    def test_missing_id_parameter(self):
        """Test that missing id parameter is handled."""
        response = requests.get(f"{BASE_URL}/i/?c=tag&a=update", timeout=TIMEOUT)
        # Should return 404 (id=0) or 403 (auth check)
        assert response.status_code in [403, 404], \
            f"Missing id should return 403 or 404, got {response.status_code}"


class TestPHPErrorHandling:
    """Tests to verify PHP is configured correctly and no fatal errors occur."""

    def test_no_php_errors_in_response(self):
        """Test that PHP errors are not exposed in responses."""
        response = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        # Should not contain PHP error messages
        error_indicators = [
            "Fatal error:",
            "Parse error:",
            "Warning:",
            "Notice:",
            "PHP Stack trace",
            "Uncaught Exception",
        ]
        for indicator in error_indicators:
            assert indicator not in response.text, \
                f"PHP error detected in response: {indicator}"

    def test_controller_methods_dont_crash(self):
        """Test that controller methods don't cause PHP crashes."""
        # These endpoints should respond without crashing
        endpoints = [
            "/i/?c=javascript&a=actualize",
            "/i/?c=javascript&a=nbUnreadsPerFeed",
            "/i/?c=tag&a=index",
        ]
        for endpoint in endpoints:
            response = requests.get(f"{BASE_URL}{endpoint}", timeout=TIMEOUT)
            # Should not be 500 (server error)
            assert response.status_code != 500, \
                f"Endpoint {endpoint} caused server error"
            # Should not contain PHP fatal errors
            assert "Fatal error" not in response.text, \
                f"Endpoint {endpoint} caused PHP fatal error"
