#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== Setting up test environment ==="

# Install pytest directly via pip if not available
if ! python3 -c "import pytest" 2>/dev/null; then
    echo "Installing pytest..."
    pip3 install pytest --quiet --break-system-packages 2>/dev/null || pip3 install pytest --quiet
fi

# Check if wasm3 binary exists (should be built by Docker image)
WASM3_PATH="/app/build/wasm3"
if [ ! -f "$WASM3_PATH" ]; then
    echo "wasm3 binary not found at $WASM3_PATH"
    echo "Attempting to build wasm3..."

    cd /app

    # Build with AddressSanitizer for vulnerability detection
    if [ -d "build" ]; then
        rm -rf build
    fi

    mkdir build && cd build

    # Build with ASAN to detect memory issues
    export CC=${CC:-clang}
    export CFLAGS="-fsanitize=address -g -O0"
    export LDFLAGS="-fsanitize=address"

    cmake -DBUILD_WASI=none .. 2>/dev/null || cmake ..
    make -j$(nproc) 2>/dev/null || make

    cd "$(dirname "$0")"
fi

if [ ! -f "$WASM3_PATH" ]; then
    echo "ERROR: Failed to build wasm3"
    exit 1
fi

echo "wasm3 binary found at: $WASM3_PATH"
echo ""

echo "=== Running tests ==="
# Run all tests with verbose output
python3 -m pytest tests/ -rA -v
