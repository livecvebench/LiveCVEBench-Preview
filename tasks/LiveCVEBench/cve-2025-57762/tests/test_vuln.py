"""
Vulnerability tests for WeGIA Stored XSS in document type management.

These tests verify the XSS vulnerability status:
- FAIL when vulnerable (XSS payload is stored/displayed without encoding)
- PASS when fixed (XSS payload is properly sanitized/encoded)
"""

import pytest
import requests
import time
import json
import re


BASE_URL = "http://localhost"
ADMIN_USER = "admin"
ADMIN_PASSWORD = "wegia"


class WeGIAClient:
    """Client helper for WeGIA authentication and requests"""

    def __init__(self, base_url=BASE_URL):
        self.base_url = base_url
        self.session = requests.Session()
        self.authenticated = False

    def login(self, username=ADMIN_USER, password=ADMIN_PASSWORD):
        """Authenticate with WeGIA and return session"""
        login_url = f"{self.base_url}/html/login.php"

        response = self.session.post(login_url, data={
            "cpf": username,
            "pwd": password
        }, allow_redirects=False)

        if response.status_code in [200, 302]:
            check_response = self.session.get(
                f"{self.base_url}/html/funcionario/dependente_docdependente.php?action=adicionar",
                allow_redirects=False
            )
            if check_response.status_code != 302:
                self.authenticated = True
                return True

        return False

    def add_document_type(self, name):
        """Add a new document type and return response"""
        url = f"{self.base_url}/html/funcionario/dependente_docdependente.php"
        response = self.session.post(url, data={
            "action": "adicionar",
            "nome": name
        })
        return response

    def get_profile_page(self, dependent_id=1):
        """Get profile page that displays document types"""
        url = f"{self.base_url}/html/funcionario/profile_dependente.php"
        response = self.session.get(url, params={"id_dependente": str(dependent_id)})
        return response


@pytest.fixture(scope="module")
def client():
    """Create authenticated WeGIA client"""
    c = WeGIAClient()
    max_retries = 30
    for i in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302]:
                break
        except requests.exceptions.ConnectionError:
            if i < max_retries - 1:
                time.sleep(2)
            continue

    if not c.login():
        pytest.skip("Could not authenticate with WeGIA")

    return c


class TestScriptTagXSS:
    """Test script tag XSS injection - core vulnerability"""

    def test_script_tag_stored_unescaped(self, client):
        """Test that script tags are stored unescaped (vulnerable)"""
        unique_id = f"xss_{int(time.time())}"
        payload = f"<script>alert('{unique_id}')</script>"

        response = client.add_document_type(payload)

        if response.status_code == 400:
            return  # Input rejected = fixed

        # Check if script tag is properly escaped
        # Vulnerable: raw <script> in response
        # Fixed: &lt;script&gt; in response
        assert "<script>" not in response.text, \
            f"XSS VULNERABLE: Script tag stored unescaped"

    def test_script_tag_rendered_in_html(self, client):
        """Test that script tags are rendered unescaped in HTML (vulnerable)"""
        unique_id = f"xss_html_{int(time.time())}"
        payload = f"<script>alert('{unique_id}')</script>"

        response = client.add_document_type(payload)

        if response.status_code == 400:
            return

        profile_response = client.get_profile_page()

        if profile_response.status_code == 200:
            # Vulnerable if raw script tag in HTML
            assert f"<script>alert('{unique_id}')</script>" not in profile_response.text, \
                "XSS VULNERABLE: Script tag rendered unescaped in HTML"


class TestEventHandlerXSS:
    """Test event handler XSS injection"""

    def test_img_onerror_stored(self, client):
        """Test img onerror handler stored unescaped"""
        unique_id = f"img_{int(time.time())}"
        payload = f'<img src=x onerror="alert(\'{unique_id}\')">'

        response = client.add_document_type(payload)

        if response.status_code == 400:
            return

        assert "<img" not in response.text, \
            "XSS VULNERABLE: IMG tag stored unescaped"

    def test_svg_onload_stored(self, client):
        """Test SVG onload handler stored unescaped"""
        unique_id = f"svg_{int(time.time())}"
        payload = f'<svg onload="alert(\'{unique_id}\')">'

        response = client.add_document_type(payload)

        if response.status_code == 400:
            return

        assert "<svg" not in response.text, \
            "XSS VULNERABLE: SVG tag stored unescaped"


class TestSpecialCharSanitization:
    """Test HTML special character sanitization"""

    def test_less_than_not_sanitized(self, client):
        """Test that < character is not sanitized (vulnerable)"""
        unique_id = f"lt_{int(time.time())}"
        payload = f"test_{unique_id} < value"

        response = client.add_document_type(payload)

        if response.status_code == 400:
            return

        try:
            data = response.json()
            for item in data:
                if 'nome_docdependente' in item and unique_id in item['nome_docdependente']:
                    val = item['nome_docdependente']
                    assert ' < ' not in val, \
                        f"XSS VULNERABLE: Raw < not sanitized: {val}"
        except json.JSONDecodeError:
            pass

    def test_greater_than_not_sanitized(self, client):
        """Test that > character is not sanitized (vulnerable)"""
        unique_id = f"gt_{int(time.time())}"
        payload = f"test_{unique_id} > value"

        response = client.add_document_type(payload)

        if response.status_code == 400:
            return

        try:
            data = response.json()
            for item in data:
                if 'nome_docdependente' in item and unique_id in item['nome_docdependente']:
                    val = item['nome_docdependente']
                    assert ' > ' not in val, \
                        f"XSS VULNERABLE: Raw > not sanitized: {val}"
        except json.JSONDecodeError:
            pass
