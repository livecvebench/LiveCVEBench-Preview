"""
Functional tests for URL Shortify plugin link editing functionality.
These tests verify that the plugin works correctly in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import re
from urllib.parse import urlencode

# WordPress configuration
WP_URL = "http://localhost"
WP_ADMIN_URL = f"{WP_URL}/wp-admin"
WP_USER = "admin"
WP_PASS = "admin"

# Session for authenticated requests
session = requests.Session()


def wait_for_wordpress(timeout=60):
    """Wait for WordPress to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{WP_URL}/wp-login.php", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


def wordpress_login():
    """Log in to WordPress admin and return authenticated session."""
    login_url = f"{WP_URL}/wp-login.php"

    # Get the login page to fetch any necessary cookies/nonces
    response = session.get(login_url)
    assert response.status_code == 200, f"Failed to load login page: {response.status_code}"

    # Submit login form
    login_data = {
        "log": WP_USER,
        "pwd": WP_PASS,
        "wp-submit": "Log In",
        "redirect_to": f"{WP_ADMIN_URL}/",
        "testcookie": "1"
    }

    response = session.post(login_url, data=login_data, allow_redirects=True)

    # Verify we're logged in by checking we can access admin
    admin_response = session.get(f"{WP_ADMIN_URL}/")
    assert "dashboard" in admin_response.text.lower() or "wp-admin" in admin_response.url, \
        "Failed to log in to WordPress admin"

    return session


@pytest.fixture(scope="module")
def wp_session():
    """Fixture to provide an authenticated WordPress session."""
    assert wait_for_wordpress(), "WordPress did not become available in time"
    return wordpress_login()


class TestPluginFunctionality:
    """Tests for basic plugin functionality."""

    def test_links_page_loads(self, wp_session):
        """Test that the links management page loads correctly."""
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links")
        assert response.status_code == 200
        # Check for plugin-specific content
        assert "us_links" in response.url or "Links" in response.text

    def test_new_link_page_loads(self, wp_session):
        """Test that the new link creation page loads correctly."""
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links&action=new")
        assert response.status_code == 200
        # The form should be present
        assert "<form" in response.text.lower()

    def test_edit_page_with_valid_numeric_id(self, wp_session):
        """Test that edit page loads correctly with a valid numeric ID."""
        # Try with ID 1 (may not exist but should load the page)
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links&action=edit&id=1")
        assert response.status_code == 200
        # Should see a form or a "no link found" type message
        assert "<form" in response.text.lower() or "link" in response.text.lower()

    def test_edit_page_with_zero_id(self, wp_session):
        """Test that edit page handles zero ID gracefully."""
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links&action=edit&id=0")
        assert response.status_code == 200

    def test_edit_page_with_empty_id(self, wp_session):
        """Test that edit page handles empty ID gracefully."""
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links&action=edit&id=")
        assert response.status_code == 200


class TestInputValidation:
    """Tests for input validation that should pass in both vulnerable and fixed states."""

    def test_valid_id_produces_clean_html(self, wp_session):
        """Test that a valid numeric ID produces properly formed HTML."""
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links&action=edit&id=123")
        assert response.status_code == 200

        # The id value in any form action should be numeric only
        form_action_match = re.search(r'<form[^>]*action=["\']([^"\']*)["\']', response.text, re.IGNORECASE)
        if form_action_match:
            form_action = form_action_match.group(1)
            # If id is in the form action, it should be a clean number
            id_match = re.search(r'[&?]id=(\d+)', form_action)
            if id_match:
                assert id_match.group(1).isdigit(), "ID in form action should be numeric"

    def test_page_structure_intact(self, wp_session):
        """Test that the page has proper HTML structure."""
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links&action=edit&id=1")
        assert response.status_code == 200

        # Check for basic HTML structure
        assert "<html" in response.text.lower()
        assert "</html>" in response.text.lower()
        assert "<body" in response.text.lower()


class TestNormalOperations:
    """Tests for normal plugin operations."""

    def test_links_list_accessible(self, wp_session):
        """Test that the links list is accessible."""
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=us_links")
        assert response.status_code == 200

    def test_settings_accessible(self, wp_session):
        """Test that plugin settings are accessible if available."""
        # Try to access settings page (URL Shortify uses 'kc-us-settings' for its settings page)
        response = wp_session.get(f"{WP_ADMIN_URL}/admin.php?page=kc-us-settings")
        # Should either load successfully or redirect, not error
        assert response.status_code in [200, 302, 404]
