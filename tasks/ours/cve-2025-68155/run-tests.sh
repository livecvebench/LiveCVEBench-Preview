#!/bin/bash
set -e

cd "$(dirname "$0")"

echo "=== Vite RSC Source Map Vulnerability Tests ==="
echo

# Wait for Vite dev server to be ready
echo "[*] Waiting for Vite dev server at http://localhost:5173..."
MAX_WAIT=60
WAITED=0

while ! curl -s http://localhost:5173 > /dev/null 2>&1; do
    if [ $WAITED -ge $MAX_WAIT ]; then
        echo "[-] Timeout waiting for Vite dev server after ${MAX_WAIT}s"
        exit 1
    fi
    sleep 2
    WAITED=$((WAITED + 2))
    echo "    Waited ${WAITED}s..."
done

echo "[+] Server is ready!"
echo

# Install uv and set up test environment
echo "[*] Setting up test environment..."
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize uv project if needed
uv init 2>/dev/null || true

# Add test dependencies
uv add pytest requests 2>/dev/null

echo
echo "[*] Running tests..."
echo

# Run all tests with verbose output
uv run pytest . -v -rA --tb=short

echo
echo "[+] Tests completed!"
