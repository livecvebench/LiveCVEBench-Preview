"""
Functional tests for the web API server.
These tests verify the application works correctly for normal use cases.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost:3000"


def wait_for_server(url: str, timeout: int = 30) -> bool:
    """Wait for server to become available."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{url}/", timeout=2)
            # Any response means server is up (even 404 or 405 for GET on POST endpoint)
            return True
        except requests.exceptions.ConnectionError:
            time.sleep(0.5)
        except requests.exceptions.Timeout:
            time.sleep(0.5)
    return False


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure server is ready before running tests."""
    assert wait_for_server(BASE_URL), f"Server at {BASE_URL} did not become available"
    yield


class TestBasicFunctionality:
    """Test basic API functionality."""

    def test_post_endpoint_accepts_valid_json(self):
        """Test that POST endpoint accepts valid JSON with expected structure."""
        payload = {
            "data": {
                "messageId": "test-message-123"
            }
        }
        response = requests.post(
            f"{BASE_URL}/",
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert "body" in data
        assert data["body"]["data"]["messageId"] == "test-message-123"

    def test_post_endpoint_returns_json(self):
        """Test that POST endpoint returns JSON response."""
        payload = {
            "data": {
                "messageId": "json-test"
            }
        }
        response = requests.post(
            f"{BASE_URL}/",
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200
        assert response.headers.get("content-type", "").startswith("application/json")

    def test_post_with_different_message_ids(self):
        """Test that different message IDs are handled correctly."""
        test_ids = ["msg-001", "msg-002", "test-abc-xyz", "12345"]

        for msg_id in test_ids:
            payload = {"data": {"messageId": msg_id}}
            response = requests.post(
                f"{BASE_URL}/",
                json=payload,
                headers={"Content-Type": "application/json"},
                timeout=10
            )
            assert response.status_code == 200
            data = response.json()
            assert data["body"]["data"]["messageId"] == msg_id

    def test_response_structure(self):
        """Test that response has expected structure."""
        payload = {
            "data": {
                "messageId": "structure-test"
            }
        }
        response = requests.post(
            f"{BASE_URL}/",
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()

        # Response should have body field with data structure
        # Note: "win" field may be absent in clean state (undefined doesn't serialize to JSON)
        # or present with null/actual value
        assert "body" in data
        assert "data" in data["body"]

    def test_post_with_special_characters_in_message_id(self):
        """Test handling of special characters in messageId."""
        special_ids = [
            "test-with-dash",
            "test_with_underscore",
            "test.with.dots",
            "test@with#special"
        ]

        for msg_id in special_ids:
            payload = {"data": {"messageId": msg_id}}
            response = requests.post(
                f"{BASE_URL}/",
                json=payload,
                headers={"Content-Type": "application/json"},
                timeout=10
            )
            assert response.status_code == 200
            data = response.json()
            assert data["body"]["data"]["messageId"] == msg_id

    def test_multiple_sequential_requests(self):
        """Test that multiple sequential requests work correctly."""
        for i in range(5):
            payload = {"data": {"messageId": f"sequential-{i}"}}
            response = requests.post(
                f"{BASE_URL}/",
                json=payload,
                headers={"Content-Type": "application/json"},
                timeout=10
            )
            assert response.status_code == 200
            data = response.json()
            assert data["body"]["data"]["messageId"] == f"sequential-{i}"


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_empty_message_id(self):
        """Test handling of empty messageId string."""
        payload = {"data": {"messageId": ""}}
        response = requests.post(
            f"{BASE_URL}/",
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        # Should either succeed or return validation error
        assert response.status_code in [200, 400, 422]

    def test_long_message_id(self):
        """Test handling of very long messageId."""
        long_id = "x" * 1000
        payload = {"data": {"messageId": long_id}}
        response = requests.post(
            f"{BASE_URL}/",
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        # Should either succeed or return appropriate error
        assert response.status_code in [200, 400, 413, 422]

    def test_unicode_message_id(self):
        """Test handling of unicode in messageId."""
        payload = {"data": {"messageId": "test-unicode-emoji"}}
        response = requests.post(
            f"{BASE_URL}/",
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
