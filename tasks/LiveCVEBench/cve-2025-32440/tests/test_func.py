#!/usr/bin/env python3
"""
Functionality tests for NetAlertX.
These tests verify the application works correctly after the fix is applied.
They should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost:20211"
TIMEOUT = 15


class TestLoginPageFunctionality:
    """Tests for login page basic functionality."""

    def test_login_page_loads(self):
        """Test that the login page loads and displays the login form."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=TIMEOUT)

        assert response.status_code == 200, f"Expected 200, got {response.status_code}"
        assert "loginpassword" in response.text, "Login password field not found"
        assert "NetAlert" in response.text, "NetAlertX branding not found"

    def test_login_page_contains_form(self):
        """Test that the login page contains the login form elements."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=TIMEOUT)

        assert response.status_code == 200
        assert '<form action="index.php"' in response.text, "Login form not found"
        assert 'type="password"' in response.text, "Password input not found"
        assert 'type="submit"' in response.text, "Submit button not found"

    def test_login_page_remember_me_option(self):
        """Test that the remember me checkbox is present."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=TIMEOUT)

        assert response.status_code == 200
        assert 'name="PWRemember"' in response.text, "Remember me checkbox not found"

    def test_root_redirects_to_login(self):
        """Test that root path works correctly."""
        response = requests.get(f"{BASE_URL}/", timeout=TIMEOUT, allow_redirects=True)

        # Should either show login page or redirect to it
        assert response.status_code == 200


class TestProtectedResourcesRequireAuth:
    """Tests that protected resources properly require authentication."""

    def test_devices_page_requires_auth(self):
        """Test that devices.php redirects to login when not authenticated."""
        response = requests.get(
            f"{BASE_URL}/devices.php",
            timeout=TIMEOUT,
            allow_redirects=True
        )

        # Should either redirect to login or show login page
        assert response.status_code == 200
        # After redirect chain, should land on login page
        assert "loginpassword" in response.text or "devices" in response.text.lower()

    def test_settings_page_requires_auth(self):
        """Test that settings.php redirects to login when not authenticated."""
        response = requests.get(
            f"{BASE_URL}/settings.php",
            timeout=TIMEOUT,
            allow_redirects=True
        )

        assert response.status_code in [200, 302, 401, 403]


class TestApplicationHealth:
    """Basic health checks for the application."""

    def test_application_is_responsive(self):
        """Test that the application responds within reasonable time."""
        start_time = time.time()
        response = requests.get(f"{BASE_URL}/index.php", timeout=TIMEOUT)
        elapsed_time = time.time() - start_time

        assert response.status_code == 200
        assert elapsed_time < 10, f"Response took too long: {elapsed_time}s"

    def test_css_resources_load(self):
        """Test that CSS resources are accessible."""
        response = requests.get(f"{BASE_URL}/css/app.css", timeout=TIMEOUT)

        # CSS file should exist
        assert response.status_code in [200, 304]

    def test_static_assets_accessible(self):
        """Test that static assets directory is accessible."""
        response = requests.get(f"{BASE_URL}/img/NetAlertX_logo.png", timeout=TIMEOUT)

        # Logo should be accessible
        assert response.status_code in [200, 304, 404]  # 404 acceptable if different path


class TestLogoutFunctionality:
    """Tests for logout functionality."""

    def test_logout_action_redirects(self):
        """Test that logout action redirects properly."""
        response = requests.get(
            f"{BASE_URL}/index.php?action=logout",
            timeout=TIMEOUT,
            allow_redirects=True
        )

        assert response.status_code == 200
        # Should redirect back to login page
        assert "loginpassword" in response.text or "index.php" in response.url


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-rA"])
