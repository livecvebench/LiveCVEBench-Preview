#!/bin/bash
set -e

# Wait for database to be ready
echo "Waiting for MariaDB..."
until mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" --skip-ssl -e "SELECT 1" 2>/dev/null; do
    sleep 2
    echo "Still waiting for database..."
done
echo "Database is ready!"

# Check if database is already initialized
if ! mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" --skip-ssl "$DB_NAME" -e "SELECT 1 FROM pessoa LIMIT 1" 2>/dev/null; then
    echo "Initializing database..."
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" --skip-ssl "$DB_NAME" < /app/BD/wegia001.sql
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" --skip-ssl "$DB_NAME" < /app/BD/wegia002.sql
    echo "Database initialized."
else
    echo "Database already initialized."
fi

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
