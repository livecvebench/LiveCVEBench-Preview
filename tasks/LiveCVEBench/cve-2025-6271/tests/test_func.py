"""
Functionality tests for wav2swf tool.

These tests verify that wav2swf works correctly with valid WAV files.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import wave
import os
import tempfile
import struct
import pytest


WAV2SWF_PATH = "/app/swftools/src/wav2swf"
TEST_DIR = "/tests"


def create_valid_wav(filename, channels=1, sampwidth=2, framerate=44100, duration_ms=100):
    """
    Create a valid WAV file with actual audio samples for testing.

    Args:
        filename: Path to output WAV file
        channels: Number of audio channels (1=mono, 2=stereo)
        sampwidth: Sample width in bytes (1=8-bit, 2=16-bit)
        framerate: Sample rate in Hz
        duration_ms: Duration in milliseconds
    """
    nframes = int(framerate * duration_ms / 1000)

    with wave.open(filename, 'w') as wav:
        wav.setnchannels(channels)
        wav.setsampwidth(sampwidth)
        wav.setframerate(framerate)

        # Generate simple sine-like pattern (alternating values)
        if sampwidth == 1:
            # 8-bit audio is unsigned (0-255, center at 128)
            samples = bytes([128 + (i % 100) - 50 for i in range(nframes * channels)])
        elif sampwidth == 2:
            # 16-bit audio is signed (-32768 to 32767)
            samples = b''.join([
                struct.pack('<h', (i % 1000) - 500)
                for i in range(nframes * channels)
            ])
        else:
            raise ValueError(f"Unsupported sample width: {sampwidth}")

        wav.writeframes(samples)


class TestBasicWavConversion:
    """Test basic WAV to SWF conversion functionality."""

    def test_mono_16bit_conversion(self, tmp_path):
        """Test converting a standard 16-bit mono WAV file."""
        wav_file = str(tmp_path / "mono_16bit.wav")
        swf_file = str(tmp_path / "mono_16bit.swf")

        create_valid_wav(wav_file, channels=1, sampwidth=2, framerate=44100)

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"
        assert os.path.getsize(swf_file) > 0, "Output SWF file is empty"

    def test_stereo_16bit_conversion(self, tmp_path):
        """Test converting a standard 16-bit stereo WAV file."""
        wav_file = str(tmp_path / "stereo_16bit.wav")
        swf_file = str(tmp_path / "stereo_16bit.swf")

        create_valid_wav(wav_file, channels=2, sampwidth=2, framerate=44100)

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"
        assert os.path.getsize(swf_file) > 0, "Output SWF file is empty"

    def test_mono_8bit_conversion(self, tmp_path):
        """Test converting an 8-bit mono WAV file."""
        wav_file = str(tmp_path / "mono_8bit.wav")
        swf_file = str(tmp_path / "mono_8bit.swf")

        create_valid_wav(wav_file, channels=1, sampwidth=1, framerate=22050)

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"

    def test_stereo_8bit_conversion(self, tmp_path):
        """Test converting an 8-bit stereo WAV file."""
        wav_file = str(tmp_path / "stereo_8bit.wav")
        swf_file = str(tmp_path / "stereo_8bit.swf")

        create_valid_wav(wav_file, channels=2, sampwidth=1, framerate=22050)

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"


class TestDifferentSampleRates:
    """Test WAV files with various sample rates."""

    def test_11025hz_conversion(self, tmp_path):
        """Test converting a low sample rate WAV file (11025 Hz)."""
        wav_file = str(tmp_path / "low_samplerate.wav")
        swf_file = str(tmp_path / "low_samplerate.swf")

        create_valid_wav(wav_file, channels=1, sampwidth=2, framerate=11025)

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"

    def test_22050hz_conversion(self, tmp_path):
        """Test converting a 22050 Hz WAV file."""
        wav_file = str(tmp_path / "medium_samplerate.wav")
        swf_file = str(tmp_path / "medium_samplerate.swf")

        create_valid_wav(wav_file, channels=1, sampwidth=2, framerate=22050)

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"

    def test_48000hz_conversion(self, tmp_path):
        """Test converting a high sample rate WAV file (48000 Hz)."""
        wav_file = str(tmp_path / "high_samplerate.wav")
        swf_file = str(tmp_path / "high_samplerate.swf")

        create_valid_wav(wav_file, channels=2, sampwidth=2, framerate=48000)

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"


class TestCommandLineOptions:
    """Test various command line options for wav2swf."""

    def test_custom_sample_rate_option(self, tmp_path):
        """Test using -r option to set sample rate."""
        wav_file = str(tmp_path / "for_resample.wav")
        swf_file = str(tmp_path / "resampled.swf")

        create_valid_wav(wav_file, channels=1, sampwidth=2, framerate=44100)

        result = subprocess.run(
            [WAV2SWF_PATH, "-r", "22050", "-o", swf_file, wav_file],
            capture_output=True,
            text=True,
            timeout=30
        )

        assert result.returncode == 0, f"wav2swf failed with -r option: {result.stderr}"
        assert os.path.exists(swf_file), "Output SWF file was not created"

    def test_help_option(self):
        """Test that -h/--help option works."""
        result = subprocess.run(
            [WAV2SWF_PATH, "-h"],
            capture_output=True,
            text=True,
            timeout=10
        )

        # Help usually returns 0 or 1, but should print usage info
        assert "wav2swf" in result.stdout.lower() or "wav2swf" in result.stderr.lower() or \
               "usage" in result.stdout.lower() or "usage" in result.stderr.lower(), \
               "Help output should mention wav2swf or usage"


class TestErrorHandling:
    """Test proper error handling for invalid inputs."""

    def test_nonexistent_file(self):
        """Test that wav2swf handles non-existent input files gracefully."""
        result = subprocess.run(
            [WAV2SWF_PATH, "-o", "/tmp/output.swf", "/nonexistent/file.wav"],
            capture_output=True,
            text=True,
            timeout=10
        )

        # Should fail but not crash
        assert result.returncode != 0, "Should fail on non-existent file"

    def test_empty_file(self, tmp_path):
        """Test that wav2swf handles empty files gracefully."""
        empty_file = str(tmp_path / "empty.wav")
        swf_file = str(tmp_path / "empty.swf")

        # Create empty file
        with open(empty_file, 'wb') as f:
            pass

        result = subprocess.run(
            [WAV2SWF_PATH, "-o", swf_file, empty_file],
            capture_output=True,
            text=True,
            timeout=10
        )

        # Should fail but not crash
        assert result.returncode != 0, "Should fail on empty file"


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-rA"])
