#!/bin/bash
# Solution script for fixing SQL injection vulnerability in add_category.php
# Uses prepared statements with parameterized queries

set -e

TARGET_FILE="/var/www/html/Supply_Management_System/admin/add_category.php"

echo "Applying SQL injection fix to add_category.php..."

# Check if file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo "Error: Target file not found at $TARGET_FILE"
    exit 1
fi

# Create backup
cp "$TARGET_FILE" "${TARGET_FILE}.bak"

# Use PHP to perform the replacement since it handles the complex PHP syntax better
php -r "
\$file = '$TARGET_FILE';
\$content = file_get_contents(\$file);

// Replace the vulnerable SQL query with prepared statement
\$vulnerable_query = '\$query_addCategory = \"INSERT INTO categories(cat_name,cat_details) VALUES(\'\$categoryName\',\'\$categoryDetails\')\";';
\$fixed_query = '\$stmt = mysqli_prepare(\$con, \"INSERT INTO categories(cat_name,cat_details) VALUES(?,?)\");
			mysqli_stmt_bind_param(\$stmt, \"ss\", \$categoryName, \$categoryDetails);';

\$content = str_replace(\$vulnerable_query, \$fixed_query, \$content);

// Replace the mysqli_query call with mysqli_stmt_execute
\$vulnerable_exec = 'if(mysqli_query(\$con,\$query_addCategory))';
\$fixed_exec = 'if(mysqli_stmt_execute(\$stmt))';

\$content = str_replace(\$vulnerable_exec, \$fixed_exec, \$content);

// Write the fixed content
file_put_contents(\$file, \$content);

echo 'File patched successfully.\n';
"

# Verify the fix was applied
if grep -q "mysqli_prepare" "$TARGET_FILE" && grep -q "mysqli_stmt_bind_param" "$TARGET_FILE"; then
    echo "Fix applied successfully!"
    echo "Prepared statement implementation verified."
else
    echo "Warning: Fix may not have been applied correctly. Checking file..."
    grep -n "INSERT INTO categories" "$TARGET_FILE" || true
fi

# Note: Apache/PHP serves files dynamically, so no restart needed for PHP code changes
echo "Fix complete."
