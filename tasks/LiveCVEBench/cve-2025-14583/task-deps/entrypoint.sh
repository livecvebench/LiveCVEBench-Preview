#!/bin/bash
set -e

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready..."
max_tries=30
counter=0

while ! php -r "
\$host = getenv('DB_HOST') ?: 'db';
\$user = getenv('DB_USER') ?: 'root';
\$pass = getenv('DB_PASS') ?: 'root';
\$db = getenv('DB_NAME') ?: 'student';
\$conn = @mysqli_connect(\$host, \$user, \$pass, \$db);
if (\$conn) { mysqli_close(\$conn); exit(0); }
exit(1);
" 2>/dev/null; do
    counter=$((counter + 1))
    if [ $counter -ge $max_tries ]; then
        echo "Error: MySQL not available after $max_tries attempts"
        exit 1
    fi
    echo "MySQL not ready, waiting... ($counter/$max_tries)"
    sleep 2
done

echo "MySQL is ready!"

# Start Apache in foreground
exec apache2-foreground
