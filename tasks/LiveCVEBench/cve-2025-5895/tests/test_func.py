"""
Functional tests for parseDataUri function.
These tests verify that the function correctly parses valid data URIs.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import pytest
import os

# Path to the test helper that runs the JavaScript function
TEST_DIR = os.path.dirname(os.path.abspath(__file__))


def run_parse_data_uri(input_uri: str, timeout: int = 30) -> dict:
    """
    Run the parseDataUri function with the given input and return the result.
    Returns a dict with 'result' (the parsed object or null) and 'duration_ms'.
    """
    # Create a temporary JS script to test the function
    js_code = f'''
const {{ parseDataUri }} = require('/app/frontend/src/metabase/lib/dom.js');
const input = {repr(input_uri)};
const start = Date.now();
let result;
try {{
    result = parseDataUri(input);
}} catch (e) {{
    result = {{"error": e.message}};
}}
const duration = Date.now() - start;
console.log(JSON.stringify({{result: result, duration_ms: duration}}));
'''

    try:
        result = subprocess.run(
            ['node', '-e', js_code],
            capture_output=True,
            text=True,
            timeout=timeout,
            cwd='/app'
        )
        if result.returncode != 0:
            return {"result": None, "duration_ms": 0, "error": result.stderr}

        import json
        return json.loads(result.stdout.strip())
    except subprocess.TimeoutExpired:
        return {"result": None, "duration_ms": timeout * 1000, "timeout": True}
    except Exception as e:
        return {"result": None, "duration_ms": 0, "error": str(e)}


class TestParseDataUriFunctional:
    """Functional tests for valid data URI parsing."""

    def test_parse_simple_text_data_uri(self):
        """Test parsing a simple text data URI without encoding."""
        uri = "data:text/plain,Hello World"
        result = run_parse_data_uri(uri)

        assert result.get("result") is not None, f"Expected parsed result, got: {result}"
        parsed = result["result"]
        assert parsed["mimeType"] == "text/plain"
        assert "Hello World" in parsed.get("data", "") or "Hello World" in parsed.get("base64", "")

    def test_parse_base64_encoded_data_uri(self):
        """Test parsing a base64 encoded data URI."""
        # "Hello, World!" base64 encoded is "SGVsbG8sIFdvcmxkIQ=="
        uri = "data:text/plain;base64,SGVsbG8sIFdvcmxkIQ=="
        result = run_parse_data_uri(uri)

        assert result.get("result") is not None, f"Expected parsed result, got: {result}"
        parsed = result["result"]
        assert parsed["mimeType"] == "text/plain"
        # The decoded data should be "Hello, World!"
        assert parsed.get("data") == "Hello, World!"

    def test_parse_data_uri_with_charset(self):
        """Test parsing a data URI with charset parameter."""
        uri = "data:text/plain;charset=utf-8,Test Data"
        result = run_parse_data_uri(uri)

        assert result.get("result") is not None, f"Expected parsed result, got: {result}"
        parsed = result["result"]
        assert parsed["mimeType"] == "text/plain"
        assert "charset" in parsed.get("charset", "") or parsed.get("charset") == "charset=utf-8"

    def test_parse_data_uri_with_charset_and_base64(self):
        """Test parsing a data URI with both charset and base64."""
        # "Test" base64 encoded is "VGVzdA=="
        uri = "data:text/plain;charset=utf-8;base64,VGVzdA=="
        result = run_parse_data_uri(uri)

        assert result.get("result") is not None, f"Expected parsed result, got: {result}"
        parsed = result["result"]
        assert parsed["mimeType"] == "text/plain"

    def test_parse_image_data_uri(self):
        """Test parsing an image data URI (common use case)."""
        # Small 1x1 transparent PNG
        uri = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
        result = run_parse_data_uri(uri)

        assert result.get("result") is not None, f"Expected parsed result, got: {result}"
        parsed = result["result"]
        assert parsed["mimeType"] == "image/png"

    def test_return_null_for_invalid_prefix(self):
        """Test that invalid data URI prefix returns null."""
        invalid_uris = [
            "not-a-data-uri",
            "http://example.com",
            "d4ta:text/plain,test",
            "DATA:text/plain,test",  # Case sensitive
            "dataa:text/plain,test",
        ]

        for uri in invalid_uris:
            result = run_parse_data_uri(uri)
            assert result.get("result") is None, f"Expected null for invalid URI '{uri}', got: {result}"

    def test_return_null_for_null_input(self):
        """Test that null input returns null."""
        js_code = '''
const { parseDataUri } = require('/app/frontend/src/metabase/lib/dom.js');
console.log(JSON.stringify({result: parseDataUri(null), duration_ms: 0}));
'''
        result = subprocess.run(
            ['node', '-e', js_code],
            capture_output=True,
            text=True,
            timeout=10,
            cwd='/app'
        )
        import json
        parsed = json.loads(result.stdout.strip())
        assert parsed["result"] is None

    def test_return_null_for_undefined_input(self):
        """Test that undefined input returns null."""
        js_code = '''
const { parseDataUri } = require('/app/frontend/src/metabase/lib/dom.js');
console.log(JSON.stringify({result: parseDataUri(undefined), duration_ms: 0}));
'''
        result = subprocess.run(
            ['node', '-e', js_code],
            capture_output=True,
            text=True,
            timeout=10,
            cwd='/app'
        )
        import json
        parsed = json.loads(result.stdout.strip())
        assert parsed["result"] is None

    def test_parse_data_uri_minimal(self):
        """Test parsing minimal valid data URI."""
        uri = "data:,test"
        result = run_parse_data_uri(uri)

        # Should either return parsed result or null, but not hang
        assert result.get("duration_ms", 0) < 1000, "Function should not hang on minimal input"

    def test_parse_application_json_data_uri(self):
        """Test parsing JSON data URI."""
        import base64
        json_data = '{"key": "value"}'
        encoded = base64.b64encode(json_data.encode()).decode()
        uri = f"data:application/json;base64,{encoded}"
        result = run_parse_data_uri(uri)

        assert result.get("result") is not None, f"Expected parsed result, got: {result}"
        parsed = result["result"]
        assert parsed["mimeType"] == "application/json"
