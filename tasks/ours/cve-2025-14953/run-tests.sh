#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install uv package manager
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize project and install dependencies
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

# Build PoC binary
echo "Building PoC..."
mkdir -p /poc
go mod tidy
go build -o /poc/poc .

# Wait for UPF to be fully ready
echo "Waiting for UPF to be ready..."
for i in {1..30}; do
    if timeout 2 bash -c "echo > /dev/udp/127.0.0.7/8805" 2>/dev/null; then
        echo "UPF PFCP port is accessible"
        break
    fi
    sleep 1
done

# Run all tests
echo "Running tests..."
uv run pytest . -rA -v
