FROM php:7.4-apache

WORKDIR /var/www/html

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    unzip \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Install mysqli extension for PHP-MySQL connectivity
RUN docker-php-ext-install mysqli

# Download and extract the Voting System
RUN curl -L -o /tmp/votesystem.zip "https://download-media.code-projects.org/2020/02/VOTING_SYSTEM_IN_PHP_WITH_SOURCE_CODE.zip" \
    && unzip /tmp/votesystem.zip -d /tmp/ \
    && cp -r /tmp/VotingSystem_PHP/votesystem /var/www/html/ \
    && rm -rf /tmp/votesystem.zip /tmp/VotingSystem_PHP

# Update database connection to use MySQL container hostname
# There are two conn.php files that need to be updated
RUN sed -i "s/'localhost'/'mysql'/g" /var/www/html/votesystem/admin/includes/conn.php \
    && sed -i "s/'', 'votesystem'/'root', 'votesystem'/g" /var/www/html/votesystem/admin/includes/conn.php \
    && sed -i "s/'localhost'/'mysql'/g" /var/www/html/votesystem/includes/conn.php \
    && sed -i "s/'', 'votesystem'/'root', 'votesystem'/g" /var/www/html/votesystem/includes/conn.php

# Set file permissions for images directory (for candidate photo uploads)
RUN chmod 777 /var/www/html/votesystem/images/

# Ensure session directory exists and is writable
RUN mkdir -p /var/lib/php/sessions && chmod 777 /var/lib/php/sessions

# Suppress PHP warnings/notices for cleaner output on PHP 7.4+
RUN echo "error_reporting = E_ALL & ~E_DEPRECATED & ~E_NOTICE & ~E_WARNING" >> /usr/local/etc/php/php.ini

# Environment variables for database connection
ENV DB_HOST=mysql
ENV DB_USER=root
ENV DB_PASS=root
ENV DB_NAME=votesystem

# Expose port 80
EXPOSE 80

# Use default Apache foreground command
# PHP is interpreted at request time, so no restart needed for code changes
# CMD ["apache2-foreground"]
