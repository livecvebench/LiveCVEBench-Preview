"""
Functional tests for the Mesh Connect SDK.

These tests verify that the SDK works correctly for legitimate use cases.
They should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import json

def run_jest_tests(test_pattern):
    """Run Jest tests matching the given pattern and return the result."""
    result = subprocess.run(
        ['npm', 'test', '--', '--testNamePattern', test_pattern, '--ci', '--json'],
        cwd='/app/packages/link',
        capture_output=True,
        text=True,
        timeout=120
    )
    return result

def run_jest_file(test_file):
    """Run a specific Jest test file."""
    result = subprocess.run(
        ['npm', 'test', '--', test_file, '--ci'],
        cwd='/app/packages/link',
        capture_output=True,
        text=True,
        timeout=120
    )
    return result


class TestFunctionalBehavior:
    """Tests for basic SDK functionality that should work in both states."""

    def test_empty_token_rejected(self):
        """Empty link token should trigger onExit with 'Invalid link token!'"""
        result = run_jest_file('src/tests/func_empty_token.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_valid_http_url_works(self):
        """Valid http:// URL should create iframe successfully."""
        result = run_jest_file('src/tests/func_valid_http.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_valid_https_url_works(self):
        """Valid https:// URL should create iframe successfully."""
        result = run_jest_file('src/tests/func_valid_https.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_language_parameter_added(self):
        """Language parameter should be appended to URL."""
        result = run_jest_file('src/tests/func_language.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_custom_iframe_id_works(self):
        """Custom iframe ID should be supported."""
        result = run_jest_file('src/tests/func_custom_iframe.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_close_link_removes_popup(self):
        """closeLink() should remove the popup and trigger onExit."""
        result = run_jest_file('src/tests/func_close_link.test.ts')
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"
