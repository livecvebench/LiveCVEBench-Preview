#!/bin/bash
set -e

echo "[INFO] Initializing Test Environment..."

# --- 1. 清理环境 ---
rm -f /app/database/database.sqlite
rm -f installed.lock

# --- 2. 配置 SQLite ---
mkdir -p /app/database
touch /app/database/database.sqlite
chmod -R 777 /app/database
chmod -R 777 /app/storage /app/bootstrap/cache

if [ ! -f ".env" ]; then
    cp .env.example .env
fi

sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=sqlite/' .env
sed -i 's/DB_DATABASE=.*/DB_DATABASE=\/app\/database\/database.sqlite/' .env

php artisan config:clear

# --- 3. 初始化 UnoPim ---
echo "[INFO] Installing UnoPim..."
php artisan key:generate

# 删除不兼容的迁移文件
find . -name "*audits_trigger.php" -delete

# 修复 Seeder 不兼容问题
find . -name "CurrencyTableSeeder.php" -exec sed -i "/'id'/d" {} +
find . -name "LocaleTableSeeder.php" -exec sed -i "/'id'/d" {} +

echo "[INFO] Running migrations..."
php artisan migrate --force

echo "[INFO] Seeding database..."
php artisan db:seed --force

echo "[INFO] Creating test data..."

# === 关键修改：不再使用 tinker，而是生成一个独立的 PHP 脚本来引导 Laravel ===
cat > setup_data.php << 'PHP_SCRIPT'
<?php
// 1. 手动引导 Laravel 框架
require __DIR__ . '/vendor/autoload.php';
$app = require_once __DIR__ . '/bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();

// 2. 这里的代码现在是标准的 PHP 代码，不需要通过 Shell 交互
use Webkul\Core\Models\Locale;
use Webkul\Core\Models\Currency;
use Webkul\Product\Models\Product;
use Webkul\User\Models\Role;
use Webkul\User\Models\Admin;

echo "Creating Locale and Currency...\n";
$locale = Locale::where('code', 'en_US')->orWhere('code', 'en')->first();
$currency = Currency::where('code', 'USD')->first();

if (!$locale || !$currency) {
    if (!$locale) $locale = Locale::create(['code' => 'en', 'name' => 'English', 'direction' => 'ltr']);
    if (!$currency) $currency = Currency::create(['code' => 'USD', 'name' => 'US Dollar', 'symbol' => '$']);
}

echo "Creating Product...\n";
$product = new Product();
$product->sku = 'test-product-001';
$product->type = 'simple';
$product->attribute_family_id = 1;
$product->save();

echo "Creating Staff Role...\n";
$role = Role::create([
    'name' => 'Staff',
    'permission_type' => 'custom',
    'permissions' => [
        'dashboard',
        'catalog',
        'catalog.products',
        'catalog.products.index',
        'catalog.products.edit', 
    ]
]);

echo "Creating Low Priv User...\n";
$admin = Admin::create([
    'name' => 'Low Priv User',
    'email' => 'nopriv@example.com',
    'password' => bcrypt('password123'),
    'role_id' => $role->id,
    'status' => 1
]);

echo "Ensuring Super Admin...\n";
$super = Admin::where('email', 'admin@example.com')->first();
if (!$super) {
    Admin::create([
        'name' => 'Super Admin',
        'email' => 'admin@example.com',
        'password' => bcrypt('admin'),
        'role_id' => 1,
        'status' => 1
    ]);
}
echo "Setup Data Complete.\n";
PHP_SCRIPT

# 直接用 php 运行这个文件，稳定且不会报错退出
php setup_data.php

rm setup_data.php
touch installed.lock
echo "[INFO] Environment ready."

# --- 4. 运行测试 ---
service apache2 start || true

echo "[INFO] Running tests..."
sed -i 's/localhost:80/localhost/g' /tests/test_outputs.py

# 确保输出详细信息
apt-get update
apt-get install -y curl

# Install uv
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh

source $HOME/.local/bin/env

# Check if we're in a valid working directory
if [ "$PWD" = "/" ]; then
    echo "Error: No working directory set. Please set a WORKDIR in your Dockerfile before running this script."
    exit 1
fi

uv venv .tbench-testing
source .tbench-testing/bin/activate
uv pip install pytest==8.4.1 beautifulsoup4 requests

# Run pytest

uv run pytest $TEST_DIR/test_outputs.py -rA