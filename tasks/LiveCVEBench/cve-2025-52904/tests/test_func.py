"""
Functional tests for FileBrowser application.
These tests verify that basic functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import subprocess
import os

# Configuration
BASE_URL = os.environ.get("FILEBROWSER_URL", "http://localhost:8080")
ADMIN_USER = "admin"
ADMIN_PASS = os.environ.get("ADMIN_PASSWORD", "admin")  # Default password in v2.32.0
TEST_USER = "user1"
TEST_USER_PASS = "password123"


class TestApplicationStartup:
    """Tests for verifying the application starts and responds correctly."""

    def test_application_responds(self):
        """Test that FileBrowser web server is running and responds."""
        max_retries = 30
        for i in range(max_retries):
            try:
                response = requests.get(f"{BASE_URL}/", timeout=5)
                # FileBrowser returns 200/302 for HTML or 404 if no frontend is embedded
                # In v2.32.0 built from source, frontend may not be embedded
                assert response.status_code in [200, 302, 303, 404]
                return
            except requests.exceptions.ConnectionError:
                if i < max_retries - 1:
                    time.sleep(1)
                    continue
                raise
        pytest.fail("Application did not respond within timeout")

    def test_api_health_endpoint(self):
        """Test that the API is accessible."""
        # Try health endpoint or just verify API responds
        response = requests.get(f"{BASE_URL}/api/health", timeout=5)
        # Health endpoint may not exist, but API should be accessible
        assert response.status_code in [200, 401, 404]


class TestAuthentication:
    """Tests for user authentication functionality."""

    def get_auth_token(self, username, password):
        """Helper to get JWT token for a user."""
        response = requests.post(
            f"{BASE_URL}/api/login",
            json={"username": username, "password": password},
            timeout=10
        )
        if response.status_code == 200:
            return response.text.strip('"')  # Token is returned as JSON string
        return None

    def test_admin_login(self):
        """Test that admin user can login."""
        # Try with default admin password
        token = self.get_auth_token(ADMIN_USER, ADMIN_PASS)
        # If default doesn't work, the test user might have different credentials
        # This is acceptable as long as some user can authenticate
        if token is None:
            # Try with test user
            token = self.get_auth_token(TEST_USER, TEST_USER_PASS)
        assert token is not None, "Failed to authenticate with any user"

    def test_invalid_login_rejected(self):
        """Test that invalid credentials are rejected."""
        response = requests.post(
            f"{BASE_URL}/api/login",
            json={"username": "nonexistent", "password": "wrongpass"},
            timeout=10
        )
        assert response.status_code in [403, 401]

    def test_authenticated_request(self):
        """Test that authenticated requests work."""
        token = self.get_auth_token(TEST_USER, TEST_USER_PASS)
        if token is None:
            token = self.get_auth_token(ADMIN_USER, ADMIN_PASS)

        if token:
            headers = {"X-Auth": token}
            response = requests.get(
                f"{BASE_URL}/api/resources/",
                headers=headers,
                timeout=10
            )
            assert response.status_code in [200, 403, 404]


class TestFileOperations:
    """Tests for file browsing and operations."""

    @pytest.fixture
    def auth_headers(self):
        """Get authentication headers for test user."""
        response = requests.post(
            f"{BASE_URL}/api/login",
            json={"username": TEST_USER, "password": TEST_USER_PASS},
            timeout=10
        )
        if response.status_code == 200:
            token = response.text.strip('"')
            return {"X-Auth": token}
        # Fallback to admin
        response = requests.post(
            f"{BASE_URL}/api/login",
            json={"username": ADMIN_USER, "password": ADMIN_PASS},
            timeout=10
        )
        if response.status_code == 200:
            token = response.text.strip('"')
            return {"X-Auth": token}
        pytest.skip("Could not authenticate")

    def test_list_user_directory(self, auth_headers):
        """Test that user can list files in their scope."""
        response = requests.get(
            f"{BASE_URL}/api/resources/",
            headers=auth_headers,
            timeout=10
        )
        # User should be able to access their root directory
        assert response.status_code in [200, 404]

    def test_file_operations_respect_scope_via_api(self, auth_headers):
        """Test that file API operations respect user scope boundaries."""
        # Try to access a path that would be outside a restricted user's scope
        # The API should either deny access or return an error
        response = requests.get(
            f"{BASE_URL}/api/resources/../../../etc/passwd",
            headers=auth_headers,
            timeout=10
        )
        # Should not return file contents from /etc/passwd
        if response.status_code == 200:
            content = response.text
            assert "root:" not in content, "Path traversal should be blocked"


class TestWebInterface:
    """Tests for web interface availability."""

    def test_login_page_loads(self):
        """Test that the login page loads correctly."""
        response = requests.get(f"{BASE_URL}/login", timeout=10)
        # Should redirect or serve the SPA, or 404 if no frontend is embedded
        # In v2.32.0 built from source, frontend may not be embedded
        assert response.status_code in [200, 302, 303, 404]

    def test_static_assets_available(self):
        """Test that static assets are served."""
        response = requests.get(f"{BASE_URL}/static/js/app.js", timeout=10)
        # Static assets may have different paths, just verify we don't get 500
        assert response.status_code != 500


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
