FROM python:3.11-slim

WORKDIR /app/tautulli

# Environment variables for Tautulli
ENV TAUTULLI_DOCKER=True

# Install system dependencies (tmux, asciinema, curl required by builder)
RUN apt-get update && apt-get install -y \
    git \
    curl \
    tmux \
    asciinema \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Clone vulnerable Tautulli version and remove git history
RUN git clone --branch v2.15.3 --depth 1 https://github.com/Tautulli/Tautulli.git . && \
    rm -rf .git

# Copy and install Python dependencies
COPY task-deps/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt && \
    rm /tmp/requirements.txt

# Create data directory and copy config
RUN mkdir -p /config
COPY task-deps/config.ini /config/config.ini

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose default Tautulli port
EXPOSE 8181

# Start Tautulli via entrypoint wrapper
# CMD ["/entrypoint.sh"]
