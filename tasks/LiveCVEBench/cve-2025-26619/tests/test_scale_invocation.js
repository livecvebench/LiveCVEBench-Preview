/**
 * Test helper to verify that scale() does not invoke function arguments.
 *
 * This tests the complete flow: scale() -> getScale() -> invocation
 * In vulnerable version: the function is invoked (test FAILS)
 * In fixed version: the function is not invoked (test PASSES)
 */

// Import the scale function from the built package
// Note: getScale is an internal function and not exported
const { scale } = require('/app/packages/vega-functions/build/vega-functions.js');

// Track if our test function was invoked
let wasInvoked = false;
let invokedWith = null;

// Create a test function that records when it's called
function testFunction(arg) {
    wasInvoked = true;
    invokedWith = arg;
    return 'invoked!';
}

// Create a mock context
const mockContext = {
    scales: {}
};

// Create a mock 'this' context with the mock context
const mockThis = {
    context: mockContext
};

// Try to call scale with a function as the first argument
// In vulnerable version: testFunction will be called with 'test_arg'
// In fixed version: testFunction will not be called
try {
    // Bind scale to our mock context and call it
    const result = scale.call(mockThis, testFunction, 'test_arg');

    if (wasInvoked) {
        console.log(`FAIL: function was invoked with argument: ${invokedWith}`);
    } else {
        console.log('PASS: function not invoked');
    }
} catch (error) {
    // If an error is thrown, the function might still have been invoked
    // but something else failed. Check wasInvoked.
    if (wasInvoked) {
        console.log(`FAIL: function was invoked (error occurred after): ${error.message}`);
    } else {
        // Error without invocation means getScale returned undefined
        // and scale() tried to call undefined, which is expected
        console.log('PASS: function not invoked');
    }
}
