#!/bin/bash
set -e

cd "$(dirname "$0")"

# Install uv for Python package management
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize uv project and add pytest
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

# Check if server is already running by checking if port 8000 is in use
echo "Checking if server is already running..."
if echo "" | nc -w1 localhost 8000 > /dev/null 2>&1; then
    echo "Server is already running - using existing instance"
    SERVER_RUNNING=true
else
    echo "Server not detected - starting new instance..."
    node /app/scripts/server.js &
    SERVER_PID=$!

    # Wait for server to start
    sleep 3

    # Verify server is running
    if ! kill -0 $SERVER_PID 2>/dev/null; then
        echo "ERROR: Server failed to start"
        exit 1
    fi

    echo "Server started with PID $SERVER_PID"
    SERVER_RUNNING=false
fi

# Function to cleanup on exit (only kill server if we started it)
cleanup() {
    if [ "$SERVER_RUNNING" = "false" ]; then
        echo "Cleaning up server we started..."
        kill $SERVER_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
    else
        echo "Leaving existing server running..."
    fi
}

# Set trap to cleanup on exit
trap cleanup EXIT

# Run pytest
echo "Running tests..."
uv run pytest . -rA

echo "Tests completed."
