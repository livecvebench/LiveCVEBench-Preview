"""
Functional tests for the Retro Basketball Shoes Online Store.
These tests verify that stock management features work correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time


BASE_URL = "http://localhost:80"
ADMIN_URL = f"{BASE_URL}/admin"
LOGIN_URL = f"{ADMIN_URL}/index.php"
STOCK_URL = f"{ADMIN_URL}/admin_running.php"

# Test with a known product ID from the database (Nike category)
TEST_PRODUCT_ID = "68129"


class TestSession:
    """Helper class to manage admin session"""
    _session = None
    _cookies = None

    @classmethod
    def get_session(cls):
        if cls._session is None:
            cls._session = requests.Session()
            cls._login()
        return cls._session

    @classmethod
    def _login(cls):
        """Login to admin panel"""
        login_data = {
            'username': 'admin',
            'password': 'admin',
            'login': ''
        }
        response = cls._session.post(LOGIN_URL, data=login_data, allow_redirects=True)
        # Verify we're logged in by checking we can access admin page
        return response

    @classmethod
    def get_cookies(cls):
        if cls._cookies is None:
            session = cls.get_session()
            cls._cookies = session.cookies.get_dict()
        return cls._cookies


@pytest.fixture(scope="module")
def admin_session():
    """Fixture that provides an authenticated admin session"""
    return TestSession.get_session()


class TestAdminPageAccess:
    """Test that admin pages load correctly"""

    def test_admin_login_page_loads(self):
        """Test that the admin login page is accessible"""
        response = requests.get(LOGIN_URL, timeout=10)
        assert response.status_code == 200
        assert "login" in response.text.lower() or "admin" in response.text.lower()

    def test_admin_running_page_loads_after_login(self, admin_session):
        """Test that the Nike products page loads after login"""
        response = admin_session.get(STOCK_URL, timeout=10)
        assert response.status_code == 200
        # Should contain Nike products
        assert "Nike" in response.text

    def test_admin_page_shows_products(self, admin_session):
        """Test that products are displayed on the admin page"""
        response = admin_session.get(STOCK_URL, timeout=10)
        assert response.status_code == 200
        # Should show stock management buttons
        assert "Stock In" in response.text or "stockin" in response.text.lower()


class TestStockInFunctionality:
    """Test stock-in operations with valid data"""

    def test_stockin_with_valid_product_id(self, admin_session):
        """Test that stock-in with valid numeric product ID works"""
        data = {
            'pid': TEST_PRODUCT_ID,
            'new_stck': '1',
            'stockin': ''
        }

        start_time = time.time()
        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        elapsed = time.time() - start_time

        # Should complete quickly (under 3 seconds)
        assert elapsed < 3, f"Request took too long: {elapsed:.2f}s"
        # Should return a valid response
        assert response.status_code == 200

    def test_stockin_adds_quantity(self, admin_session):
        """Test that stock-in properly increases stock quantity"""
        # Get initial stock value
        response = admin_session.get(STOCK_URL, timeout=10)
        assert response.status_code == 200

        # Perform stock-in
        data = {
            'pid': TEST_PRODUCT_ID,
            'new_stck': '0',  # Add 0 to avoid changing data
            'stockin': ''
        }
        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        assert response.status_code == 200

    def test_stockin_response_contains_redirect(self, admin_session):
        """Test that successful stock-in redirects back to admin page"""
        data = {
            'pid': TEST_PRODUCT_ID,
            'new_stck': '0',
            'stockin': ''
        }
        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        # The response should contain a redirect script
        assert response.status_code == 200


class TestStockOutFunctionality:
    """Test stock-out operations with valid data"""

    def test_stockout_with_valid_product_id(self, admin_session):
        """Test that stock-out with valid numeric product ID works"""
        data = {
            'pid': TEST_PRODUCT_ID,
            'new_stck': '0',  # Subtract 0 to avoid changing data
            'stockout': ''
        }

        start_time = time.time()
        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        elapsed = time.time() - start_time

        # Should complete quickly
        assert elapsed < 3, f"Request took too long: {elapsed:.2f}s"
        assert response.status_code == 200

    def test_stockout_with_another_product(self, admin_session):
        """Test stock-out with another valid product ID"""
        # Using another Nike product ID from the database
        data = {
            'pid': '86554',
            'new_stck': '0',
            'stockout': ''
        }

        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        assert response.status_code == 200


class TestInputValidation:
    """Test that valid inputs are accepted"""

    def test_numeric_product_id_accepted(self, admin_session):
        """Test that numeric product IDs are accepted"""
        data = {
            'pid': '68129',
            'new_stck': '1',
            'stockin': ''
        }
        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        assert response.status_code == 200

    def test_zero_quantity_accepted(self, admin_session):
        """Test that zero quantity updates are accepted"""
        data = {
            'pid': TEST_PRODUCT_ID,
            'new_stck': '0',
            'stockin': ''
        }
        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        assert response.status_code == 200

    def test_large_quantity_accepted(self, admin_session):
        """Test that large quantity values are accepted"""
        data = {
            'pid': TEST_PRODUCT_ID,
            'new_stck': '100',
            'stockin': ''
        }
        response = admin_session.post(STOCK_URL, data=data, timeout=15)
        assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
