#!/bin/bash
set -e

# CVE-2025-8291 Fix: Validate ZIP64 EOCD offset and size fields
#
# This fix patches Python's zipfile module to properly validate the offset
# specified in the ZIP64 End of Central Directory Locator and the size field
# in the ZIP64 End of Central Directory record.

# Find the zipfile module location
ZIPFILE_PATH=$(python3 -c "import zipfile; print(zipfile.__file__)")

if [ ! -f "$ZIPFILE_PATH" ]; then
    echo "ERROR: Could not find zipfile module at $ZIPFILE_PATH"
    exit 1
fi

echo "Patching zipfile module at: $ZIPFILE_PATH"

# Create backup
cp "$ZIPFILE_PATH" "${ZIPFILE_PATH}.bak"

# Replace with the fixed version from task-deps
cp /app/task-deps/zipfile_fixed.py "$ZIPFILE_PATH"

# Verify the fix was applied
python3 -c "
import zipfile
import inspect

# Check that BadZipFile is caught in is_zipfile
source = inspect.getsource(zipfile.is_zipfile)
if 'BadZipFile' in source:
    print('Verified: is_zipfile now catches BadZipFile')
else:
    print('WARNING: is_zipfile may not catch BadZipFile')
    exit(1)

# Check that _EndRecData64 validates offset
source = inspect.getsource(zipfile._EndRecData64)
if 'Corrupt zip64' in source:
    print('Verified: _EndRecData64 now validates offsets')
else:
    print('WARNING: _EndRecData64 may not validate offsets')
    exit(1)

print('Fix applied successfully!')
"

echo "Fix applied successfully"
