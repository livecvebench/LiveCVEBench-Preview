"""
Functionality tests for Custom Admin Menu plugin.

These tests verify the plugin works correctly - should PASS in both
vulnerable and fixed states.
"""

import pytest
import requests
import urllib.parse
import re

BASE_URL = "http://localhost"
ADMIN_USER = "admin"
ADMIN_PASS = "admin"

SETTINGS_PAGE = "/wp-admin/admin.php?page=adminmenu-settings"


class WordPressSession:
    """Helper class to manage WordPress authentication."""

    def __init__(self, base_url, username, password):
        self.base_url = base_url.rstrip("/")
        self.username = username
        self.password = password
        self.session = requests.Session()
        self.logged_in = False

    def login(self):
        """Login to WordPress admin."""
        login_url = f"{self.base_url}/wp-login.php"

        # Get the login page to retrieve any nonce/cookies
        resp = self.session.get(login_url, timeout=30)

        # Perform login
        login_data = {
            "log": self.username,
            "pwd": self.password,
            "wp-submit": "Log In",
            "redirect_to": f"{self.base_url}/wp-admin/",
            "testcookie": "1"
        }

        resp = self.session.post(login_url, data=login_data, timeout=30, allow_redirects=True)

        # Check if login was successful
        if "wp-admin" in resp.url or "dashboard" in resp.text.lower():
            self.logged_in = True
            return True

        # Additional check: see if we can access admin page
        admin_resp = self.session.get(f"{self.base_url}/wp-admin/", timeout=30)
        if admin_resp.status_code == 200 and "dashboard" in admin_resp.text.lower():
            self.logged_in = True
            return True

        return False

    def get(self, path, **kwargs):
        """Make authenticated GET request."""
        url = f"{self.base_url}{path}"
        return self.session.get(url, timeout=30, **kwargs)

    def post(self, path, **kwargs):
        """Make authenticated POST request."""
        url = f"{self.base_url}{path}"
        return self.session.post(url, timeout=30, **kwargs)


@pytest.fixture(scope="module")
def wp_session():
    """Create authenticated WordPress session."""
    session = WordPressSession(BASE_URL, ADMIN_USER, ADMIN_PASS)
    if not session.login():
        pytest.skip("Could not authenticate to WordPress")
    return session


class TestPluginAccessibility:
    """Test that the plugin is accessible and functioning."""

    def test_wordpress_login_works(self, wp_session):
        """Verify we can login to WordPress admin."""
        response = wp_session.get("/wp-admin/")
        assert response.status_code == 200
        assert "dashboard" in response.text.lower() or "wp-admin" in response.url

    def test_settings_page_accessible(self, wp_session):
        """Verify the plugin settings page is accessible."""
        response = wp_session.get(SETTINGS_PAGE)
        assert response.status_code == 200, \
            f"Settings page returned status {response.status_code}"

    def test_settings_page_contains_expected_elements(self, wp_session):
        """Verify settings page contains expected UI elements."""
        response = wp_session.get(SETTINGS_PAGE)

        html = response.text.lower()

        # Should contain some reference to the plugin name or settings
        has_plugin_reference = any([
            "custom admin menu" in html,
            "adminpress" in html,
            "adminmenu" in html,
            "duogeek" in html
        ])

        assert has_plugin_reference, \
            "Settings page should reference the plugin name"

    def test_settings_page_has_form(self, wp_session):
        """Verify settings page has the configuration form."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text

        # Should contain form elements
        assert "<form" in html.lower(), \
            "Settings page should contain a form"

        # Check for save-related elements (may be button or submit input)
        has_save = "save" in html.lower() or "submit" in html.lower() or "adminmenu_option" in html
        assert has_save, \
            "Settings page should have a save-related element"


class TestMessageDisplay:
    """Test the message display functionality with normal inputs."""

    def test_normal_message_displays(self, wp_session):
        """Test that normal status messages display correctly."""
        # This is how the plugin normally uses the msg parameter
        message = "Settings+saved!"
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={message}")

        assert response.status_code == 200
        # Plus signs are replaced with spaces by the plugin
        assert "Settings saved!" in response.text, \
            "Normal message should display correctly"

    def test_reset_message_displays(self, wp_session):
        """Test that reset message displays correctly."""
        message = "Settings+reset!"
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={message}")

        assert response.status_code == 200
        assert "Settings reset!" in response.text, \
            "Reset message should display correctly"

    def test_plus_sign_converted_to_space(self, wp_session):
        """Verify plus signs are converted to spaces."""
        message = "Hello+World+Test"
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={message}")

        assert response.status_code == 200
        assert "Hello World Test" in response.text, \
            "Plus signs should be converted to spaces"

    def test_message_appears_in_updated_div(self, wp_session):
        """Verify message appears in the 'updated' notice div."""
        message = "Test+Message"
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={message}")

        html = response.text

        # Should be in an updated notice div
        assert 'class="updated"' in html, \
            "Message should appear in updated notice div"

    def test_empty_message_handled(self, wp_session):
        """Test that empty msg parameter doesn't break the page."""
        response = wp_session.get(f"{SETTINGS_PAGE}&msg=")

        assert response.status_code == 200, \
            "Empty message should not break the page"

    def test_no_message_parameter(self, wp_session):
        """Test page works without msg parameter."""
        response = wp_session.get(SETTINGS_PAGE)

        assert response.status_code == 200, \
            "Page should work without msg parameter"

    def test_long_message(self, wp_session):
        """Test handling of long messages."""
        message = "A" * 500
        encoded = urllib.parse.quote(message)
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={encoded}")

        assert response.status_code == 200, \
            "Long messages should not break the page"

    def test_unicode_message(self, wp_session):
        """Test Unicode characters in messages."""
        message = "设置已保存"  # Chinese for "Settings saved"
        encoded = urllib.parse.quote(message)
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={encoded}")

        assert response.status_code == 200, \
            "Unicode messages should not break the page"

    def test_numeric_message(self, wp_session):
        """Test numeric content in messages."""
        message = "12345"
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={message}")

        assert response.status_code == 200
        assert "12345" in response.text, \
            "Numeric messages should display correctly"

    def test_special_but_safe_characters(self, wp_session):
        """Test messages with special but safe characters."""
        message = "Success! Settings updated."
        encoded = urllib.parse.quote(message)
        response = wp_session.get(f"{SETTINGS_PAGE}&msg={encoded}")

        assert response.status_code == 200
        assert "Success" in response.text, \
            "Messages with exclamation marks should work"


class TestFormFunctionality:
    """Test that form functionality works correctly."""

    def test_form_has_nonce(self, wp_session):
        """Verify the form includes a nonce for security."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text

        assert "adminmenu_nonce_field" in html, \
            "Form should contain a nonce field for CSRF protection"

    def test_form_has_action(self, wp_session):
        """Verify form has proper action URL."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text

        assert "action=" in html.lower(), \
            "Form should have an action attribute"

    def test_save_button_exists(self, wp_session):
        """Verify save settings button exists or form has submit capability."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text

        # Check for any form submit mechanism
        has_submit = ('name="adminmenu_option"' in html or
                     'type="submit"' in html.lower() or
                     'submit' in html.lower())
        assert has_submit, \
            "Form should have submit capability"

    def test_reset_button_exists(self, wp_session):
        """Verify reset button or reset capability exists."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text

        # Check for reset functionality (may be named differently or not present in minimal config)
        has_reset_or_form = ('name="adminmenu_reset"' in html or
                            'reset' in html.lower() or
                            '<form' in html.lower())  # At minimum, form should exist
        assert has_reset_or_form, \
            "Form should have reset capability or at least exist"


class TestPageIntegrity:
    """Test overall page integrity."""

    def test_page_has_valid_html_structure(self, wp_session):
        """Verify page has valid HTML structure."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text

        # Basic HTML structure checks
        assert "<html" in html.lower() or "<!doctype" in html.lower(), \
            "Page should have HTML structure"

        assert "</html>" in html.lower(), \
            "Page should have closing HTML tag"

    def test_no_php_errors_displayed(self, wp_session):
        """Verify no PHP errors are displayed on the page."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text.lower()

        error_indicators = [
            "fatal error",
            "parse error",
            "warning:",
            "notice:",
            "deprecated:",
            "stack trace"
        ]

        for indicator in error_indicators:
            assert indicator not in html, \
                f"PHP error detected: {indicator}"

    def test_no_database_errors(self, wp_session):
        """Verify no database errors on the page."""
        response = wp_session.get(SETTINGS_PAGE)
        html = response.text.lower()

        db_error_indicators = [
            "database error",
            "mysql error",
            "sql syntax",
            "wpdb::prepare"
        ]

        for indicator in db_error_indicators:
            assert indicator not in html, \
                f"Database error detected: {indicator}"
