#!/bin/bash
set -e

echo "=== Applying fix for code injection vulnerability ==="

cd /workspace

# Define the paths (using /workspace not /app as per Docker setup)
HELPER_FILE="/workspace/packages/codegen-ui-react/lib/react-component-render-helper.ts"
CONSTANTS_FILE="/workspace/packages/codegen-ui-react/lib/utils/constants.ts"

# Check if files exist
if [ ! -f "$HELPER_FILE" ]; then
    echo "Error: react-component-render-helper.ts not found at $HELPER_FILE"
    exit 1
fi

if [ ! -f "$CONSTANTS_FILE" ]; then
    echo "Error: constants.ts not found at $CONSTANTS_FILE"
    exit 1
fi

# Step 1: Add filterScriptingPatterns function to constants.ts
echo "Step 1: Adding filterScriptingPatterns to constants.ts..."

# Check if filterScriptingPatterns already exists
if grep -q "filterScriptingPatterns" "$CONSTANTS_FILE"; then
    echo "filterScriptingPatterns already exists in constants.ts"
else
    echo "Appending filterScriptingPatterns to existing constants.ts..."
    cat >> "$CONSTANTS_FILE" << 'CONSTANTS_APPEND_EOF'

export const scriptingPatterns = [
  /eval[\s\u200b\u200c\u200d\ufeff]*\(/gi,
  /Function[\s\u200b\u200c\u200d\ufeff]*\(/gi,
  /setTimeout[\s\u200b\u200c\u200d\ufeff]*\(/gi,
  /setInterval[\s\u200b\u200c\u200d\ufeff]*\(/gi,
  /import[\s\u200b\u200c\u200d\ufeff]*\(/gi,
  /require[\s\u200b\u200c\u200d\ufeff]*\(/gi,
  /document\./gi,
  /window\./gi,
  /location\./gi,
  /global\./gi,
  /process\./gi,
  /on\w+[\s\u200b\u200c\u200d\ufeff]*=/gi,
  /javascript:/gi,
  /data:/gi,
  /vbscript:/gi,
  /<script/gi,
  /<\/script/gi,
  /<svg/gi,
  /<iframe/gi,
  /<img/gi,
  /xlink:href/gi,
  /Symbol[\s\u200b\u200c\u200d\ufeff]*\(/gi,
  /__proto__/gi,
  /prototype\./gi,
  /constructor/gi,
  /\$\{/,
  /base64/gi,
  /\/\*/gi,
  /alert[\s\u200b\u200c\u200d\ufeff]*\(/gi,
];

export function filterScriptingPatterns(str: string): string {
  if (!str) return '';
  if (scriptingPatterns.some((pattern) => pattern.test(str))) {
    return '';
  }
  return str.trim();
}
CONSTANTS_APPEND_EOF
fi

# Step 2: Add import for filterScriptingPatterns in react-component-render-helper.ts
echo "Step 2: Adding import for filterScriptingPatterns..."

# Check if the import for filterScriptingPatterns already exists
if ! grep -q "filterScriptingPatterns" "$HELPER_FILE"; then
    echo "Adding import for filterScriptingPatterns..."

    # Add import at the top of the file after existing imports
    # Find the line with "import keywords from './keywords';" and add after it
    sed -i "s|import keywords from './keywords';|import keywords from './keywords';\nimport { filterScriptingPatterns } from './utils/constants';|" "$HELPER_FILE"
fi

# Step 3: Modify the buildBindingExpression function directly
# Replace the old pattern that creates identifier without sanitization
# with a new pattern that uses filterScriptingPatterns
echo "Step 3: Modifying buildBindingExpression function..."

# First, let's check if the function still has the vulnerable pattern
if grep -q "keywords.has(property) ? \`\${property}Prop\` : property" "$HELPER_FILE"; then
    echo "Replacing vulnerable pattern in buildBindingExpression..."

    # Create a temp file to store the modifications
    TMP_FILE=$(mktemp)

    # Use awk to replace the vulnerable pattern in buildBindingExpression
    # This approach handles the multi-line context better
    awk '
    /const identifier = factory\.createIdentifier\(keywords\.has\(property\)/ {
        print "  const sanitizedProperty = filterScriptingPatterns(property);";
        print "  const escapedProperty = keywords.has(sanitizedProperty) ? `${sanitizedProperty}Prop` : sanitizedProperty;";
        print "  const identifier = factory.createIdentifier(escapedProperty);";
        next;
    }
    { print }
    ' "$HELPER_FILE" > "$TMP_FILE"

    mv "$TMP_FILE" "$HELPER_FILE"

    echo "Modified buildBindingExpression to use sanitized property"
fi

# Step 4: Also fix buildBindingWithDefaultExpression which also uses unsanitized property
echo "Step 4: Checking buildBindingWithDefaultExpression..."

if grep -q "factory.createIdentifier(prop.bindingProperties.property)" "$HELPER_FILE"; then
    echo "Fixing buildBindingWithDefaultExpression..."
    sed -i 's/factory\.createIdentifier(prop\.bindingProperties\.property)/factory.createIdentifier(filterScriptingPatterns(prop.bindingProperties.property) || "")/g' "$HELPER_FILE"
fi

# Step 5: Rebuild the package
echo "Step 5: Rebuilding the package..."

cd /workspace

# Build using lerna
npm run build 2>&1 || true

# Also try building just the specific package
if [ -d "packages/codegen-ui-react" ]; then
    echo "Building codegen-ui-react package..."
    cd packages/codegen-ui-react
    npm run build 2>&1 || npx tsc 2>&1 || true
    cd /workspace
fi

# Step 6: Verify the fix was applied
echo "Step 6: Verifying fix..."

if grep -q "filterScriptingPatterns" "$CONSTANTS_FILE" && \
   grep -q "filterScriptingPatterns" "$HELPER_FILE"; then
    echo "=== Fix applied successfully ==="
    echo "Changes made:"
    echo "  1. Added filterScriptingPatterns() to utils/constants.ts"
    echo "  2. Modified buildBindingExpression() to sanitize property values"
else
    echo "Warning: Fix may not have been applied completely"
    echo "Checking file contents..."
    grep -l "filterScriptingPatterns" /workspace/packages/codegen-ui-react/lib/*.ts 2>/dev/null || echo "Functions not found"
fi

echo "=== Solution script completed ==="
