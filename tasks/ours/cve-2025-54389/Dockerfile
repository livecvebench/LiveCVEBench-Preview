FROM debian:bookworm-slim

# Install build dependencies and required tools (tmux, asciinema, curl)
RUN apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    automake \
    autoconf-archive \
    flex \
    bison \
    pkg-config \
    libpcre2-dev \
    nettle-dev \
    zlib1g-dev \
    libacl1-dev \
    libattr1-dev \
    libcap-dev \
    libselinux1-dev \
    libcurl4-openssl-dev \
    git \
    patch \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Clone vulnerable version
RUN git clone --depth 1 --branch v0.19.1 https://github.com/aide/aide.git /app

WORKDIR /app

# Build AIDE (autogen.sh needs .git for version)
RUN ./autogen.sh && \
    ./configure --prefix=/usr && \
    make -j$(nproc) && \
    make install

# Remove .git AFTER build to prevent data leakage
RUN rm -rf .git

# Create necessary directories for AIDE operation
RUN mkdir -p /var/lib/aide /monitored

# Default command - keep container running
CMD ["tail", "-f", "/dev/null"]
