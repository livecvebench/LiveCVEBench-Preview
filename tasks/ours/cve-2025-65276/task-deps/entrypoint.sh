#!/bin/bash
set -e

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready..."
max_attempts=60
attempt=0

while [ $attempt -lt $max_attempts ]; do
    if mysqladmin ping -h mysql -u root --password=hashtech123 --silent 2>/dev/null; then
        echo "MySQL is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "Waiting for MySQL... ($attempt/$max_attempts)"
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "MySQL did not become ready in time"
    exit 1
fi

# Create database and import schema
echo "Creating database and importing schema..."
mysql -h mysql -u root --password=hashtech123 -e "CREATE DATABASE IF NOT EXISTS hashtech;"

# Check if the administrator table exists (indicates schema already imported)
if ! mysql -h mysql -u root --password=hashtech123 hashtech -e "SELECT 1 FROM administrator LIMIT 1;" 2>/dev/null; then
    echo "Importing hashtech.sql schema..."
    mysql -h mysql -u root --password=hashtech123 hashtech < /app/database/hashtech.sql
    echo "Database schema imported successfully!"
else
    echo "Database already initialized, skipping import."
fi

# Start Apache in the foreground
echo "Starting Apache..."
exec apache2-foreground
