#!/bin/bash
# Solution script for search_path hijacking vulnerability
# Fixes the vulnerable application by qualifying all function calls with pg_catalog

set -e
cd /app

echo "Applying fix for unqualified function calls..."

# Fix the db_queries.py file to use fully qualified function names
# Replace unqualified function calls with pg_catalog qualified versions

if [ -f /app/src/db_queries.py ]; then
    # Backup the original file
    cp /app/src/db_queries.py /app/src/db_queries.py.bak

    # Fix VERSION_QUERY: SELECT version() -> SELECT pg_catalog.version()
    sed -i 's/SELECT version()/SELECT pg_catalog.version()/g' /app/src/db_queries.py

    # Fix DATABASE_QUERY: SELECT current_database() -> SELECT pg_catalog.current_database()
    sed -i 's/SELECT current_database()/SELECT pg_catalog.current_database()/g' /app/src/db_queries.py

    # Fix RECOVERY_QUERY: SELECT pg_is_in_recovery() -> SELECT pg_catalog.pg_is_in_recovery()
    sed -i 's/SELECT pg_is_in_recovery()/SELECT pg_catalog.pg_is_in_recovery()/g' /app/src/db_queries.py

    # Fix TIME_QUERY: SELECT now() -> SELECT pg_catalog.now()
    sed -i 's/SELECT now()/SELECT pg_catalog.now()/g' /app/src/db_queries.py

    # Fix USER_QUERY: SELECT current_user -> SELECT pg_catalog.current_user
    sed -i 's/SELECT current_user/SELECT pg_catalog.current_user/g' /app/src/db_queries.py

    # Also handle queries that might use different casing or spacing
    sed -i 's/select version()/SELECT pg_catalog.version()/gi' /app/src/db_queries.py
    sed -i 's/select current_database()/SELECT pg_catalog.current_database()/gi' /app/src/db_queries.py
    sed -i 's/select pg_is_in_recovery()/SELECT pg_catalog.pg_is_in_recovery()/gi' /app/src/db_queries.py
    sed -i 's/select now()/SELECT pg_catalog.now()/gi' /app/src/db_queries.py

    echo "Fixed /app/src/db_queries.py"
fi

# Also check for app.py if it contains SQL queries directly
if [ -f /app/src/app.py ]; then
    cp /app/src/app.py /app/src/app.py.bak

    sed -i 's/SELECT version()/SELECT pg_catalog.version()/g' /app/src/app.py
    sed -i 's/SELECT current_database()/SELECT pg_catalog.current_database()/g' /app/src/app.py
    sed -i 's/SELECT pg_is_in_recovery()/SELECT pg_catalog.pg_is_in_recovery()/g' /app/src/app.py
    sed -i 's/SELECT now()/SELECT pg_catalog.now()/g' /app/src/app.py
    sed -i 's/SELECT current_user/SELECT pg_catalog.current_user/g' /app/src/app.py

    echo "Fixed /app/src/app.py"
fi

# Handle any other Python files that might contain SQL queries
for pyfile in /app/src/*.py; do
    if [ -f "$pyfile" ]; then
        sed -i 's/SELECT version()/SELECT pg_catalog.version()/g' "$pyfile" 2>/dev/null || true
        sed -i 's/SELECT current_database()/SELECT pg_catalog.current_database()/g' "$pyfile" 2>/dev/null || true
        sed -i 's/SELECT pg_is_in_recovery()/SELECT pg_catalog.pg_is_in_recovery()/g' "$pyfile" 2>/dev/null || true
        sed -i 's/SELECT now()/SELECT pg_catalog.now()/g' "$pyfile" 2>/dev/null || true
    fi
done

echo "Fix applied successfully!"
echo "All unqualified PostgreSQL function calls have been qualified with pg_catalog schema."
