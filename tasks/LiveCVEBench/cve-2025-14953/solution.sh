#!/bin/bash
# Solution script: Add FAR-ID validation in PFCP CreatePDR handler
set -e

cd /app

HANDLER_FILE="lib/pfcp/handler.c"

# Check if file exists
if [ ! -f "$HANDLER_FILE" ]; then
    echo "Error: $HANDLER_FILE not found"
    exit 1
fi

# Use Python for precise pattern matching and insertion
# This ensures we only modify the ogs_pfcp_handle_create_pdr function
python3 << 'PYEOF'
import re
import sys

handler_file = "lib/pfcp/handler.c"

with open(handler_file, 'r') as f:
    content = f.read()

# Check if fix already applied in the correct location (ogs_pfcp_handle_create_pdr function)
# Look for FAR-ID check near PDR-ID check in the create_pdr function
if 'if (message->far_id.presence == 0)' in content:
    # Check if it's in the right place - after PDR-ID check and before pdr_find_or_add
    pattern = r'OGS_PFCP_PDR_ID_TYPE;\s*\n\s*return NULL;\s*\n\s*\}\s*\n\s*if \(message->far_id\.presence == 0\)'
    if re.search(pattern, content):
        print("Fix already correctly applied")
        sys.exit(0)
    else:
        print("FAR-ID check found but in wrong location, needs correction")
        # Remove incorrectly placed FAR-ID checks first
        wrong_check_pattern = r'\n\s*if \(message->far_id\.presence == 0\) \{\s*\n\s*ogs_error\("No FAR-ID"\);\s*\n\s*\*cause_value = OGS_PFCP_CAUSE_MANDATORY_IE_MISSING;\s*\n\s*\*offending_ie_value = OGS_PFCP_FAR_ID_TYPE;\s*\n\s*return (NULL|false);\s*\n\s*\}'
        content = re.sub(wrong_check_pattern, '', content)

# The pattern to find: the PDR-ID check block in ogs_pfcp_handle_create_pdr
# We need to insert after:
#     if (message->pdr_id.presence == 0) {
#         ogs_error("No PDR-ID");
#         *cause_value = OGS_PFCP_CAUSE_MANDATORY_IE_MISSING;
#         *offending_ie_value = OGS_PFCP_PDR_ID_TYPE;
#         return NULL;
#     }
#
# And before:
#     pdr = ogs_pfcp_pdr_find_or_add(sess, message->pdr_id.u16);

# This specific pattern only matches in ogs_pfcp_handle_create_pdr because
# it's followed by pdr_find_or_add (other functions use pdr_find without _or_add)
pattern = r'(\*offending_ie_value = OGS_PFCP_PDR_ID_TYPE;\s*\n\s*return NULL;\s*\n\s*\})\s*\n(\s*pdr = ogs_pfcp_pdr_find_or_add)'

fix_code = '''\\1

    if (message->far_id.presence == 0) {
        ogs_error("No FAR-ID");
        *cause_value = OGS_PFCP_CAUSE_MANDATORY_IE_MISSING;
        *offending_ie_value = OGS_PFCP_FAR_ID_TYPE;
        return NULL;
    }

\\2'''

new_content, count = re.subn(pattern, fix_code, content)

if count == 0:
    print("ERROR: Could not find the insertion point for FAR-ID check")
    print("Looking for pattern: PDR-ID check followed by pdr_find_or_add")
    sys.exit(1)

print(f"Fix applied: inserted FAR-ID validation check ({count} location)")

with open(handler_file, 'w') as f:
    f.write(new_content)
PYEOF

# Verify the fix was applied correctly
echo "Verifying fix..."
if grep -A2 "No FAR-ID" "$HANDLER_FILE" | grep -q "OGS_PFCP_FAR_ID_TYPE"; then
    echo "FAR-ID validation check verified"
else
    echo "ERROR: Fix verification failed"
    exit 1
fi

# Rebuild Open5GS
echo "Rebuilding Open5GS..."
cd /app

# Check if build directory exists
if [ -d "build" ]; then
    ninja -C build
    ninja -C build install
else
    # Full build if build dir doesn't exist
    meson build --prefix=/app/install
    ninja -C build
    ninja -C build install
fi

echo "Rebuild complete"

# Restart UPF service
echo "Restarting UPF..."
pkill -f "open5gs-upfd" 2>/dev/null || true
sleep 2

# UPF will be restarted by the entrypoint/init system
echo "Solution applied successfully"
