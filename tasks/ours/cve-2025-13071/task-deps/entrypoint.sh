#!/bin/bash
set -e

# Extract hostname from WORDPRESS_DB_HOST (remove port if present)
DB_HOST="${WORDPRESS_DB_HOST%%:*}"

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready at $DB_HOST..."
until mysqladmin ping -h"$DB_HOST" --silent; do
    echo "MySQL is not ready yet, waiting..."
    sleep 2
done
echo "MySQL is ready!"

# Run the original WordPress entrypoint to setup WordPress
docker-entrypoint.sh apache2-foreground &
APACHE_PID=$!

# Wait for WordPress to be accessible
echo "Waiting for WordPress to start..."
sleep 10

# Check if WordPress is installed
echo "Checking WordPress installation status..."
for i in {1..30}; do
    if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -q "200\|302"; then
        echo "WordPress is responding!"
        break
    fi
    echo "WordPress not ready yet, waiting... ($i/30)"
    sleep 3
done

# Install WordPress if needed using WP-CLI
if ! wp core is-installed --allow-root 2>/dev/null; then
    echo "Installing WordPress..."
    wp core install \
        --url="http://localhost" \
        --title="CVE Test Site" \
        --admin_user="admin" \
        --admin_password="admin" \
        --admin_email="admin@example.com" \
        --skip-email \
        --allow-root
    echo "WordPress installed successfully!"
else
    echo "WordPress is already installed."
fi

# Activate the plugin
echo "Activating Custom Admin Menu plugin..."
wp plugin activate custom-admin-menu --allow-root || echo "Plugin may already be active or not found"

# List active plugins
echo "Active plugins:"
wp plugin list --status=active --allow-root

echo "Setup complete! WordPress is running."

# Wait for Apache
wait $APACHE_PID
