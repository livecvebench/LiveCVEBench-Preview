# Dockerfile for CVE-2025-5874 - Redash Python Query Runner Sandbox Escape
FROM python:3.7-slim-buster

WORKDIR /app

# Disable pip cache and version check for Docker
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV PIP_NO_CACHE_DIR=1

# Fix Debian Buster EOL repositories - use archive
RUN sed -i s/deb.debian.org/archive.debian.org/g /etc/apt/sources.list && \
    sed -i 's|security.debian.org|archive.debian.org|g' /etc/apt/sources.list && \
    sed -i '/stretch-updates/d' /etc/apt/sources.list && \
    sed -i '/buster-updates/d' /etc/apt/sources.list

# System dependencies (including tmux, asciinema, curl as required)
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    libffi-dev \
    libssl-dev \
    curl \
    git \
    tmux \
    asciinema \
    && rm -rf /var/lib/apt/lists/*

# Install pip 20.2.4 first (required for compatibility)
RUN pip install pip==20.2.4

# Clone vulnerable version of Redash and remove .git for security
RUN git clone --depth 1 --branch v10.1.0 https://github.com/getredash/redash.git /app \
    && rm -rf /app/.git

# Install minimal requirements (sufficient for testing the Python query runner vulnerability)
COPY task-deps/requirements_minimal.txt /tmp/requirements_minimal.txt
RUN pip install -r /tmp/requirements_minimal.txt

# Create placeholder for frontend (not needed for vulnerability testing)
RUN mkdir -p /app/client/dist && \
    touch /app/client/dist/index.html && \
    touch /app/client/dist/multi_org.html

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV REDASH_DATABASE_URL=postgresql://postgres:postgres@postgres:5432/redash
ENV REDASH_REDIS_URL=redis://redis:6379/0
ENV REDASH_COOKIE_SECRET=veryverysecretkey1234567890abc
ENV REDASH_ENABLED_QUERY_RUNNERS=Python

# Expose port (optional for this CVE - not strictly needed)
EXPOSE 5000

# Use our simple entrypoint that keeps container running for testing
# CMD ["/entrypoint.sh"]  # Moved to docker-compose.yaml
