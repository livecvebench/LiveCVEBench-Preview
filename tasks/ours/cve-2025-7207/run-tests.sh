#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== mruby Test Runner ==="

# Install uv for Python package management
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize uv project and install dependencies
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

# Create PoC file for testing
cat > poc.rb << 'EOF'
module K retry
end
EOF

echo ""
echo "=== Checking mruby binary ==="
if [ -f /app/build/host/bin/mruby ]; then
    echo "mruby binary found at /app/build/host/bin/mruby"
    /app/build/host/bin/mruby --version || echo "Could not get version"
else
    echo "ERROR: mruby binary not found!"
    echo "Looking for mruby..."
    find /app -name "mruby" -type f 2>/dev/null | head -5
    exit 1
fi

echo ""
echo "=== Running pytest ==="
uv run pytest . -rA -v
