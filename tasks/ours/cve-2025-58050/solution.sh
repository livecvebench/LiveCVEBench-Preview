#!/bin/bash
# Solution script for PCRE2 SCS+ACCEPT buffer restoration bug
# This fix adds the missing buffer boundary restoration when (*ACCEPT)
# is triggered inside a (*scs:...) block.

set -e

cd /app

echo "Applying fix to src/pcre2_match.c..."

# The fix: After the line "Fmark = assert_accept_frame->mark;" inside the
# OP_ASSERT_SCS case block (if rrc == MATCH_ACCEPT), we need to add three
# lines to restore the buffer boundaries before the break statement.
#
# IMPORTANT: There are TWO occurrences of "Fmark = assert_accept_frame->mark;"
# 1. In OP_ASSERT/OP_ASSERTBACK case block (around line 5672) - DO NOT modify
# 2. In OP_ASSERT_SCS case block (around line 5826) - THIS is the one to fix
#
# The vulnerable code in OP_ASSERT_SCS has:
#     Fmark = assert_accept_frame->mark;
#     break;
#
# We need to change it to:
#     Fmark = assert_accept_frame->mark;
#     mb->end_subject = Lsaved_end_subject;
#     mb->true_end_subject = mb->end_subject + Ltrue_end_extra;
#     mb->moptions = Lsaved_moptions;
#     break;

# First, verify the vulnerable pattern exists
if ! grep -q "Fmark = assert_accept_frame->mark;" src/pcre2_match.c; then
    echo "ERROR: Could not find the vulnerable code pattern"
    exit 1
fi

# Check if already fixed - look for the restore code after Fmark assignment in SCS block
# The SCS block is the SECOND occurrence, so we check if any occurrence has the fix
if grep -A4 "Fmark = assert_accept_frame->mark;" src/pcre2_match.c | grep -q "mb->end_subject = Lsaved_end_subject;"; then
    echo "Fix already applied, skipping..."
else
    # Use Python to precisely target only the SECOND occurrence
    # (the one inside OP_ASSERT_SCS block)
    python3 << 'PYTHON_SCRIPT'
import re

with open('src/pcre2_match.c', 'r') as f:
    content = f.read()

# Find all occurrences of the pattern
pattern = r'(Fmark = assert_accept_frame->mark;\n)(\s*)(break;)'

matches = list(re.finditer(pattern, content))
print(f"Found {len(matches)} occurrences of the vulnerable pattern")

if len(matches) < 2:
    print("ERROR: Expected at least 2 occurrences, found", len(matches))
    exit(1)

# Replace only the SECOND occurrence (index 1) - the one in OP_ASSERT_SCS
# We need to find its position and replace it
second_match = matches[1]
start = second_match.start()
end = second_match.end()

# Get the indentation from the break statement
indent = second_match.group(2)

# Build the replacement
replacement = (
    second_match.group(1) +  # Keep original "Fmark = ..." line
    indent + "mb->end_subject = Lsaved_end_subject;\n" +
    indent + "mb->true_end_subject = mb->end_subject + Ltrue_end_extra;\n" +
    indent + "mb->moptions = Lsaved_moptions;\n" +
    indent + "break;"
)

# Apply the replacement
new_content = content[:start] + replacement + content[end:]

with open('src/pcre2_match.c', 'w') as f:
    f.write(new_content)

print("Successfully patched the second occurrence (OP_ASSERT_SCS block)")
PYTHON_SCRIPT

    echo "Source code patched successfully."
fi

# Rebuild PCRE2
echo "Rebuilding PCRE2..."
cd /app/build
cmake --build . --target pcre2test 2>&1 | tail -20

echo ""
echo "Fix applied and rebuilt successfully."
echo "The buffer boundaries are now properly restored when (*ACCEPT) is used inside (*scs:...)."
