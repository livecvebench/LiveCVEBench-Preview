FROM mariadb:10.11

# Install git to fetch SQL files
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Clone ClipBucket and extract SQL files
RUN git clone --depth 1 https://github.com/MacWarrior/clipbucket-v5.git /tmp/cb && \
    cp /tmp/cb/upload/cb_install/sql/structure.sql /docker-entrypoint-initdb.d/01-structure.sql && \
    cp /tmp/cb/upload/cb_install/sql/configs.sql /docker-entrypoint-initdb.d/02-configs.sql && \
    cp /tmp/cb/upload/cb_install/sql/user_levels.sql /docker-entrypoint-initdb.d/03-user_levels.sql && \
    cp /tmp/cb/upload/cb_install/sql/add_admin.sql /docker-entrypoint-initdb.d/04-add_admin.sql && \
    rm -rf /tmp/cb

# Replace {tbl_prefix} placeholder with cb_ and add USE statement
RUN for f in /docker-entrypoint-initdb.d/*.sql; do \
    sed -i 's/{tbl_prefix}/cb_/g' "$f" && \
    sed -i '1s/^/USE clipbucket;\n/' "$f"; \
    done
