# Dockerfile for CVE-2025-52904 - FileBrowser Command Execution Scope Bypass
# Vulnerable version: v2.32.0

# Build stage
FROM golang:1.23 AS builder

WORKDIR /build

# Install git
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Clone the vulnerable version
RUN git clone --depth 1 --branch v2.32.0 https://github.com/filebrowser/filebrowser.git . && \
    rm -rf .git

# Copy go.mod and go.sum from task-deps (in case they need to be used)
# Note: The cloned repository already has these files at the vulnerable version

# Download dependencies
RUN go mod download

# Build the application
RUN CGO_ENABLED=0 go build -ldflags="-w -s" -o filebrowser .

# Runtime stage - using Debian-based image (avoiding Alpine due to network issues)
FROM debian:bookworm-slim

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required per system prompt)
RUN apt-get update && apt-get install -y \
    ca-certificates \
    mime-support \
    curl \
    jq \
    tmux \
    asciinema \
    git \
    procps \
    tini \
    && rm -rf /var/lib/apt/lists/*

# Copy the built binary from builder stage
COPY --from=builder /build/filebrowser /app/filebrowser

# Copy the source code for fixing (subjects need to modify and rebuild)
COPY --from=builder /build /app/

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create necessary directories
RUN mkdir -p /srv/user1 /srv/user2 /database /config

# Environment variables for FileBrowser
ENV FB_DATABASE=/database/filebrowser.db
ENV FB_ROOT=/srv
ENV FB_PORT=8080
ENV FB_ADDRESS=0.0.0.0

# Expose port
EXPOSE 8080

# Healthcheck - verify server responds to requests (404 is OK, it means server is running)
HEALTHCHECK --start-period=15s --interval=30s --timeout=5s \
    CMD curl -sI http://localhost:8080/ | head -1 | grep -qE "^HTTP"

# Use tini as init for proper signal handling
ENTRYPOINT ["tini", "--"]
CMD ["/entrypoint.sh"]
