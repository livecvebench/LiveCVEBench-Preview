#!/bin/bash
# Fix for command injection vulnerability in OpenVPN CMS Flask
# This script applies the fix to prevent shell metacharacter injection

set -e
cd /app

echo "Applying fix for command injection vulnerability..."

# Fix 1: Add param_shell method to the Cmd class in shell.py
# The method must be inserted inside the Cmd class (not appended at end)
# Using Python for precise insertion after the onetime_shell method of Cmd class

python3 << 'PYEOF'
with open('/app/app/libs/shell.py', 'r') as f:
    content = f.read()

# Define the new method with proper indentation (4 spaces for class method)
new_method = '''
    def param_shell(self, username):
        """
        Safely execute vpnuser add command without shell interpretation.
        Uses list arguments with subprocess.run to prevent command injection.
        """
        cmd = subprocess.run(["/usr/local/bin/vpnuser", "add", username],
                             capture_output=True,
                             text=True,
                             check=False)
        return cmd.stdout
'''

# Find the end of the Cmd class's onetime_shell method
# The Cmd class ends before "class Remote_cmd"
# We need to insert before "class Remote_cmd"

if "def param_shell" not in content:
    # Insert the new method right before "class Remote_cmd"
    new_content = content.replace(
        "\n\nclass Remote_cmd(object):",
        new_method + "\n\nclass Remote_cmd(object):"
    )

    with open('/app/app/libs/shell.py', 'w') as f:
        f.write(new_content)
    print("Added param_shell method to Cmd class in shell.py")
else:
    print("param_shell already exists in shell.py")
PYEOF

echo "Updated shell.py with param_shell method"

# Fix 2: Update create_user in openvpn.py to use the safe param_shell method
# Replace the vulnerable command construction and execution with safe method call

# First, backup the original file
cp /app/app/api/v1/openvpn.py /app/app/api/v1/openvpn.py.bak

# Use Python to make the replacement more reliably
python3 << 'PYEOF'
import re

filepath = '/app/app/api/v1/openvpn.py'

with open(filepath, 'r') as f:
    content = f.read()

# Pattern to match the vulnerable code block
old_pattern = r'''command = \["/usr/local/bin/vpnuser", "add", form\.username\.data\]
        command = ' '\.join\(str\(d\) for d in command\)
        remote_server\.onetime_shell\(command\)'''

new_code = '''remote_server.param_shell(form.username.data)'''

# Replace the vulnerable code with safe code
new_content = re.sub(old_pattern, new_code, content)

if new_content == content:
    # Try alternative pattern with different whitespace
    old_pattern2 = r"command = \[\"/usr/local/bin/vpnuser\", \"add\", form\.username\.data\].*?remote_server\.onetime_shell\(command\)"
    new_content = re.sub(old_pattern2, new_code, content, flags=re.DOTALL)

with open(filepath, 'w') as f:
    f.write(new_content)

print("Updated openvpn.py to use param_shell")
PYEOF

# Verify the fix was applied
if grep -q "param_shell" /app/app/api/v1/openvpn.py; then
    echo "Verified: openvpn.py now uses param_shell"
else
    echo "Warning: Could not verify openvpn.py update, applying manual fix..."
    # Manual fallback using sed
    sed -i 's/remote_server\.onetime_shell(command)/remote_server.param_shell(form.username.data)/g' /app/app/api/v1/openvpn.py
    # Remove the command construction lines
    sed -i '/command = \["\/usr\/local\/bin\/vpnuser", "add", form.username.data\]/d' /app/app/api/v1/openvpn.py
    sed -i "/command = ' '.join(str(d) for d in command)/d" /app/app/api/v1/openvpn.py
fi

# Restart the Flask application to pick up the changes
# The entrypoint script runs in a loop and will restart the app
echo "Restarting application..."

# Try multiple methods to kill the Python process since minimal containers may not have pkill
# Method 1: Use kill with PID from /proc
for pid in $(ls /proc | grep -E '^[0-9]+$'); do
    if [ -f /proc/$pid/cmdline ] 2>/dev/null && grep -q "starter.py\|python" /proc/$pid/cmdline 2>/dev/null; then
        kill -TERM $pid 2>/dev/null || true
    fi
done

# Method 2: Fallback - the entrypoint's while loop will restart automatically
sleep 5

echo "Fix applied successfully!"
echo "The application should restart automatically via the container entrypoint."
