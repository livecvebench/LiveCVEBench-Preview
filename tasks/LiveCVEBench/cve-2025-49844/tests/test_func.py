#!/usr/bin/env python3
"""
Functionality tests for Redis Lua scripting.
These tests verify that basic Lua functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import redis
import time


# Redis connection settings
REDIS_HOST = "localhost"
REDIS_PORT = 6379


@pytest.fixture(scope="module")
def redis_client():
    """Create a Redis client connection."""
    max_retries = 30
    for i in range(max_retries):
        try:
            client = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, decode_responses=False)
            client.ping()
            return client
        except redis.ConnectionError:
            if i < max_retries - 1:
                time.sleep(1)
            else:
                pytest.fail(f"Could not connect to Redis at {REDIS_HOST}:{REDIS_PORT}")


class TestLuaBasicFunctionality:
    """Test basic Lua scripting functionality."""

    def test_simple_return(self, redis_client):
        """Test basic Lua script that returns a string."""
        result = redis_client.eval("return 'hello'", 0)
        assert result == b'hello'

    def test_numeric_return(self, redis_client):
        """Test Lua script that returns a number."""
        result = redis_client.eval("return 42", 0)
        assert result == 42

    def test_arithmetic_operations(self, redis_client):
        """Test Lua arithmetic operations."""
        result = redis_client.eval("return 10 + 20 * 3", 0)
        assert result == 70

    def test_string_operations(self, redis_client):
        """Test Lua string operations."""
        result = redis_client.eval("return string.upper('hello')", 0)
        assert result == b'HELLO'

    def test_table_operations(self, redis_client):
        """Test Lua table operations."""
        script = """
        local t = {1, 2, 3, 4, 5}
        local sum = 0
        for _, v in ipairs(t) do
            sum = sum + v
        end
        return sum
        """
        result = redis_client.eval(script, 0)
        assert result == 15

    def test_redis_call(self, redis_client):
        """Test calling Redis commands from Lua."""
        redis_client.delete("test_key_func")
        result = redis_client.eval(
            "redis.call('SET', 'test_key_func', 'test_value'); return redis.call('GET', 'test_key_func')",
            0
        )
        assert result == b'test_value'
        redis_client.delete("test_key_func")


class TestLoadstringFunctionality:
    """Test that loadstring() function works correctly."""

    def test_loadstring_basic(self, redis_client):
        """Test basic loadstring functionality."""
        script = """
        local f = loadstring("return 42")
        return f()
        """
        result = redis_client.eval(script, 0)
        assert result == 42

    def test_loadstring_with_chunk_name(self, redis_client):
        """Test loadstring with a chunk name argument."""
        script = """
        local code = "return 'loaded'"
        local f, err = loadstring(code, "test_chunk")
        if f then
            return f()
        else
            return err
        end
        """
        result = redis_client.eval(script, 0)
        assert result == b'loaded'

    def test_loadstring_with_variables(self, redis_client):
        """Test loadstring with variable declarations."""
        script = """
        local code = "local x = 10; local y = 20; return x + y"
        local f = loadstring(code)
        return f()
        """
        result = redis_client.eval(script, 0)
        assert result == 30

    def test_loadstring_error_handling(self, redis_client):
        """Test loadstring error handling for invalid Lua code."""
        script = """
        local code = "this is not valid lua code !!!"
        local f, err = loadstring(code)
        if f == nil then
            return "error_detected"
        else
            return "no_error"
        end
        """
        result = redis_client.eval(script, 0)
        assert result == b'error_detected'

    def test_loadstring_multiple_returns(self, redis_client):
        """Test loadstring with multiple return values."""
        script = """
        local code = "return 1, 2, 3"
        local f = loadstring(code)
        local a, b, c = f()
        return a + b + c
        """
        result = redis_client.eval(script, 0)
        assert result == 6


class TestGarbageCollection:
    """Test that garbage collection works correctly."""

    def test_collectgarbage_collect(self, redis_client):
        """Test collectgarbage('collect') function."""
        script = """
        collectgarbage("collect")
        return "collected"
        """
        result = redis_client.eval(script, 0)
        assert result == b'collected'

    def test_collectgarbage_count(self, redis_client):
        """Test collectgarbage('count') returns memory usage."""
        script = """
        local count = collectgarbage("count")
        return count > 0
        """
        result = redis_client.eval(script, 0)
        assert result == 1  # Lua boolean true in Redis

    def test_collectgarbage_step(self, redis_client):
        """Test collectgarbage('step') function."""
        script = """
        collectgarbage("step", 10)
        return "stepped"
        """
        result = redis_client.eval(script, 0)
        assert result == b'stepped'

    def test_gc_with_allocations(self, redis_client):
        """Test GC with memory allocations."""
        script = """
        local t = {}
        for i = 1, 50 do
            t[i] = string.rep("x", 1000)
        end
        collectgarbage("collect")
        return #t
        """
        result = redis_client.eval(script, 0)
        assert result == 50


class TestMemoryOperations:
    """Test memory-intensive operations work correctly."""

    def test_string_rep_large(self, redis_client):
        """Test creating large strings."""
        script = """
        local s = string.rep("A", 10000)
        return string.len(s)
        """
        result = redis_client.eval(script, 0)
        assert result == 10000

    def test_table_with_many_entries(self, redis_client):
        """Test creating tables with many entries."""
        script = """
        local t = {}
        for i = 1, 1000 do
            t[i] = i
        end
        return #t
        """
        result = redis_client.eval(script, 0)
        assert result == 1000

    def test_nested_function_calls(self, redis_client):
        """Test nested function calls."""
        script = """
        local function factorial(n)
            if n <= 1 then return 1 end
            return n * factorial(n - 1)
        end
        return factorial(10)
        """
        result = redis_client.eval(script, 0)
        assert result == 3628800

    def test_string_concatenation(self, redis_client):
        """Test string concatenation operations."""
        script = """
        local parts = {}
        for i = 1, 100 do
            parts[i] = tostring(i)
        end
        local result = table.concat(parts, ",")
        return string.len(result) > 0
        """
        result = redis_client.eval(script, 0)
        assert result == 1


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_empty_script(self, redis_client):
        """Test empty return."""
        result = redis_client.eval("return nil", 0)
        assert result is None

    def test_boolean_return(self, redis_client):
        """Test boolean return values."""
        result_true = redis_client.eval("return true", 0)
        result_false = redis_client.eval("return false", 0)
        assert result_true == 1
        assert result_false is None  # Lua false/nil are returned as nil

    def test_long_chunk_name_basic(self, redis_client):
        """Test loadstring with moderately long chunk name."""
        script = """
        local chunk_name = string.rep("x", 256)
        local f = loadstring("return 1", chunk_name)
        return f()
        """
        result = redis_client.eval(script, 0)
        assert result == 1

    def test_multiple_loadstring_calls(self, redis_client):
        """Test multiple sequential loadstring calls."""
        script = """
        local results = {}
        for i = 1, 10 do
            local f = loadstring("return " .. i)
            results[i] = f()
        end
        local sum = 0
        for _, v in ipairs(results) do
            sum = sum + v
        end
        return sum
        """
        result = redis_client.eval(script, 0)
        assert result == 55  # Sum of 1..10


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
