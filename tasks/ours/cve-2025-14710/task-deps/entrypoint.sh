#!/bin/bash

# Wait for MySQL to be ready
echo "Waiting for MySQL..."
max_retries=30
retries=0
while ! mysqladmin ping -h db -u root -proot --silent 2>/dev/null; do
    retries=$((retries + 1))
    if [ $retries -ge $max_retries ]; then
        echo "MySQL not available after $max_retries attempts, starting Apache anyway..."
        break
    fi
    echo "MySQL not ready yet... attempt $retries/$max_retries"
    sleep 2
done
echo "MySQL is ready!"

# Ensure user table exists (it may be missing due to initialization issues)
echo "Ensuring user table exists..."
mysql -h db -u root -proot db_Hotel -e "
CREATE TABLE IF NOT EXISTS \`user\` (
  \`id\` int(10) NOT NULL AUTO_INCREMENT COMMENT 'id',
  \`telephone\` varchar(11) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '手机号',
  \`gender\` varchar(4) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL DEFAULT '男' COMMENT '性别',
  \`birthday\` varchar(10) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '生日',
  \`password\` varchar(100) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '密码',
  \`avator\` varchar(100) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '头像',
  \`account\` int(20) NOT NULL DEFAULT '0' COMMENT '账户余额',
  \`nickname\` varchar(30) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '昵称',
  PRIMARY KEY (\`id\`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

INSERT IGNORE INTO \`user\` (\`id\`, \`telephone\`, \`gender\`, \`birthday\`, \`password\`, \`avator\`, \`account\`, \`nickname\`) VALUES
(1, '15757118174', '男', '1995-02-20', '123456', '', 0, '大忙人'),
(2, '15757118111', '男', '2009-3-24', '123456', 'avator/7e5443fff29b245a0e6f127ea51c9cb1.jpg', 0, '陈独秀'),
(3, '15757118133', '', '', '123456', '', 0, '胡德全');
" 2>/dev/null || echo "Warning: Could not ensure user table"

echo "Database initialization complete!"

# Start Apache in foreground
exec apache2-foreground
