# ModSecurity Vulnerable Rule Configuration
# This configuration demonstrates CVE-2025-48866
# The vulnerability is quadratic memory consumption when multiple rules use sanitiseArg
# on parameters that have many duplicate names in a request.

# Basic ModSecurity configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off

# Enable audit logging (REQUIRED for sanitiseArg to take effect!)
# Must use "On" to audit all transactions
SecAuditEngine On
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# CRITICAL: The vulnerability manifests when MULTIPLE RULES each use sanitiseArg
# on the same parameter name. Each rule execution calls msre_action_sanitizeArg_execute()
# which iterates through ALL arguments and adds matching ones to arguments_to_sanitize.
# Since there's no "already added" check in the vulnerable version, each rule re-adds
# all N matching parameters, resulting in O(R * N) entries where R is number of rules.
# When R is proportional to N (or when downstream processing is O(N) per entry),
# this becomes O(N^2).

# Rule 1: Sanitize password in phase 1
SecRule REQUEST_METHOD "POST" \
    "id:1001,\
    phase:1,\
    pass,\
    log,\
    auditlog,\
    sanitiseArg:password,\
    msg:'Rule 1: Sanitize password'"

# Rule 2: Also sanitize password (deliberately duplicate to trigger vulnerability)
SecRule REQUEST_URI ".*" \
    "id:1002,\
    phase:1,\
    pass,\
    log,\
    auditlog,\
    sanitiseArg:password,\
    msg:'Rule 2: Sanitize password again'"

# Rule 3: Yet another sanitiseArg on password
SecRule ARGS ".*" \
    "id:1003,\
    phase:2,\
    pass,\
    log,\
    auditlog,\
    sanitiseArg:password,\
    msg:'Rule 3: Sanitize password in phase 2'"

# Rule 4: And again
SecRule REQUEST_HEADERS:Content-Type "application/x-www-form-urlencoded" \
    "id:1004,\
    phase:1,\
    pass,\
    log,\
    auditlog,\
    sanitiseArg:password,\
    msg:'Rule 4: Sanitize password for form data'"

# Rule 5: Phase 2 duplicate
SecRule REQUEST_BODY ".*" \
    "id:1005,\
    phase:2,\
    pass,\
    log,\
    auditlog,\
    sanitiseArg:password,\
    msg:'Rule 5: Sanitize password in request body'"

# Additional rules for other parameters (to demonstrate the pattern)
SecRule REQUEST_METHOD "POST" \
    "id:1010,\
    phase:1,\
    pass,\
    log,\
    auditlog,\
    sanitiseArg:username,\
    sanitiseArg:email,\
    sanitiseArg:secret,\
    msg:'Sanitize multiple sensitive parameters'"
