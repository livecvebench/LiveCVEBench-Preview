<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jehc.djshi.workflow.dao.LcSignRecordDao">
    <!--查询列表-->
    <select id="getLcSignRecordListByCondition" resultType="jehc.djshi.workflow.model.LcSignRecord" parameterType="map">
        SELECT
            id,
            lc_sign_id AS lcSignId,
            comment,
            task_id AS taskId,
            action_,
            user_id AS userId,
            create_time AS createTime,
            update_time AS updateTime,
            create_id AS createId,
            update_id AS updateId,
            batch,
            activity_id AS activityId,
            mutil_value AS mutilValue
        FROM
            lc_sign_record
        WHERE 1=1
            <if test="null != lcSignId">
                AND lc_sign_id = #{lcSignId}
            </if>
            <if test="null != taskId">
                AND task_id = #{taskId}
            </if>
            <if test="null != batch">
                AND batch = #{batch}
            </if>
    </select>

    <!--查找最新一条会签审批记录-->
    <select id="getLcSignRecordSingle" resultType="jehc.djshi.workflow.model.LcSignRecord" parameterType="map">
        SELECT
            id,
            lc_sign_id AS lcSignId,
            comment,
            task_id AS taskId,
            action_,
            user_id AS userId,
            lc_sign_record.create_time AS createTime,
            lc_sign_record.update_time AS updateTime,
            lc_sign_record.create_id AS createId,
            lc_sign_record.update_id AS updateId,
            lc_sign_record.batch,
            lc_sign_record.activity_id AS activityId,
            lc_sign_record.mutil_value AS mutilValue
        FROM
            lc_sign_record lc_sign_record
            LEFT JOIN lc_sign lc_sign ON lc_sign_record.lc_sign_id = lc_sign.lc_sign_id
        WHERE 1=1
            <if test="null != procInstId">
                AND lc_sign.proc_inst_id = #{procInstId}
            </if>
            <if test="null != activityId">
                AND lc_sign_record.activity_id = #{activityId}
            </if>
            <if test="null != batch">
                AND lc_sign.batch = #{batch}
            </if>
            <if test="null != action_">
                AND  (lc_sign_record.action_ = 10 OR lc_sign_record.action_ = 30)
            </if>
            ORDER BY lc_sign_record.create_time DESC
            LIMIT 1
    </select>

    <!--添加-->
    <insert id="addLcSignRecord" parameterType="jehc.djshi.workflow.model.LcSignRecord">
        INSERT INTO
            lc_sign_record
        (
            id,
            lc_sign_id,
            comment,
            task_id,
            action_,
            user_id,
            create_time,
            create_id,
            update_time,
            update_id,
            del_flag,
            batch,
            activity_id,
            mutil_value
        )
        VALUES
        (
            #{id},
            #{lcSignId},
            #{comment},
            #{taskId},
            #{action_},
            #{userId},
            #{createTime},
            #{createId},
            #{updateTime},
            #{updateId},
            0,
            #{batch},
            #{activityId},
            #{mutilValue}
        )
    </insert>

    <!--批量添加-->
    <insert id="addBatchLcSignRecord" parameterType="list">
        INSERT INTO
        lc_sign_record
        (
        id,
        lc_sign_id,
        comment,
        task_id,
        action_,
        user_id,
        create_time,
        create_id,
        update_time,
        update_id,
        del_flag,
        batch,
        activity_id,
        mutil_value
        )
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.id},
            #{item.lcSignId},
            #{item.comment},
            #{item.taskId},
            #{item.action_},
            #{item.userId},
            #{item.createTime},
            #{item.createId},
            #{item.updateTime},
            #{item.updateId},
            0,
            #{item.batch},
            #{item.activityId},
            #{item.mutilValue}
            )
        </foreach>
    </insert>

    <!--删除-->
    <delete id="delLcSignRecord" parameterType="map">
        DELETE FROM lc_sign_record WHERE id IN
        <foreach item="item" index="index" collection="id" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <!--获取最大批次-->
    <select id="getMaxBatch" resultType="java.lang.Integer" parameterType="jehc.djshi.workflow.model.LcSignRecord">
        SELECT
            max(batch)
        FROM
            lc_sign_record
        WHERE 1=1
            <if test="null != lcSignId">
                AND lc_sign_id = #{lcSignId}
            </if>
            <if test="null != taskId">
                AND task_id = #{taskId}
            </if>
            <if test="null != batch">
                AND batch = #{batch}
            </if>
    </select>
</mapper>