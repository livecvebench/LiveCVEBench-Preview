services:
  rallly_db:
    image: postgres:14.2
    container_name: ${T_BENCH_TASK_DOCKER_CLIENT_CONTAINER_NAME}-rallly_db
    restart: always
    volumes:
    - rallly-db-data:/var/lib/postgresql/data
    environment:
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_USER=postgres
    - POSTGRES_DB=rallly
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  client:
    build:
      dockerfile: Dockerfile
    image: ${T_BENCH_TASK_DOCKER_CLIENT_IMAGE_NAME}
    container_name: ${T_BENCH_TASK_DOCKER_CLIENT_CONTAINER_NAME}
    command: ["/entrypoint.sh"]
    environment:
    - TEST_DIR=${T_BENCH_TEST_DIR}
    - DATABASE_URL=postgres://postgres:postgres@rallly_db/rallly
    - DIRECT_DATABASE_URL=postgres://postgres:postgres@rallly_db/rallly
    - SECRET_PASSWORD=a-secure-secret-password-at-least-32-characters-long-for-cve
    - NEXT_PUBLIC_BASE_URL=http://localhost:3000
    - AUTH_URL=http://localhost:3000
    - QUICK_CREATE_ENABLED=true
    - SELF_HOSTED=true
    - PORT=3000
    - HOSTNAME=0.0.0.0
    volumes:
    - ${T_BENCH_TASK_LOGS_PATH}:${T_BENCH_CONTAINER_LOGS_PATH}
    - ${T_BENCH_TASK_AGENT_LOGS_PATH}:${T_BENCH_CONTAINER_AGENT_LOGS_PATH}
    depends_on:
      rallly_db:
        condition: service_healthy
    restart: always

volumes:
  rallly-db-data: