"""
Functional tests for ImageMagick.
These tests verify that basic ImageMagick operations work correctly.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import tempfile
import pytest


class TestImageMagickBasicFunctionality:
    """Test basic ImageMagick functionality."""

    @pytest.fixture(autouse=True)
    def setup_teardown(self):
        """Setup and teardown for each test."""
        self.test_dir = tempfile.mkdtemp()
        yield
        # Cleanup
        import shutil
        shutil.rmtree(self.test_dir, ignore_errors=True)

    def test_imagemagick_installed(self):
        """Verify ImageMagick is installed and accessible."""
        result = subprocess.run(
            ['magick', '--version'],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"magick --version failed: {result.stderr}"
        assert 'ImageMagick' in result.stdout, "ImageMagick not found in version output"

    def test_convert_command_available(self):
        """Verify convert command is available."""
        result = subprocess.run(
            ['convert', '--version'],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"convert --version failed: {result.stderr}"
        assert 'ImageMagick' in result.stdout

    def test_mogrify_command_available(self):
        """Verify mogrify command is available."""
        result = subprocess.run(
            ['mogrify', '--version'],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"mogrify --version failed: {result.stderr}"
        assert 'ImageMagick' in result.stdout

    def test_basic_image_creation(self):
        """Verify basic image creation works."""
        output_path = os.path.join(self.test_dir, 'test_create.png')
        result = subprocess.run(
            ['convert', '-size', '100x100', 'xc:red', output_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Image creation failed: {result.stderr}"
        assert os.path.exists(output_path), "Output image was not created"

    def test_basic_image_conversion(self):
        """Verify basic image format conversion works."""
        input_path = os.path.join(self.test_dir, 'input.png')
        output_path = os.path.join(self.test_dir, 'output.jpg')

        # Create input image
        subprocess.run(
            ['convert', '-size', '50x50', 'xc:blue', input_path],
            check=True
        )
        assert os.path.exists(input_path)

        # Convert to JPEG
        result = subprocess.run(
            ['convert', input_path, output_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Conversion failed: {result.stderr}"
        assert os.path.exists(output_path), "Output JPEG was not created"

    def test_image_resize(self):
        """Verify image resizing works."""
        input_path = os.path.join(self.test_dir, 'resize_input.png')
        output_path = os.path.join(self.test_dir, 'resize_output.png')

        # Create input image
        subprocess.run(
            ['convert', '-size', '200x200', 'xc:green', input_path],
            check=True
        )

        # Resize image
        result = subprocess.run(
            ['convert', input_path, '-resize', '50x50', output_path],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Resize failed: {result.stderr}"
        assert os.path.exists(output_path)

    def test_safe_format_specifier_d(self):
        """Verify safe %d format specifier works correctly."""
        input_path = os.path.join(self.test_dir, 'input_seq.png')
        output_pattern = os.path.join(self.test_dir, 'output_%03d.png')

        # Create input image
        subprocess.run(
            ['convert', '-size', '10x10', 'xc:white', input_path],
            check=True
        )

        # Use %d format specifier (safe usage)
        result = subprocess.run(
            ['convert', input_path, output_pattern],
            capture_output=True,
            text=True,
            timeout=10
        )
        # Should complete without crashing
        # Return code may vary but should not crash
        assert result.returncode in [0, 1], f"Unexpected crash: {result.stderr}"

    def test_safe_format_specifier_with_padding(self):
        """Verify padded format specifier (%04d) works."""
        input_path = os.path.join(self.test_dir, 'input_pad.png')
        output_pattern = os.path.join(self.test_dir, 'output_%04d.png')

        subprocess.run(
            ['convert', '-size', '10x10', 'xc:yellow', input_path],
            check=True
        )

        result = subprocess.run(
            ['convert', input_path, output_pattern],
            capture_output=True,
            text=True,
            timeout=10
        )
        # Should complete without crashing
        assert result.returncode in [0, 1], f"Unexpected crash: {result.stderr}"

    def test_mogrify_basic_operation(self):
        """Verify mogrify basic operation works."""
        test_img = os.path.join(self.test_dir, 'mogrify_test.png')
        subprocess.run(
            ['convert', '-size', '100x100', 'xc:purple', test_img],
            check=True
        )

        # Use mogrify to resize in place
        result = subprocess.run(
            ['mogrify', '-resize', '50x50', test_img],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert result.returncode == 0, f"mogrify failed: {result.stderr}"
        assert os.path.exists(test_img)

    def test_identify_command(self):
        """Verify identify command works."""
        test_img = os.path.join(self.test_dir, 'identify_test.png')
        subprocess.run(
            ['convert', '-size', '64x64', 'xc:cyan', test_img],
            check=True
        )

        result = subprocess.run(
            ['identify', test_img],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"identify failed: {result.stderr}"
        assert '64x64' in result.stdout, "Image dimensions not found in identify output"

    def test_escaped_percent(self):
        """Verify escaped %% works correctly."""
        input_path = os.path.join(self.test_dir, 'escape_input.png')
        # Using %% should produce a literal %
        output_path = os.path.join(self.test_dir, 'output_100%%.png')

        subprocess.run(
            ['convert', '-size', '10x10', 'xc:black', input_path],
            check=True
        )

        result = subprocess.run(
            ['convert', input_path, output_path],
            capture_output=True,
            text=True,
            timeout=10
        )
        # Should not crash
        assert result.returncode in [0, 1], f"Crashed on escaped percent: {result.stderr}"
