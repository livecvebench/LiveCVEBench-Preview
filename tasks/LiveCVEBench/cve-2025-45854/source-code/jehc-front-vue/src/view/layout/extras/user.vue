<template>
  <div class="topbar-item">
    <div class="btn btn-icon w-auto btn-clean d-flex align-items-center btn-lg px-2" id="kt_quick_user_toggle">
      <span class="text-muted font-weight-bold font-size-base d-none d-md-inline mr-1">
        您好,
      </span>
      <span class="text-dark-50 font-weight-bolder font-size-base d-none d-md-inline mr-3">
        {{ globalUserInfo.currentUserName }}
      </span>
      <span class="symbol symbol-35 symbol-light-success">
        <img v-if="false" alt="Pic" :src="globalUserInfo.currentPic" />
        <span v-if="true" class="symbol-label font-size-h5 font-weight-bold">
          {{ globalUserInfo.currentUserName.charAt(0).toUpperCase() }}
        </span>
      </span>
    </div>
    <div id="kt_quick_user" ref="kt_quick_user" class="offcanvas offcanvas-right p-10">
      <!--begin::Header-->
      <div class="offcanvas-header d-flex align-items-center justify-content-between pb-5">
        <h3 class="font-weight-bold m-0">
          用户信息
        </h3>
        <a href="#" class="btn btn-xs btn-icon btn-light btn-hover-primary" id="kt_quick_user_close">
          <i class="ki ki-close icon-xs text-muted"></i>
        </a>
      </div>
      <!--end::Header-->

      <!--begin::Content-->
      <perfect-scrollbar
        class="offcanvas-content pr-5 mr-n5 scroll"
        style="max-height: 90vh; position: relative;"
      >
        <!--begin::Header-->
        <div class="d-flex align-items-center mt-5">
          <div class="symbol symbol-100 mr-5">
            <img
              class="symbol-label"
              :src="globalUserInfo.currentPic"
              alt=""
              @click="showUploadPic"
            />
            <i class="symbol-badge bg-success"></i>
          </div>
          <div class="d-flex flex-column">
            <button
              class="font-weight-bold font-size-h5 text-dark-75 text-hover-primary"
            >
            {{ globalUserInfo.currentUserName }}
            </button>
            <div class="text-muted mt-1"> {{ globalUserInfo.currentAccount }}</div>
            <div class="navi mt-2">
              <a href="javascript:" class="navi-item">
                <span class="navi-link p-0 pb-2">
                  <span class="navi-icon mr-1">
                    <span class="svg-icon svg-icon-lg svg-icon-primary">
                      <inline-svg src="media/svg/icons/Communication/Mail-notification.svg" />
                    </span>
                  </span>
                  <span class="navi-text text-muted text-hover-primary">
                    {{ globalUserInfo.currentEmail }}
                  </span>
                </span>
              </a>
            </div>
            <button class="btn btn-light-primary btn-bold" @click="onLogout">
              退出
            </button>
          </div>
        </div>
        <!--end::Header-->
        <div class="separator separator-dashed mt-8 mb-5"></div>
        <!--begin::Nav-->
        <div class="navi navi-spacer-x-0 p-0">
          <!--begin::Item-->
          <button
          @click="showMyInfo"
            href="#"
            class="navi-item"
          >
            <div class="navi-link">
              <div class="symbol symbol-40 bg-light mr-3">
                <div class="symbol-label">
                  <span class="svg-icon svg-icon-md svg-icon-success">
                    <inline-svg  src="media/svg/icons/General/User.svg"/>
                  </span>
                </div>
              </div>
              <div class="navi-text">
                <div class="font-weight-bold">个人信息</div>
              </div>
            </div>
          </button>
          <!--end:Item-->
          <!--begin::Item-->
          <button
          @click="showUploadPic"
            href="#"
            class="navi-item"
          >
            <div class="navi-link">
              <div class="symbol symbol-40 bg-light mr-3">
                <div class="symbol-label">
                  <span class="svg-icon svg-icon-md svg-icon-primary">
                    <inline-svg  src="media/svg/icons/Files/Pictures1.svg"/>
                  </span>
                </div>
              </div>
              <div class="navi-text">
                <div class="font-weight-bold">上传头像</div>
              </div>
            </div>
          </button>
          <!--begin::Item-->
          <!-- <router-link
            to="/builder"
            @click.native="closeOffcanvas"
            href="#"
            class="navi-item"
          >
            <div class="navi-link">
              <div class="symbol symbol-40 bg-light mr-3">
                <div class="symbol-label">
                  <span class="svg-icon svg-icon-md svg-icon-warning">
                    <inline-svg src="media/svg/icons/Design/Horizontal.svg" />
                  </span>
                </div>
              </div>
              <div class="navi-text">
                <div class="font-weight-bold">设置主题</div>
              </div>
            </div>
          </router-link> -->
          <!--end:Item-->
          <!--begin::Item-->
          <button
            @click="showUpdatePassword"
            class="navi-item"
          >
            <div class="navi-link">
              <div class="symbol symbol-40 bg-light mr-3">
                <div class="symbol-label">
                  <span class="svg-icon svg-icon-md svg-icon-danger">
                    <inline-svg src="media/svg/icons/Tools/Pantone.svg" />
                  </span>
                </div>
              </div>
              <div class="navi-text">
                <div class="font-weight-bold">修改密码</div>
              </div>
            </div>
          </button>
          <!--end:Item-->
          <!--begin::Item-->
          <button
            @click="showChat"
            href="#"
            class="navi-item"
          >
            <div class="navi-link">
              <div class="symbol symbol-40 bg-light mr-3">
                <div class="symbol-label">
                  <span class="svg-icon svg-icon-md svg-icon-primary">
                    <inline-svg src="media/svg/icons/Communication/Chat-error.svg"/>
                  </span>
                </div>
              </div>
              <div class="navi-text">
                <div class="font-weight-bold">在线聊天</div>
              </div>
            </div>
          </button>
          <!--end:Item-->
          <!--begin::Item-->
          <button
          @click="lockWin"
            href="#"
            class="navi-item"
          >
            <div class="navi-link">
              <div class="symbol symbol-40 bg-light mr-3">
                <div class="symbol-label">
                  <span class="svg-icon svg-icon-md svg-icon-info">
                    <inline-svg  src="media/svg/icons/General/Lock.svg"/>
                  </span>
                </div>
              </div>
              <div class="navi-text">
                <div class="font-weight-bold">锁屏</div>
              </div>
            </div>
          </button>
          <!--begin::Item-->
        </div>
        <!--end::Nav-->
        <div class="separator separator-dashed my-7"></div>
        
      </perfect-scrollbar>
      <!--end::Content-->
    </div>
    <PasswordComponents ref="PasswordComponentsRef"></PasswordComponents>
    <UserInfoComponents ref="UserInfoComponentsRef"></UserInfoComponents>
    <UserPicComponents ref="UserPicComponentsRef" @change="setUserPic"></UserPicComponents>
    
  </div>
</template>

<style lang="scss" scoped>
#kt_quick_user {
  overflow: hidden;
}
</style>

<script>
import { mapGetters } from "vuex";
import PasswordComponents from "@/components/password.vue";
import UserInfoComponents from "@/components/user-info.vue";
import UserPicComponents from  "@/components/user-pic-upload.vue";
import KTLayoutQuickUser from "@/assets/js/layout/extended/quick-user.js";
import KTOffcanvas from "@/assets/js/components/offcanvas.js";
import { setCookie, getCookie ,handleAlert} from "@/core/util/jehcUtil.js";
import tokenUtil from "@/core/util/tokenUtil.js";
import apiUtil from "@/core/util/apiUtil.js";
export default {
  name: "KTQuickUser",
  data() {
    return {
      globalUserInfo:{currentUserName:"",currentAccount:"",currentEmail:"暂无",currentPic:"media/users/default.jpg"}
    };
  },
  components:{
    PasswordComponents,
    UserInfoComponents,
    UserPicComponents,
  },
  mounted() {
    // Init Quick User Panel
    KTLayoutQuickUser.init(this.$refs["kt_quick_user"]);
    this.initMyInfo();
  },
  methods: {
    onLogout() {
      let thiz = this;
      // 删除前提示
      this.$confirm("确定要退出平台?", "提示", { type: "warning", }).then(() => {
                apiUtil.post(process.env.VUE_APP_OAUTH_API + "/loginOut").then(data => {
                    if (data.data.success) {      
                      tokenUtil.destroyToken();   
                      handleAlert("退出成功", "success", 3);              
                      // thiz.$router.push({ name: "/login" });
                      thiz.$router.push("/login" );
                    } else {
                        handleAlert("退出失败", "error", 3);
                    }
                });
            }).catch(() => { });//注意这里，这里是重点！！！;     
    },
    closeOffcanvas() {
      new KTOffcanvas(KTLayoutQuickUser.getElement()).hide();
    },
    showUpdatePassword(){
      this.$refs.PasswordComponentsRef.showModal()
    },
    showMyInfo(){
      this.$refs.UserInfoComponentsRef.showModal();
    },
    showChat(){
      handleAlert("待开发", "warning", 3); 
    },
    showUploadPic(){
      this.$refs.UserPicComponentsRef.showModal();
    },
    initMyInfo(){
      let thiz = this;
      apiUtil.get(process.env.VUE_APP_OAUTH_API + "/httpSessionEntity").then(({ data }) => {
        if(null == data.oauthAccountEntity){
          handleAlert("会话已失效，重新登录", "warning", 3); 
          // thiz.$router.push({ name: "login" });
          thiz.$router.push("/login" );
          return;
        }
        this.globalUserInfo.currentAccount = data.oauthAccountEntity.account
        this.globalUserInfo.currentUserName = data.oauthAccountEntity.name
        this.globalUserInfo.currentEmail = data.oauthAccountEntity.email
        this.initMyPic(this.globalUserInfo.currentAccount);       
      });
    },
    initMyPic(userName){
      if(null != userName && "" != userName){
        apiUtil.get(process.env.VUE_APP_OAUTH_API + "/oauthAccount/single/"+userName).then(({ data }) => {
          if(null != data.data){           
            if(null != data && null != data.data && null != data.data.smallPic && "" != data.data.smallPic){
              this.globalUserInfo.currentPic = data.data.smallPic;     
            }else{
              this.globalUserInfo.currentPic = "media/users/default.jpg";
            }
          }
        });
      }
    },
    setUserPic(data){
      if(null != data && null != data.data && null != data.data.smallPic && "" != data.data.smallPic){
        this.globalUserInfo.currentPic = data.data.smallPic;
      }
    },
    lockWin(){
      handleAlert("待开发", "warning", 3);
    },
  },
  computed: {
    // ...mapGetters(["currentUserPersonalInfo"]),
    // getFullName() {
    //   return (
    //     this.currentUserPersonalInfo.name +
    //     " " +
    //     this.currentUserPersonalInfo.surname
    //   );
    // }
  }
};
</script>
