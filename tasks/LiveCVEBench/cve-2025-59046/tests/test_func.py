"""
Functional tests for interactive-git-checkout package.
These tests verify basic functionality and should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import pytest


# Path to node modules in the container
NODE_PATH = '/app/node_modules'
PACKAGE_PATH = f'{NODE_PATH}/interactive-git-checkout'


def run_node_script(script, timeout=30):
    """Helper to run Node.js scripts with proper NODE_PATH"""
    env = os.environ.copy()
    env['NODE_PATH'] = NODE_PATH
    result = subprocess.run(
        ['node', '-e', script],
        capture_output=True,
        text=True,
        timeout=timeout,
        env=env,
        cwd='/app'
    )
    return result


class TestPackageLoading:
    """Tests that verify the package can be loaded correctly"""

    def test_checkout_module_can_be_required(self):
        """Test that checkout.js can be required without errors"""
        script = """
const checkout = require('interactive-git-checkout/src/checkout');
console.log(typeof checkout === 'function' ? 'OK' : 'FAIL');
"""
        result = run_node_script(script)
        assert result.returncode == 0, f"Failed to require checkout module: {result.stderr}"
        assert 'OK' in result.stdout, f"checkout is not a function: {result.stdout}"

    def test_checkout_to_new_module_can_be_required(self):
        """Test that checkoutToNew.js can be required without errors"""
        script = """
const checkoutToNew = require('interactive-git-checkout/src/checkoutToNew');
console.log(typeof checkoutToNew === 'function' ? 'OK' : 'FAIL');
"""
        result = run_node_script(script)
        assert result.returncode == 0, f"Failed to require checkoutToNew module: {result.stderr}"
        assert 'OK' in result.stdout, f"checkoutToNew is not a function: {result.stdout}"

    def test_get_branches_module_can_be_required(self):
        """Test that getBranches.js can be required without errors"""
        script = """
const getBranches = require('interactive-git-checkout/src/getBranches');
console.log(typeof getBranches === 'function' ? 'OK' : 'FAIL');
"""
        result = run_node_script(script)
        assert result.returncode == 0, f"Failed to require getBranches module: {result.stderr}"
        assert 'OK' in result.stdout, f"getBranches is not a function: {result.stdout}"


class TestGitIntegration:
    """Tests that verify git functionality works correctly"""

    def test_get_branches_returns_branches(self):
        """Test that getBranches returns the list of branches"""
        script = """
const getBranches = require('interactive-git-checkout/src/getBranches');

(async () => {
    try {
        const result = await getBranches();
        if (result && Array.isArray(result.branches)) {
            console.log('OK:' + result.branches.length);
        } else {
            console.log('FAIL: invalid result structure');
        }
    } catch (e) {
        console.log('ERROR:' + e.message);
    }
})();
"""
        result = run_node_script(script)
        assert 'OK:' in result.stdout, f"getBranches failed: {result.stdout} {result.stderr}"

    def test_checkout_handles_nonexistent_branch_gracefully(self):
        """Test that checkout fails gracefully for non-existent branches"""
        script = """
const checkout = require('interactive-git-checkout/src/checkout');

(async () => {
    try {
        await checkout('nonexistent-branch-xyz123');
        console.log('NO_ERROR');
    } catch (e) {
        // Expected behavior - should throw an error for non-existent branch
        console.log('EXPECTED_ERROR');
    }
})();
"""
        result = run_node_script(script)
        # Should either throw an error (expected) or return without error
        assert 'EXPECTED_ERROR' in result.stdout or 'NO_ERROR' in result.stdout, \
            f"Unexpected behavior: {result.stdout} {result.stderr}"

    def test_checkout_to_new_with_valid_name(self):
        """Test that checkoutToNew works with valid branch names"""
        import random
        branch_name = f"test-branch-func-{random.randint(10000, 99999)}"

        script = f"""
const checkoutToNew = require('interactive-git-checkout/src/checkoutToNew');

(async () => {{
    try {{
        await checkoutToNew('{branch_name}');
        console.log('OK');
    }} catch (e) {{
        // May fail if branch exists or other git issues, but should not crash
        console.log('ERROR:' + e.message);
    }}
}})();
"""
        result = run_node_script(script)
        # Either succeeds or fails with a git error (not a crash)
        assert 'OK' in result.stdout or 'ERROR:' in result.stdout, \
            f"Unexpected behavior: {result.stdout} {result.stderr}"


class TestNormalBranchNames:
    """Tests for normal, safe branch names"""

    def test_checkout_with_feature_branch_style(self):
        """Test checkout with typical feature branch naming"""
        script = """
const checkout = require('interactive-git-checkout/src/checkout');

(async () => {
    try {
        await checkout('feature/user-auth');
        console.log('SUCCESS');
    } catch (e) {
        // Expected to fail (branch doesn't exist) but should complete normally
        console.log('COMPLETED');
    }
})();
"""
        result = run_node_script(script)
        assert 'SUCCESS' in result.stdout or 'COMPLETED' in result.stdout

    def test_checkout_with_hyphenated_names(self):
        """Test checkout with hyphenated branch names"""
        script = """
const checkout = require('interactive-git-checkout/src/checkout');

(async () => {
    try {
        await checkout('fix-bug-123');
        console.log('SUCCESS');
    } catch (e) {
        console.log('COMPLETED');
    }
})();
"""
        result = run_node_script(script)
        assert 'SUCCESS' in result.stdout or 'COMPLETED' in result.stdout

    def test_checkout_with_underscores(self):
        """Test checkout with underscore-containing branch names"""
        script = """
const checkout = require('interactive-git-checkout/src/checkout');

(async () => {
    try {
        await checkout('feature_new_ui');
        console.log('SUCCESS');
    } catch (e) {
        console.log('COMPLETED');
    }
})();
"""
        result = run_node_script(script)
        assert 'SUCCESS' in result.stdout or 'COMPLETED' in result.stdout
