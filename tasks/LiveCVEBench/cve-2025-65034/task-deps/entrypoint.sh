#!/bin/bash
set -e

# Set environment variables needed for the application
export DIRECT_DATABASE_URL=${DATABASE_URL}
export AUTH_URL=${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}

# Run database migrations
echo "Running database migrations..."
prisma migrate deploy --schema=/app/packages/database/prisma/schema.prisma

# Start the application in a loop to support restarts
echo "Starting Rallly application..."
while true; do
    node /app/apps/web/.next/standalone/apps/web/server.js || {
        echo "Application exited with code $?, restarting in 2 seconds..."
        sleep 2
    }
done
