#!/bin/bash
# Entrypoint script for WeGIA application
# Waits for MySQL to be ready before starting Apache

set -e

echo "Waiting for MySQL to be ready..."

# Wait for MySQL to be available using PHP PDO instead of mysql command
# This avoids SSL issues and matches how the application connects
max_retries=60
counter=0
until php -r "
try {
    new PDO('mysql:host=mysql;dbname=wegia', 'wegiauser', 'wegiapass');
    echo 'Connected';
    exit(0);
} catch (Exception \$e) {
    exit(1);
}
" 2>/dev/null; do
    counter=$((counter+1))
    if [ $counter -gt $max_retries ]; then
        echo "MySQL did not become ready in time. Starting Apache anyway..."
        break
    fi
    echo "Waiting for MySQL... (attempt $counter/$max_retries)"
    sleep 2
done

echo "MySQL is ready. Initializing database..."

# Initialize database
if [ -f /var/www/html/init-db.sh ]; then
    bash /var/www/html/init-db.sh || echo "Database initialization had errors, continuing..."
fi

echo "Starting Apache..."

# Start Apache in foreground
exec apache2-foreground
