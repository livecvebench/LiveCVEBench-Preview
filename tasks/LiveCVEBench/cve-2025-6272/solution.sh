#!/bin/bash
# Solution script for wasm3 out-of-bounds write vulnerability.
# This fix adds a check for the c_slotUnused sentinel value before
# accessing the slot allocation array.

set -e

cd /app

SOURCE_FILE="source/m3_compile.c"

# Verify the file exists
if [ ! -f "$SOURCE_FILE" ]; then
    echo "ERROR: Source file not found: $SOURCE_FILE"
    exit 1
fi

# Create backup
cp "$SOURCE_FILE" "${SOURCE_FILE}.bak"

echo "Applying fix to $SOURCE_FILE..."

# The fix adds bounds checking to MarkSlotAllocated to prevent
# accessing m3Slots with an out-of-bounds index (like c_slotUnused = 0xffff)
#
# We modify MarkSlotAllocated to return early if i_slot >= d_m3MaxFunctionSlots
# The check must be BEFORE the d_m3Assert which also accesses the array!

# First, apply the fix at the call sites (as in the upstream fix)
# This adds: && slot != c_slotUnused to the condition before MarkSlotsAllocatedByType
sed -i 's/if (slot >= o->slotFirstDynamicIndex)$/if (slot >= o->slotFirstDynamicIndex \&\& slot != c_slotUnused)/' "$SOURCE_FILE"

# Now we need to add bounds checking BEFORE the assertion in MarkSlotAllocated
# The function looks like:
#   void  MarkSlotAllocated  (IM3Compilation o, u16 i_slot)
#   {                                                                   d_m3Assert (o->m3Slots [i_slot] == 0);
#
# We need to change it to:
#   void  MarkSlotAllocated  (IM3Compilation o, u16 i_slot)
#   {   if (i_slot >= d_m3MaxFunctionSlots) return;                     d_m3Assert (o->m3Slots [i_slot] == 0);

# The tricky part is the opening brace is on the same line with whitespace before the assertion
# Let's replace the whole pattern

sed -i 's/^{[[:space:]]*d_m3Assert (o->m3Slots \[i_slot\] == 0);/{   if (i_slot >= d_m3MaxFunctionSlots) return; d_m3Assert (o->m3Slots [i_slot] == 0);/' "$SOURCE_FILE"

# Verify the fixes were applied
if grep -q "slot != c_slotUnused" "$SOURCE_FILE" && grep -q "i_slot >= d_m3MaxFunctionSlots" "$SOURCE_FILE"; then
    echo "Fixes applied successfully!"
    rm "${SOURCE_FILE}.bak"
else
    echo "WARNING: Some fixes may not have been applied correctly"

    # Check each fix
    if ! grep -q "slot != c_slotUnused" "$SOURCE_FILE"; then
        echo "  - Call site fix (slot != c_slotUnused) not found"
    fi
    if ! grep -q "i_slot >= d_m3MaxFunctionSlots" "$SOURCE_FILE"; then
        echo "  - Bounds check fix not found, trying alternative approach..."

        # Try matching with more flexible whitespace
        sed -i 's/{[[:space:]]*d_m3Assert[[:space:]]*(o->m3Slots[[:space:]]*\[[[:space:]]*i_slot[[:space:]]*\][[:space:]]*==[[:space:]]*0);/{   if (i_slot >= d_m3MaxFunctionSlots) return; d_m3Assert (o->m3Slots [i_slot] == 0);/' "$SOURCE_FILE"
    fi

    if grep -q "i_slot >= d_m3MaxFunctionSlots" "$SOURCE_FILE"; then
        echo "Alternative fix applied successfully!"
        rm "${SOURCE_FILE}.bak"
    else
        echo "ERROR: Failed to apply fix"
        mv "${SOURCE_FILE}.bak" "$SOURCE_FILE"
        exit 1
    fi
fi

# Rebuild wasm3 with the fix
echo "Rebuilding wasm3..."
cd /app/build

# Force clean rebuild to ensure patched code is compiled
make clean
make -j$(nproc) 2>/dev/null || make

echo ""
echo "Fix complete! wasm3 has been rebuilt with the vulnerability patched."
echo ""
echo "The fix adds:"
echo "1. A bounds check in MarkSlotAllocated BEFORE array access to prevent OOB"
echo "2. A check for c_slotUnused at call sites to MarkSlotsAllocatedByType"
