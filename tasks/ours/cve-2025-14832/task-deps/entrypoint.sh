#!/bin/bash
set -e

# Wait for MySQL to be ready
echo "Waiting for MySQL..."
while ! mysqladmin ping -h"$MYSQL_HOST" --silent 2>/dev/null; do
    sleep 1
done

# Check if database is initialized (tables exist)
TABLE_COUNT=$(mysql -h"$MYSQL_HOST" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "USE cakes; SHOW TABLES;" 2>/dev/null | wc -l)

if [ "$TABLE_COUNT" -lt 2 ]; then
    echo "Initializing database..."
    mysql -h"$MYSQL_HOST" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" cakes < /var/www/html/cakeshop/db/cakes.sql 2>/dev/null || true
    echo "Database initialized."
else
    echo "Database already initialized."
fi

# Start Apache in foreground
exec apache2-foreground
