<?php
namespace app\auth\controller;

use think\Controller;

/**
 * Widget Controller for Central Authentication Service
 *
 * This controller handles widget rendering with user-controlled parameters.
 * It allows dynamic loading of widget components based on layer, widget name,
 * and action parameters.
 */
class Widget extends Controller
{
    /**
     * Fallback method for undefined actions
     * Uses user input to dynamically load widget components
     */
    public function _empty()
    {
        // Get user-controlled parameters
        $layer = input('get.layer', 'view');
        $widget = input('get.widget', 'default');
        $action = input('get.action', 'render');

        // Dynamic class invocation based on parameters
        $class = "\\app\\{$layer}\\widget\\{$widget}";

        // Dynamic class instantiation
        if (class_exists($class)) {
            $instance = new $class();
            // Dynamic method call
            if (method_exists($instance, $action)) {
                return $instance->$action();
            }
        }

        // Template path constructed from user input
        return $this->fetch('widget/' . $widget, [
            'layer' => $layer,
            'action' => $action
        ]);
    }

    /**
     * Widget rendering endpoint
     * Alternative entry point
     */
    public function index()
    {
        return $this->_empty();
    }

    /**
     * Render a specific widget
     * Uses action() helper with user-controlled input
     */
    public function render()
    {
        $layer = input('get.layer');
        $widget = input('get.widget');
        $action = input('get.action');

        if ($layer && $widget && $action) {
            // ThinkPHP's action() allows calling controller/action combinations
            return action("{$layer}/{$widget}/{$action}");
        }

        return $this->fetch('widget/default');
    }
}
