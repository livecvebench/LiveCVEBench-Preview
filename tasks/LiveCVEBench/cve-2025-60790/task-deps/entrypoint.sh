#!/bin/bash
set -e

# Wait for MySQL to be ready
wait_for_mysql() {
    echo "Waiting for MySQL to be ready..."
    max_attempts=60
    attempt=0
    while [ $attempt -lt $max_attempts ]; do
        # Skip SSL verification for MySQL/MariaDB
        if mysqladmin ping -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" --skip-ssl --silent 2>/dev/null; then
            echo "MySQL is ready!"
            return 0
        fi
        attempt=$((attempt + 1))
        echo "Waiting for MySQL... ($attempt/$max_attempts)"
        sleep 2
    done
    echo "MySQL did not become ready in time, continuing anyway..."
    return 0
}

# Initialize ProcessWire database if not already done
init_processwire_db() {
    echo "Checking ProcessWire installation..."

    # Check if tables exist
    TABLES=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" --skip-ssl "$DB_NAME" -e "SHOW TABLES;" 2>/dev/null | wc -l) || TABLES=0

    if [ "$TABLES" -lt 5 ]; then
        echo "Database appears empty, ProcessWire needs installation via web interface."
    else
        echo "Database has $TABLES tables, ProcessWire appears to be installed."
    fi
}

# Environment defaults
export DB_HOST="${DB_HOST:-db}"
export DB_NAME="${DB_NAME:-processwire}"
export DB_USER="${DB_USER:-processwire}"
export DB_PASS="${DB_PASS:-processwire}"

# Wait for database
wait_for_mysql

# Check database status
init_processwire_db

# Start Apache
echo "Starting Apache web server..."
exec apache2-foreground
