#!/bin/bash
# Solution script for YesWiki archive API access control issue
# Fixes the misconfigured ACL that allows unauthenticated access to archive endpoints

set -e

echo "[*] Applying fix for YesWiki archive API access control..."

# Path to the main API controller in the container
API_CONTROLLER="/app/includes/controllers/ApiController.php"

# Check if file exists
if [ ! -f "$API_CONTROLLER" ]; then
    echo "[-] Error: ApiController.php not found at $API_CONTROLLER"
    # Try alternate location
    if [ -f "/var/www/html/includes/controllers/ApiController.php" ]; then
        API_CONTROLLER="/var/www/html/includes/controllers/ApiController.php"
        echo "[*] Found ApiController at alternate location: $API_CONTROLLER"
    else
        echo "[-] Cannot find ApiController.php"
        exit 1
    fi
fi

echo "[*] Fixing ACL configuration in $API_CONTROLLER..."

# The vulnerability is in route annotations where ACL is {"public", "@admins"}
# This incorrectly allows public (unauthenticated) access because "public" OR "@admins"
# means either condition grants access.
#
# Fix: Remove "public", from the ACL arrays, leaving only "@admins"
# This ensures only authenticated administrators can access these endpoints.

# Fix archive routes - change {"public", "@admins"} to {"@admins"}
# Using sed to perform the replacement globally
sed -i 's/options={"acl":{"public", "@admins"}}/options={"acl":{"@admins"}}/g' "$API_CONTROLLER"

# Also fix routes that might have slightly different spacing
sed -i 's/options={"acl":{"public","@admins"}}/options={"acl":{"@admins"}}/g' "$API_CONTROLLER"

# Fix routes with "+" (logged-in users) pattern: {"public", "+"} -> {"+"}
sed -i 's/options={"acl":{"public", "+"}}/options={"acl":{"+"}}/g' "$API_CONTROLLER"
sed -i 's/options={"acl":{"public","+"}}/options={"acl":{"+"}}/g' "$API_CONTROLLER"

# Also fix the templates controller if it exists
TEMPLATES_CONTROLLER="/app/tools/templates/controllers/ApiController.php"
if [ ! -f "$TEMPLATES_CONTROLLER" ]; then
    TEMPLATES_CONTROLLER="/var/www/html/tools/templates/controllers/ApiController.php"
fi

if [ -f "$TEMPLATES_CONTROLLER" ]; then
    echo "[*] Also fixing $TEMPLATES_CONTROLLER..."
    sed -i 's/options={"acl":{"public", "@admins"}}/options={"acl":{"@admins"}}/g' "$TEMPLATES_CONTROLLER"
    sed -i 's/options={"acl":{"public","@admins"}}/options={"acl":{"@admins"}}/g' "$TEMPLATES_CONTROLLER"
    sed -i 's/options={"acl":{"public", "+"}}/options={"acl":{"+"}}/g' "$TEMPLATES_CONTROLLER"
    sed -i 's/options={"acl":{"public","+"}}/options={"acl":{"+"}}/g' "$TEMPLATES_CONTROLLER"
fi

# Verify the fix was applied
echo "[*] Verifying fix..."
if grep -q '"acl":{"public", "@admins"}' "$API_CONTROLLER" 2>/dev/null; then
    echo "[-] Warning: Some vulnerable ACL patterns may still exist"
    grep -n '"acl":{"public", "@admins"}' "$API_CONTROLLER" || true
else
    echo "[+] No vulnerable ACL patterns found in main controller"
fi

if grep -q '"acl":{"public","@admins"}' "$API_CONTROLLER" 2>/dev/null; then
    echo "[-] Warning: Some vulnerable ACL patterns (no space) may still exist"
else
    echo "[+] All ACL patterns appear to be fixed"
fi

# Clear any cached routes (Symfony caches route metadata)
echo "[*] Clearing route cache..."
CACHE_DIR="/app/cache"
if [ ! -d "$CACHE_DIR" ]; then
    CACHE_DIR="/var/www/html/cache"
fi

if [ -d "$CACHE_DIR" ]; then
    rm -rf "$CACHE_DIR"/* 2>/dev/null || true
    echo "[+] Cache cleared"
fi

# PHP-FPM or Apache may cache opcodes - restart if possible
echo "[*] Attempting to restart PHP service..."
if command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
elif command -v apache2ctl &> /dev/null; then
    apache2ctl graceful 2>/dev/null || true
fi

# If PHP-FPM is running, try to reload it
if pgrep -x "php-fpm" > /dev/null 2>&1; then
    pkill -USR2 php-fpm 2>/dev/null || true
fi

echo ""
echo "[+] Fix applied successfully!"
echo "[+] Archive API endpoints now require admin authentication"
echo ""
echo "Affected endpoints:"
echo "  - GET  /?api/archives"
echo "  - GET  /?api/archives/{id}"
echo "  - GET  /?api/archives/archivingStatus/"
echo "  - GET  /?api/archives/forcedUpdateToken/"
echo "  - GET  /?api/archives/uidstatus/{uid}"
echo "  - POST /?api/archives"
echo "  - POST /?api/archives/{id}"
