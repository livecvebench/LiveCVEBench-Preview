#!/bin/bash
set -e

# Copy emlog source code to the shared volume if not already there
# The source is built into /opt/emlog-src during image build
if [ ! -f "/app/emlog/index.php" ]; then
    echo "Initializing emlog source code..."
    cp -r /opt/emlog-src/* /app/emlog/
    chown -R www-data:www-data /app/emlog
    chmod -R 755 /app/emlog
    echo "Emlog source code initialized."
fi

# Ensure writable directories exist and have proper permissions
mkdir -p /app/emlog/content/cache
mkdir -p /app/emlog/content/plugins
mkdir -p /app/emlog/content/templates
chown -R www-data:www-data /app/emlog/content
chmod -R 775 /app/emlog/content

# Apply patched Store_Model for CVE testing (returns empty data instead of redirecting on API failure)
if [ -f "/opt/emlog-patches/store_model_patched.php" ]; then
    echo "Applying Store_Model patch for CVE testing..."
    cp /opt/emlog-patches/store_model_patched.php /app/emlog/include/model/store_model.php
    chown www-data:www-data /app/emlog/include/model/store_model.php
fi

# Wait for MySQL and run installation if needed (in background)
{
    echo "Waiting for MySQL..."
    max_attempts=30
    attempt=0
    while ! mysql -h"${EMLOG_DB_HOST:-db}" -u"${EMLOG_DB_USER:-emlog}" -p"${EMLOG_DB_PASSWORD:-emlog}" --skip-ssl -e "SELECT 1" 2>/dev/null; do
        attempt=$((attempt + 1))
        if [ $attempt -ge $max_attempts ]; then
            echo "MySQL connection timeout"
            exit 0
        fi
        sleep 2
    done
    echo "MySQL is ready!"

    # Check if tables exist
    TABLE_COUNT=$(mysql -h"${EMLOG_DB_HOST:-db}" -u"${EMLOG_DB_USER:-emlog}" -p"${EMLOG_DB_PASSWORD:-emlog}" --skip-ssl -D"${EMLOG_DB_NAME:-emlog}" -N -e "SHOW TABLES LIKE 'emlog_%'" 2>/dev/null | wc -l)
    if [ "$TABLE_COUNT" -lt 5 ]; then
        echo "Installing emlog database..."
        # Wait for nginx to be ready
        sleep 5
        curl -s -X POST "http://webserver-nginx:8080/install.php?action=install" \
            -d "hostname=${EMLOG_DB_HOST:-db}" \
            -d "dbuser=${EMLOG_DB_USER:-emlog}" \
            -d "dbpasswd=${EMLOG_DB_PASSWORD:-emlog}" \
            -d "dbname=${EMLOG_DB_NAME:-emlog}" \
            -d "dbprefix=emlog_" \
            -d "username=admin" \
            -d "email=admin@example.com" \
            -d "password=admin123" \
            -d "repassword=admin123" > /tmp/install_result.html 2>&1

        if grep -q "安装成功" /tmp/install_result.html 2>/dev/null; then
            echo "Emlog installation successful!"
        else
            echo "Emlog installation may have failed, check /tmp/install_result.html"
        fi
    else
        echo "Emlog already installed (found $TABLE_COUNT tables)"
    fi
} &

# Start PHP-FPM
exec php-fpm
