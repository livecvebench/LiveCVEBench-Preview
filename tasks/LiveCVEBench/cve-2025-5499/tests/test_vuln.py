"""
Vulnerability tests for the image resizing service.
These tests verify that dangerous input patterns ARE BLOCKED (fixed state).

In vulnerable state: These tests will FAIL (dangerous patterns are accepted/processed)
In fixed state: These tests will PASS (dangerous patterns are blocked early)

Detection Method:
- We use file:// protocol with a KNOWN EXISTING image (/var/www/html/img/test.jpg)
- Vulnerable version: file:// protocol is processed, returns image/jpeg (actual image)
- Fixed version: file:// protocol is blocked (contains :/), returns image/png (error image)

This detection is reliable because:
- In vulnerable code: is_file('file:///var/www/html/img/test.jpg') returns true
- In fixed code: strpos('file://...', ':/') !== false triggers rejection
"""

import pytest
import requests
import os

BASE_URL = os.environ.get("BASE_URL", "http://localhost:80")

# The key test payload - existing image via file:// protocol
FILE_PROTOCOL_TEST = "file:///var/www/html/img/test.jpg"


class TestPharProtocolBlocked:
    """Tests that PHAR protocol handlers are blocked."""

    def test_basic_phar_protocol(self):
        """Basic phar:// protocol should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png', \
            f"Protocol processed! Got {response.headers.get('content-type')}"

    def test_phar_with_path(self):
        """phar:// with full path should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_phar_with_relative_path(self):
        """phar:// with relative path should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_phar_uppercase(self):
        """PHAR:// (uppercase) should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_phar_mixed_case(self):
        """Phar:// (mixed case) should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestPHPFilterBlocked:
    """Tests that PHP filter protocol is blocked."""

    def test_basic_php_filter(self):
        """php://filter should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_php_filter_base64_encode(self):
        """php://filter with base64-encode should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_php_filter_config_file(self):
        """Attempt to read config file via php://filter should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_php_input(self):
        """php://input should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestOtherProtocolsBlocked:
    """Tests that other dangerous protocol handlers are blocked."""

    def test_data_protocol(self):
        """data:// protocol should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_file_protocol(self):
        """file:// protocol should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'
        assert b"root:" not in response.content

    def test_ftp_protocol(self):
        """ftp:// protocol should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_expect_protocol(self):
        """expect:// protocol should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_zip_protocol(self):
        """zip:// protocol should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestPathTraversalBlocked:
    """Tests that path traversal attempts are blocked."""

    def test_basic_dot_dot_slash(self):
        """Basic ../ path traversal should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_single_dot_slash(self):
        """./ prefix should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_embedded_dot_dot_slash(self):
        """Embedded ../ in path should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_double_dot_slash_variants(self):
        """Multiple ../ variants should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestAbsolutePathsBlocked:
    """Tests that absolute paths are blocked."""

    def test_absolute_path_etc_passwd(self):
        """Absolute path /etc/passwd should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_absolute_path_var_www(self):
        """Absolute path /var/www/html/img/test.jpg should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_absolute_path_root(self):
        """Absolute path / should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestWindowsPathsBlocked:
    """Tests that Windows-style paths are blocked."""

    def test_backslash_prefix(self):
        """Backslash prefix should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_windows_drive_letter(self):
        """Windows drive letter C:\\ should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_windows_drive_forward_slash(self):
        """Windows drive with forward slash C:/ should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_dot_backslash(self):
        """.\\ prefix should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestURLEncodedPayloads:
    """Tests that URL-encoded payloads are handled correctly."""

    def test_url_encoded_dot_dot_slash(self):
        """URL-encoded ../ should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_url_encoded_phar(self):
        """URL-encoded phar:// should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_double_url_encoded(self):
        """Double URL-encoded payloads should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestNullByteInjection:
    """Tests that null byte injection is blocked."""

    def test_null_byte_in_path(self):
        """Null byte injection attempt should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_null_byte_after_protocol(self):
        """Null byte after protocol should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'


class TestMixedAttackPatterns:
    """Tests combining multiple attack patterns."""

    def test_protocol_with_traversal(self):
        """Protocol + path traversal combination should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_encoded_protocol_traversal(self):
        """Encoded protocol + traversal should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'

    def test_filter_chain_attack(self):
        """PHP filter chain attack should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"imgfile": FILE_PROTOCOL_TEST, "format": "jpg"},
            timeout=10
        )
        assert response.headers.get('content-type') == 'image/png'
