"""
Vulnerability tests for the iframe dimension restriction.
These tests verify that the Output::getPurified() method properly restricts
iframe width and height attributes to prevent UI disruption attacks.

- FAIL in vulnerable state (iframe dimensions are preserved)
- PASS in fixed state (iframe dimensions are stripped)
"""

import subprocess
import json
import pytest
import re

TEST_HELPER_PATH = "/tests/test_helper.php"


def call_purifier(html_input: str) -> dict:
    """Call PHP Output::getPurified via subprocess"""
    result = subprocess.run(
        ["php", TEST_HELPER_PATH, html_input],
        capture_output=True,
        text=True,
        cwd="/app",
        timeout=30
    )
    if result.returncode != 0:
        raise RuntimeError(f"PHP script failed: {result.stderr}")
    return json.loads(result.stdout)


def has_iframe_dimension(output: str, attr: str) -> bool:
    """Check if the output contains an iframe with a specific dimension attribute"""
    # Match iframe tag with the specified attribute
    pattern = rf'<iframe[^>]*\b{attr}\s*=\s*["\'][^"\']*["\'][^>]*>'
    return bool(re.search(pattern, output, re.IGNORECASE))


class TestOversizedIframeDimensions:
    """Test that oversized iframe dimensions are blocked"""

    def test_extremely_large_width_stripped(self):
        """Iframe with extremely large width should have width stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test123" width="9999999999"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True, "YouTube iframe should still be present"
        assert not has_iframe_dimension(result["output"], "width"), \
            "Iframe width attribute should be stripped"

    def test_extremely_large_height_stripped(self):
        """Iframe with extremely large height should have height stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test123" height="9999999999"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True, "YouTube iframe should still be present"
        assert not has_iframe_dimension(result["output"], "height"), \
            "Iframe height attribute should be stripped"

    def test_both_large_dimensions_stripped(self):
        """Iframe with both extremely large dimensions should have both stripped"""
        html = '<iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" width="9999999999" height="9999999999"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True, "YouTube iframe should still be present"
        assert not result["has_iframe_width"], "Iframe width attribute should be stripped"
        assert not result["has_iframe_height"], "Iframe height attribute should be stripped"


class TestVariousIframeDimensionValues:
    """Test various dimension values that could be used to disrupt UI"""

    def test_large_pixel_value(self):
        """Large but not extreme pixel values should also be stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test" width="50000" height="50000"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_normal_dimensions_stripped(self):
        """Even normal-looking dimensions should be stripped from iframes (after fix)"""
        html = '<iframe src="https://www.youtube.com/embed/test" width="560" height="315"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        # After fix, ALL iframe dimensions should be forbidden
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_percentage_width_stripped(self):
        """Percentage width values should also be stripped from iframes"""
        html = '<iframe src="https://www.youtube.com/embed/test" width="100%" height="100%"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_mixed_units_stripped(self):
        """Mixed dimension units should be stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test" width="1000px" height="1000em"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]


class TestDifferentVideoSources:
    """Test dimension stripping for different allowed video sources"""

    def test_youtube_nocookie_dimensions_stripped(self):
        """YouTube no-cookie iframe dimensions should be stripped"""
        html = '<iframe src="https://www.youtube-nocookie.com/embed/test" width="9999" height="9999"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert "youtube-nocookie.com" in result["output"]
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_vimeo_dimensions_stripped(self):
        """Vimeo iframe dimensions should be stripped"""
        html = '<iframe src="https://player.vimeo.com/video/123456" width="10000" height="10000"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert "vimeo.com" in result["output"]
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]


class TestEdgeCasesAndBypass:
    """Test edge cases and potential bypass attempts"""

    def test_dimension_with_spaces(self):
        """Dimension attributes with extra spaces should be stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test" width = "9999" height = "9999"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_dimension_single_quotes(self):
        """Dimension attributes with single quotes should be stripped"""
        html = "<iframe src='https://www.youtube.com/embed/test' width='9999' height='9999'></iframe>"
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_dimension_no_quotes(self):
        """Dimension attributes without quotes should be stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test" width=9999 height=9999></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_multiple_iframes_all_stripped(self):
        """Multiple iframes should all have dimensions stripped"""
        html = '''
        <iframe src="https://www.youtube.com/embed/vid1" width="9999" height="9999"></iframe>
        <iframe src="https://www.youtube.com/embed/vid2" width="8888" height="8888"></iframe>
        <iframe src="https://player.vimeo.com/video/123" width="7777" height="7777"></iframe>
        '''
        result = call_purifier(html)
        assert result["success"] is True
        # Check for presence of all iframe sources
        assert "youtube.com/embed/vid1" in result["output"]
        assert "youtube.com/embed/vid2" in result["output"]
        assert "vimeo.com/video/123" in result["output"]
        # No iframe should have width or height
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_mixed_content_with_images_and_iframes(self):
        """Mixed content: images keep dimensions, iframes don't"""
        html = '''
        <p>Check out this image:</p>
        <img src="https://example.com/photo.jpg" width="800" height="600" alt="Photo">
        <p>And this video:</p>
        <iframe src="https://www.youtube.com/embed/test" width="560" height="315"></iframe>
        '''
        result = call_purifier(html)
        assert result["success"] is True
        # Image should keep dimensions
        assert result["has_img_width"] is True
        assert result["has_img_height"] is True
        # Iframe should NOT have dimensions
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]


class TestNegativeAndZeroDimensions:
    """Test negative and zero dimension values"""

    def test_negative_dimensions_stripped(self):
        """Negative dimension values should be stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test" width="-100" height="-100"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]

    def test_zero_dimensions_stripped(self):
        """Zero dimension values should also be stripped"""
        html = '<iframe src="https://www.youtube.com/embed/test" width="0" height="0"></iframe>'
        result = call_purifier(html)
        assert result["success"] is True
        assert result["has_iframe"] is True
        assert not result["has_iframe_width"]
        assert not result["has_iframe_height"]
