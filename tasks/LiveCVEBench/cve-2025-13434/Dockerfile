FROM php:7.4-cli

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Clone the Hush Framework repository at vulnerable version (master)
RUN git clone --depth 1 https://github.com/jameschz/hush.git /app \
    && rm -rf /app/.git

# Copy the vulnerable Util.php to ensure consistent test environment
COPY task-deps/Util.php /app/hush-lib/Hush/Util.php

# Create runtime directories required by the framework
RUN mkdir -p /app/hush-run/run/hush-app/cache \
    /app/hush-run/run/hush-app/log \
    /app/hush-run/run/hush-app/tpl \
    /app/hush-run/sys \
    /app/hush-run/cdn/hush-app \
    /app/hush-run/dat/hush-app

# Copy minimal environment config
COPY task-deps/env.php /app/hush-app/etc/.env.php

# Set proper permissions
RUN chmod -R 755 /app

# Default command - keep container running for testing
CMD ["tail", "-f", "/dev/null"]
