import express from 'express';
import formidable from 'formidable';
import path from 'path';
import fs from 'fs';

const app = express();
const uploadDir = '/app/uploads';

// Ensure upload directory exists
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}

app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

app.post('/upload', async (req, res) => {
  const form = formidable({
    uploadDir: uploadDir,
    keepExtensions: true,
    multiples: true
  });

  try {
    const [fields, files] = await form.parse(req);
    const fileList = Object.values(files).flat().map(f => ({
      newFilename: f.newFilename,
      originalFilename: f.originalFilename,
      mimetype: f.mimetype,
      filepath: f.filepath
    }));
    res.json({ files: fileList });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
