"""
Vulnerability tests for CVE-2025-62382: Export API path traversal.

These tests verify whether the vulnerability is blocked or exploitable.

TEST BEHAVIOR:
- In VULNERABLE state (v0.16.1): Tests should FAIL
  (because the vulnerability allows arbitrary paths, so export succeeds when it shouldn't)
- In FIXED state (v0.16.2): Tests should PASS
  (because the fix rejects arbitrary paths with 400)

The tests expect that malicious paths like /etc/passwd will be REJECTED with HTTP 400.
In the vulnerable version, they are ACCEPTED with HTTP 200, causing the tests to FAIL.

Tests send real HTTP requests to the running FastAPI server.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost:5000/api"


def wait_for_server(timeout=30):
    """Wait for the server to be available."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            requests.get(f"{BASE_URL}/exports", timeout=2)
            return True
        except requests.exceptions.ConnectionError:
            time.sleep(0.5)
    return False


@pytest.fixture(scope="module", autouse=True)
def ensure_server_running():
    """Ensure the server is running before tests."""
    if not wait_for_server():
        pytest.skip("Server not available")


class TestArbitraryFilePathRejection:
    """
    Test that arbitrary file paths outside clips directory are rejected.

    These tests verify the fix is in place. In the vulnerable version,
    these paths are accepted (200), causing test FAILURE.
    """

    def test_etc_passwd_path_rejected(self):
        """
        Test: /etc/passwd should be REJECTED with 400.
        Vulnerable: Returns 200 (FAIL)
        Fixed: Returns 400 (PASS)
        """
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/etc/passwd"
            }
        )

        # This assertion FAILS in vulnerable version (returns 200)
        # and PASSES in fixed version (returns 400)
        assert response.status_code == 400, \
            f"VULNERABLE: /etc/passwd was accepted (status {response.status_code}), should be rejected with 400"

    def test_etc_shadow_path_rejected(self):
        """Test: /etc/shadow should be REJECTED with 400."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/etc/shadow"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: /etc/shadow was accepted (status {response.status_code})"

    def test_config_file_path_rejected(self):
        """Test: /config/frigate.db should be REJECTED with 400."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/config/frigate.db"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: /config/frigate.db was accepted (status {response.status_code})"

    def test_var_log_path_rejected(self):
        """Test: /var/log/messages should be REJECTED with 400."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/var/log/messages"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: /var/log/messages was accepted (status {response.status_code})"

    def test_root_path_rejected(self):
        """Test: /root/.ssh/id_rsa should be REJECTED with 400."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/root/.ssh/id_rsa"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: /root/.ssh/id_rsa was accepted (status {response.status_code})"


class TestPathTraversalRejection:
    """Test that path traversal attempts are blocked."""

    def test_basic_path_traversal_rejected(self):
        """Test: Path with ../ traversal should be REJECTED."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/media/frigate/clips/../../../etc/passwd"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: Path traversal was accepted (status {response.status_code})"

    def test_double_dot_traversal_rejected(self):
        """Test: Double dot traversal should be REJECTED."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/media/frigate/clips/../../passwd"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: Double dot traversal was accepted (status {response.status_code})"


class TestMediaDirectoryBoundary:
    """Test paths near the clips directory boundary."""

    def test_media_frigate_recordings_rejected(self):
        """Test: /media/frigate/recordings (not clips) should be REJECTED."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/media/frigate/recordings/secret.mp4"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: /media/frigate/recordings was accepted (status {response.status_code})"

    def test_exports_directory_rejected(self):
        """Test: /media/frigate/exports should be REJECTED (only clips allowed)."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/media/frigate/exports/video.mp4"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: /media/frigate/exports was accepted (status {response.status_code})"

    def test_tmp_directory_rejected(self):
        """Test: /tmp paths should be REJECTED."""
        response = requests.post(
            f"{BASE_URL}/export/front_door/start/1000.0/end/2000.0",
            json={
                "playback": "realtime",
                "source": "preview",
                "name": "exploit",
                "image_path": "/tmp/malicious_file"
            }
        )

        assert response.status_code == 400, \
            f"VULNERABLE: /tmp path was accepted (status {response.status_code})"
