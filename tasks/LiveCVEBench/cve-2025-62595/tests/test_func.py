"""
Functional tests for Koa.js redirect functionality.
These tests verify that the redirect feature works correctly for legitimate use cases.
Should PASS in both vulnerable and fixed states.
"""
import subprocess
import pytest
import requests
import time
import os
import signal

BASE_URL = os.environ.get('APP_URL', 'http://localhost:3000')


class TestBackRedirectFunctionalBasic:
    """Test basic redirect('back') functionality that should work in all versions."""

    def test_redirect_to_same_origin_absolute_url(self):
        """Same-origin absolute URL referrers should be accepted."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={
                'Host': 'localhost:3000',
                'Referer': 'http://localhost:3000/previous-page'
            },
            allow_redirects=False
        )
        assert response.status_code == 302
        assert response.headers.get('Location') == 'http://localhost:3000/previous-page'

    def test_redirect_to_same_origin_with_path(self):
        """Same-origin referrer with complex path should work."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={
                'Host': 'localhost:3000',
                'Referer': 'http://localhost:3000/users/123/profile?tab=settings'
            },
            allow_redirects=False
        )
        assert response.status_code == 302
        assert 'users/123/profile' in response.headers.get('Location', '')

    def test_redirect_fallback_to_alt_when_no_referrer(self):
        """When no Referer header, should use alt URL (/home)."""
        response = requests.get(
            f"{BASE_URL}/redirect-back-with-alt",
            headers={'Host': 'localhost:3000'},
            allow_redirects=False
        )
        assert response.status_code == 302
        assert response.headers.get('Location') == '/home'

    def test_redirect_fallback_to_root_when_nothing(self):
        """When no Referer and no alt, should redirect to /."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={'Host': 'localhost:3000'},
            allow_redirects=False
        )
        assert response.status_code == 302
        assert response.headers.get('Location') == '/'

    def test_redirect_fallback_with_cross_origin_referrer(self):
        """Cross-origin referrer should cause fallback to / or alt."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={
                'Host': 'localhost:3000',
                'Referer': 'https://external-site.com/page'
            },
            allow_redirects=False
        )
        assert response.status_code == 302
        # Should NOT redirect to external-site.com
        location = response.headers.get('Location', '')
        assert 'external-site.com' not in location
        assert location == '/'


class TestBackRedirectFunctionalAdvanced:
    """Advanced functional tests for redirect behavior."""

    def test_redirect_with_https_referrer_same_origin(self):
        """HTTPS same-origin referrer should work."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={
                'Host': 'localhost:3000',
                'Referer': 'http://localhost:3000/secure-page'
            },
            allow_redirects=False
        )
        assert response.status_code == 302
        assert 'localhost:3000' in response.headers.get('Location', '')

    def test_redirect_with_fragment_in_referrer(self):
        """Referrer with URL fragment should be handled."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={
                'Host': 'localhost:3000',
                'Referer': 'http://localhost:3000/page#section'
            },
            allow_redirects=False
        )
        assert response.status_code == 302
        # Fragment may or may not be preserved, but should be same origin
        location = response.headers.get('Location', '')
        assert 'localhost:3000' in location

    def test_redirect_with_empty_referrer(self):
        """Empty Referer header should cause fallback."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={
                'Host': 'localhost:3000',
                'Referer': ''
            },
            allow_redirects=False
        )
        assert response.status_code == 302
        assert response.headers.get('Location') == '/'

    def test_redirect_preserves_query_parameters(self):
        """Query parameters in referrer should be preserved."""
        response = requests.get(
            f"{BASE_URL}/redirect-back",
            headers={
                'Host': 'localhost:3000',
                'Referer': 'http://localhost:3000/search?q=test&page=2'
            },
            allow_redirects=False
        )
        assert response.status_code == 302
        location = response.headers.get('Location', '')
        assert 'q=test' in location
        assert 'page=2' in location


class TestDirectRedirectFunctionality:
    """Test direct redirect (not 'back') to ensure it still works."""

    def test_direct_redirect_to_path(self):
        """Direct redirect to a path should work."""
        response = requests.get(
            f"{BASE_URL}/redirect-to-login",
            allow_redirects=False
        )
        assert response.status_code == 302
        assert response.headers.get('Location') == '/login'

    def test_direct_redirect_to_external_url(self):
        """Direct redirect to external URL should work."""
        response = requests.get(
            f"{BASE_URL}/redirect-to-google",
            allow_redirects=False
        )
        assert response.status_code == 302
        assert 'google.com' in response.headers.get('Location', '')
