#!/bin/bash

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready..."
max_tries=30
count=0
while ! mysqladmin ping -h"db" -u"root" -p"password" --silent 2>/dev/null; do
    count=$((count + 1))
    if [ $count -gt $max_tries ]; then
        echo "MySQL did not become ready in time"
        exit 1
    fi
    echo "Waiting for MySQL... ($count/$max_tries)"
    sleep 2
done

echo "MySQL is ready!"

# Initialize database if not already done
echo "Checking database..."
if ! mysql -h"db" -u"root" -p"password" -e "USE votesystem; SELECT 1 FROM admin LIMIT 1;" 2>/dev/null; then
    echo "Initializing database..."
    mysql -h"db" -u"root" -p"password" -e "CREATE DATABASE IF NOT EXISTS votesystem;"
    mysql -h"db" -u"root" -p"password" votesystem < /var/www/html/db/votesystem.sql

    # Update admin password to bcrypt hash for Admin@123
    # Generate hash using: php -r "echo password_hash('Admin@123', PASSWORD_DEFAULT);"
    echo "Setting admin password..."
    ADMIN_HASH=$(php -r "echo password_hash('Admin@123', PASSWORD_DEFAULT);")
    mysql -h"db" -u"root" -p"password" votesystem -e "UPDATE admin SET password = '${ADMIN_HASH}' WHERE username = 'harie';"
    echo "Database initialized!"
else
    echo "Database already initialized."
fi

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
