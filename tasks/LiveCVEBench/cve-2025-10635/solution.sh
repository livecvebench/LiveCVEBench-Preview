#!/bin/bash
#
# Solution script for Find Me On WordPress Plugin
# Fixes the SQL injection vulnerability in wp_ajax_find_me_on_delete_network()
#

set -e

PLUGIN_FILE="/var/www/html/wp-content/plugins/find-me-on/find-me-on.php"

echo "[*] Applying fix to Find Me On plugin..."

# Check if the plugin file exists
if [ ! -f "$PLUGIN_FILE" ]; then
    echo "[-] Plugin file not found at $PLUGIN_FILE"
    # Try alternative path
    PLUGIN_FILE="/app/wp-content/plugins/find-me-on/find-me-on.php"
    if [ ! -f "$PLUGIN_FILE" ]; then
        echo "[-] Plugin file not found at alternative path either"
        exit 1
    fi
fi

echo "[*] Found plugin file at: $PLUGIN_FILE"

# Create backup
cp "$PLUGIN_FILE" "${PLUGIN_FILE}.bak"

# Check if already fixed (idempotent check)
if grep -q "intval(\$_POST\['linkId'\])" "$PLUGIN_FILE"; then
    echo "[*] Fix already applied, skipping..."
    exit 0
fi

# Apply the fix using a here-doc with sed
# The vulnerable code block (lines ~333-358):
#
# function wp_ajax_find_me_on_delete_network(){
#     global $wpdb;
#     global $definitions;
#     global $status_message;
#
#     $linkId = $_POST['linkId'];
#     //WPD_print('deleting linkID='. $linkId);
#     $table_name = $wpdb->prefix . "find_me_on";
#     $sql = 'delete from ' .  $table_name . ' where id='.$linkId;
#     $result = $wpdb->query($wpdb->prepare($sql));
#
# Fixed version:
# - Sanitize linkId using intval()
# - Validate that it's a positive integer
# - Use $wpdb->prepare() correctly with %d placeholder

# Create a PHP script to do the fix more reliably than sed
php << 'PHPFIX'
<?php
$file = getenv('PLUGIN_FILE') ?: '/var/www/html/wp-content/plugins/find-me-on/find-me-on.php';
$content = file_get_contents($file);

if ($content === false) {
    echo "[-] Could not read plugin file\n";
    exit(1);
}

// Pattern to match the vulnerable function
$vulnerable_pattern = '/function\s+wp_ajax_find_me_on_delete_network\s*\(\s*\)\s*\{[^}]*\$linkId\s*=\s*\$_POST\s*\[\s*[\'"]linkId[\'"]\s*\]\s*;/s';

if (!preg_match($vulnerable_pattern, $content)) {
    echo "[*] Pattern not found - may already be fixed\n";
    exit(0);
}

// Replace the vulnerable linkId assignment
$content = preg_replace(
    '/(\$linkId\s*=\s*)\$_POST\s*\[\s*[\'"]linkId[\'"]\s*\]\s*;/',
    '$1isset($_POST[\'linkId\']) ? intval($_POST[\'linkId\']) : 0;

			// Validate input - must be positive integer
			if ($linkId <= 0) {
				die(\'Invalid link ID\');
			}',
    $content
);

// Replace the vulnerable SQL construction
// Old: $sql = 'delete from ' .  $table_name . ' where id='.$linkId;
// New: $sql = $wpdb->prepare("DELETE FROM {$table_name} WHERE id = %d", $linkId);
$content = preg_replace(
    '/\$sql\s*=\s*[\'"]delete from[\'"]\s*\.\s*\$table_name\s*\.\s*[\'"]\s*where\s+id=[\'"]\.?\s*\$linkId\s*;?/',
    '$sql = $wpdb->prepare("DELETE FROM {$table_name} WHERE id = %d", $linkId);',
    $content,
    -1,
    $count1
);

// Replace the redundant prepare() call
// Old: $result = $wpdb->query($wpdb->prepare($sql));
// New: $result = $wpdb->query($sql);
$content = preg_replace(
    '/\$result\s*=\s*\$wpdb->query\s*\(\s*\$wpdb->prepare\s*\(\s*\$sql\s*\)\s*\)\s*;/',
    '$result = $wpdb->query($sql);',
    $content,
    -1,
    $count2
);

if (file_put_contents($file, $content) === false) {
    echo "[-] Could not write to plugin file\n";
    exit(1);
}

echo "[+] Fix applied successfully\n";
echo "    - Sanitized linkId input with intval()\n";
echo "    - Added input validation\n";
echo "    - Fixed SQL query to use proper prepare() with placeholder\n";
?>
PHPFIX

# Alternative: If PHP is not available, use sed
if [ $? -ne 0 ]; then
    echo "[*] PHP fix failed, trying sed-based approach..."

    # Replace vulnerable linkId assignment
    sed -i 's/\$linkId = \$_POST\[.linkId.\];/\$linkId = isset(\$_POST['"'"'linkId'"'"']) ? intval(\$_POST['"'"'linkId'"'"']) : 0;\n\t\t\tif (\$linkId <= 0) { die('"'"'Invalid link ID'"'"'); }/' "$PLUGIN_FILE"

    # Replace vulnerable SQL construction
    sed -i "s/\$sql = 'delete from '.*\$table_name.*'where id='.\$linkId;/\$sql = \$wpdb->prepare(\"DELETE FROM {\$table_name} WHERE id = %d\", \$linkId);/" "$PLUGIN_FILE"

    # Fix the redundant prepare call
    sed -i 's/\$result = \$wpdb->query(\$wpdb->prepare(\$sql));/\$result = \$wpdb->query(\$sql);/' "$PLUGIN_FILE"
fi

# Verify the fix was applied
echo "[*] Verifying fix..."
if grep -q "intval(\$_POST\['linkId'\])" "$PLUGIN_FILE" || grep -q 'intval($_POST' "$PLUGIN_FILE"; then
    echo "[+] Input sanitization verified"
else
    echo "[-] Warning: Input sanitization may not have been applied correctly"
fi

if grep -q 'WHERE id = %d' "$PLUGIN_FILE"; then
    echo "[+] Parameterized query verified"
else
    echo "[-] Warning: Parameterized query may not have been applied correctly"
fi

# Restart Apache/PHP-FPM if running (to pick up changes)
# For most WordPress setups, PHP changes are picked up immediately
# But if using opcache, we may need to reset it

# Try to restart common services if they exist
if command -v apache2ctl &> /dev/null; then
    echo "[*] Restarting Apache..."
    apache2ctl graceful 2>/dev/null || true
elif command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
fi

if command -v service &> /dev/null; then
    service php-fpm reload 2>/dev/null || true
    service php7.4-fpm reload 2>/dev/null || true
    service php8.0-fpm reload 2>/dev/null || true
    service php8.1-fpm reload 2>/dev/null || true
    service php8.2-fpm reload 2>/dev/null || true
fi

# Clear opcache if available
php -r "if (function_exists('opcache_reset')) { opcache_reset(); echo '[*] OPcache cleared\n'; }" 2>/dev/null || true

echo "[+] Fix applied successfully!"
echo ""
echo "Changes made:"
echo "1. linkId parameter is now sanitized using intval()"
echo "2. Added validation to reject zero/negative IDs"
echo "3. SQL query now uses \$wpdb->prepare() correctly with %d placeholder"
echo ""
