#!/bin/bash
# Solution script to fix buffer over-read in ArrayBuffer.prototype.slice()
#
# The fix adds a bounds check after the species constructor call to ensure
# the buffer's byte_length is still sufficient for the calculated slice range.

set -e

cd /app/quickjs

# The vulnerable code in js_array_buffer_slice only checks if the buffer
# is detached, but doesn't verify the byte_length after potential side effects
# from the species constructor.
#
# We need to change:
#   if (abuf->detached) {
# To:
#   if (abuf->detached || abuf->byte_length < start + new_len) {
#
# This pattern appears multiple times in quickjs.c, so we need to be specific
# about which instance to fix. The vulnerable check is in js_array_buffer_slice
# function, right after the "must test again because of side effects" comment.

# First, let's verify the vulnerable pattern exists
if ! grep -q "if (abuf->detached) {" quickjs.c; then
    echo "Warning: Pattern 'if (abuf->detached) {' not found - may already be fixed"
fi

# Apply the fix using sed
# The fix targets the specific pattern in js_array_buffer_slice
# We use a context-aware replacement to ensure we hit the right instance

# Method: Replace the pattern in the context of js_array_buffer_slice
# The comment "must test again because of side effects" appears just before
# the check we need to modify

# First try: Use the comment as context (most reliable)
sed -i '/must test again because of side effects/,+5{
    s/if (abuf->detached) {/if (abuf->detached || abuf->byte_length < start + new_len) {/
}' quickjs.c

# Verify the fix was applied
if grep -q "abuf->byte_length < start + new_len" quickjs.c; then
    echo "Fix verified: bounds check added successfully"
else
    # Fallback: Try a simpler approach targeting the specific function
    # Look for the pattern in the js_array_buffer_slice function context
    echo "First method failed, trying fallback..."

    # Create a temporary file with the fix
    awk '
    /static JSValue js_array_buffer_slice/ { in_function=1 }
    in_function && /^}$/ { in_function=0 }
    in_function && /if \(abuf->detached\) \{/ && !already_fixed {
        gsub(/if \(abuf->detached\) \{/, "if (abuf->detached || abuf->byte_length < start + new_len) {")
        already_fixed=1
    }
    { print }
    ' quickjs.c > quickjs.c.tmp && mv quickjs.c.tmp quickjs.c

    if grep -q "abuf->byte_length < start + new_len" quickjs.c; then
        echo "Fallback fix applied successfully"
    else
        echo "Error: Could not apply fix"
        exit 1
    fi
fi

# Rebuild QuickJS
echo "Rebuilding QuickJS..."
make clean
make

echo "Fix applied and QuickJS rebuilt successfully"
