#!/bin/bash
set -e

cd "$(dirname "$0")"

echo "========================================"
echo "CEL Parser Test Suite"
echo "========================================"
echo ""

# Install uv for Python environment management
echo "Setting up Python environment..."
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

echo ""
echo "========================================"
echo "Verifying cel-test binary exists..."
echo "========================================"

if [ ! -f "/app/target/release/cel-test" ]; then
    echo "Building cel-rust..."
    cd /app
    cargo build --release
    cd "$(dirname "$0")"
fi

echo "Binary found at /app/target/release/cel-test"

echo ""
echo "========================================"
echo "Running tests..."
echo "========================================"
echo ""

uv run pytest . -rA -v

echo ""
echo "========================================"
echo "All tests completed!"
echo "========================================"
