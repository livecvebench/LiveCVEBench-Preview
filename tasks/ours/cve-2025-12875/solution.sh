#!/bin/bash
set -e
cd /app

# Apply the fix to validate negative start and length values in ary_fill_exec
# The fix adds input validation after mrb_get_args to reject negative values

ARRAY_C="/app/mrbgems/mruby-array-ext/src/array.c"

# Check if the fix has already been applied (idempotent)
if grep -q "negative start index" "$ARRAY_C" 2>/dev/null; then
    echo "Fix already applied"
    exit 0
fi

# Add validation checks after the mrb_get_args call in ary_fill_exec
# The pattern matches the line: mrb_get_args(mrb, "iio", &start, &length, &obj);
# And adds validation checks immediately after it

sed -i '/mrb_get_args(mrb, "iio", &start, &length, &obj);/a\
\
  if (start < 0) {\
    mrb_raise(mrb, E_ARGUMENT_ERROR, "negative start index");\
  }\
  if (length < 0) {\
    mrb_raise(mrb, E_ARGUMENT_ERROR, "negative length");\
  }' "$ARRAY_C"

# Rebuild mruby to compile the fix
echo "Rebuilding mruby..."
rake clean 2>/dev/null || true
rake

echo "Fix applied and mruby rebuilt successfully"
