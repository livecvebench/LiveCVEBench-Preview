#!/bin/bash
# Database initialization script - runs inside the container
# This imports the WeGIA database schemas

set -e

# MySQL connection options - skip SSL to avoid certificate errors with MariaDB client
MYSQL_OPTS="--skip-ssl -h mysql -u wegiauser -pwegiapass"

echo "Starting database initialization..."

# Wait for MySQL to be available
echo "Waiting for MySQL..."
max_retries=60
counter=0
until mysql $MYSQL_OPTS -e "SELECT 1" &>/dev/null; do
    counter=$((counter+1))
    if [ $counter -gt $max_retries ]; then
        echo "ERROR: MySQL did not become ready in time"
        exit 1
    fi
    echo "Waiting for MySQL... (attempt $counter/$max_retries)"
    sleep 2
done

echo "MySQL is ready. Checking if database needs initialization..."

# Check if the produto table exists (indicates schema is loaded)
if mysql $MYSQL_OPTS wegia -e "SELECT 1 FROM produto LIMIT 1" &>/dev/null; then
    echo "Database already initialized."
else
    echo "Importing database schemas..."

    # Import schema files
    if [ -f /var/www/html/BD/wegia001.sql ]; then
        echo "Importing wegia001.sql..."
        mysql $MYSQL_OPTS wegia < /var/www/html/BD/wegia001.sql || true
    fi

    if [ -f /var/www/html/BD/wegia002.sql ]; then
        echo "Importing wegia002.sql..."
        mysql $MYSQL_OPTS wegia < /var/www/html/BD/wegia002.sql || true
    fi

    # Import test data
    if [ -f /var/www/html/init-db.sql ]; then
        echo "Importing test data..."
        mysql $MYSQL_OPTS wegia < /var/www/html/init-db.sql || true
    fi

    echo "Database initialization complete."
fi
