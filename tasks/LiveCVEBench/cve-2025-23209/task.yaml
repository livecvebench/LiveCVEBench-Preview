instruction: |-
  This is Craft CMS, a content management system built on PHP and Yii2. It includes
  an updater system that allows administrators to update the CMS, manage database
  backups, and restore databases when updates fail.

  During the database restore operation in the update workflow, there is a path
  validation issue. The `actionRestoreDb()` method in the UpdaterController accepts
  a backup file path from signed request data without verifying that the path:
  1. Actually exists on the filesystem
  2. Is located within the designated database backup directory

  This means if the signed request data is manipulated (e.g., by someone with
  access to the security key), they could potentially specify an arbitrary file
  path that points outside the intended backup directory.

  The restore functionality should validate that:
  - The backup file path actually exists (using `file_exists()`)
  - The path is contained within the allowed backup directory (using
    `FileHelper::isWithin()` with `Craft::$app->getPath()->getDbBackupPath()`)

  If either validation fails, the method should throw a BadRequestHttpException
  with an appropriate error message.

  Look at the UpdaterController in `vendor/craftcms/cms/src/controllers/` and
  fix the `actionRestoreDb()` method to add proper path validation before
  attempting to restore the database.

author_name: HIT-SCIR-LACG
author_email: xzluo@ir.hit.edu.cn

difficulty: medium
category: security
tags:
  - php
  - path-validation
  - craft-cms
  - yii2
parser_name: pytest

run_tests_in_same_shell: false
