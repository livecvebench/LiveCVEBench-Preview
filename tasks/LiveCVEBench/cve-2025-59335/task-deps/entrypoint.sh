#!/bin/sh
set -e

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready..."
until mysql -h database -u cubecart -ppassword --ssl=FALSE -e "SELECT 1" > /dev/null 2>&1; do
    echo "MySQL is unavailable - sleeping"
    sleep 2
done
echo "MySQL is ready!"

# Check if global.inc.php exists (installation complete)
if [ ! -f /var/www/html/includes/global.inc.php ]; then
    echo "First run - setting up CubeCart..."

    # Copy the pre-configured global.inc.php
    cp /global.inc.php /var/www/html/includes/global.inc.php
    chown www-data:www-data /var/www/html/includes/global.inc.php
    chmod 644 /var/www/html/includes/global.inc.php

    # Import the initialization SQL
    echo "Importing database schema..."
    mysql -h database -u cubecart -ppassword --ssl=FALSE cubecart < /init.sql

    # Rename setup directory to prevent redirect to setup wizard
    echo "Disabling setup wizard..."
    mv /var/www/html/setup /var/www/html/setup.disabled

    echo "CubeCart setup complete!"
fi

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
