"""
Functional tests for Supplier Management System.
These tests verify that the application works correctly for legitimate use cases.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import random
import string

BASE_URL = "http://localhost/Supply_Management_System"
ADMIN_USERNAME = "admin"
ADMIN_PASSWORD = "admin123"


def get_admin_session():
    """Create and return an authenticated admin session."""
    session = requests.Session()
    login_data = {
        'txtUsername': ADMIN_USERNAME,
        'txtPassword': ADMIN_PASSWORD,
        'login_type': 'admin'
    }
    response = session.post(f"{BASE_URL}/index.php", data=login_data, allow_redirects=False)
    return session


def random_string(length=8):
    """Generate a random alphanumeric string."""
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))


class TestApplicationAvailability:
    """Test that the application is running and accessible."""

    def test_homepage_accessible(self):
        """Test that the login page is accessible."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=10)
        assert response.status_code == 200
        assert "Login" in response.text or "login" in response.text.lower()

    def test_login_form_present(self):
        """Test that login form elements are present."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=10)
        assert response.status_code == 200
        assert "txtUsername" in response.text
        assert "txtPassword" in response.text
        assert "login_type" in response.text


class TestAdminAuthentication:
    """Test admin authentication functionality."""

    def test_admin_login_success(self):
        """Test that admin can log in successfully."""
        session = requests.Session()
        login_data = {
            'txtUsername': ADMIN_USERNAME,
            'txtPassword': ADMIN_PASSWORD,
            'login_type': 'admin'
        }
        response = session.post(f"{BASE_URL}/index.php", data=login_data, allow_redirects=True, timeout=10)
        # After successful login, we should be on admin/index.php or see admin content
        assert response.status_code == 200

    def test_admin_login_invalid_credentials(self):
        """Test that invalid credentials are rejected."""
        session = requests.Session()
        login_data = {
            'txtUsername': 'wronguser',
            'txtPassword': 'wrongpass',
            'login_type': 'admin'
        }
        response = session.post(f"{BASE_URL}/index.php", data=login_data, timeout=10)
        assert response.status_code == 200
        assert "incorrect" in response.text.lower() or "error" in response.text.lower() or "Login" in response.text


class TestAddRetailerPage:
    """Test the Add Retailer page functionality."""

    def test_add_retailer_page_loads(self):
        """Test that the add retailer page loads for authenticated admin."""
        session = get_admin_session()
        response = session.get(f"{BASE_URL}/admin/add_retailer.php", timeout=10)
        assert response.status_code == 200
        assert "Add Retailer" in response.text or "Retailer" in response.text

    def test_add_retailer_form_elements_present(self):
        """Test that the add retailer form has all required elements."""
        session = get_admin_session()
        response = session.get(f"{BASE_URL}/admin/add_retailer.php", timeout=10)
        assert response.status_code == 200
        # Check for form fields
        assert "txtRetailerUname" in response.text
        assert "txtRetailerPassword" in response.text
        assert "cmbAreaCode" in response.text
        assert "txtRetailerPhone" in response.text
        assert "txtRetailerEmail" in response.text

    def test_add_retailer_page_requires_auth(self):
        """Test that the add retailer page requires authentication."""
        session = requests.Session()  # No login
        response = session.get(f"{BASE_URL}/admin/add_retailer.php", allow_redirects=False, timeout=10)
        # Should redirect to login page
        assert response.status_code in [302, 303, 200]
        if response.status_code == 200:
            # If not redirected, check if it's the login page or access is denied
            assert "Login" in response.text or "index.php" in response.text or len(response.text) < 500


class TestValidRetailerAddition:
    """Test adding retailers with valid data."""

    def test_add_retailer_with_valid_data(self):
        """Test that a retailer can be added with valid data."""
        session = get_admin_session()

        # Generate unique test data
        unique_id = random_string(6)
        retailer_data = {
            'txtRetailerUname': f'testuser{unique_id}',
            'txtRetailerPassword': 'testpass123',
            'cmbAreaCode': '1',  # Valid area code (numeric ID)
            'txtRetailerPhone': '9876543210',
            'txtRetailerEmail': f'test{unique_id}@example.com',
            'txtRetailerAddress': 'Test Address 123'
        }

        response = session.post(f"{BASE_URL}/admin/add_retailer.php", data=retailer_data, timeout=10)
        assert response.status_code == 200
        # Response should indicate success or show the form (which includes success message)
        # The page uses JavaScript alert for success message
        assert "Retailer Added Successfully" in response.text or "Add Retailer" in response.text

    def test_add_retailer_response_time_normal(self):
        """Test that adding a retailer with valid data is fast."""
        session = get_admin_session()

        unique_id = random_string(6)
        retailer_data = {
            'txtRetailerUname': f'testtime{unique_id}',
            'txtRetailerPassword': 'testpass123',
            'cmbAreaCode': '1',
            'txtRetailerPhone': '1234567890',
            'txtRetailerEmail': f'testtime{unique_id}@example.com',
            'txtRetailerAddress': 'Test Address'
        }

        start_time = time.time()
        response = session.post(f"{BASE_URL}/admin/add_retailer.php", data=retailer_data, timeout=15)
        elapsed = time.time() - start_time

        assert response.status_code == 200
        # Normal operation should complete quickly (< 3 seconds)
        assert elapsed < 3, f"Request took too long: {elapsed} seconds"


class TestInputValidation:
    """Test input validation for retailer addition."""

    def test_invalid_username_rejected(self):
        """Test that invalid username format is rejected."""
        session = get_admin_session()

        retailer_data = {
            'txtRetailerUname': 'ab',  # Too short
            'txtRetailerPassword': 'testpass123',
            'cmbAreaCode': '1',
            'txtRetailerPhone': '9876543210',
            'txtRetailerEmail': 'test@example.com',
            'txtRetailerAddress': 'Test Address'
        }

        response = session.post(f"{BASE_URL}/admin/add_retailer.php", data=retailer_data, timeout=10)
        assert response.status_code == 200
        # Should show error message or not add successfully
        assert "Invalid" in response.text or "error" in response.text.lower() or "5-14" in response.text or "Add Retailer" in response.text

    def test_invalid_phone_rejected(self):
        """Test that invalid phone format is rejected."""
        session = get_admin_session()

        unique_id = random_string(6)
        retailer_data = {
            'txtRetailerUname': f'testph{unique_id}',
            'txtRetailerPassword': 'testpass123',
            'cmbAreaCode': '1',
            'txtRetailerPhone': '123',  # Invalid - too short
            'txtRetailerEmail': f'testph{unique_id}@example.com',
            'txtRetailerAddress': 'Test Address'
        }

        response = session.post(f"{BASE_URL}/admin/add_retailer.php", data=retailer_data, timeout=10)
        assert response.status_code == 200
        # Should show validation error
        assert "Invalid" in response.text or "Phone" in response.text or "Add Retailer" in response.text

    def test_invalid_email_rejected(self):
        """Test that invalid email format is rejected."""
        session = get_admin_session()

        unique_id = random_string(6)
        retailer_data = {
            'txtRetailerUname': f'testem{unique_id}',
            'txtRetailerPassword': 'testpass123',
            'cmbAreaCode': '1',
            'txtRetailerPhone': '9876543210',
            'txtRetailerEmail': 'invalid-email',  # Invalid format
            'txtRetailerAddress': 'Test Address'
        }

        response = session.post(f"{BASE_URL}/admin/add_retailer.php", data=retailer_data, timeout=10)
        assert response.status_code == 200
        # Should show validation error
        assert "Invalid" in response.text or "Email" in response.text or "Add Retailer" in response.text


class TestMissingRequiredFields:
    """Test that missing required fields are handled properly."""

    def test_missing_username(self):
        """Test that missing username is handled."""
        session = get_admin_session()

        retailer_data = {
            'txtRetailerUname': '',
            'txtRetailerPassword': 'testpass123',
            'cmbAreaCode': '1',
            'txtRetailerPhone': '9876543210',
            'txtRetailerEmail': 'test@example.com',
            'txtRetailerAddress': 'Test Address'
        }

        response = session.post(f"{BASE_URL}/admin/add_retailer.php", data=retailer_data, timeout=10)
        assert response.status_code == 200
        # Should show error or just display the form again
        assert "compulsory" in response.text.lower() or "required" in response.text.lower() or "Add Retailer" in response.text

    def test_missing_password(self):
        """Test that missing password is handled."""
        session = get_admin_session()

        unique_id = random_string(6)
        retailer_data = {
            'txtRetailerUname': f'testnp{unique_id}',
            'txtRetailerPassword': '',
            'cmbAreaCode': '1',
            'txtRetailerPhone': '9876543210',
            'txtRetailerEmail': f'testnp{unique_id}@example.com',
            'txtRetailerAddress': 'Test Address'
        }

        response = session.post(f"{BASE_URL}/admin/add_retailer.php", data=retailer_data, timeout=10)
        assert response.status_code == 200
        # Should show error or display the form
        assert "compulsory" in response.text.lower() or "required" in response.text.lower() or "Add Retailer" in response.text


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
