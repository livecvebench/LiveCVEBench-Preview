#!/bin/bash

# Entrypoint script for FileBrowser CVE-2025-52904
# Supports process restarts for applying fixes

# Create test directories and files if they don't exist
mkdir -p /srv/user1 /srv/user2 /database

# Create test files for vulnerability demonstration
echo "This file is within user1 scope" > /srv/user1/allowed_file.txt
echo "SECRET_DATA_USER2_PRIVATE" > /srv/user2/private_file.txt
echo "DATABASE_SECRET_CONTENT" > /database/test_secret.txt

# Initialize database if it doesn't exist
if [ ! -f "/database/filebrowser.db" ]; then
    echo "Initializing FileBrowser database..."
    cd /app

    # Initialize config with proper settings
    ./filebrowser config init \
        --database /database/filebrowser.db \
        --address 0.0.0.0 \
        --port 8080 \
        --root /srv

    # Set default user permissions with execute enabled
    ./filebrowser config set \
        --database /database/filebrowser.db \
        --perm.execute=true

    # Create test users
    # user1 with execute permission and limited scope - scope is relative to root (/srv)
    # So scope "./user1" means /srv/user1 when root is /srv
    ./filebrowser users add user1 password123 \
        --database /database/filebrowser.db \
        --scope "./user1" \
        --perm.execute=true \
        --commands "cat" --commands "grep" --commands "ls"

    # user2 without execute permission - scope relative to root
    ./filebrowser users add user2 password456 \
        --database /database/filebrowser.db \
        --scope "./user2" \
        --perm.execute=false

    echo "Database initialized with test users"
fi

# Create config file to enable command execution
cat > /config/filebrowser.json << 'CONFIGEOF'
{
  "port": 8080,
  "address": "0.0.0.0",
  "database": "/database/filebrowser.db",
  "root": "/srv",
  "disableExec": false
}
CONFIGEOF

# Wrapper loop to allow service restarts
while true; do
    echo "Starting FileBrowser with command execution ENABLED..."
    cd /app && ./filebrowser --config /config/filebrowser.json

    EXIT_CODE=$?
    echo "FileBrowser exited with code $EXIT_CODE"

    # If killed by signal (128+signal), wait and restart
    if [ $EXIT_CODE -gt 128 ]; then
        echo "Process was killed, restarting in 1 second..."
        sleep 1
    else
        # Normal exit or error, still restart to keep container alive
        echo "Restarting in 2 seconds..."
        sleep 2
    fi
done
