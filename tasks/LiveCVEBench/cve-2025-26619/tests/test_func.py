"""
Functionality tests for Vega getScale function.
These tests verify that normal scale lookup functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""
import subprocess
import pytest
import os

# Path to the test helper script
TEST_HELPER_DIR = "/tests"

class TestScaleFunctionality:
    """Test that the getScale function works correctly for valid scale lookups."""

    def test_getscale_returns_undefined_for_nonexistent_scale(self):
        """Test that getScale returns undefined when looking up a non-existent scale name."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_getscale_func.js", "nonexistent_scale"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for nonexistent scale" in result.stdout, \
            f"Expected undefined for nonexistent scale. Output: {result.stdout}"

    def test_getscale_returns_undefined_for_empty_string(self):
        """Test that getScale returns undefined for an empty string scale name."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_getscale_func.js", "empty_string"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for empty string" in result.stdout, \
            f"Expected undefined for empty string. Output: {result.stdout}"

    def test_getscale_returns_undefined_for_null(self):
        """Test that getScale returns undefined when null is passed."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_getscale_func.js", "null_value"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for null" in result.stdout, \
            f"Expected undefined for null. Output: {result.stdout}"

    def test_getscale_returns_undefined_for_number(self):
        """Test that getScale returns undefined when a number is passed."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_getscale_func.js", "number_value"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for number" in result.stdout, \
            f"Expected undefined for number. Output: {result.stdout}"

    def test_getscale_returns_undefined_for_object(self):
        """Test that getScale returns undefined when an object is passed."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_getscale_func.js", "object_value"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for object" in result.stdout, \
            f"Expected undefined for object. Output: {result.stdout}"

    def test_getscale_returns_undefined_for_array(self):
        """Test that getScale returns undefined when an array is passed."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_getscale_func.js", "array_value"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Test script failed: {result.stderr}"
        assert "PASS: undefined for array" in result.stdout, \
            f"Expected undefined for array. Output: {result.stdout}"


class TestScaleIntegration:
    """Integration tests to verify the scale module loads and exports correctly."""

    def test_scales_module_exports_getscale(self):
        """Test that the scales module exports the getScale function."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_module_exports.js"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Module test failed: {result.stderr}"
        assert "PASS: getScale is exported" in result.stdout, \
            f"getScale should be exported. Output: {result.stdout}"

    def test_scales_module_exports_internalscalefunctions(self):
        """Test that the scales module exports the internalScaleFunctions function."""
        result = subprocess.run(
            ["node", f"{TEST_HELPER_DIR}/test_module_exports.js"],
            capture_output=True,
            text=True,
            cwd="/app"
        )
        assert result.returncode == 0, f"Module test failed: {result.stderr}"
        assert "PASS: internalScaleFunctions is exported" in result.stdout, \
            f"internalScaleFunctions should be exported. Output: {result.stdout}"
