FROM oven/bun:1.1

WORKDIR /app

# Install required system packages (curl for healthcheck, tmux and asciinema as required)
# Also install python3-pip and test dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    tmux \
    asciinema \
    procps \
    python3-pip \
    gcc g++ wget git \
    && rm -rf /var/lib/apt/lists/* \
    && pip3 install pytest requests --break-system-packages || pip3 install pytest requests

# Copy package files
COPY task-deps/package.json ./

# Install dependencies (gets vulnerable elysia@1.4.17)
RUN bun install

# Copy application code
COPY task-deps/app.ts ./

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV COOKIE_SECRET=default-secret

# Expose port
EXPOSE 3000

# Start the application with restart loop
# CMD ["/entrypoint.sh"]
