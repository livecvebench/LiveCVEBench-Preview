"""
Functional tests for Assimp BVH loader.
These tests verify that the BVH loader works correctly for valid files.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import sys
import pytest

# Paths in the container
APP_DIR = "/app"
VALID_BVH = "/app/task-deps/valid_example.bvh"
TEST_PROGRAM = "/app/build/bin/assimpd"


def run_assimp_info(bvh_file: str, timeout: int = 30) -> subprocess.CompletedProcess:
    """Run assimp info command on a BVH file."""
    cmd = [TEST_PROGRAM, "info", bvh_file]
    return subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        timeout=timeout,
        cwd=APP_DIR,
        env={**os.environ, "ASAN_OPTIONS": "detect_leaks=0"}
    )


def run_assimp_export(bvh_file: str, output_file: str, timeout: int = 30) -> subprocess.CompletedProcess:
    """Run assimp export command to convert BVH to another format."""
    cmd = [TEST_PROGRAM, "export", bvh_file, output_file]
    return subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        timeout=timeout,
        cwd=APP_DIR,
        env={**os.environ, "ASAN_OPTIONS": "detect_leaks=0"}
    )


class TestBVHLoaderFunctionality:
    """Tests for basic BVH loading functionality."""

    def test_valid_bvh_loads_successfully(self):
        """Test that a valid BVH file loads without errors."""
        result = run_assimp_info(VALID_BVH)

        # Should not crash or have ASAN errors
        assert "AddressSanitizer" not in result.stderr, \
            f"ASAN error detected: {result.stderr}"
        assert result.returncode == 0 or "Nodes:" in result.stdout, \
            f"Failed to load valid BVH. stdout: {result.stdout}, stderr: {result.stderr}"

    def test_valid_bvh_has_hierarchy(self):
        """Test that the BVH hierarchy is correctly parsed."""
        result = run_assimp_info(VALID_BVH)

        # Should recognize it as a valid scene with nodes
        output = result.stdout + result.stderr
        # The assimp info command should show some node information
        assert result.returncode == 0 or "Node" in output or "Animation" in output, \
            f"BVH should contain hierarchy information. Output: {output}"

    def test_valid_bvh_has_animation_data(self):
        """Test that animation data is loaded from BVH."""
        result = run_assimp_info(VALID_BVH)

        output = result.stdout + result.stderr
        # BVH files contain animation data, should be recognized
        # Even if parsing has warnings, we shouldn't crash
        assert "AddressSanitizer" not in result.stderr, \
            f"ASAN error during animation parsing: {result.stderr}"


class TestBVHLoaderEdgeCases:
    """Tests for edge cases in BVH loading."""

    def test_nonexistent_file_handled_gracefully(self):
        """Test that non-existent file is handled without crash."""
        result = run_assimp_info("/nonexistent/file.bvh")

        # Should return error, not crash with ASAN
        assert "AddressSanitizer" not in result.stderr, \
            "ASAN error on non-existent file"
        # Non-zero return code is expected for missing file
        assert result.returncode != 0 or "error" in result.stderr.lower() or "error" in result.stdout.lower()

    def test_empty_file_handled_gracefully(self):
        """Test that an empty file is handled without crash."""
        empty_file = "/tmp/empty.bvh"

        # Create empty file
        with open(empty_file, 'w') as f:
            pass

        try:
            result = run_assimp_info(empty_file)

            # Should handle gracefully without ASAN errors
            assert "AddressSanitizer" not in result.stderr, \
                "ASAN error on empty file"
        finally:
            if os.path.exists(empty_file):
                os.remove(empty_file)

    def test_minimal_bvh_structure(self):
        """Test loading a minimal valid BVH structure."""
        minimal_bvh = "/tmp/minimal.bvh"

        # Create minimal valid BVH
        content = """HIERARCHY
ROOT Root
{
    OFFSET 0.0 0.0 0.0
    CHANNELS 3 Xposition Yposition Zposition
    End Site
    {
        OFFSET 0.0 1.0 0.0
    }
}
MOTION
Frames: 1
Frame Time: 0.033333
0.0 0.0 0.0
"""
        with open(minimal_bvh, 'w') as f:
            f.write(content)

        try:
            result = run_assimp_info(minimal_bvh)

            # Should load without ASAN errors
            assert "AddressSanitizer" not in result.stderr, \
                f"ASAN error on minimal BVH: {result.stderr}"
        finally:
            if os.path.exists(minimal_bvh):
                os.remove(minimal_bvh)


class TestBVHLoaderMultipleJoints:
    """Tests for BVH files with multiple joints."""

    def test_multiple_joint_hierarchy(self):
        """Test loading BVH with multiple nested joints."""
        multi_joint_bvh = "/tmp/multi_joint.bvh"

        content = """HIERARCHY
ROOT Hips
{
    OFFSET 0.0 0.0 0.0
    CHANNELS 6 Xposition Yposition Zposition Zrotation Xrotation Yrotation
    JOINT Spine
    {
        OFFSET 0.0 5.0 0.0
        CHANNELS 3 Zrotation Xrotation Yrotation
        JOINT Spine1
        {
            OFFSET 0.0 5.0 0.0
            CHANNELS 3 Zrotation Xrotation Yrotation
            JOINT Spine2
            {
                OFFSET 0.0 5.0 0.0
                CHANNELS 3 Zrotation Xrotation Yrotation
                End Site
                {
                    OFFSET 0.0 5.0 0.0
                }
            }
        }
    }
    JOINT LeftLeg
    {
        OFFSET 5.0 0.0 0.0
        CHANNELS 3 Zrotation Xrotation Yrotation
        End Site
        {
            OFFSET 0.0 -10.0 0.0
        }
    }
    JOINT RightLeg
    {
        OFFSET -5.0 0.0 0.0
        CHANNELS 3 Zrotation Xrotation Yrotation
        End Site
        {
            OFFSET 0.0 -10.0 0.0
        }
    }
}
MOTION
Frames: 2
Frame Time: 0.033333
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
0.0 1.0 0.0 5.0 0.0 0.0 10.0 0.0 0.0 5.0 0.0 0.0 0.0 0.0 0.0 15.0 0.0 0.0 -15.0 0.0 0.0
"""
        with open(multi_joint_bvh, 'w') as f:
            f.write(content)

        try:
            result = run_assimp_info(multi_joint_bvh)

            # Should load without ASAN errors
            assert "AddressSanitizer" not in result.stderr, \
                f"ASAN error on multi-joint BVH: {result.stderr}"
            # Should not crash
            assert "SEGV" not in result.stderr and "segmentation" not in result.stderr.lower()
        finally:
            if os.path.exists(multi_joint_bvh):
                os.remove(multi_joint_bvh)


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-rA"])
