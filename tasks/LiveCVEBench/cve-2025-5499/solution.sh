#!/bin/bash
# solution.sh - Apply fix for path validation vulnerability in image_resized.php
set -e

FILE="/app/image_resized.php"

# Check if file exists
if [ ! -f "$FILE" ]; then
    # Try alternate location
    FILE="/var/www/html/image_resized.php"
    if [ ! -f "$FILE" ]; then
        echo "Error: image_resized.php not found in /app or /var/www/html"
        exit 1
    fi
fi

echo "Applying fix to: $FILE"

# Use PHP to apply the fix reliably
php << 'EOPHP'
<?php
$file = getenv('FILE') ?: '/app/image_resized.php';
if (!file_exists($file)) {
    $file = '/var/www/html/image_resized.php';
}

$content = file_get_contents($file);
if ($content === false) {
    echo "Error: Could not read $file\n";
    exit(1);
}

// Check if already fixed (contains strpos check for :/)
if (strpos($content, "strpos(\$img_file, ':/') !== false") !== false) {
    echo "File appears to already be fixed.\n";
    exit(0);
}

// Find and replace the vulnerable str_replace line
// Pattern: $img_file = str_replace(array('http://', 'https://'), '', $img_file);
$pattern = '/\$img_file\s*=\s*str_replace\s*\(\s*array\s*\(\s*[\'"]http:\/\/[\'"]\s*,\s*[\'"]https:\/\/[\'"]\s*\)\s*,\s*[\'"][\'"],\s*\$img_file\s*\)\s*;/';

$replacement = <<<'EOT'
// Ensure no protocol handlers (http://...) or something like C:\ or C:/ or ./ or ../ is part of the file name
if (
    $img_file
    &&
    (
        $img_file[0] === '.'
        ||
        $img_file[0] === '/'
        ||
        $img_file[0] === '\\\\'
        ||
        strpos($img_file, ':/') !== false
        ||
        strpos($img_file, './') !== false
        ||
        strpos($img_file, ':\\\\') !== false
        ||
        strpos($img_file, '.\\\\') !== false
    )
) {
    $img_file = '';
} else {
    // Absolute path only related to the current directory
    $img_file = __DIR__ . '/' . $img_file;
}
EOT;

$newContent = preg_replace($pattern, $replacement, $content, 1, $count);

if ($count === 0) {
    // Try a more lenient pattern
    $pattern2 = '/\$img_file\s*=\s*str_replace\s*\([^;]+\$img_file\s*\)\s*;/';
    $newContent = preg_replace($pattern2, $replacement, $content, 1, $count);
}

if ($count === 0) {
    echo "Warning: Could not find the vulnerable str_replace pattern.\n";
    echo "Attempting line-based replacement...\n";

    // Fall back to line-by-line replacement
    $lines = explode("\n", $content);
    $found = false;
    $newLines = [];

    foreach ($lines as $line) {
        if (strpos($line, 'str_replace') !== false &&
            strpos($line, 'http://') !== false &&
            strpos($line, 'img_file') !== false) {
            // Replace this line with the fix
            $newLines[] = $replacement;
            $found = true;
        } else {
            $newLines[] = $line;
        }
    }

    if ($found) {
        $newContent = implode("\n", $newLines);
        $count = 1;
    }
}

if ($count > 0) {
    // Also update the is_file check if present
    // Change: if(is_file($img_file) && $img_info = getimagesize($img_file)) {
    // To: if ($img_file !== '' && is_readable($img_file) && $img_info = getimagesize($img_file)) {
    $newContent = preg_replace(
        '/if\s*\(\s*is_file\s*\(\s*\$img_file\s*\)\s*&&\s*\$img_info\s*=\s*getimagesize\s*\(\s*\$img_file\s*\)\s*\)/',
        'if ($img_file !== \'\' && is_readable($img_file) && $img_info = getimagesize($img_file))',
        $newContent
    );

    if (file_put_contents($file, $newContent) !== false) {
        echo "Fix applied successfully to $file\n";
        exit(0);
    } else {
        echo "Error: Could not write to $file\n";
        exit(1);
    }
} else {
    echo "Error: Could not apply fix - pattern not found\n";
    exit(1);
}
?>
EOPHP

# Verify the fix was applied
if grep -q "strpos.*':/'.*!== false" "$FILE"; then
    echo "Fix verification: SUCCESS"
else
    echo "Fix verification: WARNING - fix pattern not found in file"
fi

# Restart Apache/PHP-FPM if running (for the changes to take effect)
# PHP files don't need restart for Apache mod_php, but we try anyway
if pgrep apache2 > /dev/null 2>&1; then
    echo "Restarting Apache..."
    apache2ctl graceful 2>/dev/null || true
fi

if pgrep php-fpm > /dev/null 2>&1; then
    echo "Reloading PHP-FPM..."
    pkill -USR2 php-fpm 2>/dev/null || true
fi

echo "Fix applied successfully!"
