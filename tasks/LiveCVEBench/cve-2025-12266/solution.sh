#!/bin/bash
# Solution script for ThinkPHP namespace injection vulnerability (CVE-2025-12266)
# This vulnerability allows attackers to invoke arbitrary PHP functions by manipulating
# the controller namespace path via the 's' parameter.
# Fix: Add controller name validation in App.php to reject namespace injection attempts.

set -e

cd /app

echo "Applying framework-level fix to App.php..."

# The vulnerable file is in the ThinkPHP library
APP_FILE="/app/thinkphp/library/think/App.php"

if [ ! -f "$APP_FILE" ]; then
    echo "Error: App.php not found at $APP_FILE"
    exit 1
fi

# Create a backup
cp "$APP_FILE" "${APP_FILE}.bak"

# Check if the fix is already applied
if grep -q "SECURITY FIX: Reject namespace injection" "$APP_FILE"; then
    echo "Framework fix already applied."
else
    # The vulnerability is in the module() function where controller name is parsed from URL.
    # An attacker can inject a namespace like \think\app to invoke framework classes directly.
    #
    # Fix: After getting the controller name, validate it contains only alphanumeric
    # characters and underscores (no backslashes for namespace traversal).
    #
    # We need to add validation right after:
    #   $controller = strip_tags($result[1] ?: $config['default_controller']);
    #   $controller = $convert ? strtolower($controller) : $controller;

    # Use Python for reliable multi-line text replacement
    python3 << 'PYTHON_SCRIPT'
import re

app_file = '/app/thinkphp/library/think/App.php'

with open(app_file, 'r') as f:
    content = f.read()

# Find the pattern where controller is assigned and add validation
# We look for the two lines that process the controller name
old_pattern = r"(\s*// 获取控制器名\s*\n\s*\$controller = strip_tags\(\$result\[1\] \?: \$config\['default_controller'\]\);\s*\n\s*\$controller = \$convert \? strtolower\(\$controller\) : \$controller;)"

replacement = r'''\1

        // SECURITY FIX: Reject namespace injection attempts (CVE-2025-12266)
        // Controller names must only contain alphanumeric characters and underscores
        // Backslashes would allow accessing framework classes like \think\app
        if (!preg_match('/^[A-Za-z][A-Za-z0-9_]*$/', $controller)) {
            throw new HttpException(404, 'controller not exists:' . $controller);
        }'''

new_content = re.sub(old_pattern, replacement, content)

if new_content == content:
    print("Warning: Pattern not found, trying alternative approach...")
    # Alternative: insert after the second $controller assignment line
    old_pattern2 = r"(\$controller = \$convert \? strtolower\(\$controller\) : \$controller;)"
    replacement2 = r'''\1

        // SECURITY FIX: Reject namespace injection attempts (CVE-2025-12266)
        // Controller names must only contain alphanumeric characters and underscores
        // Backslashes would allow accessing framework classes like \think\app
        if (!preg_match('/^[A-Za-z][A-Za-z0-9_]*$/', $controller)) {
            throw new HttpException(404, 'controller not exists:' . $controller);
        }'''
    new_content = re.sub(old_pattern2, replacement2, content, count=1)

if new_content != content:
    with open(app_file, 'w') as f:
        f.write(new_content)
    print("App.php patched successfully!")
else:
    print("Error: Could not find pattern to patch")
    exit(1)
PYTHON_SCRIPT

fi

# Verify the patch was applied
if grep -q "SECURITY FIX: Reject namespace injection" "$APP_FILE"; then
    echo "Verification: App.php fix confirmed."
else
    echo "Error: Fix verification failed!"
    exit 1
fi

# Clear any cached routes or configuration
rm -rf /app/runtime/cache/*
rm -rf /app/runtime/temp/*

echo "Fix applied successfully!"
