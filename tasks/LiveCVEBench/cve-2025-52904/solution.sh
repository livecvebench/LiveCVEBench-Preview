#!/bin/bash
set -e

# Fix for CVE-2025-52904: Command Execution Scope Bypass
# The vulnerability allows users to execute commands that access files outside their scope.
# The official fix changes the default of --disable-exec from false to true.
#
# Since the runtime container doesn't have Go to rebuild, we apply the fix by:
# 1. Modifying the config file to disable command execution (using hyphen format for Viper)
# 2. Restarting the service to apply the change

cd /app

# Update the config file to disable command execution
# Viper uses kebab-case (disable-exec) for config keys, not camelCase
# We replace the entire config file to ensure correct format
echo "Updating config file to disable command execution..."

cat > /config/filebrowser.json << 'EOF'
{
  "port": 8080,
  "address": "0.0.0.0",
  "database": "/database/filebrowser.db",
  "root": "/srv",
  "disable-exec": true
}
EOF

echo "Config file updated with disable-exec: true"

# Restart the service (kill existing process so entrypoint can restart it)
pkill -f "filebrowser" || true
sleep 2

echo "Fix applied successfully - command execution is now disabled"
