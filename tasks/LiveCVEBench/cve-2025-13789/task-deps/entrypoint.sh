#!/bin/bash

# Entrypoint script for ZenTao PMS container
# This script starts zbox services and keeps the container running

set -e

echo "=========================================="
echo "ZenTao PMS Container Starting"
echo "=========================================="

# Start zbox services
echo "Starting ZenTao services..."
/opt/zbox/zbox start

# Wait for MySQL to be ready
echo "Waiting for MySQL to be ready..."
for i in {1..30}; do
    if /opt/zbox/run/mysql/mysql -u root -p123456 zentao -e "SELECT 1" &>/dev/null; then
        echo "MySQL is ready."
        break
    fi
    sleep 1
done

# Disable weak password change requirement for testing
# This allows automated testing to work without being forced to change password
echo "Configuring ZenTao for testing environment..."
/opt/zbox/run/mysql/mysql -u root -p123456 zentao -e "UPDATE zt_config SET value='0' WHERE \`key\`='changeWeak'" 2>/dev/null || true

echo "=========================================="
echo "ZenTao PMS is running"
echo "Web Interface: http://localhost/zentao/"
echo "Default credentials: admin / 123456"
echo "=========================================="

# Keep container running and monitor services
while true; do
    # Check if services are running
    status=$(/opt/zbox/zbox status 2>&1) || true

    if ! echo "$status" | grep -q "Apache.*running"; then
        echo "Apache stopped. Restarting services..."
        /opt/zbox/zbox start || true
    fi

    sleep 30
done
