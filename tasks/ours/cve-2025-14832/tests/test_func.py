"""
Functional tests for the Online Cake Ordering System product update feature.
These tests verify that the application works correctly for normal operations.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:80")
CAKESHOP_URL = f"{BASE_URL}/cakeshop"


class TestProductUpdateFunctionality:
    """Test that the product update page functions correctly."""

    def test_valid_product_retrieval_1001(self):
        """Test retrieving product with code 1001 (Caramel Cake)."""
        response = requests.get(
            f"{CAKESHOP_URL}/updateproduct.php",
            params={"action": "edit", "id": "1001"},
            timeout=10
        )
        # Page should load successfully
        assert response.status_code == 200
        # Should contain the product name "Caramel Cake"
        assert "Caramel Cake" in response.text

    def test_valid_product_retrieval_1002(self):
        """Test retrieving product with code 1002 (Chocolate cake)."""
        response = requests.get(
            f"{CAKESHOP_URL}/updateproduct.php",
            params={"action": "edit", "id": "1002"},
            timeout=10
        )
        assert response.status_code == 200
        assert "Chocolate cake" in response.text

    def test_valid_product_retrieval_1003(self):
        """Test retrieving product with code 1003 (Banana Cake)."""
        response = requests.get(
            f"{CAKESHOP_URL}/updateproduct.php",
            params={"action": "edit", "id": "1003"},
            timeout=10
        )
        assert response.status_code == 200
        assert "Banana Cake" in response.text

    def test_page_contains_update_form(self):
        """Test that the page contains the product update form."""
        response = requests.get(
            f"{CAKESHOP_URL}/updateproduct.php",
            params={"action": "edit", "id": "1001"},
            timeout=10
        )
        assert response.status_code == 200
        # Check for form elements
        assert "Update Product" in response.text
        assert 'name="Productname"' in response.text
        assert 'name="Price"' in response.text
        assert 'name="Markup"' in response.text
        assert 'name="Selling"' in response.text

    def test_product_form_has_correct_values(self):
        """Test that form fields contain correct product data."""
        response = requests.get(
            f"{CAKESHOP_URL}/updateproduct.php",
            params={"action": "edit", "id": "1001"},
            timeout=10
        )
        assert response.status_code == 200
        # Caramel Cake has price=300, profit=100, selling_price=400
        assert 'value="Caramel Cake"' in response.text or "Caramel Cake" in response.text
        assert 'value="300"' in response.text  # price
        assert 'value="100"' in response.text  # profit/markup
        assert 'value="400"' in response.text  # selling price

    def test_invalid_product_id_no_crash(self):
        """Test that accessing with non-existent product ID doesn't crash."""
        response = requests.get(
            f"{CAKESHOP_URL}/updateproduct.php",
            params={"action": "edit", "id": "99999"},
            timeout=10
        )
        # Page should still load (may have empty fields, but no crash)
        assert response.status_code == 200
        assert "Update Product" in response.text

    def test_multiple_products_retrievable(self):
        """Test that multiple different products can be retrieved."""
        products = [
            ("1001", "Caramel Cake"),
            ("1002", "Chocolate cake"),
            ("1004", "Strawberry Cake"),
            ("1005", "Vanilla Cake"),
        ]
        for product_code, product_name in products:
            response = requests.get(
                f"{CAKESHOP_URL}/updateproduct.php",
                params={"action": "edit", "id": product_code},
                timeout=10
            )
            assert response.status_code == 200, f"Failed for product {product_code}"
            assert product_name in response.text, f"Product {product_name} not found"


class TestApplicationAccessibility:
    """Test that the application is running and accessible."""

    def test_homepage_accessible(self):
        """Test that the homepage is accessible."""
        response = requests.get(f"{CAKESHOP_URL}/index.php", timeout=10)
        assert response.status_code == 200

    def test_login_page_accessible(self):
        """Test that the login page is accessible."""
        response = requests.get(f"{CAKESHOP_URL}/login.php", timeout=10)
        assert response.status_code == 200
        assert "login" in response.text.lower() or "sign in" in response.text.lower()

    def test_product_page_accessible(self):
        """Test that the product page is accessible."""
        response = requests.get(f"{CAKESHOP_URL}/product.php", timeout=10)
        # May redirect to login, but should not error
        assert response.status_code in [200, 302]
