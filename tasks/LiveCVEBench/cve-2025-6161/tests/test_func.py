"""
Functionality tests for the Simple Food Ordering System.
These tests verify that the application works correctly.
They should PASS in both vulnerable and fixed states.
"""

import requests
import time

BASE_URL = "http://localhost"


class TestApplicationAvailability:
    """Test that the application and its components are accessible."""

    def test_app_homepage_responds(self):
        """Test that application home page loads successfully."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=10)
        assert response.status_code == 200
        assert len(response.content) > 0

    def test_product_page_responds(self):
        """Test that product management page loads."""
        response = requests.get(f"{BASE_URL}/product.php", timeout=10)
        assert response.status_code == 200

    def test_edit_product_endpoint_accessible(self):
        """Test that editproduct.php endpoint exists and responds."""
        # GET request to the endpoint - may return error without POST data but should not 404
        response = requests.get(f"{BASE_URL}/editproduct.php?product=14", timeout=10)
        # Should not be 404 - endpoint should exist
        assert response.status_code != 404


class TestDatabaseConnectivity:
    """Test database connectivity and data retrieval."""

    def test_products_displayed_on_homepage(self):
        """Test that products are loaded from database and displayed."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=10)
        assert response.status_code == 200
        # Should contain product data - category names or product names
        content = response.text.lower()
        # Check for some expected content from the database
        assert any(keyword in content for keyword in [
            "breakfast", "lunch", "dinner", "beverages",
            "pancake", "egg", "spaghetti", "mojito", "coca-cola"
        ])

    def test_product_list_has_items(self):
        """Test that product page shows products."""
        response = requests.get(f"{BASE_URL}/product.php", timeout=10)
        assert response.status_code == 200
        # Should have some product-related content
        assert len(response.content) > 500  # Page should have meaningful content


class TestUploadDirectory:
    """Test that upload directory is properly configured."""

    def test_upload_directory_exists(self):
        """Test that upload directory is accessible (may have directory listing disabled)."""
        response = requests.get(f"{BASE_URL}/upload/", timeout=10)
        # Either 200 (listing enabled) or 403 (listing disabled) is acceptable
        # 404 would mean the directory doesn't exist
        assert response.status_code in [200, 403]

    def test_existing_upload_accessible(self):
        """Test that existing uploaded files can be served."""
        # Try to access a known uploaded image from the database seed
        # Based on foodsys.sql, there are existing images
        response = requests.get(f"{BASE_URL}/upload/", timeout=10)
        # Just verify the upload path is valid - actual files may or may not exist
        assert response.status_code != 404


class TestFormSubmission:
    """Test that form submissions work correctly."""

    def test_editproduct_accepts_post(self):
        """Test that editproduct.php accepts POST requests."""
        url = f"{BASE_URL}/editproduct.php?product=14"
        data = {
            'pname': 'Test Product',
            'category': '4',
            'price': '100'
        }
        # Submit without file - should redirect (302/303) to product.php
        response = requests.post(url, data=data, allow_redirects=False, timeout=10)
        # Should get a redirect response
        assert response.status_code in [200, 302, 303]

    def test_product_update_without_photo(self):
        """Test updating product without changing the photo."""
        url = f"{BASE_URL}/editproduct.php?product=15"
        data = {
            'pname': 'Egg Baked In Tomatoes',
            'category': '4',
            'price': '310'
        }
        response = requests.post(url, data=data, allow_redirects=False, timeout=10)
        # Should succeed (redirect or success)
        assert response.status_code in [200, 302, 303]
