#!/bin/bash
set -e

cd /app

SERVER_SCRIPT="scripts/server.js"

echo "Applying path validation fix to ${SERVER_SCRIPT}..."

cat > "${SERVER_SCRIPT}" << 'EOF'
/* jshint globalstrict:true, node:true */
'use strict';

var http = require('http'),
  url = require('url'),
  path = require('path'),
  fs = require('fs'),
  domain = require('domain').create();

var mimeTypes = {
  html: 'text/html',
  json: 'application/json',
  js: 'text/javascript',
  css: 'text/css',
};

http
  .createServer(function (req, res) {
    var uri = url.parse(req.url).pathname,
      filename;

    if (uri === '/test/') {
      uri = '/test/index.html';
    }

    try {
      const requestedPath = path.join(process.cwd(), uri);
      const resolvedPath = path.resolve(requestedPath);
      
      if (!resolvedPath.startsWith(process.cwd() + path.sep) && resolvedPath !== process.cwd()) {
        res.writeHead(403, { 'Content-Type': 'text/plain' });
        res.end('403 Forbidden\n');
        return;
      }
      filename = resolvedPath;
      if (!fs.existsSync(filename) || !fs.statSync(filename).isFile()) {
        throw new Error("File not found or not a file");
      }
    } catch (err) {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      res.end('404 Not Found\n');
      return;
    }

    domain.on('error', function () {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      res.end('404 Not Found\n');
    });
    domain.run(function () {
      var mimeType =
        mimeTypes[path.extname(filename).split('.')[1]] || 'text/plain';
      res.writeHead(200, { 'Content-Type': mimeType });
      fs.createReadStream(filename).pipe(res);
    });
  })
  .listen(8000);
console.log(
  'Test server is running on \x1B[1m\x1B[32mhttp://localhost:8000/test/\x1B[39m, press Ctrl-C to stop.'
);
EOF

echo "Fix applied successfully."
echo "Restarting Node.js server..."

echo "Stopping old server (SIGKILL)..."
fuser -k -9 8000/tcp 2>/dev/null || true

echo "Waiting for port 8000 to be released..."
MAX_WAIT=15
for i in $(seq 1 $MAX_WAIT); do
    if ! fuser 8000/tcp > /dev/null 2>&1; then
        echo "Port 8000 is now free after ${i}s."
        break
    fi
    if [ "$i" -eq "$MAX_WAIT" ]; then
        echo "Warning: Port 8000 still in use after ${MAX_WAIT}s. Forcing again..."
        fuser -k -9 8000/tcp 2>/dev/null || true
        sleep 2
    fi
    sleep 1
done

echo "Starting new server..."
nohup node "${SERVER_SCRIPT}" > /dev/null 2>&1 &

sleep 2

if fuser 8000/tcp > /dev/null 2>&1; then
    echo "Server restarted successfully on port 8000."
else
    echo "Warning: Server might not have started. Check logs."
fi