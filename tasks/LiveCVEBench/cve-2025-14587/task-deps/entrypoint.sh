#!/bin/bash
set -e

# Start MariaDB service
service mariadb start

# Wait for MariaDB to be ready
echo "Waiting for MariaDB to start..."
for i in {1..30}; do
    if mysqladmin ping -h 127.0.0.1 --silent 2>/dev/null; then
        echo "MariaDB is ready!"
        break
    fi
    sleep 1
done

# Initialize database if not already done
if ! mysql -u root -e "USE dbcnp" 2>/dev/null; then
    echo "Initializing database..."
    mysql -u root -e "CREATE DATABASE IF NOT EXISTS dbcnp;"
    mysql -u root dbcnp < /tmp/dbcnp.sql
    echo "Database initialized successfully!"
else
    echo "Database already exists."
fi

# Fix root authentication for PHP mysqli connection (uses TCP 127.0.0.1)
# MariaDB on Debian defaults to unix_socket auth which doesn't work with mysqli
echo "Configuring database authentication..."
mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED VIA mysql_native_password USING '';" 2>/dev/null || true
mysql -u root -e "CREATE USER IF NOT EXISTS 'root'@'127.0.0.1' IDENTIFIED BY '';" 2>/dev/null || true
mysql -u root -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'127.0.0.1' WITH GRANT OPTION;" 2>/dev/null || true
mysql -u root -e "FLUSH PRIVILEGES;" 2>/dev/null || true
echo "Database authentication configured."

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
