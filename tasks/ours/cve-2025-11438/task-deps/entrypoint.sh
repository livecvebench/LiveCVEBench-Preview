#!/bin/bash
set -e

cd /var/www/html/api

# Wait for PostgreSQL to be ready
echo "Waiting for PostgreSQL..."
until PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USERNAME" -d "$DB_DATABASE" -c '\q' 2>/dev/null; do
    sleep 1
done
echo "PostgreSQL is ready!"

# Wait for Redis to be ready
echo "Waiting for Redis..."
until redis-cli -h "$REDIS_HOST" ping 2>/dev/null | grep -q PONG; do
    sleep 1
done
echo "Redis is ready!"

# Set database connection from environment variables
if [ ! -z "$DB_HOST" ]; then
    sed -i "s/^DB_HOST=.*/DB_HOST=$DB_HOST/" /var/www/html/api/.env
fi
if [ ! -z "$DB_DATABASE" ]; then
    sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_DATABASE/" /var/www/html/api/.env
fi
if [ ! -z "$DB_USERNAME" ]; then
    sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USERNAME/" /var/www/html/api/.env
fi
if [ ! -z "$DB_PASSWORD" ]; then
    sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASSWORD/" /var/www/html/api/.env
fi

# Remove STRIPE_KEY from .env to disable pricing (makes all workspaces Pro)
echo "Disabling Stripe/pricing to enable Pro features for all workspaces..."
sed -i '/^STRIPE_KEY=/d' /var/www/html/api/.env

# Generate app key if not set (APP_KEY= or APP_KEY=)
if ! grep -q '^APP_KEY=base64:' /var/www/html/api/.env; then
    echo "Generating application key..."
    NEW_KEY=$(php -r "echo 'base64:' . base64_encode(random_bytes(32));")
    # Escape special characters for sed
    ESCAPED_KEY=$(printf '%s\n' "$NEW_KEY" | sed -e 's/[\/&]/\\&/g')
    sed -i "s/^APP_KEY=.*/APP_KEY=${ESCAPED_KEY}/" /var/www/html/api/.env
    echo "Application key set"
fi

# Generate JWT secret if not set
if ! grep -q '^JWT_SECRET=.\+' /var/www/html/api/.env; then
    echo "Generating JWT secret..."
    NEW_JWT=$(php -r "echo bin2hex(random_bytes(32));")
    sed -i "s/^JWT_SECRET=.*/JWT_SECRET=${NEW_JWT}/" /var/www/html/api/.env
    echo "JWT secret set"
fi

# Run migrations
echo "Running migrations..."
php artisan migrate --force || true

# Create test users via tinker if they don't exist
echo "Setting up test users..."
php artisan tinker --execute="
try {
    // Get or create admin user
    \$admin = \App\Models\User::where('email', 'admin@test.com')->first();
    if (!\$admin) {
        \$admin = \App\Models\User::create([
            'name' => 'Admin User',
            'email' => 'admin@test.com',
            'password' => bcrypt('password123'),
            'email_verified_at' => now(),
        ]);
        echo \"Created admin user\\n\";
    } else {
        echo \"Admin user already exists\\n\";
    }

    // Get or create viewer user
    \$viewer = \App\Models\User::where('email', 'viewer@test.com')->first();
    if (!\$viewer) {
        \$viewer = \App\Models\User::create([
            'name' => 'Viewer User',
            'email' => 'viewer@test.com',
            'password' => bcrypt('password123'),
            'email_verified_at' => now(),
        ]);
        echo \"Created viewer user\\n\";
    } else {
        echo \"Viewer user already exists\\n\";
    }

    // Get or create workspace
    \$workspace = \App\Models\Workspace::first();
    if (!\$workspace) {
        \$workspace = \App\Models\Workspace::create([
            'name' => 'Test Workspace',
        ]);
        // Set is_pro if column exists
        if (\Schema::hasColumn('workspaces', 'is_pro')) {
            \$workspace->is_pro = true;
            \$workspace->save();
        }
        echo \"Created workspace\\n\";
    } else {
        echo \"Workspace already exists\\n\";
    }

    // Attach admin to workspace as admin (if not already attached)
    if (!\$workspace->users()->where('user_id', \$admin->id)->exists()) {
        \$workspace->users()->attach(\$admin->id, ['role' => 'admin']);
        echo \"Attached admin to workspace\\n\";
    }

    // Attach viewer to workspace as user (if not already attached)
    if (!\$workspace->users()->where('user_id', \$viewer->id)->exists()) {
        \$workspace->users()->attach(\$viewer->id, ['role' => 'user']);
        echo \"Attached viewer to workspace\\n\";
    }

    echo \"Setup complete!\\n\";
} catch (Exception \$e) {
    echo 'Error: ' . \$e->getMessage() . \"\\n\";
}
" || true

echo "Starting Laravel server..."

# Loop to allow restart when solution.sh kills/restarts the process
while true; do
    php artisan serve --host=0.0.0.0 --port=8000 || true
    echo "Server stopped. Restarting in 2 seconds..."
    sleep 2
done
