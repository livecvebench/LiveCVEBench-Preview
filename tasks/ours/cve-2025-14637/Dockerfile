FROM php:7.4-apache

WORKDIR /var/www/html

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    default-mysql-client \
    gcc g++ wget \
    && rm -rf /var/lib/apt/lists/*

# Install PHP mysqli extension
RUN docker-php-ext-install mysqli

# Copy the vulnerable application source code
COPY task-deps/pet1/ /var/www/html/pet1/

# Copy the database SQL file for initialization
COPY task-deps/dbcnp.sql /var/www/html/pet1/database/dbcnp.sql

# Copy modified database connection config for Docker
COPY task-deps/dbconn-docker.php /var/www/html/pet1/includes/dbconn.php

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create upload directory with proper permissions
RUN mkdir -p /var/www/html/pet1/upload && \
    chown -R www-data:www-data /var/www/html/pet1 && \
    chmod -R 755 /var/www/html/pet1 && \
    chmod 777 /var/www/html/pet1/upload

# Set proper permissions for images upload directory if it exists
RUN if [ -d /var/www/html/pet1/images/upload ]; then \
    chmod 777 /var/www/html/pet1/images/upload; \
    fi

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Configure PHP settings for file uploads
RUN echo "file_uploads = On" >> /usr/local/etc/php/php.ini && \
    echo "upload_max_filesize = 10M" >> /usr/local/etc/php/php.ini && \
    echo "post_max_size = 12M" >> /usr/local/etc/php/php.ini && \
    echo "memory_limit = 128M" >> /usr/local/etc/php/php.ini

# ENTRYPOINT ["/entrypoint.sh"]
