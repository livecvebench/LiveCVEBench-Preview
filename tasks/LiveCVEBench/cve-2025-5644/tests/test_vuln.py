#!/usr/bin/env python3
"""
Vulnerability tests for radiff2 threading mode.

These tests verify that the -T flag properly warns users about experimental
threading support.

VULNERABLE STATE: No warning message when -T flag is used
FIXED STATE: Warning message present when -T flag is used
"""

import subprocess
import tempfile
import os
import pytest


# The expected warning message after the fix is applied
EXPECTED_WARNING_FRAGMENTS = [
    "Threading support is experimental",
    "known to be crashy",
]


class TestThreadingFlagWarning:
    """Test that the -T flag produces appropriate warning messages."""

    @pytest.fixture
    def test_binaries(self):
        """Create simple test binaries for radiff2."""
        files = []
        for i, content in enumerate([b'AAAA', b'BBBB']):
            with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f:
                # Write minimal ELF-like header
                f.write(b'\x7fELF\x01\x01\x01\x00')
                f.write(b'\x00' * 8)
                f.write(content * 100)
                files.append(f.name)

        yield files

        # Cleanup
        for f in files:
            if os.path.exists(f):
                os.unlink(f)

    def test_threading_warning_present(self, test_binaries):
        """
        Test that using -T flag shows the experimental warning.

        This test FAILS on vulnerable version (no warning)
        This test PASSES on fixed version (warning present)
        """
        file1, file2 = test_binaries

        result = subprocess.run(
            ['radiff2', '-T', file1, file2],
            capture_output=True,
            text=True,
            timeout=30
        )

        output = result.stdout + result.stderr

        # Check for any fragment of the warning message
        warning_found = any(fragment in output for fragment in EXPECTED_WARNING_FRAGMENTS)

        assert warning_found, (
            f"Expected warning about experimental threading not found.\n"
            f"stdout: {result.stdout}\n"
            f"stderr: {result.stderr}"
        )

    def test_threading_warning_with_verbose(self, test_binaries):
        """Test warning presence with additional flags."""
        file1, file2 = test_binaries

        result = subprocess.run(
            ['radiff2', '-T', '-q', file1, file2],
            capture_output=True,
            text=True,
            timeout=30
        )

        output = result.stdout + result.stderr
        warning_found = any(fragment in output for fragment in EXPECTED_WARNING_FRAGMENTS)

        assert warning_found, (
            f"Warning not found with -T -q flags.\n"
            f"output: {output}"
        )

    def test_threading_warning_sparc_architecture(self, test_binaries):
        """Test warning with different architecture settings."""
        file1, file2 = test_binaries

        result = subprocess.run(
            ['radiff2', '-a', 'x86', '-T', file1, file2],
            capture_output=True,
            text=True,
            timeout=30
        )

        output = result.stdout + result.stderr
        warning_found = any(fragment in output for fragment in EXPECTED_WARNING_FRAGMENTS)

        assert warning_found, (
            f"Warning not found with architecture flags.\n"
            f"output: {output}"
        )


class TestThreadingFlagBehavior:
    """Test the actual behavior when threading flag is used."""

    @pytest.fixture
    def test_binaries(self):
        """Create test binaries."""
        files = []
        for content in [b'TEST1', b'TEST2']:
            with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f:
                f.write(b'\x7fELF\x01\x01\x01\x00')
                f.write(b'\x00' * 8)
                f.write(content * 50)
                files.append(f.name)

        yield files

        for f in files:
            if os.path.exists(f):
                os.unlink(f)

    def test_warning_in_stderr_or_stdout(self, test_binaries):
        """Verify warning appears in output stream."""
        file1, file2 = test_binaries

        result = subprocess.run(
            ['radiff2', '-T', file1, file2],
            capture_output=True,
            text=True,
            timeout=30
        )

        # Check both streams
        stdout_has_warning = any(
            fragment in result.stdout for fragment in EXPECTED_WARNING_FRAGMENTS
        )
        stderr_has_warning = any(
            fragment in result.stderr for fragment in EXPECTED_WARNING_FRAGMENTS
        )

        assert stdout_has_warning or stderr_has_warning, (
            f"Warning not found in stdout or stderr.\n"
            f"stdout: {result.stdout[:500]}\n"
            f"stderr: {result.stderr[:500]}"
        )


class TestWarningMessageContent:
    """Test the specific content of the warning message."""

    @pytest.fixture
    def test_binaries(self):
        """Create test binaries."""
        files = []
        for content in [b'A', b'B']:
            with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f:
                f.write(b'\x7fELF\x01\x01\x01\x00')
                f.write(b'\x00' * 8)
                f.write(content * 100)
                files.append(f.name)

        yield files

        for f in files:
            if os.path.exists(f):
                os.unlink(f)

    def test_warning_contains_experimental(self, test_binaries):
        """Verify warning mentions 'experimental'."""
        file1, file2 = test_binaries

        result = subprocess.run(
            ['radiff2', '-T', file1, file2],
            capture_output=True,
            text=True,
            timeout=30
        )

        output = result.stdout + result.stderr
        assert 'experimental' in output.lower(), (
            f"Warning doesn't mention 'experimental'.\n"
            f"output: {output}"
        )

    def test_warning_contains_threading(self, test_binaries):
        """Verify warning mentions 'threading'."""
        file1, file2 = test_binaries

        result = subprocess.run(
            ['radiff2', '-T', file1, file2],
            capture_output=True,
            text=True,
            timeout=30
        )

        output = result.stdout + result.stderr
        assert 'threading' in output.lower() or 'thread' in output.lower(), (
            f"Warning doesn't mention 'threading'.\n"
            f"output: {output}"
        )


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
