FROM golang:1.20

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required per builder guidelines)
RUN apt-get update && apt-get install -y git tmux asciinema curl python3 python3-pip && rm -rf /var/lib/apt/lists/*

# Install pytest for test execution
RUN pip3 install pytest --break-system-packages

# Clone the vulnerable version and remove git history
RUN git clone https://github.com/evervault/evervault-go.git . && \
    git checkout v1.3.1 && \
    rm -rf .git

# Download Go dependencies
RUN go mod download && go mod verify

# Copy test file to attestation directory
COPY task-deps/pcrs_test.go /app/attestation/pcrs_test.go

# Verify project builds
RUN go build ./...

# Keep container running for test execution
# CMD ["tail", "-f", "/dev/null"]
