#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== Setting up test environment ==="

# Install uv for Python package management
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize Python project and install pytest
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

# Copy the test harness to the app directory
cp /tests/test_poll_handler.ts /app/test_poll_handler.ts

# Install Node.js dependencies if needed
cd /app
if [ ! -d "node_modules" ]; then
    echo "Installing Node.js dependencies..."
    npm install 2>/dev/null || true
fi

# Install ts-node if not available
if ! npx ts-node --version >/dev/null 2>&1; then
    echo "Installing ts-node..."
    npm install --save-dev ts-node typescript @types/node 2>/dev/null || true
fi

echo "=== Running tests ==="
cd /tests
uv run pytest . -rA
