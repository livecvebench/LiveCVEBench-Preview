"""
Vulnerability tests for path traversal in file parse API.

These tests verify that the path traversal vulnerability is exploitable
in the vulnerable state and blocked in the fixed state.

In VULNERABLE state: Tests should FAIL (vulnerability is exploitable, sensitive content returned)
In FIXED state: Tests should PASS (vulnerability is mitigated, access denied)

Test logic: Each test asserts that the vulnerability is BLOCKED (fixed behavior).
When running against a VULNERABLE system, these assertions will FAIL because
the exploit succeeds and returns sensitive file contents.
"""

import requests
import pytest

BASE_URL = "http://localhost:3000"
TIMEOUT = 30


class TestPathTraversalVulnerability:
    """Test suite for path traversal vulnerability detection.

    All tests here verify the PRIMARY vulnerability path: /api/files/serve/../../../etc/passwd
    These tests should ALL FAIL on a vulnerable system (because exploit succeeds)
    and ALL PASS on a fixed system (because exploit is blocked).
    """

    def test_passwd_file_traversal_basic(self):
        """Test basic path traversal to read /etc/passwd using many ../ sequences."""
        payload = "/api/files/serve/../../../../../../../etc/passwd"
        response = requests.post(
            f"{BASE_URL}/api/files/parse",
            json={"filePath": payload},
            headers={"Content-Type": "application/json"},
            timeout=TIMEOUT
        )
        data = response.json()

        # VULNERABLE: success=true and content contains passwd data
        # FIXED: success=false with access denied error
        # We assert FIXED behavior, so test FAILS on vulnerable system

        if data.get("success") == True:
            content = data.get("output", {}).get("content", "")
            # If we can read /etc/passwd content, vulnerability exists
            assert "root:" not in content and "daemon:" not in content, \
                f"Path traversal vulnerability exploited! Read /etc/passwd content: {content[:200]}..."

    def test_proc_self_environ(self):
        """Test reading /proc/self/environ for environment variables."""
        payload = "/api/files/serve/../../../../../../../proc/self/environ"
        response = requests.post(
            f"{BASE_URL}/api/files/parse",
            json={"filePath": payload},
            headers={"Content-Type": "application/json"},
            timeout=TIMEOUT
        )
        data = response.json()

        if data.get("success") == True:
            content = data.get("output", {}).get("content", "")
            # /proc/self/environ contains env vars
            assert "PATH=" not in content and "HOME=" not in content, \
                f"Path traversal vulnerability exploited! Read /proc/self/environ: {content[:200]}..."

    def test_hosts_file_traversal(self):
        """Test reading /etc/hosts file."""
        payload = "/api/files/serve/../../../../../../../etc/hosts"
        response = requests.post(
            f"{BASE_URL}/api/files/parse",
            json={"filePath": payload},
            headers={"Content-Type": "application/json"},
            timeout=TIMEOUT
        )
        data = response.json()

        if data.get("success") == True:
            content = data.get("output", {}).get("content", "")
            # /etc/hosts typically contains localhost entry
            assert "localhost" not in content and "127.0.0.1" not in content, \
                f"Path traversal vulnerability exploited! Read /etc/hosts: {content[:200]}..."

    def test_os_release_traversal(self):
        """Test reading /etc/os-release file."""
        payload = "/api/files/serve/../../../../../../../etc/os-release"
        response = requests.post(
            f"{BASE_URL}/api/files/parse",
            json={"filePath": payload},
            headers={"Content-Type": "application/json"},
            timeout=TIMEOUT
        )
        data = response.json()

        if data.get("success") == True:
            content = data.get("output", {}).get("content", "")
            # /etc/os-release contains OS info
            assert "ID=" not in content and "VERSION" not in content, \
                f"Path traversal vulnerability exploited! Read /etc/os-release: {content[:200]}..."

    def test_relative_path_traversal(self):
        """Test relative path traversal without /api/files/serve prefix."""
        payload = "../../../etc/passwd"
        response = requests.post(
            f"{BASE_URL}/api/files/parse",
            json={"filePath": payload},
            headers={"Content-Type": "application/json"},
            timeout=TIMEOUT
        )
        data = response.json()

        if data.get("success") == True:
            content = data.get("output", {}).get("content", "")
            assert "root:" not in content, \
                "Relative path traversal allowed reading /etc/passwd content"
