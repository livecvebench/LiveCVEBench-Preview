"""
Functionality tests for WeGIA member reports endpoint.
These tests verify the endpoint works correctly and should PASS in both
vulnerable and fixed states.
"""
import pytest
import requests
import time

BASE_URL = "http://localhost"
ENDPOINT = "/WeGIA/html/socio/sistema/get_relatorios_socios.php"


def wait_for_server(timeout=60):
    """Wait for the web server to be ready."""
    start = time.time()
    while time.time() - start < timeout:
        try:
            response = requests.get(f"{BASE_URL}/WeGIA/", timeout=5)
            if response.status_code in [200, 302, 403]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(1)
    return False


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure the server is ready before running tests."""
    assert wait_for_server(), "Web server failed to start"


def test_endpoint_exists():
    """Test that the member reports endpoint exists and responds."""
    params = {
        "tipo_socio": "x",
        "tipo_pessoa": "x",
        "operador": "maior_q",
        "valor": "",
        "tag": "x",
        "status": "x"
    }
    response = requests.get(f"{BASE_URL}{ENDPOINT}", params=params, allow_redirects=False)
    # The endpoint should respond (either with data, error, or redirect)
    assert response.status_code in [200, 302, 400, 403], \
        f"Unexpected status code: {response.status_code}"


def test_endpoint_returns_valid_json_or_error():
    """Test that the endpoint returns valid JSON (data or error message)."""
    params = {
        "tipo_socio": "x",
        "tipo_pessoa": "x",
        "operador": "maior_q",
        "valor": "",
        "tag": "x",
        "status": "x"
    }
    response = requests.get(f"{BASE_URL}{ENDPOINT}", params=params, allow_redirects=False)

    # If it's a redirect, that's acceptable (for fixed version)
    if response.status_code in [302, 303]:
        return

    # If it returns content, it should be valid JSON
    if response.text.strip():
        try:
            data = response.json()
            # Should be either a list (member data) or a dict (error message)
            assert isinstance(data, (list, dict, type(None))), \
                "Response should be JSON list, dict, or null"
        except ValueError:
            pytest.fail(f"Response is not valid JSON: {response.text[:200]}")


def test_database_has_test_data():
    """Test that the database has expected test data (when accessible)."""
    params = {
        "tipo_socio": "x",
        "tipo_pessoa": "x",
        "operador": "maior_q",
        "valor": "",
        "tag": "x",
        "status": "x"
    }
    response = requests.get(f"{BASE_URL}{ENDPOINT}", params=params, allow_redirects=False)

    # In vulnerable state, we can check data exists
    # In fixed state, we'll get an error/redirect which is also acceptable
    if response.status_code == 200:
        try:
            data = response.json()
            if isinstance(data, list) and len(data) > 0:
                # Verify the data structure matches expected fields
                first_record = data[0]
                expected_fields = ["nome", "telefone", "cpf", "valor_periodo", "email", "tipo", "status", "tag"]
                for field in expected_fields:
                    assert field in first_record, f"Missing expected field: {field}"
        except (ValueError, TypeError):
            pass  # Error response is acceptable


def test_filter_parameters_accepted():
    """Test that the endpoint accepts filter parameters without error."""
    # Test with specific status filter
    params = {
        "tipo_socio": "x",
        "tipo_pessoa": "x",
        "operador": "maior_q",
        "valor": "100",
        "tag": "x",
        "status": "1"  # Active status
    }
    response = requests.get(f"{BASE_URL}{ENDPOINT}", params=params, allow_redirects=False)

    # Should not return 500 server error
    assert response.status_code != 500, \
        f"Server error when using filter parameters: {response.text[:200]}"


def test_value_filter_operator():
    """Test that value filter with different operators is accepted."""
    operators = ["maior_q", "maior_ia", "igual_a", "menor_ia", "menor_q"]

    for op in operators:
        params = {
            "tipo_socio": "x",
            "tipo_pessoa": "x",
            "operador": op,
            "valor": "1000",
            "tag": "x",
            "status": "x"
        }
        response = requests.get(f"{BASE_URL}{ENDPOINT}", params=params, allow_redirects=False)

        # Should not cause server error for any operator
        assert response.status_code != 500, \
            f"Server error with operator '{op}': {response.text[:200]}"
