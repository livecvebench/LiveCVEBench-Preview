#!/bin/bash
# Solution script for OpenSourcePOS CSRF Protection Fix
# This script enables CSRF protection that was disabled in the configuration

set -e
cd /app

echo "[*] Applying CSRF protection fix..."

# Fix 1: Enable CSRF filter in Filters.php
# The CSRF filter is commented out and needs to be uncommented
echo "[*] Enabling CSRF filter in app/Config/Filters.php..."

if [ -f "app/Config/Filters.php" ]; then
    # Replace the commented CSRF line with the active one
    sed -i "s|// 'csrf' => \['except' => 'login'\],.*|'csrf' => ['except' => 'login'],|" app/Config/Filters.php
    echo "[+] CSRF filter enabled in Filters.php"
else
    echo "[-] Error: app/Config/Filters.php not found"
    exit 1
fi

# Fix 2: Update Security.php settings for proper CSRF operation
echo "[*] Updating CSRF settings in app/Config/Security.php..."

if [ -f "app/Config/Security.php" ]; then
    # Change CSRF protection from cookie to session-based (more secure)
    sed -i "s/public string \$csrfProtection = 'cookie'/public string \$csrfProtection = 'session'/" app/Config/Security.php

    # Disable token regeneration to prevent AJAX race conditions in Sales module
    sed -i "s/public bool \$regenerate = true/public bool \$regenerate = false/" app/Config/Security.php

    echo "[+] Security.php updated"
else
    echo "[-] Error: app/Config/Security.php not found"
    exit 1
fi

# Verify the changes were applied
echo ""
echo "[*] Verifying changes..."

if grep -q "'csrf' => \['except' => 'login'\]" app/Config/Filters.php; then
    echo "[+] Filters.php: CSRF filter is now enabled"
else
    echo "[-] Warning: CSRF filter may not be properly enabled"
fi

if grep -q "public string \$csrfProtection = 'session'" app/Config/Security.php; then
    echo "[+] Security.php: Using session-based CSRF protection"
else
    echo "[-] Warning: CSRF protection method may not be updated"
fi

if grep -q "public bool \$regenerate = false" app/Config/Security.php; then
    echo "[+] Security.php: Token regeneration disabled for AJAX compatibility"
else
    echo "[-] Warning: Token regeneration setting may not be updated"
fi

# Clear any cached configuration
echo ""
echo "[*] Clearing configuration cache..."
if [ -d "writable/cache" ]; then
    rm -f writable/cache/*.php 2>/dev/null || true
    echo "[+] Cache cleared"
fi

# PHP-FPM / Apache with mod_php typically picks up changes automatically
# But if the app is running as a persistent process, we might need to restart
# For CodeIgniter 4 with Apache/nginx+PHP-FPM, changes take effect on next request

echo ""
echo "[+] Fix applied successfully!"
echo ""
echo "Summary of changes:"
echo "  1. Enabled CSRF filter in Filters.php (was commented out)"
echo "  2. Changed CSRF protection from 'cookie' to 'session' in Security.php"
echo "  3. Disabled token regeneration to prevent AJAX issues in Sales module"
echo ""
echo "The application will now reject form submissions that don't include"
echo "a valid CSRF token, preventing cross-origin request attacks."
