#!/bin/bash
# Solution script for Online Pet Shop Management System
# Fixes input validation issue in order form processing

set -e

VULN_FILE="/var/www/html/pet1/availableframe.php"

echo "Applying fix to $VULN_FILE..."

# Backup original file
cp "$VULN_FILE" "${VULN_FILE}.bak" 2>/dev/null || true

# Use Python for reliable multi-line text replacement
python3 << 'PYTHON_SCRIPT'
import sys

vuln_file = '/var/www/html/pet1/availableframe.php'

try:
    with open(vuln_file, 'r') as f:
        content = f.read()
except FileNotFoundError:
    print(f"ERROR: File not found: {vuln_file}")
    sys.exit(1)

original_content = content

# Fix 1: Replace vulnerable SELECT query with prepared statement
# Match the exact vulnerable pattern
old_select = '''$sql =("SELECT * FROM tblorders WHERE cname = '$name'") or die (mysqli_error());
    $result=mysqli_query($con, $sql);'''

new_select = '''$stmt = mysqli_prepare($con, "SELECT * FROM tblorders WHERE cname = ?");
		mysqli_stmt_bind_param($stmt, "s", $name);
		mysqli_stmt_execute($stmt);
		$result = mysqli_stmt_get_result($stmt);'''

if old_select in content:
    content = content.replace(old_select, new_select)
    print("Fixed SELECT query")
else:
    # Try alternative whitespace patterns
    import re
    pattern = r'\$sql\s*=\s*\(\s*"SELECT \* FROM tblorders WHERE cname = \'\$name\'"\s*\)\s*or\s+die\s*\(\s*mysqli_error\(\)\s*\)\s*;\s*\n\s*\$result\s*=\s*mysqli_query\s*\(\s*\$con\s*,\s*\$sql\s*\)\s*;'
    if re.search(pattern, content):
        content = re.sub(pattern, new_select, content)
        print("Fixed SELECT query (regex)")
    else:
        print("Warning: SELECT pattern not found (may already be fixed)")

# Fix 2: Replace vulnerable INSERT query with prepared statement
old_insert = '''$sql = ("INSERT INTO tblorders VALUES(NULL,'$name','$address','$contact','$id','$qty','new',NULL,'$otype','$datep')") or die (mysqli_error());
        $result=mysqli_query($con, $sql);'''

new_insert = '''$stmt2 = mysqli_prepare($con, "INSERT INTO tblorders VALUES(NULL,?,?,?,?,?,'new',NULL,?,?)");
				mysqli_stmt_bind_param($stmt2, "sssisis", $name, $address, $contact, $id, $qty, $otype, $datep);
				mysqli_stmt_execute($stmt2);
				$result = $stmt2 ? true : false;'''

if old_insert in content:
    content = content.replace(old_insert, new_insert)
    print("Fixed INSERT query")
else:
    # Try alternative whitespace patterns
    pattern = r'\$sql\s*=\s*\(\s*"INSERT INTO tblorders VALUES\(NULL,\'\$name\',\'\$address\',\'\$contact\',\'\$id\',\'\$qty\',\'new\',NULL,\'\$otype\',\'\$datep\'\)"\s*\)\s*or\s+die\s*\(\s*mysqli_error\(\)\s*\)\s*;\s*\n\s*\$result\s*=\s*mysqli_query\s*\(\s*\$con\s*,\s*\$sql\s*\)\s*;'
    if re.search(pattern, content):
        content = re.sub(pattern, new_insert, content)
        print("Fixed INSERT query (regex)")
    else:
        print("Warning: INSERT pattern not found (may already be fixed)")

if content != original_content:
    with open(vuln_file, 'w') as f:
        f.write(content)
    print("Fix applied successfully!")
else:
    print("No changes made (file may already be fixed)")

PYTHON_SCRIPT

echo ""
echo "Fix complete."
echo ""

# Note: PHP doesn't require service restart as it re-reads files on each request
# But if running with opcache, you might need to restart Apache
# Attempt to clear opcache or restart web server
if command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
elif command -v apache2ctl &> /dev/null; then
    apache2ctl graceful 2>/dev/null || true
elif [ -f /etc/init.d/apache2 ]; then
    /etc/init.d/apache2 reload 2>/dev/null || true
fi

echo "Solution applied."
