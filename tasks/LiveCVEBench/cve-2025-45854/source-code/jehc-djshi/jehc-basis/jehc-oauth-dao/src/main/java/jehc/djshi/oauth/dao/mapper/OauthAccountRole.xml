<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jehc.djshi.oauth.dao.OauthAccountRoleDao">

	<resultMap type="jehc.djshi.oauth.model.OauthAccount" id="OauthAccountResult">
		<result property="id"    column="id"    />
		<result property="accountTypeId"    column="account_type_id"    />
		<result property="name"    column="name"    />
		<result property="account"    column="account"    />
		<result property="status" column="status"/>
		<result property="email" column="email"/>
		<result property="createTime" column="create_time"/>
		<result property="updateTime" column="update_time"/>
		<result property="lastLoginTime"    column="last_login_time"    />
		<association property="oauthAccountTypes" column="{id=account_type_id}" select="jehc.djshi.oauth.dao.OauthAccountTypeDao.getOauthAccountTypeList"></association>
	</resultMap>

	<!--初始化分页-->
	<select id="getOauthAccountRoleListByCondition" resultType="jehc.djshi.oauth.model.OauthAccountRole" parameterType="map">
		SELECT
			id,
			role_id AS roleId,
			account_id AS accountId
		FROM
			oauth_account_role
		WHERE 1=1
		<if test="null != accountId">
			AND account_id = #{accountId}
		</if>
		<if test="null != roleId">
			AND role_id = #{roleId}
		</if>
	</select>

	<!--查询列表-->
	<select id="getOauthARListByCondition" resultMap="OauthAccountResult" parameterType="map">
		SELECT
			oauth_account.id,
			oauth_account.name,
			oauth_account.account,
			oauth_account.account_type_id,
			oauth_account.status,
			oauth_account.email
		FROM
			oauth_account oauth_account
		WHERE 1=1
		<if test="null != roleId and '' != roleId">
			<if test="flag == 1">
				AND oauth_account.id IN(SELECT account_id FROM oauth_account_role WHERE role_id=#{roleId})
			</if>
			<if test="flag == 2">
				AND oauth_account.id NOT IN(SELECT account_id FROM oauth_account_role WHERE role_id=#{roleId})
				AND (
				<foreach item="item" index="ind" collection="accountTypeIds.split(',')" open=" " separator=" OR " close=" ">
					FIND_IN_SET(#{item},oauth_account.account_type_id)
				</foreach>
				)
			</if>
		</if>
		<if test="null != name">
			AND oauth_account.name LIKE CONCAT(CONCAT('%',#{name}),'%')
		</if>
		<if test="null != account">
			AND oauth_account.account = #{account}
		</if>
		<if test="null != accountTypeId">
			<foreach item="item" index="index" collection="accountTypeId.split(',')" open=" " separator=" " close=" ">
				AND FIND_IN_SET(#{item},oauth_account.account_type_id)
			</foreach>
		</if>
		<if test="null != status">
			AND oauth_account.status = #{status}
		</if>
		<if test="null != email">
			AND oauth_account.email = #{email}
		</if>
			<!--过滤管理员-->
			AND oauth_account.id NOT IN(SELECT oauth_admin.account_id FROM oauth_admin oauth_admin LEFT JOIN oauth_admin_sys oauth_admin_sys ON oauth_admin_sys.admin_id = oauth_admin.id)
	</select>

	<!--查询对象-->
	<select id="getOauthAccountRoleById" resultType="jehc.djshi.oauth.model.OauthAccountRole" parameterType="string">
		SELECT
			id,
			role_id AS roleId,
			account_id AS accountId
		FROM 
			oauth_account_role
		WHERE id=#{id}
	</select>

	<!--添加-->
	<insert id="addOauthAccountRole" parameterType="jehc.djshi.oauth.model.OauthAccountRole">
		INSERT INTO
			oauth_account_role
			(
			id,
			role_id,
			account_id
			)
			VALUES
			(
			#{id},
			#{roleId},
			#{accountId}
			)
	</insert>

	<!--删除-->
	<delete id="delOauthAccountRole" parameterType="map">
		DELETE FROM oauth_account_role WHERE account_id IN
		<foreach item="item" index="index" collection="accountId" open="(" separator="," close=")">
			#{item}
		</foreach>
		AND role_id = #{roleId}
	</delete>

	<!--删除-->
	<delete id="delBatchOauthAccountRole" parameterType="map">
		DELETE FROM oauth_account_role WHERE role_id IN
		<foreach item="item" index="index" collection="roleId" open="(" separator="," close=")">
			#{item}
		</foreach>
		AND account_id = #{accountId}
	</delete>

</mapper>