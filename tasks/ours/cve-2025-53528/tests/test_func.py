"""
Functionality tests for Cadwyn documentation endpoints.
These tests verify that the documentation endpoints work correctly
with valid version parameters.
"""

import pytest
from fastapi.testclient import TestClient
from cadwyn import Cadwyn, HeadVersion, Version, VersionBundle


@pytest.fixture
def client():
    """Create a test client with a minimal Cadwyn application."""
    app = Cadwyn(
        versions=VersionBundle(HeadVersion(), Version("2000-01-01")),
        title="Test API"
    )

    @app.get("/")
    async def root():
        return {"message": "Hello World"}

    return TestClient(app)


class TestDocsEndpointFunctionality:
    """Test that /docs endpoint works correctly."""

    def test_docs_dashboard_without_version(self, client):
        """Test /docs returns the version selection dashboard."""
        response = client.get("/docs")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("content-type", "")

    def test_docs_with_valid_version(self, client):
        """Test /docs with a valid version parameter returns Swagger UI."""
        response = client.get("/docs?version=2000-01-01")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("content-type", "")
        # Should contain Swagger UI elements
        assert "swagger" in response.text.lower()

    def test_docs_with_head_version(self, client):
        """Test /docs works with head version."""
        # HeadVersion creates a version based on today's date
        response = client.get("/docs")
        assert response.status_code == 200


class TestRedocEndpointFunctionality:
    """Test that /redoc endpoint works correctly."""

    def test_redoc_dashboard_without_version(self, client):
        """Test /redoc returns the version selection dashboard."""
        response = client.get("/redoc")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("content-type", "")

    def test_redoc_with_valid_version(self, client):
        """Test /redoc with a valid version parameter returns ReDoc."""
        response = client.get("/redoc?version=2000-01-01")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("content-type", "")
        # Should contain ReDoc elements
        assert "redoc" in response.text.lower()


class TestOpenAPIEndpointFunctionality:
    """Test that /openapi.json endpoint works correctly."""

    def test_openapi_with_valid_version(self, client):
        """Test /openapi.json returns valid OpenAPI schema."""
        response = client.get("/openapi.json?version=2000-01-01")
        assert response.status_code == 200
        data = response.json()
        assert "openapi" in data
        assert "info" in data
        assert "paths" in data

    def test_openapi_with_invalid_version_returns_404(self, client):
        """Test /openapi.json with invalid version returns 404."""
        response = client.get("/openapi.json?version=invalid-version")
        assert response.status_code == 404


class TestVersionParameterHandling:
    """Test that version parameters are properly handled."""

    def test_version_with_simple_alphanumeric(self, client):
        """Test version parameter with simple alphanumeric value."""
        response = client.get("/docs?version=2000-01-01")
        assert response.status_code == 200

    def test_version_parameter_appears_in_response(self, client):
        """Test that version is included in the generated URL."""
        response = client.get("/docs?version=2000-01-01")
        assert response.status_code == 200
        # The version should appear in the openapi_url
        assert "version=" in response.text
