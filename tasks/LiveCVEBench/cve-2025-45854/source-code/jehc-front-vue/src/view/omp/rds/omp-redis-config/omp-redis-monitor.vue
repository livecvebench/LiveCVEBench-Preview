<template>
    <!-- 
    <b-modal ref="my-modal" hide-footer title="Using Component Methods">
     <div class="d-block text-center">
       <h3>Hello From My Modal!</h3>
     </div>
     <b-button class="mt-3" variant="outline-danger" block @click="hideModal">Close Me</b-button>
     <b-button class="mt-2" variant="outline-warning" block @click="toggleModal">Toggle Me</b-button>
   </b-modal> 
    -->
    <!--
        body-class="modalStyle" 表示样式
        size="lg" 表示模态窗口大小 xl,lg,sm,full
        hide-footer 表示隐藏底部按钮
        hide-header 表示隐藏头部内容
        no-close-on-backdrop 表示鼠标点击背景不可关闭
        hide-header-close 表示隐藏头部关闭按钮
        centered 居中
        ok-title=“确定” 
        cancel-title=取消
        @ok="handleOk" 
        @cancel="handleCancel"
        @close="handleCancel" 监听关闭窗体事件
        scrollable 滚动条
        hide-backdrop 隐藏背景
        wrapClassName="ant-modal-cust-warp" 
        style="top:5%;height: 85%;overflow-y: hidden" 样式
    -->
    <b-modal ref="my-modal" :title="title" content-class="fullWinBody" hide-footer size="fullWin" scrollable no-close-on-backdrop @close="handleClose">
        <div class="d-block text-center">
            <div class="panel-body">
                <div class="m-form m-form--fit m-form--label-align-left m-form--group-seperator-dashed">
                    <div class="form-group m-form__group row">
                        <div class="col-lg-2">
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight: 100;">Redis版本</label><br>
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight:500;" >{{ompRedisInfoForm.redis_version}}</label>
                        </div>
                        <div class="col-lg-2">
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight: 100;">已使用内存</label><br>
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight:500;" >{{ompRedisInfoForm.used_memory_human}}</label>
                        </div>
                        <div class="col-lg-2">
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight: 100;">客户端</label><br>
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight:500;">{{ompRedisInfoForm.connected_clients}}</label>
                        </div>
                        <div class="col-lg-2">
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight: 100;">已执行的命令</label><br>
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight:500;">{{ompRedisInfoForm.total_commands_processed}}</label>
                        </div>
                        <div class="col-lg-2">
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight: 100;">正常运行时间</label><br>
                            <label class="col-form-label" style="padding-top: .1rem;font-size: 16px;font-weight:500;">{{ompRedisInfoForm.uptime_in_days}} days</label>
                        </div>
                    </div>
                    <div class="form-group m-form__group row">
                        <div class="col-lg-7" style="overflow-x:auto;overflow-y:auto;">
                            <div id="mainMem" style="width:100%;height:300px;text-align: center;margin: auto;"></div>
                        </div>
                        <div class="col-lg-5">
                            <table class="table table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th>属性</th>
                                    <th>键值</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <th scope="row" title="架构">arch_bits</th>
                                    <td>{{ompRedisInfoForm.arch_bits}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="配置文件路径">config_file</th>
                                    <td>{{ompRedisInfoForm.config_file}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis内部调度频率">hz</th>
                                    <td>{{ompRedisInfoForm.hz}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="自增时间，用于LRU管理">lru_clock</th>
                                    <td>{{ompRedisInfoForm.lru_clock}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis服务器宿主机操作系统">os</th>
                                    <td>{{ompRedisInfoForm.os}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="事件处理机制">multiplexing_api</th>
                                    <td>{{ompRedisInfoForm.multiplexing_api}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis服务器进程的pid">process_id</th>
                                    <td>{{ompRedisInfoForm.process_id}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis_build_id">redis_build_id</th>
                                    <td>{{ompRedisInfoForm.redis_build_id}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis_git_dirty">redis_git_dirty</th>
                                    <td>{{ompRedisInfoForm.redis_git_dirty}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis_git_sha1">redis_git_sha1</th>
                                    <td>{{ompRedisInfoForm.redis_git_sha1}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="运行模式，单机或集群">redis_mode</th>
                                    <td>{{ompRedisInfoForm.redis_mode}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis服务器版本">redis_version</th>
                                    <td>{{ompRedisInfoForm.redis_version}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="服务器运行id">run_id</th>
                                    <td>{{ompRedisInfoForm.run_id}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis服务器监听端口">tcp_port</th>
                                    <td>{{ompRedisInfoForm.tcp_port}}</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="redis服务器启动总时间，单位天">uptime_in_days</th>
                                    <td>{{ompRedisInfoForm.uptime_in_days}} days</td>
                                </tr>
                                <tr>
                                    <th scope="row" title="自 Redis 服务器启动以来，经过的秒数">uptime_in_seconds</th>
                                    <td>{{ompRedisInfoForm.uptime_in_seconds}}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <template slot="modal-footer">
            <!--自定义按钮-->
        </template>
    </b-modal>
</template>
<script>
import apiUtil from "@/core/util/apiUtil.js";
import { handleNotify, handleAlert, handleConfirm, showWating, closeWating } from "@/core/util/jehcUtil.js";
import { setTimeout } from "timers";
export default {
    data() {
        return {
            title:"实时信息",
            memChart:null,
            timer_ :null,
            win:null,
            configId:"",
            ompRedisInfoForm: {                
                redis_version: "未知",
                used_memory_human:"未知",
                connected_clients:"未知",
                total_commands_processed:"未知",
                uptime_in_days:"未知",
                uptime_in_days:"未知",
                uptime_in_seconds:"未知",
                max_wait_millis:"未知",
                arch_bits:"未知",
                config_file:"未知",
                hz:"未知",
                lru_clock:"未知",
                os:"未知",
                multiplexing_api:"未知",
                process_id:"未知",
                redis_build_id:"未知",
                redis_git_dirty:"未知",
                redis_git_sha1:"未知",
                redis_mode:"未知",
                run_id:"未知",
                tcp_port:"未知",
                uptime_in_seconds:"未知",
            }
        }
    },
    components: {

    },
    watch: {
    },
    mounted() {
       
    },
    methods: {
        showModal(id,host) {
            this.restForm();
            this.$refs['my-modal'].show();
            this.getDetail(id);
            this.title="实时信息 "+host;   
            setTimeout(this.initMemChart, 500);

            let timer = setInterval(() => {
                this.initRedisInfoData();
            }, 5000);

            this.timer_ = timer;
        },
        hideModal() {
            this.$refs['my-modal'].hide()
        },
        toggleModal() {
            // 当模态已隐藏时，我们传递要返回焦点的按钮的ID
            this.$refs['my-modal'].toggle('#toggle-btn')
        },
        restForm() {
            //重置
            Object.assign(this.$data.ompRedisInfoForm, this.$options.data().ompRedisInfoForm);
        },
        getDetail(id){            
            this.configId = id;
            if(null != this.configId && '' != this.configId){
                apiUtil.get(process.env.VUE_APP_OMP_API+"/omp/redisMain/info?configId="+id).then(({ data }) => {
                    this.ompRedisInfoForm = data.data;
                    if(this.memChart){
                        this.initMemData();
                    }                   
                    
                });
            }
        },
        handleClose(){
            this.configId = "";
            this.memChart = null;        
            clearInterval(this.timer_);
        },
        initRedisInfoData(){
            this.getDetail(this.configId)
        },
        initMemChart(){
            this.memChart = this.$echarts.init(document.getElementById('mainMem'));
            this.memChart.setOption({
                title: {
                    show:true,    // 是否显示标题组件,（true/false）
                    text:'内存',   // 主标题文本，支持使用\n换行
                    textAlign:'auto',    //整体水平对齐（包括text和subtext）
                    textVerticalAlign:'auto',//整体的垂直对齐（包括text和subtext）
                    padding:0,    // 标题内边距 写法如[5,10]||[ 5,6, 7, 8] ,
                    left:'auto',    // title组件离容器左侧距离，写法如'5'||'5%'
                    right:'auto',    //'title组件离容器右侧距离
                    top:'auto',    // title组件离容器上侧距离
                    bottom:'auto',    // title组件离容器下侧距离
                    borderColor: '#fff',     // 标题边框颜色
                    borderWidth: 1,    // 边框宽度（默认单位px）
                    textStyle: {    // 标题样式
                        color: '#ccc',    //字体颜色
                        fontStyle: 'normal',    //字体风格
                        fontSize: 13,    //字体大小
                        fontWeight: 400,    //字体粗细
                        fontFamily: 'sans-serif',    //文字字体
                        lineHeight: '13',    //字体行高
                        align:'center',//文字水平对齐方式（left/right）
                        verticalAlign:'middle',//文字垂直对齐方式（top/bottom）
                    },
                    subtext: '',    // 副标题
                    subtextStyle: {    // 副标题样式
                        color: '#ccc',
                        fontStyle:'normal',
                        fontWeight:'normal',
                        fontFamily:'sans-serif',
                        fontSize:11,
                        lineHeight:11,
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    }
                },
                legend: {
                    data: ['used_memory', 'used_memory_rss', 'used_memory_lua', 'used_memory_peak']
                },
                /*toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
                },*/
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: [
                    {
                        type: 'category',
                        boundaryGap: false,
                        data: []
                    }
                ],
                yAxis: [
                    {
                        // name: '单位（MB）',
                        type: 'value',
                        axisLabel:{
                            color: "#1e1e1e",
                            formatter: this.labelFormatter,
                            inside: false,
                            fontSize:'0.2rem',
                            fontWeight: 'bold'
                        }
                    }
                ],
                series: [
                    {
                        name: 'used_memory',
                        type: 'line',
                        stack: '总量',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: '#e7bcf3' // 0% 处的颜色
                                }, {
                                    offset: 1, color: '#e7bcf3' // 100% 处的颜色
                                }],
                                global: false // 缺省为 false
                            }
                        },
                        data: []
                    },
                    {
                        name: 'used_memory_rss',
                        type: 'line',
                        stack: '总量',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(58,132,255, 0.5)' // 0% 处的颜色
                                }, {
                                    offset: 1, color: 'rgba(58,132,255, 0)' // 100% 处的颜色
                                }],
                                global: false // 缺省为 false
                            }
                        },
                        data: []
                    },
                    {
                        name: 'used_memory_lua',
                        type: 'line',
                        stack: '总量',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: '#FFDB5C' // 0% 处的颜色
                                }, {
                                    offset: 1, color: '#FFDB5C' // 100% 处的颜色
                                }],
                                global: false // 缺省为 false
                            }
                        },
                        data: []
                    },
                    {
                        name: 'used_memory_peak',
                        type: 'line',
                        stack: '总量',
                        label: {
                            normal: {
                                show: true,
                                position: 'top'
                            }
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: '#9FE6B8' // 0% 处的颜色
                                }, {
                                    offset: 1, color: '#9FE6B8' // 100% 处的颜色
                                }],
                                global: false // 缺省为 false
                            }
                        },
                        data: []
                    }
                ]
            });
        },
        labelFormatter(value) {
            return value+" mb"
        },
        initMemData(){
            if(null != this.configId && '' != this.configId && null != this.memChart){
                apiUtil.post(process.env.VUE_APP_OMP_API+"/omp/redisMain/mems?configId="+this.configId).then(({ data }) => {
                    let option =  this.memChart.getOption();
                    option.xAxis[0].data = data.data.xdata;
                    option.series[0].data = data.data.ydata0;
                    option.series[1].data = data.data.ydata1;
                    option.series[2].data = data.data.ydata2;
                    option.series[3].data = data.data.ydata3;
                    this.memChart.setOption(option);
                });
            }            
        },
    }
}
</script>