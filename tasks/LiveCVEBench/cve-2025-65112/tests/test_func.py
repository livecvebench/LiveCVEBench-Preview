"""
Functionality tests for PubNet package upload endpoint.
These tests verify the application works correctly and should PASS in both
vulnerable and fixed states.
"""
import requests
import tarfile
import io
import pytest

BASE_URL = "http://localhost"


def create_dart_package(name="test_package", version="1.0.0"):
    """Create a minimal valid Dart package tar.gz in memory"""
    pubspec = f"""name: {name}
version: {version}
description: Test package for functionality verification
environment:
  sdk: '>=2.12.0 <4.0.0'
"""
    tar_buffer = io.BytesIO()
    with tarfile.open(fileobj=tar_buffer, mode='w:gz') as tar:
        info = tarfile.TarInfo(name='pubspec.yaml')
        data = pubspec.encode('utf-8')
        info.size = len(data)
        tar.addfile(info, io.BytesIO(data))
    tar_buffer.seek(0)
    return tar_buffer


class TestUploadEndpointBasics:
    """Test basic endpoint functionality"""

    def test_endpoint_exists(self):
        """Upload endpoint should be accessible"""
        response = requests.options(f"{BASE_URL}/api/storage/upload")
        # Should not be 404 - endpoint exists
        assert response.status_code != 404, "Upload endpoint should exist"

    def test_missing_file_returns_error(self):
        """Upload without file should return appropriate error"""
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            data={'author-id': '1'}
        )
        # Should return 400 or 411 (bad request or length required)
        assert response.status_code in [400, 411], \
            f"Missing file should return error, got {response.status_code}"

    def test_missing_content_length_returns_411(self):
        """Request without Content-Length should return 411"""
        # Send a request that triggers the content-length check
        # Most HTTP clients add Content-Length automatically, but we test the endpoint behavior
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', create_dart_package(), 'application/gzip')},
            data={'author-id': '1'}
        )
        # Either accepts or rejects with a valid HTTP code
        assert response.status_code in [200, 204, 400, 411, 413], \
            f"Unexpected status code: {response.status_code}"


class TestUploadPayloadValidation:
    """Test payload and content validation"""

    def test_invalid_author_id_format_handled(self):
        """Invalid author-id format should be handled gracefully"""
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': 'not-a-number'}
        )
        # Should return 400 or 500 (validation error), not crash
        assert response.status_code in [400, 500], \
            f"Invalid author-id should return error, got {response.status_code}"

    def test_nonexistent_author_id_rejected(self):
        """Non-existent author ID should be rejected"""
        package = create_dart_package()
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('test.tar.gz', package, 'application/gzip')},
            data={'author-id': '99999999'}  # Very high ID unlikely to exist
        )
        # Should reject invalid author - could be 400 (InvalidAuthorId) or 400 (InvalidSignedUrl after fix)
        assert response.status_code == 400, \
            f"Non-existent author-id should return 400, got {response.status_code}"

    def test_empty_file_handled(self):
        """Empty file upload should be handled gracefully"""
        empty_buffer = io.BytesIO(b'')
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            files={'file': ('empty.tar.gz', empty_buffer, 'application/gzip')},
            data={'author-id': '1'}
        )
        # Should return an error or accept (depends on validation level)
        # 204 is also acceptable - server accepted the empty file
        assert response.status_code in [204, 400, 422, 500], \
            f"Empty file should be handled gracefully, got {response.status_code}"


class TestResponseFormat:
    """Test API response formats"""

    def test_error_response_is_json(self):
        """Error responses should be in JSON format"""
        response = requests.post(
            f"{BASE_URL}/api/storage/upload",
            data={'author-id': '1'}  # Missing file
        )
        if response.status_code >= 400:
            content_type = response.headers.get('Content-Type', '')
            # Should return JSON error response
            assert 'application/json' in content_type or 'application/problem+json' in content_type or response.text.startswith('{'), \
                f"Error response should be JSON, got Content-Type: {content_type}"

    def test_options_request_handled(self):
        """OPTIONS request should be handled gracefully (with or without CORS)"""
        response = requests.options(f"{BASE_URL}/api/storage/upload")
        # Server should respond with a valid HTTP response
        # 405 is acceptable if CORS is not configured, 200/204 if it is
        assert response.status_code in [200, 204, 405], \
            f"OPTIONS should return a valid response, got {response.status_code}"


class TestServerHealth:
    """Test server is running and responsive"""

    def test_api_is_reachable(self):
        """API server should be reachable"""
        try:
            response = requests.get(f"{BASE_URL}/api/packages", timeout=10)
            # Any response (even 404) means server is running
            assert True
        except requests.exceptions.ConnectionError:
            pytest.fail("Cannot connect to API server at " + BASE_URL)

    def test_storage_endpoint_base_path(self):
        """Storage controller base path should be accessible"""
        response = requests.get(f"{BASE_URL}/api/storage/finalize")
        # Should not be 404 - the route exists (might require parameters)
        assert response.status_code != 404, "Storage finalize endpoint should exist"
