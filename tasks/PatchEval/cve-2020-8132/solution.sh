cat <<'EOF' > /workspace/fix.patch
diff --git a/index.js b/index.js
index 4fa6231..05c2073 100644
--- a/index.js
+++ b/index.js
@@ -4,8 +4,7 @@ var Promise = require("es6-promise").Promise;
 
 var path = require("path");
 var fs   = require("fs");
-var util = require("util");
-var exec = require("child_process").exec;
+var spawn = require("child-process-promise").spawn;
 
 function PDFImage(pdfFilePath, options) {
   if (!options) options = {};
@@ -23,10 +22,10 @@ function PDFImage(pdfFilePath, options) {
 
 PDFImage.prototype = {
   constructGetInfoCommand: function () {
-    return util.format(
-      "pdfinfo \"%s\"",
-      this.pdfFilePath
-    );
+    return {
+      cmd: "pdfinfo",
+      args: [this.pdfFilePath]
+    };
   },
   parseGetInfoCommandOutput: function (output) {
     var info = {};
@@ -40,20 +39,12 @@ PDFImage.prototype = {
   getInfo: function () {
     var self = this;
     var getInfoCommand = this.constructGetInfoCommand();
-    var promise = new Promise(function (resolve, reject) {
-      exec(getInfoCommand, function (err, stdout, stderr) {
-        if (err) {
-          return reject({
-            message: "Failed to get PDF'S information",
-            error: err,
-            stdout: stdout,
-            stderr: stderr
-          });
-        }
-        return resolve(self.parseGetInfoCommandOutput(stdout));
-      });
+    return new Promise(function (resolve, reject) {
+      spawn(getInfoCommand.cmd, getInfoCommand.args, { capture: [ 'stdout', 'stderr' ]})
+        .then(function (cmdResult) {
+          resolve(self.parseGetInfoCommandOutput(cmdResult.stdout.toString()));
+        }).catch(reject);
     });
-    return promise;
   },
   numberOfPages: function () {
     return this.getInfo().then(function (info) {
@@ -84,46 +75,53 @@ PDFImage.prototype = {
   constructConvertCommandForPage: function (pageNumber) {
     var pdfFilePath = this.pdfFilePath;
     var outputImagePath = this.getOutputImagePathForPage(pageNumber);
-    var convertOptionsString = this.constructConvertOptions();
-    return util.format(
-      "%s %s\"%s[%d]\" \"%s\"",
-      this.useGM ? "gm convert" : "convert",
-      convertOptionsString ? convertOptionsString + " " : "",
-      pdfFilePath, pageNumber, outputImagePath
-    );
+    var convertOptions = this.constructConvertOptions();
+    var args = [];
+    if (convertOptions) args = convertOptions.slice();
+    args.push(pdfFilePath+"["+pageNumber+"]");
+    args.push(outputImagePath);
+
+    return {
+      cmd: this.useGM ? "gm convert" : "convert",
+      args: args
+    };
   },
   constructCombineCommandForFile: function (imagePaths) {
-    return util.format(
-      "%s -append %s \"%s\"",
-      this.useGM ? "gm convert" : "convert",
-      imagePaths.join(' '),
-      this.getOutputImagePathForFile()
-    );
+    var args = imagePaths.slice();
+    args.push(this.getOutputImagePathForFile());
+    args.unshift("-append");
+    return {
+      cmd: this.useGM ? "gm convert" : "convert",
+      args: args
+    };
   },
   constructConvertOptions: function () {
-    return Object.keys(this.convertOptions).sort().map(function (optionName) {
+    var convertOptions = [];
+    Object.keys(this.convertOptions).sort().map(function (optionName) {
       if (this.convertOptions[optionName] !== null) {
-        return optionName + " " + this.convertOptions[optionName];
+        convertOptions.push(optionName);
+        convertOptions.push(this.convertOptions[optionName]);
       } else {
-        return optionName;
+        convertOptions.push(optionName);
       }
-    }, this).join(" ");
+    }, this);
+    return convertOptions;
   },
   combineImages: function(imagePaths) {
     var pdfImage = this;
     var combineCommand = pdfImage.constructCombineCommandForFile(imagePaths);
     return new Promise(function (resolve, reject) {
-      exec(combineCommand, function (err, stdout, stderr) {
-        if (err) {
-          return reject({
+      spawn(combineCommand.cmd, combineCommand.args, { capture: [ 'stdout', 'stderr' ]})
+        .then(function () {
+          spawn("rm", imagePaths); //cleanUp
+          resolve(pdfImage.getOutputImagePathForFile());
+        }).catch(function(error){
+          reject({
             message: "Failed to combine images",
-            error: err,
-            stdout: stdout,
-            stderr: stderr
+            error: error.message,
+            stdout: error.stdout,
+            stderr: error.stderr
           });
-        }
-        exec("rm "+imagePaths.join(' ')); //cleanUp
-        return resolve(pdfImage.getOutputImagePathForFile());
       });
     });
   },
@@ -167,16 +165,18 @@ PDFImage.prototype = {
 
     var promise = new Promise(function (resolve, reject) {
       function convertPageToImage() {
-        exec(convertCommand, function (err, stdout, stderr) {
-          if (err) {
-            return reject({
+        return new Promise(function (resolve, reject) {
+          spawn(convertCommand.cmd, convertCommand.args, { capture: [ 'stdout', 'stderr' ]})
+            .then(function () {
+              resolve(outputImagePath);
+            }).catch(function(error){
+            reject({
               message: "Failed to convert page to image",
-              error: err,
-              stdout: stdout,
-              stderr: stderr
+              error: error.message,
+              stdout: error.stdout,
+              stderr: error.stderr
             });
-          }
-          return resolve(outputImagePath);
+          });
         });
       }
 
@@ -194,7 +194,9 @@ PDFImage.prototype = {
 
         if (imageNotExists) {
           // (1)
-          convertPageToImage();
+          convertPageToImage().then(function(result){
+            resolve(result);
+          }).catch(reject);
           return;
         }
 
@@ -209,11 +211,10 @@ PDFImage.prototype = {
 
           if (imageFileStat.mtime < pdfFileStat.mtime) {
             // (2)
-            convertPageToImage();
-            return;
+            convertPageToImage().then(function(result){
+              resolve(result);
+            }).catch(reject);
           }
-
-          return resolve(outputImagePath);
         });
       });
     });
     

EOF

cd /workspace/node-pdf-image
git apply --whitespace=nowarn  /workspace/fix.patch