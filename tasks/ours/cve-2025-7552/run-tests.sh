#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env
fi

# Initialize uv project and add dependencies
uv init 2>/dev/null || true
uv add pytest requests urllib3 2>/dev/null

# Wait for application to be ready
echo "Waiting for Northstar application to start..."
MAX_WAIT=120
WAITED=0

while [ $WAITED -lt $MAX_WAIT ]; do
    # Try to connect to the application
    if curl -s -o /dev/null -w "%{http_code}" "http://localhost:80/northstar/auth/login" 2>/dev/null | grep -qE "^[0-9]+$"; then
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:80/northstar/auth/login" 2>/dev/null)
        if [ "$HTTP_CODE" != "000" ]; then
            echo "Application is ready! (HTTP $HTTP_CODE)"
            break
        fi
    fi

    # Also try a protected endpoint
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:80/northstar/log" 2>/dev/null || echo "000")
    if [ "$HTTP_CODE" == "401" ]; then
        echo "Application is ready! (Protected endpoint returns 401)"
        break
    fi

    echo "Waiting for application... ($WAITED/$MAX_WAIT seconds)"
    sleep 2
    WAITED=$((WAITED + 2))
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo "Warning: Application may not be fully ready after ${MAX_WAIT} seconds"
    echo "Proceeding with tests anyway..."
fi

# Run pytest
echo ""
echo "Running tests..."
uv run pytest . -rA -v
