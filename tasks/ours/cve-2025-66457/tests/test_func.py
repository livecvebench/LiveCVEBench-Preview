"""
Functionality Tests for Elysia Application

These tests verify that the application works correctly with normal operations.
They should PASS in both vulnerable and fixed states.
"""

import subprocess
import time
import requests
import pytest


BASE_URL = "http://localhost:3000"
MAX_RETRIES = 30
RETRY_DELAY = 1


def wait_for_server():
    """Wait for the server to be ready."""
    for i in range(MAX_RETRIES):
        try:
            response = requests.get(f"{BASE_URL}/health", timeout=2)
            if response.status_code == 200:
                return True
        except requests.exceptions.ConnectionError:
            pass
        except requests.exceptions.Timeout:
            pass
        time.sleep(RETRY_DELAY)
    return False


class TestBasicFunctionality:
    """Test that basic application functionality works."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before each test."""
        assert wait_for_server(), "Server did not start in time"

    def test_health_endpoint(self):
        """Test that the health endpoint responds correctly."""
        response = requests.get(f"{BASE_URL}/health")
        assert response.status_code == 200
        data = response.json()
        assert data.get("status") == "ok"

    def test_root_endpoint(self):
        """Test that the root endpoint responds correctly."""
        response = requests.get(f"{BASE_URL}/")
        assert response.status_code == 200
        assert "Hello" in response.text or "hello" in response.text.lower()

    def test_multiple_requests(self):
        """Test that the server handles multiple requests correctly."""
        for i in range(5):
            response = requests.get(f"{BASE_URL}/")
            assert response.status_code == 200

    def test_concurrent_requests(self):
        """Test that the server handles concurrent requests."""
        import concurrent.futures

        def make_request():
            return requests.get(f"{BASE_URL}/health")

        with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
            futures = [executor.submit(make_request) for _ in range(10)]
            results = [f.result() for f in concurrent.futures.as_completed(futures)]

        for response in results:
            assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
