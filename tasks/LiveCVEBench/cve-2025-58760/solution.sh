#!/bin/bash
set -e
cd /app

echo "Applying fix for path traversal issue in image serving..."

# Fix 1: Add is_subdir() function to helpers.py
# This function validates that a child path is within a parent directory
if ! grep -q "def is_subdir" /app/plexpy/helpers.py; then
    echo "Adding is_subdir() function to helpers.py..."
    cat >> /app/plexpy/helpers.py << 'EOF'


def is_subdir(child: str, parent: str) -> bool:
    child = os.path.abspath(child)
    parent = os.path.abspath(parent)
    return os.path.commonpath([parent]) == os.path.commonpath([parent, child])
EOF
    echo "Added is_subdir() function."
else
    echo "is_subdir() function already exists."
fi

# Fix 2: Update the image() function in webserve.py
echo "Updating image() function in webserve.py..."

python3 << 'PYTHON_FIX'
import re

webserve_path = "/app/plexpy/webserve.py"

with open(webserve_path, 'r') as f:
    content = f.read()

# Fix the image() function
# Original vulnerable code
old_image_pattern = r'''if len\(args\) >= 2 and args\[0\] == 'images':
                resource_dir = os\.path\.join\(str\(plexpy\.PROG_DIR\), 'data/interfaces/default/'\)
                try:
                    return serve_file\(path=os\.path\.join\(resource_dir, \*args\), content_type='image/png'\)'''

new_image_code = '''if len(args) >= 2 and args[0] == 'images':
                resource_dir = os.path.join(plexpy.PROG_DIR, 'data/interfaces/default')
                img_path = os.path.join(resource_dir, *args)
                if not helpers.is_subdir(img_path, resource_dir):
                    return

                try:
                    return serve_file(path=img_path, content_type='image/png')'''

content = re.sub(old_image_pattern, new_image_code, content)

# Fix the real_pms_image_proxy() function
# Original vulnerable code
old_proxy_pattern = r'''if isinstance\(img, str\) and img\.startswith\('interfaces/default/images'\):
            fp = os\.path\.join\(plexpy\.PROG_DIR, 'data', img\)
            ext = img\.rsplit\("\.", 1\)\[-1\]
            if ext == 'svg':
                content_type = 'image/svg\+xml'
            else:
                content_type = 'image/\{\}'\.format\(ext\)
            return serve_file\(path=fp, content_type=content_type\)'''

new_proxy_code = '''if isinstance(img, str) and img.startswith('interfaces/default/images'):
            resource_dir = os.path.join(plexpy.PROG_DIR, 'data/interfaces/default/images')
            img_path = os.path.join(plexpy.PROG_DIR, 'data', img)
            if not helpers.is_subdir(img_path, resource_dir):
                return

            ext = img.rsplit(".", 1)[-1]
            if ext == 'svg':
                content_type = 'image/svg+xml'
            else:
                content_type = 'image/{}'.format(ext)
            return serve_file(path=img_path, content_type=content_type)'''

content = re.sub(old_proxy_pattern, new_proxy_code, content)

with open(webserve_path, 'w') as f:
    f.write(content)

print("webserve.py updated successfully.")
PYTHON_FIX

echo "Fix applied successfully."

# Restart Tautulli to pick up the changes
echo "Restarting Tautulli service..."

# Find and kill Tautulli Python process using shell
# Note: pkill may not be available in slim images
for pid in $(ls /proc | grep '^[0-9]*$'); do
    if [ "$pid" != "1" ] && [ -f "/proc/$pid/cmdline" ]; then
        cmdline=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ')
        if echo "$cmdline" | grep -q "Tautulli.py"; then
            echo "Killing Tautulli process $pid"
            kill -TERM "$pid" 2>/dev/null || true
        fi
    fi
done

# Wait for process to die and restart
sleep 3

# Wait for Tautulli to be ready on port 8181 (up to 60 seconds)
echo "Waiting for Tautulli to restart..."
for i in $(seq 1 60); do
    if curl -s --max-time 2 http://localhost:8181/ > /dev/null 2>&1; then
        echo "Tautulli is ready."
        break
    fi
    if [ $i -eq 60 ]; then
        echo "Warning: Tautulli may not be fully ready yet."
    fi
    sleep 1
done

echo "Fix complete."
