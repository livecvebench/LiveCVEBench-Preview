#!/bin/bash
set -e
cd /var/www/html

echo "Applying fix for SQL injection vulnerability in product management..."

# Fix 1: Update ProdutoDAO.php - Replace vulnerable query with prepared statement
# The vulnerable code uses direct string concatenation in the incluir() method
# We need to replace it with parameterized queries

DAO_FILE="/var/www/html/dao/ProdutoDAO.php"

if [ -f "$DAO_FILE" ]; then
    echo "Fixing $DAO_FILE..."

    # Check if file still has the vulnerable pattern
    if grep -q '\$pdo->query("SELECT id_produto, oculto FROM produto WHERE descricao=' "$DAO_FILE"; then
        # Create a PHP script to do the replacement more reliably
        cat > /tmp/fix_dao.php << 'FIXEOF'
<?php
$file = '/var/www/html/dao/ProdutoDAO.php';
$content = file_get_contents($file);

// Pattern to find the vulnerable query
$vulnerable_pattern = '/\$existente = \$pdo->query\("SELECT id_produto, oculto FROM produto WHERE descricao=\'" \. \$produto->getDescricao\(\) \. "\'"\)->fetch\(PDO::FETCH_ASSOC\);/';

// Fixed code with prepared statement
$fixed_code = '$stmtExistente = $pdo->prepare("SELECT id_produto, oculto FROM produto WHERE descricao=:descricao");
			$stmtExistente->bindValue(\':descricao\', $produto->getDescricao(), PDO::PARAM_STR);
			$stmtExistente->execute();
			$existente = $stmtExistente->fetch(PDO::FETCH_ASSOC);';

$content = preg_replace($vulnerable_pattern, $fixed_code, $content);

file_put_contents($file, $content);
echo "DAO fix applied.\n";
FIXEOF

        php /tmp/fix_dao.php
        rm /tmp/fix_dao.php
    else
        echo "DAO file already appears to be fixed or has different format."
    fi
else
    echo "Warning: $DAO_FILE not found"
fi

# Fix 2: Update Produto.php - Add input sanitization to setDescricao method
PRODUTO_FILE="/var/www/html/classes/Produto.php"

if [ -f "$PRODUTO_FILE" ]; then
    echo "Fixing $PRODUTO_FILE..."

    # Check if file still has the vulnerable pattern (no sanitization)
    if grep -q '\$this->descricao = \$descricao;' "$PRODUTO_FILE" && ! grep -q 'filter_var.*descricao.*FILTER_SANITIZE' "$PRODUTO_FILE"; then
        # Replace the direct assignment with sanitized version
        sed -i 's/\$this->descricao = \$descricao;/$this->descricao = filter_var($descricao, FILTER_SANITIZE_SPECIAL_CHARS);/g' "$PRODUTO_FILE"
        echo "Produto.php sanitization fix applied."
    else
        echo "Produto.php already appears to be fixed."
    fi

    # Also fix setCodigo if it has similar issue
    if grep -q '\$this->codigo = \$codigo;' "$PRODUTO_FILE" && ! grep -q 'filter_var.*codigo.*FILTER_SANITIZE' "$PRODUTO_FILE"; then
        sed -i 's/\$this->codigo = \$codigo;/$this->codigo = filter_var($codigo, FILTER_SANITIZE_SPECIAL_CHARS);/g' "$PRODUTO_FILE"
        echo "Produto.php codigo sanitization fix applied."
    fi
else
    echo "Warning: $PRODUTO_FILE not found"
fi

# Verify fixes were applied
echo ""
echo "Verifying fixes..."

if [ -f "$DAO_FILE" ]; then
    if grep -q 'prepare.*SELECT id_produto, oculto FROM produto WHERE descricao=:descricao' "$DAO_FILE"; then
        echo "SUCCESS: ProdutoDAO.php now uses prepared statements"
    elif grep -q '\$pdo->query("SELECT id_produto, oculto FROM produto WHERE descricao=' "$DAO_FILE"; then
        echo "WARNING: ProdutoDAO.php still has vulnerable query pattern"
    else
        echo "INFO: ProdutoDAO.php query pattern changed (verify manually)"
    fi
fi

if [ -f "$PRODUTO_FILE" ]; then
    if grep -q 'filter_var.*FILTER_SANITIZE_SPECIAL_CHARS' "$PRODUTO_FILE"; then
        echo "SUCCESS: Produto.php now sanitizes input"
    else
        echo "WARNING: Produto.php may not have sanitization applied"
    fi
fi

# Restart PHP/Apache if running - use service restart instead of pkill
echo ""
echo "Restarting web server to apply changes..."
if command -v apachectl &> /dev/null; then
    apachectl graceful || true
elif command -v apache2ctl &> /dev/null; then
    apache2ctl graceful || true
fi

echo ""
echo "Fix applied successfully!"
