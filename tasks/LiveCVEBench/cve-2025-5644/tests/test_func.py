#!/usr/bin/env python3
"""Functionality tests for radiff2 - verify basic operations work correctly."""

import subprocess
import tempfile
import os
import pytest


class TestRadiff2Exists:
    """Test that radiff2 binary is available and accessible."""

    def test_radiff2_in_path(self):
        """Verify radiff2 binary exists and is executable."""
        result = subprocess.run(['which', 'radiff2'], capture_output=True, text=True)
        assert result.returncode == 0, f"radiff2 not found in PATH: {result.stderr}"

    def test_radiff2_executable(self):
        """Verify radiff2 can be executed."""
        result = subprocess.run(['radiff2'], capture_output=True, text=True)
        # radiff2 with no arguments will return non-zero, but shouldn't crash
        assert result.returncode in [0, 1], f"radiff2 execution failed unexpectedly"


class TestRadiff2Version:
    """Test radiff2 version and help output."""

    def test_version_output(self):
        """Verify radiff2 -v shows version information."""
        result = subprocess.run(['radiff2', '-v'], capture_output=True, text=True)
        assert result.returncode == 0, f"radiff2 -v failed: {result.stderr}"
        output = result.stdout.lower() + result.stderr.lower()
        assert 'radare2' in output or '5.9' in output or 'radiff2' in output, \
            f"Version output doesn't contain expected version info: {result.stdout}"

    def test_help_output(self):
        """Verify radiff2 -h shows help including -T flag."""
        result = subprocess.run(['radiff2', '-h'], capture_output=True, text=True)
        output = result.stdout + result.stderr
        # Help should mention the -T flag
        assert '-T' in output, f"Help output doesn't mention -T flag: {output}"


class TestRadiff2BasicDiff:
    """Test basic diff functionality without threading."""

    @pytest.fixture
    def test_files(self):
        """Create temporary test files for diffing."""
        with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f1:
            f1.write(b'\x7fELF\x01\x01\x01\x00' + b'\x00' * 8 + b'AAAA' * 100)
            file1 = f1.name

        with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f2:
            f2.write(b'\x7fELF\x01\x01\x01\x00' + b'\x00' * 8 + b'BBBB' * 100)
            file2 = f2.name

        yield file1, file2

        # Cleanup
        os.unlink(file1)
        os.unlink(file2)

    def test_basic_diff_completes(self, test_files):
        """Verify basic diff operation completes without crashing."""
        file1, file2 = test_files
        result = subprocess.run(
            ['radiff2', file1, file2],
            capture_output=True,
            timeout=30
        )
        # Should complete without crashing (return code 0 or 1 is acceptable)
        assert result.returncode in [0, 1], \
            f"radiff2 basic diff returned unexpected code: {result.returncode}"

    def test_identical_files(self):
        """Verify diffing identical files works."""
        with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f:
            f.write(b'\x7fELF\x01\x01\x01\x00' + b'SAME' * 50)
            filename = f.name

        try:
            result = subprocess.run(
                ['radiff2', filename, filename],
                capture_output=True,
                timeout=30
            )
            assert result.returncode in [0, 1], \
                f"radiff2 on identical files failed: {result.returncode}"
        finally:
            os.unlink(filename)

    def test_diff_with_options(self, test_files):
        """Verify diff works with various command line options."""
        file1, file2 = test_files

        # Test with -q (quiet mode)
        result = subprocess.run(
            ['radiff2', '-q', file1, file2],
            capture_output=True,
            timeout=30
        )
        assert result.returncode in [0, 1], \
            f"radiff2 -q failed: {result.returncode}"


class TestRadiff2EdgeCases:
    """Test edge cases for robustness."""

    def test_empty_files(self):
        """Verify handling of empty files."""
        with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f1:
            f1.write(b'')
            file1 = f1.name

        with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f2:
            f2.write(b'')
            file2 = f2.name

        try:
            result = subprocess.run(
                ['radiff2', file1, file2],
                capture_output=True,
                timeout=30
            )
            # Should handle gracefully, not crash
            assert result.returncode in [0, 1, 255], \
                f"radiff2 on empty files crashed: {result.returncode}"
        finally:
            os.unlink(file1)
            os.unlink(file2)

    def test_nonexistent_file(self):
        """Verify handling of nonexistent files."""
        result = subprocess.run(
            ['radiff2', '/nonexistent/file1', '/nonexistent/file2'],
            capture_output=True,
            timeout=30
        )
        # Should return error but not crash with segfault
        # Segfault is typically -11 or 139
        assert result.returncode not in [-11, 139, 134], \
            f"radiff2 crashed on nonexistent files: {result.returncode}"


class TestThreadingFlagExists:
    """Test that threading flag (-T) is available and works."""

    @pytest.fixture
    def test_files(self):
        """Create temporary test files for diffing."""
        with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f1:
            f1.write(b'\x7fELF\x01\x01\x01\x00' + b'\x00' * 8 + b'TEST1' * 50)
            file1 = f1.name

        with tempfile.NamedTemporaryFile(mode='wb', suffix='.bin', delete=False) as f2:
            f2.write(b'\x7fELF\x01\x01\x01\x00' + b'\x00' * 8 + b'TEST2' * 50)
            file2 = f2.name

        yield file1, file2

        # Cleanup
        os.unlink(file1)
        os.unlink(file2)

    def test_threading_mode_completes(self, test_files):
        """Verify threading mode completes without hanging."""
        file1, file2 = test_files

        try:
            result = subprocess.run(
                ['radiff2', '-T', file1, file2],
                capture_output=True,
                timeout=30  # Should complete within 30 seconds
            )
            # Should complete without hanging
            # Return code doesn't matter as long as it finishes
            assert True
        except subprocess.TimeoutExpired:
            pytest.fail("radiff2 with -T flag hung/timed out")

    def test_no_warning_without_threading_flag(self, test_files):
        """Verify warning is NOT shown when -T is not used (both versions)."""
        file1, file2 = test_files

        result = subprocess.run(
            ['radiff2', file1, file2],
            capture_output=True,
            text=True,
            timeout=30
        )

        output = result.stdout + result.stderr

        # Warning should NOT appear when -T is not used
        warning_fragments = [
            "Threading support is experimental",
            "known to be crashy",
        ]
        warning_found = any(fragment in output for fragment in warning_fragments)

        assert not warning_found, (
            f"Warning appeared without -T flag, which is unexpected.\n"
            f"output: {output}"
        )


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
