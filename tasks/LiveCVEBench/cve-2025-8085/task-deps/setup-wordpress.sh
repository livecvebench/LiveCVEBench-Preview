#!/bin/bash
set -e

# This script runs setup after WordPress container is ready
# Wait for WordPress to be fully initialized by the docker-entrypoint

echo "Waiting for WordPress to be ready..."

# Wait for Apache to be running and WordPress to be accessible
for i in {1..60}; do
    if curl -s http://localhost/wp-admin/install.php > /dev/null 2>&1 || curl -s http://localhost/ > /dev/null 2>&1; then
        echo "WordPress web server is ready!"
        break
    fi
    echo "Waiting... ($i/60)"
    sleep 2
done

# Function to run wp-cli commands
wp_cli() {
    wp "$@" --allow-root --path=/var/www/html
}

# Wait for database connection
echo "Waiting for database..."
while ! mysqladmin ping -h"$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" --silent 2>/dev/null; do
    sleep 2
done
echo "Database is ready!"

# Check if WordPress is already installed
if ! wp_cli core is-installed 2>/dev/null; then
    echo "Installing WordPress..."

    # Create wp-config.php if not present
    if [ ! -f /var/www/html/wp-config.php ]; then
        wp_cli config create \
            --dbname="$WORDPRESS_DB_NAME" \
            --dbuser="$WORDPRESS_DB_USER" \
            --dbpass="$WORDPRESS_DB_PASSWORD" \
            --dbhost="$WORDPRESS_DB_HOST" \
            --skip-check
    fi

    # Install WordPress
    wp_cli core install \
        --url="http://localhost" \
        --title="Test WordPress Site" \
        --admin_user="admin" \
        --admin_password="admin123" \
        --admin_email="admin@localhost.local" \
        --skip-email

    echo "WordPress installed successfully!"
fi

# Update site URLs
wp_cli option update siteurl "http://localhost" 2>/dev/null || true
wp_cli option update home "http://localhost" 2>/dev/null || true

# Install and activate Ditty plugin if not already active
if ! wp_cli plugin is-active ditty-news-ticker 2>/dev/null; then
    echo "Activating Ditty plugin..."

    if [ -d /var/www/html/wp-content/plugins/ditty-news-ticker ]; then
        wp_cli plugin activate ditty-news-ticker
        echo "Ditty plugin activated!"
    else
        echo "ERROR: Ditty plugin not found!"
        exit 1
    fi
fi

# Flush rewrite rules to ensure REST API works
wp_cli rewrite structure '/%postname%/' 2>/dev/null || true
wp_cli rewrite flush 2>/dev/null || true

echo "WordPress is ready with Ditty plugin!"
