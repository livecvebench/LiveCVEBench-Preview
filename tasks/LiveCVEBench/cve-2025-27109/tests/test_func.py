"""
Functional tests for Solid.js SSR application.
These tests verify that the application works correctly and renders content properly.
Tests should PASS in both vulnerable and fixed states.
"""

import subprocess
import requests
import time
import pytest
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:3000")


def wait_for_server(url, timeout=30):
    """Wait for server to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(url, timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(1)
    return False


class TestServerFunctionality:
    """Test that the server is running and responding correctly."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(BASE_URL), f"Server at {BASE_URL} not available"

    def test_server_responds(self):
        """Test that server responds to basic requests."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200
        assert len(response.text) > 0

    def test_server_returns_html(self):
        """Test that server returns valid HTML content."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200
        # Should contain basic HTML structure
        assert "<html" in response.text.lower() or "<!doctype" in response.text.lower() or "<body" in response.text.lower()


class TestBasicRendering:
    """Test basic text rendering functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(BASE_URL), f"Server at {BASE_URL} not available"

    def test_plain_text_renders(self):
        """Test that plain text content renders correctly."""
        response = requests.get(f"{BASE_URL}/?text=Hello%20World")
        assert response.status_code == 200
        assert "Hello World" in response.text

    def test_numeric_content_renders(self):
        """Test that numeric content renders correctly."""
        response = requests.get(f"{BASE_URL}/?text=12345")
        assert response.status_code == 200
        assert "12345" in response.text

    def test_special_characters_render(self):
        """Test that non-HTML special characters render correctly."""
        response = requests.get(f"{BASE_URL}/?text=Hello%21%20%40%23%24%25")
        assert response.status_code == 200
        # Should contain the special characters (URL decoded)
        assert "Hello" in response.text

    def test_empty_text_parameter(self):
        """Test that empty text parameter works."""
        response = requests.get(f"{BASE_URL}/?text=")
        assert response.status_code == 200

    def test_unicode_content_renders(self):
        """Test that unicode content renders correctly."""
        # URL encode unicode characters
        response = requests.get(f"{BASE_URL}/?text=%E4%B8%AD%E6%96%87")  # Chinese: 中文
        assert response.status_code == 200

    def test_long_content_renders(self):
        """Test that long content renders correctly."""
        long_text = "A" * 500
        response = requests.get(f"{BASE_URL}/?text={long_text}")
        assert response.status_code == 200
        # Should contain some of the repeated content
        assert "AAA" in response.text


class TestDefaultBehavior:
    """Test default behavior when no parameters are provided."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(BASE_URL), f"Server at {BASE_URL} not available"

    def test_no_parameters(self):
        """Test that server handles requests with no parameters."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200

    def test_missing_text_parameter(self):
        """Test that server handles missing text parameter."""
        response = requests.get(f"{BASE_URL}/?other=value")
        assert response.status_code == 200


class TestResponseFormat:
    """Test the format of server responses."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(BASE_URL), f"Server at {BASE_URL} not available"

    def test_response_content_type(self):
        """Test that response has appropriate content type."""
        response = requests.get(BASE_URL)
        content_type = response.headers.get('content-type', '')
        # Should be HTML or text
        assert 'text/html' in content_type or 'text/plain' in content_type or len(response.text) > 0

    def test_response_is_complete_html(self):
        """Test that response appears to be complete HTML."""
        response = requests.get(f"{BASE_URL}/?text=test")
        # Should have opening and/or closing tags
        text = response.text.lower()
        assert "<body" in text or "</body" in text or "<html" in text or "<!doctype" in text
