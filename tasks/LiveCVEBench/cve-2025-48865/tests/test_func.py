#!/usr/bin/env python3
"""
Functional tests for Fabio HTTP proxy.
These tests verify that Fabio correctly adds forwarding headers to proxied requests.
These tests should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os

# Fabio proxy URL (default port 9999)
FABIO_URL = os.environ.get("FABIO_URL", "http://localhost:9999")
# Backend server URL for checking received headers
BACKEND_URL = os.environ.get("BACKEND_URL", "http://localhost:8080")

# Timeout for HTTP requests
REQUEST_TIMEOUT = 10


def wait_for_service(url, max_retries=30, delay=1):
    """Wait for a service to become available."""
    for i in range(max_retries):
        try:
            response = requests.get(url, timeout=2)
            return True
        except requests.exceptions.RequestException:
            if i < max_retries - 1:
                time.sleep(delay)
    return False


@pytest.fixture(scope="module", autouse=True)
def setup_services():
    """Ensure services are available before running tests."""
    if not wait_for_service(FABIO_URL):
        pytest.skip(f"Fabio proxy not available at {FABIO_URL}")
    if not wait_for_service(BACKEND_URL):
        pytest.skip(f"Backend server not available at {BACKEND_URL}")


class TestForwardingHeadersPresent:
    """Test that Fabio adds required forwarding headers in normal operation."""

    def test_x_real_ip_header_present(self):
        """Test that X-Real-Ip header is added by Fabio."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        # X-Real-Ip should be present
        assert "X-Real-Ip" in received_headers or "x-real-ip" in {k.lower(): v for k, v in received_headers.items()}, \
            "X-Real-Ip header should be present in proxied request"

    def test_x_forwarded_host_header_present(self):
        """Test that X-Forwarded-Host header is added by Fabio."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        # Normalize header keys to lowercase for comparison
        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        assert "x-forwarded-host" in headers_lower, \
            "X-Forwarded-Host header should be present in proxied request"

    def test_x_forwarded_port_header_present(self):
        """Test that X-Forwarded-Port header is added by Fabio."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        assert "x-forwarded-port" in headers_lower, \
            "X-Forwarded-Port header should be present in proxied request"

    def test_x_forwarded_proto_header_present(self):
        """Test that X-Forwarded-Proto header is added by Fabio."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        assert "x-forwarded-proto" in headers_lower, \
            "X-Forwarded-Proto header should be present in proxied request"

    def test_forwarded_header_present(self):
        """Test that Forwarded header is added by Fabio."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        assert "forwarded" in headers_lower, \
            "Forwarded header should be present in proxied request"


class TestForwardedHeaderFormat:
    """Test that forwarding headers have correct format."""

    def test_forwarded_header_contains_for_directive(self):
        """Test Forwarded header contains 'for=' directive."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        forwarded = headers_lower.get("forwarded", "")
        assert "for=" in forwarded, \
            "Forwarded header should contain 'for=' directive"

    def test_forwarded_header_contains_proto_directive(self):
        """Test Forwarded header contains 'proto=' directive."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        forwarded = headers_lower.get("forwarded", "")
        assert "proto=" in forwarded, \
            "Forwarded header should contain 'proto=' directive"

    def test_x_forwarded_proto_has_valid_value(self):
        """Test X-Forwarded-Proto has a valid protocol value."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        proto = headers_lower.get("x-forwarded-proto", "")
        assert proto in ["http", "https"], \
            f"X-Forwarded-Proto should be 'http' or 'https', got: {proto}"


class TestProxyBasicFunctionality:
    """Test basic proxy functionality."""

    def test_proxy_returns_success(self):
        """Test that proxy successfully forwards requests."""
        response = requests.get(
            f"{FABIO_URL}/",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200

    def test_proxy_with_path(self):
        """Test that proxy correctly forwards requests with paths."""
        response = requests.get(
            f"{FABIO_URL}/test/path",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200

    def test_proxy_with_query_params(self):
        """Test that proxy correctly forwards query parameters."""
        response = requests.get(
            f"{FABIO_URL}/query?param1=value1&param2=value2",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200

    def test_proxy_with_custom_headers(self):
        """Test that proxy forwards custom headers."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"X-Custom-Header": "test-value"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        received_headers = data.get("headers", {})

        headers_lower = {k.lower(): v for k, v in received_headers.items()}
        assert headers_lower.get("x-custom-header") == "test-value"


class TestConnectionHeaderNormalBehavior:
    """Test that legitimate Connection header directives work."""

    def test_keep_alive_connection(self):
        """Test that Connection: keep-alive works normally."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200

    def test_close_connection(self):
        """Test that Connection: close works normally."""
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "close"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
