#!/usr/bin/env python3
"""
Functionality tests for URL Shortify plugin.
These tests verify that the core functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import re
import time

BASE_URL = "http://localhost"
ADMIN_USER = "admin"
ADMIN_PASS = "admin"


class WordPressSession:
    """Helper class to handle WordPress admin authentication."""

    def __init__(self, base_url=BASE_URL):
        self.base_url = base_url
        self.session = requests.Session()
        self.logged_in = False

    def login(self, username=ADMIN_USER, password=ADMIN_PASS):
        """Login to WordPress admin."""
        login_url = f"{self.base_url}/wp-login.php"

        # Get the login page to retrieve any necessary cookies
        self.session.get(login_url)

        # Perform login
        login_data = {
            "log": username,
            "pwd": password,
            "wp-submit": "Log In",
            "redirect_to": f"{self.base_url}/wp-admin/",
            "testcookie": "1"
        }

        response = self.session.post(login_url, data=login_data, allow_redirects=True)

        # Check if login was successful
        if "wordpress_logged_in" in str(self.session.cookies) or "/wp-admin/" in response.url:
            self.logged_in = True
            return True

        return False

    def get(self, url, **kwargs):
        """Perform authenticated GET request."""
        if not self.logged_in:
            self.login()
        return self.session.get(url, **kwargs)

    def post(self, url, **kwargs):
        """Perform authenticated POST request."""
        if not self.logged_in:
            self.login()
        return self.session.post(url, **kwargs)


def get_nonce_from_page(html_content, nonce_name="_wpnonce"):
    """Extract WordPress nonce from page HTML."""
    # Look for nonce in hidden input
    pattern = rf'name="{nonce_name}"[^>]*value="([^"]+)"'
    match = re.search(pattern, html_content)
    if match:
        return match.group(1)

    # Alternative pattern
    pattern = rf'value="([^"]+)"[^>]*name="{nonce_name}"'
    match = re.search(pattern, html_content)
    if match:
        return match.group(1)

    return None


class TestPluginFunctionality:
    """Test core functionality of URL Shortify plugin."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Setup test fixtures."""
        self.wp = WordPressSession()
        self.wp.login()

    def test_plugin_is_active(self):
        """Verify URL Shortify plugin is installed and active."""
        response = self.wp.get(f"{BASE_URL}/wp-admin/plugins.php")
        assert response.status_code == 200
        # Check if URL Shortify appears in plugins list
        assert "url-shortify" in response.text.lower() or "URL Shortify" in response.text

    def test_links_page_loads(self):
        """Verify the links management page loads correctly."""
        response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=us_links")
        assert response.status_code == 200
        # Should contain some indication we're on the links page
        assert "us_links" in response.text or "Links" in response.text

    def test_add_new_link_page_loads(self):
        """Verify the add new link form page loads correctly."""
        response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=us_links&action=new")
        assert response.status_code == 200
        # Should have a form for adding links
        assert "form" in response.text.lower()
        assert "url" in response.text.lower() or "URL" in response.text

    def test_groups_page_loads(self):
        """Verify the groups management page loads correctly."""
        response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=us_groups")
        assert response.status_code == 200
        assert "us_groups" in response.text or "Groups" in response.text

    def test_add_new_group_page_loads(self):
        """Verify the add new group form page loads correctly."""
        response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=us_groups&action=new")
        assert response.status_code == 200
        assert "form" in response.text.lower()

    def test_link_creation_via_post(self):
        """Test that link creation via proper POST form submission works."""
        # First, get the form page to retrieve nonce
        form_response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=us_links&action=new")
        assert form_response.status_code == 200

        nonce = get_nonce_from_page(form_response.text)

        if nonce:
            # Create a unique slug for this test
            test_slug = f"test-link-{int(time.time())}"

            # Submit form data via POST
            form_data = {
                "_wpnonce": nonce,
                "form_data[url]": "https://example.com/test",
                "form_data[slug]": test_slug,
                "form_data[cpt_id]": "",
                "form_data[name]": "Test Link",
                "form_data[description]": "A test link",
                "submitted": "submitted",
                "submit": "Save Link"
            }

            response = self.wp.post(
                f"{BASE_URL}/wp-admin/admin.php?page=us_links&action=new",
                data=form_data,
                allow_redirects=True
            )

            # Should either succeed (redirect) or show the form again
            assert response.status_code == 200

    def test_clean_form_data_in_normal_use(self):
        """Test that normal form data is handled correctly without special characters."""
        response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=us_links&action=new")
        assert response.status_code == 200

        # Check that the form_data[cpt_id] field exists and is empty or has clean value
        assert 'name="form_data[cpt_id]"' in response.text

        # The value should be empty or a valid ID (not contain HTML tags)
        cpt_pattern = r'name="form_data\[cpt_id\]"[^>]*value="([^"]*)"'
        match = re.search(cpt_pattern, response.text)
        if match:
            value = match.group(1)
            # Should not contain script tags or HTML
            assert "<script>" not in value
            assert "<" not in value or ">" not in value

    def test_dashboard_page_loads(self):
        """Verify the plugin dashboard page loads correctly."""
        # The dashboard uses 'url_shortify' slug (same as main menu)
        response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=url_shortify")
        assert response.status_code == 200

    def test_settings_page_loads(self):
        """Verify the plugin settings page loads correctly."""
        # Settings is accessed via the main dashboard page with Settings tab
        # or via Freemius account page. The main dashboard page should work.
        response = self.wp.get(f"{BASE_URL}/wp-admin/admin.php?page=url_shortify")
        assert response.status_code == 200
        # Check that we're on the plugin page
        assert "URL Shortify" in response.text or "url_shortify" in response.text


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
