FROM debian:12

WORKDIR /app

# Qt5 display settings (no display needed)
ENV QT_QPA_PLATFORM=offscreen

# System dependencies (tmux, asciinema, curl are required)
# Build dependencies for zuluPolkit
# Runtime dependencies (policykit-1)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    build-essential \
    cmake \
    g++ \
    qtbase5-dev \
    qt5-qmake \
    qtbase5-dev-tools \
    libcryptsetup-dev \
    libpwquality-dev \
    libdevmapper-dev \
    libsecret-1-dev \
    libgcrypt20-dev \
    libblkid-dev \
    libudev-dev \
    uuid-dev \
    chrpath \
    pkg-config \
    policykit-1 \
    python3 \
    && rm -rf /var/lib/apt/lists/*

# Clone zuluCrypt source at vulnerable version 5.5.0
RUN git clone --depth=1 --branch 5.5.0 https://github.com/mhogomchungu/zuluCrypt.git /app \
    && rm -rf /app/.git

# Apply vulnerable configuration (Debian patch equivalent)
# Change auth_admin -> auth_self in PolicyKit policy
RUN sed -i 's/<allow_any>auth_admin<\/allow_any>/<allow_any>auth_self<\/allow_any>/g' /app/zuluPolkit/CMakeLists.txt \
    && sed -i 's/<allow_inactive>auth_admin<\/allow_inactive>/<allow_inactive>auth_self<\/allow_inactive>/g' /app/zuluPolkit/CMakeLists.txt \
    && sed -i 's/<allow_active>auth_admin<\/allow_active>/<allow_active>auth_self<\/allow_active>/g' /app/zuluPolkit/CMakeLists.txt

# Build zuluPolkit from project root
RUN mkdir -p /app/build \
    && cd /app/build \
    && cmake .. \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_DATAROOTDIR=/usr/share \
        -DCMAKE_INSTALL_BINDIR=/usr/bin \
        -DCMAKE_INSTALL_LIBDIR=/usr/lib \
        -DQT5=true \
        -DINTERNAL_ZULUPLAY=false \
    && make zuluPolkit mhogomchungu_task -j$(nproc)

# Install zuluPolkit binary and policy file manually
RUN mkdir -p /usr/share/polkit-1/actions \
    && cp /app/build/org.zulucrypt.zulupolkit.policy /usr/share/polkit-1/actions/ \
    && cp /app/build/zuluPolkit/zuluPolkit /usr/bin/ \
    && chmod +x /usr/bin/zuluPolkit

# Keep container running for testing
CMD ["sleep", "infinity"]
