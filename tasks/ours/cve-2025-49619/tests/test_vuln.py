"""
Vulnerability tests for Skyvern template injection.
These tests verify that template injection attacks are blocked.
Should FAIL in vulnerable state (attack succeeds) and PASS in fixed state (attack blocked).
"""

import subprocess
import sys


def get_template_module_path():
    """Get the path to the template test helper."""
    return "/tests/template_helper.py"


class TestClassHierarchyAccess:
    """Test that access to Python class hierarchy is blocked."""

    def test_class_attribute_access(self):
        """Test that __class__ access is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_class"],
            capture_output=True,
            text=True
        )
        # In fixed state: should block access (SecurityError or empty result)
        # In vulnerable state: would return class info
        assert "tuple" not in result.stdout.lower(), \
            "Vulnerability: __class__ access was allowed"
        assert "class" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: class information was leaked"

    def test_base_class_access(self):
        """Test that __base__ access is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_base"],
            capture_output=True,
            text=True
        )
        # Should not return 'object' which would indicate successful traversal
        assert "object" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: __base__ access was allowed, class hierarchy exposed"

    def test_subclasses_access(self):
        """Test that __subclasses__() access is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_subclasses"],
            capture_output=True,
            text=True
        )
        # Should not return list of subclasses
        assert "warning" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: __subclasses__() access was allowed"
        # Check for signs of successful subclass enumeration
        assert "[<class" not in result.stdout, \
            "Vulnerability: subclasses list was returned"

    def test_mro_access(self):
        """Test that __mro__ access is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_mro"],
            capture_output=True,
            text=True
        )
        # MRO should not be accessible
        assert "object" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: __mro__ access was allowed"


class TestBuiltinAccess:
    """Test that access to Python builtins is blocked."""

    def test_builtins_access(self):
        """Test that __builtins__ access is blocked via lipsum."""
        # Use lipsum.__globals__ which reliably exposes __builtins__
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_lipsum"],
            capture_output=True,
            text=True
        )
        # In vulnerable state: returns globals including __builtins__
        # In fixed state: should block access (SecurityError or empty result)
        assert "__builtins__" not in result.stdout or "security" in result.stdout.lower(), \
            "Vulnerability: __builtins__ access was allowed via lipsum"

    def test_globals_access(self):
        """Test that __globals__ access is blocked via cycler."""
        # Use cycler.__init__.__globals__ which reliably exposes globals
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_cycler"],
            capture_output=True,
            text=True
        )
        # In vulnerable state: returns globals with __builtins__
        # In fixed state: should block access
        assert "__builtins__" not in result.stdout or "security" in result.stdout.lower(), \
            "Vulnerability: __globals__ access was allowed via cycler"


class TestCodeExecution:
    """Test that code execution attempts are blocked."""

    def test_os_popen_via_warning(self):
        """Test the classic warning-based RCE payload is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_rce_warning"],
            capture_output=True,
            text=True
        )
        # Should not execute commands - check for command output markers
        assert "uid=" not in result.stdout, \
            "Vulnerability: Code execution succeeded via warning class"
        assert "root:" not in result.stdout, \
            "Vulnerability: File read via code execution"

    def test_os_import_attempt(self):
        """Test that os module import via SSTI is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_os_import"],
            capture_output=True,
            text=True
        )
        # Should not successfully import os
        assert "posix" not in result.stdout.lower(), \
            "Vulnerability: os module was imported"
        assert "<module" not in result.stdout, \
            "Vulnerability: module import succeeded"

    def test_subprocess_access(self):
        """Test that joiner globals access is blocked (alternative code execution vector)."""
        # Use joiner.__init__.__globals__ as reliable code execution vector
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_joiner"],
            capture_output=True,
            text=True
        )
        # In vulnerable state: returns globals with __builtins__ enabling code exec
        # In fixed state: should block access
        assert "__builtins__" not in result.stdout or "security" in result.stdout.lower(), \
            "Vulnerability: joiner globals access enabled code execution vector"

    def test_file_read_attempt(self):
        """Test that file read via SSTI is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_file_read"],
            capture_output=True,
            text=True
        )
        # Should not read /etc/passwd
        assert "root:" not in result.stdout, \
            "Vulnerability: File read succeeded"
        assert "nobody:" not in result.stdout, \
            "Vulnerability: File read succeeded"


class TestEncodedPayloads:
    """Test that encoded or obfuscated payloads are blocked."""

    def test_attr_filter_bypass(self):
        """Test that attr filter bypass attempts are blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_attr_bypass"],
            capture_output=True,
            text=True
        )
        # Should not allow attribute access via filter
        assert "object" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: attr filter bypass worked"

    def test_request_object_bypass(self):
        """Test getitem-style access is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_getitem"],
            capture_output=True,
            text=True
        )
        # Should not allow dangerous attribute access
        assert "tuple" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: getitem bypass worked"

    def test_string_format_exploit(self):
        """Test that string format exploits are blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_format"],
            capture_output=True,
            text=True
        )
        # Should not leak class info via format
        assert "object" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: string format exploit worked"


class TestMultiStepExploits:
    """Test that multi-step exploitation chains are blocked."""

    def test_config_object_access(self):
        """Test that MRO access is blocked (used for config/object traversal)."""
        # Use MRO to test object traversal capability
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_mro"],
            capture_output=True,
            text=True
        )
        # In vulnerable state: returns MRO including 'object'
        # In fixed state: should block access
        assert "object" not in result.stdout.lower() or "security" in result.stdout.lower(), \
            "Vulnerability: MRO access enabled object traversal"

    def test_lipsum_trick(self):
        """Test that lipsum globals access is blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_lipsum"],
            capture_output=True,
            text=True
        )
        # Should not access globals via lipsum
        assert "__builtins__" not in result.stdout, \
            "Vulnerability: lipsum globals trick worked"

    def test_cycler_exploit(self):
        """Test that cycler-based exploits are blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_cycler"],
            capture_output=True,
            text=True
        )
        # Should not execute via cycler
        assert "__builtins__" not in result.stdout, \
            "Vulnerability: cycler exploit worked"

    def test_joiner_exploit(self):
        """Test that joiner-based exploits are blocked."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "ssti_joiner"],
            capture_output=True,
            text=True
        )
        # Should not access globals via joiner
        assert "__builtins__" not in result.stdout, \
            "Vulnerability: joiner exploit worked"
