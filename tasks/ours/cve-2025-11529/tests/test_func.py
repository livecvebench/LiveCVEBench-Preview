"""
Functional tests for ChurchCRM API middleware.
These tests verify that the application is running correctly and basic API functionality works.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost"
MAX_RETRIES = 30
RETRY_DELAY = 2


def wait_for_application():
    """Wait for the application to be ready."""
    for i in range(MAX_RETRIES):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5, allow_redirects=True)
            if response.status_code in [200, 302, 303]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(RETRY_DELAY)
    return False


@pytest.fixture(scope="module", autouse=True)
def setup_module():
    """Ensure application is ready before running tests."""
    assert wait_for_application(), "Application failed to start within timeout"


class TestApplicationRunning:
    """Test that the application is running and responding."""

    def test_application_responds(self):
        """Verify the application responds to requests."""
        response = requests.get(f"{BASE_URL}/", timeout=10, allow_redirects=True)
        # Application should respond with 200 or redirect to login
        assert response.status_code in [200, 302, 303], \
            f"Expected 200 or redirect, got {response.status_code}"

    def test_api_endpoint_exists(self):
        """Verify that API endpoints exist and respond."""
        # A protected API endpoint should return 401 when not authenticated
        response = requests.get(f"{BASE_URL}/api/persons/latest", timeout=10)
        # Should return either 401 (auth required) or 200 (if somehow auth bypassed)
        # The key is that the endpoint responds
        assert response.status_code in [200, 401], \
            f"Expected 200 or 401, got {response.status_code}"


class TestProtectedEndpointBehavior:
    """Test that protected endpoints require authentication."""

    def test_protected_endpoint_without_auth_returns_401(self):
        """Protected API endpoint should return 401 without authentication."""
        response = requests.get(f"{BASE_URL}/api/persons/latest", timeout=10)
        # This should ALWAYS return 401 for unauthenticated requests
        # (both in vulnerable and fixed state for normal requests)
        assert response.status_code == 401, \
            f"Expected 401 for unauthenticated request, got {response.status_code}"

    def test_protected_endpoint_returns_json_error(self):
        """Protected endpoint should return appropriate error response."""
        response = requests.get(f"{BASE_URL}/api/persons/latest", timeout=10)
        assert response.status_code == 401


class TestPublicEndpointAccess:
    """Test that public endpoints work correctly."""

    def test_root_accessible(self):
        """Root path should be accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=10, allow_redirects=False)
        # Root may redirect to login or show a page
        assert response.status_code in [200, 301, 302, 303], \
            f"Expected success or redirect, got {response.status_code}"