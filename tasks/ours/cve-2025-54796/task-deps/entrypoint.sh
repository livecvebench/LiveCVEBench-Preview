#!/bin/bash

# Entrypoint script for Copyparty
# This script runs the copyparty server in a loop to allow restarts

# Function to upload test files for ReDoS vulnerability testing
upload_test_files() {
    echo "Waiting for server to be ready..."
    for i in {1..30}; do
        if curl -s -o /dev/null -w "%{http_code}" http://localhost:3923/ | grep -q "200"; then
            echo "Server is ready, uploading test files..."
            break
        fi
        sleep 1
    done

    # Create directories on filesystem
    mkdir -p /data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
    mkdir -p /data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb

    # Upload files via HTTP PUT to be tracked in recent uploads
    # These file paths have NO 'x' character to trigger ReDoS with (.+)+x pattern
    curl -s -X PUT -d "test content 1" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/testfile1.dat"
    curl -s -X PUT -d "test content 2" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/testfile2.dat"
    curl -s -X PUT -d "test content 3" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/document.pdf"
    curl -s -X PUT -d "test content 4" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/readme.md"
    curl -s -X PUT -d "test content 5" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/config.json"

    # Upload nested files with even longer paths
    curl -s -X PUT -d "nested content 1" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb/nested1.dat"
    curl -s -X PUT -d "nested content 2" "http://localhost:3923/data/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb/nested2.dat"

    echo "Test files uploaded for ReDoS vulnerability testing"
}

# Start background task to upload files after server is ready
upload_test_files &

while true; do
    echo "Starting copyparty server..."
    python -m copyparty -p 3923 -v /data:/data:rw -e2dsa
    exit_code=$?
    echo "Copyparty exited with code $exit_code, restarting in 2 seconds..."
    sleep 2
done
