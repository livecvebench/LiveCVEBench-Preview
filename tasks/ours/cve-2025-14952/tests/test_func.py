"""
Functional tests for the Supplier Management System.
These tests verify that core functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import requests
import time
import pytest

BASE_URL = "http://localhost"
LOGIN_URL = f"{BASE_URL}/Supply_Management_System/index.php"
ADD_CATEGORY_URL = f"{BASE_URL}/Supply_Management_System/admin/add_category.php"
VIEW_CATEGORY_URL = f"{BASE_URL}/Supply_Management_System/admin/view_category.php"


class TestAdminLogin:
    """Test admin authentication functionality"""

    def get_session(self):
        """Create a fresh session"""
        return requests.Session()

    def test_admin_login_successful(self):
        """Test that admin can login with valid credentials"""
        session = self.get_session()
        data = {
            "txtUsername": "admin",
            "txtPassword": "admin123",
            "login_type": "admin"
        }
        response = session.post(LOGIN_URL, data=data, allow_redirects=True)

        # After successful login, should be at admin area
        assert response.status_code == 200
        # Verify we can access admin pages
        admin_response = session.get(ADD_CATEGORY_URL)
        assert admin_response.status_code == 200
        # Should not redirect back to login
        assert "index.php" not in admin_response.url or "admin" in admin_response.url

    def test_admin_login_invalid_credentials(self):
        """Test that invalid credentials do not grant access"""
        session = self.get_session()
        data = {
            "txtUsername": "admin",
            "txtPassword": "wrongpassword",
            "login_type": "admin"
        }
        response = session.post(LOGIN_URL, data=data, allow_redirects=True)

        # Should not have access to admin area
        admin_response = session.get(ADD_CATEGORY_URL, allow_redirects=False)
        # Should redirect to login page if not authenticated
        assert admin_response.status_code in [200, 302]

    def test_add_category_page_accessible(self):
        """Test that add category page is accessible after login"""
        session = self.get_session()
        data = {
            "txtUsername": "admin",
            "txtPassword": "admin123",
            "login_type": "admin"
        }
        session.post(LOGIN_URL, data=data)

        response = session.get(ADD_CATEGORY_URL)
        assert response.status_code == 200
        assert "Add Category" in response.text


class TestCategoryManagement:
    """Test category management functionality"""

    def get_admin_session(self):
        """Login as admin and return authenticated session"""
        session = requests.Session()
        data = {
            "txtUsername": "admin",
            "txtPassword": "admin123",
            "login_type": "admin"
        }
        session.post(LOGIN_URL, data=data)
        return session

    def test_add_category_with_normal_input(self):
        """Test adding a category with normal alphanumeric input"""
        session = self.get_admin_session()

        # Generate unique category name to avoid duplicates
        unique_name = f"TestCategory_{int(time.time())}"

        data = {
            "txtCategoryName": unique_name,
            "txtCategoryDetails": "This is a test category description"
        }

        response = session.post(ADD_CATEGORY_URL, data=data)
        assert response.status_code == 200
        # Success message should appear or no error
        # The app shows JavaScript alert on success
        assert "Category Added Successfully" in response.text or "Failed" not in response.text

    def test_add_category_with_spaces(self):
        """Test adding a category with spaces in the name"""
        session = self.get_admin_session()

        unique_name = f"Test Category With Spaces {int(time.time())}"

        data = {
            "txtCategoryName": unique_name,
            "txtCategoryDetails": "Description with spaces and more text"
        }

        response = session.post(ADD_CATEGORY_URL, data=data)
        assert response.status_code == 200

    def test_add_category_with_special_html_chars(self):
        """Test adding a category with HTML special characters (not SQL-related)"""
        session = self.get_admin_session()

        # These are HTML special chars, not SQL injection attempts
        unique_name = f"Category <Test> & More {int(time.time())}"

        data = {
            "txtCategoryName": unique_name,
            "txtCategoryDetails": "Details with <html> & entities"
        }

        response = session.post(ADD_CATEGORY_URL, data=data)
        assert response.status_code == 200

    def test_add_category_with_numbers(self):
        """Test adding a category with numeric values"""
        session = self.get_admin_session()

        unique_name = f"Category12345_{int(time.time())}"

        data = {
            "txtCategoryName": unique_name,
            "txtCategoryDetails": "Details 123 456 789"
        }

        response = session.post(ADD_CATEGORY_URL, data=data)
        assert response.status_code == 200

    def test_add_category_empty_details(self):
        """Test adding a category with empty details field"""
        session = self.get_admin_session()

        unique_name = f"CategoryNoDetails_{int(time.time())}"

        data = {
            "txtCategoryName": unique_name,
            "txtCategoryDetails": ""
        }

        response = session.post(ADD_CATEGORY_URL, data=data)
        assert response.status_code == 200

    def test_view_category_page_accessible(self):
        """Test that view category page is accessible and shows content"""
        session = self.get_admin_session()

        response = session.get(VIEW_CATEGORY_URL)
        assert response.status_code == 200
        # Page should contain category-related content
        assert "Category" in response.text or "category" in response.text

    def test_category_form_elements_present(self):
        """Test that the add category form has required elements"""
        session = self.get_admin_session()

        response = session.get(ADD_CATEGORY_URL)
        assert response.status_code == 200

        # Check for form elements
        assert 'name="txtCategoryName"' in response.text
        assert 'name="txtCategoryDetails"' in response.text
        assert 'type="submit"' in response.text


class TestApplicationResponsiveness:
    """Test that the application responds in reasonable time"""

    def get_admin_session(self):
        """Login as admin and return authenticated session"""
        session = requests.Session()
        data = {
            "txtUsername": "admin",
            "txtPassword": "admin123",
            "login_type": "admin"
        }
        session.post(LOGIN_URL, data=data)
        return session

    def test_normal_request_response_time(self):
        """Test that normal requests complete within reasonable time"""
        session = self.get_admin_session()

        unique_name = f"SpeedTest_{int(time.time())}"

        data = {
            "txtCategoryName": unique_name,
            "txtCategoryDetails": "Speed test description"
        }

        start_time = time.time()
        response = session.post(ADD_CATEGORY_URL, data=data)
        elapsed_time = time.time() - start_time

        assert response.status_code == 200
        # Normal requests should complete within 2 seconds
        assert elapsed_time < 2.0, f"Request took too long: {elapsed_time:.2f}s"

    def test_page_load_time(self):
        """Test that page loads are fast"""
        session = self.get_admin_session()

        start_time = time.time()
        response = session.get(ADD_CATEGORY_URL)
        elapsed_time = time.time() - start_time

        assert response.status_code == 200
        assert elapsed_time < 2.0, f"Page load took too long: {elapsed_time:.2f}s"
