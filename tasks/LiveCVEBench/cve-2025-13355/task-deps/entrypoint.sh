#!/bin/bash
set -e

# Function to setup WordPress with plugin after core is ready
setup_wordpress() {
    # Wait for WordPress files to be present (from docker-entrypoint.sh)
    while [ ! -f /var/www/html/wp-load.php ]; do
        echo "Waiting for WordPress files..."
        sleep 2
    done

    # Wait for database to be available
    echo "Waiting for database..."
    while ! mysqladmin ping -h"$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" --silent 2>/dev/null; do
        echo "Database not ready yet, waiting..."
        sleep 2
    done
    echo "Database is ready!"

    # Give MySQL a bit more time to fully initialize
    sleep 3

    # Set up WordPress if not already installed
    if ! wp core is-installed --path=/var/www/html --allow-root 2>/dev/null; then
        echo "Installing WordPress..."

        # Install WordPress (password=admin to match test credentials)
        wp core install \
            --path=/var/www/html \
            --url="http://localhost" \
            --title="CVE Test Site" \
            --admin_user=admin \
            --admin_password=admin \
            --admin_email=admin@test.local \
            --skip-email \
            --allow-root

        echo "WordPress installed successfully!"

        # Activate URL Shortify plugin
        echo "Activating URL Shortify plugin..."
        wp plugin activate url-shortify --path=/var/www/html --allow-root

        # Set up permalinks
        wp rewrite structure '/%postname%/' --path=/var/www/html --allow-root
        wp rewrite flush --path=/var/www/html --allow-root

        # Skip Freemius activation by calling skip_connection() directly
        # This properly sets the anonymous mode in Freemius SDK storage
        echo "Skipping Freemius activation..."
        php -r "
            define('WP_USE_THEMES', false);
            define('WP_ADMIN', true);
            require('/var/www/html/wp-load.php');
            if (function_exists('kc_us_fs')) {
                \$fs = kc_us_fs();
                \$fs->skip_connection();
                echo 'Freemius anonymous mode set successfully';
            } else {
                echo 'Warning: kc_us_fs not found';
            }
        " || true

        echo "Setup complete!"
    else
        echo "WordPress already installed."
    fi
}

# Run setup in background
setup_wordpress &

# Call the original WordPress entrypoint
exec docker-entrypoint.sh apache2-foreground
