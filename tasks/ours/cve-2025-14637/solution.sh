#!/bin/bash
set -e

# Solution script for fixing SQL injection in Online Pet Shop Management System
# This script applies prepared statements to prevent SQL injection

FILE="/var/www/html/pet1/includes/availablepackage.php"

echo "Applying SQL injection fix to $FILE..."

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "Error: File $FILE not found"
    exit 1
fi

# Create backup
cp "$FILE" "${FILE}.bak"

# Create the fixed version of the PHP block
# The fix replaces direct string concatenation with prepared statements
cat > /tmp/fix_patch.php << 'FIXED_CODE'
<?php
include('includes/dbconn.php');
if(isset($_POST['save'])){
    $name = $_POST['cnpname'];
    $prize = $_POST['prize'];
    $des = $_POST['des'];
    $stat = $_POST['stat'];
    //image
    $image = addslashes(file_get_contents($_FILES['image']['tmp_name']));
    $image_name = addslashes($_FILES['image']['name']);
    $image_size = getimagesize($_FILES['image']['tmp_name']);
    //
    move_uploaded_file($_FILES["image"]["tmp_name"], "../upload/" . $_FILES["image"]["name"]);
    $location = "../upload/" . $_FILES["image"]["name"];
    if(empty($name) || empty($prize) || empty($des) || empty($stat)){
        echo '<script>alert("Fields must be empty.");
             window.location.href="addcnp.php";
        </script>';

    }else {
        // Fixed: Use prepared statements to prevent SQL injection
        $sql = "INSERT INTO tblcnp (name, prize, description, image, status) VALUES (?, ?, ?, ?, ?)";
        $stmt = mysqli_prepare($con, $sql);
        mysqli_stmt_bind_param($stmt, "sdsss", $name, $prize, $des, $location, $stat);
        $result = mysqli_stmt_execute($stmt);
        mysqli_stmt_close($stmt);

        if($result==true){
            echo '<script>alert("Save Successfully!");
                window.location.href="addcnp.php";</script>';
        }else {
            echo '<script>alert("Sory unable to process your request!");
                window.location.href="addcnp.php";</script>';
        }
    }
}
?>
FIXED_CODE

# Extract the HTML part (lines 1-54) and combine with fixed PHP
head -n 54 "$FILE" > /tmp/fixed_file.php
cat /tmp/fix_patch.php >> /tmp/fixed_file.php

# Replace the original file
mv /tmp/fixed_file.php "$FILE"

# Clean up
rm -f /tmp/fix_patch.php

echo "Fix applied successfully!"

# Verify the fix was applied by checking for prepared statement
if grep -q "mysqli_prepare" "$FILE" && grep -q "mysqli_stmt_bind_param" "$FILE"; then
    echo "Verification: Prepared statements are now in use."
else
    echo "Warning: Fix verification failed. Please check the file manually."
    exit 1
fi

# Restart Apache to ensure PHP picks up changes (in case of opcode caching)
if command -v apache2ctl &> /dev/null; then
    apache2ctl graceful 2>/dev/null || true
elif command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
elif command -v service &> /dev/null; then
    service apache2 reload 2>/dev/null || service httpd reload 2>/dev/null || true
fi

echo "Solution applied successfully!"
