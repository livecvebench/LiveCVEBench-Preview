"""
Vulnerability tests for the type confusion issue in @digitalocean/do-markdownit.

These tests verify that the vulnerability is exploitable before the fix is applied.
They should FAIL in the vulnerable state (bypass works) and PASS after fix (bypass blocked).
"""

import subprocess
import json
import os
import pytest

# Test script that renders markdown and outputs results as JSON
TEST_SCRIPT_TEMPLATE = """
const MarkdownIt = require("markdown-it");
const doMD = require("@digitalocean/do-markdownit");

// Configuration with STRING values (vulnerable configuration)
const md = MarkdownIt().use(doMD, {
  callout: { allowedClasses: "admin,info" },
  fence_environment: { allowedEnvironments: "production,test" }
});

const input = %s;
const output = md.render(input);

console.log(JSON.stringify({
  input: input,
  output: output
}));
"""


def run_markdown_test(markdown_input):
    """Helper function to run markdown rendering test via Node.js"""
    script_content = TEST_SCRIPT_TEMPLATE % json.dumps(markdown_input)

    result = subprocess.run(
        ["node", "-e", script_content],
        capture_output=True,
        text=True,
        cwd="/app",
        timeout=30
    )

    if result.returncode != 0:
        pytest.fail(f"Node.js script failed: {result.stderr}")

    return json.loads(result.stdout)


class TestCalloutVulnerability:
    """Test cases for callout class bypass vulnerability"""

    def test_substring_in_bypasses_admin(self):
        """
        Test that 'in' (substring of 'admin') is blocked.
        Vulnerability: 'in' is found within 'admin' string, allowing bypass.
        """
        result = run_markdown_test("<$>[in]\nBypassed content<$>")
        output = result["output"]

        # After fix: 'in' should NOT be rendered as a callout
        # The markup should be escaped or treated as plain text
        assert 'class="callout in"' not in output, \
            "Substring 'in' should be blocked but was accepted as callout class"

    def test_substring_adm_bypasses_admin(self):
        """
        Test that 'adm' (substring of 'admin') is blocked.
        """
        result = run_markdown_test("<$>[adm]\nBypassed via adm<$>")
        output = result["output"]

        assert 'class="callout adm"' not in output, \
            "Substring 'adm' should be blocked but was accepted as callout class"

    def test_substring_fo_bypasses_info(self):
        """
        Test that 'fo' (substring of 'info') is blocked.
        """
        result = run_markdown_test("<$>[fo]\nBypassed via fo<$>")
        output = result["output"]

        assert 'class="callout fo"' not in output, \
            "Substring 'fo' should be blocked but was accepted as callout class"

    def test_substring_nf_bypasses_info(self):
        """
        Test that 'nf' (substring of 'info') is blocked.
        """
        result = run_markdown_test("<$>[nf]\nBypassed via nf<$>")
        output = result["output"]

        assert 'class="callout nf"' not in output, \
            "Substring 'nf' should be blocked but was accepted as callout class"

    def test_single_char_i_bypass(self):
        """
        Test that single character 'i' is blocked (appears in both admin and info).
        """
        result = run_markdown_test("<$>[i]\nSingle char bypass<$>")
        output = result["output"]

        assert 'class="callout i"' not in output, \
            "Single character 'i' should be blocked but was accepted"

    def test_substring_dm_bypass(self):
        """
        Test that 'dm' (substring of 'admin') is blocked.
        """
        result = run_markdown_test("<$>[dm]\nBypassed via dm<$>")
        output = result["output"]

        assert 'class="callout dm"' not in output, \
            "Substring 'dm' should be blocked but was accepted as callout class"


class TestFenceEnvironmentVulnerability:
    """Test cases for fence environment name bypass vulnerability"""

    def test_substring_pro_bypasses_production(self):
        """
        Test that 'pro' (substring of 'production') is blocked.
        Vulnerability: 'pro' is found within 'production' string, allowing bypass.
        """
        result = run_markdown_test("```\n[environment pro]\ncode here\n```")
        output = result["output"]

        # After fix: 'pro' should NOT be accepted as environment name
        assert 'class="environment-pro"' not in output and 'environment-pro' not in output, \
            "Substring 'pro' should be blocked but was accepted as environment name"

    def test_substring_prod_bypasses_production(self):
        """
        Test that 'prod' (substring of 'production') is blocked.
        """
        result = run_markdown_test("```\n[environment prod]\ncode here\n```")
        output = result["output"]

        assert 'class="environment-prod"' not in output and 'environment-prod' not in output, \
            "Substring 'prod' should be blocked but was accepted as environment name"

    def test_substring_est_bypasses_test(self):
        """
        Test that 'est' (substring of 'test') is blocked.
        """
        result = run_markdown_test("```\n[environment est]\ncode here\n```")
        output = result["output"]

        assert 'class="environment-est"' not in output and 'environment-est' not in output, \
            "Substring 'est' should be blocked but was accepted as environment name"

    def test_substring_te_bypasses_test(self):
        """
        Test that 'te' (substring of 'test') is blocked.
        """
        result = run_markdown_test("```\n[environment te]\ncode here\n```")
        output = result["output"]

        assert 'class="environment-te"' not in output and 'environment-te' not in output, \
            "Substring 'te' should be blocked but was accepted as environment name"

    def test_substring_oduct_bypass(self):
        """
        Test that 'oduct' (substring of 'production') is blocked.
        """
        result = run_markdown_test("```\n[environment oduct]\ncode here\n```")
        output = result["output"]

        assert 'environment-oduct' not in output, \
            "Substring 'oduct' should be blocked but was accepted as environment name"

    def test_single_char_t_bypass(self):
        """
        Test that single character 't' is blocked.
        """
        result = run_markdown_test("```\n[environment t]\ncode here\n```")
        output = result["output"]

        assert 'environment-t' not in output, \
            "Single character 't' should be blocked but was accepted"


class TestCombinedBypassScenarios:
    """Test combined attack scenarios"""

    def test_multiple_callout_bypasses_in_document(self):
        """
        Test multiple callout bypass attempts in a single document.
        """
        markdown = """<$>[in]\nFirst bypass<$>

Some text

<$>[adm]\nSecond bypass<$>"""

        result = run_markdown_test(markdown)
        output = result["output"]

        assert 'class="callout in"' not in output, "First bypass 'in' should be blocked"
        assert 'class="callout adm"' not in output, "Second bypass 'adm' should be blocked"

    def test_callout_and_environment_combined(self):
        """
        Test both callout and environment bypass in same document.
        """
        markdown = """<$>[in]\nCallout bypass<$>

```
[environment pro]
code
```"""

        result = run_markdown_test(markdown)
        output = result["output"]

        assert 'class="callout in"' not in output, "Callout bypass should be blocked"
        assert 'environment-pro' not in output, "Environment bypass should be blocked"

    def test_exact_delimiter_substring(self):
        """
        Test bypass using the comma delimiter as part of substring.
        'n,i' spans across 'admin,info' but shouldn't match.
        """
        result = run_markdown_test("<$>[n,i]\nDelimiter bypass attempt<$>")
        output = result["output"]

        # This tests edge case where attacker tries to use delimiter
        # Should not render as callout regardless
        assert 'class="callout n,i"' not in output

