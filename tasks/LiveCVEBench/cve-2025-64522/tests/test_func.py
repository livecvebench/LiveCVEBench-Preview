"""
Functionality tests for Soft Serve webhook feature.

These tests verify that the webhook feature works correctly for valid external URLs.
Should PASS in both vulnerable and fixed states.
"""
import pytest
import subprocess
import time
import os
import socket
import http.server
import threading


# SSH configuration for soft-serve
SSH_HOST = os.environ.get("SOFT_SERVE_HOST", "localhost")
SSH_PORT = os.environ.get("SOFT_SERVE_SSH_PORT", "23231")
SSH_KEY = os.environ.get("SOFT_SERVE_ADMIN_KEY", "/root/.ssh/id_ed25519")

# Test repository name
TEST_REPO = "test-repo"


def run_ssh_command(command: str, timeout: int = 30) -> subprocess.CompletedProcess:
    """Run an SSH command against soft-serve.

    Note: In soft-serve v0.11.0, webhooks are managed via 'repo webhook' subcommand,
    not a top-level 'webhook' command.
    """
    ssh_cmd = [
        "ssh",
        "-p", SSH_PORT,
        "-o", "StrictHostKeyChecking=no",
        "-o", "UserKnownHostsFile=/dev/null",
        "-o", "IdentitiesOnly=yes",
        "-i", SSH_KEY,
        SSH_HOST,
        command
    ]
    return subprocess.run(ssh_cmd, capture_output=True, text=True, timeout=timeout)


def wait_for_soft_serve(max_wait: int = 60) -> bool:
    """Wait for soft-serve to be ready."""
    start = time.time()
    while time.time() - start < max_wait:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex((SSH_HOST, int(SSH_PORT)))
            sock.close()
            if result == 0:
                time.sleep(2)  # Give it a moment to fully initialize
                return True
        except Exception:
            pass
        time.sleep(1)
    return False


@pytest.fixture(scope="module", autouse=True)
def setup_environment():
    """Ensure soft-serve is running and set up test repository."""
    import re
    assert wait_for_soft_serve(), "Soft Serve is not running"

    # Create test repository if it doesn't exist
    result = run_ssh_command(f"repo create {TEST_REPO}")
    # It's OK if repo already exists

    # Pre-cleanup - delete any webhooks that might exist from previous runs
    result = run_ssh_command(f"repo webhook list {TEST_REPO}")
    if result.returncode == 0 and result.stdout.strip():
        lines = result.stdout.strip().split("\n")
        for line in lines:
            # Parse ID from table format: │ID│URL│... (with possible whitespace)
            match = re.search(r'│\s*(\d+)\s*│', line)
            if match:
                webhook_id = match.group(1)
                run_ssh_command(f"repo webhook delete {TEST_REPO} {webhook_id}")

    yield

    # Cleanup - delete any webhooks created during tests
    result = run_ssh_command(f"repo webhook list {TEST_REPO}")
    if result.returncode == 0 and result.stdout.strip():
        lines = result.stdout.strip().split("\n")
        for line in lines:
            # Parse ID from table format: │ID│URL│... (with possible whitespace)
            match = re.search(r'│\s*(\d+)\s*│', line)
            if match:
                webhook_id = match.group(1)
                run_ssh_command(f"repo webhook delete {TEST_REPO} {webhook_id}")


class TestWebhookBasicFunctionality:
    """Test basic webhook CRUD operations."""

    def test_soft_serve_is_running(self):
        """Verify soft-serve is responding to SSH commands."""
        result = run_ssh_command("info")
        assert result.returncode == 0, f"SSH command failed: {result.stderr}"

    def test_list_webhooks_empty(self):
        """Verify listing webhooks on a repo with no webhooks."""
        # First ensure no webhooks exist
        result = run_ssh_command(f"repo webhook list {TEST_REPO}")
        assert result.returncode == 0, f"Failed to list webhooks: {result.stderr}"

    def test_create_webhook_with_external_url(self):
        """Create a webhook with a valid external URL."""
        # Use a known public URL (example.com is reserved for documentation)
        external_url = "https://httpbin.org/post"

        result = run_ssh_command(
            f"repo webhook create {TEST_REPO} {external_url} --events push --active"
        )

        # After fix: should succeed for valid external URL
        # Before fix: should also succeed
        assert result.returncode == 0 or "created" in result.stdout.lower() or \
            "created" in result.stderr.lower(), \
            f"Failed to create webhook: {result.stderr}"

    def test_list_webhooks_after_create(self):
        """Verify webhooks appear in the list after creation."""
        result = run_ssh_command(f"repo webhook list {TEST_REPO}")
        assert result.returncode == 0, f"Failed to list webhooks: {result.stderr}"
        # Should have at least one webhook
        assert result.stdout.strip() != "" or "no webhooks" not in result.stdout.lower()

    def test_webhook_info(self):
        """Get info about a specific webhook."""
        import re
        # First create a webhook
        external_url = "https://example.org/webhook"
        run_ssh_command(
            f"repo webhook create {TEST_REPO} {external_url} --events push"
        )

        # List to get ID
        result = run_ssh_command(f"repo webhook list {TEST_REPO}")
        assert result.returncode == 0

        # Try to get info on first webhook
        lines = result.stdout.strip().split("\n")
        webhook_id = None
        for line in lines:
            # Parse ID from table format: │ID│URL│... (with possible whitespace)
            match = re.search(r'│\s*(\d+)\s*│', line)
            if match:
                webhook_id = match.group(1)
                break

        if webhook_id:
            info_result = run_ssh_command(f"repo webhook info {TEST_REPO} {webhook_id}")
            # Just verify command doesn't error out
            assert info_result.returncode == 0 or "not found" not in info_result.stderr.lower()


class TestWebhookWithDifferentSchemes:
    """Test webhook creation with different URL schemes."""

    def test_https_webhook(self):
        """Create webhook with HTTPS URL."""
        result = run_ssh_command(
            f"repo webhook create {TEST_REPO} https://postman-echo.com/post --events push"
        )
        # Should work
        assert result.returncode == 0 or "error" not in result.stderr.lower()

    def test_http_webhook(self):
        """Create webhook with HTTP URL (non-HTTPS)."""
        result = run_ssh_command(
            f"repo webhook create {TEST_REPO} http://httpbin.org/post --events push"
        )
        # HTTP should also work for external URLs
        assert result.returncode == 0 or "error" not in result.stderr.lower()


class TestWebhookEvents:
    """Test webhook with different event types."""

    def test_push_event_webhook(self):
        """Create webhook for push events."""
        result = run_ssh_command(
            f"repo webhook create {TEST_REPO} https://example.com/push-hook --events push"
        )
        assert result.returncode == 0 or "created" in (result.stdout + result.stderr).lower()

    def test_multiple_events_webhook(self):
        """Create webhook for multiple events."""
        result = run_ssh_command(
            f"repo webhook create {TEST_REPO} https://example.com/multi-hook --events push,branch_tag_create"
        )
        # Should accept multiple events
        assert result.returncode == 0 or "error" not in result.stderr.lower()


class TestWebhookDelete:
    """Test webhook deletion."""

    def test_delete_webhook(self):
        """Create and delete a webhook."""
        import re
        # Create
        create_result = run_ssh_command(
            f"repo webhook create {TEST_REPO} https://example.com/to-delete --events push"
        )

        # Get webhook ID from list
        list_result = run_ssh_command(f"repo webhook list {TEST_REPO}")
        lines = list_result.stdout.strip().split("\n")
        webhook_id = None
        for line in lines:
            if "to-delete" in line:
                # Parse ID from table format: │ID│URL│... (with possible whitespace)
                match = re.search(r'│\s*(\d+)\s*│', line)
                if match:
                    webhook_id = match.group(1)
                    break

        if webhook_id:
            # Delete
            delete_result = run_ssh_command(f"repo webhook delete {TEST_REPO} {webhook_id}")
            assert delete_result.returncode == 0 or "deleted" in (delete_result.stdout + delete_result.stderr).lower()


class TestRepositoryOperations:
    """Test that repository operations work correctly."""

    def test_repo_list(self):
        """Verify repository listing works."""
        result = run_ssh_command("repo list")
        assert result.returncode == 0, f"Failed to list repos: {result.stderr}"

    def test_repo_info(self):
        """Get repository info."""
        result = run_ssh_command(f"repo info {TEST_REPO}")
        assert result.returncode == 0 or "not found" not in result.stderr.lower()
