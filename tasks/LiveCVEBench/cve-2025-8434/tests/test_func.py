"""
Functional tests for NeonFlix movie streaming application.
These tests verify that the application works correctly for legitimate users.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import subprocess
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")

# Test credentials - admin user created in database setup
ADMIN_USERNAME = "admin@test.com"
ADMIN_PASSWORD = "admin123"
REGULAR_USERNAME = "user@test.com"
REGULAR_PASSWORD = "user123"


class TestApplicationBasics:
    """Test basic application functionality."""

    def test_homepage_accessible(self):
        """Test that the homepage is accessible (may redirect to login)."""
        response = requests.get(f"{BASE_URL}/", allow_redirects=False, timeout=10)
        # Should either show content or redirect to login
        assert response.status_code in [200, 302, 301]

    def test_login_page_accessible(self):
        """Test that the login page is accessible."""
        response = requests.get(f"{BASE_URL}/user-login.php", timeout=10)
        assert response.status_code == 200

    def test_login_page_has_form(self):
        """Test that the login page contains a login form."""
        response = requests.get(f"{BASE_URL}/user-login.php", timeout=10)
        assert response.status_code == 200
        content = response.text.lower()
        assert "form" in content
        # Should have password and username/email fields
        assert "password" in content or "pass" in content


class TestAdminAuthentication:
    """Test admin authentication flow."""

    def test_admin_login_success(self):
        """Test that admin can successfully log in."""
        session = requests.Session()

        # Perform login
        login_data = {
            "mail": ADMIN_USERNAME,
            "pass": ADMIN_PASSWORD
        }
        response = session.post(
            f"{BASE_URL}/backend/login_control.php",
            data=login_data,
            allow_redirects=False,
            timeout=10
        )

        # Should redirect to homepage on success
        assert response.status_code in [200, 302]

        # If redirected, follow to homepage
        if response.status_code == 302:
            homepage_response = session.get(f"{BASE_URL}/homepage.php", timeout=10)
            assert homepage_response.status_code == 200

    def test_admin_can_access_admin_page_after_login(self):
        """Test that authenticated admin can access the admin page."""
        session = requests.Session()

        # Login as admin
        login_data = {
            "mail": ADMIN_USERNAME,
            "pass": ADMIN_PASSWORD
        }
        session.post(
            f"{BASE_URL}/backend/login_control.php",
            data=login_data,
            allow_redirects=True,
            timeout=10
        )

        # Now access admin page
        response = session.get(f"{BASE_URL}/admin.php", allow_redirects=False, timeout=10)

        # Admin should be able to see the admin page (200) or if fixed, still allowed since they're admin
        # The page should contain the movie upload form
        if response.status_code == 200:
            assert "Enter the Movie details" in response.text or "movie" in response.text.lower()

    def test_admin_can_see_upload_form(self):
        """Test that authenticated admin can see the movie upload form."""
        session = requests.Session()

        # Login as admin
        login_data = {
            "mail": ADMIN_USERNAME,
            "pass": ADMIN_PASSWORD
        }
        session.post(
            f"{BASE_URL}/backend/login_control.php",
            data=login_data,
            allow_redirects=True,
            timeout=10
        )

        # Access admin page
        response = session.get(f"{BASE_URL}/admin.php", timeout=10)

        if response.status_code == 200:
            content = response.text.lower()
            # Should have form elements for uploading movies
            assert "form" in content
            assert ("movie" in content or "upload" in content or "submit" in content)


class TestRegularUserAuthentication:
    """Test regular user authentication flow."""

    def test_regular_user_login(self):
        """Test that a regular user can log in."""
        session = requests.Session()

        login_data = {
            "mail": REGULAR_USERNAME,
            "pass": REGULAR_PASSWORD
        }
        response = session.post(
            f"{BASE_URL}/backend/login_control.php",
            data=login_data,
            allow_redirects=False,
            timeout=10
        )

        # Should redirect or show content
        assert response.status_code in [200, 302]

    def test_homepage_accessible_after_login(self):
        """Test that homepage is accessible after user login."""
        session = requests.Session()

        login_data = {
            "mail": REGULAR_USERNAME,
            "pass": REGULAR_PASSWORD
        }
        session.post(
            f"{BASE_URL}/backend/login_control.php",
            data=login_data,
            allow_redirects=True,
            timeout=10
        )

        response = session.get(f"{BASE_URL}/homepage.php", timeout=10)
        # Homepage should be accessible (200) or redirect
        assert response.status_code in [200, 302]


class TestDatabaseConnectivity:
    """Test database connectivity."""

    def test_database_connection_works(self):
        """Test that the database connection is working by checking login endpoint."""
        # Try to login with invalid credentials
        response = requests.post(
            f"{BASE_URL}/backend/login_control.php",
            data={"mail": "nonexistent", "pass": "wrongpass"},
            timeout=10
        )

        # Should get an error message (not a database connection error)
        assert response.status_code in [200, 302]
        # If 200, should show error message about credentials, not DB error
        if response.status_code == 200:
            content = response.text.lower()
            # Should not have database connection errors
            assert "could not connect" not in content


class TestStaticResources:
    """Test that static resources are accessible."""

    def test_css_directory_accessible(self):
        """Test that CSS files are served."""
        # Try to access a known CSS file
        response = requests.get(f"{BASE_URL}/css/user.css", timeout=10)
        # Should be accessible or 404 if doesn't exist
        assert response.status_code in [200, 404, 403]

    def test_images_accessible(self):
        """Test that images directory is accessible."""
        response = requests.get(f"{BASE_URL}/images/", timeout=10)
        # Should not be server error
        assert response.status_code in [200, 403, 404]
