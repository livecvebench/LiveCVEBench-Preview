#!/bin/bash
set -e

# Define the CubeCart root directory
CUBECART_ROOT="/var/www/html"

echo "=== Applying session invalidation fix ==="
echo "CubeCart root: $CUBECART_ROOT"

# Fix 1: Modify logout() in classes/user.class.php
# Change: public function logout()
# To:     public function logout($password_change = false)
# And add pu parameter to redirect

echo "Fixing classes/user.class.php..."

# First, update the function signature
sed -i 's/public function logout()/public function logout($password_change = false)/g' $CUBECART_ROOT/classes/user.class.php

# Replace the simple httpredir call with the conditional one
# Original: httpredir(currentPage(null, array('_a' => 'login')));
# Fixed:    $get = array('_a' => 'login');
#           if($password_change) {
#               $get['pu'] = 1;
#           };
#           httpredir(currentPage(null, $get));

sed -i "s|httpredir(currentPage(null, array('_a' => 'login')));|"'$get = array('"'"'_a'"'"' => '"'"'login'"'"'); if(\$password_change) { \$get['"'"'pu'"'"'] = 1; }; httpredir(currentPage(null, \$get));|g' $CUBECART_ROOT/classes/user.class.php

echo "  - Updated logout() function signature"
echo "  - Added password change redirect parameter"


# Fix 2: Modify _profile() in classes/cubecart.class.php
# Change: $GLOBALS['gui']->setNotify($GLOBALS['language']->account['password_updated']);
# To:     $GLOBALS['user']->logout(true);

echo "Fixing classes/cubecart.class.php (_profile method)..."

sed -i "s|\$GLOBALS\['gui'\]->setNotify(\$GLOBALS\['language'\]->account\['password_updated'\]);|\$GLOBALS['user']->logout(true);|g" $CUBECART_ROOT/classes/cubecart.class.php

echo "  - Updated password change to call logout(true)"


# Fix 3: Add pu parameter check in _login() method
# Add: if (isset($_GET['pu'])) { $GLOBALS['gui']->setNotify($GLOBALS['language']->account['password_updated']); }
# After: $GLOBALS['session']->setBack();

echo "Fixing classes/cubecart.class.php (_login method)..."

# Use sed to add the pu check after setBack() call
sed -i "s|\$GLOBALS\['session'\]->setBack();|\$GLOBALS['session']->setBack();\n        if (isset(\$_GET['pu'])) {\n            \$GLOBALS['gui']->setNotify(\$GLOBALS['language']->account['password_updated']);\n        }|g" $CUBECART_ROOT/classes/cubecart.class.php

echo "  - Added password update notification check on login page"


# Fix 4: Modify admin/sources/settings.admins.inc.php
# Add $logout = false; after $record = $_POST['admin'];
# Set $logout = true; when password is changed
# Add logout redirect when password was changed

echo "Fixing admin/sources/settings.admins.inc.php..."

# Use PHP for more reliable file manipulation
php << 'EOPHP'
<?php
$file = '/var/www/html/admin/sources/settings.admins.inc.php';
$content = file_get_contents($file);

// Fix 4a: Add $logout = false; after $record = $_POST['admin'];
// The original line may have varying whitespace
if (strpos($content, '$logout = false') === false) {
    $content = preg_replace(
        '/(\$record\s*=\s*\$_POST\[\'admin\'\];)/s',
        "$1\n    \$logout = false;",
        $content
    );
}

// Fix 4b: Add $logout = true; after password hashing
if (strpos($content, '$logout = true') === false) {
    $content = preg_replace(
        '/(\$record\[\'password\'\]\s*=\s*Password::getInstance\(\)->getSalted\(\$record\[\'password\'\],\s*\$salt\);)/s',
        "$1\n                \$logout = true;",
        $content
    );
}

// Fix 4c: Modify the redirect after update success to check $logout
// Find and replace the httpredir in the elseif ($updated) block
if (strpos($content, '_g=logout') === false) {
    // Replace single line redirect with conditional redirect
    $content = preg_replace(
        '/(} elseif \(\$updated\) \{\s*\$GLOBALS\[\'main\'\]->successMessage\(\$lang\[\'admins\'\]\[\'notify_admin_update\'\]\);\s*)httpredir\(currentPage\(array\(\'action\', \'admin_id\'\)\)\);/',
        "$1if(\$logout) {\n            httpredir('?_g=logout&token='.SESSION_TOKEN);\n        } else {\n            httpredir(currentPage(array('action', 'admin_id')));\n        }",
        $content
    );
}

file_put_contents($file, $content);
echo "Admin settings file updated successfully\n";
?>
EOPHP

echo "  - Added logout flag variable"
echo "  - Set logout flag on password change"
echo "  - Added logout redirect for admin password change"


# Fix 5: Update language/definitions.xml
# Update password_updated message and add pw_cause_logout string

echo "Fixing language/definitions.xml..."

# Update the password_updated message
sed -i 's|<string name="password_updated" introduced="6.0.0"><!\[CDATA\[Your password has been updated.\]\]></string>|<string name="password_updated" introduced="6.0.0"><![CDATA[Your password has been updated. Please now login with your new credentials.]]></string>|g' $CUBECART_ROOT/language/definitions.xml

# Add pw_cause_logout string after password_updated (for all language files)
for lang_file in $CUBECART_ROOT/language/*/definitions.xml; do
    if [ -f "$lang_file" ]; then
        # Update password_updated message
        sed -i 's|<string name="password_updated" introduced="6.0.0"><!\[CDATA\[Your password has been updated.\]\]></string>|<string name="password_updated" introduced="6.0.0"><![CDATA[Your password has been updated. Please now login with your new credentials.]]></string>|g' "$lang_file"

        # Add pw_cause_logout if not present
        if ! grep -q "pw_cause_logout" "$lang_file"; then
            sed -i 's|<string name="password_updated" introduced="6.0.0"><!\[CDATA\[Your password has been updated. Please now login with your new credentials.\]\]></string>|<string name="password_updated" introduced="6.0.0"><![CDATA[Your password has been updated. Please now login with your new credentials.]]></string>\n    <string name="pw_cause_logout" introduced="6.5.11"><![CDATA[Changing your password will log you out of this current session.]]></string>|g' "$lang_file"
        fi
    fi
done

# Also fix the main definitions.xml in language folder
if [ -f "$CUBECART_ROOT/language/definitions.xml" ]; then
    sed -i 's|<string name="password_updated" introduced="6.0.0"><!\[CDATA\[Your password has been updated.\]\]></string>|<string name="password_updated" introduced="6.0.0"><![CDATA[Your password has been updated. Please now login with your new credentials.]]></string>|g' $CUBECART_ROOT/language/definitions.xml

    if ! grep -q "pw_cause_logout" $CUBECART_ROOT/language/definitions.xml; then
        sed -i 's|<string name="password_updated" introduced="6.0.0"><!\[CDATA\[Your password has been updated. Please now login with your new credentials.\]\]></string>|<string name="password_updated" introduced="6.0.0"><![CDATA[Your password has been updated. Please now login with your new credentials.]]></string>\n    <string name="pw_cause_logout" introduced="6.5.11"><![CDATA[Changing your password will log you out of this current session.]]></string>|g' $CUBECART_ROOT/language/definitions.xml
    fi
fi

echo "  - Updated password_updated message"
echo "  - Added pw_cause_logout string"


# Verify fixes were applied
echo ""
echo "=== Verifying fixes ==="

# Check user.class.php
if grep -q 'logout($password_change' $CUBECART_ROOT/classes/user.class.php; then
    echo "✓ user.class.php: logout() parameter added"
else
    echo "✗ user.class.php: logout() parameter NOT added"
fi

# Check cubecart.class.php - logout call
if grep -q "logout(true)" $CUBECART_ROOT/classes/cubecart.class.php; then
    echo "✓ cubecart.class.php: logout(true) call added in _profile()"
else
    echo "✗ cubecart.class.php: logout(true) NOT found"
fi

# Check cubecart.class.php - pu parameter
if grep -q "\$_GET\['pu'\]" $CUBECART_ROOT/classes/cubecart.class.php; then
    echo "✓ cubecart.class.php: pu parameter check added in _login()"
else
    echo "✗ cubecart.class.php: pu parameter check NOT found"
fi

# Check admin settings
if grep -q "\$logout" $CUBECART_ROOT/admin/sources/settings.admins.inc.php; then
    echo "✓ settings.admins.inc.php: logout flag added"
else
    echo "✗ settings.admins.inc.php: logout flag NOT found"
fi

if grep -q "_g=logout" $CUBECART_ROOT/admin/sources/settings.admins.inc.php; then
    echo "✓ settings.admins.inc.php: logout redirect added"
else
    echo "✗ settings.admins.inc.php: logout redirect NOT found"
fi

echo ""
echo "=== Fix application complete ==="

# Create symlink from /var/www/html to /app for tests that expect /app path
# This allows tests to find files at /app/classes/* etc.
echo "Creating /app symlink for test compatibility..."
if [ ! -e /app ]; then
    ln -s /var/www/html /app
    echo "  - Created /app -> /var/www/html symlink"
elif [ -d /app ] && [ ! -L /app ]; then
    # /app exists as a real directory (not symlink), remove solution.sh from it and recreate as symlink
    rm -f /app/solution.sh 2>/dev/null || true
    rmdir /app 2>/dev/null || true
    if [ ! -e /app ]; then
        ln -s /var/www/html /app
        echo "  - Recreated /app -> /var/www/html symlink"
    else
        echo "  - /app directory exists with content, cannot create symlink"
    fi
fi

# Restart PHP/Apache to ensure changes take effect
# CubeCart is a PHP application served by Apache, so we need to restart Apache
# In Docker, we just reload Apache config instead of full restart to avoid container exit
echo "Reloading web server configuration..."
if command -v apache2ctl &> /dev/null; then
    apache2ctl graceful 2>/dev/null || true
elif command -v apachectl &> /dev/null; then
    apachectl graceful 2>/dev/null || true
fi

echo "Done!"
