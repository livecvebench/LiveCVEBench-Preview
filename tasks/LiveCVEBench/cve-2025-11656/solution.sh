#!/bin/bash
set -e

# Solution script for fixing the unrestricted file upload vulnerability in editNotes.php
# This fix adds:
# 1. Authentication check - verifies user is logged in
# 2. File extension whitelist - only allows safe file types

echo "Applying fix to editNotes.php..."

# Path to the vulnerable file
VULN_FILE="/var/www/html/school-management-system/assets/editNotes.php"

# Check if file exists
if [ ! -f "$VULN_FILE" ]; then
    echo "ERROR: $VULN_FILE not found"
    exit 1
fi

# Create the fixed version of editNotes.php
cat > "$VULN_FILE" << 'FIXED_EOF'
<?php

include("config.php");
session_start();

// Authentication check - reject unauthenticated requests
if(!isset($_SESSION['uid'])){
    echo "Unauthorized";
    exit();
}

$response = "";
if ($_SERVER['REQUEST_METHOD'] == 'POST') {

    $class = $_POST['class'];
    $subject = $_POST['subject'];
    $title = $_POST['title'];
    $comment = $_POST['comment'];
    $noteId = $_POST['noteId'] . "";
    $editorId = $_SESSION['uid'];


    if (
        isset($_FILES["file"]) &&
        $_FILES["file"]["error"] == 0 &&
        isset($_POST['class']) &&
        isset($_POST['subject']) &&
        isset($_POST['title']) &&
        isset($_POST['comment']) &&
        isset($noteId)
    ) {
        $query1 = "SELECT `file` FROM `notes` WHERE s_no = ?";

        $stmt1 = mysqli_prepare($conn, $query1);
        $intNoteId = (int) $noteId;

        mysqli_stmt_bind_param($stmt1, "i", $intNoteId);

        mysqli_stmt_execute($stmt1);

        $result1 = mysqli_stmt_get_result($stmt1);
        $row = mysqli_fetch_assoc($result1);

        mysqli_stmt_close($stmt1);
        $existingFilePath = ".." . DIRECTORY_SEPARATOR . "notesUploads" . DIRECTORY_SEPARATOR . $row['file'];


        if (unlink($existingFilePath)) {

        } else {

        }

        $filename = $_FILES["file"]["name"];
        $tempname = $_FILES["file"]["tmp_name"];

        $fileInfo = pathinfo($filename);
        $fileExtension = strtolower($fileInfo['extension']);

        // File extension whitelist validation - only allow safe file types
        $allowedExtensions = ['pdf', 'doc', 'docx', 'txt', 'jpg', 'jpeg', 'png', 'gif'];
        if (!in_array($fileExtension, $allowedExtensions)) {
            $response = "Invalid file type";
            echo $response;
            exit();
        }

        $newName = $editorId . time() . "." . $fileExtension;

        $folder = __DIR__ . DIRECTORY_SEPARATOR . ".." . DIRECTORY_SEPARATOR . "notesUploads" . DIRECTORY_SEPARATOR . $newName;


        if (move_uploaded_file($tempname, $folder)) {


            $query2 = "UPDATE `notes` SET `class` = ? , `subject`=?, `title`=? , `comment`=? , `editor_id`=? , `file`=? WHERE `notes`.`s_no` = ?;";

            $stmt2 = mysqli_prepare($conn, $query2);

            mysqli_stmt_bind_param($stmt2, "ssssssi", $class, $subject, $title, $comment, $editorId, $newName, $intNoteId);

            if (mysqli_stmt_execute($stmt2)) {
                $response = "success";

            } else {
                $response =  'Something went wrong!';
            }
            mysqli_stmt_close($stmt2);


        } else {
            $response =  'Something went wrong!';
        }

    } else {

        $query3 = "UPDATE `notes` SET `class` = ? , `subject`=?, `title`=? , `comment`=? , `editor_id`=? WHERE `notes`.`s_no` = ?;";

        $stmt3 = mysqli_prepare($conn, $query3);
        $intNoteId = (int) $noteId;

        mysqli_stmt_bind_param($stmt3, "sssssi", $class, $subject, $title, $comment, $editorId,  $intNoteId);

        if (mysqli_stmt_execute($stmt3)) {
            $response = "success";

        } else {
            $response =  'Something went wrong!';
        }
        mysqli_stmt_close($stmt3);
    }




} else {
    $response = "Unable to edit note!";
}
echo $response;

?>
FIXED_EOF

echo "Fix applied to editNotes.php"

# Also fix uploadNotes.php if it exists (similar vulnerability)
UPLOAD_FILE="/var/www/html/school-management-system/assets/uploadNotes.php"
if [ -f "$UPLOAD_FILE" ]; then
    echo "Checking uploadNotes.php..."

    # Check if it needs the same fix (no session check)
    if ! grep -q "if(!isset(\$_SESSION\['uid'\]))" "$UPLOAD_FILE"; then
        echo "Adding authentication check to uploadNotes.php..."

        # Add session check after session_start()
        sed -i '/session_start();/a\
\
// Authentication check - reject unauthenticated requests\
if(!isset($_SESSION['"'"'uid'"'"'])){\
    echo "Unauthorized";\
    exit();\
}' "$UPLOAD_FILE"
    fi

    # Check if file extension validation exists
    if ! grep -q "allowedExtensions" "$UPLOAD_FILE"; then
        echo "Adding file extension validation to uploadNotes.php..."

        # Add whitelist check after extracting the extension
        sed -i '/\$fileExtension = strtolower(\$fileInfo\['"'"'extension'"'"'\]);/a\
\
        // File extension whitelist validation - only allow safe file types\
        $allowedExtensions = ['"'"'pdf'"'"', '"'"'doc'"'"', '"'"'docx'"'"', '"'"'txt'"'"', '"'"'jpg'"'"', '"'"'jpeg'"'"', '"'"'png'"'"', '"'"'gif'"'"'];\
        if (!in_array($fileExtension, $allowedExtensions)) {\
            $response = "Invalid file type";\
            echo $response;\
            exit();\
        }' "$UPLOAD_FILE"
    fi

    echo "Fix applied to uploadNotes.php"
fi

echo ""
echo "=== Fix Summary ==="
echo "1. Added authentication check - unauthenticated requests are now rejected"
echo "2. Added file extension whitelist - only PDF, DOC, DOCX, TXT, and image files are allowed"
echo ""
echo "Fix applied successfully!"
