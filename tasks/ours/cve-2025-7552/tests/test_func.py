"""
Functionality tests for Northstar application.
These tests verify basic application behavior and should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import urllib3

# Disable SSL warnings for testing
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "http://localhost:80"
TIMEOUT = 10


class TestApplicationBasics:
    """Test that the application is running and basic endpoints work."""

    def test_application_is_running(self):
        """Verify the application responds to requests."""
        # Try multiple endpoints to ensure app is up
        endpoints_to_try = [
            "/northstar/auth/login",
            "/northstar/log",
            "/",
        ]

        app_responding = False
        for endpoint in endpoints_to_try:
            try:
                response = requests.get(
                    f"{BASE_URL}{endpoint}",
                    timeout=TIMEOUT,
                    allow_redirects=False
                )
                # Any response (even 401/404) means app is running
                if response.status_code in [200, 301, 302, 401, 403, 404, 500]:
                    app_responding = True
                    break
            except requests.exceptions.ConnectionError:
                continue

        assert app_responding, "Application is not responding on any endpoint"

    def test_login_endpoint_accessible(self):
        """Verify login endpoint is accessible without authentication."""
        response = requests.get(
            f"{BASE_URL}/northstar/auth/login",
            timeout=TIMEOUT,
            allow_redirects=False
        )
        # Login endpoint should NOT return 401 (it's the auth entry point)
        assert response.status_code != 401, \
            f"Login endpoint should be accessible, got {response.status_code}"


class TestAuthenticationRequired:
    """Test that protected endpoints require authentication."""

    @pytest.mark.parametrize("endpoint", [
        "/northstar/log",
        "/northstar/gateway",
        "/northstar/module",
    ])
    def test_protected_endpoint_requires_auth(self, endpoint):
        """Verify protected endpoints return 401 without authentication."""
        response = requests.get(
            f"{BASE_URL}{endpoint}",
            timeout=TIMEOUT,
            allow_redirects=False
        )
        assert response.status_code == 401, \
            f"Expected 401 for {endpoint}, got {response.status_code}"


class TestPublicEndpoints:
    """Test that public endpoints are accessible."""

    def test_redirect_endpoint_accessible(self):
        """Verify /redirect path prefix endpoints don't require auth."""
        # The interceptor allows /redirect paths without auth
        response = requests.get(
            f"{BASE_URL}/redirect",
            timeout=TIMEOUT,
            allow_redirects=False
        )
        # Should not return 401 (may return 404 if endpoint doesn't exist)
        # The key is that auth check passes
        assert response.status_code != 401 or response.status_code == 404, \
            f"Redirect endpoint should not require auth, got {response.status_code}"

    def test_non_northstar_paths_accessible(self):
        """Verify paths not under /northstar don't require auth."""
        # Non-northstar paths should bypass the auth interceptor
        response = requests.get(
            f"{BASE_URL}/other-path",
            timeout=TIMEOUT,
            allow_redirects=False
        )
        # Should return 404 (not found) or similar, but NOT 401
        # This verifies the interceptor logic for non-northstar paths
        assert response.status_code != 401, \
            f"Non-northstar paths should not require auth check, got {response.status_code}"


class TestResponseContent:
    """Test response content and headers."""

    def test_unauthorized_response_format(self):
        """Verify 401 responses have proper format."""
        response = requests.get(
            f"{BASE_URL}/northstar/log",
            timeout=TIMEOUT,
            allow_redirects=False
        )
        assert response.status_code == 401
        # Check that error message is in Chinese (as per original code)
        # "token校验失败" means "token validation failed"
        assert "校验" in response.text or "token" in response.text.lower() or response.status_code == 401
