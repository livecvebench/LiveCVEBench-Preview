"""
Functional tests for NiceGUI media file serving.

These tests verify that the application works correctly for legitimate requests.
They should PASS in both vulnerable and fixed states.
"""
import httpx
import pytest
import time

BASE_URL = "http://localhost:8080"
TIMEOUT = 10.0


@pytest.fixture(scope="module", autouse=True)
def wait_for_app():
    """Wait for the application to be ready before running tests."""
    max_attempts = 30
    for i in range(max_attempts):
        try:
            response = httpx.get(f"{BASE_URL}/", timeout=2.0)
            if response.status_code == 200:
                return
        except httpx.RequestError:
            pass
        time.sleep(1)
    pytest.fail(f"Application did not start within {max_attempts} seconds")


class TestApplicationHealth:
    """Tests to verify the application is running and accessible."""

    def test_application_is_running(self):
        """Test that the NiceGUI application is accessible."""
        response = httpx.get(f"{BASE_URL}/", timeout=TIMEOUT)
        assert response.status_code == 200

    def test_main_page_returns_html(self):
        """Test that the main page returns HTML content."""
        response = httpx.get(f"{BASE_URL}/", timeout=TIMEOUT)
        assert response.status_code == 200
        content_type = response.headers.get("content-type", "")
        assert "text/html" in content_type


class TestMediaFileServing:
    """Tests for legitimate media file serving functionality."""

    def test_media_endpoint_exists(self):
        """Test that the /media endpoint is defined."""
        # Request a non-existent file - should get 404, not 405 or 500
        response = httpx.get(f"{BASE_URL}/media/nonexistent.txt", timeout=TIMEOUT)
        # 404 means endpoint exists but file doesn't
        assert response.status_code == 404

    def test_legitimate_media_file_access(self):
        """Test that legitimate files in the media directory can be accessed."""
        response = httpx.get(f"{BASE_URL}/media/test.txt", timeout=TIMEOUT)
        # test.txt was created by the PoC - should return 200 with content
        assert response.status_code == 200
        assert "test media file" in response.text.lower() or response.status_code == 200

    def test_nested_path_in_media_directory(self):
        """Test that nested paths within media directory work."""
        response = httpx.get(f"{BASE_URL}/media/subdir/file.txt", timeout=TIMEOUT)
        # Should return 404 (doesn't exist) rather than error
        assert response.status_code in [200, 404]

    def test_media_streaming_support(self):
        """Test that media files support HTTP range requests for streaming."""
        # First check if file exists
        response = httpx.get(f"{BASE_URL}/media/test.txt", timeout=TIMEOUT)
        if response.status_code != 200:
            pytest.skip("Test file not available")

        # Test range request
        response = httpx.get(
            f"{BASE_URL}/media/test.txt",
            headers={"Range": "bytes=0-10"},
            timeout=TIMEOUT
        )
        # Should support partial content (206) or return full file (200)
        assert response.status_code in [200, 206]

    def test_media_endpoint_accepts_various_extensions(self):
        """Test that various file extensions are handled."""
        extensions = ["mp4", "mp3", "wav", "pdf", "jpg"]
        for ext in extensions:
            response = httpx.get(f"{BASE_URL}/media/test.{ext}", timeout=TIMEOUT)
            # Should return 404 (file not found) not 500 or 405
            assert response.status_code in [200, 404], f"Failed for extension: {ext}"


class TestErrorHandling:
    """Tests for proper error handling."""

    def test_404_for_missing_file(self):
        """Test that missing files return 404 with proper message."""
        response = httpx.get(f"{BASE_URL}/media/definitely_not_exists_xyz123.txt", timeout=TIMEOUT)
        assert response.status_code == 404

    def test_404_response_format(self):
        """Test that 404 responses have proper format."""
        response = httpx.get(f"{BASE_URL}/media/missing.txt", timeout=TIMEOUT)
        assert response.status_code == 404
        # NiceGUI/FastAPI returns JSON error detail
        if "application/json" in response.headers.get("content-type", ""):
            assert "Not Found" in response.text or "not found" in response.text.lower()

    def test_empty_filename_handling(self):
        """Test that requests to /media/ without filename are handled."""
        response = httpx.get(f"{BASE_URL}/media/", timeout=TIMEOUT)
        # Should not crash - either redirect or 404
        assert response.status_code in [200, 307, 404]
