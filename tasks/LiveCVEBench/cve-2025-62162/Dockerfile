FROM rust:1.80-slim-bookworm

WORKDIR /app

# System dependencies (including tmux, asciinema, curl as required)
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    python3 \
    curl \
    ca-certificates \
    git \
    tmux \
    asciinema \
    gcc \
    g++ \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Clone the vulnerable version and remove .git to prevent solution leakage
RUN git clone https://github.com/cel-rust/cel-rust.git . && \
    git checkout cel-v0.11.3 && \
    rm -rf .git

# Create src directory for test binary
RUN mkdir -p /app/src

# Copy test harness and workspace config
COPY task-deps/main.rs /app/src/main.rs
COPY task-deps/Cargo.toml.workspace /app/Cargo.toml

# Build the project (dependencies cached in this layer)
RUN cargo build --release

# Enable backtrace for debugging panics
ENV RUST_BACKTRACE=1

# Keep container running
# CMD ["tail", "-f", "/dev/null"]
