"""
Functionality tests for Ditty WordPress Plugin API.

These tests verify that the plugin works correctly and responds appropriately
to various requests. They should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import subprocess

BASE_URL = "http://localhost"


def wait_for_wordpress(timeout=60):
    """Wait for WordPress to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


class TestWordPressBasicFunctionality:
    """Test basic WordPress functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure WordPress is ready before tests."""
        assert wait_for_wordpress(), "WordPress failed to start"

    def test_wordpress_homepage_accessible(self):
        """Verify WordPress homepage is accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=10)
        assert response.status_code == 200
        # Check for WordPress-related content
        assert "wp-content" in response.text or "WordPress" in response.text or "html" in response.text.lower()

    def test_rest_api_discovery_endpoint(self):
        """Verify WordPress REST API is accessible."""
        response = requests.get(f"{BASE_URL}/wp-json/", timeout=10)
        assert response.status_code == 200
        data = response.json()
        assert "name" in data or "namespaces" in data

    def test_rest_api_returns_json(self):
        """Verify REST API returns proper JSON responses."""
        response = requests.get(f"{BASE_URL}/wp-json/", timeout=10)
        assert response.status_code == 200
        assert "application/json" in response.headers.get("Content-Type", "")


class TestDittyPluginPresence:
    """Test that Ditty plugin is installed and active."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure WordPress is ready before tests."""
        assert wait_for_wordpress(), "WordPress failed to start"

    def test_ditty_rest_namespace_exists(self):
        """Verify Ditty plugin REST namespace is registered."""
        response = requests.get(f"{BASE_URL}/wp-json/", timeout=10)
        assert response.status_code == 200
        data = response.json()
        namespaces = data.get("namespaces", [])
        # Check if dittyeditor namespace is registered
        ditty_found = any("dittyeditor" in ns for ns in namespaces)
        assert ditty_found, "Ditty plugin namespace not found in REST API"

    def test_displayitems_endpoint_exists(self):
        """Verify displayItems endpoint exists (responds to requests)."""
        # Send a request to the endpoint - it should respond (not 404)
        response = requests.post(
            f"{BASE_URL}/wp-json/dittyeditor/v1/displayItems",
            json={},
            timeout=10
        )
        # Should return some response (200, 403, or 404 with specific error), not a generic 404
        assert response.status_code != 404 or "no_id" in response.text or "no api data" in response.text.lower() or "Invalid nonce" in response.text or "no_nonce" in response.text

    def test_phpitemmods_endpoint_exists(self):
        """Verify phpItemMods endpoint exists."""
        response = requests.post(
            f"{BASE_URL}/wp-json/dittyeditor/v1/phpItemMods",
            json={},
            timeout=10
        )
        # Should respond (not a generic 404 "route not found")
        assert response.status_code != 404 or "no_data" in response.text or "no api data" in response.text.lower() or "Invalid nonce" in response.text or "no_nonce" in response.text

    def test_dynamiclayouttags_endpoint_exists(self):
        """Verify dynamicLayoutTags endpoint exists."""
        response = requests.post(
            f"{BASE_URL}/wp-json/dittyeditor/v1/dynamicLayoutTags",
            json={},
            timeout=10
        )
        # Should respond (not a generic 404 "route not found")
        assert response.status_code != 404 or "no_id" in response.text or "no api data" in response.text.lower() or "Invalid nonce" in response.text or "no_nonce" in response.text


class TestAPIResponseFormats:
    """Test API response format consistency."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure WordPress is ready before tests."""
        assert wait_for_wordpress(), "WordPress failed to start"

    def test_displayitems_returns_json(self):
        """Verify displayItems returns JSON response."""
        response = requests.post(
            f"{BASE_URL}/wp-json/dittyeditor/v1/displayItems",
            headers={"Content-Type": "application/json"},
            json={"apiData": {"items": [], "layouts": []}},
            timeout=10
        )
        # Should return JSON regardless of auth status
        assert "application/json" in response.headers.get("Content-Type", "")

    def test_malformed_request_returns_error(self):
        """Verify malformed requests return appropriate errors."""
        response = requests.post(
            f"{BASE_URL}/wp-json/dittyeditor/v1/displayItems",
            headers={"Content-Type": "application/json"},
            json={},  # Missing apiData
            timeout=10
        )
        # Should return 403 (nonce error) or 404 (no api data error)
        assert response.status_code in [403, 404]
        data = response.json()
        assert "code" in data
        # Either no_nonce (fixed) or no_id/no_api_data (vulnerable)
        assert data["code"] in ["no_nonce", "no_id", "no_api_data"]

    def test_empty_apidata_returns_error(self):
        """Verify empty apiData returns appropriate error."""
        response = requests.post(
            f"{BASE_URL}/wp-json/dittyeditor/v1/displayItems",
            headers={"Content-Type": "application/json"},
            json={"apiData": {}},  # Empty apiData
            timeout=10
        )
        # Should return 403 (nonce error) or 404 (no items error)
        assert response.status_code in [403, 404]


class TestHTTPMethods:
    """Test HTTP method handling."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure WordPress is ready before tests."""
        assert wait_for_wordpress(), "WordPress failed to start"

    def test_displayitems_rejects_get(self):
        """Verify displayItems endpoint rejects GET requests."""
        response = requests.get(
            f"{BASE_URL}/wp-json/dittyeditor/v1/displayItems",
            timeout=10
        )
        # GET should not be allowed - returns 404 (route not found for GET)
        assert response.status_code in [404, 405]

    def test_displayitems_accepts_post(self):
        """Verify displayItems endpoint accepts POST requests."""
        response = requests.post(
            f"{BASE_URL}/wp-json/dittyeditor/v1/displayItems",
            headers={"Content-Type": "application/json"},
            json={"apiData": {"items": [], "layouts": []}},
            timeout=10
        )
        # POST should be accepted (200, 403, or 404 with api error)
        assert response.status_code in [200, 403, 404]
