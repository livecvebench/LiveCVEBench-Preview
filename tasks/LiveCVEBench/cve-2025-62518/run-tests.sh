#!/bin/bash
set -e

cd "$(dirname "$0")"

# Source cargo environment
. "$HOME/.cargo/env" 2>/dev/null || true
export PATH="/usr/local/cargo/bin:$PATH"

echo "=== Setting up test environment ==="

# Install uv for Python package management
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize uv project if needed
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

echo "=== Building Rust library ==="
cd /app
cargo build --release

echo "=== Creating test archive directory ==="
mkdir -p /app/tests/archives

echo "=== Running Python tests ==="
cd /tests
uv run pytest . -rA

echo "=== All tests completed ==="
