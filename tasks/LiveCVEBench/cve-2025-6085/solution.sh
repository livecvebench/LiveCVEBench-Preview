#!/bin/bash
set -e

# Fix for file upload validation issue in Make Connector plugin (CVE-2025-6085)
# The problem: Files are copied to uploads directory BEFORE validation
# The fix: Move validation BEFORE the copy() operation AND check for dangerous extensions

PLUGIN_DIR="/var/www/html/wp-content/plugins/integromat-connector"
VULN_FILE="$PLUGIN_DIR/class/class-rest-request.php"

echo "Applying fix to $VULN_FILE..."

# Verify the file exists
if [ ! -f "$VULN_FILE" ]; then
    echo "Error: Vulnerable file not found at $VULN_FILE"
    exit 1
fi

# Create fix script that performs string replacement
cat > /tmp/apply_fix.php << 'FIXSCRIPT'
<?php
$file = '/var/www/html/wp-content/plugins/integromat-connector/class/class-rest-request.php';

if (!file_exists($file)) {
    echo "Error: File not found\n";
    exit(1);
}

$content = file_get_contents($file);

// Check if already fixed (look for our security fix marker)
if (strpos($content, 'dangerous_extensions') !== false) {
    echo "Fix already applied.\n";
    exit(0);
}

// The vulnerable code block - file is copied BEFORE validation
$old_code = '	private static function upload_media() {
		$udir              = wp_upload_dir();
		$media_file_source = $udir[\'path\'] . \'/\' . sanitize_file_name( $_FILES[\'file\'][\'name\'] );

		if ( (int) $_FILES[\'file\'][\'size\'] === 0 ) {
			Rest_Response::render_error( 500, \'The uploaded file exceeds the upload_max_filesize directive in php.ini.\', \'rest_upload_unknown_error\' );
		}

		if ( (int) $_FILES[\'file\'][\'error\'] > 0 ) {
			Rest_Response::render_error( 500, \'An error has occured when uploading file to the server.\', \'rest_upload_unknown_error\' );
		}

		copy( realpath( $_FILES[\'file\'][\'tmp_name\'] ), $media_file_source );';

// The fixed code - validation happens BEFORE copy with comprehensive checks
$new_code = '	private static function upload_media() {
		$udir              = wp_upload_dir();
		$media_file_source = $udir[\'path\'] . \'/\' . sanitize_file_name( $_FILES[\'file\'][\'name\'] );

		if ( (int) $_FILES[\'file\'][\'size\'] === 0 ) {
			Rest_Response::render_error( 500, \'The uploaded file exceeds the upload_max_filesize directive in php.ini.\', \'rest_upload_unknown_error\' );
		}

		if ( (int) $_FILES[\'file\'][\'error\'] > 0 ) {
			Rest_Response::render_error( 500, \'An error has occured when uploading file to the server.\', \'rest_upload_unknown_error\' );
		}

		// Security Fix CVE-2025-6085: Validate file type BEFORE copying to uploads directory
		$pre_check_filename = sanitize_file_name( $_FILES[\'file\'][\'name\'] );

		// Check for dangerous extensions anywhere in filename (prevents double extension bypass)
		$dangerous_extensions = array( \'php\', \'php3\', \'php4\', \'php5\', \'php7\', \'phtml\', \'phar\', \'phps\' );
		$filename_lower = strtolower( $pre_check_filename );
		foreach ( $dangerous_extensions as $ext ) {
			// Check if the dangerous extension appears anywhere as a file extension
			if ( preg_match( \'/\\.\' . preg_quote( $ext, \'/\' ) . \'([._]|$)/i\', $filename_lower ) ) {
				Rest_Response::render_error( 500, \'Sorry, this file type is not permitted for security reasons.\', \'rest_upload_unknown_error\' );
				return;
			}
		}

		// Also validate using WordPress built-in function
		$pre_check_filetype = wp_check_filetype( $pre_check_filename, null );
		$pre_allowed_types  = get_allowed_mime_types();

		if ( ! in_array( $pre_check_filetype[\'type\'], $pre_allowed_types, true ) ) {
			Rest_Response::render_error( 500, \'Sorry, this file type is not permitted for security reasons.\', \'rest_upload_unknown_error\' );
			return;
		}

		copy( realpath( $_FILES[\'file\'][\'tmp_name\'] ), $media_file_source );';

// Check if vulnerable code exists
if (strpos($content, $old_code) === false) {
    echo "Warning: Expected vulnerable code pattern not found.\n";
    echo "Attempting alternative fix method...\n";

    // Alternative: Insert validation just before the copy() line
    $copy_line = 'copy( realpath( $_FILES[\'file\'][\'tmp_name\'] ), $media_file_source );';

    $validation_code = '// Security Fix CVE-2025-6085: Validate file type BEFORE copying to uploads directory
		$pre_check_filename = sanitize_file_name( $_FILES[\'file\'][\'name\'] );

		// Check for dangerous extensions anywhere in filename (prevents double extension bypass)
		$dangerous_extensions = array( \'php\', \'php3\', \'php4\', \'php5\', \'php7\', \'phtml\', \'phar\', \'phps\' );
		$filename_lower = strtolower( $pre_check_filename );
		foreach ( $dangerous_extensions as $ext ) {
			// Check if the dangerous extension appears anywhere as a file extension
			if ( preg_match( \'/\\.\' . preg_quote( $ext, \'/\' ) . \'([._]|$)/i\', $filename_lower ) ) {
				Rest_Response::render_error( 500, \'Sorry, this file type is not permitted for security reasons.\', \'rest_upload_unknown_error\' );
				return;
			}
		}

		// Also validate using WordPress built-in function
		$pre_check_filetype = wp_check_filetype( $pre_check_filename, null );
		$pre_allowed_types  = get_allowed_mime_types();

		if ( ! in_array( $pre_check_filetype[\'type\'], $pre_allowed_types, true ) ) {
			Rest_Response::render_error( 500, \'Sorry, this file type is not permitted for security reasons.\', \'rest_upload_unknown_error\' );
			return;
		}

		';

    if (strpos($content, $copy_line) !== false) {
        $content = str_replace($copy_line, $validation_code . $copy_line, $content);
        file_put_contents($file, $content);
        echo "Fix applied successfully (alternative method).\n";
        exit(0);
    } else {
        echo "Error: Could not locate copy() call.\n";
        exit(1);
    }
}

// Apply the fix
$content = str_replace($old_code, $new_code, $content);
file_put_contents($file, $content);
echo "Fix applied successfully.\n";
FIXSCRIPT

# Execute the fix script
php /tmp/apply_fix.php

# Clean up
rm -f /tmp/apply_fix.php

# Verify the fix was applied
if grep -q "dangerous_extensions" "$VULN_FILE"; then
    echo "Verification: Fix is present in the file."
else
    echo "Warning: Fix verification failed."
    exit 1
fi

# Restart PHP/Apache if running (for the changes to take effect)
# WordPress typically uses PHP-FPM or mod_php
if pgrep -x "php-fpm" > /dev/null 2>&1; then
    echo "Restarting PHP-FPM..."
    pkill -USR2 php-fpm || true
    sleep 2
fi

if pgrep -x "apache2" > /dev/null 2>&1 || pgrep -x "httpd" > /dev/null 2>&1; then
    echo "Reloading Apache..."
    apachectl graceful 2>/dev/null || apache2ctl graceful 2>/dev/null || true
    sleep 2
fi

echo "Fix applied successfully!"
