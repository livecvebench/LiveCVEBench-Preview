# Docker environment for CVE-2025-59426 - Lobe Chat Open Redirect
# Vulnerable version: commit 8711ea244c8dcb43c5cb5e74f6679633e241cea4

FROM node:20-slim

WORKDIR /app

# System dependencies (git for clone, tmux/asciinema/curl required)
RUN apt-get update && apt-get install -y \
    git \
    curl \
    tmux \
    asciinema \
    python3 \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm globally
RUN npm install -g pnpm

# Clone the vulnerable version of lobe-chat
RUN git clone --depth 1 https://github.com/lobehub/lobe-chat.git . && \
    git fetch --depth 1 origin 8711ea244c8dcb43c5cb5e74f6679633e241cea4 && \
    git checkout 8711ea244c8dcb43c5cb5e74f6679633e241cea4 && \
    rm -rf .git

# Install dependencies
RUN pnpm install

# Environment variables
ENV NODE_ENV=production
ENV APP_URL=http://localhost:3210
ENV DEBUG=lobe-oidc:*

# Keep container running
CMD ["tail", "-f", "/dev/null"]
