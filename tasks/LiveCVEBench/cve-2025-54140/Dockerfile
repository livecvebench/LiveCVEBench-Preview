FROM python:3.11-slim

WORKDIR /app

# Install system dependencies (tmux, asciinema, curl are required)
# Also install build tools needed for pycurl and cryptography
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    tmux \
    asciinema \
    curl \
    build-essential \
    libcurl4-openssl-dev \
    libssl-dev \
    python3-dev \
    libffi-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone pyload repository at vulnerable version
RUN git clone https://github.com/pyload/pyload.git . \
    && git checkout df094db67ec6e25294a9ac0ddb4375fd7fb9ba00 \
    && rm -rf .git

# Install pyload in editable mode so source code is accessible at /app/src/pyload/
RUN pip install --no-cache-dir -e .

# Create data directories
# The tmp_.. directory in storage folder is needed for path traversal to work
# (file.save() does not auto-create intermediate directories)
RUN mkdir -p /tmp/pyload-data /tmp/pyload-downloads /tmp/pyload-downloads/tmp_..

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose web interface port
EXPOSE 8000

# Startup command using entrypoint script for restart capability
# CMD ["/entrypoint.sh"]
