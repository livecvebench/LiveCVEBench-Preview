"""
Vulnerability tests for phpwcms image_resized.php path handling issue.

These tests verify the vulnerability is BLOCKED (fixed state).

In VULNERABLE state: All tests should FAIL (malicious paths are processed, not blocked)
In FIXED state: All tests should PASS (malicious paths are blocked)

Test strategy:
- Each test uses paths that ACTUALLY WORK in the vulnerable state
- We use real existing image files with malicious path patterns
- Tests assert that malicious paths return "Image Error" (meaning they were blocked)
- In vulnerable state, these paths are processed and return valid images, causing test FAILURE

IMPORTANT: Only include tests with paths that actually work in the vulnerable code.
- phar:// and php://filter DON'T work with is_file()/getimagesize() for normal files
- file:// DOES work with is_file()/getimagesize()
- ./ and ../ and absolute paths all work with is_file()/getimagesize()
"""
import os
import requests
import pytest

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")

# These image files exist in the container and are used to demonstrate the vulnerability
# The vulnerable code will process these paths while the fixed code blocks them
EXISTING_IMAGE_1 = "img/leer.gif"
EXISTING_IMAGE_2 = "img/test.jpg"
EXISTING_IMAGE_SUBDIR = "img/ajax/bar.gif"


def is_image_error_response(response):
    """
    Check if the response is an "Image Error" response.
    The fixed version returns a small PNG with "Image Error" text for blocked paths.
    Error image characteristics: image/png, ~200-300 bytes, 75x20 pixels
    """
    if response.status_code != 200:
        return False
    if "image/png" not in response.headers.get("Content-Type", ""):
        return False
    # Error image is very small (< 500 bytes)
    if len(response.content) > 500:
        return False
    return True


class TestDotSlashVulnerability:
    """
    Test ./ prefix path handling.

    VULNERABLE: ./img/leer.gif is processed -> returns valid image (larger) -> test FAILS
    FIXED: ./img/leer.gif is blocked -> returns Image Error -> test PASSES
    """

    def test_dot_slash_prefix_blocked(self):
        """Paths starting with ./ pointing to existing image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"./{EXISTING_IMAGE_1}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"./{EXISTING_IMAGE_1} should be blocked (got {len(response.content)} bytes)"

    def test_dot_slash_nested_blocked(self):
        """Nested ./ paths to existing image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"./{EXISTING_IMAGE_SUBDIR}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"./{EXISTING_IMAGE_SUBDIR} should be blocked"

    def test_dot_slash_with_test_image_blocked(self):
        """./path/to/file patterns should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"./{EXISTING_IMAGE_2}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"./{EXISTING_IMAGE_2} should be blocked"


class TestPathTraversalVulnerability:
    """
    Test path traversal handling.

    Tests use paths that resolve to existing images via traversal.
    VULNERABLE: img/../img/leer.gif is processed -> returns valid image -> test FAILS
    FIXED: path with ../ is blocked -> returns Image Error -> test PASSES
    """

    def test_embedded_traversal_blocked(self):
        """Embedded ../ traversal to existing image should be blocked."""
        # img/../img/leer.gif resolves to img/leer.gif
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"img/../{EXISTING_IMAGE_1}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"img/../{EXISTING_IMAGE_1} should be blocked"

    def test_double_traversal_blocked(self):
        """Multiple ../ traversals resolving to existing image should be blocked."""
        # img/ajax/../../img/leer.gif resolves to img/leer.gif
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"img/ajax/../../{EXISTING_IMAGE_1}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"Double traversal to {EXISTING_IMAGE_1} should be blocked"

    def test_traversal_to_subdir_blocked(self):
        """Traversal resolving to subdirectory image should be blocked."""
        # img/../img/ajax/bar.gif resolves to img/ajax/bar.gif
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"img/../{EXISTING_IMAGE_SUBDIR}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"Traversal to {EXISTING_IMAGE_SUBDIR} should be blocked"

    def test_parent_traversal_blocked(self):
        """Paths using ../ to navigate to existing image should be blocked."""
        # From /var/www/html, ../html/img/leer.gif resolves to /var/www/html/img/leer.gif
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"../html/{EXISTING_IMAGE_1}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"../html/{EXISTING_IMAGE_1} should be blocked"


class TestAbsolutePathVulnerability:
    """
    Test absolute path handling.

    VULNERABLE: /var/www/html/img/leer.gif is processed -> returns valid image -> test FAILS
    FIXED: paths starting with / are blocked -> returns Image Error -> test PASSES
    """

    def test_absolute_path_to_image_blocked(self):
        """Absolute path to existing web image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"/var/www/html/{EXISTING_IMAGE_1}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"/var/www/html/{EXISTING_IMAGE_1} should be blocked"

    def test_absolute_path_to_subdir_image_blocked(self):
        """Absolute path to subdirectory image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"/var/www/html/{EXISTING_IMAGE_SUBDIR}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"/var/www/html/{EXISTING_IMAGE_SUBDIR} should be blocked"

    def test_absolute_path_to_test_image_blocked(self):
        """Absolute path to test image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"/var/www/html/{EXISTING_IMAGE_2}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"/var/www/html/{EXISTING_IMAGE_2} should be blocked"


class TestFileProtocolVulnerability:
    """
    Test file:// protocol handling.

    file:// works with is_file() and getimagesize() for existing images.
    VULNERABLE: file:///var/www/html/img/leer.gif is processed -> returns valid image -> test FAILS
    FIXED: file:// protocol is blocked -> returns Image Error -> test PASSES
    """

    def test_file_protocol_image_blocked(self):
        """file:// protocol to existing image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"file:///var/www/html/{EXISTING_IMAGE_1}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"file:///var/www/html/{EXISTING_IMAGE_1} should be blocked"

    def test_file_protocol_subdir_image_blocked(self):
        """file:// protocol to subdirectory image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"file:///var/www/html/{EXISTING_IMAGE_SUBDIR}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"file:///var/www/html/{EXISTING_IMAGE_SUBDIR} should be blocked"

    def test_file_protocol_test_image_blocked(self):
        """file:// protocol to test image should be blocked."""
        response = requests.get(
            f"{BASE_URL}/image_resized.php",
            params={"format": "jpg", "imgfile": f"file:///var/www/html/{EXISTING_IMAGE_2}"},
            timeout=10
        )
        assert is_image_error_response(response), \
            f"file:///var/www/html/{EXISTING_IMAGE_2} should be blocked"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
