#!/bin/bash

# Entrypoint script for SimStudio CVE-2025-7107
# Wraps the Next.js server in a restart loop for solution.sh compatibility

# Increase file descriptor limits
ulimit -n 65536 2>/dev/null || true

# Function to handle SIGTERM
cleanup() {
    echo "Received SIGTERM, stopping server..."
    kill $SERVER_PID 2>/dev/null
    exit 0
}

trap cleanup SIGTERM SIGINT

cd /app/apps/sim

# Try production server first, fall back to dev if no build exists
while true; do
    if [ -f ".next/BUILD_ID" ]; then
        echo "Starting SimStudio production server..."
        bun run start --port 3000 --hostname 0.0.0.0 &
    else
        echo "No production build found, starting dev server..."
        # For dev mode, use polling to reduce file watchers
        WATCHPACK_POLLING=true bun run dev --port 3000 --hostname 0.0.0.0 &
    fi
    SERVER_PID=$!

    # Wait for the server process
    wait $SERVER_PID
    EXIT_CODE=$?

    echo "Server exited with code $EXIT_CODE, restarting in 1 second..."
    sleep 1
done
