"""
Vulnerability tests for the Voting System.
These tests verify that stored XSS vulnerability is properly mitigated.

In vulnerable state: FAIL (XSS payload is not escaped, executes in browser)
In fixed state: PASS (XSS payload is properly escaped as HTML entities)

Note: The application has SQL injection issues with single quotes, so XSS payloads
must avoid single quotes to ensure they get stored in the database.

IMPORTANT: The voters.firstname column is varchar(30), so payloads must be <= 30 chars.
We use short 4-char unique IDs to fit within the column limit.
"""

import pytest
import requests
import uuid
import html

BASE_URL = "http://localhost:80"
ADMIN_LOGIN_URL = f"{BASE_URL}/admin/login.php"
VOTERS_URL = f"{BASE_URL}/admin/voters.php"
VOTERS_ADD_URL = f"{BASE_URL}/admin/voters_add.php"
CANDIDATES_URL = f"{BASE_URL}/admin/candidates.php"
CANDIDATES_ADD_URL = f"{BASE_URL}/admin/candidates_add.php"

ADMIN_USERNAME = "harie"
ADMIN_PASSWORD = "Admin@123"


def short_id():
    """Generate a short 3-char unique ID to keep payloads under 30 chars."""
    return str(uuid.uuid4())[:3]


class TestVotersXSSVulnerability:
    """Test XSS vulnerabilities in voter management."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "login": ""
        }
        session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)
        return session

    def test_xss_script_tag_in_firstname_blocked(self, admin_session):
        """Test that <script> tags in firstname are properly escaped."""
        uid = short_id()
        # 27 chars: <script>alert(1234)</script>
        xss_payload = f"<script>alert({uid})</script>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"XSSLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        # Add the voter with XSS payload
        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)

        # Get the voters list page
        response = admin_session.get(VOTERS_URL)

        # The raw script tag should NOT appear in the HTML
        # It should be escaped to &lt;script&gt; or similar
        assert xss_payload not in response.text, \
            "XSS payload was not escaped - script tag appears raw in HTML"

    def test_xss_script_tag_in_lastname_blocked(self, admin_session):
        """Test that <script> tags in lastname are properly escaped."""
        uid = short_id()
        # 27 chars fits in varchar(30)
        xss_payload = f"<script>alert({uid})</script>"

        voter_data = {
            "firstname": f"First{uid}",
            "lastname": xss_payload,
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        assert xss_payload not in response.text, \
            "XSS payload was not escaped - script tag appears raw in HTML"

    def test_xss_img_onerror_in_firstname_blocked(self, admin_session):
        """Test that img onerror XSS in firstname is properly escaped."""
        uid = short_id()
        # 29 chars: <img src=x onerror=alert(1)>
        xss_payload = f"<img onerror=alert({uid}) src=x>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"ImgLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        # The raw img tag with onerror should not appear
        assert xss_payload not in response.text, \
            "XSS payload was not escaped - img onerror tag appears raw in HTML"

    def test_xss_svg_onload_blocked(self, admin_session):
        """Test that SVG onload XSS is properly escaped."""
        uid = short_id()
        # 23 chars: <svg onload=alert(1234)>
        xss_payload = f"<svg onload=alert({uid})>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"SvgLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        assert xss_payload not in response.text, \
            "XSS payload was not escaped - svg onload tag appears raw in HTML"

    def test_xss_body_onload_blocked(self, admin_session):
        """Test that body onload XSS is properly escaped."""
        uid = short_id()
        # 25 chars: <body onload=alert(1234)>
        xss_payload = f"<body onload=alert({uid})>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"BodyLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        # Should not appear as raw HTML
        assert xss_payload not in response.text, \
            "XSS payload was not escaped"

    def test_xss_iframe_src_blocked(self, admin_session):
        """Test that iframe src with javascript is properly escaped."""
        uid = short_id()
        # 28 chars: <iframe src=j:alert(1234)>
        xss_payload = f"<iframe src=j:alert({uid})>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"IframeLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        assert xss_payload not in response.text, \
            "XSS payload was not escaped - iframe tag appears raw in HTML"

    def test_xss_anchor_href_blocked(self, admin_session):
        """Test that anchor href with javascript is properly escaped."""
        uid = short_id()
        # 27 chars: <a href=j:alert(1234)>X</a>
        xss_payload = f"<a href=j:alert({uid})>X</a>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"AnchorLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        assert xss_payload not in response.text, \
            "XSS payload was not escaped - anchor tag appears in HTML"

    def test_xss_input_onfocus_blocked(self, admin_session):
        """Test that input onfocus XSS is properly escaped."""
        uid = short_id()
        # 29 chars: <input onfocus=alert(1234)>
        xss_payload = f"<input onfocus=alert({uid})>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"InputLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        # Check that the onfocus is escaped
        assert xss_payload not in response.text, \
            "XSS payload was not escaped - onfocus attribute appears in HTML"

    def test_xss_mixed_case_script_blocked(self, admin_session):
        """Test that mixed-case script tags are also blocked."""
        uid = short_id()
        # 27 chars: <ScRiPt>alert(1234)</sCrIpT>
        xss_payload = f"<ScRiPt>alert({uid})</sCrIpT>"

        voter_data = {
            "firstname": xss_payload,
            "lastname": f"MixedLast{uid}",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        # Mixed case script tag should also be escaped
        assert xss_payload not in response.text, \
            "Mixed-case XSS payload was not escaped"


class TestCandidatesXSSVulnerability:
    """Test XSS vulnerabilities in candidate management."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "login": ""
        }
        session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)
        return session

    @pytest.fixture
    def position_id(self, admin_session):
        """Get or create a position for testing candidates."""
        return "1"

    def test_xss_script_tag_in_candidate_firstname_blocked(self, admin_session, position_id):
        """Test that <script> tags in candidate firstname are properly escaped."""
        uid = short_id()
        xss_payload = f"<script>alert({uid})</script>"

        candidate_data = {
            "firstname": xss_payload,
            "lastname": f"CandLast{uid}",
            "position": position_id,
            "platform": "Test platform",
            "add": ""
        }

        admin_session.post(CANDIDATES_ADD_URL, data=candidate_data, allow_redirects=True)
        response = admin_session.get(CANDIDATES_URL)

        assert xss_payload not in response.text, \
            "XSS payload in candidate firstname was not escaped"

    def test_xss_script_tag_in_candidate_lastname_blocked(self, admin_session, position_id):
        """Test that <script> tags in candidate lastname are properly escaped."""
        uid = short_id()
        xss_payload = f"<script>alert({uid})</script>"

        candidate_data = {
            "firstname": f"CandFirst{uid}",
            "lastname": xss_payload,
            "position": position_id,
            "platform": "Test platform",
            "add": ""
        }

        admin_session.post(CANDIDATES_ADD_URL, data=candidate_data, allow_redirects=True)
        response = admin_session.get(CANDIDATES_URL)

        assert xss_payload not in response.text, \
            "XSS payload in candidate lastname was not escaped"

    def test_xss_img_onerror_in_candidate_blocked(self, admin_session, position_id):
        """Test that img onerror in candidate names is properly escaped."""
        uid = short_id()
        xss_payload = f"<img onerror=alert({uid}) src=x>"

        candidate_data = {
            "firstname": xss_payload,
            "lastname": f"CandLast{uid}",
            "position": position_id,
            "platform": "Test platform",
            "add": ""
        }

        admin_session.post(CANDIDATES_ADD_URL, data=candidate_data, allow_redirects=True)
        response = admin_session.get(CANDIDATES_URL)

        assert xss_payload not in response.text, \
            "XSS payload in candidate was not escaped"


class TestSpecialCharacterHandling:
    """Test proper handling of special HTML characters - these should FAIL in vulnerable state."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = requests.Session()
        login_data = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "login": ""
        }
        session.post(ADMIN_LOGIN_URL, data=login_data, allow_redirects=True)
        return session

    def test_angle_brackets_escaped_in_voters(self, admin_session):
        """Test that < and > are properly escaped in voter names."""
        uid = short_id()

        voter_data = {
            "firstname": f"Test<{uid}>Name",
            "lastname": f"Last<b>{uid}</b>Name",
            "password": "testpass123",
            "add": ""
        }

        admin_session.post(VOTERS_ADD_URL, data=voter_data, allow_redirects=True)
        response = admin_session.get(VOTERS_URL)

        # The raw < and > should be escaped as &lt; and &gt;
        # Check that the literal <{uid}> doesn't appear as valid HTML
        assert f"<{uid}>" not in response.text or \
               f"&lt;{uid}&gt;" in response.text, \
            "Angle brackets were not properly escaped"
