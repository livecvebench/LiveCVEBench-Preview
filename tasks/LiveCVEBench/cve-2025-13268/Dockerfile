FROM maven:3.8-openjdk-8

WORKDIR /app

# Install required system packages
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Copy Maven settings with proxy configuration
COPY task-deps/maven-settings.xml /root/.m2/settings.xml

# Clone the repository at vulnerable version
RUN git clone https://github.com/dromara/dataCompare.git . && \
    git checkout 1.0.1 && \
    rm -rf .git

# Build the application with Maven (skip tests for faster build)
RUN mvn clean package -DskipTests -B

# Copy the entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose the application port
EXPOSE 80

# Use entrypoint script for restart capability
# CMD ["/entrypoint.sh"]
