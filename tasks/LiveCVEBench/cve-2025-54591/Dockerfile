FROM php:8.2-apache-bookworm

WORKDIR /var/www/FreshRSS

# Timezone
ENV TZ=UTC

# System dependencies (git, curl, tmux, asciinema required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    libgmp-dev \
    libicu-dev \
    libzip-dev \
    libxml2-dev \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install -j$(nproc) \
    gmp \
    intl \
    zip \
    pdo_sqlite \
    pdo_mysql \
    opcache

# Enable Apache mod_rewrite and other modules
RUN a2enmod rewrite headers expires deflate remoteip

# Clone vulnerable version of FreshRSS and remove .git
RUN git clone --branch 1.26.3 --depth 1 https://github.com/FreshRSS/FreshRSS.git . && \
    rm -rf .git

# Copy Apache configuration for Debian
COPY task-deps/freshrss-debian.conf /etc/apache2/sites-available/freshrss.conf

# Disable default site and enable FreshRSS site
RUN a2dissite 000-default && a2ensite freshrss

# Disable built-in updates for Docker
RUN sed -r -i "\\#disable_update#s#^.*#\t'disable_update' => true,#" ./config.default.php

# Create necessary directories
RUN mkdir -p /run/apache2/ /var/www/FreshRSS/data

# Set permissions
RUN chown -R www-data:www-data /var/www/FreshRSS

# Copy entrypoint script (Debian compatible version)
COPY task-deps/entrypoint-debian.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables for auto-installation
ENV FRESHRSS_INSTALL="--default_user admin --auth_type form"
ENV FRESHRSS_USER="--user admin --password admin123 --language en"


RUN mkdir -p /tests /oracle
# ENTRYPOINT ["/entrypoint.sh"]
# CMD ["apache2-foreground"]
