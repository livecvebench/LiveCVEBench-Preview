"""
Functional tests for ClipBucket V5.
These tests verify basic application functionality and should pass
both before and after the security fix is applied.
"""

import pytest
import requests
import subprocess
import time
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost")

# Database connection settings from environment
DB_HOST = os.environ.get("DB_HOST", "localhost")
DB_USER = os.environ.get("DB_USER", "clipbucket")
DB_PASS = os.environ.get("DB_PASS", os.environ.get("MYSQL_PASSWORD", "clipbucket"))
DB_NAME = os.environ.get("DB_NAME", "clipbucket")


def get_db_connection():
    """Get a MySQL database connection."""
    import mysql.connector
    return mysql.connector.connect(
        host=DB_HOST,
        user=DB_USER,
        password=DB_PASS,
        database=DB_NAME
    )


def get_template_dir_from_db():
    """Get the current template_dir value from the database."""
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT value FROM cb_config WHERE name='template_dir'")
    result = cursor.fetchone()
    cursor.close()
    conn.close()
    return result[0] if result else None


def reset_template_dir():
    """Reset template_dir to the default value."""
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("UPDATE cb_config SET value='cb_28' WHERE name='template_dir'")
    conn.commit()
    cursor.close()
    conn.close()


class TestBasicFunctionality:
    """Tests for basic ClipBucket functionality."""

    @pytest.fixture(autouse=True)
    def setup_and_teardown(self):
        """Ensure clean state before and after each test."""
        # Reset template directory before test
        try:
            reset_template_dir()
        except Exception:
            pass  # Database may not be ready yet
        yield
        # Reset template directory after test
        try:
            reset_template_dir()
        except Exception:
            pass

    def test_homepage_loads(self):
        """Test that the homepage loads successfully."""
        response = requests.get(f"{BASE_URL}/", timeout=10, allow_redirects=False)
        # Should return 200 OK, redirect (302), or 500 (PHP error but server works)
        # ClipBucket may redirect to installer if not fully configured
        assert response.status_code in [200, 302, 500], \
            f"Homepage returned unexpected status: {response.status_code}"

    def test_404_page_loads(self):
        """Test that the 404 page loads successfully."""
        response = requests.get(f"{BASE_URL}/404.php", timeout=10, allow_redirects=False)
        # 404.php should load (may redirect to installer or return 200/500)
        assert response.status_code in [200, 302, 404, 500], \
            f"404 page returned unexpected status: {response.status_code}"

    def test_template_directory_valid(self):
        """Test that the template directory is set to a valid value."""
        template_dir = get_template_dir_from_db()
        assert template_dir is not None, "Template directory not found in database"
        # Template should not contain path traversal sequences
        assert ".." not in template_dir, \
            f"Template directory contains path traversal: {template_dir}"
        # Template should be a simple directory name
        assert template_dir == "cb_28" or template_dir.startswith("cb_"), \
            f"Template directory has unexpected value: {template_dir}"

    def test_web_server_responds(self):
        """Test that web server responds to requests."""
        response = requests.get(f"{BASE_URL}/", timeout=10, allow_redirects=False)
        # Any HTTP response means server is working
        assert response.status_code > 0, "Web server not responding"

    def test_php_works(self):
        """Test that PHP is functioning by checking index.php responds."""
        # Check that index.php returns a valid response (PHP is working)
        response = requests.get(f"{BASE_URL}/index.php", timeout=10, allow_redirects=False)
        # Should return 200, 302 (redirect), or 500 (PHP error but working)
        assert response.status_code in [200, 302, 500], \
            f"PHP check returned unexpected status: {response.status_code}"


class TestDatabaseConnectivity:
    """Tests for database connectivity."""

    def test_database_connection(self):
        """Test that we can connect to the database."""
        conn = get_db_connection()
        assert conn.is_connected(), "Database connection failed"
        conn.close()

    def test_cb_config_table_exists(self):
        """Test that the cb_config table exists and has data."""
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM cb_config")
        count = cursor.fetchone()[0]
        cursor.close()
        conn.close()
        assert count > 0, "cb_config table is empty"

    def test_template_dir_config_exists(self):
        """Test that template_dir configuration exists in database."""
        template_dir = get_template_dir_from_db()
        assert template_dir is not None, "template_dir configuration not found in database"
