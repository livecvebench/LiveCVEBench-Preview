FROM node:18

WORKDIR /workspace

# System dependencies (tmux, asciinema, curl are required for terminal-bench)
RUN apt-get update && \
    apt-get install -y git tmux asciinema curl bash gcc g++ wget && \
    rm -rf /var/lib/apt/lists/*

# Configure npm for better network handling
RUN npm config set fetch-retries 5 && \
    npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000

# Clone vulnerable version of aws-amplify/amplify-codegen-ui at v2.20.2
RUN git clone --branch v2.20.2 --depth 1 https://github.com/aws-amplify/amplify-codegen-ui.git . && \
    rm -rf .git

# Increase Node.js memory limit for large builds
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Install root dependencies with retry
RUN npm install || npm install || npm install

# Install lerna globally and bootstrap the monorepo
RUN npm install -g lerna && npx lerna bootstrap

# Build all packages
RUN npm run build

# Copy task-deps files for reference testing
COPY task-deps/ /task-deps/

# Keep container running
# CMD ["tail", "-f", "/dev/null"]
