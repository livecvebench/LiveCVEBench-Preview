#!/usr/bin/env python3
"""
Functionality tests for RemoteClinic staff profile editor.

These tests verify that the application works correctly:
- Staff edit page is accessible
- Valid image uploads work
- Profile updates work
"""

import pytest
import requests
import os
import hashlib
from datetime import datetime
import time

# Base URL for the application
BASE_URL = os.environ.get("APP_URL", "http://localhost")

# Default credentials from the database
ADMIN_USER = "admin@domain.ext"
ADMIN_PASSWORD = "remoteclinic"

# Test staff ID (Woolnough Smith has id=10)
TEST_STAFF_ID = "10"


def get_extra_key():
    """
    Generate the extra_key required for login.
    The key is MD5 hash of a formatted date string.
    """
    # Format: "AM  Mon, Jan 1st, 2024" - but the day suffix logic is specific
    now = datetime.now()
    ampm = now.strftime("%p")
    day_name = now.strftime("%a")
    month = now.strftime("%b")
    day = now.day
    year = now.strftime("%Y")

    # Determine day suffix
    if day in [1, 21, 31]:
        suffix = "st"
    elif day in [2, 22]:
        suffix = "nd"
    elif day in [3, 23]:
        suffix = "rd"
    else:
        suffix = "th"

    # Julian day
    julian = now.strftime("%j")

    # Format matches the PHP: date("A  D, M jS, Y") but %j is julian day not suffix
    # Actually from regular-functions.php: date("A  D, M jS, Y")
    date_str = f"{ampm}  {day_name}, {month} {day}{suffix}, {year}"

    return hashlib.md5(date_str.encode()).hexdigest()


def get_authenticated_session():
    """Get an authenticated session with admin credentials."""
    session = requests.Session()

    login_url = f"{BASE_URL}/login/process.php"
    extra_key = get_extra_key()

    data = {
        'user_id': ADMIN_USER,
        'password': ADMIN_PASSWORD,
        'extra_key': extra_key
    }

    response = session.post(login_url, data=data, allow_redirects=True)

    # Verify login succeeded by checking we can access dashboard
    dashboard_response = session.get(f"{BASE_URL}/dashboard/")

    return session


def create_valid_png():
    """Create a minimal valid PNG image (1x1 transparent pixel)."""
    # Minimal valid PNG - 1x1 transparent pixel
    png_data = bytes([
        0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A,  # PNG signature
        0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52,  # IHDR chunk header
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,  # Width=1, Height=1
        0x08, 0x06, 0x00, 0x00, 0x00, 0x1F, 0x15, 0xC4,  # Bit depth, color type, etc
        0x89, 0x00, 0x00, 0x00, 0x0A, 0x49, 0x44, 0x41,  # IDAT chunk
        0x54, 0x78, 0x9C, 0x63, 0x00, 0x01, 0x00, 0x00,  # Compressed data
        0x05, 0x00, 0x01, 0x0D, 0x0A, 0x2D, 0xB4, 0x00,  # More IDAT data
        0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44,  # IEND chunk
        0xAE, 0x42, 0x60, 0x82                           # IEND CRC
    ])
    return png_data


def create_valid_jpeg():
    """Create a minimal valid JPEG image."""
    # Minimal valid JPEG - 1x1 red pixel
    jpeg_data = bytes([
        0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46,  # SOI, APP0
        0x49, 0x46, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01,  # JFIF header
        0x00, 0x01, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,  # DQT
        0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08,  # Quantization table
        0x07, 0x07, 0x07, 0x09, 0x09, 0x08, 0x0A, 0x0C,
        0x14, 0x0D, 0x0C, 0x0B, 0x0B, 0x0C, 0x19, 0x12,
        0x13, 0x0F, 0x14, 0x1D, 0x1A, 0x1F, 0x1E, 0x1D,
        0x1A, 0x1C, 0x1C, 0x20, 0x24, 0x2E, 0x27, 0x20,
        0x22, 0x2C, 0x23, 0x1C, 0x1C, 0x28, 0x37, 0x29,
        0x2C, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1F, 0x27,
        0x39, 0x3D, 0x38, 0x32, 0x3C, 0x2E, 0x33, 0x34,
        0x32, 0xFF, 0xC0, 0x00, 0x0B, 0x08, 0x00, 0x01,  # SOF
        0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xFF, 0xC4,  # DHT
        0x00, 0x1F, 0x00, 0x00, 0x01, 0x05, 0x01, 0x01,
        0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0xFF,
        0xC4, 0x00, 0xB5, 0x10, 0x00, 0x02, 0x01, 0x03,
        0x03, 0x02, 0x04, 0x03, 0x05, 0x05, 0x04, 0x04,
        0x00, 0x00, 0x01, 0x7D, 0x01, 0x02, 0x03, 0x00,
        0x04, 0x11, 0x05, 0x12, 0x21, 0x31, 0x41, 0x06,
        0x13, 0x51, 0x61, 0x07, 0x22, 0x71, 0x14, 0x32,
        0x81, 0x91, 0xA1, 0x08, 0x23, 0x42, 0xB1, 0xC1,
        0x15, 0x52, 0xD1, 0xF0, 0x24, 0x33, 0x62, 0x72,
        0x82, 0x09, 0x0A, 0x16, 0x17, 0x18, 0x19, 0x1A,
        0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x34, 0x35,
        0x36, 0x37, 0x38, 0x39, 0x3A, 0x43, 0x44, 0x45,
        0x46, 0x47, 0x48, 0x49, 0x4A, 0x53, 0x54, 0x55,
        0x56, 0x57, 0x58, 0x59, 0x5A, 0x63, 0x64, 0x65,
        0x66, 0x67, 0x68, 0x69, 0x6A, 0x73, 0x74, 0x75,
        0x76, 0x77, 0x78, 0x79, 0x7A, 0x83, 0x84, 0x85,
        0x86, 0x87, 0x88, 0x89, 0x8A, 0x92, 0x93, 0x94,
        0x95, 0x96, 0x97, 0x98, 0x99, 0x9A, 0xA2, 0xA3,
        0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xB2,
        0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA,
        0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9,
        0xCA, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8,
        0xD9, 0xDA, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6,
        0xE7, 0xE8, 0xE9, 0xEA, 0xF1, 0xF2, 0xF3, 0xF4,
        0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFF, 0xDA,
        0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3F, 0x00,
        0xFB, 0xD5, 0xDB, 0x20, 0xB8, 0xED, 0xF1, 0x59,
        0xFF, 0xD9
    ])
    return jpeg_data


class TestApplicationAccess:
    """Test basic application accessibility."""

    def test_homepage_accessible(self):
        """Verify the application is running and accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=10)
        assert response.status_code in [200, 302], f"Homepage not accessible: {response.status_code}"

    def test_login_page_accessible(self):
        """Verify the login page is accessible."""
        response = requests.get(f"{BASE_URL}/login/", timeout=10)
        assert response.status_code == 200, f"Login page not accessible: {response.status_code}"


class TestAuthentication:
    """Test authentication functionality."""

    def test_successful_login(self):
        """Verify that login with valid credentials works."""
        session = get_authenticated_session()

        # Try to access a protected page
        response = session.get(f"{BASE_URL}/staff/", timeout=10)

        # Should not redirect to login page
        assert "login" not in response.url.lower() or response.status_code == 200


class TestStaffEditPage:
    """Test staff edit page functionality."""

    def test_staff_edit_page_accessible(self):
        """Verify staff edit page is accessible when authenticated."""
        session = get_authenticated_session()

        response = session.get(f"{BASE_URL}/staff/edit.php?id={TEST_STAFF_ID}", timeout=10)

        # Should be accessible (200) or redirect within the app
        assert response.status_code == 200, f"Staff edit page not accessible: {response.status_code}"

        # Should contain the edit form
        assert "first_name" in response.text.lower() or "edit" in response.text.lower()


class TestValidImageUpload:
    """Test that valid image uploads work correctly."""

    def test_upload_valid_png(self):
        """Verify that uploading a valid PNG image works."""
        session = get_authenticated_session()

        png_data = create_valid_png()

        files = {'image': ('test.png', png_data, 'image/png')}
        data = {
            'id': TEST_STAFF_ID,
            'title': 'Mr.',
            'first_name': 'Test',
            'last_name': 'User',
            'passkey': '',
            'contact': '1234567890',
            'mobile': '1234567890',
            'skype': 'test',
            'address': 'Test Address',
            'access_level': '4',
            'status': 'active',
            'branch': '1',
            'submit': 'Update'
        }

        response = session.post(
            f"{BASE_URL}/staff/edit.php?id={TEST_STAFF_ID}",
            files=files,
            data=data,
            timeout=30
        )

        assert response.status_code == 200, f"Upload request failed: {response.status_code}"
        # Profile update should succeed
        assert "success" in response.text.lower() or "updated" in response.text.lower(), \
            "Profile update with valid PNG should succeed"


class TestProfileUpdate:
    """Test profile update functionality."""

    def test_profile_update_without_image(self):
        """Verify that profile can be updated without uploading an image."""
        session = get_authenticated_session()

        # Get current profile data first
        response = session.get(f"{BASE_URL}/staff/edit.php?id={TEST_STAFF_ID}", timeout=10)
        assert response.status_code == 200

        # Update profile without image
        data = {
            'id': TEST_STAFF_ID,
            'title': 'Mr.',
            'first_name': 'Woolnough',
            'last_name': 'Smith',
            'passkey': '',
            'contact': '00102030405',
            'mobile': '00102030405',
            'skype': 'smith',
            'address': 'Smith Residence',
            'access_level': '4',
            'status': 'active',
            'branch': '13',
            'submit': 'Update'
        }

        response = session.post(
            f"{BASE_URL}/staff/edit.php?id={TEST_STAFF_ID}",
            data=data,
            timeout=30
        )

        assert response.status_code == 200, f"Update request failed: {response.status_code}"
        assert "success" in response.text.lower() or "updated" in response.text.lower(), \
            "Profile update without image should succeed"
