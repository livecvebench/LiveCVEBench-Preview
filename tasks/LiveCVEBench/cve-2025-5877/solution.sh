#!/bin/bash
# Solution script for Feng Office XXE vulnerability
# This script fixes the insecure XML parsing configuration in document text extraction

set -e

# Try both possible locations for Feng Office installation
if [ -d "/var/www/html/application" ]; then
    APP_ROOT="/var/www/html"
elif [ -d "/app/application" ]; then
    APP_ROOT="/app"
else
    echo "ERROR: Cannot find application directory"
    exit 1
fi

cd "$APP_ROOT"

echo "=== Applying fix for document processing vulnerability ==="
echo "Application root: $APP_ROOT"

# The vulnerable code is in application/functions.php
# The readZippedXML function uses dangerous libxml flags:
#   LIBXML_NOENT | LIBXML_XINCLUDE | LIBXML_NOERROR | LIBXML_NOWARNING
# These flags enable external entity processing which allows XXE attacks.
#
# The fix removes LIBXML_NOENT and LIBXML_XINCLUDE, keeping only:
#   LIBXML_NOERROR | LIBXML_NOWARNING

FUNCTIONS_FILE="${APP_ROOT}/application/functions.php"

if [ ! -f "$FUNCTIONS_FILE" ]; then
    echo "ERROR: functions.php not found at $FUNCTIONS_FILE"
    exit 1
fi

# Check if already fixed
if grep -q "LIBXML_NOENT | LIBXML_XINCLUDE | LIBXML_NOERROR | LIBXML_NOWARNING" "$FUNCTIONS_FILE"; then
    echo "Vulnerability found. Applying fix..."

    # Replace the vulnerable libxml flags with safe ones
    # Before: LIBXML_NOENT | LIBXML_XINCLUDE | LIBXML_NOERROR | LIBXML_NOWARNING
    # After:  LIBXML_NOERROR | LIBXML_NOWARNING
    sed -i 's/LIBXML_NOENT | LIBXML_XINCLUDE | LIBXML_NOERROR | LIBXML_NOWARNING/LIBXML_NOERROR | LIBXML_NOWARNING/g' "$FUNCTIONS_FILE"

    # Verify the fix was applied
    if grep -q "LIBXML_NOENT" "$FUNCTIONS_FILE"; then
        echo "ERROR: Fix may not have been applied correctly. LIBXML_NOENT still present."
        exit 1
    fi

    echo "Fix applied successfully!"
else
    echo "File appears to already be fixed or has different code structure."
    # Check if the safe pattern exists
    if grep -q "LIBXML_NOERROR | LIBXML_NOWARNING" "$FUNCTIONS_FILE"; then
        echo "Safe libxml flags are present."
    fi
fi

# Verify the fix
echo ""
echo "=== Verification ==="
if grep -q "LIBXML_NOENT" "$FUNCTIONS_FILE"; then
    echo "WARNING: LIBXML_NOENT still found in file"
    exit 1
fi

if grep -q "LIBXML_XINCLUDE" "$FUNCTIONS_FILE"; then
    echo "WARNING: LIBXML_XINCLUDE still found in file"
    exit 1
fi

echo "Verification passed: Dangerous libxml flags have been removed."

# Restart PHP/Apache if running (to reload the changed PHP file)
# PHP-FPM or Apache may cache the file
echo ""
echo "=== Restarting services if needed ==="

# Try to restart Apache if running
if pgrep -x "apache2" > /dev/null || pgrep -x "httpd" > /dev/null; then
    echo "Restarting Apache..."
    if command -v apachectl &> /dev/null; then
        apachectl graceful 2>/dev/null || true
    elif command -v apache2ctl &> /dev/null; then
        apache2ctl graceful 2>/dev/null || true
    fi
fi

# Try to restart PHP-FPM if running
if pgrep -x "php-fpm" > /dev/null; then
    echo "Restarting PHP-FPM..."
    pkill -USR2 php-fpm 2>/dev/null || true
fi

# For development servers, just kill and let entrypoint restart
if pgrep -f "php.*-S" > /dev/null; then
    echo "Stopping PHP built-in server..."
    pkill -f "php.*-S" || true
    sleep 2
fi

echo ""
echo "=== Fix complete ==="
echo "The document processing vulnerability has been fixed."
echo "External entity processing has been disabled in XML parsing."
