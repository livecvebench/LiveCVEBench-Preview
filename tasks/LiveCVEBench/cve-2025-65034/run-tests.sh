#!/bin/bash
cd "$(dirname "$0")"

# Wait for application to be ready
echo "Waiting for application to be ready..."
MAX_RETRIES=30
RETRY_COUNT=0

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200\|301\|302"; then
        echo "Application is ready!"
        break
    fi
    echo "Waiting for application... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
    sleep 2
    RETRY_COUNT=$((RETRY_COUNT + 1))
done

if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    echo "Warning: Application may not be fully ready, proceeding with tests anyway..."
fi

# Run all tests together
echo ""
echo "Running all tests..."
python3 -m pytest test_func.py test_vuln.py -rA --tb=line 2>&1

echo ""
echo "Tests completed!"
