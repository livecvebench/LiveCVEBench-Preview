# Dockerfile for CVE-2025-7107 - SimStudio Path Traversal
# Using Debian-based Bun image (NOT Alpine due to network issues)
FROM oven/bun:1 AS base

# Proxy settings are injected via standard http_proxy/https_proxy build args
# Docker automatically makes these available during build

WORKDIR /app

# Install system dependencies (git, tmux, asciinema, curl are required)
# Also install Python and pip for running tests
RUN apt-get update && \
    apt-get install -y git tmux asciinema curl procps postgresql-client python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*

# Install uv (Python package manager) for running tests
RUN curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh && \
    ln -s /root/.local/bin/uv /usr/local/bin/uv

# Clone the vulnerable version (full clone needed to access the specific commit)
RUN git clone https://github.com/simstudioai/sim.git . && \
    git checkout 8c268e2 && \
    rm -rf .git

# Install dependencies
RUN bun install --ignore-scripts

# Install sharp for Next.js image optimization
WORKDIR /app/apps/sim
RUN bun install sharp

# Back to root
WORKDIR /app

# Create uploads directory
RUN mkdir -p /app/apps/sim/uploads

# Copy task-deps files (fixed version for solution.sh)
COPY task-deps/ /task-deps/

# Copy entrypoint
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment for Next.js
ENV NEXT_TELEMETRY_DISABLED=1
ENV VERCEL_TELEMETRY_DISABLED=1
ENV NODE_ENV=development
ENV PORT=3000
ENV HOSTNAME=0.0.0.0


# CMD ["/entrypoint.sh"]
