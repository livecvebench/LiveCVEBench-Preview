"""
Vulnerability tests for ValidatePackageNames validator.

These tests verify that the prefix matching vulnerability is fixed.
- FAIL in vulnerable state (vulnerability is exploitable - malicious packages pass validation)
- PASS in fixed state (vulnerability is mitigated - malicious packages are rejected)
"""

import json
import subprocess
import os

# Path to the app directory in container
APP_DIR = "/app"


def run_validator(packages_dict, aliases=None):
    """
    Run the ValidatePackageNames validator with the given packages.
    Returns the validation result as a dict with 'type' and 'errors' keys.
    """
    alias_arg = f", {json.dumps(aliases)}" if aliases else ""

    test_script = f"""
const ValidatePackageNames = require('{APP_DIR}/src/validators/ValidatePackageNames.js');

const packages = {json.dumps(packages_dict)};

const validator = new ValidatePackageNames({{ packages }});
const result = validator.validate({alias_arg});
console.log(JSON.stringify(result));
"""

    result = subprocess.run(
        ['node', '-e', test_script],
        capture_output=True,
        text=True,
        timeout=30
    )

    if result.returncode != 0:
        raise RuntimeError(f"Node script failed: {result.stderr}")

    return json.loads(result.stdout.strip())


class TestPrefixBypassVulnerability:
    """
    Test cases that verify the prefix matching bypass vulnerability is fixed.

    The vulnerability allows packages with names that START WITH the expected package name
    to bypass validation. For example, if the declared package is "commander", the validator
    incorrectly accepts URLs pointing to "commander2", "commanderx", etc.
    """

    def test_basic_prefix_bypass_suffix_number(self):
        """
        Test: Declared 'commander' but resolved URL points to 'commander2'.

        Expected: Validation should FAIL (reject the mismatched package)
        Vulnerable: Validation passes (prefix match succeeds incorrectly)
        """
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.npmjs.org/commander2/-/commander-4.1.1.tgz",
                "integrity": "sha512-NOKm8xhkzAjzFx8B2v5OAHT+u5pRQc2UCa2Vq9jYL/31o2wi9mxBA7LIFs3sV5VSC49z6pEhfbMULvShKj26WA=="
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Validation should have FAILED for mismatched package name. Got: {result}"
        assert len(result["errors"]) > 0, \
            f"Expected errors to be reported for the mismatched package"
        assert any("commander" in e.get("package", "") or "commander" in e.get("message", "")
                   for e in result["errors"]), \
            f"Expected error to mention the package name mismatch"

    def test_prefix_bypass_suffix_letter(self):
        """
        Test: Declared 'commander' but resolved URL points to 'commanderx'.

        Expected: Validation should FAIL
        """
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.npmjs.org/commanderx/-/commanderx-4.1.1.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Validation should have FAILED. Got: {result}"
        assert len(result["errors"]) > 0

    def test_prefix_bypass_suffix_hyphen(self):
        """
        Test: Declared 'express' but resolved URL points to 'express-malicious'.

        Expected: Validation should FAIL
        """
        packages = {
            "express@4.17.1": {
                "version": "4.17.1",
                "resolved": "https://registry.npmjs.org/express-malicious/-/express-malicious-4.17.1.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Validation should have FAILED. Got: {result}"
        assert len(result["errors"]) > 0

    def test_prefix_bypass_suffix_underscore(self):
        """
        Test: Declared 'lodash' but resolved URL points to 'lodash_evil'.

        Expected: Validation should FAIL
        """
        packages = {
            "lodash@4.17.21": {
                "version": "4.17.21",
                "resolved": "https://registry.npmjs.org/lodash_evil/-/lodash_evil-4.17.21.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Validation should have FAILED. Got: {result}"
        assert len(result["errors"]) > 0


class TestScopedPackageBypass:
    """Test prefix bypass vulnerability with scoped packages."""

    def test_scoped_package_prefix_bypass(self):
        """
        Test: Declared '@babel/core' but resolved URL points to '@babel/core-evil'.

        Expected: Validation should FAIL
        """
        packages = {
            "@babel/core@7.12.0": {
                "version": "7.12.0",
                "resolved": "https://registry.npmjs.org/@babel/core-evil/-/core-evil-7.12.0.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Scoped package bypass should have FAILED. Got: {result}"
        assert len(result["errors"]) > 0

    def test_scoped_package_extended_name(self):
        """
        Test: Declared '@types/node' but resolved URL points to '@types/node2'.

        Expected: Validation should FAIL
        """
        packages = {
            "@types/node@16.0.0": {
                "version": "16.0.0",
                "resolved": "https://registry.npmjs.org/@types/node2/-/node2-16.0.0.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Validation should have FAILED. Got: {result}"
        assert len(result["errors"]) > 0


class TestMultipleMaliciousPackages:
    """Test detection of multiple malicious packages in one lockfile."""

    def test_multiple_prefix_bypass_attempts(self):
        """
        Test: Multiple packages with prefix bypass attacks.

        Expected: All malicious packages should be detected and reported
        """
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.npmjs.org/commander2/-/commander-4.1.1.tgz",
                "integrity": "sha512-..."
            },
            "express@4.17.1": {
                "version": "4.17.1",
                "resolved": "https://registry.npmjs.org/expressx/-/expressx-4.17.1.tgz",
                "integrity": "sha512-..."
            },
            "lodash@4.17.21": {
                "version": "4.17.21",
                "resolved": "https://registry.npmjs.org/lodash-evil/-/lodash-evil-4.17.21.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! All mismatched packages should be caught. Got: {result}"
        # Should have at least one error (ideally 3, one for each malicious package)
        assert len(result["errors"]) >= 1, \
            f"Expected multiple errors for multiple malicious packages"

    def test_mixed_valid_and_malicious_packages(self):
        """
        Test: Mix of legitimate and malicious packages.

        Expected: Malicious packages should be detected, legitimate ones should pass
        """
        packages = {
            # Valid package
            "axios@0.21.1": {
                "version": "0.21.1",
                "resolved": "https://registry.npmjs.org/axios/-/axios-0.21.1.tgz",
                "integrity": "sha512-..."
            },
            # Malicious - prefix bypass
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.npmjs.org/commander2/-/commander-4.1.1.tgz",
                "integrity": "sha512-..."
            },
            # Valid package
            "moment@2.29.1": {
                "version": "2.29.1",
                "resolved": "https://registry.npmjs.org/moment/-/moment-2.29.1.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Mixed packages test failed. Got: {result}"
        assert len(result["errors"]) >= 1, \
            "Should detect the malicious commander package"


class TestEdgeCasePrefixBypasses:
    """Test edge cases and boundary conditions for prefix bypass."""

    def test_single_char_extension(self):
        """
        Test: Package name extended by single character ('a' -> 'ab').

        Expected: Validation should FAIL
        """
        packages = {
            "a@1.0.0": {
                "version": "1.0.0",
                "resolved": "https://registry.npmjs.org/ab/-/ab-1.0.0.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Single char extension bypass should FAIL. Got: {result}"

    def test_meow_to_meowlicious(self):
        """
        Test: Declared 'meow' but resolved URL points to 'meowlicious'.

        This is the exact test case from the official test suite.
        """
        packages = {
            "meow@10.0.0": {
                "version": "10.0.0",
                "resolved": "https://registry.npmjs.org/meowlicious/-/meowlicious-10.0.0.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! meow -> meowlicious bypass should FAIL. Got: {result}"

    def test_package_with_similar_version_pattern(self):
        """
        Test: Package with tarball name that looks legitimate but wrong package dir.
        """
        packages = {
            "react@17.0.2": {
                "version": "17.0.2",
                # Different package (react2) but tarball name looks similar
                "resolved": "https://registry.npmjs.org/react2/-/react-17.0.2.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! react -> react2 bypass should FAIL. Got: {result}"


class TestYarnRegistryBypass:
    """Test prefix bypass vulnerability on yarn registry."""

    def test_yarn_registry_prefix_bypass(self):
        """
        Test: Prefix bypass attack using yarn registry URL.

        Expected: Validation should FAIL
        """
        packages = {
            "commander@4.1.1": {
                "version": "4.1.1",
                "resolved": "https://registry.yarnpkg.com/commander2/-/commander-4.1.1.tgz",
                "integrity": "sha512-..."
            }
        }

        result = run_validator(packages)

        assert result["type"] == "error", \
            f"Vulnerability detected! Yarn registry prefix bypass should FAIL. Got: {result}"


