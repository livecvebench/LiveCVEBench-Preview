#!/bin/bash
cd "$(dirname "$0")"

echo "Setting up test environment..."

# Try to install uv, fall back to pip if network fails
if ! command -v uv &> /dev/null; then
    curl -LsSf --connect-timeout 10 https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    if [ -f "$HOME/.local/bin/env" ]; then
        source $HOME/.local/bin/env
    fi
fi

if command -v uv &> /dev/null; then
    echo "Using uv..."
    uv init 2>/dev/null || true
    uv add pytest 2>/dev/null
    echo "Running tests..."
    uv run pytest test_func.py test_vuln.py -rA --tb=no || true
else
    echo "uv not available, using pip..."
    pip3 install pytest --break-system-packages 2>/dev/null || pip3 install pytest 2>/dev/null || pip install pytest 2>/dev/null
    echo "Running tests..."
    python3 -m pytest test_func.py test_vuln.py -rA --tb=no || true
fi

echo "All tests completed!"
