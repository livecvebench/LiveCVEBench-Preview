#!/bin/bash
set -e
cd /app

echo "Applying fix for GIF decoder comment block EOF handling..."

# Find the GifDecoderCore.cs file
GIF_DECODER_FILE=$(find . -name "GifDecoderCore.cs" -path "*/Formats/Gif/*" 2>/dev/null | head -1)

if [ -z "$GIF_DECODER_FILE" ]; then
    echo "Error: GifDecoderCore.cs not found"
    exit 1
fi

echo "Found: $GIF_DECODER_FILE"

# Check if fix is already applied
if grep -q "if (length == -1)" "$GIF_DECODER_FILE"; then
    echo "Fix already applied (EOF check already exists)"
else
    # Apply the fix using sed
    # The vulnerable pattern is:
    #   while ((length = stream.ReadByte()) != 0)
    #   {
    #       if (length > GifConstants.MaxCommentSubBlockLength)
    #
    # We need to insert the EOF check after the opening brace of the while loop

    # Use a temp file for the fix
    TEMP_FILE=$(mktemp)
    cp "$GIF_DECODER_FILE" "$TEMP_FILE"

    # Apply the fix - insert EOF check after "while ((length = stream.ReadByte()) != 0)" and opening brace
    # We match the line with "if (length > GifConstants.MaxCommentSubBlockLength)" and insert before it
    sed -i '/if (length > GifConstants.MaxCommentSubBlockLength)/i\
            if (length == -1)\
            {\
                GifThrowHelper.ThrowInvalidImageContentException(\
                    "Unexpected end of stream while reading gif comment");\
            }\
' "$GIF_DECODER_FILE"

    # Verify the fix was applied
    if grep -q "if (length == -1)" "$GIF_DECODER_FILE"; then
        echo "Fix applied successfully!"
        echo ""
        echo "Added EOF check in ReadComments method:"
        echo "  - Checks if ReadByte() returns -1 (EOF)"
        echo "  - Throws InvalidImageContentException on unexpected EOF"
        echo "  - Prevents infinite loop on malformed GIF files"
    else
        echo "Error: Failed to apply fix"
        # Restore original
        cp "$TEMP_FILE" "$GIF_DECODER_FILE"
        rm "$TEMP_FILE"
        exit 1
    fi

    rm "$TEMP_FILE"
fi

# Remove problematic Azure DevOps NuGet source that may be unreachable
echo ""
echo "Fixing NuGet sources..."
GLOBAL_PROPS="/app/ImageSharp/shared-infrastructure/msbuild/props/SixLabors.Global.props"
if [ -f "$GLOBAL_PROPS" ]; then
    # Remove the Azure DevOps feed line as it can be unreliable
    sed -i '/pkgs.dev.azure.com/d' "$GLOBAL_PROPS"
    echo "Removed problematic Azure DevOps NuGet source"
fi

# Rebuild the ImageSharp source with the fix
echo ""
echo "Rebuilding ImageSharp from source..."
dotnet restore /app/ImageSharp/src/ImageSharp/ImageSharp.csproj
dotnet build /app/ImageSharp/src/ImageSharp/ImageSharp.csproj -c Release

# Rebuild the test project using source reference (not NuGet package)
echo ""
echo "Rebuilding test project using fixed source..."
dotnet restore /app/test/ImageTestFromSource.csproj
dotnet build /app/test/ImageTestFromSource.csproj -c Release

# Publish the test project (for faster execution)
echo ""
echo "Publishing test project..."
dotnet publish /app/test/ImageTestFromSource.csproj -c Release -o /app/test/publish --no-build

echo ""
echo "Fix complete!"
