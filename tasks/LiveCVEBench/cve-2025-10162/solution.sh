#!/bin/bash
set -e
cd /var/www/html

# Fix for path traversal vulnerability in OrderConvo plugin
# The download_file function doesn't validate the filename parameter,
# allowing directory traversal sequences like "../" to access files
# outside the intended upload directory.

PLUGIN_DIR="/var/www/html/wp-content/plugins/admin-and-client-message-after-order-for-woocommerce"
TARGET_FILE="$PLUGIN_DIR/includes/wprest.class.php"

# Verify file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo "Error: Target file not found at $TARGET_FILE"
    exit 1
fi

# Create backup
cp "$TARGET_FILE" "$TARGET_FILE.bak"

# Use a PHP script to apply the fix precisely
php << 'PHPSCRIPT'
<?php
$file = '/var/www/html/wp-content/plugins/admin-and-client-message-after-order-for-woocommerce/includes/wprest.class.php';
$content = file_get_contents($file);

// Check if fix is already applied
if (strpos($content, '// Security fix: Sanitize filename') !== false) {
    echo "Fix already applied.\n";
    exit(0);
}

// The vulnerable code pattern in download_file function:
// extract($data);
//
// $dir_path = wooconvo_file_directory($order_id);
// $file_path = $dir_path . $filename;
//
// if (file_exists($file_path)){

// We need to insert the security fix between extract($data) and the file_exists check
// The fix adds:
// 1. basename() sanitization of filename
// 2. realpath() validation to ensure path is within allowed directory

$vulnerable_pattern = '/(function download_file\(\$request\)\{[^}]*?extract\(\$data\);)\s*(\$dir_path = wooconvo_file_directory\(\$order_id\);\s*\$file_path = \$dir_path \. \$filename;\s*)(if \(file_exists\(\$file_path\)\)\{)/s';

$fixed_replacement = '$1

        // Security fix: Sanitize filename to prevent path traversal
        $filename = basename($filename);

        $2
        // Security fix: Validate file path is within allowed directory
        $real_path = realpath($file_path);
        $real_dir = realpath($dir_path);

        if (!$real_path || !$real_dir || strpos($real_path, $real_dir) !== 0) {
            wp_send_json_error([\'message\' => __(\'Invalid file path.\', \'wooconvo\')]);
            return;
        }

        $3';

if (preg_match($vulnerable_pattern, $content)) {
    $content = preg_replace($vulnerable_pattern, $fixed_replacement, $content);
    file_put_contents($file, $content);
    echo "Fix applied successfully using regex replacement.\n";
} else {
    // Fallback: Line-by-line approach
    $lines = explode("\n", $content);
    $fixed_lines = [];
    $in_download_function = false;
    $found_extract = false;
    $found_file_path = false;
    $fixed = false;

    for ($i = 0; $i < count($lines); $i++) {
        $line = $lines[$i];

        // Detect entry into download_file function
        if (strpos($line, 'function download_file($request)') !== false) {
            $in_download_function = true;
        }

        // After extract($data); line in download_file, mark it
        if ($in_download_function && !$fixed && strpos($line, 'extract($data)') !== false) {
            $found_extract = true;
            $fixed_lines[] = $line;
            // Add basename sanitization
            $fixed_lines[] = '        ';
            $fixed_lines[] = '        // Security fix: Sanitize filename to prevent path traversal';
            $fixed_lines[] = '        $filename = basename($filename);';
            continue;
        }

        // After $file_path = $dir_path . $filename; line, insert path validation
        if ($in_download_function && $found_extract && !$fixed && strpos($line, '$file_path = $dir_path . $filename') !== false) {
            $fixed_lines[] = $line;
            $fixed_lines[] = '        ';
            $fixed_lines[] = '        // Security fix: Validate file path is within allowed directory';
            $fixed_lines[] = '        $real_path = realpath($file_path);';
            $fixed_lines[] = '        $real_dir = realpath($dir_path);';
            $fixed_lines[] = '        ';
            $fixed_lines[] = '        if (!$real_path || !$real_dir || strpos($real_path, $real_dir) !== 0) {';
            $fixed_lines[] = '            wp_send_json_error([\'message\' => __(\'Invalid file path.\', \'wooconvo\')]);';
            $fixed_lines[] = '            return;';
            $fixed_lines[] = '        }';
            $fixed = true;
            $in_download_function = false;
            continue;
        }

        $fixed_lines[] = $line;
    }

    if ($fixed) {
        $content = implode("\n", $fixed_lines);
        file_put_contents($file, $content);
        echo "Fix applied successfully using line-by-line insertion.\n";
    } else {
        echo "Warning: Could not locate the vulnerable code pattern. Manual inspection may be required.\n";
        exit(1);
    }
}
?>
PHPSCRIPT

# Verify the fix was applied
if grep -q 'basename($filename)' "$TARGET_FILE"; then
    echo "Verification: basename() sanitization is present."
else
    echo "Warning: basename() sanitization may not have been applied correctly."
    exit 1
fi

if grep -q 'strpos($real_path, $real_dir)' "$TARGET_FILE"; then
    echo "Verification: Path validation is present."
else
    echo "Warning: Path validation may not have been applied correctly."
    exit 1
fi

echo "Fix applied successfully!"
