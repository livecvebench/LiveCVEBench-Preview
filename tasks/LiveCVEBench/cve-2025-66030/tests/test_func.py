"""
Functional tests for ASN.1 OID encoding/decoding.
These tests verify that normal OID operations work correctly.
Should PASS in both vulnerable and fixed states.
"""
import subprocess
import json
import pytest


def run_node_script(script):
    """Helper to run a Node.js script and return the result."""
    result = subprocess.run(
        ['node', '-e', script],
        capture_output=True,
        text=True,
        cwd='/app',
        timeout=30
    )
    return result


class TestBasicOidConversion:
    """Test basic OID to/from DER conversion."""

    def test_oid_to_der_standard(self):
        """Test standard OID conversion to DER format."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var der = ASN1.oidToDer("1.2.840.113549");
        console.log(JSON.stringify({
            "hex": der.toHex(),
            "success": true
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['success'] == True
        assert output['hex'] == '2a864886f70d', f"Expected 2a864886f70d, got {output['hex']}"

    def test_der_to_oid_standard(self):
        """Test standard DER conversion to OID format."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        var der = UTIL.hexToBytes("2a864886f70d");
        var oid = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "oid": oid,
            "success": true
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['success'] == True
        assert output['oid'] == '1.2.840.113549', f"Expected 1.2.840.113549, got {output['oid']}"

    def test_roundtrip_conversion(self):
        """Test that oidToDer -> derToOid gives the original OID."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var originalOid = "1.3.6.1.4.1.311.21.20";
        var der = ASN1.oidToDer(originalOid);
        var recoveredOid = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "original": originalOid,
            "recovered": recoveredOid,
            "match": originalOid === recoveredOid
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True, f"OID roundtrip failed: {output['original']} != {output['recovered']}"


class TestSmallOidValues:
    """Test OID handling with small arc values."""

    def test_single_byte_arcs(self):
        """Test OID with single-byte arc values (< 128)."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var oid = "1.2.3.4.5";
        var der = ASN1.oidToDer(oid);
        var recovered = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "original": oid,
            "recovered": recovered,
            "match": oid === recovered
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True

    def test_multi_byte_arcs(self):
        """Test OID with multi-byte arc values (>= 128)."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var oid = "1.2.840.10045.3.1.7";  // P-256 curve OID
        var der = ASN1.oidToDer(oid);
        var recovered = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "original": oid,
            "recovered": recovered,
            "match": oid === recovered
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True


class Test32BitOidValues:
    """Test OID handling with 32-bit arc values that work in both vulnerable and fixed versions."""

    def test_31bit_max_value_to_der(self):
        """Test that 31-bit max value (2147483647) can be converted to DER.
        This is within 32-bit signed range and works in both vulnerable and fixed versions."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        try {
            var der = ASN1.oidToDer("1.2.2147483647");
            console.log(JSON.stringify({
                "hex": der.toHex(),
                "success": true
            }));
        } catch(e) {
            console.log(JSON.stringify({
                "success": false,
                "error": e.message
            }));
        }
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['success'] == True, f"Failed to convert 31-bit max value: {output.get('error', 'unknown')}"
        # 2147483647 encodes as 87 ff ff ff 7f in OID DER encoding
        assert output['hex'] == '2a87ffffff7f', f"Expected 2a87ffffff7f, got {output['hex']}"

    def test_31bit_max_value_from_der(self):
        """Test that 31-bit max value can be read from DER.
        This works correctly in both vulnerable and fixed versions."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var UTIL = require("./lib/util");
        var der = UTIL.hexToBytes("2a87ffffff7f");
        var oid = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "oid": oid,
            "expected": "1.2.2147483647",
            "match": oid === "1.2.2147483647"
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True, f"Expected 1.2.2147483647, got {output['oid']}"


class TestCommonOids:
    """Test common cryptographic OIDs."""

    def test_rsa_encryption_oid(self):
        """Test RSA encryption OID."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var oid = "1.2.840.113549.1.1.1";  // rsaEncryption
        var der = ASN1.oidToDer(oid);
        var recovered = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "match": oid === recovered
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True

    def test_sha256_oid(self):
        """Test SHA-256 OID."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var oid = "2.16.840.1.101.3.4.2.1";  // SHA-256
        var der = ASN1.oidToDer(oid);
        var recovered = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "match": oid === recovered
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True

    def test_ecdsa_with_sha256_oid(self):
        """Test ECDSA with SHA-256 OID."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var oid = "1.2.840.10045.4.3.2";  // ecdsa-with-SHA256
        var der = ASN1.oidToDer(oid);
        var recovered = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "match": oid === recovered
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True

    def test_x509_common_name_oid(self):
        """Test X.509 common name OID."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var oid = "2.5.4.3";  // commonName
        var der = ASN1.oidToDer(oid);
        var recovered = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "match": oid === recovered
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True


class TestEdgeCases:
    """Test edge cases in OID handling."""

    def test_zero_arc(self):
        """Test OID with zero arc value."""
        result = run_node_script('''
        var ASN1 = require("./lib/asn1");
        var oid = "1.2.0.3";
        var der = ASN1.oidToDer(oid);
        var recovered = ASN1.derToOid(der);
        console.log(JSON.stringify({
            "match": oid === recovered
        }));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = json.loads(result.stdout.strip())
        assert output['match'] == True

    def test_first_component_combinations(self):
        """Test OID with different first/second component combinations.
        Note: According to OID DER encoding rules:
        - First byte = first*40 + second
        - Decoding: first = floor(byte/40), second = byte % 40
        - For first=2, only second values 0-39 will roundtrip correctly.
        """
        test_cases = [
            ("0.0", True),
            ("0.39", True),
            ("1.0", True),
            ("1.39", True),
            ("2.0", True),
            ("2.39", True),  # 2.39 = byte 119, which roundtrips correctly
        ]
        for oid_prefix, expected in test_cases:
            full_oid = f"{oid_prefix}.1"
            result = run_node_script(f'''
            var ASN1 = require("./lib/asn1");
            var oid = "{full_oid}";
            try {{
                var der = ASN1.oidToDer(oid);
                var recovered = ASN1.derToOid(der);
                console.log(JSON.stringify({{
                    "success": true,
                    "match": oid === recovered
                }}));
            }} catch(e) {{
                console.log(JSON.stringify({{
                    "success": false,
                    "error": e.message
                }}));
            }}
            ''')
            if expected:
                assert result.returncode == 0, f"Script failed for {full_oid}: {result.stderr}"
                output = json.loads(result.stdout.strip())
                assert output.get('match', False) == True, f"OID {full_oid} roundtrip failed"
