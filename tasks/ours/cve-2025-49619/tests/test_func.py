"""
Functionality tests for Skyvern template rendering.
These tests verify that legitimate template features work correctly.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import sys


def get_template_module_path():
    """Get the path to the template test helper."""
    return "/tests/template_helper.py"


class TestBasicTemplateFeatures:
    """Test that basic Jinja2 template features work correctly."""

    def test_simple_variable_substitution(self):
        """Test basic variable substitution in templates."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "basic_var"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "Hello World" in result.stdout

    def test_numeric_expression(self):
        """Test simple numeric expressions work."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "numeric"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "2" in result.stdout

    def test_string_concatenation(self):
        """Test string operations in templates."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "string_concat"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "HelloWorld" in result.stdout

    def test_conditional_expression(self):
        """Test conditional expressions work."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "conditional"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "yes" in result.stdout

    def test_list_access(self):
        """Test accessing list elements."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "list_access"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "second" in result.stdout

    def test_dict_access(self):
        """Test accessing dictionary values."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "dict_access"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "value1" in result.stdout

    def test_loop_iteration(self):
        """Test for loop iteration in templates."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "loop"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "a" in result.stdout
        assert "b" in result.stdout
        assert "c" in result.stdout


class TestWorkflowContextSimulation:
    """Test template features that simulate workflow context usage."""

    def test_nested_dict_access(self):
        """Test accessing nested dictionary structures like workflow context."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "nested_dict"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "output_value" in result.stdout

    def test_multiple_variables(self):
        """Test template with multiple context variables."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "multi_var"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "John" in result.stdout
        assert "30" in result.stdout

    def test_filter_usage(self):
        """Test Jinja2 filters work correctly."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "filter"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "HELLO" in result.stdout

    def test_default_filter(self):
        """Test default filter for missing variables."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "default_filter"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "default_value" in result.stdout

    def test_empty_template(self):
        """Test that empty templates are handled correctly."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "empty"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        # Empty template should return empty or whitespace only
        assert result.stdout.strip() == "" or "empty" in result.stdout.lower()

    def test_plain_text_no_template(self):
        """Test plain text without template expressions."""
        result = subprocess.run(
            [sys.executable, get_template_module_path(), "plain_text"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, f"Failed: {result.stderr}"
        assert "This is plain text with no templates" in result.stdout
