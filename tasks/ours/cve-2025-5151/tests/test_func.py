"""
Functional tests to verify that legitimate data analysis operations continue to work.
These tests should PASS in both vulnerable and fixed states.
"""
import pytest
import asyncio
import sys
import os

# Add backend to path for imports
sys.path.insert(0, '/app/backend')

@pytest.mark.asyncio
async def test_basic_pandas_dataframe_creation():
    """Test that basic pandas DataFrame operations work."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
import pandas as pd
df = pd.DataFrame({'A': [1, 2, 3], 'B': [4, 5, 6]})
final_result = f"Created DataFrame with shape: {df.shape}"
'''
    result, error = await execute_analysis_code_safely(code, "[]")

    assert "Created DataFrame with shape: (3, 2)" in result
    assert error == ""


@pytest.mark.asyncio
async def test_numpy_array_operations():
    """Test that numpy operations work correctly."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
import numpy as np
arr = np.array([1, 2, 3, 4, 5])
mean_val = np.mean(arr)
std_val = np.std(arr)
final_result = f"Mean: {mean_val}, Std: {std_val:.4f}"
'''
    result, error = await execute_analysis_code_safely(code, "[]")

    assert "Mean: 3.0" in result
    assert error == ""


@pytest.mark.asyncio
async def test_data_dict_access():
    """Test that data_dict is properly accessible for analysis."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
import pandas as pd
df = pd.DataFrame(data_dict)
row_count = len(df)
col_count = len(df.columns)
final_result = f"Data has {row_count} rows and {col_count} columns"
'''
    data = '[{"x": 1, "y": 10}, {"x": 2, "y": 20}, {"x": 3, "y": 30}]'
    result, error = await execute_analysis_code_safely(code, data)

    assert "3 rows" in result
    assert "2 columns" in result
    assert error == ""


@pytest.mark.asyncio
async def test_math_operations():
    """Test that math module operations work."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
import math
result_val = math.sqrt(16) + math.pow(2, 3)
final_result = f"Result: {result_val}"
'''
    result, error = await execute_analysis_code_safely(code, "[]")

    assert "Result: 12.0" in result
    assert error == ""


@pytest.mark.asyncio
async def test_statistics_module():
    """Test that statistics module works."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
import statistics
data = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
mean_val = statistics.mean(data)
median_val = statistics.median(data)
final_result = f"Mean: {mean_val}, Median: {median_val}"
'''
    result, error = await execute_analysis_code_safely(code, "[]")

    assert "Mean: 5.5" in result
    assert "Median: 5.5" in result
    assert error == ""


@pytest.mark.asyncio
async def test_pandas_aggregation():
    """Test pandas aggregation functions."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
import pandas as pd
df = pd.DataFrame({
    'category': ['A', 'A', 'B', 'B', 'C'],
    'value': [10, 20, 30, 40, 50]
})
grouped = df.groupby('category')['value'].sum()
final_result = f"Sum by category: A={grouped['A']}, B={grouped['B']}, C={grouped['C']}"
'''
    result, error = await execute_analysis_code_safely(code, "[]")

    assert "A=30" in result
    assert "B=70" in result
    assert "C=50" in result
    assert error == ""


@pytest.mark.asyncio
async def test_print_output_captured():
    """Test that print statements are captured in result."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
print("Hello from analysis code")
final_result = "Analysis complete"
'''
    result, error = await execute_analysis_code_safely(code, "[]")

    # Either final_result or print output should be captured
    assert "Analysis complete" in result or "Hello" in result
    assert error == ""


@pytest.mark.asyncio
async def test_json_module_available():
    """Test that json module is available for data manipulation."""
    from tools.analysis_tools import execute_analysis_code_safely

    code = '''
import json
data = {"key": "value", "number": 42}
json_str = json.dumps(data)
parsed = json.loads(json_str)
final_result = f"JSON roundtrip successful: {parsed['number']}"
'''
    result, error = await execute_analysis_code_safely(code, "[]")

    assert "JSON roundtrip successful: 42" in result
    assert error == ""