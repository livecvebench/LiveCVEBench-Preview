"""
Functionality tests for md-to-pdf library.
Tests basic markdown conversion functionality.
These tests should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import time
import tempfile


def run_md_to_pdf(input_path, output_path=None, timeout=60):
    """Helper function to run md-to-pdf conversion."""
    cmd = ['npx', 'md-to-pdf', input_path,
           '--launch-options', '{"args": ["--no-sandbox", "--disable-setuid-sandbox"]}']
    if output_path:
        cmd.extend(['--dest', output_path])

    result = subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        cwd='/app',
        timeout=timeout
    )
    return result


class TestBasicConversion:
    """Test basic markdown to PDF conversion functionality."""

    def test_simple_markdown_conversion(self):
        """Test that simple markdown converts to PDF successfully."""
        test_content = """# Hello World

This is a simple test document.

- Item 1
- Item 2
- Item 3
"""
        input_path = '/tmp/test_simple.md'
        output_path = '/tmp/test_simple.pdf'

        # Clean up any previous files
        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        # Check that the PDF was generated
        assert os.path.exists(output_path), \
            f"PDF should be generated at {output_path}. stderr: {result.stderr}"

    def test_yaml_frontmatter_processing(self):
        """Test that YAML front-matter is properly processed."""
        test_content = """---
title: "Test Document"
author: "Test Author"
date: "2024-01-01"
---

# Document Title

This document has YAML front-matter.
"""
        input_path = '/tmp/test_yaml_fm.md'
        output_path = '/tmp/test_yaml_fm.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        # PDF should be generated with YAML front-matter
        assert os.path.exists(output_path), \
            f"PDF should be generated with YAML front-matter. stderr: {result.stderr}"

    def test_markdown_with_code_blocks(self):
        """Test markdown with code blocks converts properly."""
        test_content = """# Code Example

Here is some Python code:

```python
def hello_world():
    print("Hello, World!")
```

And some JavaScript:

```javascript
function greet(name) {
    console.log(`Hello, ${name}!`);
}
```
"""
        input_path = '/tmp/test_code.md'
        output_path = '/tmp/test_code.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        assert os.path.exists(output_path), \
            f"PDF with code blocks should be generated. stderr: {result.stderr}"

    def test_markdown_with_links_and_images(self):
        """Test markdown with links processes correctly."""
        test_content = """# Links Test

This is a [link to Google](https://www.google.com).

And here is an inline `code` example.

## Formatting

**Bold text** and *italic text* should work.
"""
        input_path = '/tmp/test_links.md'
        output_path = '/tmp/test_links.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        assert os.path.exists(output_path), \
            f"PDF with links should be generated. stderr: {result.stderr}"


class TestFrontMatterFormats:
    """Test various front-matter formats."""

    def test_empty_frontmatter(self):
        """Test markdown with empty YAML front-matter."""
        test_content = """---
---

# Empty Front-matter

This document has empty front-matter.
"""
        input_path = '/tmp/test_empty_fm.md'
        output_path = '/tmp/test_empty_fm.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        assert os.path.exists(output_path), \
            f"PDF with empty front-matter should be generated. stderr: {result.stderr}"

    def test_json_frontmatter(self):
        """Test markdown with JSON front-matter."""
        test_content = """---json
{
  "title": "JSON Front-matter Test"
}
---

# JSON Front-matter

This uses JSON format for front-matter.
"""
        input_path = '/tmp/test_json_fm.md'
        output_path = '/tmp/test_json_fm.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        # JSON front-matter should work
        assert os.path.exists(output_path), \
            f"PDF with JSON front-matter should be generated. stderr: {result.stderr}"

    def test_no_frontmatter(self):
        """Test markdown without any front-matter."""
        test_content = """# No Front-matter

This document has no front-matter at all.

Just plain markdown content.
"""
        input_path = '/tmp/test_no_fm.md'
        output_path = '/tmp/test_no_fm.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        assert os.path.exists(output_path), \
            f"PDF without front-matter should be generated. stderr: {result.stderr}"


class TestEdgeCases:
    """Test edge cases and special content."""

    def test_unicode_content(self):
        """Test markdown with unicode characters."""
        test_content = """# Unicode Test ä¸­æ–‡æµ‹è¯•

This document contains unicode: ä½ å¥½ä¸–ç•Œ

Emojis: ðŸŽ‰ ðŸš€ âœ…

Special characters: Â© Â® â„¢ â‚¬ Â£ Â¥
"""
        input_path = '/tmp/test_unicode.md'
        output_path = '/tmp/test_unicode.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w', encoding='utf-8') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        assert os.path.exists(output_path), \
            f"PDF with unicode should be generated. stderr: {result.stderr}"

    def test_tables(self):
        """Test markdown tables conversion."""
        test_content = """# Table Test

| Column 1 | Column 2 | Column 3 |
|----------|----------|----------|
| Row 1    | Data     | More     |
| Row 2    | Data     | More     |
| Row 3    | Data     | More     |
"""
        input_path = '/tmp/test_table.md'
        output_path = '/tmp/test_table.pdf'

        for f in [input_path, output_path]:
            if os.path.exists(f):
                os.remove(f)

        with open(input_path, 'w') as f:
            f.write(test_content)

        result = run_md_to_pdf(input_path)
        time.sleep(2)

        assert os.path.exists(output_path), \
            f"PDF with tables should be generated. stderr: {result.stderr}"
