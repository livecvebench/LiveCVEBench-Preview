#!/bin/bash
# Solution script for CVE-2025-54572
# Fixes resource exhaustion by moving size check before expensive regex operation
set -e

FILE="/app/lib/onelogin/ruby-saml/saml_message.rb"

echo "Checking if fix is needed..."

# Check if already fixed by looking at the order of operations
# In fixed version, first line after 'def decode_raw_saml' is settings assignment
# In vulnerable version, first line is 'return saml unless base64_encoded?'
if grep -A1 "def decode_raw_saml" "$FILE" | grep -q "settings = OneLogin::RubySaml::Settings.new"; then
    echo "Already fixed - settings assignment is first after method definition"
    exit 0
fi

echo "Applying fix to $FILE..."

# Create a Ruby script to perform the fix
# This is more reliable than sed for multi-line changes
ruby << 'RUBY_SCRIPT'
file_path = "/app/lib/onelogin/ruby-saml/saml_message.rb"
content = File.read(file_path)

# The vulnerable code has this structure:
#   def decode_raw_saml(saml, settings = nil)
#     return saml unless base64_encoded?(saml)
#
#     settings = OneLogin::RubySaml::Settings.new if settings.nil?
#     if saml.bytesize > settings.message_max_bytesize
#       raise ValidationError.new("Encoded SAML Message exceeds "...
#     end
#
#     decoded = decode(saml)
#
# The fix moves the 'return saml unless base64_encoded?(saml)' line
# to AFTER the size check block.

vulnerable_pattern = /
  (def\ decode_raw_saml\(saml,\ settings\ =\ nil\)\n)  # Method signature
  (\s+return\ saml\ unless\ base64_encoded\?\(saml\)\n)  # Early return (to move)
  (\n)  # Blank line
  (\s+settings\ =\ OneLogin::RubySaml::Settings\.new\ if\ settings\.nil\?\n)  # Settings init
  (\s+if\ saml\.bytesize\ >\ settings\.message_max_bytesize\n)  # Size check if
  (\s+raise\ ValidationError\.new\("Encoded\ SAML\ Message\ exceeds\ "\ \+\ settings\.message_max_bytesize\.to_s\ \+\ "\ bytes,\ so\ was\ rejected"\)\n)  # raise
  (\s+end\n)  # end
  (\n)  # Blank line
  (\s+decoded\ =\ decode\(saml\))  # decoded assignment
/x

fixed_replacement = '\1\4\5\6\7' + "\n" + '\2' + "\n" + '\9'

if content.match?(vulnerable_pattern)
  new_content = content.sub(vulnerable_pattern, fixed_replacement)
  File.write(file_path, new_content)
  puts "Fix applied successfully using pattern replacement"
  exit 0
end

# Fallback: simpler approach if exact pattern doesn't match
# Remove the early return line and add it after the size check
lines = content.lines
new_lines = []
in_decode_raw_saml = false
early_return_line = nil
size_check_end_found = false
inserted = false

lines.each_with_index do |line, i|
  if line.include?("def decode_raw_saml")
    in_decode_raw_saml = true
    new_lines << line
    next
  end

  if in_decode_raw_saml
    # Capture the early return line if it's right at the start
    if early_return_line.nil? && line.strip.start_with?("return saml unless base64_encoded?")
      early_return_line = line
      # Skip blank line after if present
      next
    end

    # Skip blank line after the removed early return
    if early_return_line && line.strip.empty? && !size_check_end_found && new_lines.last&.include?("def decode_raw_saml")
      next
    end

    # Look for the end of size check block
    if line.strip == "end" && !size_check_end_found && !inserted
      prev_lines = new_lines.last(5).join
      if prev_lines.include?("message_max_bytesize")
        size_check_end_found = true
        new_lines << line
        # Insert blank line and the early return after the size check end
        if early_return_line
          new_lines << "\n"
          new_lines << early_return_line
          inserted = true
        end
        next
      end
    end

    # Reset flag when we exit the method
    if line.match?(/^\s{6}end\s*$/) || (line.include?("def ") && !line.include?("decode_raw_saml"))
      in_decode_raw_saml = false
    end
  end

  new_lines << line
end

if inserted
  File.write(file_path, new_lines.join)
  puts "Fix applied successfully using line manipulation"
  exit 0
else
  puts "Warning: Could not apply fix automatically"
  exit 1
end
RUBY_SCRIPT

echo "Verifying fix..."
if grep -A1 "def decode_raw_saml" "$FILE" | grep -q "settings = OneLogin::RubySaml::Settings.new"; then
    echo "Fix verified successfully"
else
    echo "Warning: Fix verification inconclusive, checking alternate pattern..."
    # Check if base64_encoded comes after message_max_bytesize
    if grep -n "message_max_bytesize\|base64_encoded" "$FILE" | head -4; then
        echo "Please verify the order manually"
    fi
fi

echo "Fix applied"
