#!/usr/bin/env python3
"""
Vulnerability tests for Fabio HTTP proxy header manipulation issue.
These tests verify that the Connection header cannot be abused to remove
security-critical forwarding headers.

- FAIL in vulnerable state (headers can be removed via Connection header)
- PASS in fixed state (protected headers cannot be removed)
"""

import pytest
import requests
import time
import os

# Fabio proxy URL (default port 9999)
FABIO_URL = os.environ.get("FABIO_URL", "http://localhost:9999")
# Backend server URL for checking received headers
BACKEND_URL = os.environ.get("BACKEND_URL", "http://localhost:8080")

# Timeout for HTTP requests
REQUEST_TIMEOUT = 10


def wait_for_service(url, max_retries=30, delay=1):
    """Wait for a service to become available."""
    for i in range(max_retries):
        try:
            response = requests.get(url, timeout=2)
            return True
        except requests.exceptions.RequestException:
            if i < max_retries - 1:
                time.sleep(delay)
    return False


def get_received_headers(response):
    """Extract headers received by backend from response."""
    data = response.json()
    received_headers = data.get("headers", {})
    # Normalize to lowercase for easier comparison
    return {k.lower(): v for k, v in received_headers.items()}


@pytest.fixture(scope="module", autouse=True)
def setup_services():
    """Ensure services are available before running tests."""
    if not wait_for_service(FABIO_URL):
        pytest.skip(f"Fabio proxy not available at {FABIO_URL}")
    if not wait_for_service(BACKEND_URL):
        pytest.skip(f"Backend server not available at {BACKEND_URL}")


class TestConnectionHeaderCannotRemoveXRealIp:
    """Test that Connection header cannot remove X-Real-Ip."""

    def test_x_real_ip_with_connection_header_attack(self):
        """
        Test that X-Real-Ip cannot be removed via Connection header.
        Attacker attempts: Connection: keep-alive, X-Real-Ip
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Real-Ip"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip was removed via Connection header - VULNERABLE"

    def test_x_real_ip_case_insensitive_attack(self):
        """
        Test case-insensitive attack on X-Real-Ip.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, x-real-ip"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip was removed via lowercase Connection header - VULNERABLE"

    def test_x_real_ip_with_close_connection(self):
        """
        Test attack with Connection: close directive.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "close, X-Real-Ip"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip was removed via Connection header with close - VULNERABLE"


class TestConnectionHeaderCannotRemoveForwarded:
    """Test that Connection header cannot remove Forwarded header."""

    def test_forwarded_with_connection_header_attack(self):
        """
        Test that Forwarded cannot be removed via Connection header.
        Attacker attempts: Connection: keep-alive, Forwarded
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, Forwarded"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "forwarded" in headers, \
            "Forwarded was removed via Connection header - VULNERABLE"

    def test_forwarded_case_insensitive_attack(self):
        """
        Test case-insensitive attack on Forwarded header.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "close, forwarded"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "forwarded" in headers, \
            "Forwarded was removed via lowercase Connection header - VULNERABLE"


class TestConnectionHeaderCannotRemoveXForwardedHost:
    """Test that Connection header cannot remove X-Forwarded-Host."""

    def test_x_forwarded_host_with_connection_header_attack(self):
        """
        Test that X-Forwarded-Host cannot be removed via Connection header.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Forwarded-Host"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-forwarded-host" in headers, \
            "X-Forwarded-Host was removed via Connection header - VULNERABLE"

    def test_x_forwarded_host_case_variations(self):
        """
        Test various case variations of X-Forwarded-Host attack.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "x-forwarded-host"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-forwarded-host" in headers, \
            "X-Forwarded-Host was removed via Connection header - VULNERABLE"


class TestConnectionHeaderCannotRemoveXForwardedPort:
    """Test that Connection header cannot remove X-Forwarded-Port."""

    def test_x_forwarded_port_with_connection_header_attack(self):
        """
        Test that X-Forwarded-Port cannot be removed via Connection header.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Forwarded-Port"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-forwarded-port" in headers, \
            "X-Forwarded-Port was removed via Connection header - VULNERABLE"


class TestConnectionHeaderCannotRemoveXForwardedProto:
    """Test that Connection header cannot remove X-Forwarded-Proto."""

    def test_x_forwarded_proto_with_connection_header_attack(self):
        """
        Test that X-Forwarded-Proto cannot be removed via Connection header.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Forwarded-Proto"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-forwarded-proto" in headers, \
            "X-Forwarded-Proto was removed via Connection header - VULNERABLE"

    def test_x_forwarded_proto_https_bypass_attempt(self):
        """
        Test attempt to bypass HTTPS enforcement by removing X-Forwarded-Proto.
        This simulates an attack where backend relies on this header for security.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "X-Forwarded-Proto"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-forwarded-proto" in headers, \
            "X-Forwarded-Proto removed - backend HTTPS enforcement can be bypassed - VULNERABLE"


class TestConnectionHeaderCannotRemoveXForwardedFor:
    """Test that Connection header cannot remove X-Forwarded-For.

    Note: X-Forwarded-For is handled specially by Go's httputil.ReverseProxy.
    It is set AFTER Connection header processing, so it cannot be removed via
    the Connection header attack. This test actually tests the attack attempt
    against X-Real-Ip alongside X-Forwarded-For to verify vulnerability.
    """

    def test_x_forwarded_for_with_connection_header_attack(self):
        """
        Test combined attack attempting to remove X-Forwarded-For and X-Real-Ip.
        X-Forwarded-For is protected by Go's ReverseProxy, but X-Real-Ip is not.
        In vulnerable state, X-Real-Ip should be removed (test fails).
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Forwarded-For, X-Real-Ip"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        # X-Forwarded-For should be present (always protected by Go's ReverseProxy)
        # X-Real-Ip should also be present (test fails if vulnerable)
        assert "x-forwarded-for" in headers, \
            "X-Forwarded-For was removed - unexpected"
        assert "x-real-ip" in headers, \
            "X-Real-Ip was removed via Connection header alongside X-Forwarded-For - VULNERABLE"


class TestMultipleHeadersRemovalAttempt:
    """Test attempts to remove multiple protected headers at once."""

    def test_remove_multiple_forwarding_headers(self):
        """
        Test that multiple forwarding headers cannot be removed at once.
        Attacker attempts to remove X-Real-Ip and X-Forwarded-Host together.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Real-Ip, X-Forwarded-Host"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip was removed in multi-header attack - VULNERABLE"
        assert "x-forwarded-host" in headers, \
            "X-Forwarded-Host was removed in multi-header attack - VULNERABLE"

    def test_remove_all_protected_headers(self):
        """
        Test that all protected headers cannot be removed at once.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={
                "Connection": "keep-alive, X-Real-Ip, X-Forwarded-Host, X-Forwarded-Proto, X-Forwarded-Port, Forwarded"
            },
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip was removed - VULNERABLE"
        assert "x-forwarded-host" in headers, \
            "X-Forwarded-Host was removed - VULNERABLE"
        assert "x-forwarded-proto" in headers, \
            "X-Forwarded-Proto was removed - VULNERABLE"
        assert "x-forwarded-port" in headers, \
            "X-Forwarded-Port was removed - VULNERABLE"
        assert "forwarded" in headers, \
            "Forwarded was removed - VULNERABLE"

    def test_mixed_legitimate_and_attack_headers(self):
        """
        Test Connection header with legitimate directives mixed with attack.
        Legitimate keep-alive should still work, but protected headers preserved.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Real-Ip, X-Forwarded-Host"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        # Protected headers should still be present
        assert "x-real-ip" in headers
        assert "x-forwarded-host" in headers


class TestConnectionHeaderVariations:
    """Test various formats and variations of Connection header attacks."""

    def test_connection_header_with_spaces(self):
        """
        Test Connection header with extra spaces around header names.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive,  X-Real-Ip  "},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip removed with spaces in Connection header - VULNERABLE"

    def test_connection_header_mixed_case(self):
        """
        Test Connection header with mixed case header names.
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "X-REAL-IP, x-forwarded-HOST"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip removed with mixed case - VULNERABLE"
        assert "x-forwarded-host" in headers, \
            "X-Forwarded-Host removed with mixed case - VULNERABLE"

    def test_connection_only_attack_header(self):
        """
        Test Connection header with only the attack header (no keep-alive).
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "X-Real-Ip"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        assert "x-real-ip" in headers, \
            "X-Real-Ip removed when only header in Connection - VULNERABLE"


class TestXForwardedPrefixProtection:
    """Test that X-Forwarded-Prefix attack also affects other headers.

    Note: X-Forwarded-Prefix is only set when stripPath is configured in Fabio.
    Since our test environment doesn't use stripPath, we test that attempting to
    remove X-Forwarded-Prefix via Connection header also removes X-Real-Ip
    (demonstrating the vulnerability pattern).
    """

    def test_x_forwarded_prefix_cannot_be_removed(self):
        """
        Test that Connection header attack attempting X-Forwarded-Prefix removal
        also removes X-Real-Ip (demonstrating vulnerability).
        """
        response = requests.get(
            f"{FABIO_URL}/headers",
            headers={"Connection": "keep-alive, X-Forwarded-Prefix, X-Real-Ip"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200
        headers = get_received_headers(response)

        # X-Real-Ip should be present in fixed state
        # In vulnerable state, this will fail because X-Real-Ip is removed
        assert "x-real-ip" in headers, \
            "X-Real-Ip was removed via Connection header with X-Forwarded-Prefix attack - VULNERABLE"
