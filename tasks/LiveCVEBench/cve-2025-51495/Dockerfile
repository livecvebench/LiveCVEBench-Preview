FROM ubuntu:22.04

WORKDIR /app

# System dependencies including those required for tests
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    make \
    git \
    curl \
    wget \
    tmux \
    asciinema \
    python3 \
    python3-pip \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Python dependencies for tests
RUN pip3 install pytest requests websocket-client

# Clone Mongoose 7.17 and remove git history
RUN git clone --branch 7.17 --depth 1 https://github.com/cesanta/mongoose.git /tmp/mongoose \
    && cp /tmp/mongoose/mongoose.c /tmp/mongoose/mongoose.h /app/ \
    && mkdir -p /app/src \
    && cp /tmp/mongoose/src/ws.c /app/src/ \
    && rm -rf /tmp/mongoose

# Copy server main from task-deps
COPY task-deps/server_main.c /app/main.c

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Build with ASAN for vulnerability detection
RUN gcc -o server main.c mongoose.c -W -Wall -Wextra -g -fsanitize=address -I.

# Startup command via entrypoint for restart capability
# CMD ["/entrypoint.sh"]
