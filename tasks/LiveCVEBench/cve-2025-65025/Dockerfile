# esm.sh Path Traversal via Tarslip
# Single-stage Dockerfile to keep Go available for rebuilding after fix

FROM golang:1.20

# Install system dependencies
# git - required for cloning and package operations
# nodejs/npm - required for pnpm
# tmux, asciinema, curl - required by the framework
# libcap2-bin - for setcap (allows binding to privileged ports)
RUN apt-get update && apt-get install -y \
    git \
    nodejs \
    npm \
    tmux \
    asciinema \
    curl \
    libcap2-bin \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm globally
RUN npm i -g pnpm

# Clone vulnerable version v135
ENV ESM_SH_VERSION=v135
RUN git clone --branch $ESM_SH_VERSION --depth 1 https://github.com/esm-dev/esm.sh /app

# Set working directory
WORKDIR /app

# Remove .git directory to prevent solution leakage
RUN rm -rf .git

# Build the esmd binary
RUN CGO_ENABLED=0 go build -o esmd main.go

# Set capability to bind to privileged ports
RUN setcap cap_net_bind_service=ep /app/esmd

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Start via entrypoint script (enables restart capability)
# CMD ["/entrypoint.sh"]
