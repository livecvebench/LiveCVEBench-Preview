#!/bin/bash
# Solution script for URL Shortify input validation issue
# This fix changes form_data input source from $_REQUEST to $_POST only
set -e

PLUGIN_DIR="/var/www/html/wp-content/plugins/url-shortify"

echo "Applying fix to URL Shortify plugin..."

# Fix 1: Links_Table.php - Change get_request_data to get_post_data for form_data
# Line 1111: $form_data = Helper::get_request_data( 'form_data', [], false );
# Should be: $form_data = Helper::get_post_data( 'form_data', [], false );
LINKS_FILE="${PLUGIN_DIR}/lite/includes/Admin/Links_Table.php"

if [ -f "$LINKS_FILE" ]; then
    echo "Fixing Links_Table.php..."
    sed -i "s/Helper::get_request_data( 'form_data', \[\], false )/Helper::get_post_data( 'form_data', [], false )/g" "$LINKS_FILE"
    echo "Links_Table.php fixed."
else
    echo "Warning: Links_Table.php not found at $LINKS_FILE"
fi

# Fix 2: Groups_Table.php - Change get_request_data to get_post_data for form_data
# Line 482: $form_data = Helper::get_request_data( 'form_data', array(), false );
# Should be: $form_data = Helper::get_post_data( 'form_data', array(), false );
GROUPS_FILE="${PLUGIN_DIR}/lite/includes/Admin/Groups_Table.php"

if [ -f "$GROUPS_FILE" ]; then
    echo "Fixing Groups_Table.php..."
    sed -i "s/Helper::get_request_data( 'form_data', array(), false )/Helper::get_post_data( 'form_data', array(), false )/g" "$GROUPS_FILE"
    echo "Groups_Table.php fixed."
else
    echo "Warning: Groups_Table.php not found at $GROUPS_FILE"
fi

# Verify fixes were applied
echo ""
echo "Verifying fixes..."

if [ -f "$LINKS_FILE" ]; then
    if grep -q "get_post_data( 'form_data'" "$LINKS_FILE"; then
        echo "✓ Links_Table.php: Fix verified"
    else
        echo "✗ Links_Table.php: Fix may not have been applied correctly"
    fi
fi

if [ -f "$GROUPS_FILE" ]; then
    if grep -q "get_post_data( 'form_data'" "$GROUPS_FILE"; then
        echo "✓ Groups_Table.php: Fix verified"
    else
        echo "✗ Groups_Table.php: Fix may not have been applied correctly"
    fi
fi

echo ""
echo "Fix applied successfully!"
