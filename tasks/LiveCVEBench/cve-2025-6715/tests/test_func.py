#!/usr/bin/env python3
"""
Functionality tests for LatePoint customer cabinet.
These tests verify the application works correctly and should PASS
in both vulnerable and fixed states.
"""

import os
import requests
import pytest
import time

BASE_URL = os.environ.get("TARGET_URL", "http://localhost:80")


def wait_for_server(url, timeout=60):
    """Wait for the server to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(url, timeout=5)
            if response.status_code < 500:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


def wait_for_wordpress_ready(base_url, timeout=180):
    """Wait for WordPress and LatePoint plugin to be fully ready.

    This waits for:
    1. Server to respond
    2. WordPress homepage to return 200
    3. wp-admin to be accessible (indicates WordPress is installed)
    4. customer-cabinet to not return 500 (indicates LatePoint is activated)
    """
    start_time = time.time()

    # First wait for basic server response
    while time.time() - start_time < timeout:
        try:
            response = requests.get(base_url, timeout=5)
            if response.status_code == 200:
                break
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)

    # Wait for wp-admin to be accessible (indicates WordPress is installed)
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{base_url}/wp-admin/", timeout=5, allow_redirects=True)
            if response.status_code in [200, 301, 302]:
                break
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)

    # Wait for customer-cabinet to not return 500 (indicates LatePoint is activated)
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{base_url}/customer-cabinet/", timeout=5)
            if response.status_code != 500:
                # Give a little extra time for full initialization
                time.sleep(5)
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)

    return False


@pytest.fixture(scope="module", autouse=True)
def ensure_server_ready():
    """Ensure the WordPress server is ready before running tests."""
    assert wait_for_wordpress_ready(BASE_URL), f"WordPress at {BASE_URL} did not become ready in time"


class TestCustomerCabinetFunctionality:
    """Test that the customer cabinet functionality works correctly."""

    def test_wordpress_homepage_accessible(self):
        """Test that WordPress homepage is accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=30)
        assert response.status_code == 200, f"Homepage returned {response.status_code}"

    def test_customer_cabinet_page_loads(self):
        """Test that the customer cabinet page loads successfully."""
        response = requests.get(f"{BASE_URL}/customer-cabinet/", timeout=30)
        # Should return 200 or redirect
        assert response.status_code in [200, 301, 302, 404], \
            f"Customer cabinet returned unexpected status: {response.status_code}"

    def test_customer_cabinet_with_default_layout(self):
        """Test that customer cabinet works with default layout parameter."""
        response = requests.get(f"{BASE_URL}/customer-cabinet/?layout=default", timeout=30)
        # Even if the layout doesn't exist, it shouldn't cause server error
        assert response.status_code in [200, 301, 302, 404], \
            f"Default layout request returned unexpected status: {response.status_code}"
        # Should not return a 500 server error
        assert response.status_code != 500, "Server error when using default layout"

    def test_customer_cabinet_with_valid_alphanumeric_layout(self):
        """Test that alphanumeric layout names work correctly."""
        test_layouts = ["default", "main", "layout1", "my-layout", "custom_layout"]
        for layout in test_layouts:
            response = requests.get(f"{BASE_URL}/customer-cabinet/?layout={layout}", timeout=30)
            # Should not cause server errors
            assert response.status_code != 500, \
                f"Server error when using layout '{layout}'"

    def test_latepoint_plugin_active(self):
        """Test that LatePoint plugin appears to be active."""
        response = requests.get(f"{BASE_URL}/customer-cabinet/", timeout=30)
        # The page should load without 500 errors
        assert response.status_code != 500, "Server error accessing LatePoint endpoint"

    def test_invalid_layout_graceful_handling(self):
        """Test that invalid layout names are handled gracefully."""
        response = requests.get(
            f"{BASE_URL}/customer-cabinet/?layout=nonexistent_layout_12345",
            timeout=30
        )
        # Should not crash - either work with fallback or return appropriate error
        assert response.status_code in [200, 301, 302, 400, 404], \
            f"Invalid layout caused unexpected response: {response.status_code}"

    def test_empty_layout_parameter(self):
        """Test that empty layout parameter is handled correctly."""
        response = requests.get(f"{BASE_URL}/customer-cabinet/?layout=", timeout=30)
        # Should fallback to default or handle gracefully
        assert response.status_code in [200, 301, 302, 400, 404], \
            f"Empty layout parameter caused unexpected response: {response.status_code}"

    def test_wp_admin_accessible(self):
        """Test that WordPress admin login page is accessible."""
        response = requests.get(f"{BASE_URL}/wp-admin/", timeout=30, allow_redirects=True)
        # Should redirect to login or be accessible
        assert response.status_code in [200, 301, 302], \
            f"wp-admin returned unexpected status: {response.status_code}"

    def test_no_php_errors_on_normal_request(self):
        """Test that normal requests don't cause PHP errors."""
        response = requests.get(f"{BASE_URL}/customer-cabinet/", timeout=30)
        content = response.text.lower()
        # Check for common PHP error messages
        php_errors = ["fatal error", "parse error", "syntax error"]
        for error in php_errors:
            assert error not in content, f"PHP error detected: {error}"
