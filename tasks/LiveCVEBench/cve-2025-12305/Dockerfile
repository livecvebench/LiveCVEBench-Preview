# Multi-stage build for shiyi-blog CVE-2025-12305

# Build stage
FROM maven:3.8.4-openjdk-8 AS build

WORKDIR /build

# Copy Maven settings with proxy configuration
COPY task-deps/maven-settings.xml /root/.m2/settings.xml

# Clone the repository and checkout master branch
RUN git clone https://github.com/Anthonycharon/shiyi-blog.git /build/repo && \
    cd /build/repo && \
    rm -rf .git

# Copy the source code to working directory
WORKDIR /build/app

# Copy task-deps files to override/provide required source files
COPY task-deps/pom.xml /build/app/pom.xml
COPY task-deps/application.yml /build/app/src/main/resources/application.yml
COPY task-deps/application-dev.yml /build/app/src/main/resources/application-dev.yml
COPY task-deps/application-prod.yml /build/app/src/main/resources/application-prod.yml

# Copy source from repository
RUN cp -r /build/repo/blog/src /build/app/

# Copy vulnerable Java files from task-deps
COPY task-deps/JobInvokeUtil.java /build/app/src/main/java/com/shiyi/quartz/JobInvokeUtil.java
COPY task-deps/JobController.java /build/app/src/main/java/com/shiyi/controller/system/JobController.java
COPY task-deps/Job.java /build/app/src/main/java/com/shiyi/entity/Job.java

# Create directory structure if missing
RUN mkdir -p /build/app/src/main/java/com/shiyi/quartz && \
    mkdir -p /build/app/src/main/java/com/shiyi/controller/system && \
    mkdir -p /build/app/src/main/java/com/shiyi/entity

# Download dependencies and build
RUN mvn clean package -DskipTests -q

# Runtime stage
FROM eclipse-temurin:8-jdk

WORKDIR /app

# Install required system packages
RUN apt-get update && \
    apt-get install -y git tmux asciinema curl wget gcc g++ netcat-openbsd procps maven python3 && \
    rm -rf /var/lib/apt/lists/*

# Copy the built JAR from build stage
COPY --from=build /build/app/target/shiyi-blog.jar /app/shiyi-blog.jar

# Copy source files for potential patching by solution.sh
COPY --from=build /build/app/src /app/src
COPY --from=build /build/app/pom.xml /app/pom.xml

# Copy Maven settings for rebuild capability
COPY task-deps/maven-settings.xml /root/.m2/settings.xml

# Copy Maven repository from build stage to avoid re-downloading dependencies
COPY --from=build /root/.m2/repository /root/.m2/repository

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create upload directory
RUN mkdir -p /usr/local/blog/file/

# Application port
EXPOSE 8800

# Override database and redis configuration to use docker service names
ENV SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/blog?characterEncoding=UTF-8&useUnicode=true&useSSL=false&serverTimezone=Asia/Shanghai&tinyInt1isBit=false&allowPublicKeyRetrieval=true
ENV SPRING_DATASOURCE_USERNAME=root
ENV SPRING_DATASOURCE_PASSWORD=root
ENV SPRING_REDIS_HOST=redis

# CMD ["/entrypoint.sh"]
