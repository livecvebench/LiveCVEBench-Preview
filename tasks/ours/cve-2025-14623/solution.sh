#!/bin/bash
# Solution script for fixing the SQL injection vulnerability in Student File Management System
# This script replaces the vulnerable update_student.php with a secure version using prepared statements

set -e

TARGET_FILE="/var/www/html/SFMS/admin/update_student.php"

echo "Applying fix to $TARGET_FILE..."

# Backup original file
cp "$TARGET_FILE" "${TARGET_FILE}.bak" 2>/dev/null || true

# Replace the vulnerable file with the fixed version using prepared statements
cat > "$TARGET_FILE" << 'EOF'
<?php
	require_once 'conn.php';

	if(ISSET($_POST['update'])){
		$stud_id = $_POST['stud_id'];
		$stud_no = $_POST['stud_no'];
		$firstname = $_POST['firstname'];
		$lastname = $_POST['lastname'];
		$gender = $_POST['gender'];
		$yrsec = $_POST['year']."".$_POST['section'];
		$password = md5($_POST['password']);

		$stmt = mysqli_prepare($conn, "UPDATE `student` SET `stud_no` = ?, `firstname` = ?, `lastname` = ?, `gender` = ?, `yr&sec` = ?, `password` = ? WHERE `stud_id` = ?");
		mysqli_stmt_bind_param($stmt, "isssssi", $stud_no, $firstname, $lastname, $gender, $yrsec, $password, $stud_id);
		mysqli_stmt_execute($stmt);
		mysqli_stmt_close($stmt);

		echo "<script>alert('Successfully updated!')</script>";
		echo "<script>window.location = 'student.php'</script>";
	}
?>
EOF

echo "Fix applied successfully!"
echo "The update_student.php now uses prepared statements with parameterized queries."
