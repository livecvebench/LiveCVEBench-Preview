FROM php:8.1-fpm

# System dependencies (tmux, asciinema, curl required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    unzip \
    libzip-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libonig-dev \
    default-mysql-client \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install pytest and requests for testing
RUN pip3 install pytest requests --break-system-packages

# Configure and install PHP extensions
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
        pdo_mysql \
        mysqli \
        mbstring \
        zip \
        gd

# Clone emlog at vulnerable version to a staging directory
RUN git clone --branch pro-2.5.17 --depth 1 https://github.com/emlog/emlog.git /opt/emlog-src \
    && rm -rf /opt/emlog-src/.git

# Copy pre-configured config.php with database settings
COPY task-deps/config.php /opt/emlog-src/config.php

# Copy Store_Model patch for CVE testing (allows store page to work without external API)
RUN mkdir -p /opt/emlog-patches
COPY task-deps/store_model_patched.php /opt/emlog-patches/store_model_patched.php

# Create working directory
WORKDIR /app/emlog

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh


RUN mkdir -p /tests /oracle
# ENTRYPOINT ["/entrypoint.sh"]
