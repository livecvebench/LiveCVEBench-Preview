FROM php:8.1-fpm

WORKDIR /var/www/html

# System dependencies including nginx
RUN apt-get update && apt-get install -y \
    git \
    nginx \
    tmux \
    asciinema \
    curl \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libwebp-dev \
    libzip-dev \
    libxml2-dev \
    libcurl4-openssl-dev \
    libonig-dev \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Configure and install PHP extensions
RUN docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp \
    && docker-php-ext-install \
        gd \
        mysqli \
        pdo \
        pdo_mysql \
        zip \
        xml \
        curl \
        gettext \
        mbstring \
        pcntl

# Clone Vvveb CMS at vulnerable version 1.0.5 with submodules
RUN rm -rf /var/www/html/* && \
    git clone --branch 1.0.5 --recurse-submodules https://github.com/givanz/Vvveb.git /tmp/vvveb && \
    cp -a /tmp/vvveb/. /var/www/html/ && \
    rm -rf /tmp/vvveb /var/www/html/.git /var/www/html/public/admin/default/.git \
    /var/www/html/public/themes/landing/.git /var/www/html/public/themes/blog-default/.git \
    /var/www/html/plugins/contact-form/.git /var/www/html/plugins/payment/.git \
    /var/www/html/plugins/shipping/.git /var/www/html/public/js/libs/tinymce-dist/.git

# Copy nginx configuration
COPY task-deps/nginx.conf /etc/nginx/sites-available/default

# Copy task-deps files for solution
COPY task-deps/ /task-deps/

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# PHP configuration
RUN echo "memory_limit = 256M" >> /usr/local/etc/php/conf.d/vvveb.ini \
    && echo "upload_max_filesize = 64M" >> /usr/local/etc/php/conf.d/vvveb.ini \
    && echo "post_max_size = 64M" >> /usr/local/etc/php/conf.d/vvveb.ini \
    && echo "max_execution_time = 300" >> /usr/local/etc/php/conf.d/vvveb.ini

# Set permissions
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

# Environment variables
ENV DB_HOST=db
ENV DB_NAME=vvveb
ENV DB_USER=vvveb
ENV DB_PASSWORD=vvveb


# CMD ["/entrypoint.sh"]
