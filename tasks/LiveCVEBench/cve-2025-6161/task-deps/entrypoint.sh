#!/bin/bash

# Wait for database to be ready
echo "Waiting for MySQL to be ready..."
max_attempts=30
attempt=0

while [ $attempt -lt $max_attempts ]; do
    if mysqladmin ping -h db -u root -ppassword --silent &>/dev/null; then
        echo "MySQL is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "Attempt $attempt/$max_attempts - MySQL not ready yet, waiting..."
    sleep 2
done

# Update conn.php with Docker MySQL settings
sed -i "s/'localhost'/'db'/g" /var/www/html/ordersimple/conn.php
sed -i "s/'root', ''/'root', 'password'/g" /var/www/html/ordersimple/conn.php

# Restart loop for Apache - handles restarts after code changes
while true; do
    echo "Starting Apache..."
    apache2-foreground
    echo "Apache stopped, restarting in 2 seconds..."
    sleep 2
done
