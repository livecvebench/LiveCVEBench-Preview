#!/bin/bash
# Solution script for Erlang/OTP SSH pre-auth message handling vulnerability (CVE-2025-32433)
# This script patches ssh_connection.erl to reject connection protocol messages
# (types >= 80) before authentication is complete, per RFC 4252 Section 6.

set -e

echo "[*] Applying fix for SSH pre-auth message handling..."

# Find the ssh_connection.erl file
SSH_CONN_FILE=$(find /usr/lib/erlang/lib/ssh-*/src -name "ssh_connection.erl" 2>/dev/null | head -1)

if [ -z "$SSH_CONN_FILE" ]; then
    # Try alternate locations
    SSH_CONN_FILE=$(find /usr/local/lib/erlang/lib/ssh-*/src -name "ssh_connection.erl" 2>/dev/null | head -1)
fi

if [ -z "$SSH_CONN_FILE" ]; then
    echo "[-] Error: Cannot find ssh_connection.erl"
    exit 1
fi

echo "[*] Found ssh_connection.erl at: $SSH_CONN_FILE"
SSH_DIR=$(dirname "$SSH_CONN_FILE")
SSH_EBIN_DIR="${SSH_DIR}/../ebin"

# Backup original file
cp "$SSH_CONN_FILE" "${SSH_CONN_FILE}.bak"

# Check if fix is already applied
if grep -q "authenticated = false" "$SSH_CONN_FILE"; then
    echo "[*] Fix appears to already be applied, skipping patch..."
else
    # Step 1: Add logger include if not present
    if ! grep -q 'include_lib("kernel/include/logger.hrl")' "$SSH_CONN_FILE"; then
        echo "[*] Adding logger include..."
        sed -i '/-include("ssh_transport.hrl")./a -include_lib("kernel/include/logger.hrl").' "$SSH_CONN_FILE"
    fi

    # Step 2: Add the authentication check clause
    echo "[*] Adding authentication check clause..."

    # Find line number of first channel_open handler for session
    LINE_NUM=$(grep -n 'handle_msg(#ssh_msg_channel_open{channel_type = "session"' "$SSH_CONN_FILE" | head -1 | cut -d: -f1)

    if [ -z "$LINE_NUM" ]; then
        echo "[-] Could not find channel_open handler"
        exit 1
    fi

    echo "[*] Inserting fix clause before line $LINE_NUM..."

    # Insert the fix clause before the channel_open handler
    head -n $((LINE_NUM - 1)) "$SSH_CONN_FILE" > "${SSH_CONN_FILE}.new"
    cat >> "${SSH_CONN_FILE}.new" << 'FIXEOF'
handle_msg(Msg, Connection, server, #ssh{authenticated = false}) ->
    %% See RFC4252 6.
    %% Message numbers of 80 and higher are reserved for protocols running
    %% after this authentication protocol, so receiving one of them before
    %% authentication is complete is an error, to which the server MUST
    %% respond by disconnecting.
    ?LOG_WARNING("Connection terminated. Unexpected message for unauthenticated user: ~p",
               [element(1, Msg)]),
    {disconnect, {?SSH_DISCONNECT_PROTOCOL_ERROR, "Connection refused"},
     handle_stop(Connection)};

FIXEOF
    tail -n +$LINE_NUM "$SSH_CONN_FILE" >> "${SSH_CONN_FILE}.new"
    mv "${SSH_CONN_FILE}.new" "$SSH_CONN_FILE"

    echo "[*] Fix clause inserted successfully"

    # Step 3: Recompile the module
    echo "[*] Recompiling ssh_connection module..."
    cd "$SSH_DIR"

    # Get the include paths
    ERLANG_ROOT=$(dirname $(dirname $(dirname "$SSH_DIR")))
    SSH_APP_DIR=$(dirname "$SSH_DIR")

    # Compile with proper include paths
    erlc -o "$SSH_EBIN_DIR" \
        -I "$SSH_APP_DIR/include" \
        -I "$SSH_APP_DIR/src" \
        -I "$ERLANG_ROOT/kernel/include" \
        -I "$ERLANG_ROOT" \
        +debug_info \
        ssh_connection.erl

    echo "[*] Recompilation complete"
fi

# Step 4: Restart the SSH server to load the new compiled module
echo "[*] Restarting SSH server to load patched module..."

# The entrypoint.sh runs a while loop that restarts erl when it exits
# Kill the erl process - the entrypoint will restart it automatically
pkill -f "erl.*ssh_server" || true

# Wait for the service to come back up
echo "[*] Waiting for service to restart..."
sleep 3

# Verify the server is back up
for i in $(seq 1 10); do
    if nc -z localhost 2222 2>/dev/null; then
        echo "[+] SSH server is back up and running on port 2222"
        break
    fi
    echo "[*] Waiting for server (attempt $i)..."
    sleep 1
done

echo "[+] Fix applied successfully!"
echo "[*] The SSH server will now reject connection protocol messages from unauthenticated clients"
