#!/bin/bash
# Solution script: Add server-side authorization checks to admin pages
set -e

echo "Applying authorization fix to admin pages..."

# Fix admin.php - add authorization check after session_start()
ADMIN_FILE="/var/www/html/admin.php"

if [ -f "$ADMIN_FILE" ]; then
    # Check if already fixed (contains the authorization check)
    if grep -q "SESSION\['admin'\]" "$ADMIN_FILE" && grep -q "exit()" "$ADMIN_FILE"; then
        echo "admin.php already appears to be fixed"
    else
        # Create the new header with authorization check
        cat > /tmp/admin_header.php << 'PHPCODE'
<?php
session_start();
if (!isset($_SESSION['admin']) || $_SESSION['admin'] != 1) {
    header("Location: user-login.php");
    exit();
}

 ?>
PHPCODE

        # Get everything after line 4 from original (skip original <?php, session_start();, empty line, and ?>)
        tail -n +5 "$ADMIN_FILE" > /tmp/admin_body.php

        # Combine fixed header with original body
        cat /tmp/admin_header.php /tmp/admin_body.php > "$ADMIN_FILE"

        # Verify syntax
        php -l "$ADMIN_FILE"

        echo "Fixed admin.php - added authorization check"
    fi
else
    echo "ERROR: admin.php not found at $ADMIN_FILE"
    exit 1
fi

# Fix backend/admin_control.php - add authorization check after session_start()
ADMIN_CONTROL_FILE="/var/www/html/backend/admin_control.php"

if [ -f "$ADMIN_CONTROL_FILE" ]; then
    # Check if already fixed
    if grep -q "403 Forbidden" "$ADMIN_CONTROL_FILE"; then
        echo "backend/admin_control.php already appears to be fixed"
    else
        # Create new header with authorization check
        cat > /tmp/admin_control_header.php << 'PHPCODE'
<?php
session_start();
if (!isset($_SESSION['admin']) || $_SESSION['admin'] != 1) {
    header("HTTP/1.1 403 Forbidden");
    echo "Access denied";
    exit();
}
if (isset($_POST['upload'])) {
PHPCODE

        # Get everything after line 3 from original (skip <?php, session_start();, if (isset($_POST['upload'])) {)
        tail -n +4 "$ADMIN_CONTROL_FILE" > /tmp/admin_control_body.php

        # Combine fixed header with original body
        cat /tmp/admin_control_header.php /tmp/admin_control_body.php > "$ADMIN_CONTROL_FILE"

        # Verify syntax
        php -l "$ADMIN_CONTROL_FILE"

        echo "Fixed backend/admin_control.php - added authorization check"
    fi
else
    echo "ERROR: admin_control.php not found at $ADMIN_CONTROL_FILE"
    exit 1
fi

echo ""
echo "Authorization fix applied successfully!"
echo ""
echo "Changes made:"
echo "  - admin.php: Added check for \$_SESSION['admin'] == 1, redirects to user-login.php if not admin"
echo "  - backend/admin_control.php: Added check for \$_SESSION['admin'] == 1, returns 403 Forbidden if not admin"
