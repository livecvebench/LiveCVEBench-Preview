"""
Functionality tests for poll vote submission handler.

These tests verify that the poll submission feature works correctly
for normal use cases. They should PASS in both vulnerable and fixed states.
"""

import subprocess
import json
import pytest
import os

# Path to the test runner script (copied to /app by run-tests.sh)
TEST_SCRIPT_PATH = "/app/test_poll_handler.ts"
APP_DIR = "/app"


def run_poll_handler_test(poll_id: str, answer_ids: list, meeting_id: str = "meeting-123", user_id: str = "user-456") -> dict:
    """
    Execute the poll handler with given inputs and return the result.
    Returns dict with 'success', 'result' or 'error' keys.
    """
    input_data = {
        "pollId": poll_id,
        "answerIds": answer_ids
    }

    session_vars = {
        "x-hasura-meetingid": meeting_id,
        "x-hasura-userid": user_id
    }

    test_payload = json.dumps({
        "input": input_data,
        "session": session_vars
    })

    result = subprocess.run(
        ["npx", "ts-node", TEST_SCRIPT_PATH],
        input=test_payload,
        capture_output=True,
        text=True,
        cwd=APP_DIR,
        timeout=30
    )

    try:
        output = json.loads(result.stdout.strip().split('\n')[-1])
        return output
    except (json.JSONDecodeError, IndexError):
        return {
            "success": False,
            "error": f"Failed to parse output: stdout={result.stdout}, stderr={result.stderr}",
            "returncode": result.returncode
        }


class TestPollHandlerFunctionality:
    """Test basic functionality of the poll handler."""

    def test_single_answer_submission(self):
        """Test submitting a poll with a single answer."""
        result = run_poll_handler_test(
            poll_id="poll-001",
            answer_ids=[0]
        )

        assert result["success"], f"Single answer submission failed: {result.get('error')}"
        assert "body" in result["result"]
        assert result["result"]["body"]["answerIds"] == [0]
        assert result["result"]["body"]["pollId"] == "poll-001"

    def test_multiple_answers_submission(self):
        """Test submitting a poll with multiple answers (multi-select)."""
        result = run_poll_handler_test(
            poll_id="poll-002",
            answer_ids=[0, 1, 2]
        )

        assert result["success"], f"Multiple answer submission failed: {result.get('error')}"
        assert result["result"]["body"]["answerIds"] == [0, 1, 2]

    def test_various_answer_indices(self):
        """Test submitting with various valid answer indices."""
        result = run_poll_handler_test(
            poll_id="poll-003",
            answer_ids=[5, 10, 15]
        )

        assert result["success"], f"Various indices submission failed: {result.get('error')}"
        assert result["result"]["body"]["answerIds"] == [5, 10, 15]

    def test_session_variables_in_routing(self):
        """Test that session variables are correctly propagated to routing."""
        result = run_poll_handler_test(
            poll_id="poll-004",
            answer_ids=[0],
            meeting_id="test-meeting-abc",
            user_id="test-user-xyz"
        )

        assert result["success"], f"Session variable test failed: {result.get('error')}"
        assert result["result"]["routing"]["meetingId"] == "test-meeting-abc"
        assert result["result"]["routing"]["userId"] == "test-user-xyz"

    def test_event_name_is_correct(self):
        """Test that the event name is set correctly."""
        result = run_poll_handler_test(
            poll_id="poll-005",
            answer_ids=[0]
        )

        assert result["success"], f"Event name test failed: {result.get('error')}"
        assert result["result"]["eventName"] == "RespondToPollReqMsg"

    def test_header_contains_required_fields(self):
        """Test that header contains all required fields."""
        result = run_poll_handler_test(
            poll_id="poll-006",
            answer_ids=[1],
            meeting_id="header-test-meeting",
            user_id="header-test-user"
        )

        assert result["success"], f"Header fields test failed: {result.get('error')}"
        header = result["result"]["header"]
        assert header["name"] == "RespondToPollReqMsg"
        assert header["meetingId"] == "header-test-meeting"
        assert header["userId"] == "header-test-user"

    def test_body_contains_required_fields(self):
        """Test that body contains all required fields."""
        result = run_poll_handler_test(
            poll_id="body-test-poll",
            answer_ids=[2, 3],
            user_id="body-test-user"
        )

        assert result["success"], f"Body fields test failed: {result.get('error')}"
        body = result["result"]["body"]
        assert body["pollId"] == "body-test-poll"
        assert body["answerIds"] == [2, 3]
        assert body["requesterId"] == "body-test-user"
        assert body["questionId"] == 0


class TestInputValidation:
    """Test input validation for required parameters."""

    def test_missing_poll_id_rejected(self):
        """Test that missing pollId is rejected."""
        input_data = json.dumps({
            "input": {"answerIds": [0]},
            "session": {"x-hasura-meetingid": "m1", "x-hasura-userid": "u1"}
        })

        result = subprocess.run(
            ["npx", "ts-node", TEST_SCRIPT_PATH],
            input=input_data,
            capture_output=True,
            text=True,
            cwd=APP_DIR,
            timeout=30
        )

        try:
            output = json.loads(result.stdout.strip().split('\n')[-1])
            assert not output["success"], "Missing pollId should be rejected"
            assert "pollId" in output.get("error", "").lower() or "required" in output.get("error", "").lower()
        except (json.JSONDecodeError, IndexError):
            # Script may exit with error - that's acceptable
            assert result.returncode != 0 or "error" in result.stderr.lower() or "required" in result.stderr.lower()

    def test_missing_answer_ids_rejected(self):
        """Test that missing answerIds is rejected."""
        input_data = json.dumps({
            "input": {"pollId": "poll-123"},
            "session": {"x-hasura-meetingid": "m1", "x-hasura-userid": "u1"}
        })

        result = subprocess.run(
            ["npx", "ts-node", TEST_SCRIPT_PATH],
            input=input_data,
            capture_output=True,
            text=True,
            cwd=APP_DIR,
            timeout=30
        )

        try:
            output = json.loads(result.stdout.strip().split('\n')[-1])
            assert not output["success"], "Missing answerIds should be rejected"
        except (json.JSONDecodeError, IndexError):
            # Script may exit with error - that's acceptable
            assert result.returncode != 0

    def test_invalid_answer_ids_type_rejected(self):
        """Test that non-array answerIds is rejected."""
        input_data = json.dumps({
            "input": {"pollId": "poll-123", "answerIds": "not-an-array"},
            "session": {"x-hasura-meetingid": "m1", "x-hasura-userid": "u1"}
        })

        result = subprocess.run(
            ["npx", "ts-node", TEST_SCRIPT_PATH],
            input=input_data,
            capture_output=True,
            text=True,
            cwd=APP_DIR,
            timeout=30
        )

        try:
            output = json.loads(result.stdout.strip().split('\n')[-1])
            assert not output["success"], "String answerIds should be rejected"
        except (json.JSONDecodeError, IndexError):
            # Script may exit with error - that's acceptable
            assert result.returncode != 0


class TestBoundaryConditions:
    """Test boundary conditions for array sizes."""

    def test_empty_answer_array_accepted(self):
        """Test that empty answerIds array is accepted (valid edge case)."""
        result = run_poll_handler_test(
            poll_id="poll-empty",
            answer_ids=[]
        )

        # Empty array may or may not be valid depending on implementation
        # Just verify it doesn't cause a crash
        assert "result" in result or "error" in result

    def test_small_array_accepted(self):
        """Test that a small array (5 elements) is accepted."""
        result = run_poll_handler_test(
            poll_id="poll-small",
            answer_ids=[0, 1, 2, 3, 4]
        )

        assert result["success"], f"Small array submission failed: {result.get('error')}"
        assert result["result"]["body"]["answerIds"] == [0, 1, 2, 3, 4]

    def test_medium_array_accepted(self):
        """Test that a medium array (50 elements) is accepted."""
        answer_ids = list(range(50))
        result = run_poll_handler_test(
            poll_id="poll-medium",
            answer_ids=answer_ids
        )

        assert result["success"], f"Medium array submission failed: {result.get('error')}"
        assert len(result["result"]["body"]["answerIds"]) == 50

    def test_boundary_array_accepted(self):
        """Test that exactly 100 elements is accepted (at the limit)."""
        answer_ids = list(range(100))
        result = run_poll_handler_test(
            poll_id="poll-boundary",
            answer_ids=answer_ids
        )

        assert result["success"], f"Boundary array (100) submission failed: {result.get('error')}"
        assert len(result["result"]["body"]["answerIds"]) == 100
