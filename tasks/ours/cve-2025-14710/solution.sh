#!/bin/bash
set -e

# Fix the SQL injection vulnerability in orderList.php by adding input validation
# The fix ensures telephone parameter contains exactly 11 digits

ORDER_LIST_FILE="/var/www/html/controller/api/orderList.php"

# Check if file exists
if [ ! -f "$ORDER_LIST_FILE" ]; then
    echo "Error: $ORDER_LIST_FILE not found"
    exit 1
fi

# Create a backup
cp "$ORDER_LIST_FILE" "${ORDER_LIST_FILE}.bak"

# Apply the fix using sed
# The fix adds input validation for the telephone parameter

# Step 1: Replace the direct assignment with validation logic
# Original: self.$this->telephone = $_REQUEST["telephone"];
# Fixed: Add validation before assignment

sed -i 's/function getOrders(){/function getOrders(){\
        $raw_telephone = isset($_REQUEST["telephone"]) ? $_REQUEST["telephone"] : "";\
        \
        \/\/ Validate telephone format: must be exactly 11 digits\
        if (!preg_match('\''\/^[0-9]{11}$\/'\'',$raw_telephone)) {\
            Response::show(201,"fail","Invalid telephone format","json");\
            return;\
        }/g' "$ORDER_LIST_FILE"

# Step 2: Replace the original telephone assignment line with the validated value
sed -i 's/self\.\$this->telephone = \$_REQUEST\["telephone"\];/self.$this->telephone = $raw_telephone;/g' "$ORDER_LIST_FILE"

echo "Fix applied successfully to $ORDER_LIST_FILE"

# Verify the fix was applied
if grep -q 'preg_match' "$ORDER_LIST_FILE"; then
    echo "Verification: Input validation code found in file"
else
    echo "Warning: Could not verify fix was applied correctly"
    exit 1
fi

echo "Done. SQL injection vulnerability has been mitigated."
