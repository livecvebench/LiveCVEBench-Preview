#!/bin/bash
# Solution script for CVE-2025-24367: Cacti line delimiter injection vulnerability
# This script modifies cacti_escapeshellarg() to strip newline characters
set -e

CACTI_DIR="${CACTI_DIR:-/var/www/html/cacti}"
FUNCTIONS_FILE="$CACTI_DIR/lib/functions.php"

echo "=== Applying fix for CVE-2025-24367 line delimiter injection ==="
echo "Target file: $FUNCTIONS_FILE"

# Verify the file exists
if [ ! -f "$FUNCTIONS_FILE" ]; then
    echo "ERROR: $FUNCTIONS_FILE not found"
    exit 1
fi

# Check if fix is already applied
if grep -q 'str_replace.*\\n.*\\r' "$FUNCTIONS_FILE" 2>/dev/null; then
    echo "Fix already applied - skipping"
    exit 0
fi

# Create a backup
cp "$FUNCTIONS_FILE" "${FUNCTIONS_FILE}.bak"

# Apply the fix using sed
# The vulnerable function looks like:
#   function cacti_escapeshellarg($string, $quote = true) {
#       global $config;
#
# We add newline stripping after "global $config;"

sed -i '/function cacti_escapeshellarg/,/global \$config;/ {
    /global \$config;/ a\
\
\t// Strip newline and carriage return to prevent command injection (CVE-2025-24367)\
\tif ($string != \x27\x27) {\
\t\t$string = str_replace(array("\\n", "\\r"), \x27\x27, $string);\
\t}
}' "$FUNCTIONS_FILE"

# Verify the fix was applied
if grep -q 'str_replace.*\\n.*\\r' "$FUNCTIONS_FILE"; then
    echo "=== Fix applied successfully ==="
    echo ""
    echo "The cacti_escapeshellarg() function now strips newline and carriage"
    echo "return characters from input before passing to shell commands."
    echo ""
    echo "Fix applied successfully!"
    exit 0
else
    echo "Trying alternative fix method..."

    # Alternative: Use PHP to apply the fix
    php << 'EOFPHP'
<?php
$file = '/var/www/html/cacti/lib/functions.php';

$content = file_get_contents($file);
if ($content === false) {
    echo "ERROR: Could not read $file\n";
    exit(1);
}

// Find the function and insert the fix after "global $config;"
$pattern = '/(function cacti_escapeshellarg\s*\([^)]*\)\s*\{[^}]*?global \$config;)/s';
$replacement = '$1

	// Strip newline and carriage return to prevent command injection (CVE-2025-24367)
	if ($string != \'\') {
		$string = str_replace(array("\n", "\r"), \'\', $string);
	}';

$newContent = preg_replace($pattern, $replacement, $content, 1, $count);

if ($count === 0) {
    echo "ERROR: Could not find cacti_escapeshellarg function pattern\n";
    exit(1);
}

if (file_put_contents($file, $newContent) === false) {
    echo "ERROR: Could not write to $file\n";
    exit(1);
}

echo "SUCCESS: Fix applied to cacti_escapeshellarg function\n";
?>
EOFPHP

    if [ $? -eq 0 ]; then
        echo "=== Fix applied via PHP ==="
        exit 0
    else
        echo "ERROR: Could not apply fix"
        exit 1
    fi
fi
