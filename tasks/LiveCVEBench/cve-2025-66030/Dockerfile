FROM node:18

WORKDIR /app

# System dependencies (tmux, asciinema, curl required, plus python3 for pytest)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install pytest globally using pip with break-system-packages flag (Debian 12)
RUN pip3 install --break-system-packages pytest

# Clone vulnerable version and remove git history
RUN git clone --depth 1 --branch v1.3.1 https://github.com/digitalbazaar/forge.git . && \
    rm -rf .git

# Install npm dependencies (includes devDependencies for mocha testing)
RUN npm install

# Verify library loads correctly
RUN node -e "require('./lib/asn1'); console.log('node-forge library loaded successfully');"

# Default command - keep container running for testing
CMD ["tail", "-f", "/dev/null"]
