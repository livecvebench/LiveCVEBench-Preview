"""
Functional tests for shiyi-blog scheduled task feature.
These tests verify that the application's core functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""
import pytest
import requests
import time

BASE_URL = "http://localhost:8800/shiyi"

# Default admin credentials
ADMIN_USERNAME = "admin"
ADMIN_PASSWORD = "123456"


class TestAuth:
    """Test authentication functionality"""

    @pytest.fixture(scope="class")
    def auth_token(self):
        """Get authentication token for admin user"""
        login_url = f"{BASE_URL}/login"
        payload = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "rememberMe": False
        }

        # Try multiple times as server may be starting up
        for attempt in range(3):
            try:
                response = requests.post(login_url, json=payload, timeout=10)
                if response.status_code == 200:
                    data = response.json()
                    if data.get("code") == 200 or data.get("success"):
                        # Token is returned directly in data field as a string
                        token = data.get("data")
                        if token and isinstance(token, str):
                            return token
                        # Or it might be in data.token for some API versions
                        elif token and isinstance(token, dict):
                            return token.get("token")
            except requests.exceptions.RequestException:
                time.sleep(2)

        pytest.skip("Could not authenticate with admin credentials")

    def test_login_endpoint_accessible(self):
        """Verify login endpoint is accessible"""
        response = requests.post(
            f"{BASE_URL}/login",
            json={"username": "test", "password": "test", "rememberMe": False},
            timeout=10
        )
        # Should get a response (even if login fails)
        assert response.status_code in [200, 400, 401, 500]

    def test_admin_login_success(self, auth_token):
        """Verify admin can log in successfully"""
        assert auth_token is not None


class TestJobListEndpoint:
    """Test scheduled task list functionality"""

    @pytest.fixture(scope="class")
    def auth_headers(self):
        """Get authentication headers"""
        login_url = f"{BASE_URL}/login"
        payload = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "rememberMe": False
        }

        for attempt in range(3):
            try:
                response = requests.post(login_url, json=payload, timeout=10)
                if response.status_code == 200:
                    data = response.json()
                    if data.get("code") == 200 or data.get("success"):
                        token = data.get("data")
                        if token and isinstance(token, str):
                            return {"Authorization": token}
                        elif token and isinstance(token, dict):
                            return {"Authorization": token.get("token")}
            except requests.exceptions.RequestException:
                time.sleep(2)

        pytest.skip("Could not authenticate")

    def test_job_list_endpoint_requires_auth(self):
        """Verify job list endpoint requires authentication"""
        response = requests.get(f"{BASE_URL}/system/job/list", timeout=10)
        # Should fail without auth
        assert response.status_code in [401, 403, 500] or (
            response.status_code == 200 and response.json().get("code") != 200
        )

    def test_job_list_endpoint_with_auth(self, auth_headers):
        """Verify job list endpoint works with authentication"""
        response = requests.get(
            f"{BASE_URL}/system/job/list",
            headers=auth_headers,
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        # Should return success with list of jobs
        assert data.get("code") == 200 or data.get("success") == True


class TestSpringBeanTaskExecution:
    """Test that legitimate Spring bean tasks work correctly"""

    @pytest.fixture(scope="class")
    def auth_headers(self):
        """Get authentication headers"""
        login_url = f"{BASE_URL}/login"
        payload = {
            "username": ADMIN_USERNAME,
            "password": ADMIN_PASSWORD,
            "rememberMe": False
        }

        for attempt in range(3):
            try:
                response = requests.post(login_url, json=payload, timeout=10)
                if response.status_code == 200:
                    data = response.json()
                    if data.get("code") == 200 or data.get("success"):
                        token = data.get("data")
                        if token and isinstance(token, str):
                            return {"Authorization": token}
                        elif token and isinstance(token, dict):
                            return {"Authorization": token.get("token")}
            except requests.exceptions.RequestException:
                time.sleep(2)

        pytest.skip("Could not authenticate")

    def test_get_existing_jobs(self, auth_headers):
        """Verify we can retrieve existing jobs"""
        response = requests.get(
            f"{BASE_URL}/system/job/list",
            headers=auth_headers,
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("code") == 200 or data.get("success")

    def test_run_endpoint_exists(self, auth_headers):
        """Verify the run endpoint is accessible"""
        # Send a request to the run endpoint (it may fail due to invalid job, but endpoint should exist)
        response = requests.post(
            f"{BASE_URL}/system/job/run",
            headers=auth_headers,
            json={"jobId": 1},
            timeout=10
        )
        # Endpoint should be accessible (even if the specific job doesn't exist)
        assert response.status_code in [200, 400, 500]


class TestApiEndpoints:
    """Test various API endpoints are accessible"""

    def test_swagger_docs_accessible(self):
        """Verify API documentation is accessible (requires basic auth admin/admin)"""
        # Knife4j swagger requires basic auth with admin/admin
        # This is a non-essential functionality test - just verify the endpoint responds
        try:
            response = requests.get(f"{BASE_URL}/doc.html", auth=("admin", "admin"), timeout=10)
            # Accept any response that shows the server is responding
            assert response.status_code in [200, 401, 403, 302]
        except requests.exceptions.ConnectionError:
            pytest.skip("Documentation endpoint not responding - non-essential test")

    def test_health_check(self):
        """Basic connectivity check"""
        try:
            response = requests.get(f"{BASE_URL}/", timeout=10)
            # Any response means server is up
            assert response.status_code is not None
        except requests.exceptions.ConnectionError:
            pytest.fail("Cannot connect to application")
