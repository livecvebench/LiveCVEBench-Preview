#!/bin/bash
# Solution script for CVE-2025-68155 - Arbitrary File Read in @vitejs/plugin-rsc
# This script applies the fix by adding path validation to the findSourceMapURL function.

set -e

echo "[*] Applying fix for arbitrary file read vulnerability..."

# Find the bundled plugin file containing findSourceMapURL
# The vulnerable code is in the bundled plugin file (plugin-*.js), not a separate file
FILE=$(find /app/node_modules/@vitejs/plugin-rsc/dist -maxdepth 1 -name "plugin-*.js" -type f | head -1)

if [ -z "$FILE" ]; then
    echo "[-] Error: Could not find plugin-*.js file"
    exit 1
fi

echo "[*] Found plugin file: $FILE"

# Verify the file contains the vulnerable code
if ! grep -q "__vite_rsc_findSourceMapURL" "$FILE"; then
    echo "[-] Error: File does not contain the findSourceMapURL endpoint"
    exit 1
fi

# Check if fix is already applied
if grep -q "isFileLoadingAllowed" "$FILE"; then
    echo "[+] Fix already applied, skipping..."
else
    echo "[*] Patching $FILE..."

    # Use Node.js to apply the fix more reliably
    node << EOF
const fs = require('fs');
const path = '$FILE';

let content = fs.readFileSync(path, 'utf-8');

// The file imports vite as: import * as vite from "vite";
// We need to add isFileLoadingAllowed to the existing destructured import
// or add it as a new import

// Add isFileLoadingAllowed to the import from "vite"
if (!content.includes('isFileLoadingAllowed')) {
    // The file has: import { defaultServerConditions, isCSSRequest, normalizePath, parseAstAsync } from "vite";
    // Add isFileLoadingAllowed to this import
    content = content.replace(
        /import\s*\{([^}]*)\}\s*from\s*"vite"/,
        (match, imports) => {
            if (!imports.includes('isFileLoadingAllowed')) {
                return 'import { ' + imports.trim() + ', isFileLoadingAllowed } from "vite"';
            }
            return match;
        }
    );
}

// Now apply the actual fix to the findSourceMapURL function
// Look for the vulnerable pattern in the findSourceMapURL function:
//   if (fs.existsSync(filename)) {
// Change it to:
//   if (isFileLoadingAllowed(server.config, filename) && fs.existsSync(filename)) {

// The vulnerable code is specifically within the findSourceMapURL function context
// We need to be careful to only modify the correct instance

const vulnerablePattern = /if\s*\(\s*fs\.existsSync\s*\(\s*filename\s*\)\s*\)\s*\{[\s\S]*?const\s+content\s*=\s*fs\.readFileSync\s*\(\s*filename\s*,\s*["']utf-8["']\s*\)/;

if (vulnerablePattern.test(content)) {
    content = content.replace(
        /if\s*\(\s*fs\.existsSync\s*\(\s*filename\s*\)\s*\)/,
        'if (isFileLoadingAllowed(server.config, filename) && fs.existsSync(filename))'
    );
    console.log('[+] Patch applied successfully');
} else {
    console.log('[-] Warning: Could not find the exact vulnerable pattern');
    // Try a more aggressive pattern replacement for all fs.existsSync(filename) in the file
    // But limit to the findSourceMapURL function context
    const findSourceMapRegion = content.match(/async function findSourceMapURL[\s\S]*?^}/m);
    if (findSourceMapRegion) {
        const originalRegion = findSourceMapRegion[0];
        const patchedRegion = originalRegion.replace(
            /if\s*\(\s*fs\.existsSync\s*\(\s*filename\s*\)\s*\)/,
            'if (isFileLoadingAllowed(server.config, filename) && fs.existsSync(filename))'
        );
        content = content.replace(originalRegion, patchedRegion);
        console.log('[+] Patch applied using region-based approach');
    } else {
        console.log('[-] Error: Could not locate findSourceMapURL function');
        process.exit(1);
    }
}

fs.writeFileSync(path, content);
EOF

fi

echo "[*] Verifying fix was applied..."
if grep -q "isFileLoadingAllowed" "$FILE"; then
    echo "[+] Fix verified successfully!"
else
    echo "[-] Error: Fix verification failed"
    exit 1
fi

# Restart the Vite dev server to apply changes
echo "[*] Restarting Vite dev server..."
pkill -f "node.*vite" || true
pkill -f "vite" || true
sleep 2

# Start the server in the background
cd /app
nohup npm run dev > /tmp/vite.log 2>&1 &
sleep 5

echo "[+] Fix applied and server restarted."
