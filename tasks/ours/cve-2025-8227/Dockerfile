FROM node:22-slim

# Accept proxy build arguments (injected by check script)
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG http_proxy
ARG https_proxy

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required + git for cloning + bash for entrypoint)
RUN apt-get update && apt-get install -y \
    bash \
    git \
    tmux \
    asciinema \
    curl \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Clone ChanCMS repository and remove git history
RUN git clone https://github.com/chancms/ChanCMS.git . && rm -rf .git

# Install additional packages needed by collect service for proxy support
RUN npm install && npm install node-fetch http-proxy-agent https-proxy-agent

# Copy environment file
COPY task-deps/env.dev .env.dev

# Copy vulnerable controller and guard files
COPY task-deps/collect_vulnerable.js /app/app/modules/cms/controller/collect.js
COPY task-deps/guard_vulnerable.js /app/app/middleware/guard.js
COPY task-deps/clearhtml.js /app/app/middleware/clearhtml.js

# Copy router with auth disabled for /collect/getArticle endpoint
COPY task-deps/cms_router.js /app/app/modules/cms/router.js

# Copy collect service with proxy support
COPY task-deps/collect_service.js /app/app/modules/cms/service/collect.js

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh


# CMD ["/entrypoint.sh"]
