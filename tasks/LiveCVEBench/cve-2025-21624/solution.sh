#!/bin/bash
#
# Solution script for ClipBucket V5 Playlist Cover Upload Vulnerability
#
# This script removes the vulnerable playlist cover upload functionality
# to prevent arbitrary file uploads and remote code execution.
#
# The fix mirrors the official security patch which removes the upload
# feature entirely rather than attempting to add validation.
#

set -e

echo "Applying security fix for playlist cover upload vulnerability..."

# Determine ClipBucket installation path
# Standard Docker path is /srv/http/clipbucket/upload
# Other possible locations: /var/www/html, /app
if [ -d "/srv/http/clipbucket/upload" ]; then
    CB_ROOT="/srv/http/clipbucket/upload"
elif [ -d "/app/upload" ]; then
    CB_ROOT="/app/upload"
elif [ -d "/var/www/html" ] && [ -f "/var/www/html/manage_playlists.php" ]; then
    CB_ROOT="/var/www/html"
elif [ -f "/app/manage_playlists.php" ]; then
    CB_ROOT="/app"
else
    # Try to find it
    CB_ROOT=$(find /srv /var/www /app -name "manage_playlists.php" -type f 2>/dev/null | head -1 | xargs dirname 2>/dev/null || echo "")
fi

if [ -z "$CB_ROOT" ] || [ ! -f "$CB_ROOT/manage_playlists.php" ]; then
    echo "ERROR: Could not find ClipBucket installation"
    echo "Searched in: /srv/http/clipbucket/upload, /app/upload, /var/www/html, /app"
    exit 1
fi

echo "Found ClipBucket at: $CB_ROOT"

# ================================================================
# Cleanup: Remove any previously uploaded PHP files in playlist_covers
# ================================================================

PLAYLIST_COVERS="$CB_ROOT/images/playlist_covers"
if [ -d "$PLAYLIST_COVERS" ]; then
    echo "Cleaning up potentially malicious uploaded files..."
    find "$PLAYLIST_COVERS" -name "*.php*" -type f -delete 2>/dev/null || true
    echo "  - Removed any PHP files from playlist_covers directory"
fi

# Export variables for PHP scripts
export CB_ROOT
export MANAGE_PLAYLISTS="$CB_ROOT/manage_playlists.php"
export ADMIN_MANAGE_PLAYLIST="$CB_ROOT/admin_area/manage_playlist.php"
export FUNCTIONS_PLAYLIST="$CB_ROOT/includes/functions_playlist.php"

# ================================================================
# Fix 1: Remove upload handler from manage_playlists.php (user area)
# ================================================================

if [ -f "$MANAGE_PLAYLISTS" ]; then
    echo "Patching: $MANAGE_PLAYLISTS"

    # Create a PHP script for proper brace-matching removal
    php << 'PHPSOLUTION'
<?php
$file = getenv('MANAGE_PLAYLISTS');
if (!$file || !file_exists($file)) {
    echo "  ERROR: Could not access file\n";
    exit(1);
}
$content = file_get_contents($file);

// Use a token-based approach to find and remove the block
function remove_upload_block($content) {
    $lines = explode("\n", $content);
    $result = [];
    $braceCount = 0;
    $inBlock = false;

    foreach ($lines as $line) {
        // Check if this line starts the upload_playlist_cover block
        if (preg_match('/if\s*\(\s*isset\s*\(\s*\$_POST\s*\[\s*[\'"]upload_playlist_cover[\'"]\s*\]/', $line)) {
            $inBlock = true;
            // Count opening braces on this line
            $braceCount = substr_count($line, '{') - substr_count($line, '}');
            continue;
        }

        if ($inBlock) {
            $braceCount += substr_count($line, '{') - substr_count($line, '}');
            if ($braceCount <= 0) {
                $inBlock = false;
            }
            continue;
        }

        $result[] = $line;
    }

    return implode("\n", $result);
}

$content = remove_upload_block($content);
file_put_contents($file, $content);
echo "  - Removed upload_playlist_cover handler from user area\n";
?>
PHPSOLUTION

    chown www-data:www-data "$MANAGE_PLAYLISTS" 2>/dev/null || true
    chmod 644 "$MANAGE_PLAYLISTS" 2>/dev/null || true
fi

# ================================================================
# Fix 2: Remove upload handler from admin_area/manage_playlist.php
# ================================================================

if [ -f "$ADMIN_MANAGE_PLAYLIST" ]; then
    echo "Patching: $ADMIN_MANAGE_PLAYLIST"

    php << 'PHPSOLUTION'
<?php
$file = getenv('ADMIN_MANAGE_PLAYLIST');
if (!$file || !file_exists($file)) {
    echo "  ERROR: Could not access file\n";
    exit(1);
}
$content = file_get_contents($file);

// Use a token-based approach to find and remove the block
function remove_upload_block($content) {
    $lines = explode("\n", $content);
    $result = [];
    $braceCount = 0;
    $inBlock = false;

    foreach ($lines as $line) {
        // Check if this line starts the upload_playlist_cover block
        if (preg_match('/if\s*\(\s*isset\s*\(\s*\$_POST\s*\[\s*[\'"]upload_playlist_cover[\'"]\s*\]/', $line)) {
            $inBlock = true;
            // Count opening braces on this line
            $braceCount = substr_count($line, '{') - substr_count($line, '}');
            continue;
        }

        if ($inBlock) {
            $braceCount += substr_count($line, '{') - substr_count($line, '}');
            if ($braceCount <= 0) {
                $inBlock = false;
            }
            continue;
        }

        $result[] = $line;
    }

    return implode("\n", $result);
}

$content = remove_upload_block($content);
file_put_contents($file, $content);
echo "  - Removed upload_playlist_cover handler from admin area\n";
?>
PHPSOLUTION

    chown www-data:www-data "$ADMIN_MANAGE_PLAYLIST" 2>/dev/null || true
    chmod 644 "$ADMIN_MANAGE_PLAYLIST" 2>/dev/null || true
fi

# ================================================================
# Fix 3: Remove playlist_upload_cover function from functions_playlist.php
# ================================================================

if [ -f "$FUNCTIONS_PLAYLIST" ]; then
    echo "Patching: $FUNCTIONS_PLAYLIST"

    php << 'PHPSOLUTION'
<?php
$file = getenv('FUNCTIONS_PLAYLIST');
if (!$file || !file_exists($file)) {
    echo "  ERROR: Could not access file\n";
    exit(1);
}
$content = file_get_contents($file);

// Remove the playlist_upload_cover function
function remove_function($content, $funcName) {
    $lines = explode("\n", $content);
    $result = [];
    $braceCount = 0;
    $inFunction = false;

    foreach ($lines as $line) {
        // Check if this line starts the function
        if (preg_match('/function\s+' . preg_quote($funcName, '/') . '\s*\(/', $line)) {
            $inFunction = true;
            // Count opening braces on this line
            $braceCount = substr_count($line, '{') - substr_count($line, '}');
            continue;
        }

        if ($inFunction) {
            $braceCount += substr_count($line, '{') - substr_count($line, '}');
            if ($braceCount <= 0) {
                $inFunction = false;
            }
            continue;
        }

        $result[] = $line;
    }

    return implode("\n", $result);
}

$content = remove_function($content, 'playlist_upload_cover');
file_put_contents($file, $content);
echo "  - Removed playlist_upload_cover function\n";
?>
PHPSOLUTION

    chown www-data:www-data "$FUNCTIONS_PLAYLIST" 2>/dev/null || true
    chmod 644 "$FUNCTIONS_PLAYLIST" 2>/dev/null || true
fi

# ================================================================
# Verification
# ================================================================

echo ""
echo "Verifying patches..."

# Check for remaining vulnerable code
REMAINING=$(grep -rn "upload_playlist_cover\|playlist_upload_cover" "$CB_ROOT" 2>/dev/null | grep -v ".bak" | grep -v "DISABLED" | wc -l || echo "0")

if [ "$REMAINING" -eq 0 ] || [ "$REMAINING" = "0" ]; then
    echo "SUCCESS: All vulnerable code has been removed"
else
    echo "WARNING: Found $REMAINING remaining references"
    grep -rn "upload_playlist_cover\|playlist_upload_cover" "$CB_ROOT" 2>/dev/null | grep -v ".bak" | grep -v "DISABLED" || true

    # Fallback: use sed to comment out remaining references
    echo ""
    echo "Applying fallback cleanup..."

    # Remove any remaining code blocks containing upload_playlist_cover
    find "$CB_ROOT" -name "*.php" -type f -exec grep -l "upload_playlist_cover\|playlist_upload_cover" {} \; 2>/dev/null | while read file; do
        echo "  Cleaning: $file"
        # Comment out lines containing the vulnerable code
        sed -i 's/\(.*upload_playlist_cover.*\)/\/\/ DISABLED: \1/g' "$file" 2>/dev/null || true
        sed -i 's/\(.*playlist_upload_cover.*\)/\/\/ DISABLED: \1/g' "$file" 2>/dev/null || true
    done
fi

# ================================================================
# Clear PHP OPcache (if available)
# ================================================================

echo ""
echo "Clearing PHP cache..."

# Try to restart PHP-FPM to clear OPcache
if command -v service &> /dev/null; then
    service php8.2-fpm restart 2>/dev/null || \
    service php8.1-fpm restart 2>/dev/null || \
    service php-fpm restart 2>/dev/null || \
    echo "  Could not restart PHP-FPM (may need manual restart)"
    # Wait for PHP-FPM to start
    sleep 3
elif command -v systemctl &> /dev/null; then
    systemctl restart php8.2-fpm 2>/dev/null || \
    systemctl restart php8.1-fpm 2>/dev/null || \
    systemctl restart php-fpm 2>/dev/null || \
    echo "  Could not restart PHP-FPM via systemctl"
    # Wait for PHP-FPM to start
    sleep 3
else
    # Try to kill PHP-FPM processes
    pkill -f "php-fpm" 2>/dev/null || true
    sleep 3
fi

echo ""
echo "=========================================="
echo "Fix applied successfully!"
echo "=========================================="
echo ""
echo "The playlist cover upload functionality has been disabled."
echo "This prevents arbitrary file uploads and remote code execution."
echo ""
