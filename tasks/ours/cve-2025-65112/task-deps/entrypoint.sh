#!/bin/bash
set -e

# Wait for database to be ready
echo "Waiting for database to be ready..."
sleep 5

# Create packages directory if needed
mkdir -p /app/packages

cd /app

# Function to seed test user after API starts
seed_test_user() {
    echo "Waiting for API to be ready for seeding..."
    sleep 10

    # Check if user already exists by attempting to register
    # Registration will fail if user exists, which is fine
    echo "Seeding test user for vulnerability demonstration..."
    curl -s -X POST http://localhost/api/authentication/register \
        -H "Content-Type: application/json" \
        -d '{
            "userName": "testuser",
            "name": "Test User",
            "email": "test@example.com",
            "password": "TestPass123!"
        }' > /dev/null 2>&1 || true

    echo "Test user seeding complete."
}

# Start the application with restart capability
while true; do
    echo "Starting PubNet API..."

    # Start user seeding in background (only runs once per container start)
    seed_test_user &

    dotnet PubNet.API.dll --urls "http://0.0.0.0:80" || true
    echo "Application exited, restarting in 2 seconds..."
    sleep 2
done
