#!/bin/bash
set -e
cd /app

echo "Applying fix for ASN.1 OID integer handling..."

# Create a Node.js script to apply the fix with proper string replacements
cat > /tmp/apply_fix.js << 'FIXSCRIPT'
const fs = require('fs');

let content = fs.readFileSync('/app/lib/asn1.js', 'utf8');

// Fix 1: Add 32-bit validation in oidToDer
// Find the pattern where value is parsed and add validation before the do-while loop
const oidToDerPattern = /value = parseInt\(values\[i\], 10\);\n(\s+)do \{/;
const oidToDerReplacement = `value = parseInt(values[i], 10);
$1// TODO: Change bitwise logic to allow larger values.
$1if(value > 0xffffffff) {
$1  throw new Error('OID value too large; max is 32-bits.');
$1}
$1do {`;

if (oidToDerPattern.test(content)) {
    content = content.replace(oidToDerPattern, oidToDerReplacement);
    console.log('Applied fix 1: Added 32-bit validation in oidToDer');
} else {
    console.log('Warning: Could not find oidToDer pattern - may already be fixed');
}

// Fix 2: Add 53-bit check in derToOid and replace bitwise shift with multiplication
// Find the while loop pattern in derToOid
const derToOidPattern = /var value = 0;\n(\s+)while\(bytes\.length\(\) > 0\) \{\n(\s+)b = bytes\.getByte\(\);\n(\s+)value = value << 7;/;
const derToOidReplacement = `var value = 0;
$1while(bytes.length() > 0) {
$2// error if 7b shift would exceed Number.MAX_SAFE_INTEGER
$2// (Number.MAX_SAFE_INTEGER / 128)
$2if(value > 0x3fffffffffff) {
$2  throw new Error('OID value too large; max is 53-bits.');
$2}
$2b = bytes.getByte();
$3value = value * 128;`;

if (derToOidPattern.test(content)) {
    content = content.replace(derToOidPattern, derToOidReplacement);
    console.log('Applied fix 2: Added 53-bit check and replaced bitwise shift in derToOid');
} else {
    console.log('Warning: Could not find derToOid pattern - may already be fixed');
}

fs.writeFileSync('/app/lib/asn1.js', content);
console.log('Fix applied successfully!');
FIXSCRIPT

# Run the fix script
node /tmp/apply_fix.js

# Clean up
rm -f /tmp/apply_fix.js

echo "Fix complete."
