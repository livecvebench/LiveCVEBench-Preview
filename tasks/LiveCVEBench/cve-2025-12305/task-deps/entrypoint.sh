#!/bin/bash

# Entrypoint script for shiyi-blog
# Wraps the application in a restart loop to support solution.sh restart operations

# Wait for MySQL and Redis to be ready
echo "Waiting for MySQL..."
while ! nc -z mysql 3306; do
    sleep 1
done
echo "MySQL is ready!"

echo "Waiting for Redis..."
while ! nc -z redis 6379; do
    sleep 1
done
echo "Redis is ready!"

echo "Waiting for Elasticsearch..."
while ! nc -z elasticsearch 9200; do
    sleep 1
done
echo "Elasticsearch is ready!"

# Start application in a loop
while true; do
    echo "Starting shiyi-blog application..."
    java -jar /app/shiyi-blog.jar \
        --spring.profiles.active=dev \
        --spring.datasource.url=jdbc:mysql://mysql:3306/blog?characterEncoding=UTF-8\&useUnicode=true\&useSSL=false\&serverTimezone=Asia/Shanghai\&tinyInt1isBit=false\&allowPublicKeyRetrieval=true \
        --spring.datasource.username=root \
        --spring.datasource.password=root \
        --spring.redis.host=redis \
        --spring.elasticsearch.rest.uris=http://elasticsearch:9200
    EXIT_CODE=$?
    echo "Application exited with code $EXIT_CODE. Restarting in 2 seconds..."
    sleep 2
done
