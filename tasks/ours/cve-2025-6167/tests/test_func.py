"""
Functional tests for workflow API.
These tests verify that the workflow storage system works correctly
for legitimate use cases.
"""

import pytest
import requests
import time
import os
import json

BASE_URL = os.environ.get("APP_URL", "http://localhost:8080")


# Valid workflow structure required by the API (must have nodes and edges)
def make_workflow_payload(workflow_id, name="Test Workflow", description="Test"):
    """Create a valid workflow payload with the given ID."""
    return {
        "id": workflow_id,
        "name": name,
        "description": description,
        "version": "1.0",
        "nodes": [
            {"id": "node1", "name": "Start", "type": "INPUT", "config": {}},
            {"id": "node2", "name": "End", "type": "OUTPUT", "config": {}}
        ],
        "edges": [
            {"id": "edge1", "source_node_id": "node1", "target_node_id": "node2", "edge_type": "DATA"}
        ]
    }


@pytest.fixture(scope="module")
def wait_for_app():
    """Wait for the application to be ready."""
    max_retries = 30
    for i in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=2)
            if response.status_code == 200:
                return True
        except requests.exceptions.ConnectionError:
            pass
        time.sleep(1)
    pytest.fail("Application did not start in time")


class TestWorkflowFunctionality:
    """Test basic workflow CRUD operations work correctly."""

    def test_create_workflow_with_alphanumeric_id(self, wait_for_app):
        """Create a workflow with a simple alphanumeric ID."""
        workflow_id = f"testworkflow{int(time.time())}"
        payload = make_workflow_payload(workflow_id, "Test Workflow", "A test workflow")

        response = requests.post(
            f"{BASE_URL}/api/workflows/",
            json=payload,
            timeout=10
        )

        assert response.status_code == 201, f"Expected 201, got {response.status_code}: {response.text}"
        data = response.json()
        assert data.get("id") == workflow_id

    def test_create_workflow_with_hyphens(self, wait_for_app):
        """Create a workflow with hyphens in the ID."""
        workflow_id = f"test-workflow-{int(time.time())}"
        payload = make_workflow_payload(workflow_id, "Hyphenated Workflow", "Workflow with hyphens in ID")

        response = requests.post(
            f"{BASE_URL}/api/workflows/",
            json=payload,
            timeout=10
        )

        assert response.status_code == 201, f"Expected 201, got {response.status_code}: {response.text}"
        data = response.json()
        assert data.get("id") == workflow_id

    def test_create_workflow_with_underscores(self, wait_for_app):
        """Create a workflow with underscores in the ID."""
        workflow_id = f"test_workflow_{int(time.time())}"
        payload = make_workflow_payload(workflow_id, "Underscored Workflow", "Workflow with underscores in ID")

        response = requests.post(
            f"{BASE_URL}/api/workflows/",
            json=payload,
            timeout=10
        )

        assert response.status_code == 201, f"Expected 201, got {response.status_code}: {response.text}"
        data = response.json()
        assert data.get("id") == workflow_id

    def test_create_workflow_with_mixed_case(self, wait_for_app):
        """Create a workflow with mixed case alphanumeric ID."""
        workflow_id = f"TestWorkFlow123_{int(time.time())}"
        payload = make_workflow_payload(workflow_id, "Mixed Case Workflow", "Workflow with mixed case")

        response = requests.post(
            f"{BASE_URL}/api/workflows/",
            json=payload,
            timeout=10
        )

        assert response.status_code == 201, f"Expected 201, got {response.status_code}: {response.text}"
        data = response.json()
        assert data.get("id") == workflow_id

    def test_list_workflows(self, wait_for_app):
        """List workflows returns a valid response."""
        response = requests.get(
            f"{BASE_URL}/api/workflows/",
            timeout=10
        )

        assert response.status_code == 200, f"Expected 200, got {response.status_code}: {response.text}"
        data = response.json()
        assert isinstance(data, list), "Expected list response"

    def test_get_workflow_by_id(self, wait_for_app):
        """Create and then retrieve a workflow by ID."""
        workflow_id = f"gettest{int(time.time())}"
        payload = make_workflow_payload(workflow_id, "Get Test Workflow", "Workflow for get test")

        # Create workflow
        create_response = requests.post(
            f"{BASE_URL}/api/workflows/",
            json=payload,
            timeout=10
        )
        assert create_response.status_code == 201

        # Get workflow
        get_response = requests.get(
            f"{BASE_URL}/api/workflows/{workflow_id}",
            timeout=10
        )

        assert get_response.status_code == 200, f"Expected 200, got {get_response.status_code}: {get_response.text}"
        data = get_response.json()
        assert data.get("id") == workflow_id
        assert data.get("name") == "Get Test Workflow"

    def test_create_workflow_with_nodes_and_edges(self, wait_for_app):
        """Create a workflow with nodes and edges."""
        workflow_id = f"complexflow{int(time.time())}"
        payload = {
            "id": workflow_id,
            "name": "Complex Workflow",
            "description": "Workflow with nodes and edges",
            "version": "1.0",
            "nodes": [
                {
                    "id": "node1",
                    "name": "Start Node",
                    "type": "INPUT",
                    "config": {},
                    "position": {"x": 0, "y": 0}
                },
                {
                    "id": "node2",
                    "name": "End Node",
                    "type": "OUTPUT",
                    "config": {},
                    "position": {"x": 100, "y": 0}
                }
            ],
            "edges": [
                {
                    "id": "edge1",
                    "source_node_id": "node1",
                    "target_node_id": "node2",
                    "edge_type": "DATA"
                }
            ]
        }

        response = requests.post(
            f"{BASE_URL}/api/workflows/",
            json=payload,
            timeout=10
        )

        assert response.status_code == 201, f"Expected 201, got {response.status_code}: {response.text}"

    def test_api_home_endpoint(self, wait_for_app):
        """Test the home endpoint returns API info."""
        response = requests.get(f"{BASE_URL}/", timeout=10)

        assert response.status_code == 200
        data = response.json()
        assert "name" in data
        assert "endpoints" in data
