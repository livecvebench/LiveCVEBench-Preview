#!/bin/bash
set -e

cd /app/sftpgo
git apply --whitespace=nowarn /tests/test.patch
go test -timeout 30s -run ^TestEventManagerCommandsInitialization$ github.com/drakkan/sftpgo/v2/internal/common
go test -timeout 120s -v -run '^(TestEventRuleEmailField|TestMaxConnections|TestEventRulePreDownloadUpload|TestHiddenRoot|TestNonLocalCrossRename|TestMaxSessionsSameConnection|TestMultiStepBuiltinKeyboardAuth|TestResolvePathError|TestBackupAsAttachment|TestRemoveAll|TestLoginAccessTime|TestEventRule|TestEventActionCommandEnvVars|TestHiddenPatternFilter|TestProxyProtocolVersion|TestStartupHook|TestQuotaRenameInsideSameVirtualFolder|TestServerVersion|TestEventRuleProviderEvents|TestCheckParentDirs|TestSetStat|TestRootDirVirtualFolder|TestCopyAndRemoveSSHCommands|TestConnectionStatus|TestEventActionCompressQuotaFolder|TestRelativeSymlinks|TestParseAllowedIPAndRanges|TestInitializationClosedProvider|TestRateLimitersIntegration|TestSSHConnections|TestSplittedRenamePerms|TestQuotaRenameFromVirtualFolder|TestQuotaScans|TestProxyProtocol|TestEventActionCompressErrors|TestIPList|TestSetProtocol|TestUploadEventRule|TestEventRuleFirstUploadDownloadActions|TestQuotaRenameBetweenVirtualFolder|TestFsActionCopy|TestProxyPolicy|TestEventRuleRenameEvent|TestMaxConnectionPerHost|TestVirtualFoldersLink|TestConnections|TestCheckFsAfterUpdate|TestCrossFoldersCopy|TestAllowList|TestCachedFs|TestGetQuotaError|TestGetFsError|TestPerUserTransferLimits|TestEventActionCompress|TestQuotaRenameOverwrite|TestTransferQuotaLimits|TestVirtualFoldersQuotaValues|TestQuotaTrackDisabled|TestEventFsActionsGroupFilters|TestEventRulePreDelete|TestAtomicUpload|TestRenameSymlink|TestChtimesOpenHandle|TestSyncUploadAction|TestEventActionsRetentionReports|TestEventActionHTTPMultipart|TestHideConfidentialData|TestPostDisconnectHook|TestCopyAndRemovePermissions|TestPermissionErrors|TestBuiltinKeyboardInteractiveAuthentication|TestEventRuleRotateLog|TestEventRuleIPBlocked|TestRenameDir|TestVirtualFoldersQuotaRenameOverwrite|TestNonLocalCrossRenameNonLocalBaseUser|TestFolderCopy|TestUpdateTransferTimestamps|TestCryptFsStat|TestEventRuleCertificate|TestConnectionRoles|TestPostConnectHook|TestWaitForConnections|TestCrossFolderRename|TestDbDefenderErrors|TestEventRuleInactivityCheck|TestSplittedDeletePerms|TestIdleConnections|TestUserPerms|TestQuotaScansRole|TestSFTPLoopError|TestUserRecentActivity|TestInitializationProxyErrors|TestPasswordCaching|TestCloseConnection|TestEventActionCompressQuotaErrors|TestCryptoConvertFileInfo|TestEventActionEmailAttachments|TestVfsSameResource|TestDelayedQuotaUpdater|TestEventRulePasswordExpiration|TestTruncateQuotaLimits|TestUserPasswordHashing|TestUserMaxSessions|TestQuotaRenameToVirtualFolder|TestALPNProtocols|TestSQLPlaceholderLimits|TestCryptFsUserUploadErrorOverwrite|TestFileNotAllowedErrors|TestHTTPFs|TestEventRuleStatues|TestCleanPath|TestDirs|TestEventRuleIDPLogin|TestEventRuleFsActions|TestGetTLSVersion|TestSwapConnection)$' github.com/drakkan/sftpgo/v2/internal/common
