#!/bin/bash
set -e

# Fix SQL injection vulnerability in hotelList.php by sanitizing user inputs
# This script adds addslashes() to escape special characters in user-supplied parameters

FILE="/var/www/html/controller/api/hotelList.php"

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo "Error: File $FILE not found"
    exit 1
fi

# Create backup
cp "$FILE" "${FILE}.bak"

# Sanitize subjectId - escape special characters
sed -i "s/self\.\$this->subjectId = \$_REQUEST\[\"subjectId\"\];/self.\$this->subjectId = addslashes(\$_REQUEST[\"subjectId\"]);/" "$FILE"

# Sanitize cityName - escape special characters
sed -i "s/self\.\$this->cityName = \$_REQUEST\[\"cityName\"\];/self.\$this->cityName = addslashes(\$_REQUEST[\"cityName\"]);/" "$FILE"

# Sanitize type - escape special characters
sed -i "s/self\.\$this->type = \$_REQUEST\[\"type\"\];/self.\$this->type = addslashes(\$_REQUEST[\"type\"]);/" "$FILE"

# Sanitize pickedHotelName - escape special characters
sed -i "s/self\.\$this->pickedHotelName = \$_REQUEST\[\"pickedHotelName\"\];/self.\$this->pickedHotelName = addslashes(\$_REQUEST[\"pickedHotelName\"]);/" "$FILE"

# Sanitize pickedStar - escape special characters
sed -i "s/self\.\$this->pickedStar = \$_REQUEST\[\"pickedStar\"\];/self.\$this->pickedStar = addslashes(\$_REQUEST[\"pickedStar\"]);/" "$FILE"

# Verify the changes were applied
echo "Verifying fix was applied..."

if grep -q "addslashes(\$_REQUEST\[\"subjectId\"\])" "$FILE" && \
   grep -q "addslashes(\$_REQUEST\[\"cityName\"\])" "$FILE" && \
   grep -q "addslashes(\$_REQUEST\[\"type\"\])" "$FILE" && \
   grep -q "addslashes(\$_REQUEST\[\"pickedHotelName\"\])" "$FILE" && \
   grep -q "addslashes(\$_REQUEST\[\"pickedStar\"\])" "$FILE"; then
    echo "Fix successfully applied to $FILE"
else
    echo "Warning: Some fixes may not have been applied correctly"
    echo "Checking current state of file..."
    grep -n "self\.\$this->" "$FILE" | head -20
fi

echo "Fix applied successfully"
