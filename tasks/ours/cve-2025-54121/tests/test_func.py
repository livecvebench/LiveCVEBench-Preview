"""
Functional tests for file upload handling.

These tests verify that the basic file upload functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""

import pytest
from io import BytesIO

from starlette.applications import Starlette
from starlette.requests import Request
from starlette.responses import JSONResponse
from starlette.routing import Route
from starlette.testclient import TestClient


# Test application that handles file uploads
async def upload_handler(request: Request):
    """Handler that accepts file uploads and returns file metadata."""
    form = await request.form()
    result = {}
    for key, value in form.items():
        if hasattr(value, 'read'):
            content = await value.read()
            result[key] = {
                "filename": value.filename,
                "size": len(content),
                "content_type": value.content_type
            }
        else:
            result[key] = {"value": value}
    await request.close()
    return JSONResponse(result)


async def multi_upload_handler(request: Request):
    """Handler that accepts multiple files."""
    form = await request.form()
    files = []
    fields = []
    for key, value in form.multi_items():
        if hasattr(value, 'read'):
            content = await value.read()
            files.append({
                "key": key,
                "filename": value.filename,
                "size": len(content)
            })
        else:
            fields.append({"key": key, "value": value})
    await request.close()
    return JSONResponse({"files": files, "fields": fields})


app = Starlette(routes=[
    Route("/upload", upload_handler, methods=["POST"]),
    Route("/multi", multi_upload_handler, methods=["POST"]),
])
client = TestClient(app)


class TestSmallFileUploads:
    """Tests for files smaller than the spool threshold (1MB)."""

    def test_small_file_upload(self):
        """Test uploading a small file (1KB)."""
        small_file = BytesIO(b"x" * 1024)  # 1KB
        response = client.post(
            "/upload",
            files={"file": ("small.txt", small_file, "text/plain")}
        )
        assert response.status_code == 200
        data = response.json()
        assert "file" in data
        assert data["file"]["size"] == 1024
        assert data["file"]["filename"] == "small.txt"

    def test_empty_file_upload(self):
        """Test uploading an empty file."""
        empty_file = BytesIO(b"")
        response = client.post(
            "/upload",
            files={"file": ("empty.txt", empty_file, "text/plain")}
        )
        assert response.status_code == 200
        data = response.json()
        assert data["file"]["size"] == 0

    def test_small_file_near_threshold(self):
        """Test file just under the 1MB threshold."""
        # Just under 1MB to stay in memory
        near_threshold = BytesIO(b"x" * (1024 * 1024 - 1000))
        response = client.post(
            "/upload",
            files={"file": ("near_threshold.bin", near_threshold)}
        )
        assert response.status_code == 200
        data = response.json()
        assert data["file"]["size"] == 1024 * 1024 - 1000


class TestLargeFileUploads:
    """Tests for files larger than the spool threshold (1MB)."""

    def test_large_file_upload(self):
        """Test uploading a file larger than spool threshold."""
        # 1MB + 1KB to trigger rollover
        large_file = BytesIO(b"y" * (1024 * 1024 + 1024))
        response = client.post(
            "/upload",
            files={"file": ("large.bin", large_file)}
        )
        assert response.status_code == 200
        data = response.json()
        assert data["file"]["size"] == 1024 * 1024 + 1024
        assert data["file"]["filename"] == "large.bin"

    def test_very_large_file_upload(self):
        """Test uploading a much larger file (5MB)."""
        very_large = BytesIO(b"z" * (5 * 1024 * 1024))
        response = client.post(
            "/upload",
            files={"file": ("very_large.bin", very_large)}
        )
        assert response.status_code == 200
        data = response.json()
        assert data["file"]["size"] == 5 * 1024 * 1024

    def test_file_exactly_at_threshold(self):
        """Test file exactly at the 1MB threshold."""
        at_threshold = BytesIO(b"a" * (1024 * 1024))
        response = client.post(
            "/upload",
            files={"file": ("exact_threshold.bin", at_threshold)}
        )
        assert response.status_code == 200
        data = response.json()
        assert data["file"]["size"] == 1024 * 1024


class TestMultipleFileUploads:
    """Tests for uploading multiple files."""

    def test_multiple_small_files(self):
        """Test uploading multiple small files."""
        files = [
            ("file1", ("a.txt", BytesIO(b"aaa"), "text/plain")),
            ("file2", ("b.txt", BytesIO(b"bbb"), "text/plain")),
            ("file3", ("c.txt", BytesIO(b"ccc"), "text/plain")),
        ]
        response = client.post("/multi", files=files)
        assert response.status_code == 200
        data = response.json()
        assert len(data["files"]) == 3

    def test_mixed_size_files(self):
        """Test uploading a mix of small and large files."""
        files = [
            ("small", ("small.txt", BytesIO(b"x" * 1024), "text/plain")),
            ("large", ("large.bin", BytesIO(b"y" * (1024 * 1024 + 100)), "application/octet-stream")),
        ]
        response = client.post("/multi", files=files)
        assert response.status_code == 200
        data = response.json()
        assert len(data["files"]) == 2

        sizes = {f["key"]: f["size"] for f in data["files"]}
        assert sizes["small"] == 1024
        assert sizes["large"] == 1024 * 1024 + 100

    def test_files_with_form_fields(self):
        """Test uploading files along with form fields."""
        response = client.post(
            "/multi",
            files=[("upload", ("doc.pdf", BytesIO(b"PDF content"), "application/pdf"))],
            data={"title": "My Document", "category": "reports"}
        )
        assert response.status_code == 200
        data = response.json()
        assert len(data["files"]) == 1
        assert len(data["fields"]) == 2

        field_values = {f["key"]: f["value"] for f in data["fields"]}
        assert field_values["title"] == "My Document"
        assert field_values["category"] == "reports"


class TestFileContentIntegrity:
    """Tests to verify file content is preserved correctly."""

    def test_binary_content_preserved(self):
        """Test that binary content is preserved correctly."""
        # Create binary content with all byte values
        binary_content = bytes(range(256)) * 100  # 25.6KB
        response = client.post(
            "/upload",
            files={"file": ("binary.bin", BytesIO(binary_content))}
        )
        assert response.status_code == 200
        assert response.json()["file"]["size"] == len(binary_content)

    def test_large_binary_content_preserved(self):
        """Test that large binary content (triggering rollover) is preserved."""
        # 2MB of varied binary content
        binary_content = bytes(range(256)) * (2 * 1024 * 1024 // 256)
        response = client.post(
            "/upload",
            files={"file": ("large_binary.bin", BytesIO(binary_content))}
        )
        assert response.status_code == 200
        assert response.json()["file"]["size"] == len(binary_content)
