#!/bin/bash
# Test runner script that executes tests inside the Docker container
# This solves the networking issue by running tests where Cacti is accessible

set -e

CONTAINER_NAME="cacti-cve-2025-24367-app"

echo "Running tests inside Docker container..."

# Ensure container is running
if ! docker ps | grep -q "$CONTAINER_NAME"; then
    echo "Error: Container $CONTAINER_NAME is not running"
    exit 1
fi

# Copy current tests to container (in case they were updated)
docker cp tests/. "$CONTAINER_NAME":/tests/ 2>/dev/null || true

# Run tests inside container with correct CACTI_URL
docker exec "$CONTAINER_NAME" bash -c "
    cd /tests
    export CACTI_URL=http://localhost/cacti
    echo 'Running tests with CACTI_URL=\$CACTI_URL'
    python3 -m pytest \"\$@\"
" -- "$@"