"""
Functionality tests for File Browser application.
These tests verify that the application works correctly in both vulnerable and fixed states.
"""
import pytest
import requests
import time

BASE_URL = "http://localhost:80"
ADMIN_USER = "admin"
ADMIN_PASS = "admin"
TEST_USER = "testuser"
TEST_PASS = "testpass"


def wait_for_service(url, timeout=60):
    """Wait for the service to become available."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(url, timeout=5)
            if response.status_code in [200, 401, 403]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


class TestApplicationStartup:
    """Test that File Browser starts and is accessible."""

    def test_application_is_running(self):
        """Verify File Browser is running and accessible."""
        assert wait_for_service(BASE_URL), "File Browser service did not start within timeout"
        response = requests.get(BASE_URL, timeout=10)
        assert response.status_code == 200, f"Unexpected status code: {response.status_code}"

    def test_api_endpoints_available(self):
        """Verify API endpoints are responding."""
        response = requests.get(f"{BASE_URL}/api/health", timeout=10)
        # Health endpoint may return 200 or the endpoint may not exist
        # In either case, we're testing connectivity
        assert response.status_code in [200, 404], f"API not responding properly: {response.status_code}"


class TestAuthentication:
    """Test authentication functionality."""

    def test_admin_login(self):
        """Verify admin user can authenticate."""
        response = requests.post(
            f"{BASE_URL}/api/login",
            json={"username": ADMIN_USER, "password": ADMIN_PASS},
            timeout=10
        )
        assert response.status_code == 200, f"Admin login failed: {response.status_code}"
        # File Browser v2.32.0 returns raw JWT token as text/plain, not JSON
        token = response.text.strip()
        has_token = len(token) > 0 and token.startswith("eyJ")
        assert has_token, "No authentication token received"

    def test_testuser_login(self):
        """Verify test user can authenticate."""
        response = requests.post(
            f"{BASE_URL}/api/login",
            json={"username": TEST_USER, "password": TEST_PASS},
            timeout=10
        )
        assert response.status_code == 200, f"Test user login failed: {response.status_code}"

    def test_invalid_login_rejected(self):
        """Verify invalid credentials are rejected."""
        response = requests.post(
            f"{BASE_URL}/api/login",
            json={"username": "invalid", "password": "invalid"},
            timeout=10
        )
        assert response.status_code in [401, 403], f"Invalid login should be rejected: {response.status_code}"


class TestFileBrowsing:
    """Test file browsing functionality."""

    @pytest.fixture
    def authenticated_session(self):
        """Create an authenticated session."""
        session = requests.Session()
        response = session.post(
            f"{BASE_URL}/api/login",
            json={"username": ADMIN_USER, "password": ADMIN_PASS},
            timeout=10
        )
        assert response.status_code == 200, "Authentication failed"
        # File Browser v2.32.0 returns raw JWT token as text/plain
        token = response.text.strip()
        if token and token.startswith("eyJ"):
            session.headers.update({"X-Auth": token})
        return session

    def test_browse_root_directory(self, authenticated_session):
        """Verify file browsing works."""
        response = authenticated_session.get(f"{BASE_URL}/api/resources/", timeout=10)
        assert response.status_code == 200, f"Failed to browse root: {response.status_code}"

    def test_list_directory_contents(self, authenticated_session):
        """Verify directory listing returns valid data."""
        response = authenticated_session.get(f"{BASE_URL}/api/resources/", timeout=10)
        assert response.status_code == 200
        data = response.json()
        # Should have some structure indicating it's a directory listing
        assert "items" in data or "isDir" in data, "Invalid directory listing response"


class TestUserPermissions:
    """Test user permission system."""

    @pytest.fixture
    def admin_session(self):
        """Create an admin authenticated session."""
        session = requests.Session()
        response = session.post(
            f"{BASE_URL}/api/login",
            json={"username": ADMIN_USER, "password": ADMIN_PASS},
            timeout=10
        )
        # File Browser v2.32.0 returns raw JWT token as text/plain
        token = response.text.strip()
        if token and token.startswith("eyJ"):
            session.headers.update({"X-Auth": token})
        return session

    def test_get_user_info(self, admin_session):
        """Verify user info retrieval works."""
        response = admin_session.get(f"{BASE_URL}/api/users", timeout=10)
        # Should be able to list users or get 200
        assert response.status_code in [200, 403], f"Unexpected status: {response.status_code}"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
