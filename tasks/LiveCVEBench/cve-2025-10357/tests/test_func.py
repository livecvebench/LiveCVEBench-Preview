"""
Functional tests for Simple SEO WordPress Plugin.

These tests verify that the plugin's core SEO functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import re
import time
from urllib.parse import urljoin

# WordPress configuration
BASE_URL = "http://localhost"
ADMIN_USER = "admin"
ADMIN_PASS = "admin"
CONTRIBUTOR_USER = "contributor"
CONTRIBUTOR_PASS = "contributor"


class WordPressSession:
    """Helper class to manage WordPress authenticated sessions."""

    def __init__(self, base_url):
        self.base_url = base_url
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

    def login(self, username, password):
        """Log in to WordPress admin."""
        login_url = urljoin(self.base_url, '/wp-login.php')

        # Get the login page first to get any cookies
        self.session.get(login_url)

        login_data = {
            'log': username,
            'pwd': password,
            'wp-submit': 'Log In',
            'redirect_to': urljoin(self.base_url, '/wp-admin/'),
            'testcookie': '1'
        }

        response = self.session.post(login_url, data=login_data, allow_redirects=True)

        # Check if login was successful by looking for dashboard or admin elements
        if 'wp-admin' in response.url or 'Dashboard' in response.text or 'dashboard' in response.text.lower():
            return True
        return False

    def get(self, path, **kwargs):
        """Make authenticated GET request."""
        url = urljoin(self.base_url, path)
        return self.session.get(url, **kwargs)

    def post(self, path, **kwargs):
        """Make authenticated POST request."""
        url = urljoin(self.base_url, path)
        return self.session.post(url, **kwargs)

    def get_nonce(self, page_content, nonce_name='_wpnonce'):
        """Extract nonce from page content."""
        # Try various nonce patterns
        patterns = [
            rf'name="{nonce_name}"\s+value="([a-f0-9]+)"',
            rf'name="{nonce_name}" value="([a-f0-9]+)"',
            rf'value="([a-f0-9]+)"\s+name="{nonce_name}"',
            rf'{nonce_name}["\']:\s*["\']([a-f0-9]+)["\']',
        ]

        for pattern in patterns:
            match = re.search(pattern, page_content)
            if match:
                return match.group(1)
        return None


def wait_for_wordpress(timeout=120):
    """Wait for WordPress to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{BASE_URL}/wp-login.php", timeout=5)
            if response.status_code == 200:
                return True
        except requests.RequestException:
            pass
        time.sleep(2)
    return False


@pytest.fixture(scope="module")
def wp_ready():
    """Ensure WordPress is ready before running tests."""
    assert wait_for_wordpress(), "WordPress did not become ready in time"
    return True


@pytest.fixture(scope="module")
def admin_session(wp_ready):
    """Create an authenticated admin session."""
    session = WordPressSession(BASE_URL)
    assert session.login(ADMIN_USER, ADMIN_PASS), "Failed to login as admin"
    return session


@pytest.fixture(scope="module")
def contributor_session(wp_ready):
    """Create an authenticated contributor session."""
    session = WordPressSession(BASE_URL)
    assert session.login(CONTRIBUTOR_USER, CONTRIBUTOR_PASS), "Failed to login as contributor"
    return session


class TestPluginActive:
    """Test that the Simple SEO plugin is active and functional."""

    def test_plugin_is_active(self, admin_session):
        """Verify Simple SEO plugin is activated."""
        response = admin_session.get('/wp-admin/plugins.php')
        assert response.status_code == 200

        # Check for plugin presence - look for the plugin slug or name
        content = response.text.lower()
        assert 'simple-seo' in content or 'cds-simple-seo' in content or 'simpleseo' in content, \
            "Simple SEO plugin should be listed in plugins page"

    def test_seo_metabox_exists_on_post_edit(self, admin_session):
        """Verify Simple SEO meta box appears on post edit page."""
        # First create a new post to get a valid post ID
        response = admin_session.get('/wp-admin/post-new.php')
        assert response.status_code == 200

        # Check for Simple SEO meta box elements
        # The plugin creates a metabox with tabs including SEO, Keywords, Robots, etc.
        content = response.text

        # Look for plugin-specific elements
        has_metabox = any([
            'cds-seo-metabox' in content,
            'cds-seo-tab' in content,
            'sseo_meta_title' in content,
            'Simple SEO' in content,
            'cds-seo-preview' in content,
        ])

        assert has_metabox, "Simple SEO meta box should be present on post edit page"


class TestSEOFieldsSaveAndRetrieve:
    """Test that SEO fields can be saved and retrieved correctly."""

    def test_save_and_retrieve_seo_title(self, contributor_session):
        """Test saving and retrieving a normal SEO title."""
        # Get new post page
        response = contributor_session.get('/wp-admin/post-new.php')
        assert response.status_code == 200

        content = response.text

        # Extract post ID from the new post page
        post_id_match = re.search(r'post=(\d+)', content) or re.search(r'post_ID["\']?\s*(?:value=|:)\s*["\']?(\d+)', content)

        # Extract nonces
        wpnonce = contributor_session.get_nonce(content, '_wpnonce')
        sseo_nonce = contributor_session.get_nonce(content, 'sseo_nonce')

        # Create a post with a normal SEO title
        test_title = "Test Post for SEO Functionality"
        seo_title = "My Custom SEO Title for Testing"

        post_data = {
            'post_title': test_title,
            'post_content': 'This is test content for functional testing.',
            'post_status': 'draft',
            'sseo_meta_title': seo_title,
            'sseo_meta_description': 'Test SEO description',
            'sseo_nonce': sseo_nonce or '',
            '_wpnonce': wpnonce or '',
            'action': 'editpost',
            'post_type': 'post',
        }

        if post_id_match:
            post_data['post_ID'] = post_id_match.group(1)

        # Submit the post
        response = contributor_session.post('/wp-admin/post.php', data=post_data, allow_redirects=True)

        # Verify the post was saved (should redirect or show success)
        assert response.status_code == 200

    def test_normal_text_displays_correctly(self, admin_session):
        """Test that normal text without special characters displays correctly."""
        # Get new post page and verify form fields exist
        response = admin_session.get('/wp-admin/post-new.php')
        assert response.status_code == 200

        content = response.text

        # Check that SEO title field exists and can accept input
        assert 'sseo_meta_title' in content, "SEO title field should exist"
        assert 'sseo_meta_description' in content, "SEO description field should exist"


class TestSEOMetaBoxTabs:
    """Test that all SEO meta box tabs are present and functional."""

    def test_seo_tab_present(self, admin_session):
        """Verify SEO tab is present."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        # Look for SEO tab label
        assert 'cds-seo-tab1' in content or '>SEO<' in content, \
            "SEO tab should be present"

    def test_keywords_tab_present(self, admin_session):
        """Verify Keywords tab is present."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        has_keywords = 'Keywords' in content or 'sseo_meta_keywords' in content
        assert has_keywords, "Keywords tab or field should be present"

    def test_robots_tab_present(self, admin_session):
        """Verify Robots tab is present."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        has_robots = 'Robots' in content or 'sseo_robot_noindex' in content or 'sseo_robot_nofollow' in content
        assert has_robots, "Robots tab or fields should be present"

    def test_facebook_tab_present(self, admin_session):
        """Verify Facebook tab is present."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        has_facebook = 'Facebook' in content or 'sseo_fb_title' in content
        assert has_facebook, "Facebook tab or fields should be present"

    def test_twitter_tab_present(self, admin_session):
        """Verify Twitter tab is present."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        has_twitter = 'Twitter' in content or 'sseo_tw_title' in content
        assert has_twitter, "Twitter tab or fields should be present"

    def test_advanced_tab_present(self, admin_session):
        """Verify Advanced tab is present."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        has_advanced = 'Advanced' in content or 'sseo_canonical_url' in content
        assert has_advanced, "Advanced tab or Canonical URL field should be present"


class TestPreviewSection:
    """Test that the SEO preview section works correctly."""

    def test_preview_snippet_exists(self, admin_session):
        """Verify preview snippet area exists."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        has_preview = any([
            'sseo_snippet' in content,
            'preview_snippet' in content,
            'sseo_snippet_title' in content,
            'Preview' in content,
        ])

        assert has_preview, "Preview snippet section should exist"

    def test_character_count_display(self, admin_session):
        """Verify character count displays exist."""
        response = admin_session.get('/wp-admin/post-new.php')
        content = response.text

        # The plugin shows character counts for title and description
        has_counts = 'sseo_title_count' in content or 'sseo_desc_count' in content or 'characters' in content.lower()

        assert has_counts, "Character count displays should exist"


class TestWordPressIntegration:
    """Test WordPress core integration with the plugin."""

    def test_can_create_draft_post(self, contributor_session):
        """Test that contributor can create a draft post."""
        response = contributor_session.get('/wp-admin/post-new.php')
        assert response.status_code == 200
        assert 'post-new.php' in response.url or 'post.php' in response.url

    def test_admin_can_view_posts(self, admin_session):
        """Test that admin can view all posts."""
        response = admin_session.get('/wp-admin/edit.php')
        assert response.status_code == 200

        # Should see the posts list
        assert 'edit.php' in response.url or 'Posts' in response.text
