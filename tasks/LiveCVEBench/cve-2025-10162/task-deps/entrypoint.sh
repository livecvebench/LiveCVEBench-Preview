#!/bin/bash
# Custom entrypoint that wraps WordPress entrypoint and adds setup

# Function to wait for database
wait_for_db() {
    echo "Waiting for database connection..."
    local max_wait=120
    local waited=0
    while ! mysqladmin ping -h"${WORDPRESS_DB_HOST:-db}" -u"${WORDPRESS_DB_USER:-wordpress}" -p"${WORDPRESS_DB_PASSWORD:-wordpress}" --silent 2>/dev/null; do
        if [ $waited -ge $max_wait ]; then
            echo "ERROR: Database connection timeout after ${max_wait}s"
            return 1
        fi
        echo "Database not ready, waiting... (${waited}s/${max_wait}s)"
        sleep 2
        waited=$((waited + 2))
    done
    echo "Database is ready!"
    return 0
}

# Function to setup WordPress
setup_wordpress() {
    echo "=== Starting WordPress setup ===" | tee /tmp/wp_setup.log
    cd /var/www/html

    # Wait for wp-config.php to be created by WordPress entrypoint
    local max_wait=60
    local waited=0
    while [ ! -f /var/www/html/wp-config.php ] && [ $waited -lt $max_wait ]; do
        echo "Waiting for WordPress files to be ready... (${waited}s/${max_wait}s)" | tee -a /tmp/wp_setup.log
        sleep 2
        waited=$((waited + 2))
    done

    if [ ! -f /var/www/html/wp-config.php ]; then
        echo "ERROR: wp-config.php not found after ${max_wait}s" | tee -a /tmp/wp_setup.log
        return 1
    fi

    echo "wp-config.php found, checking WordPress installation..." | tee -a /tmp/wp_setup.log

    # Wait for database to be truly ready for WordPress operations
    wait_for_db 2>&1 | tee -a /tmp/wp_setup.log || return 1

    # Check if WordPress is installed - wait a bit for Apache to be ready
    sleep 3

    if ! wp core is-installed --allow-root 2>/dev/null; then
        echo "Installing WordPress..." | tee -a /tmp/wp_setup.log
        if ! wp core install \
            --url="http://localhost" \
            --title="CVE-2025-10162 Test Site" \
            --admin_user="admin" \
            --admin_password="admin123" \
            --admin_email="admin@example.com" \
            --skip-email \
            --allow-root 2>&1 | tee -a /tmp/wp_setup.log; then
            echo "ERROR: WordPress installation failed" | tee -a /tmp/wp_setup.log
            return 1
        fi
        echo "WordPress installed successfully!" | tee -a /tmp/wp_setup.log
    else
        echo "WordPress already installed." | tee -a /tmp/wp_setup.log
    fi

    # Set up permalinks for REST API
    echo "Configuring permalinks..." | tee -a /tmp/wp_setup.log
    wp rewrite structure '/%postname%/' --allow-root 2>&1 | tee -a /tmp/wp_setup.log || true
    wp rewrite flush --hard --allow-root 2>&1 | tee -a /tmp/wp_setup.log || true

    # Ensure .htaccess exists with proper rules
    if [ ! -f /var/www/html/.htaccess ]; then
        echo "Creating .htaccess file..." | tee -a /tmp/wp_setup.log
        cat > /var/www/html/.htaccess << 'HTACCESS'
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress
HTACCESS
        chown www-data:www-data /var/www/html/.htaccess
    fi

    # Activate WooCommerce first (required by OrderConvo)
    if wp plugin is-installed woocommerce --allow-root 2>/dev/null; then
        echo "Activating WooCommerce..." | tee -a /tmp/wp_setup.log
        wp plugin activate woocommerce --allow-root 2>&1 | tee -a /tmp/wp_setup.log || echo "WooCommerce activation skipped"

        # Create WooCommerce pages
        echo "Setting up WooCommerce..." | tee -a /tmp/wp_setup.log
        wp wc tool run install_pages --allow-root 2>&1 | tee -a /tmp/wp_setup.log || true
    else
        echo "WARNING: WooCommerce not installed" | tee -a /tmp/wp_setup.log
    fi

    # Activate the OrderConvo plugin
    if wp plugin is-installed admin-and-client-message-after-order-for-woocommerce --allow-root 2>/dev/null; then
        echo "Activating OrderConvo plugin..." | tee -a /tmp/wp_setup.log
        wp plugin activate admin-and-client-message-after-order-for-woocommerce --allow-root 2>&1 | tee -a /tmp/wp_setup.log || echo "OrderConvo activation skipped"
    else
        echo "WARNING: OrderConvo plugin not installed" | tee -a /tmp/wp_setup.log
    fi

    # Ensure uploads directory exists and has proper permissions
    mkdir -p /var/www/html/wp-content/uploads/wooconvo
    chown -R www-data:www-data /var/www/html/wp-content/uploads
    chmod -R 755 /var/www/html/wp-content/uploads

    echo "=== WordPress setup completed successfully ===" | tee -a /tmp/wp_setup.log
    return 0
}

# Start background setup process FIRST (before Apache takes over)
# This will run in the background while Apache starts
(
    # Wait a bit for WordPress entrypoint to create files
    sleep 8
    setup_wordpress
) &

# Now run the original WordPress entrypoint (which will exec into Apache)
# This will NOT return - it becomes Apache
exec /usr/local/bin/docker-entrypoint.sh "$@"
