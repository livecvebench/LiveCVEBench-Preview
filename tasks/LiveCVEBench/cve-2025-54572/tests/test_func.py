#!/usr/bin/env python3
"""
Functional tests for ruby-saml message processing.
These tests verify that normal SAML operations work correctly.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import pytest
import os

RUBY_SCRIPT_DIR = "/tests"
APP_DIR = "/app"


def run_ruby_script(script_content: str, timeout: int = 30) -> tuple[str, str, int]:
    """Execute Ruby code and return stdout, stderr, and return code."""
    result = subprocess.run(
        ["ruby", "-I", f"{APP_DIR}/lib", "-e", script_content],
        capture_output=True,
        text=True,
        timeout=timeout,
        cwd=APP_DIR
    )
    return result.stdout, result.stderr, result.returncode


class TestBasicDecoding:
    """Test that basic SAML decoding functionality works."""

    def test_decode_valid_base64_saml(self):
        """Verify that valid Base64-encoded SAML messages are decoded correctly."""
        script = '''
require 'onelogin/ruby-saml'
require 'base64'

# Create a simple SAML-like XML content
xml_content = '<?xml version="1.0"?><Response>test</Response>'
encoded = Base64.strict_encode64(xml_content)

# Create a SamlMessage instance and test decoding
saml_msg = OneLogin::RubySaml::SamlMessage.new
decoded = saml_msg.send(:decode_raw_saml, encoded)

# Verify the content is decoded correctly
if decoded == xml_content
  puts "SUCCESS: Decoding works correctly"
  exit 0
else
  puts "FAILURE: Decoded content does not match"
  puts "Expected: #{xml_content}"
  puts "Got: #{decoded}"
  exit 1
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout

    def test_decode_base64_with_newlines(self):
        """Verify that Base64 content with newlines is handled correctly."""
        script = '''
require 'onelogin/ruby-saml'
require 'base64'

# Create Base64 with newlines (as produced by standard Base64.encode64)
xml_content = '<?xml version="1.0"?><Response>test data here</Response>'
encoded_with_newlines = Base64.encode64(xml_content)  # Contains newlines

saml_msg = OneLogin::RubySaml::SamlMessage.new
decoded = saml_msg.send(:decode_raw_saml, encoded_with_newlines)

if decoded.include?("Response") && decoded.include?("test data here")
  puts "SUCCESS: Base64 with newlines decoded correctly"
  exit 0
else
  puts "FAILURE: Decoding with newlines failed"
  exit 1
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout

    def test_non_base64_passthrough(self):
        """Verify that non-Base64 content passes through unchanged."""
        script = '''
require 'onelogin/ruby-saml'

# Plain XML (not Base64 encoded)
xml_content = '<?xml version="1.0"?><Response>plain xml</Response>'

saml_msg = OneLogin::RubySaml::SamlMessage.new
result = saml_msg.send(:decode_raw_saml, xml_content)

if result == xml_content
  puts "SUCCESS: Non-Base64 content passed through correctly"
  exit 0
else
  puts "FAILURE: Non-Base64 content was modified"
  exit 1
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout


class TestSizeLimitEnforcement:
    """Test that message size limits are enforced."""

    def test_size_limit_rejects_large_encoded_message(self):
        """Verify that messages exceeding message_max_bytesize are rejected."""
        script = '''
require 'onelogin/ruby-saml'

settings = OneLogin::RubySaml::Settings.new
settings.message_max_bytesize = 1000  # Set a small limit

# Create a message larger than the limit (valid Base64 chars)
large_message = "A" * 2000

saml_msg = OneLogin::RubySaml::SamlMessage.new

begin
  saml_msg.send(:decode_raw_saml, large_message, settings)
  puts "FAILURE: Large message was not rejected"
  exit 1
rescue OneLogin::RubySaml::ValidationError => e
  if e.message.include?("exceeds") && e.message.include?("bytes")
    puts "SUCCESS: Large message correctly rejected with size error"
    exit 0
  else
    puts "FAILURE: Wrong error message: #{e.message}"
    exit 1
  end
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout

    def test_size_limit_allows_small_message(self):
        """Verify that messages under the limit are processed."""
        script = '''
require 'onelogin/ruby-saml'
require 'base64'

settings = OneLogin::RubySaml::Settings.new
settings.message_max_bytesize = 10000

# Create a valid Base64 message well under the limit
xml_content = '<?xml version="1.0"?><Response>small</Response>'
encoded = Base64.strict_encode64(xml_content)

saml_msg = OneLogin::RubySaml::SamlMessage.new

begin
  result = saml_msg.send(:decode_raw_saml, encoded, settings)
  if result == xml_content
    puts "SUCCESS: Small message processed correctly"
    exit 0
  else
    puts "FAILURE: Message content was corrupted"
    exit 1
  end
rescue => e
  puts "FAILURE: Unexpected error: #{e.message}"
  exit 1
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout

    def test_custom_size_limit_setting(self):
        """Verify that custom message_max_bytesize setting is respected."""
        script = '''
require 'onelogin/ruby-saml'

# Test with custom limit
custom_limit = 500
settings = OneLogin::RubySaml::Settings.new
settings.message_max_bytesize = custom_limit

# Create message slightly over custom limit
message = "A" * 600

saml_msg = OneLogin::RubySaml::SamlMessage.new

begin
  saml_msg.send(:decode_raw_saml, message, settings)
  puts "FAILURE: Message over custom limit was not rejected"
  exit 1
rescue OneLogin::RubySaml::ValidationError => e
  if e.message.include?(custom_limit.to_s)
    puts "SUCCESS: Custom size limit is enforced"
    exit 0
  else
    puts "FAILURE: Error doesn't mention custom limit"
    exit 1
  end
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout


class TestBase64Detection:
    """Test Base64 format detection."""

    def test_valid_base64_detected(self):
        """Verify that valid Base64 strings are correctly identified."""
        script = '''
require 'onelogin/ruby-saml'
require 'base64'

saml_msg = OneLogin::RubySaml::SamlMessage.new

# Test various valid Base64 strings
test_cases = [
  Base64.strict_encode64("hello world"),
  "SGVsbG8gV29ybGQ=",  # "Hello World" in Base64
  "QUJD",  # "ABC"
  "YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXo=",  # alphabet
]

all_passed = true
test_cases.each do |tc|
  result = saml_msg.send(:base64_encoded?, tc)
  unless result
    puts "FAILURE: Failed to detect valid Base64: #{tc}"
    all_passed = false
  end
end

if all_passed
  puts "SUCCESS: All valid Base64 strings detected"
  exit 0
else
  exit 1
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout

    def test_non_base64_detected(self):
        """Verify that non-Base64 strings are correctly identified."""
        script = '''
require 'onelogin/ruby-saml'

saml_msg = OneLogin::RubySaml::SamlMessage.new

# Test strings that are NOT valid Base64
test_cases = [
  '<?xml version="1.0"?>',  # XML - use single quotes
  '<Response>test</Response>',
  'not base64 at all!!!',
  'special chars: @#$%',
]

all_passed = true
test_cases.each do |tc|
  result = saml_msg.send(:base64_encoded?, tc)
  if result
    puts "FAILURE: False positive for non-Base64: #{tc}"
    all_passed = false
  end
end

if all_passed
  puts "SUCCESS: All non-Base64 strings correctly identified"
  exit 0
else
  exit 1
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout


class TestDeflateInflate:
    """Test deflate/inflate functionality for compressed SAML messages."""

    def test_deflated_base64_message(self):
        """Verify that deflated and Base64-encoded messages are handled."""
        script = '''
require 'onelogin/ruby-saml'
require 'base64'
require 'zlib'

xml_content = '<?xml version="1.0"?><Response><Data>test content</Data></Response>'

# Deflate and encode (as done in SAML HTTP-Redirect binding)
deflated = Zlib::Deflate.deflate(xml_content, 9)[2..-5]
encoded = Base64.strict_encode64(deflated)

saml_msg = OneLogin::RubySaml::SamlMessage.new
decoded = saml_msg.send(:decode_raw_saml, encoded)

if decoded == xml_content
  puts "SUCCESS: Deflated message decoded correctly"
  exit 0
else
  puts "FAILURE: Deflated message not decoded correctly"
  puts "Expected: #{xml_content}"
  puts "Got: #{decoded}"
  exit 1
end
'''
        stdout, stderr, returncode = run_ruby_script(script)
        assert returncode == 0, f"Failed: {stderr}\n{stdout}"
        assert "SUCCESS" in stdout


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
