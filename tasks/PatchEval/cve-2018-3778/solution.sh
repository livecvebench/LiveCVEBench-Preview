cat <<'EOF' > /workspace/fix.patch
diff --git a/lib/client.js b/lib/client.js
index 644589d1..75464ef7 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -242,12 +242,20 @@ Client.prototype.close = function (done) {
 
   function finish () {
     if (!that.disconnected && that.will) {
-      that.broker.publish(that.will, that, function (err) {
+      that.broker.authorizePublish(that, that.will, function (err) {
         if (!err) {
-          that.broker.persistence.delWill({
-            id: that.id,
-            brokerId: that.broker.id
-          }, nop)
+          that.broker.publish(that.will, that, done)
+        } else {
+          done()
+        }
+
+        function done (err) {
+          if (!err) {
+            that.broker.persistence.delWill({
+              id: that.id,
+              brokerId: that.broker.id
+            }, nop)
+          }
         }
       })
       that.will = null // this function might be called twice
@@ -298,4 +306,4 @@ function enqueue (packet) {
   handle(this.client, packet, this.client._nextBatch)
 }
 
-function nop () {}
+function nop () { }


EOF

cd /workspace/aedes
git apply --whitespace=nowarn  /workspace/fix.patch