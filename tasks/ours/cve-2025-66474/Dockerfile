FROM eclipse-temurin:11-jdk

WORKDIR /app

# System dependencies required for tb framework
RUN apt-get update && apt-get install -y \
    tmux \
    asciinema \
    gcc \
    g++ \
    wget \
    curl \
    git \
    patch \
    && rm -rf /var/lib/apt/lists/*

# Create directory structure
RUN mkdir -p org/xwiki/rendering/renderer/printer \
             org/xwiki/xml/html \
             lib \
             /task-deps

# Copy stub/interface files from task-deps
COPY task-deps/WikiPrinter.java org/xwiki/rendering/renderer/printer/
COPY task-deps/XMLWikiPrinter.java org/xwiki/rendering/renderer/printer/
COPY task-deps/HTMLElementSanitizer.java org/xwiki/xml/html/

# Copy vulnerable source file
COPY task-deps/XHTMLWikiPrinter_vulnerable.java org/xwiki/rendering/renderer/printer/XHTMLWikiPrinter.java

# Copy fix files to /task-deps for solution.sh
COPY task-deps/XHTMLWikiPrinter_fixed.java /task-deps/
COPY task-deps/XHTMLWikiPrinter.patch /task-deps/

# Download commons-lang3 (required for StringUtils.replaceEach)
RUN curl -L -o lib/commons-lang3-3.14.0.jar \
    https://repo1.maven.org/maven2/org/apache/commons/commons-lang3/3.14.0/commons-lang3-3.14.0.jar

# Compile all Java files
RUN javac -cp "lib/*" \
    org/xwiki/xml/html/HTMLElementSanitizer.java \
    org/xwiki/rendering/renderer/printer/WikiPrinter.java \
    org/xwiki/rendering/renderer/printer/XMLWikiPrinter.java \
    org/xwiki/rendering/renderer/printer/XHTMLWikiPrinter.java

# Keep container running (handled by docker-compose command)
# CMD ["tail", "-f", "/dev/null"]
