cat <<'EOF' > /workspace/fix.patch
diff --git a/index.js b/index.js
index 0102e84..dc1d7c5 100644
--- a/index.js
+++ b/index.js
@@ -41,8 +41,12 @@ function removeTrailingSlashes(opts) {
             path = path.slice(0, -1);
             const query = querystring.length ? '?' + querystring : '';
 
-            ctx.status = 301;
-            ctx.redirect(path + query);
+            const newURL = new URL(path + query, ctx.request.URL);
+
+            if (ctx.origin === newURL.origin) {
+                ctx.status = 301;
+                ctx.redirect(path + query);
+            }
         }
 
         if (!opts.defer) {
            

EOF

cd /workspace/koa-remove-trailing-slashes
git apply --whitespace=nowarn  /workspace/fix.patch