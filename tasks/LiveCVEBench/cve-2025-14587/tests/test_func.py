"""
Functional tests for Online Pet Shop Management System.
These tests verify that the application works correctly for normal operations.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import re

BASE_URL = "http://localhost"


class TestApplicationAvailability:
    """Test that the application and its pages are accessible."""

    def test_homepage_loads(self):
        """Test that the pet shop homepage loads."""
        response = requests.get(f"{BASE_URL}/pet1/", timeout=10)
        assert response.status_code == 200, f"Homepage failed to load: {response.status_code}"

    def test_available_page_loads(self):
        """Test that the available products page loads."""
        response = requests.get(f"{BASE_URL}/pet1/available.php", timeout=10)
        assert response.status_code == 200, f"Available page failed to load: {response.status_code}"

    def test_availableframe_page_loads(self):
        """Test that the iframe content page loads."""
        response = requests.get(f"{BASE_URL}/pet1/availableframe.php", timeout=10)
        assert response.status_code == 200, f"Availableframe page failed to load: {response.status_code}"

    def test_products_displayed(self):
        """Test that products are displayed on the available products page."""
        response = requests.get(f"{BASE_URL}/pet1/availableframe.php", timeout=10)
        assert response.status_code == 200
        # Check for product-related content (table structure or product names from db)
        content = response.text.lower()
        assert "table" in content or "product" in content or "cart" in content or "order" in content, \
            "Product listing not found in page"


class TestOrderSubmission:
    """Test normal order submission functionality."""

    def test_valid_order_submission(self):
        """Test that a valid order can be submitted successfully."""
        order_data = {
            "name": "Test Customer",
            "foodid": "2",
            "address": "123 Test Street",
            "contact": "1234567890",
            "oqty": "1",
            "otype": "Deliver",
            "datep": "2024-12-25",
            "savechanges": "1"
        }

        response = requests.post(
            f"{BASE_URL}/pet1/availableframe.php",
            data=order_data,
            timeout=15
        )

        assert response.status_code == 200, f"Order submission failed: {response.status_code}"
        # Check response doesn't contain fatal errors
        assert "fatal error" not in response.text.lower(), "Fatal error in response"
        assert "syntax error" not in response.text.lower(), "Syntax error in response"

    def test_order_with_normal_name(self):
        """Test order submission with a normal customer name."""
        unique_name = f"John Smith {int(time.time())}"
        order_data = {
            "name": unique_name,
            "foodid": "3",
            "address": "456 Main Avenue",
            "contact": "9876543210",
            "oqty": "2",
            "otype": "Pick-up",
            "datep": "2024-12-30",
            "savechanges": "1"
        }

        response = requests.post(
            f"{BASE_URL}/pet1/availableframe.php",
            data=order_data,
            timeout=15
        )

        assert response.status_code == 200
        # Response should indicate success or at least not error
        response_lower = response.text.lower()
        assert "fatal" not in response_lower, "Unexpected fatal error"

    def test_order_with_unicode_name(self):
        """Test order with unicode characters in name (international names)."""
        order_data = {
            "name": "José García",
            "foodid": "1",
            "address": "Calle Principal 123",
            "contact": "5551234567",
            "oqty": "1",
            "otype": "Deliver",
            "datep": "2024-12-28",
            "savechanges": "1"
        }

        response = requests.post(
            f"{BASE_URL}/pet1/availableframe.php",
            data=order_data,
            timeout=15
        )

        assert response.status_code == 200

    def test_order_response_time_normal(self):
        """Test that normal orders process within acceptable time."""
        order_data = {
            "name": "Quick Test",
            "foodid": "2",
            "address": "Fast Lane 1",
            "contact": "1111111111",
            "oqty": "1",
            "otype": "Deliver",
            "datep": "2024-12-25",
            "savechanges": "1"
        }

        start_time = time.time()
        response = requests.post(
            f"{BASE_URL}/pet1/availableframe.php",
            data=order_data,
            timeout=15
        )
        elapsed_time = time.time() - start_time

        assert response.status_code == 200
        # Normal orders should complete in under 2 seconds
        assert elapsed_time < 2, f"Order took too long: {elapsed_time:.2f}s"


class TestFormValidation:
    """Test form handling and edge cases."""

    def test_empty_form_submission(self):
        """Test that submitting without savechanges doesn't process order."""
        response = requests.post(
            f"{BASE_URL}/pet1/availableframe.php",
            data={},
            timeout=10
        )
        # Should return page without processing (no savechanges parameter)
        assert response.status_code == 200

    def test_page_contains_form_elements(self):
        """Test that the page contains expected form elements."""
        response = requests.get(f"{BASE_URL}/pet1/availableframe.php", timeout=10)
        assert response.status_code == 200
        content = response.text.lower()
        # Check for form-related elements
        assert "form" in content or "input" in content or "button" in content, \
            "Form elements not found in page"

    def test_multiple_consecutive_orders(self):
        """Test that multiple orders can be placed consecutively."""
        for i in range(3):
            order_data = {
                "name": f"Bulk Tester {i} {int(time.time())}",
                "foodid": str((i % 5) + 1),
                "address": f"Address {i}",
                "contact": f"555000{i:04d}",
                "oqty": "1",
                "otype": "Deliver",
                "datep": "2024-12-25",
                "savechanges": "1"
            }

            response = requests.post(
                f"{BASE_URL}/pet1/availableframe.php",
                data=order_data,
                timeout=15
            )

            assert response.status_code == 200, f"Order {i} failed"


class TestDatabaseConnectivity:
    """Test that database operations work correctly."""

    def test_products_from_database(self):
        """Test that products are being fetched from database."""
        response = requests.get(f"{BASE_URL}/pet1/availableframe.php", timeout=10)
        assert response.status_code == 200
        # Should not show database connection errors
        assert "connection failed" not in response.text.lower()
        assert "mysqli_connect" not in response.text.lower() or "error" not in response.text.lower()

    def test_order_inserts_without_error(self):
        """Test that order insertion doesn't produce database errors."""
        unique_name = f"DBTest User {int(time.time())}"
        order_data = {
            "name": unique_name,
            "foodid": "2",
            "address": "Database Test Address",
            "contact": "5559999999",
            "oqty": "1",
            "otype": "Deliver",
            "datep": "2024-12-25",
            "savechanges": "1"
        }

        response = requests.post(
            f"{BASE_URL}/pet1/availableframe.php",
            data=order_data,
            timeout=15
        )

        assert response.status_code == 200
        # Check for common MySQL error patterns
        response_text = response.text.lower()
        assert "mysql" not in response_text or "error" not in response_text, \
            "Database error detected in response"
        assert "syntax" not in response_text or "error" not in response_text, \
            "SQL syntax error detected"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
