cat <<'EOF' > /workspace/fix.patch
diff --git a/lib/ansible/template/__init__.py b/lib/ansible/template/__init__.py
index 52b9f71977c3c1..a20b1bae688b8b 100644
--- a/lib/ansible/template/__init__.py
+++ b/lib/ansible/template/__init__.py
@@ -875,7 +875,8 @@ def do_template(self, data, preserve_trailing_newlines=True, escape_backslashes=
 
             try:
                 res = j2_concat(rf)
-                if getattr(new_context, 'unsafe', False):
+                unsafe = getattr(new_context, 'unsafe', False)
+                if unsafe:
                     res = wrap_var(res)
             except TypeError as te:
                 if 'AnsibleUndefined' in to_native(te):
@@ -905,6 +906,8 @@ def do_template(self, data, preserve_trailing_newlines=True, escape_backslashes=
                 res_newlines = _count_newlines_from_end(res)
                 if data_newlines > res_newlines:
                     res += self.environment.newline_sequence * (data_newlines - res_newlines)
+                    if unsafe:
+                        res = wrap_var(res)
             return res
         except (UndefinedError, AnsibleUndefinedVariable) as e:
             if fail_on_undefined:


EOF

cd /workspace/ansible
git apply --whitespace=nowarn  /workspace/fix.patch