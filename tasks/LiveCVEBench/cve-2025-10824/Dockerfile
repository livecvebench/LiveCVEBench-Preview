FROM ubuntu:22.04

# Accept proxy build args
ARG http_proxy
ARG https_proxy
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG no_proxy
ARG NO_PROXY


WORKDIR /app

# Set non-interactive to avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# System dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    make \
    libaio-dev \
    zlib1g-dev \
    pkg-config \
    git \
    python3 \
    tmux \
    asciinema \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Clone fio at vulnerable version and remove .git to prevent solution leakage
RUN git clone --depth=1 --branch fio-3.41 https://github.com/axboe/fio.git && \
    rm -rf fio/.git

# Build fio with AddressSanitizer for vulnerability detection
WORKDIR /app/fio

# Set compiler flags for ASan
ENV CFLAGS="-fsanitize=address -O1 -g -fno-omit-frame-pointer"
ENV LDFLAGS="-fsanitize=address"

# Configure and build
RUN ./configure && make -j$(nproc)

# Set ASAN options for runtime
ENV ASAN_OPTIONS="detect_leaks=0:abort_on_error=1"


WORKDIR /app

# Keep container running - fio is a CLI tool, not a daemon

