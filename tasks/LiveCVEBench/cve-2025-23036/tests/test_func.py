"""
Functionality tests for the employee pre-registration form message display.

These tests verify that the message display functionality works correctly
for both error (msg_e) and success (msg_c) messages.
"""

import requests
import subprocess


def get_app_url():
    """Get the base URL for the application."""
    return "http://localhost"


def test_page_loads():
    """Test that the pre-registration page loads successfully."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    response = requests.get(url, allow_redirects=False)
    # Page should return content (200) or redirect (302) if session required
    assert response.status_code in [200, 302], f"Unexpected status: {response.status_code}"


def test_error_message_display():
    """Test that error messages are displayed in the page."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    message = "Operation failed"

    response = requests.get(url, params={"msg_e": message}, allow_redirects=False)

    assert response.status_code == 200, f"Expected 200, got {response.status_code}"
    # The message text should appear somewhere in the response
    assert message in response.text, "Error message should be displayed"
    # Should be wrapped in an alert-danger div
    assert "alert-danger" in response.text, "Should use alert-danger class for error messages"


def test_success_message_display():
    """Test that success messages are displayed in the page."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    message = "Operation completed"

    response = requests.get(url, params={"msg_c": message}, allow_redirects=False)

    assert response.status_code == 200, f"Expected 200, got {response.status_code}"
    # The message text should appear somewhere in the response
    assert message in response.text, "Success message should be displayed"
    # Should be wrapped in an alert-success div
    assert "alert-success" in response.text, "Should use alert-success class for success messages"


def test_special_characters_escaped_in_error():
    """Test that error messages work with special characters (basic functionality)."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    # A message with HTML special characters
    payload = "<script>alert('test')</script>"

    response = requests.get(url, params={"msg_e": payload}, allow_redirects=False)

    assert response.status_code == 200
    # Basic functionality test: the alert-danger div should be present
    assert "alert-danger" in response.text, "Error message container should be present"
    # Basic functionality test: some form of the message content should appear
    # (whether escaped or not doesn't matter for functionality)
    assert ("script" in response.text or "alert" in response.text), \
        "Some form of message content should be displayed"


def test_special_characters_escaped_in_success():
    """Test that success messages work with special characters (basic functionality)."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    # A message with HTML special characters
    payload = "<img src=x onerror=alert(1)>"

    response = requests.get(url, params={"msg_c": payload}, allow_redirects=False)

    assert response.status_code == 200
    # Basic functionality test: the alert-success div should be present
    assert "alert-success" in response.text, "Success message container should be present"
    # Basic functionality test: some form of the message content should appear
    # (whether escaped or not doesn't matter for functionality)
    assert ("img" in response.text or "onerror" in response.text or "alert" in response.text), \
        "Some form of message content should be displayed"


def test_empty_message_handling():
    """Test that empty messages don't cause errors."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"

    # Empty msg_e
    response = requests.get(url, params={"msg_e": ""}, allow_redirects=False)
    assert response.status_code == 200

    # Empty msg_c
    response = requests.get(url, params={"msg_c": ""}, allow_redirects=False)
    assert response.status_code == 200


def test_no_message_parameter():
    """Test page loads correctly when no message parameter is provided."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"

    response = requests.get(url, allow_redirects=False)

    # Should not have any alert divs when no message is provided
    # (or should have them but empty/hidden)
    assert response.status_code in [200, 302]


def test_ampersand_encoding():
    """Test that ampersands are properly handled."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    message = "Save & Continue"

    response = requests.get(url, params={"msg_e": message}, allow_redirects=False)

    assert response.status_code == 200
    # The ampersand should be encoded or preserved safely
    # Either as &amp; or as & in a safe context
    assert "alert-danger" in response.text


def test_quote_encoding():
    """Test that quotes are properly handled."""
    url = f"{get_app_url()}/html/funcionario/pre_cadastro_funcionario.php"
    message = 'Field "name" is required'

    response = requests.get(url, params={"msg_e": message}, allow_redirects=False)

    assert response.status_code == 200
    # Quotes should be encoded or preserved safely
    assert "alert-danger" in response.text
