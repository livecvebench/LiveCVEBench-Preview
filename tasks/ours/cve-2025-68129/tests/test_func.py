"""
Functionality Tests - Verify normal token validation still works

These tests ensure that after applying the fix, normal token validation
continues to work correctly for all token types.

PASS in both vulnerable and fixed states
"""

import subprocess
import pytest
import os

# Base directory for the application
APP_DIR = "/app"
TESTS_DIR = "/tests"


def run_php_test(test_filter: str) -> subprocess.CompletedProcess:
    """Run a specific PHP test using Pest."""
    result = subprocess.run(
        [
            f"{APP_DIR}/vendor/bin/pest",
            f"{TESTS_DIR}/test_func.php",
            "--filter", test_filter,
            "--colors=never",
        ],
        capture_output=True,
        text=True,
        cwd=APP_DIR,
    )
    return result


class TestIDTokenValidation:
    """Test ID token validation functionality."""

    def test_valid_hs256_id_token(self):
        """Valid HS256 ID token validates correctly."""
        result = run_php_test("validates a valid HS256 ID token correctly")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_valid_rs256_id_token(self):
        """Valid RS256 ID token validates correctly."""
        result = run_php_test("validates a valid RS256 ID token correctly")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_id_token_with_organization(self):
        """ID token with organization claim validates correctly."""
        result = run_php_test("validates ID token with organization claim")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_id_token_multiple_audiences(self):
        """ID token with multiple audiences validates correctly."""
        result = run_php_test("validates ID token with multiple audiences")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestAccessTokenValidation:
    """Test access token validation functionality."""

    def test_valid_access_token_with_api_audience(self):
        """Valid access token with API audience validates correctly."""
        result = run_php_test("validates a valid access token with API audience")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_access_token_clientid_fallback(self):
        """Access token uses clientId as fallback when no API audience configured."""
        result = run_php_test("validates access token with clientId audience when no API audience configured")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestLogoutTokenValidation:
    """Test logout token validation functionality."""

    def test_valid_logout_token(self):
        """Valid logout token validates correctly."""
        result = run_php_test("validates a valid logout token correctly")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_logout_token_with_nonce_rejected(self):
        """Logout token with nonce claim is rejected."""
        result = run_php_test("rejects logout token with nonce claim")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestTokenRejection:
    """Test that invalid tokens are properly rejected."""

    def test_expired_token_rejected(self):
        """Expired tokens are rejected."""
        result = run_php_test("rejects expired ID token")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_wrong_issuer_rejected(self):
        """Tokens with wrong issuer are rejected."""
        result = run_php_test("rejects token with wrong issuer")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_max_age_exceeded_rejected(self):
        """Tokens exceeding max age are rejected."""
        result = run_php_test("rejects token exceeding max age")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestTokenParsing:
    """Test token parsing and export functionality."""

    def test_parse_claims_correctly(self):
        """Token claims are parsed correctly."""
        result = run_php_test("parses token claims correctly")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_export_to_json(self):
        """Token exports to JSON correctly."""
        result = run_php_test("exports token to JSON correctly")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_export_to_array(self):
        """Token exports to array correctly."""
        result = run_php_test("exports token to array correctly")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestFluentInterface:
    """Test that methods return fluent interface."""

    def test_verify_returns_fluent(self):
        """verify() returns fluent interface."""
        result = run_php_test("returns fluent interface from verify")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"

    def test_validate_returns_fluent(self):
        """validate() returns fluent interface."""
        result = run_php_test("returns fluent interface from validate")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"


class TestMaxAgeValidation:
    """Test max age constraint validation."""

    def test_token_within_max_age(self):
        """Token within max age validates correctly."""
        result = run_php_test("validates token with max age constraint")
        assert result.returncode == 0, f"Test failed: {result.stdout}\n{result.stderr}"
