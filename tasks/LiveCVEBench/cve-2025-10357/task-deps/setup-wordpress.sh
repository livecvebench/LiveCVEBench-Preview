#!/bin/bash
# setup-wordpress.sh
# This script sets up WordPress, activates the plugin, and creates test users

set -e

# Wait for database to be ready
echo "Waiting for database connection..."
while ! mysqladmin ping -h"db" --silent 2>/dev/null; do
    sleep 2
done
echo "Database is ready!"

# Wait for WordPress files to be in place
while [ ! -f /var/www/html/wp-config.php ]; do
    echo "Waiting for WordPress files..."
    sleep 2
done

cd /var/www/html

# Check if WordPress is already installed
if wp core is-installed --allow-root 2>/dev/null; then
    echo "WordPress is already installed."
else
    echo "Installing WordPress..."
    wp core install \
        --url="http://localhost" \
        --title="Simple SEO Test Site" \
        --admin_user="admin" \
        --admin_password="admin" \
        --admin_email="admin@example.com" \
        --skip-email \
        --allow-root
    echo "WordPress installed successfully!"
fi

# Activate the Simple SEO plugin
echo "Activating Simple SEO plugin..."
wp plugin activate cds-simple-seo --allow-root 2>/dev/null || echo "Plugin already active or not found"

# Create contributor user if not exists
if ! wp user get contributor --allow-root 2>/dev/null; then
    echo "Creating contributor user..."
    wp user create contributor contributor@example.com \
        --role=contributor \
        --user_pass=contributor \
        --allow-root
    echo "Contributor user created!"
else
    echo "Contributor user already exists."
fi

# Verify plugin is active
echo "Verifying plugin status..."
wp plugin list --allow-root | grep cds-simple-seo

echo "WordPress setup complete!"
echo "Admin user: admin / admin"
echo "Contributor user: contributor / contributor"
