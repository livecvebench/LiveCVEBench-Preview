#!/bin/bash

# Entrypoint script for Open5GS environment
# This script handles MongoDB startup and Open5GS NF startup
# Note: SCTP is not available in this environment, so NGAP/Diameter interfaces won't work
# However, the SBI interfaces will work, and the source code is available for inspection

# Don't exit on error since some services may fail due to SCTP issues
set +e

# Create log directories
mkdir -p /var/log/mongodb /data/db /app/install/var/log/open5gs

echo "[entrypoint] Starting MongoDB..."
mongod --fork --logpath /var/log/mongodb/mongod.log --dbpath /data/db

# Wait for MongoDB to be ready
echo "[entrypoint] Waiting for MongoDB to be ready..."
for i in {1..30}; do
    if mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
        echo "[entrypoint] MongoDB is ready."
        break
    fi
    sleep 1
done

# Function to start NF and track its PID
start_nf() {
    local name=$1
    local binary=$2
    local config=$3
    echo "[entrypoint] Starting $name..."
    $binary -c $config > /app/install/var/log/open5gs/${name}_stdout.log 2>&1 &
    local pid=$!
    echo $pid > /var/run/${name}.pid
    sleep 1
    if kill -0 $pid 2>/dev/null; then
        echo "[entrypoint] $name started with PID $pid"
    else
        echo "[entrypoint] WARNING: $name failed to start (this may be expected if SCTP is not available)"
    fi
}

# Start Network Functions in correct order
echo "[entrypoint] Starting Open5GS Network Functions..."
echo "[entrypoint] Note: Some services may fail due to SCTP not being available in this Docker environment."
echo "[entrypoint] The vulnerable source code is available at /app/src/smf/ngap-handler.c"

# NRF must start first (Service Registry/Discovery)
start_nf "nrf" "/app/install/bin/open5gs-nrfd" "/app/install/etc/open5gs/nrf.yaml"
sleep 2

# Start supporting functions (these use SBI/HTTP, should work)
start_nf "udr" "/app/install/bin/open5gs-udrd" "/app/install/etc/open5gs/udr.yaml"
start_nf "udm" "/app/install/bin/open5gs-udmd" "/app/install/etc/open5gs/udm.yaml"
start_nf "ausf" "/app/install/bin/open5gs-ausfd" "/app/install/etc/open5gs/ausf.yaml"
start_nf "pcf" "/app/install/bin/open5gs-pcfd" "/app/install/etc/open5gs/pcf.yaml"
sleep 2

# Start UPF (may partially work without GTP-U clients)
start_nf "upf" "/app/install/bin/open5gs-upfd" "/app/install/etc/open5gs/upf.yaml"

# Note: SMF with default config uses freeDiameter which requires SCTP
# AMF with default config uses NGAP which requires SCTP
# The source code is available for inspection and patching
echo "[entrypoint] Note: SMF and AMF may not start due to SCTP requirement."
echo "[entrypoint] The SMF source code is at /app/src/smf/"

# Try to start SMF and AMF anyway (they'll fail but we log it)
start_nf "smf" "/app/install/bin/open5gs-smfd" "/app/install/etc/open5gs/smf.yaml"
sleep 1
start_nf "amf" "/app/install/bin/open5gs-amfd" "/app/install/etc/open5gs/amf.yaml"

echo ""
echo "[entrypoint] =============================================="
echo "[entrypoint] Open5GS Environment Status:"
echo "[entrypoint] =============================================="
echo "[entrypoint] MongoDB: Running"
echo "[entrypoint] Source code: /app/src/"
echo "[entrypoint] Compiled binaries: /app/install/bin/"
echo "[entrypoint] Config files: /app/install/etc/open5gs/"
echo "[entrypoint] Build directory: /app/build/"
echo "[entrypoint] =============================================="
echo ""
echo "[entrypoint] Running services:"
pgrep -a open5gs || echo "[entrypoint] (Some services may have failed to start due to SCTP requirement)"

echo ""
echo "[entrypoint] Container is ready. Keeping alive..."

# Keep container running
while true; do
    sleep 30
done
