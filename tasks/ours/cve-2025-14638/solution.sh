#!/bin/bash
set -e

echo "Applying security fix for product update functionality..."

# The vulnerable file location in the container
TARGET_FILE="/var/www/html/pet1/update_cnp.php"

# Create the fixed version using PHP to do the replacement
# This is more reliable than sed for complex PHP code patterns
php << 'PHPFIX'
<?php
$file = '/var/www/html/pet1/update_cnp.php';

if (!file_exists($file)) {
    echo "ERROR: Target file not found: $file\n";
    exit(1);
}

$content = file_get_contents($file);

if ($content === false) {
    echo "ERROR: Could not read file: $file\n";
    exit(1);
}

// Define the vulnerable code pattern (the exact SQL query line)
$vulnerable_pattern = '$sql = ("UPDATE tblcnp SET name=\'$name\', prize=\'$prize\', description=\'$description\', status=\'$status\' WHERE id=\'$id\'") or die (mysqli_error());
    $result = mysqli_query($con, $sql);';

// Define the fixed code using prepared statements
$fixed_code = '$stmt = $con->prepare("UPDATE tblcnp SET name=?, prize=?, description=?, status=? WHERE id=?");
    $stmt->bind_param("sdssi", $name, $prize, $description, $status, $id);
    $result = $stmt->execute();
    $stmt->close();';

// Check if vulnerable pattern exists
if (strpos($content, $vulnerable_pattern) === false) {
    // Try alternative pattern matching (with different spacing)
    $alt_pattern = '$sql = ("UPDATE tblcnp SET name=\'$name\', prize=\'$prize\', description=\'$description\', status=\'$status\' WHERE id=\'$id\'") or die (mysqli_error());';

    if (strpos($content, $alt_pattern) !== false) {
        // Replace just the SQL line and the mysqli_query line separately
        $content = str_replace($alt_pattern, '$stmt = $con->prepare("UPDATE tblcnp SET name=?, prize=?, description=?, status=? WHERE id=?");', $content);
        $content = str_replace('$result = mysqli_query($con, $sql);', '$stmt->bind_param("sdssi", $name, $prize, $description, $status, $id);
    $result = $stmt->execute();
    $stmt->close();', $content);

        if (file_put_contents($file, $content) === false) {
            echo "ERROR: Could not write fixed content to file\n";
            exit(1);
        }
        echo "Fix applied successfully (alternative pattern)!\n";
        exit(0);
    }

    echo "WARNING: Vulnerable pattern not found - file may already be fixed or has different formatting\n";
    exit(0);
}

// Apply the fix
$content = str_replace($vulnerable_pattern, $fixed_code, $content);

if (file_put_contents($file, $content) === false) {
    echo "ERROR: Could not write fixed content to file\n";
    exit(1);
}

echo "Fix applied successfully!\n";
?>
PHPFIX

echo "Security fix applied to product update functionality."
echo "The application now uses prepared statements to prevent SQL injection."
