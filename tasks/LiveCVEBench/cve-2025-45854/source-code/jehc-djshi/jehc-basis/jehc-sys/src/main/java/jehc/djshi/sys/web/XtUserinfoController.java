package jehc.djshi.sys.web;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import jehc.djshi.common.annotation.Auth;
import jehc.djshi.common.base.*;
import jehc.djshi.common.entity.ConstantEntity;
import jehc.djshi.common.entity.DataDictionaryEntity;
import jehc.djshi.common.entity.UserinfoEntity;
import jehc.djshi.common.util.Base64Util;
import jehc.djshi.common.util.MD5;
import jehc.djshi.common.util.JsonUtil;
import jehc.djshi.common.util.StringUtil;
import jehc.djshi.log.client.service.LogsUtil;
import jehc.djshi.oauth.service.OauthAccountService;
import jehc.djshi.sys.model.XtUserinfo;
import jehc.djshi.sys.service.XtUserinfoService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.util.CollectionUtils;
import org.springframework.util.MultiValueMap;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import com.alibaba.druid.util.StringUtils;
import com.github.pagehelper.PageInfo;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;
/**
 * @Desc 员工信息
 * @Author 邓纯杰
 * @CreateTime 2012-12-12 12:12:12
 */
@RestController
@RequestMapping("/xtUserinfo")
@Api(value = "员工信息API",tags = "员工信息API",description = "员工信息API")
@Slf4j
public class XtUserinfoController extends BaseAction {

	@Resource
	XtUserinfoService xtUserinfoService;

	@Resource
	OauthAccountService oauthAccountService;

	@Resource
	CommonUtils commonUtils;

	@Resource
	LogsUtil logsUtil;

	/**
	* 查询员工信息列表并分页
	* @param baseSearch
	*/
	@PostMapping(value="/list")
	@Auth(value = "/xtUserinfo/list",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	@ApiOperation(value="查询员工信息列表并分页", notes="查询员工信息列表并分页")
	public BasePage<List<XtUserinfo>> getXtUserinfoListByCondition(@RequestBody(required=true)BaseSearch baseSearch){
		Map<String, Object> condition = baseSearch.convert();
		commonHPager(baseSearch);
		List<XtUserinfo> xtUserinfoList = xtUserinfoService.getXtUserinfoListByCondition(condition);
		PageInfo<XtUserinfo> page = new PageInfo<XtUserinfo>(xtUserinfoList);
		return outPageBootStr(page,baseSearch);
	}
	
	/**
	 * 查询已删除用户列表并分页
	 * @param baseSearch
	 * @return
	 */
	@PostMapping(value="/deleted/list")
	@Auth(value = "/xtUserinfo/deleted/list",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	@ApiOperation(value="查询已删除用户列表并分页", notes="查询已删除用户列表并分页")
	public BasePage<List<XtUserinfo>> getXtUserinfoDeletedListByCondition(@RequestBody(required=true)BaseSearch baseSearch){
		Map<String, Object> condition = baseSearch.convert();
		commonHPager(baseSearch);
		List<XtUserinfo> xtUserinfoList = xtUserinfoService.getXtUserinfoDeletedListByCondition(condition);
		PageInfo<XtUserinfo> page = new PageInfo<XtUserinfo>(xtUserinfoList);
		return outPageBootStr(page,baseSearch);
	}
	
	/**
	* 查询单个用户
	* @param id
	*/
	@GetMapping(value="/get/{id}")
	@Auth(value = "/xtUserinfo/get",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	@ApiOperation(value="查询单个用户", notes="查询单个用户")
	public BaseResult<XtUserinfo> getXtUserinfoById(@PathVariable("id")String id){
		XtUserinfo xtUserinfo = xtUserinfoService.getXtUserinfoById(id);
		return outDataStr(xtUserinfo);
	}
	
	/**
	* 添加
	* @param xtUserinfo
	*/
	@PostMapping(value="/add")
	@ApiOperation(value="创建单个用户", notes="创建单个用户")
	public BaseResult addXtUserinfo(@RequestBody XtUserinfo xtUserinfo){
		int i = 0;
		MD5 md5 = new MD5();
		if(null != xtUserinfo){
			xtUserinfo.setId(toUUID());
			xtUserinfo.setCreateId(getXtUid());
			xtUserinfo.setCreateTime(getDate());
			i=xtUserinfoService.addXtUserinfo(xtUserinfo);
			UserinfoEntity userinfoEntity = JsonUtil.fromFastJson(xtUserinfo,UserinfoEntity.class);
			new Thread(new SyncWorker(userinfoEntity)).start();
		}
		if(i>0){
			logsUtil.aBLogs("用户控制层", "添加", "添加用户成功");
			return outAudStr(true);
		}else{
			logsUtil.aBLogs("用户控制层", "添加", "添加用户失败");
			return outAudStr(false);
		}
	}
	
	/**
	* 修改
	* @param xtUserinfo
	*/
	@PutMapping(value="/update")
	@ApiOperation(value="编辑单个用户", notes="编辑单个用户")
	public BaseResult updateXtUserinfo(@RequestBody XtUserinfo xtUserinfo){
		int i = 0;
		if(null != xtUserinfo){

			xtUserinfo.setUpdateId(getXtUid());

			xtUserinfo.setUpdateTime(getDate());

			i=xtUserinfoService.updateXtUserinfo(xtUserinfo);

			UserinfoEntity userinfoEntity = JsonUtil.fromFastJson(xtUserinfo,UserinfoEntity.class);

			new Thread(new SyncWorker(userinfoEntity)).start();
		}
		if(i>0){
			logsUtil.aBLogs("用户控制层", "修改", "修改用户成功");
			return outAudStr(true);
		}else{
			logsUtil.aBLogs("用户控制层", "修改", "修改用户失败");
			return outAudStr(false);
		}
	}
	
	/**
	* 删除
	* @param id
	*/
	@DeleteMapping(value="/delete")
	@ApiOperation(value="删除用户", notes="删除用户")
	public BaseResult delXtUserinfo(String id){
		int i = 0;
		if(!StringUtil.isEmpty(id)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id",id.split(","));
			i=xtUserinfoService.delXtUserinfo(condition);
		}
		if(i>0){
			logsUtil.aBLogs("用户控制层", "删除", "删除用户成功");
			return outAudStr(true);
		}else{
			logsUtil.aBLogs("用户控制层", "删除", "删除用户失败");
			return outAudStr(false);
		}
	}
	
	/**
	 * 获取名族数据字典
	 * @param request
	 */
	@Auth(value = "/xtUserinfo/nation/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/nation/list")
	@ApiOperation(value=" 获取名族数据字典", notes=" 获取名族数据字典")
	public BaseResult<List<DataDictionaryEntity>> getXtUserinfoNationList(HttpServletRequest request){
		List<DataDictionaryEntity> dataDictionaryEntities = commonUtils.getXtDataDictionaryCache("xt_userinfo_nation");
		return outComboDataStr(dataDictionaryEntities);
	}
	
	/**
	 * 获取性别数据字典
	 * @param request
	 */
	@Auth(value = "/xtUserinfo/sex/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/sex/list")
	@ApiOperation(value=" 获取性别数据字典", notes=" 获取性别数据字典")
	public BaseResult<List<DataDictionaryEntity>> getXtUserinfoSexList(HttpServletRequest request){
		List<DataDictionaryEntity> dataDictionaryEntities = commonUtils.getXtDataDictionaryCache("gender");
		return outComboDataStr(dataDictionaryEntities);
	}
	
	/**
	 * 获取文化程度数据字典
	 * @param request
	 */
	@Auth(value = "/xtUserinfo/highestdegree/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/highestdegree/list")
	@ApiOperation(value=" 获取文化程度数据字典", notes=" 获取文化程度数据字典")
	public BaseResult<List<DataDictionaryEntity>> getXtUserinfoHighestDegreeList(HttpServletRequest request){
		List<DataDictionaryEntity> dataDictionaryEntities = commonUtils.getXtDataDictionaryCache("xt_userinfo_highestDegree");
		return outComboDataStr(dataDictionaryEntities);
	}
	
	/**
	 * 获取工作年限数据字典
	 * @param request
	 */
	@Auth(value = "/xtUserinfo/workyear/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/workyear/list")
	@ApiOperation(value=" 获取工作年限数据字典", notes=" 获取工作年限数据字典")
	public BaseResult<List<DataDictionaryEntity>> getXtUserinfoWorkYearList(HttpServletRequest request){
		List<DataDictionaryEntity> dataDictionaryEntities = commonUtils.getXtDataDictionaryCache("xt_userinfo_workYear");
		return outComboDataStr(dataDictionaryEntities);
	}
	
	/**
	 * 获取是否已婚数据字典
	 * @param request
	 */
	@Auth(value = "/xtUserinfo/ismarried/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/ismarried/list")
	@ApiOperation(value=" 获取是否已婚数据字典", notes=" 获取是否已婚数据字典")
	public BaseResult<List<DataDictionaryEntity>> getXtUserinfoIsmarriedList(HttpServletRequest request){
		List<DataDictionaryEntity> dataDictionaryEntities = commonUtils.getXtDataDictionaryCache("xt_userinfo_ismarried");
		return outComboDataStr(dataDictionaryEntities);
	}
	
	/**
	 * 获取用户状态数据字典
	 * @param request
	 */
	@Auth(value = "/xtUserinfo/state/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/state/list")
	@ApiOperation(value=" 获取用户状态数据字典", notes=" 获取用户状态数据字典")
	public BaseResult<List<DataDictionaryEntity>> getXtUserinfoStateList(HttpServletRequest request){
		List<DataDictionaryEntity> dataDictionaryEntities = commonUtils.getXtDataDictionaryCache("xt_userinfo_state");
		return outComboDataStr(dataDictionaryEntities);
	}
	
	/**
	 * 判断用户名即登陆账号是否重复
	 * @param account
	 */
	@Auth(value = "/xtUserinfo/validate",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/validate/{account}")
	@ApiOperation(value=" 判断用户名即登陆账号是否重复", notes=" 判断用户名即登陆账号是否重复")
	public BaseResult validateUser(@PathVariable("account")String account){
		Map<String, Object> condition = new HashMap<String, Object>();
		if(!StringUtil.isEmpty(account)){
			condition.put("account", account);
			int i = xtUserinfoService.validateUser(condition);
			if(i > 0){
				return outAudStr(true,"1");
			}else{
				return outAudStr(true,"0");
			}
		}else{
			return outAudStr(false,"用户名参数未获取!验证失败!");
		}
	}
	
	/**
	* 恢复数据
	* @param id
	*/
	@GetMapping(value="/recover")
	@ApiOperation(value=" 恢复数据", notes=" 恢复数据")
	public BaseResult recoverXtUserinfo(String id){
		int i = 0;
		if(!StringUtil.isEmpty(id)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id",id.split(","));
			i=xtUserinfoService.recoverXtUserinfo(condition);
		}
		if(i>0){
			logsUtil.aBLogs("用户控制层", "恢复用户", "恢复用户成功");
			return outAudStr(true);
		}else{
			logsUtil.aBLogs("用户控制层", "恢复用户", "恢复用户失败");
			return outAudStr(false);
		}
	}

	/**
	 * 全部用户
	 * @param request
	 * @return
	 */
	@Auth(value = "/xtUserinfo/chatting/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/chatting/list")
	@ApiOperation(value=" 全部用户", notes=" 全部用户")
	public BaseResult getChattingUserinfoList(HttpServletRequest request){
		Map<String, Object> condition = new HashMap<String, Object>();
		List<BaseTreeGridEntity> list = new ArrayList<BaseTreeGridEntity>();
		List<XtUserinfo> xtUserinfoList = xtUserinfoService.getXtUserinfoListByCondition(condition);
		for(int i = 0; i < xtUserinfoList.size(); i++){
			XtUserinfo xtUserinfo = xtUserinfoList.get(i);
			BaseTreeGridEntity BaseTreeGridEntity = new BaseTreeGridEntity();
			BaseTreeGridEntity.setId(xtUserinfo.getId());
			BaseTreeGridEntity.setPid("0");
			BaseTreeGridEntity.setText(xtUserinfo.getName());
			BaseTreeGridEntity.setContent("");
			BaseTreeGridEntity.setLeaf(true);
			BaseTreeGridEntity.setIcon("/deng/images/icons/employee_manager.png");
			list.add(BaseTreeGridEntity);
		}
		BaseTreeGridEntity baseTreeGridEntity = new BaseTreeGridEntity();
		List<BaseTreeGridEntity> baseTreeGridEntityList = baseTreeGridEntity.buildTree(list,"0");
		String json = JsonUtil.toFastJson(baseTreeGridEntityList);
		return outStr(json);
	}
	
	/**
	 * 根据各种情况查找集合不分页（流程设计器中处理人 发起人 发起人组等使用）
	 * @param id
	 * @return
	 */
	@Auth(value = "/xtUserinfo/lc/list/userId",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@GetMapping(value="/lc/list/{id}")
	@ApiOperation(value=" 根据各种情况查找集合不分页", notes=" 根据各种情况查找集合不分页")
	public BaseResult<List<XtUserinfo>> getXtUserinfoList(@PathVariable("id")String id){
		List<XtUserinfo> list = new ArrayList<XtUserinfo>();
		if(!StringUtil.isEmpty(id)){
			Map<String, Object> condition = new HashMap<String, Object>();
			condition.put("id", id.split(","));
			list = xtUserinfoService.getXtUserinfoList(condition);
		}
		return  outItemsStr(list);
	}
	
	/**
	* myinfo
	*/
	@GetMapping(value="/myinfo")
	@Auth(value = "/xtUserinfo/myinfo",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@ApiOperation(value=" 当前用户信息", notes=" 当前用户信息")
	public BaseResult myinfo(){
		return outDataStr(getXtU());
	}
	
	/**
	 * 流程模块使用（查找用户）
	 * @param baseSearch
	 * @return
	 * @throws UnsupportedEncodingException
	 */
	@PostMapping(value="/lc/list")
	@Auth(value = "/xtUserinfo/lc/list",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@ApiOperation(value=" 流程模块使用", notes=" 流程模块使用")
	public BasePage<List<XtUserinfo>> getXtUserinfoListForLcByCondition(@RequestBody(required=true)BaseSearch baseSearch){
		Map<String, Object> condition = baseSearch.convert();
		commonHPager(baseSearch);
		List<XtUserinfo> xtUserinfoList = xtUserinfoService.getXtUserinfoListByCondition(condition);
		PageInfo<XtUserinfo> page = new PageInfo<XtUserinfo>(xtUserinfoList);
		return outPageStr(page,baseSearch);
	}

	/**
	 * 同步至授权中心
	 * @param userinfoEntity
	 */
	@PostMapping(value="/syncOauth")
	@ApiOperation(value="同步至授权中心", notes="同步至授权中心")
	public BaseResult syncOauth(@RequestBody UserinfoEntity userinfoEntity){
		BaseResult baseResult = new BaseResult();
		baseResult.setSuccess(false);
		if(null != userinfoEntity){
			if(StringUtil.isEmpty(userinfoEntity.getId())){
				baseResult.setMessage("未能获取到用户id");
				return baseResult;
			}
			Map<String,Object> condition = new HashMap<>();
			condition.put("id", userinfoEntity.getId().split(","));
			List<XtUserinfo> userinfos = xtUserinfoService.getXtUserinfoList(condition);
			List<UserinfoEntity> userinfoEntities = JsonUtil.toFastList(userinfos,UserinfoEntity.class);
			if(!CollectionUtils.isEmpty(userinfoEntities)) {
				for (UserinfoEntity userinfoEntitys : userinfoEntities) {
					userinfoEntitys.setAccountTypeId(userinfoEntity.getAccountTypeId());
                    userinfoEntitys.setSync(userinfoEntity.getSync());
				}
				baseResult = oauthAccountService.sync(userinfoEntities);
			}
		}
		if(baseResult.getSuccess()){
			logsUtil.aBLogs("用户控制层", "同步至授权中心", "同步至授权中心成功");
			return baseResult;
		}else{
			logsUtil.aBLogs("用户控制层", "同步至授权中心", "同步至授权中心失败");
			return baseResult;
		}
	}

	/**
	 * 查询员工信息列表
	 * @param userinfoEntity
	 */
	@Auth(value = "/xtUserinfo/users",authenticationType = Auth.AuthorizationType.NOT_REQUIRED_LOGIN)
	@PostMapping(value="/users")
	@ApiOperation(value="查询员工信息列表", notes="查询员工信息列表")
	public BaseResult<List<XtUserinfo>> getUsers(@RequestBody UserinfoEntity userinfoEntity){
		if(StringUtil.isEmpty(userinfoEntity.getId())){
			return new BaseResult();
		}
		Map<String, Object> condition = new HashMap<>();
		condition.put("id",userinfoEntity.getId().split(","));
		List<XtUserinfo> xtUserinfoList = xtUserinfoService.getXtUserinfoList(condition);
		return new BaseResult(xtUserinfoList);
	}

	/**
	 * 上传头像
	 * @param request
	 * @return
	 */
	@PostMapping(value = "/pic/upload")
	@Auth(value = "/xtUserinfo/pic/upload",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	@ApiOperation(value="上传头像", notes="上传头像")
	public BaseResult uploadMyPic(HttpServletRequest request) {
		MultipartHttpServletRequest multipartRequest = (MultipartHttpServletRequest) request;//转型为MultipartHttpRequest：
		MultiValueMap<String, MultipartFile> multipartFileMultiValueMap =  multipartRequest.getMultiFileMap();//获取所有文件
		MultipartFile multipartFile = multipartRequest.getFile("userPicFile");//获取指定文件即前端file框name标签
		String account = getXtU().getAccount();
		if(!StringUtil.isEmpty(account)){
			XtUserinfo xtUserinfo = xtUserinfoService.getXtUserinfoByUserName(account);
			String pic = null;
			if(null != multipartFile && null != xtUserinfo){
				try {
					pic = Base64Util.toBase64(multipartFile.getBytes());
					xtUserinfo.setImage(pic);
				}catch (Exception e){
					log.error(e.getMessage());
				}
				int i = xtUserinfoService.updateXtUserinfo(xtUserinfo);
				if(i>0){
					return BaseResult.success(xtUserinfo);
				}
			}
		}
		return BaseResult.fail();
	}

	/**
	 * 查询单个用户头像
	 * @param userName
	 */
	@GetMapping(value="/pic/{userName}")
	@Auth(value = "/xtUserinfo/pic/get",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	@ApiOperation(value="查询单个用户头像", notes="查询单个用户头像")
	public BaseResult<XtUserinfo> getXtUserinfoPicById(@PathVariable("userName")String userName){
		XtUserinfo xtUserinfo = xtUserinfoService.getXtUserinfoByUserName(userName);
		return BaseResult.success(xtUserinfo);
	}

	/**
	 * 根据账号查找单个用户信息
	 * @param account
	 */
	@ApiOperation(value="根据账号查找单个用户信息", notes="根据账号查找单个用户信息")
	@Auth(value = "/xtUserinfo/single",authenticationType = Auth.AuthorizationType.REQUIRED_LOGIN_NOT_AUTH)
	@GetMapping(value="/single/{account}")
	public BaseResult<XtUserinfo> getSingleOauthAccount(@PathVariable("account")String account){
		if(StringUtil.isEmpty(account)){
			return BaseResult.success();
		}
		XtUserinfo xtUserinfo = xtUserinfoService.getXtUserinfoByUserName(account);
		return outDataStr(xtUserinfo);
	}

	/**
	 * 信息变更同步信息至授权中心
	 */
	class SyncWorker implements Runnable {
		UserinfoEntity userinfoEntity;


		public SyncWorker(){

		}

		public SyncWorker(UserinfoEntity userinfoEntity){
			this.userinfoEntity = userinfoEntity;
		}

		public void run() {
			if(null != userinfoEntity){

				userinfoEntity.setSync(0);//不同步类型
				userinfoEntity.setAccountTypeId("");//设置类型为空
				List<UserinfoEntity> userinfoEntities = new ArrayList<>();

				userinfoEntities.add(userinfoEntity);

				oauthAccountService.sync(userinfoEntities);
			}
		}
	}
}
