#!/bin/bash
set -e

echo "[*] Applying authentication fix to code validation endpoint..."

# Find the validate.py file
VALIDATE_FILE=""
for path in \
    "/app/.venv/lib/python3.12/site-packages/langflow/api/v1/validate.py" \
    "/app/.venv/lib/python3.11/site-packages/langflow/api/v1/validate.py" \
    "/app/src/backend/base/langflow/api/v1/validate.py" \
    "/usr/local/lib/python3.12/site-packages/langflow/api/v1/validate.py" \
    "/usr/local/lib/python3.11/site-packages/langflow/api/v1/validate.py"; do
    if [ -f "$path" ]; then
        VALIDATE_FILE="$path"
        break
    fi
done

if [ -z "$VALIDATE_FILE" ]; then
    echo "[-] Error: validate.py not found"
    exit 1
fi

echo "[+] Found validate.py at: $VALIDATE_FILE"

BASE_DIR=$(dirname $(dirname $(dirname "$VALIDATE_FILE")))
AUTH_SETTINGS_FILE="$BASE_DIR/services/settings/auth.py"

# Backup and patch validate.py
cp "$VALIDATE_FILE" "${VALIDATE_FILE}.bak"

python3 << PATCH
import re
filepath = "$VALIDATE_FILE"
with open(filepath, 'r') as f:
    content = f.read()
if 'CurrentActiveUser' in content and '_current_user: CurrentActiveUser' in content:
    print("[*] Endpoint fix already applied")
else:
    if 'from langflow.api.utils import CurrentActiveUser' not in content:
        content = content.replace(
            'from loguru import logger',
            'from loguru import logger\\n\\nfrom langflow.api.utils import CurrentActiveUser'
        )
        print("[+] Added CurrentActiveUser import")
    content = re.sub(
        r'async def post_validate_code\\(code: Code\\)',
        'async def post_validate_code(code: Code, _current_user: CurrentActiveUser)',
        content
    )
    print("[+] Added authentication parameter")
    with open(filepath, 'w') as f:
        f.write(content)
    print("[+] Fix applied")
PATCH

# Patch auth settings
if [ -f "$AUTH_SETTINGS_FILE" ]; then
    cp "$AUTH_SETTINGS_FILE" "${AUTH_SETTINGS_FILE}.bak"
    if grep -q "AUTO_LOGIN: bool = True" "$AUTH_SETTINGS_FILE"; then
        sed -i 's/AUTO_LOGIN: bool = True/AUTO_LOGIN: bool = False/' "$AUTH_SETTINGS_FILE"
        echo "[+] Disabled AUTO_LOGIN"
    else
        echo "[*] AUTO_LOGIN already disabled"
    fi
fi

# Clear bytecode cache
rm -f "$(dirname "$VALIDATE_FILE")/__pycache__/"*.pyc 2>/dev/null || true
rm -f "$(dirname "$AUTH_SETTINGS_FILE")/__pycache__/"*.pyc 2>/dev/null || true
echo "[+] Cleared bytecode cache"

# Check if fix is already active
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:7860/api/v1/validate/code -H "Content-Type: application/json" -d '{"code": "def test(): pass"}' 2>/dev/null || echo "000")

if [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "401" ]; then
    echo "[+] Authentication already enforced (HTTP $HTTP_CODE)"
    echo "[+] Solution complete."
    exit 0
fi

echo "[*] Signaling wrapper to restart langflow..."

# Create restart signal file for the wrapper script
touch /tmp/need_restart

echo "[+] Fix applied. Langflow will restart automatically."
echo "[+] Solution script completed."
exit 0
