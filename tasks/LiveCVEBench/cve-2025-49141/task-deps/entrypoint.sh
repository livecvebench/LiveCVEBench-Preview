#!/bin/bash

# HAXcms entrypoint script that runs initial setup if not configured

# Function to wait for Apache to be ready
wait_for_apache() {
    local max_attempts=30
    local attempt=0
    while [ $attempt -lt $max_attempts ]; do
        if curl -s http://localhost/ > /dev/null 2>&1; then
            return 0
        fi
        sleep 1
        ((attempt++))
    done
    return 1
}

# Start Apache in background first
apache2-foreground &
APACHE_PID=$!

# Always wait for Apache to be ready before proceeding
echo "Waiting for Apache to start..."
wait_for_apache

if [ $? -eq 0 ]; then
    echo "Apache is ready!"
else
    echo "Warning: Apache may not be fully ready"
fi

# Check if HAXcms is already configured
if [ ! -d "/var/www/html/_config" ]; then
    echo "Running HAXcms initial setup..."
    curl -s -X POST http://localhost/install.php -d 'user=admin&pass=admin' > /dev/null 2>&1

    if [ -d "/var/www/html/_config" ]; then
        echo "HAXcms setup completed successfully!"
    else
        echo "Warning: HAXcms setup may have failed"
    fi
fi

# Create a flag file to indicate setup is complete
touch /tmp/haxcms_ready

echo "HAXcms is ready to serve requests"

# Keep the container running with Apache
wait $APACHE_PID
