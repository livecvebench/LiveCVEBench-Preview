"""
Functionality tests for Horilla HRMS.
These tests verify that the application works correctly.
Should PASS in both vulnerable and fixed states.
"""
import pytest
import requests
import os

BASE_URL = os.environ.get("APP_URL", "http://localhost:8000")


class TestApplicationFunctionality:
    """Tests to verify the application is running and functional."""

    def test_homepage_accessible(self):
        """Verify the application is running and homepage loads."""
        response = requests.get(f"{BASE_URL}/", timeout=10, allow_redirects=True)
        assert response.status_code in [200, 302], f"Homepage should be accessible, got {response.status_code}"

    def test_login_page_accessible(self):
        """Verify the login page is accessible."""
        response = requests.get(f"{BASE_URL}/login/", timeout=10, allow_redirects=True)
        assert response.status_code == 200, f"Login page should be accessible, got {response.status_code}"
        assert "login" in response.text.lower() or "password" in response.text.lower(), \
            "Login page should contain login form"

    def test_static_files_served(self):
        """Verify static files are being served."""
        response = requests.get(f"{BASE_URL}/static/", timeout=10, allow_redirects=True)
        # Static directory might return 404 or redirect, but server should respond
        assert response.status_code in [200, 301, 302, 403, 404], \
            f"Static files endpoint should respond, got {response.status_code}"


class TestSafeContentAllowed:
    """Tests to verify that safe/legitimate content can be saved."""

    @pytest.fixture(scope="class", autouse=True)
    def setup_django(self):
        """Setup Django environment."""
        import sys
        sys.path.insert(0, '/app')
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'horilla.settings')
        import django
        django.setup()

    def test_plain_text_allowed(self):
        """Verify plain text content passes validation."""
        from helpdesk.models import Comment

        safe_contents = [
            "Hello, this is a normal comment",
            "Please review ticket #123",
            "The meeting is at 2pm",
        ]

        for content in safe_contents:
            comment = Comment(comment=content)
            # Should not raise any exception
            try:
                comment.full_clean()
            except Exception as e:
                # Only fail if the error is about XSS, not about missing required fields
                if "XSS" in str(e):
                    pytest.fail(f"Safe content should not be flagged as XSS: {content}")

    def test_basic_html_formatting_allowed(self):
        """Verify that basic HTML formatting is allowed."""
        from helpdesk.models import Comment

        formatting_html = [
            "<p>Paragraph text</p>",
            "<strong>Strong text</strong>",
            "<b>Bold text</b>",
            "<i>Italic text</i>",
        ]

        for html in formatting_html:
            comment = Comment(comment=html)
            try:
                comment.full_clean()
            except Exception as e:
                # Only fail if the error is about XSS
                if "XSS" in str(e):
                    pytest.fail(f"Formatting HTML should not be flagged as XSS: {html}")
