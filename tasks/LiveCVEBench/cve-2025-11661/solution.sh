#!/bin/bash
set -e

echo "Applying authentication fix to School Management System..."

cd /var/www/html

# List of vulnerable PHP files in /assets/ that need authentication checks
VULNERABLE_FILES=(
    "assets/editSubject.php"
    "assets/addSubject.php"
    "assets/deleteSubject.php"
    "assets/addStudent.php"
    "assets/editStudent.php"
    "assets/removeStudent.php"
    "assets/addTeacher.php"
    "assets/editTeacher.php"
    "assets/removeTeacher.php"
    "assets/createNotice.php"
    "assets/deleteNotice.php"
    "assets/submitAttendence.php"
)

# Authentication check code to prepend
AUTH_CHECK='session_start();
if(!isset($_SESSION['"'"'uid'"'"'])){
    http_response_code(401);
    echo "Unauthorized";
    exit();
}

'

# Function to add authentication check to a PHP file
add_auth_check() {
    local file="$1"

    if [[ ! -f "$file" ]]; then
        echo "  [SKIP] $file does not exist"
        return 0
    fi

    # Check if auth check is already present
    if grep -q "session_start()" "$file" && grep -q '\$_SESSION\[.uid.\]' "$file"; then
        echo "  [SKIP] $file already has authentication check"
        return 0
    fi

    # Create backup
    cp "$file" "${file}.bak"

    # Write the new PHP file with auth check header
    cat > "$file" << 'PHPEOF'
<?php

session_start();
if(!isset($_SESSION['uid'])){
    http_response_code(401);
    echo "Unauthorized";
    exit();
}

PHPEOF

    # Extract content after the <?php tag from backup
    # Use awk to skip leading empty lines and the <?php line, then print the rest
    awk '
        BEGIN { started = 0 }
        /^[[:space:]]*$/ && !started { next }      # Skip leading empty lines
        /^<\?php[[:space:]]*$/ && !started { next } # Skip the <?php line
        { started = 1; print }                      # Print everything after that
    ' "${file}.bak" >> "$file"

    # Remove backup
    rm "${file}.bak"

    echo "  [FIXED] $file"
}

echo ""
echo "Adding authentication checks to vulnerable endpoints..."
echo ""

for file in "${VULNERABLE_FILES[@]}"; do
    add_auth_check "/var/www/html/$file"
done

echo ""
echo "Fix applied successfully!"
echo "All data-modifying endpoints now require session authentication."
