# Dockerfile for CVE-2025-32433 vulnerable Erlang/OTP SSH server
# Uses Erlang OTP-26.2.5.10 which is vulnerable to the pre-auth RCE

FROM debian:bookworm

# Install build dependencies and required tools (tmux, asciinema, curl)
RUN apt-get update && apt-get install -y \
    git \
    build-essential \
    autoconf \
    libncurses5-dev \
    libssl-dev \
    tmux \
    asciinema \
    curl \
    openssh-client \
    netcat-openbsd \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Clone and build vulnerable Erlang/OTP version
WORKDIR /tmp
RUN git clone --depth 1 --branch OTP-26.2.5.10 https://github.com/erlang/otp.git && \
    rm -rf /tmp/otp/.git

WORKDIR /tmp/otp
RUN ./configure --prefix=/usr --without-javac --without-wx --without-debugger --without-observer --without-et
RUN make -j$(nproc)
RUN make install

# Clean up build artifacts
RUN rm -rf /tmp/otp

# Set up SSH server
WORKDIR /root
COPY task-deps/ssh_server.erl /root/
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Compile the SSH server module
RUN erlc ssh_server.erl

# Generate SSH host keys (required for SSH daemon)
RUN mkdir -p /root/ssh_keys && \
    ssh-keygen -t rsa -b 2048 -f /root/ssh_keys/ssh_host_rsa_key -N "" -m PEM && \
    chmod 600 /root/ssh_keys/ssh_host_rsa_key


# Start the vulnerable SSH server via entrypoint wrapper
# ENTRYPOINT ["/entrypoint.sh"]
