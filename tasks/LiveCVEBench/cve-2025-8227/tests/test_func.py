#!/usr/bin/env python3
"""
Functional tests for ChanCMS collect/getArticle endpoint.
These tests verify the application works correctly and should PASS
in both vulnerable and fixed states.
"""

import pytest
import requests
import json
import time
import os

# Application URL - using internal Docker network or localhost
BASE_URL = os.environ.get("APP_URL", "http://localhost:7001")

# Use local URL for scraping tests (avoiding external network dependency)
# The app's own endpoint can be used as a scrape target
LOCAL_SCRAPE_URL = f"{BASE_URL}/cms/site/runEnv"

# Test timeout settings
REQUEST_TIMEOUT = 30


def wait_for_app(max_wait=60):
    """Wait for the application to be ready."""
    start_time = time.time()
    while time.time() - start_time < max_wait:
        try:
            response = requests.get(f"{BASE_URL}/cms/site/runEnv", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


@pytest.fixture(scope="module", autouse=True)
def setup_app():
    """Ensure the application is running before tests."""
    if not wait_for_app():
        pytest.skip("Application is not available")


class TestCollectEndpointBasic:
    """Basic functional tests for the collect endpoint."""

    def test_endpoint_exists(self):
        """Test that the getArticle endpoint exists and responds."""
        response = requests.post(
            f"{BASE_URL}/cms/collect/getArticle",
            json={
                "taskUrl": LOCAL_SCRAPE_URL,
                "titleTag": "body",
                "articleTag": "body",
                "parseData": "return data;",
                "charset": "utf8"
            },
            timeout=REQUEST_TIMEOUT
        )
        # Should not be 404 (endpoint not found)
        assert response.status_code != 404, "Endpoint /cms/collect/getArticle should exist"

    def test_site_info_endpoint(self):
        """Test that basic site endpoints are accessible."""
        response = requests.get(f"{BASE_URL}/cms/site/runEnv", timeout=REQUEST_TIMEOUT)
        # This endpoint doesn't require auth
        assert response.status_code == 200

    def test_collect_scrapes_content(self):
        """Test that the collect endpoint can scrape content from a URL."""
        response = requests.post(
            f"{BASE_URL}/cms/collect/getArticle",
            json={
                "taskUrl": LOCAL_SCRAPE_URL,
                "titleTag": "body",
                "articleTag": "body",
                "parseData": "{}",  # Valid JSON config (fixed version requires JSON)
                "charset": "utf8"
            },
            timeout=REQUEST_TIMEOUT
        )

        # Check we got a valid response
        try:
            data = response.json()
            # Should have code 200 for success
            assert data.get("code") == 200, f"Expected code 200, got {data.get('code')}"
            # Should have some content in the title (from the local endpoint response)
            assert data.get("data", {}).get("title") is not None, "Should extract title from page"
        except json.JSONDecodeError:
            pytest.fail("Response should be valid JSON")


class TestCollectEndpointWithAuth:
    """Tests for the collect endpoint functionality."""

    @pytest.fixture
    def auth_session(self):
        """Get a session for requests."""
        session = requests.Session()
        return session

    def test_getarticle_basic_scrape(self, auth_session):
        """Test getArticle can scrape and return page content."""
        response = auth_session.post(
            f"{BASE_URL}/cms/collect/getArticle",
            json={
                "taskUrl": LOCAL_SCRAPE_URL,
                "titleTag": "body",
                "articleTag": "body",
                "parseData": "return data;",  # Just return the scraped content
                "charset": "utf8"
            },
            timeout=REQUEST_TIMEOUT
        )
        # Should return success
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

    def test_getarticle_response_format(self, auth_session):
        """Test that response has expected format."""
        response = auth_session.post(
            f"{BASE_URL}/cms/collect/getArticle",
            json={
                "taskUrl": LOCAL_SCRAPE_URL,
                "titleTag": "body",
                "articleTag": "body",
                "parseData": "return data;",
                "charset": "utf8"
            },
            timeout=REQUEST_TIMEOUT
        )

        # If we get a JSON response, check its structure
        if response.headers.get('content-type', '').startswith('application/json'):
            try:
                data = response.json()
                # Response should have a code field
                assert 'code' in data or 'data' in data or 'msg' in data, \
                    "Response should have standard API format"
            except json.JSONDecodeError:
                pass  # Non-JSON response is also acceptable for error cases


class TestCollectEndpointInputHandling:
    """Tests for input handling - should work in both vulnerable and fixed state."""

    def test_missing_taskUrl(self):
        """Test handling of missing taskUrl parameter."""
        response = requests.post(
            f"{BASE_URL}/cms/collect/getArticle",
            json={
                "titleTag": "title",
                "articleTag": "body",
                "parseData": "return data;",
                "charset": "utf8"
            },
            timeout=REQUEST_TIMEOUT
        )
        # Should handle gracefully - any response is acceptable as long as it doesn't crash
        assert response.status_code is not None, "Server should respond to missing taskUrl"

    def test_default_charset(self):
        """Test that charset defaults appropriately."""
        response = requests.post(
            f"{BASE_URL}/cms/collect/getArticle",
            json={
                "taskUrl": LOCAL_SCRAPE_URL,
                "titleTag": "body",
                "articleTag": "body",
                "parseData": "return data;"
                # charset omitted - should default
            },
            timeout=REQUEST_TIMEOUT
        )
        # Should not crash due to missing charset
        assert response.status_code != 500 or "charset" not in response.text.lower(), \
            "Server should use default charset when not provided"


class TestOtherEndpoints:
    """Test other endpoints still work correctly."""

    def test_collect_list_endpoint(self):
        """Test the collect list endpoint."""
        response = requests.get(
            f"{BASE_URL}/cms/collect/list",
            timeout=REQUEST_TIMEOUT
        )
        # This endpoint doesn't require auth per router
        assert response.status_code in [200, 401, 403]

    def test_collect_search_endpoint(self):
        """Test the collect search endpoint."""
        response = requests.get(
            f"{BASE_URL}/cms/collect/search",
            params={"keyword": "test"},
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code in [200, 401, 403]


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
