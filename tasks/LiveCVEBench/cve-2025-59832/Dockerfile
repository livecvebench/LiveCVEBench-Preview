FROM python:3.10-slim

WORKDIR /app

# Install system dependencies (including tmux, asciinema, curl as required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    libpq-dev \
    gcc \
    build-essential \
    python3-dev \
    libjpeg-dev \
    zlib1g-dev \
    libpng-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone the vulnerable version (1.3 - before XSS fix was added in 1.3.1)
RUN git clone --branch 1.3 --depth 1 https://github.com/horilla-opensource/horilla.git . \
    && rm -rf .git

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Environment variables for Django
ENV DJANGO_SETTINGS_MODULE=horilla.settings
ENV SECRET_KEY=insecure-dev-key-for-testing-only
ENV DEBUG=True
ENV ALLOWED_HOSTS=*
ENV PYTHONUNBUFFERED=1

# Copy task dependencies
COPY task-deps/ /task-deps/

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh


# CMD ["/entrypoint.sh"]
