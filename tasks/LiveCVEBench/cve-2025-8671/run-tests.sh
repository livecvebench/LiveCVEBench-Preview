#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "[INFO] Installing test dependencies..."

# Install uv package manager
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize project and install dependencies
uv init 2>/dev/null || true
uv add pytest h2 hyperframe 2>/dev/null

echo "[INFO] Waiting for H2O server to be ready..."
# Wait for server to start accepting connections
max_wait=30
waited=0
while ! timeout 1 bash -c "echo > /dev/tcp/localhost/8081" 2>/dev/null; do
    sleep 1
    waited=$((waited + 1))
    if [ $waited -ge $max_wait ]; then
        echo "[ERROR] Server did not start within ${max_wait} seconds"
        exit 1
    fi
done
echo "[INFO] Server is ready after ${waited} seconds"

# Give server a moment to stabilize
sleep 2

echo "[INFO] Running tests..."
uv run pytest . -rA -v
