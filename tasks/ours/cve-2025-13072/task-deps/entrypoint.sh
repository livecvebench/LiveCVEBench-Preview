#!/bin/bash
set -e

# Function to wait for database
wait_for_db() {
    echo "Waiting for database to be ready..."
    local max_attempts=60
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        # Use mysql command to check if we can connect and run a query (disable SSL)
        if mysql --skip-ssl -h"$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" "$WORDPRESS_DB_NAME" -e "SELECT 1" >/dev/null 2>&1; then
            echo "Database is ready!"
            return 0
        fi
        echo "Attempt $attempt/$max_attempts: Database not ready, waiting..."
        sleep 2
        attempt=$((attempt + 1))
    done

    echo "Database did not become ready in time"
    return 1
}

# Function to setup WordPress
setup_wordpress() {
    cd /var/www/html

    # Wait for WordPress files to be ready (docker-entrypoint copies them)
    echo "Waiting for WordPress files..."
    local wait_count=0
    while [ ! -f "/var/www/html/wp-config.php" ] && [ $wait_count -lt 30 ]; do
        sleep 2
        wait_count=$((wait_count + 1))
    done

    if [ ! -f "/var/www/html/wp-config.php" ]; then
        echo "WordPress files not ready, skipping setup"
        return 1
    fi

    # Check if WordPress is already installed
    if wp core is-installed --allow-root 2>/dev/null; then
        echo "WordPress is already installed"
    else
        echo "Installing WordPress..."
        wp core install \
            --url=http://localhost \
            --title="UTM Grabber Test Site" \
            --admin_user=admin \
            --admin_password=admin123 \
            --admin_email=admin@example.com \
            --skip-email \
            --allow-root
    fi

    # Activate the HandL UTM Grabber plugin
    echo "Activating HandL UTM Grabber plugin..."
    wp plugin activate handl-utm-grabber --allow-root 2>/dev/null || true

    # Check if UTM Test page exists by title
    if ! wp post list --post_type=page --field=post_title --allow-root 2>/dev/null | grep -q "UTM Test"; then
        echo "Creating test page with utm_source shortcode..."
        wp post create \
            --post_type=page \
            --post_title="UTM Test" \
            --post_content="<p>UTM Source: [utm_source]</p><p>UTM Medium: [utm_medium]</p><p>UTM Campaign: [utm_campaign]</p>" \
            --post_status=publish \
            --allow-root
    else
        echo "UTM Test page already exists"
    fi

    # Set proper permissions
    chown -R www-data:www-data /var/www/html/wp-content

    echo "WordPress setup complete!"
}

# First, call the original WordPress docker-entrypoint to set up WordPress files
# This runs docker-entrypoint.sh which copies WordPress files and creates wp-config.php
echo "Running WordPress docker-entrypoint..."
/usr/local/bin/docker-entrypoint.sh apache2-foreground &
APACHE_PID=$!

# Wait a bit for WordPress files to be copied
sleep 5

# Wait for database
wait_for_db

# Setup WordPress
setup_wordpress

# Wait for Apache to finish (it should be running in background)
wait $APACHE_PID
