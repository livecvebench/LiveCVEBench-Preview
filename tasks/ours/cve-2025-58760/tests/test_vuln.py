"""
Vulnerability tests for Tautulli path traversal issue.
These tests verify that the path traversal vulnerability exists in the vulnerable version.

IMPORTANT: Python's requests library normalizes URLs and removes '../' sequences before
sending them. This prevents the path traversal from working through the library.
Therefore, these tests use raw socket connections to send the actual path traversal payload.

Should FAIL in vulnerable state (exploitation successful - sensitive data found).
Should PASS in fixed state (exploitation blocked - no sensitive data leaked).

Path layout:
- /app/data/interfaces/default/images (image serving root)
- /app/Tautulli.py (4 levels up from images)
- /config/config.ini (6 levels up from images, then into config/)
- /config/tautulli.db (6 levels up from images, then into config/)
- /etc/passwd (6 levels up from images, then etc/)
"""

import pytest
import requests
import socket
import time

HOST = "localhost"
PORT = 8181
BASE_URL = f"http://{HOST}:{PORT}"
STARTUP_TIMEOUT = 60


def raw_http_get(path, timeout=10):
    """
    Send a raw HTTP GET request without URL normalization.
    This bypasses the requests library's URL normalization which removes ../
    """
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(timeout)
    try:
        s.connect((HOST, PORT))
        request = f"GET {path} HTTP/1.1\r\nHost: {HOST}:{PORT}\r\nConnection: close\r\n\r\n"
        s.send(request.encode())
        response = b""
        while True:
            try:
                data = s.recv(4096)
                if not data:
                    break
                response += data
            except socket.timeout:
                break
        s.close()
        # Split headers from body
        response_str = response.decode("utf-8", errors="ignore")
        if "\r\n\r\n" in response_str:
            _, body = response_str.split("\r\n\r\n", 1)
            return body
        return response_str
    except Exception as e:
        s.close()
        return f"ERROR: {e}"


def wait_for_server():
    """Wait for the Tautulli server to be ready."""
    start_time = time.time()
    while time.time() - start_time < STARTUP_TIMEOUT:
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302, 401]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure the server is ready before running tests."""
    if not wait_for_server():
        pytest.skip("Tautulli server not available")


class TestPathTraversalVulnerability:
    """Test that path traversal attacks are blocked (should FAIL when vulnerable)."""

    def test_basic_path_traversal_etc_passwd(self):
        """
        Test basic path traversal to read /etc/passwd.
        Path: /app/data/interfaces/default/images -> 6 levels up -> / -> etc/passwd
        """
        payload = "/image/images/../../../../../../etc/passwd"
        content = raw_http_get(payload)

        assert "root:" not in content, \
            "Path traversal vulnerability: /etc/passwd content was returned"
        assert "nobody:" not in content, \
            "Path traversal vulnerability: /etc/passwd content was returned"

    def test_path_traversal_5_levels(self):
        """Test path traversal with 5 levels of directory escape."""
        payload = "/image/images/../../../../../etc/passwd"
        content = raw_http_get(payload)

        assert "root:" not in content, \
            "Path traversal with 5 levels succeeded"

    def test_path_traversal_10_levels(self):
        """Test path traversal with 10 levels (excess levels still work)."""
        payload = "/image/images/" + "../" * 10 + "etc/passwd"
        content = raw_http_get(payload)

        assert "root:" not in content, \
            "Path traversal with 10 levels succeeded"

    def test_path_traversal_config_file(self):
        """
        Test path traversal to read Tautulli config.ini.
        Path: /app/data/interfaces/default/images -> 6 levels up -> / -> config/config.ini
        The config file contains sensitive information like API keys.
        """
        payload = "/image/images/../../../../../../config/config.ini"
        content = raw_http_get(payload)

        # Config file contains [General] section and api_key
        assert "[General]" not in content, \
            "Path traversal vulnerability: config.ini was exposed"
        assert "api_key" not in content.lower(), \
            "Path traversal vulnerability: config.ini API key was exposed"

    def test_path_traversal_database(self):
        """
        Test path traversal to read Tautulli database.
        Path: /app/data/interfaces/default/images -> 6 levels up -> / -> config/tautulli.db
        """
        payload = "/image/images/../../../../../../config/tautulli.db"
        content = raw_http_get(payload)

        # SQLite database starts with "SQLite format"
        assert "SQLite format" not in content, \
            "Path traversal vulnerability: database was exposed"

    def test_path_traversal_with_encoded_dots(self):
        """Test path traversal with URL-encoded dots."""
        # URL-encoded version of ../ - %2e = .
        payload = "/image/images/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
        content = raw_http_get(payload)

        assert "root:" not in content, \
            "Path traversal with encoded dots succeeded"

    def test_path_traversal_proc_self(self):
        """Test path traversal to read /proc/self/environ."""
        payload = "/image/images/" + "../" * 6 + "proc/self/environ"
        content = raw_http_get(payload)

        # Environment variables should not be leaked
        assert "PATH=" not in content, \
            "Path traversal vulnerability: /proc/self/environ was exposed"

    def test_path_traversal_app_source(self):
        """
        Test path traversal to read application source code.
        Path: /app/data/interfaces/default/images -> 4 levels up -> /app/Tautulli.py
        """
        payload = "/image/images/../../../../Tautulli.py"
        content = raw_http_get(payload)

        assert "import plexpy" not in content, \
            "Path traversal vulnerability: source code was exposed"


class TestEncodingVariants:
    """Test various encoding techniques for path traversal."""

    def test_traversal_mixed_encoding(self):
        """Test path traversal with partially encoded path."""
        # Mix of encoded and plain traversal - %2f is /
        payload = "/image/images/..%2f..%2f..%2f..%2f..%2f..%2fetc/passwd"
        content = raw_http_get(payload)

        assert "root:" not in content, \
            "Path traversal with mixed encoding succeeded"

    def test_unicode_dot_sequences(self):
        """Test path traversal with unicode dot representation."""
        # Unicode \u002e is just the regular '.' character
        payload = "/image/images/\u002e\u002e/\u002e\u002e/\u002e\u002e/\u002e\u002e/\u002e\u002e/\u002e\u002e/etc/passwd"
        content = raw_http_get(payload)
        assert "root:" not in content, \
            "Unicode traversal succeeded"

    def test_read_webserve_py(self):
        """
        Test reading the vulnerable webserve.py file.
        Path: /app/data/interfaces/default/images -> 4 levels up -> /app/plexpy/webserve.py
        """
        payload = "/image/images/../../../../plexpy/webserve.py"
        content = raw_http_get(payload)

        # webserve.py contains the image() function with @cherrypy.expose
        assert "@cherrypy.expose" not in content, \
            "Path traversal vulnerability: webserve.py source code was exposed"

    def test_read_helpers_py(self):
        """
        Test reading the helpers.py file.
        Path: /app/data/interfaces/default/images -> 4 levels up -> /app/plexpy/helpers.py
        """
        payload = "/image/images/../../../../plexpy/helpers.py"
        content = raw_http_get(payload)

        # helpers.py should have some def statements
        assert "def " not in content, \
            "Path traversal vulnerability: helpers.py source code was exposed"
