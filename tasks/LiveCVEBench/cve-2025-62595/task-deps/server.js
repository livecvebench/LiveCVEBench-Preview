/**
 * Simple Koa test server that exposes endpoints for testing redirect functionality.
 * This server is used to test the back redirect feature.
 */
const Koa = require('koa');
const app = new Koa();

// Health check endpoint
app.use(async (ctx, next) => {
  if (ctx.path === '/health') {
    ctx.status = 200;
    ctx.body = 'OK';
    return;
  }
  await next();
});

// Redirect back endpoint - uses ctx.redirect('back')
app.use(async (ctx, next) => {
  if (ctx.path === '/redirect-back') {
    ctx.redirect('back');
    return;
  }
  await next();
});

// Redirect back with alt parameter - falls back to /home if no valid referrer
app.use(async (ctx, next) => {
  if (ctx.path === '/redirect-back-with-alt') {
    ctx.redirect('back', '/home');
    return;
  }
  await next();
});

// Direct redirect to login
app.use(async (ctx, next) => {
  if (ctx.path === '/redirect-to-login') {
    ctx.redirect('/login');
    return;
  }
  await next();
});

// Direct redirect to external URL (for testing non-back redirects)
app.use(async (ctx, next) => {
  if (ctx.path === '/redirect-to-google') {
    ctx.redirect('https://google.com');
    return;
  }
  await next();
});

// Default response
app.use(async ctx => {
  ctx.body = 'Koa Test Server';
});

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`Server running on http://localhost:${port}`);
});
