"""
Functional tests for SiempreCMS file upload feature.
These tests verify that the file upload works correctly for legitimate use cases.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import os
import tempfile
import time


BASE_URL = os.environ.get("APP_URL", "http://localhost/SiempreCMS")


class TestAuthentication:
    """Test authentication functionality."""

    def test_login_with_valid_credentials(self):
        """Test that login works with correct admin credentials."""
        session = requests.Session()
        response = session.post(
            f"{BASE_URL}/docs/admin/login_ajax.php",
            data={
                "action": "login",
                "username": "admin",
                "password": "admin"
            }
        )
        assert response.status_code == 200
        json_data = response.json()
        assert json_data.get("result") is True, f"Login failed: {json_data}"

    def test_login_with_invalid_credentials(self):
        """Test that login fails with incorrect credentials."""
        session = requests.Session()
        response = session.post(
            f"{BASE_URL}/docs/admin/login_ajax.php",
            data={
                "action": "login",
                "username": "admin",
                "password": "wrongpassword"
            }
        )
        assert response.status_code == 200
        json_data = response.json()
        assert json_data.get("result") is False


class TestFileUploadBasic:
    """Test basic file upload functionality."""

    def test_upload_requires_authentication(self):
        """Test that upload endpoint requires authentication."""
        session = requests.Session()

        # Create a test file
        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b"fake image content for testing")
            temp_path = f.name

        try:
            response = session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/"},
                files={"image": ("test.jpg", open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            # Should indicate not logged in
            assert json_data.get("NotLoggedIn") is True or "Not logged in" in str(json_data)
        finally:
            os.unlink(temp_path)

    def test_upload_valid_image_to_media(self, authenticated_session):
        """Test uploading a valid image to the media directory."""
        # Create a test JPEG file
        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            # Write minimal JPEG header to make it look like real image
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00\x00\x01\x00\x01\x00\x00')
            f.write(b'\x00' * 100)  # padding
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/"},
                files={"image": ("test_upload.jpg", open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            # Should succeed
            assert "successfully" in json_data.get("status", "").lower() or \
                   json_data.get("status") == "Image successfully uploaded!", \
                   f"Upload failed: {json_data}"
        finally:
            os.unlink(temp_path)

    def test_upload_valid_png_to_media(self, authenticated_session):
        """Test uploading a valid PNG image to the media directory."""
        with tempfile.NamedTemporaryFile(suffix=".png", delete=False) as f:
            # Minimal PNG header
            f.write(b'\x89PNG\r\n\x1a\n')
            f.write(b'\x00' * 100)
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/"},
                files={"image": ("test_upload.png", open(temp_path, "rb"), "image/png")}
            )
            assert response.status_code == 200
            json_data = response.json()
            assert "successfully" in json_data.get("status", "").lower() or \
                   json_data.get("status") == "Image successfully uploaded!", \
                   f"PNG upload failed: {json_data}"
        finally:
            os.unlink(temp_path)

    def test_upload_valid_pdf_to_media(self, authenticated_session):
        """Test uploading a valid PDF document to the media directory."""
        with tempfile.NamedTemporaryFile(suffix=".pdf", delete=False) as f:
            # Minimal PDF content
            f.write(b'%PDF-1.4\n%test\n')
            f.write(b'\x00' * 100)
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/"},
                files={"image": ("test_upload.pdf", open(temp_path, "rb"), "application/pdf")}
            )
            assert response.status_code == 200
            json_data = response.json()
            assert "successfully" in json_data.get("status", "").lower() or \
                   json_data.get("status") == "Image successfully uploaded!", \
                   f"PDF upload failed: {json_data}"
        finally:
            os.unlink(temp_path)


class TestFileUploadValidation:
    """Test file upload validation features."""

    def test_reject_php_extension(self, authenticated_session):
        """Test that PHP files are rejected."""
        with tempfile.NamedTemporaryFile(suffix=".php", delete=False) as f:
            f.write(b"<?php phpinfo(); ?>")
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/"},
                files={"image": ("malicious.php", open(temp_path, "rb"), "application/x-php")}
            )
            assert response.status_code == 200
            json_data = response.json()
            # Should be rejected - either "Unsupported file format" or similar error
            status = json_data.get("status", "")
            assert "Unsupported" in status or "Fail" in status or "format" in status.lower(), \
                   f"PHP file should be rejected: {json_data}"
        finally:
            os.unlink(temp_path)

    def test_reject_txt_extension(self, authenticated_session):
        """Test that TXT files are rejected."""
        with tempfile.NamedTemporaryFile(suffix=".txt", delete=False) as f:
            f.write(b"This is a text file")
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/"},
                files={"image": ("test.txt", open(temp_path, "rb"), "text/plain")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")
            assert "Unsupported" in status or "Fail" in status or "format" in status.lower(), \
                   f"TXT file should be rejected: {json_data}"
        finally:
            os.unlink(temp_path)

    def test_reject_exe_extension(self, authenticated_session):
        """Test that EXE files are rejected."""
        with tempfile.NamedTemporaryFile(suffix=".exe", delete=False) as f:
            f.write(b"MZ\x90\x00\x03\x00")  # Minimal PE header
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/"},
                files={"image": ("malicious.exe", open(temp_path, "rb"), "application/x-msdownload")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")
            assert "Unsupported" in status or "Fail" in status or "format" in status.lower(), \
                   f"EXE file should be rejected: {json_data}"
        finally:
            os.unlink(temp_path)

    def test_reject_missing_folder_path(self, authenticated_session):
        """Test that missing folder-path parameter is rejected."""
        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                files={"image": ("test.jpg", open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Missing folder-path should be rejected: {json_data}"
        finally:
            os.unlink(temp_path)

    def test_reject_invalid_folder_path_prefix(self, authenticated_session):
        """Test that folder-path not starting with ../media/ is rejected."""
        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF')
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "/tmp/"},
                files={"image": ("test.jpg", open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            status = json_data.get("status", "")
            assert "Bad request" in status or "folder path" in status.lower(), \
                   f"Invalid prefix should be rejected: {json_data}"
        finally:
            os.unlink(temp_path)


class TestMediaSubdirectories:
    """Test uploading to subdirectories within media."""

    def test_upload_to_images_subdirectory(self, authenticated_session):
        """Test uploading to ../media/images/ subdirectory."""
        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00')
            f.write(b'\x00' * 100)
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/images/"},
                files={"image": ("subdir_test.jpg", open(temp_path, "rb"), "image/jpeg")}
            )
            assert response.status_code == 200
            json_data = response.json()
            # This should succeed - it's a legitimate subdirectory
            assert "successfully" in json_data.get("status", "").lower() or \
                   json_data.get("status") == "Image successfully uploaded!", \
                   f"Upload to images/ subdirectory failed: {json_data}"
        finally:
            os.unlink(temp_path)

    def test_upload_to_documents_subdirectory(self, authenticated_session):
        """Test uploading to ../media/documents/ subdirectory."""
        with tempfile.NamedTemporaryFile(suffix=".pdf", delete=False) as f:
            f.write(b'%PDF-1.4\n%test\n')
            f.write(b'\x00' * 100)
            temp_path = f.name

        try:
            response = authenticated_session.post(
                f"{BASE_URL}/docs/admin/file_upload.php",
                data={"folder-path": "../media/documents/"},
                files={"image": ("subdir_test.pdf", open(temp_path, "rb"), "application/pdf")}
            )
            assert response.status_code == 200
            json_data = response.json()
            # This should succeed - it's a legitimate subdirectory
            assert "successfully" in json_data.get("status", "").lower() or \
                   json_data.get("status") == "Image successfully uploaded!", \
                   f"Upload to documents/ subdirectory failed: {json_data}"
        finally:
            os.unlink(temp_path)
