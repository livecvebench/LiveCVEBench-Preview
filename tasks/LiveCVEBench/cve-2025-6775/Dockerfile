FROM python:3.8-slim

WORKDIR /app

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV FLASK_ENV=production

# Install system dependencies (including required: tmux, asciinema, curl)
RUN apt-get update && apt-get install -y \
    git \
    gcc \
    g++ \
    default-libmysqlclient-dev \
    pkg-config \
    libmaxminddb-dev \
    libffi-dev \
    libgeoip-dev \
    openssh-client \
    curl \
    tmux \
    asciinema \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Clone vulnerable version and remove git history
RUN git clone --branch v1.2.7 --depth 1 https://github.com/xiaoyunjie/openvpn-cms-flask.git . \
    && rm -rf .git

# Copy requirements from task-deps and install Python dependencies
COPY task-deps/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# Copy mock vpnuser script (the vulnerable code calls this binary)
COPY task-deps/vpnuser /usr/local/bin/vpnuser
RUN chmod +x /usr/local/bin/vpnuser

# Update database config for Docker: change localhost to mysql
RUN sed -i 's|mysql+cymysql://root:openvpn@localhost|mysql+cymysql://root:openvpn@mysql|g' app/config/secure.py

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# CMD ["/entrypoint.sh"]
