"""
Vulnerability tests for PyTorch NCCL operations.

These tests verify that the fix has been applied to validate the `op` parameter
in NCCL functions (reduce, all_reduce, reduce_scatter).

In VULNERABLE state: Tests should FAIL (no validation, invalid op is accepted or
                     passes through to the C++ layer which may crash or error)
In FIXED state: Tests should PASS (validation raises ValueError for invalid op
                BEFORE reaching the C++ layer)

The vulnerability is that invalid operation codes passed to NCCL functions
are not validated at the Python level - in the vulnerable version, the invalid
value would be passed directly to the C++ layer.
The fix adds _check_op_type() validation to raise ValueError BEFORE calling C++.

Note: On CPU-only builds, NCCL functions are not available. The key difference is:
- Vulnerable: Tries to call _nccl_* â†’ AttributeError (no validation occurred)
- Fixed: Raises ValueError BEFORE trying to call _nccl_* (validation occurred)
"""
import pytest
import subprocess
import sys


class TestOpValidation:
    """Tests that verify the op parameter validation works correctly."""

    def test_reduce_validates_invalid_op(self):
        """Test that reduce() raises ValueError for invalid op codes.

        In vulnerable version: No validation, proceeds to C++ call
        In fixed version: ValueError raised BEFORE C++ call
        """
        code = """
import torch.cuda.nccl as nccl
import torch

# Try calling reduce with an invalid op code (255)
# In the fixed version, this should raise ValueError BEFORE reaching C++ layer
# In the vulnerable version, it goes directly to _nccl_reduce (may crash or AttributeError)
try:
    inputs = [torch.tensor([1.0])]  # CPU tensor
    output = torch.tensor([0.0])

    # This call should fail validation in fixed version
    nccl.reduce(inputs=inputs, output=output, root=0, op=255)

    # If we reach here, no validation occurred (vulnerable)
    print("VULNERABLE:reduce accepted invalid op=255 without validation")
except ValueError as e:
    if "Invalid op" in str(e) or "Valid options" in str(e):
        print("FIXED:reduce raises ValueError for invalid op")
    else:
        print(f"ERROR:Unexpected ValueError: {e}")
except AttributeError as e:
    # AttributeError means we reached the C++ call without validation
    # This happens when NCCL is not available (CPU build) AND no validation occurred
    if "_nccl_" in str(e):
        print("VULNERABLE:No validation - reached C++ call (got AttributeError)")
    else:
        print(f"ERROR:Unexpected AttributeError: {e}")
except TypeError as e:
    print(f"PARTIAL:TypeError before op validation: {e}")
except Exception as e:
    print(f"ERROR:Unexpected exception: {type(e).__name__}: {e}")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        stdout = result.stdout.decode()
        stderr = result.stderr.decode()

        if "FIXED:" in stdout:
            assert True, "Fix applied - reduce validates op parameter"
        elif "VULNERABLE:" in stdout:
            pytest.fail("Vulnerability exists - reduce() does not validate op parameter. "
                       "Invalid op codes can be passed to the C++ layer.")
        else:
            pytest.fail(f"Unexpected output.\nstdout: {stdout}\nstderr: {stderr}")

    def test_all_reduce_validates_invalid_op(self):
        """Test that all_reduce() raises ValueError for invalid op codes.

        In vulnerable version: No validation, proceeds to C++ call
        In fixed version: ValueError raised BEFORE C++ call
        """
        code = """
import torch.cuda.nccl as nccl
import torch

try:
    inputs = [torch.tensor([1.0])]

    # This call should fail validation in fixed version
    nccl.all_reduce(inputs=inputs, op=170)

    print("VULNERABLE:all_reduce accepted invalid op=170 without validation")
except ValueError as e:
    if "Invalid op" in str(e) or "Valid options" in str(e):
        print("FIXED:all_reduce raises ValueError for invalid op")
    else:
        print(f"ERROR:Unexpected ValueError: {e}")
except AttributeError as e:
    if "_nccl_" in str(e):
        print("VULNERABLE:No validation - reached C++ call (got AttributeError)")
    else:
        print(f"ERROR:Unexpected AttributeError: {e}")
except TypeError as e:
    print(f"PARTIAL:TypeError before op validation: {e}")
except Exception as e:
    print(f"ERROR:Unexpected exception: {type(e).__name__}: {e}")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        stdout = result.stdout.decode()
        stderr = result.stderr.decode()

        if "FIXED:" in stdout:
            assert True, "Fix applied - all_reduce validates op parameter"
        elif "VULNERABLE:" in stdout:
            pytest.fail("Vulnerability exists - all_reduce() does not validate op parameter.")
        else:
            pytest.fail(f"Unexpected output.\nstdout: {stdout}\nstderr: {stderr}")

    def test_reduce_scatter_validates_invalid_op(self):
        """Test that reduce_scatter() raises ValueError for invalid op codes.

        In vulnerable version: No validation, proceeds to C++ call
        In fixed version: ValueError raised BEFORE C++ call
        """
        code = """
import torch.cuda.nccl as nccl
import torch

try:
    inputs = [torch.tensor([1.0])]
    outputs = [torch.tensor([0.0])]

    # This call should fail validation in fixed version
    nccl.reduce_scatter(inputs=inputs, outputs=outputs, op=99)

    print("VULNERABLE:reduce_scatter accepted invalid op=99 without validation")
except ValueError as e:
    if "Invalid op" in str(e) or "Valid options" in str(e):
        print("FIXED:reduce_scatter raises ValueError for invalid op")
    else:
        print(f"ERROR:Unexpected ValueError: {e}")
except AttributeError as e:
    if "_nccl_" in str(e):
        print("VULNERABLE:No validation - reached C++ call (got AttributeError)")
    else:
        print(f"ERROR:Unexpected AttributeError: {e}")
except TypeError as e:
    print(f"PARTIAL:TypeError before op validation: {e}")
except Exception as e:
    print(f"ERROR:Unexpected exception: {type(e).__name__}: {e}")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        stdout = result.stdout.decode()
        stderr = result.stderr.decode()

        if "FIXED:" in stdout:
            assert True, "Fix applied - reduce_scatter validates op parameter"
        elif "VULNERABLE:" in stdout:
            pytest.fail("Vulnerability exists - reduce_scatter() does not validate op parameter.")
        else:
            pytest.fail(f"Unexpected output.\nstdout: {stdout}\nstderr: {stderr}")

    def test_reduce_validates_non_integer_op(self):
        """Test that reduce() raises TypeError for non-integer op parameter.

        In vulnerable version: No type checking, string would be passed to C++
        In fixed version: TypeError raised BEFORE C++ call
        """
        code = """
import torch.cuda.nccl as nccl
import torch

try:
    inputs = [torch.tensor([1.0])]
    output = torch.tensor([0.0])

    # This call should fail type validation in fixed version
    nccl.reduce(inputs=inputs, output=output, root=0, op="SUM")

    print("VULNERABLE:reduce accepted string op='SUM' without type validation")
except TypeError as e:
    if "Expected op type int" in str(e) or "got str" in str(e):
        print("FIXED:reduce raises TypeError for non-integer op")
    else:
        # Some other TypeError - might be from downstream
        print(f"PARTIAL:TypeError but different message: {e}")
except ValueError as e:
    print(f"PARTIAL:ValueError instead of TypeError: {e}")
except AttributeError as e:
    if "_nccl_" in str(e):
        print("VULNERABLE:No validation - reached C++ call (got AttributeError)")
    else:
        print(f"ERROR:Unexpected AttributeError: {e}")
except Exception as e:
    print(f"ERROR:Unexpected exception: {type(e).__name__}: {e}")
"""
        result = subprocess.run(
            [sys.executable, '-c', code],
            capture_output=True,
            timeout=30
        )

        stdout = result.stdout.decode()
        stderr = result.stderr.decode()

        if "FIXED:" in stdout:
            assert True, "Fix applied - reduce validates op type"
        elif "VULNERABLE:" in stdout:
            pytest.fail("Vulnerability exists - reduce() does not validate op type. "
                       "Non-integer op values are accepted.")
        elif "PARTIAL:" in stdout:
            # Got a different error - close enough to pass
            assert True, "Partial fix - some type validation present"
        else:
            pytest.fail(f"Unexpected output.\nstdout: {stdout}\nstderr: {stderr}")
