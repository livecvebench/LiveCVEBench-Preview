"""
Functional tests to verify the admin login functionality works correctly.
These tests should PASS in both vulnerable and fixed states.
"""
import requests
import pytest

BASE_URL = "http://localhost/cts"
LOGIN_URL = f"{BASE_URL}/classes/Login.php?f=login"


class TestValidAuthentication:
    """Tests for valid login functionality."""

    def test_valid_admin_login(self):
        """Test that valid admin credentials allow login."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "admin", "password": "admin123"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("status") == "success", f"Expected success, got: {data}"

    def test_login_endpoint_accessible(self):
        """Test that the login endpoint is accessible."""
        response = requests.get(LOGIN_URL, timeout=10)
        # Even GET without proper action should respond
        assert response.status_code == 200


class TestInvalidAuthentication:
    """Tests for invalid login attempts."""

    def test_wrong_password(self):
        """Test that wrong password is rejected."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "admin", "password": "wrongpassword"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("status") == "incorrect", f"Expected incorrect, got: {data}"

    def test_nonexistent_user(self):
        """Test that nonexistent user is rejected."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "nonexistent_user_12345", "password": "anypassword"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("status") == "incorrect", f"Expected incorrect, got: {data}"

    def test_empty_credentials(self):
        """Test that empty credentials are rejected."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "", "password": ""},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("status") == "incorrect", f"Expected incorrect, got: {data}"

    def test_missing_username(self):
        """Test that missing username is handled."""
        response = requests.post(
            LOGIN_URL,
            data={"password": "admin123"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        # Should not successfully authenticate
        assert data.get("status") != "success" or data.get("status") == "incorrect"

    def test_missing_password(self):
        """Test that missing password is handled."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "admin"},
            timeout=10
        )
        assert response.status_code == 200
        data = response.json()
        assert data.get("status") == "incorrect", f"Expected incorrect, got: {data}"


class TestResponseFormat:
    """Tests for proper response format."""

    def test_response_is_json(self):
        """Test that response is valid JSON."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "admin", "password": "admin123"},
            timeout=10
        )
        assert response.status_code == 200
        # Should not raise exception
        data = response.json()
        assert "status" in data

    def test_success_response_format(self):
        """Test successful login response format."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "admin", "password": "admin123"},
            timeout=10
        )
        data = response.json()
        assert "status" in data
        assert data["status"] == "success"

    def test_failure_response_format(self):
        """Test failed login response format."""
        response = requests.post(
            LOGIN_URL,
            data={"username": "admin", "password": "wrong"},
            timeout=10
        )
        data = response.json()
        assert "status" in data
        assert data["status"] == "incorrect"
