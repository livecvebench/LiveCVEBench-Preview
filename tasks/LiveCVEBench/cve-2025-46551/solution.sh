#!/bin/bash
# Solution script to fix the hostname verification issue in jruby-openssl
# This script modifies the DEFAULT_PARAMS in lib/openssl/ssl.rb to enable
# hostname verification by default.

set -e

echo "Applying hostname verification fix..."

# Find the jruby-openssl gem location dynamically
OPENSSL_GEM_PATH=$(jruby -e "puts Gem::Specification.find_by_name('jruby-openssl').gem_dir" 2>/dev/null)

if [ -z "$OPENSSL_GEM_PATH" ]; then
    echo "Error: Could not find jruby-openssl gem path"
    exit 1
fi

SSL_FILE="$OPENSSL_GEM_PATH/lib/openssl/ssl.rb"

if [ ! -f "$SSL_FILE" ]; then
    echo "Error: Cannot find ssl.rb at $SSL_FILE"
    exit 1
fi

echo "Found ssl.rb at: $SSL_FILE"

# Check if already fixed (idempotent)
if grep -q ':verify_hostname => true,' "$SSL_FILE"; then
    echo "Fix already applied (verify_hostname is already true)"
    exit 0
fi

# Check if the vulnerable line exists
if ! grep -q ':verify_hostname => nil' "$SSL_FILE"; then
    echo "Warning: Could not find vulnerable line in $SSL_FILE"
    echo "The file may have already been modified or has a different format."
    # Check current state
    jruby -e "require 'openssl'; puts 'Current verify_hostname: ' + OpenSSL::SSL::SSLContext::DEFAULT_PARAMS[:verify_hostname].inspect"
    exit 0
fi

# Apply the fix using sed
# Replace the vulnerable line with the fixed version
sed -i.bak 's/:verify_hostname => nil, # TODO => true needs JRuby support to call verify_certificate_identity/:verify_hostname => true,/g' "$SSL_FILE"

# Verify the fix was applied
if grep -q ':verify_hostname => true,' "$SSL_FILE"; then
    echo "Fix applied successfully!"
    echo ""
    echo "Verifying fix..."
    jruby -e "require 'openssl'; vh = OpenSSL::SSL::SSLContext::DEFAULT_PARAMS[:verify_hostname]; puts 'verify_hostname is now: ' + vh.inspect; exit(vh == true ? 0 : 1)"
    echo ""
    echo "Hostname verification is now enabled by default."
else
    echo "Error: Fix was not applied correctly"
    # Restore backup
    if [ -f "${SSL_FILE}.bak" ]; then
        mv "${SSL_FILE}.bak" "$SSL_FILE"
    fi
    exit 1
fi

# Clean up backup file
rm -f "${SSL_FILE}.bak"

echo "Fix complete."
