#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "Installing uv..."
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

echo "Setting up test environment..."
uv init 2>/dev/null || true
uv add pytest requests 2>/dev/null

# Wait for the web server to be ready
echo "Waiting for web server..."
for i in {1..60}; do
    if curl -s http://localhost/controller/api/orderList.php > /dev/null 2>&1; then
        echo "Web server is ready"
        break
    fi
    if [ $i -eq 60 ]; then
        echo "Warning: Web server may not be fully ready, proceeding with tests..."
    fi
    sleep 1
done

# Ensure the user table exists in the database (may be missing or dropped)
echo "Ensuring user table exists..."
mysql -h db -u root -proot db_Hotel -e "
CREATE TABLE IF NOT EXISTS \`user\` (
  \`id\` int(10) NOT NULL AUTO_INCREMENT COMMENT 'id',
  \`telephone\` varchar(11) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '手机号',
  \`gender\` varchar(4) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL DEFAULT '男' COMMENT '性别',
  \`birthday\` varchar(10) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '生日',
  \`password\` varchar(100) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '密码',
  \`avator\` varchar(100) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '头像',
  \`account\` int(20) NOT NULL DEFAULT '0' COMMENT '账户余额',
  \`nickname\` varchar(30) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL COMMENT '昵称',
  PRIMARY KEY (\`id\`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

INSERT IGNORE INTO \`user\` (\`id\`, \`telephone\`, \`gender\`, \`birthday\`, \`password\`, \`avator\`, \`account\`, \`nickname\`) VALUES
(1, '15757118174', '男', '1995-02-20', '123456', '', 0, '大忙人'),
(2, '15757118111', '男', '2009-3-24', '123456', 'avator/7e5443fff29b245a0e6f127ea51c9cb1.jpg', 0, '陈独秀'),
(3, '15757118133', '', '', '123456', '', 0, '胡德全');
" 2>/dev/null || echo "Warning: Could not ensure user table"
echo "Database initialization complete!"

echo "Running tests..."
uv run pytest . -rA -v
