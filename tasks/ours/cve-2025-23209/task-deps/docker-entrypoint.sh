#!/bin/bash
set -e

echo "Waiting for MySQL to be ready..."
for i in {1..60}; do
    if mysql -h"$CRAFT_DB_SERVER" -u"$CRAFT_DB_USER" -p"$CRAFT_DB_PASSWORD" --skip-ssl -e "SELECT 1" &> /dev/null; then
        echo "MySQL is ready!"
        break
    fi
    echo "MySQL is not ready, waiting... (attempt $i)"
    sleep 2
    if [ $i -eq 60 ]; then
        echo "MySQL connection timeout"
        exit 1
    fi
done

cd /var/www/html

# Create craft CLI file if it doesn't exist (required for Craft 5)
if [ ! -f /var/www/html/craft ]; then
    echo "Creating craft CLI file..."
    cat > /var/www/html/craft << 'CRAFTEOF'
#!/usr/bin/env php
<?php
define("CRAFT_BASE_PATH", __DIR__);
define("CRAFT_VENDOR_PATH", CRAFT_BASE_PATH . "/vendor");
require_once CRAFT_VENDOR_PATH . "/autoload.php";
define("CRAFT_ENVIRONMENT", getenv("CRAFT_ENVIRONMENT") ?: "production");
$app = require CRAFT_VENDOR_PATH . "/craftcms/cms/bootstrap/console.php";
$exitCode = $app->run();
exit($exitCode);
CRAFTEOF
    chmod +x /var/www/html/craft
    chown www-data:www-data /var/www/html/craft
fi

# Check if Craft is already installed
if [ ! -f /var/www/html/.craft_installed ]; then
    echo "Installing Craft CMS..."

    # Run Craft install command (non-interactive)
    php /var/www/html/craft install \
        --email=admin@example.com \
        --username=admin \
        --password=password123 \
        --siteName="CVE Test Site" \
        --siteUrl="http://localhost" \
        --language=en-US \
        --interactive=0 || true

    # Mark as installed
    touch /var/www/html/.craft_installed
    echo "Craft CMS installed!"
else
    echo "Craft CMS already installed."
fi

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
