#!/usr/bin/env python3
"""
Functionality tests for Oak header parsing.

These tests verify that the basic functionality still works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost:8000"
TIMEOUT = 10


def wait_for_server(max_retries=30, delay=1):
    """Wait for the server to be ready."""
    for i in range(max_retries):
        try:
            response = requests.get(BASE_URL, timeout=5)
            return True
        except requests.exceptions.RequestException:
            if i < max_retries - 1:
                time.sleep(delay)
    return False


class TestIPParsing:
    """Test that X-Forwarded-For header is correctly parsed."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is ready before tests."""
        assert wait_for_server(), "Server failed to start"

    def test_single_ip(self):
        """Single IP should be correctly parsed."""
        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": "10.10.10.10"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["ip"] == "10.10.10.10"
        assert data["ips"] == ["10.10.10.10"]

    def test_multiple_ips(self):
        """Multiple comma-separated IPs should be correctly parsed."""
        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": "10.10.10.10, 192.168.1.1, 10.255.255.255"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["ip"] == "10.10.10.10"
        assert "10.10.10.10" in data["ips"]
        assert "192.168.1.1" in data["ips"]
        assert "10.255.255.255" in data["ips"]

    def test_ips_with_extra_whitespace(self):
        """IPs with whitespace around commas should be correctly trimmed."""
        # Note: We test whitespace AROUND commas (not leading/trailing in the whole header)
        # because the requests library rejects headers with leading/trailing whitespace
        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": "10.10.10.10 , 192.168.1.1"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        # After fix, whitespace should be trimmed
        assert data["ip"] == "10.10.10.10"
        # IPs should be present (trimmed)
        assert len(data["ips"]) >= 2

    def test_empty_entries_filtered(self):
        """Empty entries between commas should be filtered out."""
        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": "10.10.10.10,,192.168.1.1,,,10.0.0.1"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        # Should have exactly 3 IPs (empty entries filtered)
        # In vulnerable version, this might include empty strings
        # In fixed version, empty entries should be filtered
        assert data["ip"] == "10.10.10.10"

    def test_ipv6_addresses(self):
        """IPv6 addresses should be correctly parsed."""
        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": "2001:db8::1, 10.0.0.1"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["ip"] == "2001:db8::1"

    def test_no_forwarded_header(self):
        """Request without X-Forwarded-For should still work."""
        response = requests.get(BASE_URL, timeout=TIMEOUT)
        assert response.status_code == 200
        data = response.json()
        # Should get some IP (even if it's the direct connection IP)
        assert "ip" in data
        assert "ips" in data


class TestProtocolParsing:
    """Test that X-Forwarded-Proto header is correctly parsed."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is ready before tests."""
        assert wait_for_server(), "Server failed to start"

    def test_https_protocol(self):
        """HTTPS protocol should be correctly recognized."""
        response = requests.get(
            BASE_URL,
            headers={
                "X-Forwarded-Proto": "https",
                "X-Forwarded-For": "10.0.0.1"
            },
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["protocol"] == "https:"

    def test_http_protocol(self):
        """HTTP protocol should be correctly recognized."""
        response = requests.get(
            BASE_URL,
            headers={
                "X-Forwarded-Proto": "http",
                "X-Forwarded-For": "10.0.0.1"
            },
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["protocol"] == "http:"

    def test_uppercase_https(self):
        """Uppercase HTTPS should be recognized (case-insensitive)."""
        response = requests.get(
            BASE_URL,
            headers={
                "X-Forwarded-Proto": "HTTPS",
                "X-Forwarded-For": "10.0.0.1"
            },
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        # After fix, should normalize to lowercase https:
        # Before fix, might be uppercase or cause issues
        assert data["protocol"].lower() == "https:"

    def test_protocol_with_whitespace(self):
        """Protocol with whitespace around it should be handled."""
        # Note: We test whitespace AROUND comma (not leading/trailing in whole header)
        # because the requests library rejects headers with leading/trailing whitespace
        response = requests.get(
            BASE_URL,
            headers={
                "X-Forwarded-Proto": "https ,http",
                "X-Forwarded-For": "10.0.0.1"
            },
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        # Should work - may be https: (trimmed) or http: (fallback if invalid)
        assert data["protocol"] in ["https:", "http:"]

    def test_first_protocol_in_chain(self):
        """First protocol in comma-separated list should be used."""
        response = requests.get(
            BASE_URL,
            headers={
                "X-Forwarded-Proto": "https, http",
                "X-Forwarded-For": "10.0.0.1"
            },
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["protocol"] == "https:"

    def test_no_forwarded_proto(self):
        """Request without X-Forwarded-Proto should default to http."""
        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": "10.0.0.1"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["protocol"] == "http:"


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is ready before tests."""
        assert wait_for_server(), "Server failed to start"

    def test_reasonable_number_of_ips(self):
        """A reasonable number of IPs should be processed correctly."""
        ips = [f"10.0.0.{i}" for i in range(1, 51)]  # 50 IPs
        header_value = ", ".join(ips)

        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": header_value},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        assert data["ip"] == "10.0.0.1"
        assert len(data["ips"]) >= 50

    def test_entry_limit_enforced(self):
        """
        Very large number of IPs should be limited (after fix).
        The fix limits to 100 entries.
        """
        ips = [f"10.0.{i // 256}.{i % 256}" for i in range(1, 201)]  # 200 IPs
        header_value = ", ".join(ips)

        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": header_value},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        data = response.json()
        # After fix: should be capped at 100
        # Before fix: might be all 200
        # Either way, request should succeed
        assert data["ip"] == "10.0.0.1"
        assert len(data["ips"]) >= 1

    def test_special_characters_in_header(self):
        """Special characters should not cause crashes."""
        response = requests.get(
            BASE_URL,
            headers={"X-Forwarded-For": "10.0.0.1, <test>, 192.168.1.1"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        # Should not crash


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
