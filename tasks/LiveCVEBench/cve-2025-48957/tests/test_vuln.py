"""
Vulnerability tests for AstrBot path traversal.

These tests verify whether the path traversal vulnerability exists.
- In VULNERABLE state: tests should FAIL (vulnerability is exploitable)
- In FIXED state: tests should PASS (vulnerability is mitigated)

The tests send real HTTP requests to trigger the vulnerability,
not static code analysis.
"""

import os
import time
import requests

BASE_URL = os.environ.get("APP_URL", "http://localhost:6185")
TIMEOUT = 10


def wait_for_app(max_retries=30, delay=2):
    """Wait for the application to be ready."""
    for _ in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code in [200, 302, 401]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
    return False


class TestPathTraversalBlocked:
    """Test that path traversal attacks are blocked after fix."""

    def setup_method(self):
        """Ensure app is ready before each test."""
        assert wait_for_app(), "Application did not start in time"

    def test_config_file_traversal_blocked(self):
        """
        Test that path traversal to read config files is blocked.
        Payload: ../../../data/cmd_config.json
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../data/cmd_config.json"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        # After fix, should NOT return the config file content
        content = response.text

        # Check that sensitive data is NOT exposed
        assert "sk-MOCK-API-KEY" not in content, "Config file API key exposed - path traversal vulnerability present"
        assert "sk-ant-MOCK-KEY" not in content, "Config file API key exposed - path traversal vulnerability present"
        assert "password_md5" not in content, "Config file password hash exposed - path traversal vulnerability present"
        assert "5f4dcc3b5aa765d61d8327deb882cf99" not in content, "Config file MD5 hash exposed - path traversal vulnerability present"

    def test_etc_passwd_traversal_blocked(self):
        """
        Test that path traversal to read /etc/passwd is blocked.
        Payload: ../../../../../../../etc/passwd (7 levels up)
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../../../../../etc/passwd"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text

        # After fix, should NOT return /etc/passwd content
        assert "root:" not in content, "/etc/passwd content exposed - path traversal vulnerability present"
        assert "root:x:0:0" not in content, "/etc/passwd content exposed - path traversal vulnerability present"
        assert "/bin/bash" not in content or "error" in content.lower(), "System file content exposed"

    def test_etc_passwd_alternative_depth(self):
        """
        Test path traversal with different directory depth.
        Payload: ../../../../../../../../etc/passwd (8 levels up)
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../../../../../../etc/passwd"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text
        assert "root:" not in content, "/etc/passwd content exposed with deeper traversal"

    def test_main_py_traversal_blocked(self):
        """
        Test that path traversal to read application source code is blocked.
        Payload: ../../../main.py
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../main.py"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text

        # After fix, should NOT return main.py content
        # main.py typically contains import statements and entry point code
        assert "if __name__" not in content, "Application source code exposed - path traversal vulnerability present"
        assert "import astrbot" not in content.lower(), "Application source code exposed - path traversal vulnerability present"

    def test_pyproject_traversal_blocked(self):
        """
        Test that path traversal to read pyproject.toml is blocked.
        Payload: ../../../pyproject.toml
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../pyproject.toml"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text

        # After fix, should NOT return pyproject.toml content
        assert "[project]" not in content, "pyproject.toml exposed - path traversal vulnerability present"
        assert "astrbot" not in content.lower() or "error" in content.lower(), "Project metadata exposed"


class TestEncodedPathTraversal:
    """Test various encoding bypass attempts."""

    def setup_method(self):
        """Ensure app is ready before each test."""
        assert wait_for_app(), "Application did not start in time"

    def test_double_dot_slash_variations(self):
        """
        Test various ../ encoding variations.
        """
        payloads = [
            "../../../data/cmd_config.json",      # Standard
            "..%2F..%2F..%2Fdata/cmd_config.json", # URL encoded slash
            "..\\..\\..\\data/cmd_config.json",   # Backslash
            "....//....//....//data/cmd_config.json",  # Double dots
        ]

        for payload in payloads:
            response = requests.get(
                f"{BASE_URL}/api/chat/get_file",
                params={"filename": payload},
                allow_redirects=True,
                timeout=TIMEOUT
            )

            content = response.text
            assert "sk-MOCK-API-KEY" not in content, f"Config exposed with payload: {payload}"
            assert "password_md5" not in content, f"Config exposed with payload: {payload}"

    def test_absolute_path_blocked(self):
        """
        Test that absolute paths are blocked.
        Payload: /etc/passwd
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "/etc/passwd"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text
        # Should not return /etc/passwd even with absolute path
        assert "root:" not in content, "Absolute path /etc/passwd exposed"


class TestPathTraversalWithBasenameBypasses:
    """Test that basename extraction properly neutralizes attacks."""

    def setup_method(self):
        """Ensure app is ready before each test."""
        assert wait_for_app(), "Application did not start in time"

    def test_basename_reduces_to_filename_only(self):
        """
        After fix, ../../../etc/passwd should be reduced to just 'passwd',
        which won't exist in the imgs directory.
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../../../../../etc/passwd"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text

        # The content should be an error (file not found in imgs dir)
        # or empty, but NOT the /etc/passwd content
        assert "root:" not in content
        assert "root:x:0:0" not in content

    def test_nested_traversal_sequences(self):
        """
        Test deeply nested traversal sequences.
        Payload: Multiple levels of ../
        """
        payload = "../" * 15 + "etc/passwd"

        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": payload},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text
        assert "root:" not in content, "Deeply nested traversal exposed /etc/passwd"


class TestInvalidPathHandling:
    """Test that invalid paths return proper errors."""

    def setup_method(self):
        """Ensure app is ready before each test."""
        assert wait_for_app(), "Application did not start in time"

    def test_traversal_returns_error_or_not_found(self):
        """
        After fix, path traversal should return error message or 404,
        not the target file content.
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../data/cmd_config.json"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text.lower()

        # Should indicate error or file not found, not sensitive data
        has_error_indication = (
            "error" in content or
            "not found" in content or
            "invalid" in content or
            "access" in content or
            response.status_code in [400, 401, 403, 404]
        )

        has_sensitive_data = (
            "sk-mock" in content or
            "api_key" in content or
            "password_md5" in content
        )

        assert not has_sensitive_data, "Sensitive data exposed in response"
        # If we get a 200, it should contain an error message
        if response.status_code == 200:
            assert has_error_indication or len(content) < 100, "Response should indicate error for traversal attempt"

    def test_etc_shadow_blocked(self):
        """
        Test that /etc/shadow cannot be read (additional sensitive file).
        """
        response = requests.get(
            f"{BASE_URL}/api/chat/get_file",
            params={"filename": "../../../../../../../etc/shadow"},
            allow_redirects=True,
            timeout=TIMEOUT
        )

        content = response.text

        # /etc/shadow contains password hashes - should never be exposed
        # Even if file access fails, verify it's not exposed
        assert "root:" not in content or "!" in content[:50] or "error" in content.lower()
