cat <<'EOF' > /workspace/fix.patch
diff --git a/lib/appSession.js b/lib/appSession.js
index 9be1fce..3c34d67 100644
--- a/lib/appSession.js
+++ b/lib/appSession.js
@@ -15,6 +15,9 @@ const debug = require('./debug')('appSession');
 const epoch = () => (Date.now() / 1000) | 0;
 const MAX_COOKIE_SIZE = 4096;
 
+const REASSIGN = Symbol('reassign');
+const REGENERATED_SESSION_ID = Symbol('regenerated_session_id');
+
 function attachSessionObject(req, sessionName, value) {
   Object.defineProperty(req, sessionName, {
     enumerable: true,
@@ -22,7 +25,7 @@ function attachSessionObject(req, sessionName, value) {
       return value;
     },
     set(arg) {
-      if (arg === null || arg === undefined) {
+      if (arg === null || arg === undefined || arg[REASSIGN]) {
         value = arg;
       } else {
         throw new TypeError('session object cannot be reassigned');
@@ -32,6 +35,17 @@ function attachSessionObject(req, sessionName, value) {
   });
 }
 
+function regenerateSessionStoreId(req, config) {
+  if (config.session.store) {
+    req[REGENERATED_SESSION_ID] = config.session.genid(req);
+  }
+}
+
+function replaceSession(req, session, config) {
+  session[REASSIGN] = true;
+  req[config.session.name] = session;
+}
+
 module.exports = (config) => {
   let current;
 
@@ -175,7 +189,7 @@ module.exports = (config) => {
       };
     }
 
-    setCookie(id, req, res, iat) {
+    setCookie(req, res, iat) {
       setCookie(req, res, iat);
     }
   }
@@ -197,12 +211,14 @@ module.exports = (config) => {
       res,
       { uat = epoch(), iat = uat, exp = calculateExp(iat, uat) }
     ) {
-      if (!req[sessionName] || !Object.keys(req[sessionName]).length) {
-        if (req[COOKIES][sessionName]) {
-          await this._destroy(id);
-        }
-      } else {
-        await this._set(id, {
+      const hasPrevSession = !!req[COOKIES][sessionName];
+      const replacingPrevSession = !!req[REGENERATED_SESSION_ID];
+      const hasCurrentSession = req[sessionName] && Object.keys(req[sessionName]).length;
+      if (hasPrevSession && (replacingPrevSession || !hasCurrentSession)) {
+        await this._destroy(id);
+      }
+      if (hasCurrentSession) {
+        await this._set(req[REGENERATED_SESSION_ID] || id, {
           header: { iat, uat, exp },
           data: req[sessionName],
         });
@@ -233,7 +249,8 @@ module.exports = (config) => {
     }
   }
 
-  const store = config.session.store
+  const isCustomStore = !!config.session.store;
+  const store = isCustomStore
     ? new CustomStore(config.session.store)
     : new CookieStore();
 
@@ -330,11 +347,13 @@ module.exports = (config) => {
       attachSessionObject(req, sessionName, {});
     }
 
-    const id = existingSessionValue || generateId(req);
+    if (isCustomStore) {
+      const id = existingSessionValue || generateId(req);
 
-    onHeaders(res, () => store.setCookie(id, req, res, { iat }));
+      onHeaders(res, () =>
+        store.setCookie(req[REGENERATED_SESSION_ID] || id, req, res, { iat })
+      );
 
-    if (store.set) {
       const { end: origEnd } = res;
       res.end = async function resEnd(...args) {
         try {
@@ -349,8 +368,15 @@ module.exports = (config) => {
           process.nextTick(() => next(e));
         }
       };
+    } else {
+      onHeaders(res, () =>
+        store.setCookie(req, res, { iat })
+      );
     }
 
     return next();
   };
 };
+
+module.exports.regenerateSessionStoreId = regenerateSessionStoreId;
+module.exports.replaceSession = replaceSession;
diff --git a/middleware/auth.js b/middleware/auth.js
index c13a949..68cae12 100644
--- a/middleware/auth.js
+++ b/middleware/auth.js
@@ -10,6 +10,7 @@ const attemptSilentLogin = require('./attemptSilentLogin');
 const TransientCookieHandler = require('../lib/transientHandler');
 const { RequestContext, ResponseContext } = require('../lib/context');
 const appSession = require('../lib/appSession');
+const { regenerateSessionStoreId, replaceSession } = appSession;
 const { decodeState } = require('../lib/hooks/getLoginState');
 
 const enforceLeadingSlash = (path) => {
@@ -83,7 +84,7 @@ const auth = function (params) {
         try {
           const redirectUri = res.oidc.getRedirectUri();
 
-          let session;
+          let tokenSet;
 
           try {
             const callbackParams = client.callbackParams(req);
@@ -110,7 +111,7 @@ const auth = function (params) {
               extras = { exchangeBody: config.tokenEndpointParams };
             }
 
-            session = await client.callback(
+            tokenSet = await client.callback(
               redirectUri,
               callbackParams,
               checks,
@@ -120,16 +121,35 @@ const auth = function (params) {
             throw createError.BadRequest(err.message);
           }
 
+          let session = Object.assign({}, tokenSet); // Remove non-enumerable methods from the TokenSet
+
           if (config.afterCallback) {
             session = await config.afterCallback(
               req,
               res,
-              Object.assign({}, session), // Remove non-enumerable methods from the TokenSet
+              session,
               req.openidState
             );
           }
 
-          Object.assign(req[config.session.name], session);
+          if (req.oidc.isAuthenticated()) {
+            if (req.oidc.user.sub === tokenSet.claims().sub) {
+              // If it's the same user logging in again, just update the existing session.
+              Object.assign(req[config.session.name], session);
+            } else {
+              // If it's a different user, replace the session to remove any custom user
+              // properties on the session
+              replaceSession(req, session, config);
+              // And regenerate the session id so the previous user wont know the new user's session id
+              regenerateSessionStoreId(req, config);
+            }
+          } else {
+            // If a new user is replacing an anonymous session, update the existing session to keep
+            // any anonymous session state (eg. checkout basket)
+            Object.assign(req[config.session.name], session);
+            // But update the session store id so a previous anonymous user wont know the new user's session id
+            regenerateSessionStoreId(req, config);
+          }
           attemptSilentLogin.resumeSilentLogin(req, res);
 
           next();


EOF

cd /workspace/express-openid-connect
git apply --whitespace=nowarn  /workspace/fix.patch