#!/bin/bash
# Solution script for Vvveb CMS editor file access issue
# This script adds proper validation to the editor URL and template parameters
set -e

echo "Applying fix to Vvveb CMS editor..."

# Target file location
TARGET_FILE="/var/www/html/admin/controller/editor/editor.php"

# Verify file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo "Error: Target file not found at $TARGET_FILE"
    exit 1
fi

# Create backup
cp "$TARGET_FILE" "${TARGET_FILE}.bak"

# Primary approach: Use the pre-patched file from task-deps
if [ -f "/task-deps/editor-1.0.6.php" ]; then
    echo "Applying fix using patched file..."
    cp /task-deps/editor-1.0.6.php "$TARGET_FILE"
    echo "Fix applied by replacing with patched version"
else
    echo "Patched file not found, applying fix via PHP script..."

    # Create a PHP script to apply the patch programmatically
    cat > /tmp/apply_fix.php << 'PHPEOF'
<?php
$file = $argv[1];
$content = file_get_contents($file);

// The original vulnerable code pattern: after $current_page = []; comes the switch statement
$vulnerable_pattern = '/(\$current_page = \[\];)\s*\n\s*(switch \(\$route\[\'module\'\]\) \{)/s';

// The fix adds validation checks before the switch statement
$fix_code = <<<'FIX'
$current_page = [];

			//check if url and template is relative
			if (strpos($url, '//') !== false && strpos($template, '..') !== false) {
				$this->notFound();

				exit();
			}

			//check if the url has extension and is a html file and exists in the theme folder
			if (strpos($url, '.') !== false) {
				if (substr_compare($url, '.html', -5 ,5) === 0) {
					if (! file_exists(DIR_THEMES . $theme . DS . $url)) {
						$this->notFound();

						exit();
					}
				} else {
					$this->notFound();

					exit();
				}
			}

			//check if template belongs to theme and is a html file
			if (substr_compare($template, '.html', -5 ,5) === 0) {
				if (! file_exists(DIR_THEMES . $theme . DS . $template)) {
					$this->notFound();

					exit();
				}
			} else {
				$this->notFound();

				exit();
			}

			if ($route && isset($route['module'])) {
				switch ($route['module']) {
FIX;

if (preg_match($vulnerable_pattern, $content)) {
    $content = preg_replace($vulnerable_pattern, $fix_code, $content);

    // Also need to close the additional if block properly
    $old_switch_end = '/(\t\t\t\tbreak;\s*\n\s*\t\t\t\})\s*\n\s*(\$key  = slugify)/';
    $new_switch_end = "\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t\$key  = slugify";

    $content = preg_replace($old_switch_end, $new_switch_end, $content);

    file_put_contents($file, $content);
    echo "Fix applied successfully using pattern replacement\n";
    exit(0);
} else {
    echo "Pattern not found\n";
    exit(1);
}
?>
PHPEOF

    # Try to apply the fix using PHP
    if php /tmp/apply_fix.php "$TARGET_FILE" 2>/dev/null; then
        echo "Fix applied successfully via PHP script!"
    else
        echo "ERROR: Could not apply fix"
        exit 1
    fi

    # Clean up
    rm -f /tmp/apply_fix.php
fi

# Verify the fix was applied
if grep -q "check if url and template is relative" "$TARGET_FILE"; then
    echo "Verification: Fix successfully applied!"
else
    echo "ERROR: Fix verification failed"
    exit 1
fi

# PHP-FPM hot-reloads files, no service restart needed
echo "Fix complete!"
