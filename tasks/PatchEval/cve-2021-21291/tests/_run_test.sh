#!/bin/bash
# From ghcr.io/anonymous2578-data/cve-2021-21291:latest
# bash /workspace/fix-run.sh
set -e

cd /workspace/oauth2-proxy
git apply --whitespace=nowarn /tests/test.patch 
go test   -timeout 30s -run ^TestIsValidRedirect$ github.com/oauth2-proxy/oauth2-proxy/v7

cd /workspace
#!/bin/bash
# From ghcr.io/anonymous2578-data/cve-2021-21291:latest
# bash /workspace/unit_test.sh
set -e

cd /workspace/oauth2-proxy
go test -timeout 30s -run '^(TestPassGroupsHeadersWithGroups|TestProcessCookieFailIfRefreshSetAndCookieExpired|TestForwardAccessTokenUpstream|TestIsValidRedirect|TestSignInPageIncludesTargetRedirect|TestDoNotForwardAccessTokenUpstream|TestGetJwtSession|TestAjaxForbiddendRequest|Test_enrichSession|TestUserInfoEndpointAccepted|TestLoadCookiedSession|TestAjaxUnauthorizedRequest2|TestClearSingleCookie|TestProxyAllowedGroups|TestUserInfoEndpointUnauthorizedOnNoCookieSetError|TestAuthOnlyEndpointUnauthorizedOnExpiration|TestAjaxUnauthorizedRequestAccept1|TestProcessCookieNoCookieError|Test_redeemCode|TestSignInPageDirectAccessRedirectsToRoot|TestAuthOnlyEndpointUnauthorizedOnNoCookieSetError|Test_buildRoutesAllowlist|TestAuthOnlyEndpointSetBasicAuthFalseRequestHeaders|Test_getAppRedirect|TestAjaxUnauthorizedRequest1|TestAuthSkippedForPreflightRequests|TestProcessCookieFailIfCookieExpired|TestAuthOnlyEndpointSetXAuthRequestHeaders|TestBasicAuthPassword|TestAuthOnlyAllowedGroups|TestRequestSignature|TestSignInPageSkipProviderDirect|TestRobotsTxt|TestAuthOnlyEndpointUnauthorizedOnEmailValidationFailure|TestTrustedIPs|TestSignInPageSkipProvider|TestProcessCookieRefreshNotSet|TestAuthOnlyEndpointAccepted|Test_prepareNoCache|TestClearSplitCookie|TestOpenRedirects|TestAuthOnlyEndpointSetBasicAuthTrueRequestHeaders|Test_noCacheHeaders|TestStaticProxyUpstream|TestAllowedRequest)$' github.com/oauth2-proxy/oauth2-proxy/v7