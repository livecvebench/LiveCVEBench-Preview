#!/bin/bash
set -e

# File location in WordPress container
THEME_DIR="/var/www/html/wp-content/themes/oceanwp"
API_FILE="$THEME_DIR/inc/activation-notice/api.php"

# Wait for theme to be installed (entrypoint.sh runs asynchronously)
echo "[*] Waiting for OceanWP theme to be installed..."
max_wait=120
waited=0
while [ ! -d "$THEME_DIR" ]; do
    sleep 2
    waited=$((waited + 2))
    if [ $waited -ge $max_wait ]; then
        echo "[!] Timeout waiting for theme installation"
        break
    fi
    echo "[*] Waiting for theme... ($waited/$max_wait seconds)"
done

# Wait a bit more for all files to be extracted
sleep 5

# Verify file exists
if [ ! -f "$API_FILE" ]; then
    echo "Error: api.php not found at $API_FILE"
    echo "[*] Theme directory contents:"
    ls -la "$THEME_DIR" 2>/dev/null || echo "Theme directory doesn't exist"
    exit 1
fi

echo "Applying fix to add nonce validation to AJAX handlers..."

# Create a temporary file with the fixed content
# We'll use a PHP script to properly insert the nonce checks after each function opening

cat > /tmp/fix_api.php << 'PHPEOF'
<?php
$file = $argv[1];
$content = file_get_contents($file);

// Add header if missing
if (strpos($content, "defined( 'ABSPATH' )") === false) {
    $header = "<?php\n/**\n * OceanWP Notice API\n *\n * @package OceanWP WordPress theme\n */\n\nif ( ! defined( 'ABSPATH' ) ) {\n\texit;\n}\n\n";
    // Replace the opening <?php
    $content = preg_replace('/^<\?php\s*/', '', $content);
    $content = $header . $content;
}

// Define handlers and their nonce names
$handlers = [
    'oceanwp_dismissed_notice' => 'oceanwp_notice_nonce',
    'oceanwp_check_notice_actions' => 'oceanwp_notice_nonce',
    'oceanwp_notice_button_click' => 'oceanwp_notice_nonce',
    'oceanwp_dismissed_panel_notice' => 'oceanwp_panel_notice_nonce',
    'oceanwp_check_panel_notice_actions' => 'oceanwp_panel_notice_nonce',
    'oceanwp_panel_notice_button_click' => 'oceanwp_panel_notice_nonce',
];

foreach ($handlers as $action => $nonce) {
    // Check if already fixed
    if (preg_match("/wp_ajax_{$action}.*?check_ajax_referer/s", $content)) {
        echo "Handler $action already has nonce check, skipping.\n";
        continue;
    }

    // Pattern to find the action registration and its function opening
    // We need to insert check_ajax_referer right after "function () {"
    $pattern = "/(add_action\s*\(\s*['\"]wp_ajax_{$action}['\"],\s*function\s*\(\)\s*\{)/s";
    $replacement = "$1\n\n\t\tcheck_ajax_referer('{$nonce}');";

    $newContent = preg_replace($pattern, $replacement, $content, 1, $count);

    if ($count > 0) {
        $content = $newContent;
        echo "Added nonce check to: $action\n";
    } else {
        echo "Warning: Could not find handler pattern for: $action\n";
    }
}

file_put_contents($file, $content);
echo "Fix applied successfully!\n";
?>
PHPEOF

# Run the PHP fix script
php /tmp/fix_api.php "$API_FILE"

# Cleanup
rm /tmp/fix_api.php

# Verify the fix was applied
if grep -q "check_ajax_referer" "$API_FILE"; then
    echo "Verification: check_ajax_referer found in file - fix applied successfully!"
else
    echo "Warning: check_ajax_referer not found in file after fix attempt"
    exit 1
fi

echo "Fix completed."
