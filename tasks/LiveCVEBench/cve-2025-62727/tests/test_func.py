#!/usr/bin/env python3
"""
Functionality tests for FileResponse Range header handling.
These tests verify that normal Range header operations work correctly.
Should PASS in both vulnerable and fixed states.
"""
import os
import sys
import tempfile
import pytest


class TestFileResponseRangeHeaderFunctionality:
    """Test that normal Range header functionality works correctly."""

    @pytest.fixture(autouse=True)
    def setup_test_file(self):
        """Create a test file for range request testing."""
        # Create test content - 100 bytes for easy calculation
        self.test_content = b"ABCDEFGHIJ" * 10  # 100 bytes: A-J repeated 10 times

        with tempfile.NamedTemporaryFile(mode='wb', delete=False, suffix='.txt') as f:
            f.write(self.test_content)
            self.test_file = f.name

        yield

        # Cleanup
        if os.path.exists(self.test_file):
            os.unlink(self.test_file)

    def test_simple_range_request(self):
        """Test basic range request: bytes=0-9 should return first 10 bytes."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/", headers={"Range": "bytes=0-9"})

        assert response.status_code == 206, f"Expected 206 Partial Content, got {response.status_code}"
        assert response.content == b"ABCDEFGHIJ", f"Expected 'ABCDEFGHIJ', got {response.content}"
        assert "content-range" in response.headers
        print("PASSED: Simple range request (bytes=0-9)")

    def test_middle_range_request(self):
        """Test range in the middle of file: bytes=10-19."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/", headers={"Range": "bytes=10-19"})

        assert response.status_code == 206
        assert response.content == b"ABCDEFGHIJ"  # Second repetition
        print("PASSED: Middle range request (bytes=10-19)")

    def test_suffix_range_request(self):
        """Test suffix range: bytes=-10 should return last 10 bytes."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/", headers={"Range": "bytes=-10"})

        assert response.status_code == 206
        assert response.content == self.test_content[-10:]
        print("PASSED: Suffix range request (bytes=-10)")

    def test_open_ended_range_request(self):
        """Test open-ended range: bytes=90- should return from byte 90 to end."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/", headers={"Range": "bytes=90-"})

        assert response.status_code == 206
        assert response.content == self.test_content[90:]
        print("PASSED: Open-ended range request (bytes=90-)")

    def test_full_file_request(self):
        """Test request without Range header returns full file."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/")

        assert response.status_code == 200
        assert response.content == self.test_content
        print("PASSED: Full file request (no Range header)")

    def test_invalid_range_unit_rejected(self):
        """Test that non-bytes range unit is rejected with 400."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/", headers={"Range": "items=0-100"})

        assert response.status_code == 400
        print("PASSED: Invalid range unit rejected")

    def test_out_of_bounds_range_rejected(self):
        """Test that out-of-bounds range returns 416."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/", headers={"Range": "bytes=200-300"})

        assert response.status_code == 416
        print("PASSED: Out of bounds range rejected")

    def test_overlapping_ranges_merge(self):
        """Test that overlapping ranges are merged correctly."""
        from starlette.responses import FileResponse

        # Use parse method directly
        file_size = 100
        ranges = FileResponse._parse_range_header("bytes=0-10, 5-20", file_size)

        # Overlapping ranges should merge
        assert len(ranges) == 1, f"Expected 1 merged range, got {len(ranges)}: {ranges}"
        start, end = ranges[0]
        assert start == 0 and end == 21, f"Expected (0, 21), got ({start}, {end})"
        print("PASSED: Overlapping ranges merge correctly")

    def test_multiple_non_overlapping_ranges(self):
        """Test that non-overlapping ranges are preserved."""
        from starlette.responses import FileResponse

        file_size = 100
        ranges = FileResponse._parse_range_header("bytes=0-10, 50-60", file_size)

        assert len(ranges) == 2, f"Expected 2 ranges, got {len(ranges)}"
        print("PASSED: Multiple non-overlapping ranges preserved")

    def test_valid_range_header_formats(self):
        """Test various valid Range header formats are parsed correctly."""
        from starlette.responses import FileResponse

        file_size = 1000

        # Single range
        ranges = FileResponse._parse_range_header("bytes=0-99", file_size)
        assert len(ranges) == 1
        assert ranges[0] == (0, 100)

        # Multiple comma-separated ranges
        ranges = FileResponse._parse_range_header("bytes=0-10, 20-30, 40-50", file_size)
        assert len(ranges) == 3

        # Range with whitespace
        ranges = FileResponse._parse_range_header("bytes= 0-99 ", file_size)
        assert len(ranges) == 1

        print("PASSED: Various valid Range header formats parsed correctly")

    def test_content_range_header_format(self):
        """Test that Content-Range header is set correctly in response."""
        from starlette.responses import FileResponse
        from starlette.testclient import TestClient

        async def app(scope, receive, send):
            response = FileResponse(path=self.test_file)
            await response(scope, receive, send)

        client = TestClient(app)
        response = client.get("/", headers={"Range": "bytes=0-9"})

        assert response.status_code == 206
        content_range = response.headers.get("content-range", "")
        assert content_range.startswith("bytes 0-9/"), f"Unexpected Content-Range: {content_range}"
        print("PASSED: Content-Range header format correct")


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
