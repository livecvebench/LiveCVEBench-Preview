"""
Functionality tests for the NiceGUI application.
Tests that normal CSS styling works correctly.
"""

import pytest
import requests
import time
import re

BASE_URL = "http://localhost:8080"
MAX_RETRIES = 30
RETRY_DELAY = 2


def wait_for_server():
    """Wait for the NiceGUI server to be ready."""
    for i in range(MAX_RETRIES):
        try:
            response = requests.get(BASE_URL, timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(RETRY_DELAY)
    raise RuntimeError(f"Server did not start within {MAX_RETRIES * RETRY_DELAY} seconds")


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure server is ready before running tests."""
    wait_for_server()


class TestBasicFunctionality:
    """Test that basic application functionality works."""

    def test_homepage_loads(self):
        """Test that the homepage loads successfully."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200
        assert "text/html" in response.headers.get("Content-Type", "")

    def test_page_contains_button(self):
        """Test that the page contains the expected button element."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200
        # NiceGUI uses Quasar components, button should be present
        assert "Click Me" in response.text or "q-btn" in response.text

    def test_page_contains_label(self):
        """Test that the page contains expected labels."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200
        # Check for main label text
        assert "Demo" in response.text or "NiceGUI" in response.text

    def test_valid_color_parameter(self):
        """Test that a valid color parameter is accepted."""
        response = requests.get(f"{BASE_URL}/?color=red")
        assert response.status_code == 200
        # The page should load without errors
        assert "text/html" in response.headers.get("Content-Type", "")

    def test_hex_color_parameter(self):
        """Test that hex color values work correctly."""
        response = requests.get(f"{BASE_URL}/?color=%23ff0000")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("Content-Type", "")

    def test_rgb_color_parameter(self):
        """Test that RGB color values work correctly."""
        response = requests.get(f"{BASE_URL}/?color=rgb(255,0,0)")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("Content-Type", "")

    def test_default_color(self):
        """Test that default color (no parameter) works."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200
        # Check that CSS is being added (style or script for style)
        assert "<style" in response.text or "addStyle" in response.text

    def test_css_with_special_chars_preserved(self):
        """Test that CSS with quotes and other special chars works."""
        # URL-encoded special characters
        response = requests.get(f"{BASE_URL}/?color=blue")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("Content-Type", "")

    def test_multiple_requests(self):
        """Test that the server handles multiple sequential requests."""
        for color in ["red", "green", "blue", "yellow", "purple"]:
            response = requests.get(f"{BASE_URL}/?color={color}")
            assert response.status_code == 200

    def test_empty_color_parameter(self):
        """Test that empty color parameter doesn't break the page."""
        response = requests.get(f"{BASE_URL}/?color=")
        assert response.status_code == 200
        assert "text/html" in response.headers.get("Content-Type", "")


class TestCSSOutput:
    """Test that CSS is properly included in the page."""

    def test_style_tag_present(self):
        """Test that style-related content is in the page."""
        response = requests.get(f"{BASE_URL}/?color=blue")
        assert response.status_code == 200
        # Either direct <style> tags or addStyle script calls should be present
        has_style = "<style" in response.text
        has_add_style = "addStyle" in response.text
        assert has_style or has_add_style, "Page should contain CSS styling mechanism"

    def test_css_class_in_output(self):
        """Test that the q-btn class styling is present."""
        response = requests.get(f"{BASE_URL}/?color=red")
        assert response.status_code == 200
        # The CSS should reference .q-btn class
        assert ".q-btn" in response.text or "q-btn" in response.text


class TestEdgeCases:
    """Test edge cases for the application."""

    def test_very_long_color_value(self):
        """Test that very long color values don't crash the server."""
        long_color = "a" * 1000
        response = requests.get(f"{BASE_URL}/?color={long_color}")
        assert response.status_code == 200

    def test_unicode_color_value(self):
        """Test that unicode characters in color are handled."""
        response = requests.get(f"{BASE_URL}/?color=%E2%9C%93")  # Checkmark
        assert response.status_code == 200

    def test_space_in_color(self):
        """Test that spaces in color value are handled."""
        response = requests.get(f"{BASE_URL}/?color=light%20blue")
        assert response.status_code == 200
