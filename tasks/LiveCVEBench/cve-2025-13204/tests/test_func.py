"""
Functionality tests for expr-eval library.
These tests verify that the expression parser works correctly for legitimate use cases.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import json


def run_node_code(code):
    """Execute Node.js code and return stdout."""
    full_code = f"""
const {{ Parser }} = require('expr-eval');
try {{
    {code}
}} catch (e) {{
    console.log('ERROR:' + e.message);
}}
"""
    result = subprocess.run(
        ['node', '-e', full_code],
        cwd='/app',
        capture_output=True,
        text=True,
        timeout=30
    )
    return result.stdout.strip()


class TestBasicArithmetic:
    """Test basic arithmetic operations."""

    def test_addition(self):
        """Test simple addition."""
        result = run_node_code('console.log(Parser.evaluate("2 + 3"))')
        assert result == "5"

    def test_subtraction(self):
        """Test simple subtraction."""
        result = run_node_code('console.log(Parser.evaluate("10 - 4"))')
        assert result == "6"

    def test_multiplication(self):
        """Test simple multiplication."""
        result = run_node_code('console.log(Parser.evaluate("7 * 8"))')
        assert result == "56"

    def test_division(self):
        """Test simple division."""
        result = run_node_code('console.log(Parser.evaluate("20 / 4"))')
        assert result == "5"

    def test_modulo(self):
        """Test modulo operation."""
        result = run_node_code('console.log(Parser.evaluate("17 % 5"))')
        assert result == "2"

    def test_power(self):
        """Test exponentiation."""
        result = run_node_code('console.log(Parser.evaluate("2 ^ 10"))')
        assert result == "1024"

    def test_complex_expression(self):
        """Test complex arithmetic expression with precedence."""
        result = run_node_code('console.log(Parser.evaluate("2 + 3 * 4 - 6 / 2"))')
        assert result == "11"

    def test_parentheses(self):
        """Test parentheses for grouping."""
        result = run_node_code('console.log(Parser.evaluate("(2 + 3) * 4"))')
        assert result == "20"

    def test_negative_numbers(self):
        """Test negative numbers."""
        result = run_node_code('console.log(Parser.evaluate("-5 + 10"))')
        assert result == "5"

    def test_decimal_numbers(self):
        """Test decimal/floating point numbers."""
        result = run_node_code('console.log(Parser.evaluate("3.14 * 2"))')
        assert result == "6.28"


class TestVariables:
    """Test variable substitution."""

    def test_single_variable(self):
        """Test evaluation with single variable."""
        result = run_node_code('console.log(Parser.evaluate("x * 2", {x: 5}))')
        assert result == "10"

    def test_multiple_variables(self):
        """Test evaluation with multiple variables."""
        result = run_node_code('console.log(Parser.evaluate("x + y", {x: 3, y: 7}))')
        assert result == "10"

    def test_complex_variable_expression(self):
        """Test complex expression with variables."""
        result = run_node_code('console.log(Parser.evaluate("(a + b) * c / d", {a: 2, b: 3, c: 4, d: 2}))')
        assert result == "10"


class TestBuiltinFunctions:
    """Test built-in mathematical functions."""

    def test_sin(self):
        """Test sin function."""
        result = run_node_code('console.log(Math.abs(Parser.evaluate("sin(0)")) < 0.0001)')
        assert result == "true"

    def test_cos(self):
        """Test cos function."""
        result = run_node_code('console.log(Math.abs(Parser.evaluate("cos(0)") - 1) < 0.0001)')
        assert result == "true"

    def test_abs(self):
        """Test abs function."""
        result = run_node_code('console.log(Parser.evaluate("abs(-5)"))')
        assert result == "5"

    def test_sqrt(self):
        """Test sqrt function."""
        result = run_node_code('console.log(Parser.evaluate("sqrt(16)"))')
        assert result == "4"

    def test_max(self):
        """Test max function."""
        result = run_node_code('console.log(Parser.evaluate("max(1, 5, 3)"))')
        assert result == "5"

    def test_min(self):
        """Test min function."""
        result = run_node_code('console.log(Parser.evaluate("min(1, 5, 3)"))')
        assert result == "1"

    def test_floor(self):
        """Test floor function."""
        result = run_node_code('console.log(Parser.evaluate("floor(3.7)"))')
        assert result == "3"

    def test_ceil(self):
        """Test ceil function."""
        result = run_node_code('console.log(Parser.evaluate("ceil(3.2)"))')
        assert result == "4"

    def test_round(self):
        """Test round function."""
        result = run_node_code('console.log(Parser.evaluate("round(3.5)"))')
        assert result == "4"

    def test_pow(self):
        """Test pow function."""
        result = run_node_code('console.log(Parser.evaluate("pow(2, 8)"))')
        assert result == "256"


class TestUserDefinedFunctions:
    """Test user-defined functions."""

    def test_simple_function_definition(self):
        """Test defining and calling a simple function."""
        result = run_node_code('console.log(Parser.evaluate("f(x) = x * 2; f(5)"))')
        assert result == "10"

    def test_function_with_multiple_args(self):
        """Test function with multiple arguments."""
        result = run_node_code('console.log(Parser.evaluate("add(a, b) = a + b; add(3, 4)"))')
        assert result == "7"


class TestConditionalOperators:
    """Test conditional and comparison operators."""

    def test_ternary_true(self):
        """Test ternary operator with true condition."""
        result = run_node_code('console.log(Parser.evaluate("1 > 0 ? 10 : 20"))')
        assert result == "10"

    def test_ternary_false(self):
        """Test ternary operator with false condition."""
        result = run_node_code('console.log(Parser.evaluate("1 < 0 ? 10 : 20"))')
        assert result == "20"

    def test_equality(self):
        """Test equality operator."""
        result = run_node_code('console.log(Parser.evaluate("5 == 5"))')
        assert result == "true"

    def test_inequality(self):
        """Test inequality operator."""
        result = run_node_code('console.log(Parser.evaluate("5 != 3"))')
        assert result == "true"

    def test_greater_than(self):
        """Test greater than operator."""
        result = run_node_code('console.log(Parser.evaluate("10 > 5"))')
        assert result == "true"

    def test_less_than(self):
        """Test less than operator."""
        result = run_node_code('console.log(Parser.evaluate("3 < 7"))')
        assert result == "true"


class TestArrays:
    """Test array operations."""

    def test_array_index(self):
        """Test array indexing."""
        result = run_node_code('console.log(Parser.evaluate("[10, 20, 30][1]"))')
        assert result == "20"

    def test_array_length(self):
        """Test array length."""
        result = run_node_code('console.log(Parser.evaluate("length([1,2,3,4,5])"))')
        assert result == "5"


class TestStringOperations:
    """Test string operations."""

    def test_string_length(self):
        """Test string length function."""
        result = run_node_code('console.log(Parser.evaluate("length(\'hello\')"))')
        assert result == "5"

    def test_string_concatenation(self):
        """Test string concatenation."""
        result = run_node_code('console.log(Parser.evaluate("\'hello\' || \' \' || \'world\'"))')
        assert result == "hello world"


class TestConstants:
    """Test built-in constants."""

    def test_pi(self):
        """Test PI constant."""
        result = run_node_code('console.log(Math.abs(Parser.evaluate("PI") - 3.14159) < 0.001)')
        assert result == "true"

    def test_e(self):
        """Test E constant."""
        result = run_node_code('console.log(Math.abs(Parser.evaluate("E") - 2.71828) < 0.001)')
        assert result == "true"

    def test_true_constant(self):
        """Test true constant."""
        result = run_node_code('console.log(Parser.evaluate("true"))')
        assert result == "true"

    def test_false_constant(self):
        """Test false constant."""
        result = run_node_code('console.log(Parser.evaluate("false"))')
        assert result == "false"


class TestLogicalOperators:
    """Test logical operators."""

    def test_and_true(self):
        """Test logical AND with both true."""
        result = run_node_code('console.log(Parser.evaluate("true and true"))')
        assert result == "true"

    def test_and_false(self):
        """Test logical AND with one false."""
        result = run_node_code('console.log(Parser.evaluate("true and false"))')
        assert result == "false"

    def test_or_true(self):
        """Test logical OR with one true."""
        result = run_node_code('console.log(Parser.evaluate("true or false"))')
        assert result == "true"

    def test_or_false(self):
        """Test logical OR with both false."""
        result = run_node_code('console.log(Parser.evaluate("false or false"))')
        assert result == "false"

    def test_not(self):
        """Test logical NOT."""
        result = run_node_code('console.log(Parser.evaluate("not false"))')
        assert result == "true"
