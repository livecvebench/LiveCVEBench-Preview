FROM wordpress:6.4-apache

# Install required system packages (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    tmux \
    asciinema \
    curl \
    less \
    vim \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Install WP-CLI for WordPress management
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
    && chmod +x wp-cli.phar \
    && mv wp-cli.phar /usr/local/bin/wp

# Copy the Simple SEO plugin from task-deps
COPY task-deps/cds-simple-seo /var/www/html/wp-content/plugins/cds-simple-seo

# Create vulnerable version by removing esc_html() wrappers from Post.php
# This transforms the fixed version (2.0.33) back to vulnerable behavior (2.0.31)
RUN sed -i 's/esc_html(get_post_meta/get_post_meta/g' /var/www/html/wp-content/plugins/cds-simple-seo/app/Admin/Meta/Post.php && \
    sed -i 's/, true));/, true);/g' /var/www/html/wp-content/plugins/cds-simple-seo/app/Admin/Meta/Post.php

# Copy the setup script
COPY task-deps/setup-wordpress.sh /usr/local/bin/setup-wordpress.sh
RUN chmod +x /usr/local/bin/setup-wordpress.sh

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint-custom.sh
RUN chmod +x /entrypoint-custom.sh

# Set proper ownership for WordPress files
RUN chown -R www-data:www-data /var/www/html/wp-content/plugins/cds-simple-seo

EXPOSE 80

# Use custom entrypoint that wraps the original
# CMD ["/entrypoint-custom.sh"]
