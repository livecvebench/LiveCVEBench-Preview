FROM php:7.4-cli

WORKDIR /app

# Install system dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    curl \
    wget \
    tmux \
    asciinema \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Configure Composer to allow insecure packages (needed for vulnerable ThinkPHP)
RUN composer config --global audit.block-insecure false

# Allow ThinkPHP installer plugin
RUN composer config --global allow-plugins.topthink/think-installer true

# Install ThinkPHP 5.0.22 using Composer (vulnerable version)
RUN composer create-project topthink/think=5.0.22 . --prefer-dist --no-dev

# Pin the framework to exact version 5.0.22 (vulnerable version)
RUN composer require topthink/framework:5.0.22 --update-with-dependencies

# Remove .git directory to prevent solution leakage
RUN rm -rf .git

# Create auth controller directory structure
RUN mkdir -p application/auth/controller application/auth/view/widget

# Copy vulnerable Widget.php from task-deps
COPY task-deps/Widget.php application/auth/controller/Widget.php

# Copy ThinkPHP config from task-deps
COPY task-deps/config.php application/config.php

# Copy Index controller from task-deps
COPY task-deps/Index.php application/index/controller/Index.php

# Copy default widget template from task-deps
COPY task-deps/default.html application/auth/view/widget/default.html

# Set permissions for runtime and public directories
RUN chmod -R 777 runtime public

# CMD ["php", "-S", "0.0.0.0:8080", "-t", "public"]
