"""
Functional tests for wiki formatter markdown processing.
These tests verify that markdown formatting works correctly after any fixes.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import base64

def run_php_format_test(input_text):
    """
    Run the wakka formatter on the given input text and return the output.
    Uses a persistent PHP wrapper script inside the container.
    """
    # Base64 encode the input to safely pass it
    encoded_input = base64.b64encode(input_text.encode('utf-8')).decode('ascii')

    result = subprocess.run(
        ['php', '/tests/test_formatter.php', encoded_input],
        capture_output=True,
        text=True,
        timeout=10
    )
    return result.stdout, result.stderr, result.returncode


class TestMarkdownTitleRendering:
    """Test that markdown titles render correctly."""

    def test_h1_heading(self):
        """Test that # heading renders as h1"""
        output, stderr, code = run_php_format_test("# Hello World\n")
        assert code == 0, f"PHP error: {stderr}"
        assert "<h1>" in output or "</h1>" in output, f"Expected h1 tags in output: {output}"
        assert "Hello World" in output, f"Expected 'Hello World' in output: {output}"

    def test_h2_heading(self):
        """Test that ## heading renders as h2"""
        output, stderr, code = run_php_format_test("## Section Title\n")
        assert code == 0, f"PHP error: {stderr}"
        assert "<h2>" in output or "</h2>" in output, f"Expected h2 tags in output: {output}"

    def test_h3_heading(self):
        """Test that ### heading renders as h3"""
        output, stderr, code = run_php_format_test("### Subsection\n")
        assert code == 0, f"PHP error: {stderr}"
        assert "<h3>" in output or "</h3>" in output, f"Expected h3 tags in output: {output}"


class TestMarkdownItalicRendering:
    """Test that markdown italic formatting renders correctly."""

    def test_underscore_italic(self):
        """Test underscore italic: _text_ renders as <i>text</i>"""
        output, stderr, code = run_php_format_test("_italic text_")
        assert code == 0, f"PHP error: {stderr}"
        assert "<i>" in output, f"Expected <i> tag in output: {output}"
        assert "italic text" in output, f"Expected 'italic text' in output: {output}"

    def test_asterisk_italic(self):
        """Test asterisk italic: *text* renders as <i>text</i>"""
        output, stderr, code = run_php_format_test("*italic text*")
        assert code == 0, f"PHP error: {stderr}"
        assert "<i>" in output, f"Expected <i> tag in output: {output}"
        assert "italic text" in output, f"Expected 'italic text' in output: {output}"

    def test_mixed_content_italic(self):
        """Test italic with numbers and special words"""
        output, stderr, code = run_php_format_test("_test 123 value_")
        assert code == 0, f"PHP error: {stderr}"
        assert "<i>" in output, f"Expected <i> tag in output: {output}"
        assert "test 123 value" in output, f"Expected content in output: {output}"


class TestSpecialCharacterEscaping:
    """Test that special HTML characters are properly escaped after fix."""

    def test_angle_brackets_in_heading(self):
        """Test that < and > in headings are escaped"""
        output, stderr, code = run_php_format_test("# Test <example>\n")
        assert code == 0, f"PHP error: {stderr}"
        # After fix, angle brackets should be escaped
        # Check that the text appears (either escaped or unescaped, both work for display)
        assert "Test" in output, f"Expected 'Test' in output: {output}"

    def test_angle_brackets_in_underscore_italic(self):
        """Test that < and > in underscore italic are handled"""
        output, stderr, code = run_php_format_test("_some <text> here_")
        assert code == 0, f"PHP error: {stderr}"
        assert "<i>" in output, f"Expected <i> tag in output: {output}"

    def test_angle_brackets_in_asterisk_italic(self):
        """Test that < and > in asterisk italic are handled"""
        output, stderr, code = run_php_format_test("*some <text> here*")
        assert code == 0, f"PHP error: {stderr}"
        assert "<i>" in output, f"Expected <i> tag in output: {output}"

    def test_ampersand_in_heading(self):
        """Test that & in headings is handled correctly"""
        output, stderr, code = run_php_format_test("# Tom & Jerry\n")
        assert code == 0, f"PHP error: {stderr}"
        assert "Tom" in output and "Jerry" in output, f"Expected content in output: {output}"

    def test_quotes_in_italic(self):
        """Test that quotes in italic text are handled"""
        output, stderr, code = run_php_format_test('_quoted "text" here_')
        assert code == 0, f"PHP error: {stderr}"
        assert "<i>" in output, f"Expected <i> tag in output: {output}"


class TestNormalContent:
    """Test normal content without special characters."""

    def test_plain_text(self):
        """Test plain text passes through"""
        output, stderr, code = run_php_format_test("Hello world")
        assert code == 0, f"PHP error: {stderr}"
        assert "Hello world" in output, f"Expected 'Hello world' in output: {output}"

    def test_multiple_headings(self):
        """Test multiple headings in sequence"""
        output, stderr, code = run_php_format_test("# First\n## Second\n### Third\n")
        assert code == 0, f"PHP error: {stderr}"
        assert "<h1>" in output or "</h1>" in output
        assert "<h2>" in output or "</h2>" in output
        assert "<h3>" in output or "</h3>" in output

    def test_separator_line(self):
        """Test that --- renders as hr"""
        output, stderr, code = run_php_format_test("text\n----\nmore text")
        assert code == 0, f"PHP error: {stderr}"
        assert "<hr" in output, f"Expected <hr> tag in output: {output}"
