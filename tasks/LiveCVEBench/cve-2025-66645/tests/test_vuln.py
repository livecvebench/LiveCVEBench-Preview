"""
Vulnerability tests for path traversal in NiceGUI media file serving.

These tests verify that path traversal attempts are properly blocked.
- FAIL in vulnerable state (path traversal works)
- PASS in fixed state (path traversal is blocked)

NOTE: All tests use URL-encoded payloads (%2e%2e) because httpx normalizes
raw ../ sequences before sending, which wouldn't properly test the vulnerability.
"""
import httpx
import pytest
import time

BASE_URL = "http://localhost:8080"
TIMEOUT = 10.0


@pytest.fixture(scope="module", autouse=True)
def wait_for_app():
    """Wait for the application to be ready before running tests."""
    max_attempts = 30
    for i in range(max_attempts):
        try:
            response = httpx.get(f"{BASE_URL}/", timeout=2.0)
            if response.status_code == 200:
                return
        except httpx.RequestError:
            pass
        time.sleep(1)
    pytest.fail(f"Application did not start within {max_attempts} seconds")


class TestPathTraversalBlocked:
    """Tests to verify path traversal attacks are blocked."""

    def test_url_encoded_traversal_etc_passwd(self):
        """Test that URL-encoded path traversal to /etc/passwd is blocked."""
        # %2e%2e = ..
        payload = "%2e%2e/" * 6 + "etc/passwd"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        # After fix: should return 404, not file contents
        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"
        assert "root:" not in response.text, \
            "Response contains /etc/passwd content - path traversal is working!"

    def test_url_encoded_traversal_etc_hosts(self):
        """Test that URL-encoded path traversal to /etc/hosts is blocked."""
        payload = "%2e%2e/" * 6 + "etc/hosts"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"
        assert "127.0.0.1" not in response.text, \
            "Response contains /etc/hosts content - path traversal is working!"

    def test_url_encoded_traversal_etc_shadow(self):
        """Test that path traversal to sensitive files is blocked."""
        payload = "%2e%2e/" * 6 + "etc/shadow"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        # /etc/shadow might not be readable, so we check for 404 or no sensitive content
        # In vulnerable state, if readable, status would be 200
        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"

    def test_url_encoded_4x_traversal(self):
        """Test with 4x traversal depth."""
        payload = "%2e%2e/" * 4 + "etc/passwd"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"
        assert "root:" not in response.text, \
            "Response contains /etc/passwd content - path traversal is working!"

    def test_url_encoded_8x_traversal(self):
        """Test with 8x traversal depth (more than needed)."""
        payload = "%2e%2e/" * 8 + "etc/passwd"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"
        assert "root:" not in response.text, \
            "Response contains /etc/passwd content - path traversal is working!"

    def test_url_encoded_traversal_etc_os_release(self):
        """Test traversal to /etc/os-release (commonly exists)."""
        payload = "%2e%2e/" * 6 + "etc/os-release"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"


class TestParentDirectoryAccess:
    """Tests for accessing files in parent directories."""

    def test_single_parent_traversal(self):
        """Test accessing a file one directory up."""
        response = httpx.get(f"{BASE_URL}/media/%2e%2e/poc.py", timeout=TIMEOUT)

        # Should be 404 - can't access parent directory
        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"

    def test_access_app_source(self):
        """Test that application source code cannot be accessed."""
        # Try to access the main application file
        payload = "%2e%2e/" * 4 + "app/poc.py"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        # Strict assertion - should return 404
        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Application source code may be exposed!"

    def test_access_parent_app_file(self):
        """Test accessing poc.py via parent traversal."""
        payload = "%2e%2e/poc.py"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"
        # Check for Python source code specific patterns (not just "nicegui" which appears in HTML title)
        assert "from nicegui import" not in response.text, \
            "Response contains application source code!"


class TestVariousFileTargets:
    """Test path traversal attempts against various sensitive files."""

    def test_access_proc_self_environ(self):
        """Test that /proc/self/environ cannot be accessed."""
        payload = "%2e%2e/" * 6 + "proc/self/environ"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. /proc/self/environ may be exposed!"

    def test_access_etc_hostname(self):
        """Test accessing /etc/hostname."""
        payload = "%2e%2e/" * 6 + "etc/hostname"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"

    def test_access_etc_resolv_conf(self):
        """Test accessing /etc/resolv.conf."""
        payload = "%2e%2e/" * 6 + "etc/resolv.conf"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"


class TestEdgeCases:
    """Edge case tests for path traversal protection."""

    def test_deep_traversal(self):
        """Test with very deep traversal (more ../ than needed)."""
        payload = "%2e%2e/" * 20 + "etc/passwd"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"
        assert "root:" not in response.text, \
            "Response contains /etc/passwd content - path traversal is working!"

    def test_traversal_with_trailing_slash(self):
        """Test traversal with trailing slash."""
        payload = "%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd/"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        # Should be 404 (not a file with trailing slash)
        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}."

    def test_alternate_depth_traversal(self):
        """Test with 5x traversal depth."""
        payload = "%2e%2e/" * 5 + "etc/passwd"
        response = httpx.get(f"{BASE_URL}/media/{payload}", timeout=TIMEOUT)

        assert response.status_code == 404, \
            f"Expected 404, got {response.status_code}. Path traversal may be working!"
        assert "root:" not in response.text, \
            "Response contains /etc/passwd content - path traversal is working!"
