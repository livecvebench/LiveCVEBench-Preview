"""
Functional tests for pyLoad's add_package endpoint.
These tests verify that the basic package addition functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""
import pytest
import requests
import os
import time

BASE_URL = os.environ.get("PYLOAD_URL", "http://localhost:8000")
TIMEOUT = 30


@pytest.fixture(scope="module")
def wait_for_service():
    """Wait for pyLoad service to be ready"""
    for i in range(TIMEOUT):
        try:
            response = requests.get(f"{BASE_URL}/api/login", timeout=5)
            # 401 (Unauthorized) means service is up but requires auth
            if response.status_code in (200, 401, 404, 405):
                time.sleep(2)  # Give it a moment to fully initialize
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(1)
    pytest.fail(f"pyLoad service not available at {BASE_URL} after {TIMEOUT} seconds")


@pytest.fixture
def authenticated_session(wait_for_service):
    """Create an authenticated session"""
    session = requests.Session()
    response = session.post(
        f"{BASE_URL}/api/login",
        data={"username": "pyload", "password": "pyload"},
        timeout=10
    )
    assert response.status_code == 200, f"Login failed: {response.text}"
    return session


class TestBasicFunctionality:
    """Test basic add_package functionality"""

    def test_login_works(self, wait_for_service):
        """Test that login endpoint is working"""
        session = requests.Session()
        response = session.post(
            f"{BASE_URL}/api/login",
            data={"username": "pyload", "password": "pyload"},
            timeout=10
        )
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

    def test_add_package_with_links(self, authenticated_session):
        """Test adding a package with download links"""
        data = {
            'add_name': 'TestPackage',
            'add_dest': '1',
            'add_links': 'http://example.com/file.zip',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            data=data,
            timeout=10
        )
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

    def test_add_package_with_multiple_links(self, authenticated_session):
        """Test adding a package with multiple download links"""
        data = {
            'add_name': 'MultiLinkPackage',
            'add_dest': '1',
            'add_links': 'http://example.com/file1.zip\nhttp://example.com/file2.zip\nhttp://example.com/file3.zip',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            data=data,
            timeout=10
        )
        assert response.status_code == 200

    def test_add_package_with_password(self, authenticated_session):
        """Test adding a password-protected package"""
        data = {
            'add_name': 'PasswordPackage',
            'add_dest': '1',
            'add_links': 'http://example.com/protected.rar',
            'add_password': 'secretpassword123'
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            data=data,
            timeout=10
        )
        assert response.status_code == 200

    def test_add_package_default_name(self, authenticated_session):
        """Test adding a package without specifying a name"""
        data = {
            'add_name': '',
            'add_dest': '1',
            'add_links': 'http://example.com/unnamed.zip',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            data=data,
            timeout=10
        )
        assert response.status_code == 200


class TestFileUpload:
    """Test file upload functionality"""

    def test_add_package_with_normal_file(self, authenticated_session):
        """Test uploading a normal file with valid filename"""
        files = {'add_file': ('normal_links.txt', 'http://example.com/test.zip', 'text/plain')}
        data = {
            'add_name': 'FileUploadPackage',
            'add_dest': '1',
            'add_links': '',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            files=files,
            data=data,
            timeout=10
        )
        assert response.status_code == 200

    def test_add_package_with_empty_filename(self, authenticated_session):
        """Test uploading with empty filename doesn't break the endpoint"""
        files = {'add_file': ('', 'test content', 'text/plain')}
        data = {
            'add_name': 'EmptyFilenamePackage',
            'add_dest': '1',
            'add_links': 'http://example.com/backup.zip',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            files=files,
            data=data,
            timeout=10
        )
        # Should succeed - empty filename is handled gracefully
        assert response.status_code == 200

    def test_add_package_with_unicode_filename(self, authenticated_session):
        """Test uploading file with unicode characters in filename"""
        files = {'add_file': ('文件名.txt', 'test content', 'text/plain')}
        data = {
            'add_name': 'UnicodePackage',
            'add_dest': '1',
            'add_links': '',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            files=files,
            data=data,
            timeout=10
        )
        assert response.status_code == 200

    def test_add_package_with_spaces_in_filename(self, authenticated_session):
        """Test uploading file with spaces in filename"""
        files = {'add_file': ('my link file.txt', 'http://example.com/file.zip', 'text/plain')}
        data = {
            'add_name': 'SpacesPackage',
            'add_dest': '1',
            'add_links': '',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            files=files,
            data=data,
            timeout=10
        )
        assert response.status_code == 200


class TestQueueDestinations:
    """Test different queue destinations"""

    def test_add_to_queue_0(self, authenticated_session):
        """Test adding package to queue 0"""
        data = {
            'add_name': 'Queue0Package',
            'add_dest': '0',
            'add_links': 'http://example.com/q0.zip',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            data=data,
            timeout=10
        )
        assert response.status_code == 200

    def test_add_to_queue_1(self, authenticated_session):
        """Test adding package to queue 1"""
        data = {
            'add_name': 'Queue1Package',
            'add_dest': '1',
            'add_links': 'http://example.com/q1.zip',
            'add_password': ''
        }
        response = authenticated_session.post(
            f"{BASE_URL}/json/add_package",
            data=data,
            timeout=10
        )
        assert response.status_code == 200
