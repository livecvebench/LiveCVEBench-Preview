"""
Functionality tests for IXmaps map.php page.
These tests verify that the application works correctly after fixes are applied.
They should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
from urllib.parse import quote

BASE_URL = "http://localhost"


class TestMapPageBasicFunctionality:
    """Test basic page loading and structure."""

    def test_map_page_loads_successfully(self):
        """Map page should load without errors."""
        response = requests.get(f"{BASE_URL}/map.php", timeout=10)
        assert response.status_code == 200
        assert "IXmaps" in response.text or "Map" in response.text

    def test_map_page_contains_required_elements(self):
        """Map page should contain essential HTML elements."""
        response = requests.get(f"{BASE_URL}/map.php", timeout=10)
        assert response.status_code == 200
        # Check for key page elements
        assert "<html" in response.text
        assert "<body" in response.text
        assert "map-page" in response.text or "map" in response.text.lower()

    def test_map_page_contains_javascript_initialization(self):
        """Map page should contain JavaScript initialization code."""
        response = requests.get(f"{BASE_URL}/map.php", timeout=10)
        assert response.status_code == 200
        assert "initMode" in response.text
        assert "init()" in response.text

    def test_map_page_default_state(self):
        """Map page without parameters should load in default mode."""
        response = requests.get(f"{BASE_URL}/map.php", timeout=10)
        assert response.status_code == 200
        # initMode should be 0 by default (no parameters)
        assert "var initMode = 0" in response.text


class TestTridParameterFunctionality:
    """Test trid parameter handling for valid inputs."""

    def test_valid_numeric_trid_accepted(self):
        """Valid numeric trid should be accepted and processed."""
        response = requests.get(f"{BASE_URL}/map.php?trid=12345", timeout=10)
        assert response.status_code == 200
        # Should set initMode to 1 for trid
        assert "initMode = 1" in response.text
        # Should contain the trid value
        assert "trIdFilter" in response.text

    def test_valid_single_digit_trid(self):
        """Single digit trid should work."""
        response = requests.get(f"{BASE_URL}/map.php?trid=1", timeout=10)
        assert response.status_code == 200
        assert "initMode = 1" in response.text

    def test_valid_large_trid(self):
        """Large numeric trid should be accepted."""
        response = requests.get(f"{BASE_URL}/map.php?trid=999999999", timeout=10)
        assert response.status_code == 200
        assert "initMode = 1" in response.text

    def test_trid_zero_is_valid(self):
        """Zero should be a valid trid."""
        response = requests.get(f"{BASE_URL}/map.php?trid=0", timeout=10)
        assert response.status_code == 200
        # Zero is a valid digit, so initMode should be 1


class TestDataParameterFunctionality:
    """Test data parameter handling for valid inputs."""

    def test_valid_simple_data_parameter(self):
        """Simple data string should be accepted."""
        response = requests.get(f"{BASE_URL}/map.php?data=test", timeout=10)
        assert response.status_code == 200
        assert "initMode = 2" in response.text
        assert "postedData" in response.text

    def test_data_parameter_with_alphanumeric(self):
        """Alphanumeric data should be handled properly."""
        response = requests.get(f"{BASE_URL}/map.php?data=filter123", timeout=10)
        assert response.status_code == 200
        assert "initMode = 2" in response.text

    def test_data_parameter_empty_string(self):
        """Empty data parameter should not cause errors."""
        response = requests.get(f"{BASE_URL}/map.php?data=", timeout=10)
        assert response.status_code == 200


class TestPageIntegrity:
    """Test that pages maintain structural integrity."""

    def test_index_page_loads(self):
        """Index page should load successfully."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=10)
        assert response.status_code == 200

    def test_map_page_has_valid_html_structure(self):
        """Map page should have valid HTML structure."""
        response = requests.get(f"{BASE_URL}/map.php", timeout=10)
        assert response.status_code == 200
        # Check basic HTML structure
        assert "</html>" in response.text
        assert "</body>" in response.text

    def test_javascript_does_not_have_syntax_errors(self):
        """Page should not have obvious JavaScript syntax errors."""
        response = requests.get(f"{BASE_URL}/map.php?trid=123", timeout=10)
        assert response.status_code == 200
        # Basic check that script block is properly closed
        assert "</script>" in response.text
