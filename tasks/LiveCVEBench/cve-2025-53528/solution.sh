#!/bin/bash
set -e

# Find the cadwyn installation path (system install)
CADWYN_PATH=$(python -c "import cadwyn; import os; print(os.path.dirname(cadwyn.__file__))")
APP_FILE="${CADWYN_PATH}/applications.py"

echo "Applying fix to: ${APP_FILE}"

# Step 1: Add the import if not already present
if ! grep -q "from urllib.parse import quote" "$APP_FILE"; then
    # Add the import after the typing import line
    sed -i '/^from typing import/a from urllib.parse import quote' "$APP_FILE"
    echo "Added 'from urllib.parse import quote' import"
fi

# Step 2: Fix swagger_dashboard and redoc_dashboard using Python for reliability
python << 'PYTHON_SCRIPT'
import os
import cadwyn

cadwyn_path = os.path.dirname(cadwyn.__file__)
app_file = os.path.join(cadwyn_path, 'applications.py')

with open(app_file, 'r') as f:
    content = f.read()

# Check if already fixed
if 'quote(version, safe=' in content:
    print("Already fixed!")
else:
    # Fix the vulnerable lines (both occurrences)
    content = content.replace(
        'openapi_url = root_path + f"{self.openapi_url}?version={version}"',
        "openapi_url = root_path + f\"{self.openapi_url}?version={quote(version, safe='')}\""
    )

    with open(app_file, 'w') as f:
        f.write(content)

    # Verify fix was applied
    count = content.count("quote(version, safe='')")
    print(f"Fix applied to {count} locations")
PYTHON_SCRIPT

# Create marker file to signal that fix was applied
# This allows run-tests.sh to know it should apply the fix to its venv too
touch /app/.fix_applied

echo "Fix applied successfully to swagger_dashboard and redoc_dashboard"
echo "Version parameter is now URL-encoded using quote(version, safe='')"
