#!/bin/bash
set -e

echo "Applying fix for memory corruption in PdfTokenizer..."

SRC_FILE="/app/src/podofo/main/PdfTokenizer.cpp"

# Verify the source file exists
if [ ! -f "$SRC_FILE" ]; then
    echo "ERROR: Source file not found at $SRC_FILE"
    exit 1
fi

# Create backup
cp "$SRC_FILE" "$SRC_FILE.backup"

# Apply the fix using a patch
# The fix replaces early returns with 'goto Recovery' and adds a Recovery label
cat > /tmp/fix.patch << 'PATCH_EOF'
--- a/src/podofo/main/PdfTokenizer.cpp
+++ b/src/podofo/main/PdfTokenizer.cpp
@@ -304,7 +304,7 @@
                     // Don't consume the token
                     this->EnqueueToken(token, tokenType);
                     PoDoFo::LogMessage(PdfLogSeverity::Warning, "Invalid real while parsing content");
-                    return PdfLiteralDataType::Unknown;
+                    goto Recovery;
                 }

                 new(&variant.m_Real)PdfVariant::PrimitiveMember(val);
@@ -318,7 +318,7 @@
                     // Don't consume the token
                     this->EnqueueToken(token, tokenType);
                     PoDoFo::LogMessage(PdfLogSeverity::Warning, "Invalid number while parsing content");
-                    return PdfLiteralDataType::Unknown;
+                    goto Recovery;
                 }

                 if (!m_options.ReadReferences)
@@ -382,6 +382,7 @@
             }
             else
             {
+            Recovery:
                 new(&variant.m_Null)PdfVariant::NullMember();
                 return PdfLiteralDataType::Unknown;
             }
PATCH_EOF

cd /app

# Try to apply patch
if patch -p1 --dry-run < /tmp/fix.patch > /dev/null 2>&1; then
    echo "Patch can be applied cleanly, applying..."
    patch -p1 < /tmp/fix.patch
else
    echo "Patch failed to apply cleanly, using sed fallback..."

    # Fallback: Use sed to make the changes
    # Fix 1: Replace first 'return PdfLiteralDataType::Unknown;' after 'Invalid real' warning
    sed -i '/Invalid real while parsing content/{ n; s/return PdfLiteralDataType::Unknown;/goto Recovery;/ }' "$SRC_FILE"

    # Fix 2: Replace 'return PdfLiteralDataType::Unknown;' after 'Invalid number' warning
    sed -i '/Invalid number while parsing content/{ n; s/return PdfLiteralDataType::Unknown;/goto Recovery;/ }' "$SRC_FILE"

    # Fix 3: Add Recovery label before the null initialization in the else block
    # Find the pattern: else { new(&variant.m_Null) and add Recovery: label
    sed -i '/^            else$/{ n; /^            {$/a\            Recovery:' "$SRC_FILE"
fi

# Verify the fix was applied
if grep -q "goto Recovery;" "$SRC_FILE" && grep -q "Recovery:" "$SRC_FILE"; then
    echo "Fix applied successfully!"
else
    echo "WARNING: Fix may not have been applied correctly, checking diff..."
    diff "$SRC_FILE.backup" "$SRC_FILE" || true
fi

# Rebuild the project
echo "Rebuilding PoDoFo..."
cd /app/build

# Rebuild just the library and tools
cmake --build . -j$(nproc)

echo "Build completed successfully!"

# Verify the binary exists
if [ -f "/app/build/target/podofoencrypt" ]; then
    echo "podofoencrypt tool rebuilt successfully"
else
    echo "WARNING: podofoencrypt not found after rebuild"
fi

echo "Fix applied and project rebuilt!"
