#!/bin/bash
set -e

# Start MariaDB
service mariadb start

# Wait for MariaDB to be ready
echo "Waiting for MariaDB to start..."
until mysqladmin ping -h localhost --silent; do
    sleep 1
done
echo "MariaDB is ready."

# Initialize database if not already done
if ! mysql -e "USE wegia" 2>/dev/null; then
    echo "Initializing database..."
    mysql -e "CREATE DATABASE wegia CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
    mysql -e "CREATE USER 'wegia'@'localhost' IDENTIFIED BY 'wegia_password';"
    mysql -e "GRANT ALL PRIVILEGES ON wegia.* TO 'wegia'@'localhost';"
    mysql -e "FLUSH PRIVILEGES;"

    # Import schema
    mysql wegia < /task-deps/wegia001.sql

    echo "Database initialized."
else
    echo "Database already exists."
fi

# Ensure admin user and permissions exist
echo "Setting up admin user and permissions..."
mysql wegia << 'EOF'
-- Insert situacao (employment status) if not exists
INSERT IGNORE INTO situacao (id_situacao, situacoes) VALUES (1, 'Ativo');

-- Insert cargo (position) if not exists
INSERT IGNORE INTO cargo (id_cargo, cargo) VALUES (1, 'Administrador');

-- Insert admin user if not exists (password: 'wegia' hashed with SHA256)
INSERT IGNORE INTO pessoa (id_pessoa, cpf, senha, nome, adm_configurado) VALUES (1, 'admin', SHA2('wegia', 256), 'Admin', 1);

-- Insert funcionario for admin if not exists
INSERT IGNORE INTO funcionario (id_pessoa, id_cargo, id_situacao, data_admissao, ctps) VALUES (1, 1, 1, '2024-01-01', '12345');

-- Insert recurso for configurar_senhas if not exists
INSERT IGNORE INTO recurso (id_recurso, descricao) VALUES (91, 'configurar_senhas');

-- Insert acao if not exists (column is 'descricao', not 'nome_acao')
INSERT IGNORE INTO acao (id_acao, descricao) VALUES (2, 'editar');

-- Insert permission for admin role if not exists
INSERT IGNORE INTO permissao (id_cargo, id_recurso, id_acao) VALUES (1, 91, 2);
EOF
echo "Admin setup complete."

# Set permissions
chown -R www-data:www-data /var/www/html/WeGIA
chmod -R 755 /var/www/html/WeGIA

# Patch login.php to skip slow external release check (speeds up login from 60s to <1s)
sed -i 's|file_get_contents("https://www.wegia.org/software/release")|0|g' /var/www/html/WeGIA/html/login.php

# Create local release file
echo '9999999999' > /var/www/html/WeGIA/.release

# Start Apache in foreground
echo "Starting Apache..."
exec apache2ctl -D FOREGROUND
