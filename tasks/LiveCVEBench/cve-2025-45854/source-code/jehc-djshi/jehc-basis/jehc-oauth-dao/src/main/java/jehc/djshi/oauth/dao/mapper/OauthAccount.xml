<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jehc.djshi.oauth.dao.OauthAccountDao">

    <resultMap type="jehc.djshi.oauth.model.OauthAccount" id="OauthAccountResult">
        <result property="id"    column="id"    />
        <result property="accountTypeId"    column="account_type_id"    />
        <result property="name"    column="name"    />
        <result property="account"    column="account"    />
        <result property="status" column="status"/>
        <result property="email" column="email"/>
        <result property="pic" column="pic"/>
        <result property="smallPic" column="small_pic"/>
        <result property="phone" column="phone"/>
        <result property="createTime" column="create_time"/>
        <result property="createId" column="create_id"/>
        <result property="updateTime" column="update_time"/>
        <result property="updateId" column="update_id"/>
        <result property="lastLoginTime"    column="last_login_time"    />
        <association property="oauthAccountTypes" column="{id=account_type_id}" select="jehc.djshi.oauth.dao.OauthAccountTypeDao.getOauthAccountTypeList"></association>
    </resultMap>

    <!--初始化分页-->
    <select id="getOauthAccountList" resultMap="OauthAccountResult" parameterType="map">
        SELECT
            oauth_account.id,
            oauth_account.account_type_id,
            oauth_account.name,
            oauth_account.account,
            oauth_account.status,
            oauth_account.email,
            oauth_account.create_time,
            oauth_account.update_time,
            oauth_account.create_id,
            oauth_account.update_id,
            oauth_account.last_login_time,
            oauth_account.pic,
            oauth_account.small_pic,
            oauth_account.phone
        FROM
            oauth_account oauth_account
        WHERE 1=1
        <if test="null != name">
            AND oauth_account.name LIKE CONCAT(CONCAT('%',#{name}),'%')
        </if>
        <if test="null != account">
            AND oauth_account.account = #{account}
        </if>
        <if test="null != accountTypeId">
            <choose>
                <when test="typeCondition == 0">
                    <foreach item="item" index="index" collection="accountTypeId.split(',')" open=" " separator=" " close=" ">
                        AND FIND_IN_SET(#{item},account_type_id)
                    </foreach>
                </when>
                <otherwise>
                    AND (
                    <foreach item="item" index="ind" collection="accountTypeId.split(',')" open=" " separator=" OR " close=" ">
                        FIND_IN_SET(#{item},oauth_account.account_type_id)
                    </foreach>
                    )
                </otherwise>
            </choose>
        </if>
        <if test="null != status">
            AND oauth_account.status = #{status}
        </if>
        <if test="null != email">
            AND oauth_account.email = #{email}
        </if>
        <if test="null != phone">
            AND oauth_account.phone = #{phone}
        </if>
    </select>

    <!--查询对象-->
    <select id="getOauthAccountById" resultType="jehc.djshi.oauth.model.OauthAccount" parameterType="string">
        SELECT
            oauth_account.id,
            oauth_account.account_type_id AS accountTypeId,
            oauth_account.name,
            oauth_account.account,
            oauth_account.status,
            oauth_account.email,
            oauth_account.create_time AS createTime,
            oauth_account.update_time AS updateTime,
            oauth_account.create_id AS createId,
            oauth_account.update_id AS updateId,
            oauth_account.last_login_time AS lastLoginTime,
            oauth_account.pic,
            oauth_account.small_pic AS smallPic,
            oauth_account.phone,
            info_body AS infoBody
        FROM
            oauth_account oauth_account
        WHERE oauth_account.id=#{id}
    </select>

    <!--登录-->
    <select id="login" resultType="jehc.djshi.oauth.model.OauthAccount" parameterType="map">
        SELECT
            oauth_account.id,
            oauth_account.name,
            oauth_account.account,
            oauth_account.account_type_id AS accountTypeId,
            oauth_account.status,
            oauth_account.email,
            oauth_account.create_time AS createTime,
            oauth_account.update_time AS updateTime,
            oauth_account.create_id AS createId,
            oauth_account.update_id AS updateId,
            oauth_account.last_login_time AS lastLoginTime,
            oauth_account.info_body AS infoBody,
            oauth_account.pic,
            oauth_account.small_pic AS smallPic,
            oauth_account.phone
        FROM
            oauth_account oauth_account
        WHERE 1=1
          AND oauth_account.account=#{account}
          AND oauth_account.password = #{password}
          AND oauth_account.status = 0
    </select>

    <!--添加-->
    <insert id="addOauthAccount" parameterType="jehc.djshi.oauth.model.OauthAccount">
        INSERT INTO
        oauth_account
        (
            id,
            account,
            name,
            account_type_id,
            status,
            email,
            create_time,
            create_id,
            password,
            info_body,
            phone,
            pic,
            small_pic
        )
        VALUES
        (
            #{id},
            #{account},
            #{name},
            #{accountTypeId},
            0,
            #{email},
            #{createTime},
            #{createId},
            #{password},
            #{infoBody},
            #{phone},
            #{pic},
            #{smallPic}
        )
    </insert>

    <!--修改-->
    <update id="updateOauthAccount" parameterType="jehc.djshi.oauth.model.OauthAccount">
        UPDATE
            oauth_account
        <set>
            <if test="account != null">
                account = #{account},
            </if>
            <if test="name != null">
                name = #{name},
            </if>
            <if test="accountTypeId != null">
                account_type_id = #{accountTypeId},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="lastLoginTime != null">
                last_login_time = #{lastLoginTime},
            </if>
            <if test="password != null">
                password = #{password},
            </if>
            <if test="email != null">
                email =  #{email},
            </if>
            <if test="infoBody != null">
                info_body = #{infoBody},
            </if>
        </set>
        WHERE id=#{id}
    </update>

    <!--修改登录时间-->
    <update id="updateLoginTime" parameterType="jehc.djshi.oauth.model.OauthAccount">
        UPDATE
            oauth_account
            <set>
                <if test="lastLoginTime != null">
                    last_login_time = #{lastLoginTime},
                </if>
            </set>
        WHERE id=#{id}
    </update>

    <!-- 冻结 -->
    <update id="freezeAccount"  parameterType="jehc.djshi.oauth.model.OauthAccount">
        UPDATE
          oauth_account
        SET status = #{status}
        WHERE id=#{id}
    </update>

    <!--查询唯一对象-->
    <select id="getSingleOauthAccount" resultType="jehc.djshi.oauth.model.OauthAccount" parameterType="string">
        SELECT
            oauth_account.id,
            oauth_account.name,
            oauth_account.account,
            oauth_account.account_type_id AS accountTypeId,
            oauth_account.status,
            oauth_account.email,
            oauth_account.create_time AS createTime,
            oauth_account.update_time AS updateTime,
            oauth_account.create_id AS createId,
            oauth_account.update_id AS updateId,
            oauth_account.last_login_time AS lastLoginTime,
            oauth_account.info_body AS infoBody,
            oauth_account.pic,
            oauth_account.small_pic AS smallPic,
            oauth_account.phone
        FROM
            oauth_account oauth_account
        WHERE account=#{account}
    </select>

    <!--查询账户集合-->
    <select id="infoList" resultType="jehc.djshi.oauth.model.OauthAccount" parameterType="map">
        SELECT
            oauth_account.id,
            oauth_account.name,
            oauth_account.account,
            oauth_account.account_type_id AS accountTypeId,
            oauth_account.status,
            oauth_account.email,
            oauth_account.create_time AS createTime,
            oauth_account.update_time AS updateTime,
            oauth_account.create_id AS createId,
            oauth_account.update_id AS updateId,
            oauth_account.last_login_time AS lastLoginTime,
            oauth_account.info_body AS infoBody,
            oauth_account.pic,
            oauth_account.small_pic AS smallPic,
            oauth_account.phone
        FROM
        oauth_account oauth_account
        WHERE 1=1
        <if test="null != account">
            AND account IN
            <foreach item="item" index="index" collection="account" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <!--修改头像-->
    <update id="updateSmallPic" parameterType="jehc.djshi.oauth.model.OauthAccount">
        UPDATE
            oauth_account
        SET
            small_pic = #{smallPic},
            update_time = NOW()
        WHERE id=#{id}
    </update>

</mapper>