"""
Vulnerability tests for the isLength() function.
These tests verify that the Unicode variation selector bypass vulnerability is fixed.

- FAIL in vulnerable state (vulnerability is exploitable)
- PASS in fixed state (vulnerability is mitigated)
"""

import subprocess
import json
import pytest


def run_js(code):
    """Run JavaScript code and return output"""
    result = subprocess.run(
        ['node', '-e', code],
        capture_output=True,
        text=True,
        cwd='/app'
    )
    if result.returncode != 0:
        raise RuntimeError(f"JS execution failed: {result.stderr}")
    return result.stdout.strip()


class TestVariationSelectorBypass:
    """
    Test that Unicode variation selectors (U+FE0F, U+FE0E) cannot bypass
    the maximum length validation.

    The vulnerability was that ALL variation selectors were subtracted from
    the string length, regardless of context. This allowed attackers to craft
    strings with arbitrary amounts of these characters while passing max length checks.
    """

    def test_trailing_variation_selectors_bypass(self):
        """
        Trailing variation selectors should be counted toward string length.

        'test' + 4 variation selectors = 8 characters total.
        Should return false for max:4.
        """
        code = '''
        const v = require('validator');
        // 'test' (4 chars) + 4 variation selectors (\\uFE0F) = 8 chars total
        const testStr = 'test\\uFE0F\\uFE0F\\uFE0F\\uFE0F';
        const result = v.isLength(testStr, { max: 4 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Vulnerability present! String with 8 chars passed max:4 check. Got: {result}"

    def test_leading_variation_selectors_counted(self):
        """
        Leading variation selectors should be counted toward string length.

        2 leading selectors + 'test' = 6 characters total.
        Should return false for max:4.
        """
        code = '''
        const v = require('validator');
        // 2 leading variation selectors + 'test' = 6 chars
        const testStr = '\\uFE0F\\uFE0Ftest';
        const result = v.isLength(testStr, { max: 4 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Leading selectors not counted! String with 6 chars passed max:4. Got: {result}"

    def test_consecutive_variation_selectors_counted(self):
        """
        Consecutive variation selectors (not after base char) should be counted.

        Multiple consecutive selectors should only allow one to be excluded per base char.
        """
        code = '''
        const v = require('validator');
        // 'a' + 5 consecutive selectors = 6 chars, only 1 should be excluded = 5 counted
        const testStr = 'a\\uFE0F\\uFE0F\\uFE0F\\uFE0F\\uFE0F';
        const result = v.isLength(testStr, { max: 4 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Consecutive selectors not counted properly! Got: {result}"

    def test_extreme_selector_count(self):
        """
        Extreme case: 'a' + 100 variation selectors = 101 characters.
        Should return false for max:5.
        """
        code = '''
        const v = require('validator');
        // 'a' + 100 variation selectors = 101 chars total
        const testStr = 'a' + '\\uFE0F'.repeat(100);
        const result = v.isLength(testStr, { max: 5 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Extreme case not handled! 101-char string passed max:5. Got: {result}"

    def test_fe0e_selector_bypass(self):
        """
        Test with U+FE0E (Variation Selector-15) instead of U+FE0F.
        Same vulnerability applies to both selectors.
        """
        code = '''
        const v = require('validator');
        // 'test' + 4 FE0E selectors = 8 chars
        const testStr = 'test\\uFE0E\\uFE0E\\uFE0E\\uFE0E';
        const result = v.isLength(testStr, { max: 4 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"FE0E bypass vulnerability! String with 8 chars passed max:4. Got: {result}"

    def test_mixed_selectors_bypass(self):
        """
        Test with mixed U+FE0F and U+FE0E selectors.
        """
        code = '''
        const v = require('validator');
        // 'ab' + mixed selectors = 6 chars
        const testStr = 'ab\\uFE0F\\uFE0E\\uFE0F\\uFE0E';
        const result = v.isLength(testStr, { max: 4 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Mixed selector bypass! String with 6 chars passed max:4. Got: {result}"


class TestBoundaryConditions:
    """
    Test boundary conditions for the vulnerability fix.
    """

    def test_one_over_boundary_with_selectors(self):
        """
        String one char over max when selectors are properly counted.

        'abc' + 2 selectors = 5 raw chars
        With fix: only 1 selector is excluded (the one after 'c')
        Calculated length = 5 - 1 = 4 chars
        max: 3 should fail since 4 > 3
        """
        code = '''
        const v = require('validator');
        // 'abc' + 2 selectors = 5 chars, after fix 4 counted, max 3 should fail
        const testStr = 'abc\\uFE0F\\uFE0F';
        const result = v.isLength(testStr, { max: 3 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Boundary condition not handled! Got: {result}"

    def test_selector_only_string(self):
        """
        String containing only variation selectors.
        """
        code = '''
        const v = require('validator');
        // Only 3 selectors, no base char = 3 chars (all counted)
        const testStr = '\\uFE0F\\uFE0F\\uFE0F';
        const result = v.isLength(testStr, { max: 2 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Selector-only string not counted! Got: {result}"
