#!/bin/bash
set -e

# Solution for CVE-2025-9670: ReDoS vulnerability in turndown library
# This fix replaces vulnerable regex patterns with safe iterative string processing

cd /app

echo "Applying fix for turndown ReDoS vulnerability..."

TURNDOWN_LIB="/app/node_modules/turndown/lib"

if [ ! -d "$TURNDOWN_LIB" ]; then
    echo "Error: turndown library not found"
    exit 1
fi

# Use Python for reliable patching of all bundle files
python3 << 'PYTHONSCRIPT'
import os
import re
import glob

turndown_lib = "/app/node_modules/turndown/lib"
js_files = glob.glob(os.path.join(turndown_lib, "*.js"))

print(f"Found {len(js_files)} JavaScript files to patch")

for jsfile in js_files:
    print(f"\nProcessing: {jsfile}")

    with open(jsfile, 'r', encoding='utf-8') as f:
        content = f.read()

    original = content
    changes = []

    # Step 1: Add trimNewlines function after trimTrailingNewlines
    if 'function trimNewlines' not in content:
        pattern = r'(function trimTrailingNewlines\s*\([^)]*\)\s*\{[^}]+\})'
        match = re.search(pattern, content)
        if match:
            trimNewlines_func = '\n\nfunction trimNewlines(string) {\n  return trimTrailingNewlines(trimLeadingNewlines(string));\n}'
            content = content[:match.end()] + trimNewlines_func + content[match.end():]
            changes.append("Added trimNewlines function")

    # Step 2: Fix blockquote rule
    # Replace: content = content.replace(/^\n+|\n+$/g, '');
    # With: content = trimNewlines(content);
    blockquote_pattern = r"content\s*=\s*content\.replace\(/\^\\n\+\|\\n\+\$/g,\s*''\);"
    if re.search(blockquote_pattern, content):
        content = re.sub(blockquote_pattern, "content = trimNewlines(content);", content)
        changes.append("Fixed blockquote rule")

    # Step 3: Fix listItem rule - this is complex
    # We need to:
    # a) Remove the vulnerable chain at the start of replacement function
    # b) Add new code AFTER prefix is fully defined (after the if/else for OL)
    # c) Fix the return statement

    # Match the entire listItem replacement function body to restructure it
    # The structure in original:
    #   replacement: function (content, node, options) {
    #     content = content
    #       .replace(/^\n+/, '') // remove leading newlines
    #       .replace(/\n+$/, '\n') // replace trailing newlines
    #       .replace(/\n/gm, '\n    '); // indent
    #     var prefix = options.bulletListMarker + '   ';
    #     var parent = node.parentNode;
    #     if (parent.nodeName === 'OL') {
    #       var start = parent.getAttribute('start');
    #       var index = Array.prototype.indexOf.call(parent.children, node);
    #       prefix = (start ? Number(start) + index : index + 1) + '.  ';
    #     }
    #     return (
    #       prefix + content + (node.nextSibling && !/\n$/.test(content) ? '\n' : '')
    #     )
    #   }

    # Pattern to match the vulnerable chain (to be removed)
    vuln_chain = r"content\s*=\s*content\s*\n\s*\.replace\(/\^\\n\+/,\s*''\)\s*//[^\n]*\n\s*\.replace\(/\\n\+\$/,\s*'\\n'\)\s*//[^\n]*\n\s*\.replace\(/\\n/gm,\s*'\\n\s+'\);\s*//[^\n]*\n"

    if re.search(vuln_chain, content):
        # Remove the vulnerable chain
        content = re.sub(vuln_chain, "", content)
        changes.append("Removed vulnerable chain")

    # Now add the new code after the if block for OL
    # Pattern to find where to insert (after the closing brace of the if block)
    # Looking for: prefix = (start ? Number(start) + index : index + 1) + '.  ';\n    }\n
    insert_pattern = r"(prefix\s*=\s*\(start\s*\?\s*Number\(start\)\s*\+\s*index\s*:\s*index\s*\+\s*1\)\s*\+\s*'\.\s*';\s*\n\s*\})"

    # New code to insert (using \\n for literal backslash-n in the output file)
    new_code = "\n    var isParagraph = /\\\\n$/.test(content);\n    content = trimNewlines(content) + (isParagraph ? '\\\\n' : '');\n    content = content.replace(/\\\\n/gm, '\\\\n' + ' '.repeat(prefix.length));"

    if re.search(insert_pattern, content) and 'var isParagraph' not in content:
        content = re.sub(insert_pattern, r"\1" + new_code, content)
        changes.append("Added isParagraph logic")

    # Step 4: Fix return statement
    # Original: prefix + content + (node.nextSibling && !/\n$/.test(content) ? '\n' : '')
    # Fixed: prefix + content + (node.nextSibling ? '\n' : '')
    return_pattern = r"prefix\s*\+\s*content\s*\+\s*\(node\.nextSibling\s*&&\s*!/\\n\$/\.test\(content\)\s*\?\s*'\\n'\s*:\s*''\)"
    new_return = "prefix + content + (node.nextSibling ? '\\\\n' : '')"
    if re.search(return_pattern, content):
        content = re.sub(return_pattern, new_return, content)
        changes.append("Fixed listItem return")

    if content != original:
        with open(jsfile, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"  Changes: {', '.join(changes)}")
    else:
        print("  No changes needed")

print("\n" + "="*50)
print("Patching complete!")
print("="*50)
PYTHONSCRIPT

# Verify
echo ""
echo "Verifying patches..."

MAIN_FILE="$TURNDOWN_LIB/turndown.cjs.js"

if grep -q "function trimNewlines" "$MAIN_FILE"; then
    echo "✓ trimNewlines function added"
else
    echo "✗ trimNewlines function NOT found"
    exit 1
fi

if grep -q "trimNewlines(content)" "$MAIN_FILE"; then
    echo "✓ trimNewlines is being used"
else
    echo "✗ trimNewlines not being used"
fi

echo ""
echo "Fix applied successfully!"
