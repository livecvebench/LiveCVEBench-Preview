"""
Functional tests for Craft CMS UpdaterController.

These tests verify basic functionality and should PASS in both
vulnerable and fixed states.
"""

import hashlib
import hmac
import json
import os
import requests
import subprocess


class TestCraftCMSFunctionality:
    """Test suite for verifying Craft CMS core functionality."""

    BASE_URL = "http://localhost:80"
    SECURITY_KEY = "testkey123456789012345678901234"
    CONTROLLER_PATH = "/var/www/html/vendor/craftcms/cms/src/controllers/UpdaterController.php"

    def test_controller_file_exists(self):
        """Verify the UpdaterController.php file exists."""
        assert os.path.exists(self.CONTROLLER_PATH), \
            f"UpdaterController.php should exist at {self.CONTROLLER_PATH}"

    def test_controller_has_restore_db_action(self):
        """Verify the actionRestoreDb method exists in the controller."""
        with open(self.CONTROLLER_PATH, 'r') as f:
            content = f.read()

        assert 'public function actionRestoreDb()' in content or \
               'function actionRestoreDb()' in content, \
            "Controller should have actionRestoreDb method"

    def test_controller_has_required_imports(self):
        """Verify the controller has necessary use statements."""
        with open(self.CONTROLLER_PATH, 'r') as f:
            content = f.read()

        assert 'use Craft;' in content, "Should import Craft"
        assert 'use yii\\web\\BadRequestHttpException;' in content, \
            "Should import BadRequestHttpException"
        assert 'use yii\\web\\Response;' in content, "Should import Response"

    def test_controller_extends_base_controller(self):
        """Verify UpdaterController extends BaseUpdaterController."""
        with open(self.CONTROLLER_PATH, 'r') as f:
            content = f.read()

        assert 'extends BaseUpdaterController' in content, \
            "UpdaterController should extend BaseUpdaterController"

    def test_controller_has_proper_namespace(self):
        """Verify the controller has the correct namespace."""
        with open(self.CONTROLLER_PATH, 'r') as f:
            content = f.read()

        assert 'namespace craft\\controllers;' in content, \
            "Controller should have craft\\controllers namespace"

    def test_controller_syntax_valid(self):
        """Verify the PHP file has valid syntax."""
        result = subprocess.run(
            ['php', '-l', self.CONTROLLER_PATH],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0, \
            f"PHP syntax check failed: {result.stderr}"

    def test_web_server_responds(self):
        """Verify the web server is running and responds."""
        try:
            response = requests.get(self.BASE_URL, timeout=10)
            # Any response (even error) means server is running
            assert response.status_code is not None, \
                "Web server should respond"
        except requests.exceptions.ConnectionError:
            assert False, "Web server is not running or not accessible"

    def test_admin_endpoint_exists(self):
        """Verify the admin endpoint is accessible."""
        try:
            response = requests.get(f"{self.BASE_URL}/admin", timeout=10)
            # Should get some response (redirect, error page, etc.)
            # 404 means routing works but page not found
            # 500 might mean app error but endpoint exists
            assert response.status_code in [200, 302, 400, 403, 404, 500], \
                f"Admin endpoint should be accessible. Got {response.status_code}"
        except requests.exceptions.ConnectionError:
            assert False, "Cannot connect to admin endpoint"
