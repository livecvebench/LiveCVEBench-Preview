FROM ubuntu:22.04

WORKDIR /app

# Proxy will be injected via --build-arg during docker build

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies and required tools
RUN apt-get update && apt-get install -y \
    python3-pip python3-setuptools python3-wheel ninja-build \
    build-essential flex bison git cmake meson pkg-config \
    libsctp-dev libgnutls28-dev libgcrypt-dev libssl-dev \
    libmongoc-dev libbson-dev libyaml-dev \
    libnghttp2-dev libmicrohttpd-dev libcurl4-gnutls-dev \
    libtins-dev libtalloc-dev libidn11-dev \
    curl gnupg tmux asciinema \
    && rm -rf /var/lib/apt/lists/*

# Install MongoDB 6.0
RUN curl -fsSL https://www.mongodb.org/static/pgp/server-6.0.asc | \
    gpg --dearmor -o /usr/share/keyrings/mongodb-server-6.0.gpg && \
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] \
    https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | \
    tee /etc/apt/sources.list.d/mongodb-org-6.0.list && \
    apt-get update && apt-get install -y mongodb-org && \
    rm -rf /var/lib/apt/lists/*

# Create required directories
RUN mkdir -p /data/db /var/log/mongodb /var/run

# Clone Open5GS v2.7.0 (vulnerable version)
RUN git clone --depth 1 --branch v2.7.0 https://github.com/open5gs/open5gs.git /app && \
    rm -rf /app/.git

# Build Open5GS with Meson + Ninja
RUN meson build --prefix=/app/install && \
    ninja -C build && \
    cd build && ninja install

# Create log directory for Open5GS
RUN mkdir -p /app/install/var/log/open5gs

# Copy custom SMF config (without freeDiameter to avoid SCTP issues)
COPY task-deps/configs/smf.yaml /app/install/etc/open5gs/smf.yaml

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Copy pathswitchrequest.pcap for reference/testing
COPY task-deps/pathswitchrequest.pcap /app/pathswitchrequest.pcap

# Keep source code reference (vulnerability is at src/smf/ngap-handler.c)
# The src directory is part of the cloned repo, so it's already available

# CMD ["/entrypoint.sh"]  # Moved to docker-compose.yaml
