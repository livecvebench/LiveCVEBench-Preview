# Build stage - compile the application
FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build

WORKDIR /src


# Clone the vulnerable version of PubNet
RUN git clone --depth 1 --branch v1.1.2 https://github.com/ricardoboss/PubNet.git . && \
    rm -rf .git

# Restore dependencies
RUN dotnet restore PubNet.sln

# Build and publish the API
RUN dotnet build PubNet.API/PubNet.API.csproj -c Release
RUN dotnet publish PubNet.API/PubNet.API.csproj -c Release -o /app/publish --no-build

# Runtime stage - includes SDK for patching and rebuilding
FROM mcr.microsoft.com/dotnet/sdk:7.0 AS runtime

WORKDIR /app


# Install required tools (tmux, asciinema, curl, patch for solution.sh)
RUN apt-get update && \
    apt-get install -y git tmux asciinema curl patch procps gcc g++ wget && \
    rm -rf /var/lib/apt/lists/*

# Copy published application
COPY --from=build /app/publish /app/

# Copy source code for patching (solution.sh needs to modify .cs files)
COPY --from=build /src /src/

# Copy the entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Copy application configuration
COPY task-deps/backend-appsettings.json /app/appsettings.Production.json
COPY task-deps/backend-appsettings.json /app/appsettings.json

# Create packages directory
RUN mkdir -p /app/packages && chmod 777 /app/packages

# Environment variables
ENV ASPNETCORE_ENVIRONMENT=Production
ENV ASPNETCORE_URLS=http://+:80

# Use entrypoint script for restart capability
# CMD ["/entrypoint.sh"]
