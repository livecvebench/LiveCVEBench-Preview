#!/bin/bash
# Solution script for prototype pollution vulnerability in TOML parser
# Applies fix by replacing empty object literals {} with { __proto__: null }

set -e

cd /app

echo "Applying fix to toml/_parser.ts..."

# The vulnerability exists in 8 locations where empty object literals {} are used.
# Each {} inherits from Object.prototype, allowing __proto__ manipulation.
# The fix replaces {} with { __proto__: null } to break the prototype chain.

# Location 1: unflat function default parameter (line ~157)
# values: unknown = {} -> values: unknown = { __proto__: null }
sed -i 's/values: unknown = {}/values: unknown = { __proto__: null }/g' /app/toml/_parser.ts

# Location 2: merge function body initialization (line ~339)
# let body = {} -> let body = { __proto__: null }
sed -i 's/let body = {};/let body = { __proto__: null };/g' /app/toml/_parser.ts

# Locations 3 & 4: inlineTable function (lines ~747, ~751)
# return success({}) -> return success({ __proto__: null })
# let table = {} -> let table = { __proto__: null } as Record<string, unknown>
sed -i 's/return success({});/return success({ __proto__: null });/g' /app/toml/_parser.ts
sed -i 's/let table = {};/let table = { __proto__: null } as Record<string, unknown>;/g' /app/toml/_parser.ts

# Locations 5 & 6: table and tableArray functions (lines ~799, ~816)
# value: b.ok ? b.body.value : {} -> value: b.ok ? b.body.value : { __proto__: null }
sed -i 's/value: b\.ok ? b\.body\.value : {}/value: b.ok ? b.body.value : { __proto__: null }/g' /app/toml/_parser.ts

# Location 7: toml function - empty blocks case (line ~824)
# Already handled by the return success({}) replacement above

# Location 8: toml function - reduce initial value (line ~825)
# blocks.body.reduce(deepAssign, {}) -> blocks.body.reduce(deepAssign, { __proto__: null })
sed -i 's/blocks\.body\.reduce(deepAssign, {});/blocks.body.reduce(deepAssign, { __proto__: null });/g' /app/toml/_parser.ts

echo "Fix applied to _parser.ts"

# ============================================================================
# CRITICAL: Also fix the compiled JavaScript file (parse.js)
# Node.js executes the compiled JS, not the TypeScript source!
# ============================================================================

echo ""
echo "Applying fix to toml/parse.js (compiled JavaScript)..."

# Fix 1: unflat function default parameter (line ~212)
# values = {} -> values = { __proto__: null }
sed -i 's/function unflat(keys, values = {}) {/function unflat(keys, values = { __proto__: null }) {/g' /app/toml/parse.js

# Fix 2: merge function body initialization (line ~348)
# let body = {} -> let body = { __proto__: null }
sed -i 's/let body = {};/let body = { __proto__: null };/g' /app/toml/parse.js

# Fix 3 & 7: return success({}) patterns (lines ~726, ~794)
sed -i 's/return success({});/return success({ __proto__: null });/g' /app/toml/parse.js

# Fix 4: let table2 = {} (line ~731)
# In compiled JS, the variable is named table2
sed -i 's/let table2 = {};/let table2 = { __proto__: null };/g' /app/toml/parse.js

# Fix 5 & 6: ternary expressions (lines ~774, ~788)
sed -i 's/value: b\.ok ? b\.body\.value : {}/value: b.ok ? b.body.value : { __proto__: null }/g' /app/toml/parse.js

# Fix 8: reduce initial value (line ~795)
sed -i 's/blocks\.body\.reduce(deepAssign, {});/blocks.body.reduce(deepAssign, { __proto__: null });/g' /app/toml/parse.js

echo "Fix applied to parse.js"

# Verify the changes were applied
echo ""
echo "Verifying changes..."
TS_COUNT=$(grep -c '__proto__: null' /app/toml/_parser.ts || echo "0")
JS_COUNT=$(grep -c '__proto__: null' /app/toml/parse.js || echo "0")

echo "TypeScript fixes applied: $TS_COUNT"
echo "JavaScript fixes applied: $JS_COUNT"

if [ "$TS_COUNT" -lt 8 ]; then
    echo "WARNING: Expected at least 8 fixes in _parser.ts, found $TS_COUNT"
fi

if [ "$JS_COUNT" -lt 8 ]; then
    echo "WARNING: Expected at least 8 fixes in parse.js, found $JS_COUNT"
fi

if grep -q '__proto__: null' /app/toml/parse.js; then
    echo "Verification passed: __proto__: null patterns found in parse.js"
else
    echo "ERROR: Fix verification failed - no __proto__: null patterns found in parse.js"
    exit 1
fi

echo ""
echo "Solution applied. The TOML parser now creates objects without prototype chain."
