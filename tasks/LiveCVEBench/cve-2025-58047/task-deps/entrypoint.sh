#!/bin/bash

# Entrypoint script for Volto frontend with restart capability
# This script runs the Node.js server in a loop so that it can be restarted
# after applying patches via solution.sh

cd /app

# Wait for backend to be truly ready
echo "[entrypoint] Waiting for backend to be ready..."
max_retries=30
retry_count=0
while [ $retry_count -lt $max_retries ]; do
    if curl -s -o /dev/null -w "%{http_code}" http://backend-db:8080/Plone 2>/dev/null | grep -q "200\|302"; then
        echo "[entrypoint] Backend is ready!"
        break
    fi
    retry_count=$((retry_count + 1))
    echo "[entrypoint] Backend not ready yet (attempt $retry_count/$max_retries)..."
    sleep 5
done

while true; do
    echo "[entrypoint] Starting Volto frontend server..."

    # Run the Node.js server
    # The original image uses yarn start:prod
    yarn start:prod

    EXIT_CODE=$?
    echo "[entrypoint] Server exited with code $EXIT_CODE. Restarting in 10 seconds..."
    sleep 10
done
