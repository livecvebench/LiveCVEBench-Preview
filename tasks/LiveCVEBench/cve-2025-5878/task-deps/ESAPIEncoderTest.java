package com.test;

import org.owasp.esapi.Encoder;
import org.owasp.esapi.codecs.Codec;
import org.owasp.esapi.codecs.MySQLCodec;
import org.owasp.esapi.codecs.OracleCodec;
import org.owasp.esapi.reference.DefaultEncoder;

/**
 * Test harness for ESAPI SQL encoding.
 * Used by Python tests to verify encoding behavior.
 *
 * Usage: java -cp <classpath> com.test.ESAPIEncoderTest <codec> <input>
 *
 * codec: oracle | mysql_ansi | mysql_standard
 * input: string to encode (use __NULL__ for null test)
 *
 * Output format:
 *   ENCODED:<result>    - Successful encoding
 *   EXCEPTION:<message> - Exception was thrown
 */
public class ESAPIEncoderTest {

    public static void main(String[] args) {
        if (args.length < 2) {
            System.out.println("EXCEPTION:Usage: ESAPIEncoderTest <codec> <input>");
            System.out.println("  codec: oracle | mysql_ansi | mysql_standard");
            System.exit(1);
        }

        String codecType = args[0].toLowerCase();
        String input = args[1];

        // Handle null test
        if ("__NULL__".equals(input)) {
            input = null;
        }

        try {
            Encoder encoder = DefaultEncoder.getInstance();
            Codec<?> codec = getCodec(codecType);

            String result = encoder.encodeForSQL(codec, input);

            if (result == null) {
                System.out.println("ENCODED:__NULL__");
            } else {
                System.out.println("ENCODED:" + result);
            }

        } catch (Exception e) {
            // Capture exception details
            String message = e.getClass().getSimpleName() + ": " + e.getMessage();
            System.out.println("EXCEPTION:" + message);
        }
    }

    private static Codec<?> getCodec(String codecType) {
        switch (codecType) {
            case "oracle":
                return new OracleCodec();
            case "mysql_ansi":
                return new MySQLCodec(MySQLCodec.Mode.ANSI);
            case "mysql_standard":
                return new MySQLCodec(MySQLCodec.Mode.STANDARD);
            default:
                throw new IllegalArgumentException("Unknown codec: " + codecType);
        }
    }
}
