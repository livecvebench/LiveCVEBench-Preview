#!/usr/bin/env python3
"""
Vulnerability tests for LatePoint Local File Inclusion (CVE-2025-6715).

These tests verify the vulnerability status:
- FAIL in vulnerable state (vulnerability is exploitable)
- PASS in fixed state (vulnerability is mitigated)

The vulnerability is a PHP file INCLUSION, not file read. This means:
- Included PHP files are EXECUTED, not displayed
- We test by creating a marker PHP file and checking if it gets included

The tests attempt path traversal attacks via the 'layout' parameter.
"""

import os
import requests
import pytest
import time

BASE_URL = os.environ.get("TARGET_URL", "http://localhost:80")

# Unique marker that our test PHP file will output
VULN_MARKER = "CVE_2025_6715_LFI_VULNERABLE_MARKER"


def wait_for_server(url, timeout=60):
    """Wait for the server to be ready."""
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            response = requests.get(url, timeout=5)
            if response.status_code < 500:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


def wait_for_wordpress_ready(base_url, timeout=180):
    """Wait for WordPress and LatePoint plugin to be fully ready.

    This waits for:
    1. Server to respond
    2. WordPress homepage to return 200
    3. wp-admin to be accessible (indicates WordPress is installed)
    4. customer-cabinet to not return 500 (indicates LatePoint is activated)
    """
    start_time = time.time()

    # First wait for basic server response
    while time.time() - start_time < timeout:
        try:
            response = requests.get(base_url, timeout=5)
            if response.status_code == 200:
                break
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)

    # Wait for wp-admin to be accessible (indicates WordPress is installed)
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{base_url}/wp-admin/", timeout=5, allow_redirects=True)
            if response.status_code in [200, 301, 302]:
                break
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)

    # Wait for customer-cabinet to not return 500 (indicates LatePoint is activated)
    while time.time() - start_time < timeout:
        try:
            response = requests.get(f"{base_url}/customer-cabinet/", timeout=5)
            if response.status_code != 500:
                # Give a little extra time for full initialization
                time.sleep(5)
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)

    return False


def create_marker_file():
    """Create a PHP marker file that outputs a unique string when included."""
    marker_php = f'<?php echo "{VULN_MARKER}"; ?>'
    marker_path = "/tmp/lfi_test_marker.php"

    try:
        with open(marker_path, 'w') as f:
            f.write(marker_php)
        return True
    except Exception as e:
        print(f"Failed to create marker file: {e}")
        return False


@pytest.fixture(scope="module", autouse=True)
def setup_environment():
    """Setup test environment - create marker file and wait for server."""
    create_marker_file()
    assert wait_for_wordpress_ready(BASE_URL), f"WordPress at {BASE_URL} did not become ready in time"


class TestLFIVulnerability:
    """Test LFI vulnerability using marker file inclusion.

    These tests should FAIL when the vulnerability exists (marker appears in output)
    and PASS when the vulnerability is fixed (marker does not appear).
    """

    def test_lfi_basic_traversal(self):
        """Test basic LFI with path traversal to include marker file."""
        # /var/www/html/wp-content/plugins/latepoint/lib/views/layouts/
        # Need 9 levels up to reach root, then tmp/
        payload = "../../../../../../../../../tmp/lfi_test_marker"
        response = requests.get(
            f"{BASE_URL}/customer-cabinet/?layout={payload}",
            timeout=30
        )
        content = response.text

        # If vulnerable, our marker will appear in the output
        assert VULN_MARKER not in content, \
            "LFI vulnerability: marker file was included via path traversal"

    def test_lfi_url_encoded_traversal(self):
        """Test LFI with URL-encoded path traversal."""
        payload = "..%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2ftmp%2flfi_test_marker"
        response = requests.get(
            f"{BASE_URL}/customer-cabinet/?layout={payload}",
            timeout=30
        )
        content = response.text

        assert VULN_MARKER not in content, \
            "LFI vulnerability: URL-encoded path traversal succeeded"

    def test_lfi_uppercase_encoded_traversal(self):
        """Test LFI with uppercase URL-encoded path traversal."""
        payload = "..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Ftmp%2Flfi_test_marker"
        response = requests.get(
            f"{BASE_URL}/customer-cabinet/?layout={payload}",
            timeout=30
        )
        content = response.text

        assert VULN_MARKER not in content, \
            "LFI vulnerability: uppercase URL-encoded traversal succeeded"

    def test_lfi_deep_traversal(self):
        """Test LFI with excessive path traversal depth."""
        # More ../ than needed shouldn't affect the result
        payload = "../" * 15 + "tmp/lfi_test_marker"
        response = requests.get(
            f"{BASE_URL}/customer-cabinet/?layout={payload}",
            timeout=30
        )
        content = response.text

        assert VULN_MARKER not in content, \
            "LFI vulnerability: deep path traversal succeeded"

    def test_lfi_ten_levels_traversal(self):
        """Test LFI with 10 levels of path traversal."""
        payload = "../" * 10 + "tmp/lfi_test_marker"
        response = requests.get(
            f"{BASE_URL}/customer-cabinet/?layout={payload}",
            timeout=30
        )
        content = response.text

        assert VULN_MARKER not in content, \
            "LFI vulnerability: 10-level path traversal succeeded"
