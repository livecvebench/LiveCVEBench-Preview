"""
Functionality tests for the pet profile page.
These tests verify that the application works correctly for valid inputs.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import os

# Base URL for the application
BASE_URL = os.environ.get("APP_URL", "http://localhost:80")


def get_session_cookie():
    """
    Attempt to get a valid session by logging in.
    Returns session cookies if successful, None otherwise.
    """
    session = requests.Session()

    # Try to access login page first
    try:
        login_url = f"{BASE_URL}/html/login.php"
        resp = session.get(login_url, timeout=10)

        # Try logging in with default credentials
        # WeGIA uses 'cpf' and 'pwd' as field names
        login_data = {
            "cpf": "admin",
            "pwd": "wegia",  # Default WeGIA password
        }

        resp = session.post(login_url, data=login_data, timeout=10, allow_redirects=True)

        # Check if session has authenticated user
        if session.cookies.get("PHPSESSID"):
            return session
    except Exception as e:
        print(f"Login attempt failed: {e}")

    return session


class TestPetProfileFunctionality:
    """Tests for pet profile basic functionality."""

    def setup_method(self):
        """Set up session for each test."""
        self.session = get_session_cookie()

    def test_valid_pet_id_integer(self):
        """
        Test that valid integer pet IDs are accepted.
        Even if pet doesn't exist, the request should be processed
        (not rejected as invalid input).
        """
        url = f"{BASE_URL}/html/pet/profile_pet.php"

        # Try with a valid integer ID
        params = {"id_pet": "1"}

        start_time = time.time()
        try:
            resp = self.session.get(url, params=params, timeout=30, allow_redirects=True)
            elapsed = time.time() - start_time

            # Request should complete in reasonable time
            assert elapsed < 5, f"Request took too long: {elapsed}s"

            # Should not get a 400 error for valid integer
            # (may get redirect, 200, or 404 depending on if pet exists)
            # But NOT 400 for input validation
            # Note: In fixed state, valid integers should work
            # In vulnerable state, they also work
            assert resp.status_code in [200, 302, 303, 404], \
                f"Unexpected status {resp.status_code} for valid pet ID"

        except requests.exceptions.Timeout:
            # Timeout is also acceptable for this test
            pass

    def test_application_is_running(self):
        """Test that the application is accessible."""
        try:
            resp = requests.get(f"{BASE_URL}/", timeout=10, allow_redirects=True)
            # Any response means the app is running
            assert resp.status_code is not None, "No response from server"
        except requests.exceptions.ConnectionError:
            # This might fail if the app needs more time to start
            pytest.skip("Application not yet available")

    def test_login_page_accessible(self):
        """Test that the login page is accessible."""
        url = f"{BASE_URL}/html/login.php"
        try:
            resp = requests.get(url, timeout=10)
            assert resp.status_code in [200, 302, 303], \
                f"Login page returned {resp.status_code}"
        except requests.exceptions.ConnectionError:
            pytest.skip("Application not yet available")

    def test_pet_profile_requires_auth(self):
        """
        Test that pet profile page requires authentication.
        Without valid session, should redirect to login.
        """
        url = f"{BASE_URL}/html/pet/profile_pet.php"
        params = {"id_pet": "1"}

        # Use a fresh session without auth
        session = requests.Session()

        try:
            resp = session.get(url, params=params, timeout=10, allow_redirects=False)

            # Should redirect to login page (302/303) or return auth error
            # In vulnerable code, it redirects
            # In fixed code, it still redirects for unauthenticated users
            assert resp.status_code in [200, 302, 303, 401], \
                f"Unexpected status {resp.status_code}"
        except requests.exceptions.Timeout:
            pass  # May timeout which is OK


class TestValidInputHandling:
    """Tests for valid input scenarios."""

    def setup_method(self):
        """Set up session for each test."""
        self.session = get_session_cookie()

    def test_large_valid_pet_id(self):
        """Test that large but valid integer IDs are handled."""
        url = f"{BASE_URL}/html/pet/profile_pet.php"
        params = {"id_pet": "999999"}

        start_time = time.time()
        try:
            resp = self.session.get(url, params=params, timeout=30)
            elapsed = time.time() - start_time

            # Should respond quickly (not hang)
            assert elapsed < 5, f"Request took too long: {elapsed}s"

            # Valid integer should not trigger input validation error
            # Pet may not exist, but input format is valid
        except requests.exceptions.Timeout:
            pass

    def test_pet_id_with_leading_zeros(self):
        """Test pet ID with leading zeros (should work as it's numeric)."""
        url = f"{BASE_URL}/html/pet/profile_pet.php"
        params = {"id_pet": "001"}

        try:
            resp = self.session.get(url, params=params, timeout=30)
            # Leading zeros should be treated as valid integer "1"
            # Should not get 400 error
            # Note: In fixed state, FILTER_SANITIZE_NUMBER_INT handles this
        except requests.exceptions.Timeout:
            pass
