"""
Functional tests for Bagisto product description rendering.

These tests verify that the core product functionality works correctly,
including creating products and viewing them on the storefront.
"""

import pytest
import requests
import time
import re
import os

# Base URL for the Bagisto application
BASE_URL = os.environ.get("APP_URL", "http://localhost:8000")
ADMIN_URL = f"{BASE_URL}/admin"

# Default admin credentials
ADMIN_EMAIL = os.environ.get("ADMIN_EMAIL", "admin@example.com")
ADMIN_PASSWORD = os.environ.get("ADMIN_PASSWORD", "admin123")


class TestBagistoSetup:
    """Test that the Bagisto application is running and accessible."""

    def test_homepage_accessible(self):
        """Test that the storefront homepage is accessible."""
        response = requests.get(f"{BASE_URL}/", timeout=30)
        assert response.status_code == 200, f"Homepage not accessible: {response.status_code}"
        assert "Bagisto" in response.text or "bagisto" in response.text.lower(), \
            "Homepage does not appear to be Bagisto"

    def test_admin_login_page_accessible(self):
        """Test that the admin login page is accessible."""
        response = requests.get(f"{ADMIN_URL}/login", timeout=30)
        assert response.status_code == 200, f"Admin login page not accessible: {response.status_code}"


class BagistoAdminSession:
    """Helper class to manage authenticated admin sessions."""

    def __init__(self):
        self.session = requests.Session()
        self.csrf_token = None

    def get_csrf_token(self, url):
        """Extract CSRF token from a page."""
        response = self.session.get(url, timeout=30)
        # Try to find _token in form
        match = re.search(r'name="_token"\s+value="([^"]+)"', response.text)
        if match:
            return match.group(1)
        # Try to find in meta tag
        match = re.search(r'<meta name="csrf-token" content="([^"]+)"', response.text)
        if match:
            return match.group(1)
        return None

    def login(self):
        """Authenticate as admin."""
        login_url = f"{ADMIN_URL}/login"
        self.csrf_token = self.get_csrf_token(login_url)

        if not self.csrf_token:
            raise Exception("Could not get CSRF token for login")

        login_data = {
            "_token": self.csrf_token,
            "email": ADMIN_EMAIL,
            "password": ADMIN_PASSWORD,
        }

        response = self.session.post(login_url, data=login_data, timeout=30, allow_redirects=True)

        # Check if login was successful (redirected to dashboard or no error message)
        if "dashboard" in response.url.lower() or response.status_code == 200:
            # Verify we have access to admin pages
            dashboard_response = self.session.get(f"{ADMIN_URL}/dashboard", timeout=30)
            if dashboard_response.status_code == 200:
                return True

        return False


class TestProductFunctionality:
    """Test core product functionality."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = BagistoAdminSession()
        logged_in = session.login()
        assert logged_in, "Failed to login to admin panel"
        return session

    def test_admin_can_access_products(self, admin_session):
        """Test that admin can access the products list."""
        response = admin_session.session.get(
            f"{ADMIN_URL}/catalog/products",
            timeout=30
        )
        assert response.status_code == 200, \
            f"Could not access products page: {response.status_code}"

    def test_product_pages_render(self, admin_session):
        """Test that product pages on storefront render correctly."""
        # Get the storefront and look for product links
        response = requests.get(f"{BASE_URL}/", timeout=30)
        assert response.status_code == 200

        # Check if there are any products on the homepage
        # If yes, try to access one
        product_link_match = re.search(r'href="([^"]*?/products/[^"]+)"', response.text)
        if product_link_match:
            product_url = product_link_match.group(1)
            if not product_url.startswith("http"):
                product_url = f"{BASE_URL}{product_url}" if product_url.startswith("/") else f"{BASE_URL}/{product_url}"

            product_response = requests.get(product_url, timeout=30)
            assert product_response.status_code == 200, \
                f"Product page not accessible: {product_response.status_code}"

    def test_html_in_description_renders(self, admin_session):
        """Test that basic HTML in product descriptions renders properly."""
        # This test checks that legitimate HTML like <b>, <p>, <ul> still works
        # after any security fixes are applied.

        # Get products page to find existing products
        response = requests.get(f"{BASE_URL}/", timeout=30)

        # Look for any product page
        product_links = re.findall(r'href="([^"]*?/products/[^"]+)"', response.text)

        if product_links:
            # Check that at least one product page loads
            for link in product_links[:3]:  # Check first 3
                if not link.startswith("http"):
                    link = f"{BASE_URL}{link}" if link.startswith("/") else f"{BASE_URL}/{link}"

                product_response = requests.get(link, timeout=30)
                assert product_response.status_code == 200, \
                    f"Product page failed to load: {link}"

    def test_search_functionality(self):
        """Test that product search works."""
        search_url = f"{BASE_URL}/search"
        response = requests.get(search_url, params={"query": "product"}, timeout=30)
        # Search should return 200 (even if no results)
        assert response.status_code == 200, \
            f"Search functionality not working: {response.status_code}"


class TestAdminProductManagement:
    """Test admin product management functionality."""

    @pytest.fixture
    def admin_session(self):
        """Create an authenticated admin session."""
        session = BagistoAdminSession()
        logged_in = session.login()
        assert logged_in, "Failed to login to admin panel"
        return session

    def test_product_list_page_accessible(self, admin_session):
        """Test that the product list page is accessible.

        Note: In Bagisto 2.x, there's no GET route for /catalog/products/create.
        Product creation is handled via POST with Vue.js modal, so we test
        the products index page instead.
        """
        response = admin_session.session.get(
            f"{ADMIN_URL}/catalog/products",
            timeout=30
        )
        assert response.status_code == 200, \
            f"Product list page not accessible: {response.status_code}"

    def test_admin_dashboard_accessible(self, admin_session):
        """Test that admin dashboard is accessible after login."""
        response = admin_session.session.get(
            f"{ADMIN_URL}/dashboard",
            timeout=30
        )
        assert response.status_code == 200, \
            f"Admin dashboard not accessible: {response.status_code}"

    def test_catalog_menu_accessible(self, admin_session):
        """Test that catalog menu is accessible."""
        response = admin_session.session.get(
            f"{ADMIN_URL}/catalog/products",
            timeout=30
        )
        assert response.status_code == 200, \
            f"Catalog products not accessible: {response.status_code}"


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-rA"])
