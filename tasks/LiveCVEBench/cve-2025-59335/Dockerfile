FROM php:8.2-apache

WORKDIR /var/www/html

# System dependencies
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    unzip \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libzip-dev \
    libxml2-dev \
    libonig-dev \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# PHP extensions
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
    mysqli \
    pdo_mysql \
    gd \
    zip \
    xml \
    mbstring \
    soap

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Configure Apache
COPY task-deps/cubecart.conf /etc/apache2/conf-available/cubecart.conf
RUN a2enconf cubecart

# Download and setup CubeCart v6.5.10
RUN curl -L -o cubecart.tar.gz "https://api.github.com/repos/cubecart/v6/tarball/v6.5.10" \
    && tar -xzf cubecart.tar.gz --strip-components=1 \
    && rm cubecart.tar.gz \
    && rm -rf .git

# Set permissions
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

# Create writable directories with proper permissions
RUN mkdir -p /var/www/html/cache /var/www/html/files /var/www/html/images/source \
    && chmod -R 777 /var/www/html/cache /var/www/html/files /var/www/html/images /var/www/html/includes

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh && sed -i 's/\r$//' /entrypoint.sh

# Copy initialization SQL
COPY task-deps/init.sql /init.sql

# Copy global.inc.php template
COPY task-deps/global.inc.php /global.inc.php

# Copy SSL custom config to disable HTTPS redirect
COPY task-deps/ssl-custom.inc.php /var/www/html/ssl-custom.inc.php
RUN chown www-data:www-data /var/www/html/ssl-custom.inc.php

# PHP configuration
RUN echo "session.save_path = '/var/lib/php/sessions'" >> /usr/local/etc/php/php.ini-production \
    && mkdir -p /var/lib/php/sessions \
    && chown -R www-data:www-data /var/lib/php/sessions

# CMD ["/bin/bash", "/entrypoint.sh"]
