FROM php:7.4-apache

WORKDIR /var/www/html

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install mysqli

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Clone RemoteClinic repository and remove .git
RUN git clone --depth 1 https://github.com/remoteclinic/RemoteClinic.git /tmp/remoteclinic \
    && cp -r /tmp/remoteclinic/* /var/www/html/ \
    && rm -rf /tmp/remoteclinic \
    && rm -rf /var/www/html/.git

# Copy Docker-specific db.php
COPY task-deps/db-docker.php /var/www/html/pre-includes/db.php

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create required directories and set permissions
RUN mkdir -p /var/www/html/media/staff \
    && mkdir -p /var/www/html/uploads/staff \
    && chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html/media \
    && chmod -R 755 /var/www/html/uploads

# Configure Apache to allow .htaccess overrides
COPY task-deps/remoteclinic-apache.conf /etc/apache2/conf-available/remoteclinic.conf
RUN a2enconf remoteclinic

# PHP configuration for file uploads
COPY task-deps/php-uploads.ini /usr/local/etc/php/conf.d/uploads.ini

EXPOSE 80

# CMD ["/entrypoint.sh"]
