#!/bin/bash
# Solution script for CUPS IPv6 address parsing buffer underflow
set -e

cd /app/cups-2.4.14

echo "Applying fix to scheduler/conf.c..."

# Fix 1: Add bounds check to the IPv6 parsing loop condition
# The issue is that 'i' can become negative when there are excessive colons after ::
# Original: for (i = 0, ptr = value + 1; *ptr && i < 8; i ++)
# Fixed:    for (i = 0, ptr = value + 1; *ptr && i >= 0 && i < 8; i ++)
sed -i 's/for (i = 0, ptr = value + 1; \*ptr && i < 8; i ++)/for (i = 0, ptr = value + 1; *ptr \&\& i >= 0 \&\& i < 8; i ++)/' scheduler/conf.c

# Fix 2: Add negative check for IPv6 mask validation
# Original: if (i > 128)
# Fixed:    if (i < 0 || i > 128)
sed -i 's/if (i > 128)$/if (i < 0 || i > 128)/' scheduler/conf.c

# Fix 3: Add negative check for IPv4 mask validation
# Original: if (i > 32)
# Fixed:    if (i < 0 || i > 32)
sed -i 's/if (i > 32)$/if (i < 0 || i > 32)/' scheduler/conf.c

echo "Rebuilding CUPS..."

# Rebuild only the scheduler (faster than full rebuild)
make -C scheduler clean 2>/dev/null || true
make -j$(nproc)

echo "Fix applied successfully!"
echo ""
echo "Verification:"
grep -n "i >= 0 && i < 8" scheduler/conf.c || echo "Loop fix not found (may have different formatting)"
grep -n "i < 0 || i > 128" scheduler/conf.c || echo "IPv6 mask fix not found"
grep -n "i < 0 || i > 32" scheduler/conf.c || echo "IPv4 mask fix not found"
