FROM ubuntu:22.04

WORKDIR /app

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies and build tools
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-setuptools python3-wheel \
    ninja-build build-essential flex bison git cmake meson \
    libsctp-dev libgnutls28-dev libgcrypt-dev libssl-dev \
    libmongoc-dev libbson-dev libyaml-dev libnghttp2-dev \
    libmicrohttpd-dev libcurl4-gnutls-dev libtins-dev libtalloc-dev \
    libidn11-dev pkg-config procps curl wget \
    iproute2 iputils-ping net-tools \
    tmux asciinema \
    golang-go \
    && rm -rf /var/lib/apt/lists/*

# Clone Open5GS at vulnerable version and remove git history
RUN git clone --branch v2.7.5 --depth 1 https://github.com/open5gs/open5gs.git . && rm -rf .git

# Build Open5GS with Meson/Ninja
RUN meson build --prefix=/app/install && \
    ninja -C build && \
    ninja -C build install

# The build process installs config files to /app/install/etc/open5gs/
# UPF config uses 127.0.0.7 by default (PFCP and GTP-U)

# Set library path
ENV LD_LIBRARY_PATH=/app/install/lib:$LD_LIBRARY_PATH



# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh


# Start UPF with restart loop
# CMD moved to docker-compose.yaml
# CMD ["/entrypoint.sh"]
