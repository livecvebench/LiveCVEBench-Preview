#!/bin/bash
set -e

# First, run the original WordPress entrypoint to set up wp-config.php
# This uses docker-entrypoint.sh from the base image
docker-entrypoint.sh apache2-foreground &
APACHE_PID=$!

# Wait for Apache to start and WordPress files to be ready
echo "Waiting for WordPress files to be ready..."
for i in {1..60}; do
    if [ -f /var/www/html/wp-config.php ]; then
        echo "wp-config.php is ready!"
        break
    fi
    sleep 2
done

# Wait for database to be ready
echo "Waiting for database..."
while ! mysqladmin ping -h"$WORDPRESS_DB_HOST" -u"$WORDPRESS_DB_USER" -p"$WORDPRESS_DB_PASSWORD" --silent 2>/dev/null; do
    sleep 2
done
echo "Database is ready!"

# Wait for Apache to respond
echo "Waiting for Apache to respond..."
for i in {1..60}; do
    if curl -s http://localhost/ > /dev/null 2>&1; then
        echo "Apache is responding!"
        break
    fi
    sleep 2
done

# Function to run wp-cli commands
wp_cli() {
    wp "$@" --allow-root --path=/var/www/html
}

# Check if WordPress is already installed
if ! wp_cli core is-installed 2>/dev/null; then
    echo "Installing WordPress..."

    # Install WordPress
    wp_cli core install \
        --url="http://localhost" \
        --title="Test WordPress Site" \
        --admin_user="admin" \
        --admin_password="admin123" \
        --admin_email="admin@localhost.local" \
        --skip-email

    echo "WordPress installed successfully!"
fi

# Update site URLs if needed
wp_cli option update siteurl "http://localhost" 2>/dev/null || true
wp_cli option update home "http://localhost" 2>/dev/null || true

# Install and activate Ditty plugin if not already active
if ! wp_cli plugin is-active ditty-news-ticker 2>/dev/null; then
    echo "Activating Ditty plugin..."

    if [ -d /var/www/html/wp-content/plugins/ditty-news-ticker ]; then
        wp_cli plugin activate ditty-news-ticker
        echo "Ditty plugin activated!"
    else
        echo "ERROR: Ditty plugin not found!"
    fi
fi

# Flush rewrite rules to ensure REST API works
wp_cli rewrite structure '/%postname%/' 2>/dev/null || true
wp_cli rewrite flush 2>/dev/null || true

# Ensure proper permissions
chown -R www-data:www-data /var/www/html

echo "WordPress is ready with Ditty plugin!"

# Wait for Apache process
wait $APACHE_PID
