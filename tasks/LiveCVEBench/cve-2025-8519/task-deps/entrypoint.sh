#!/bin/bash
set -e

# Wait for database to be ready
echo "Waiting for MySQL to be ready..."
MAX_RETRIES=60
count=0
while [ $count -lt $MAX_RETRIES ]; do
    if mysql -h"${DB_HOST:-db}" -u"${DB_USER:-vvveb}" -p"${DB_PASSWORD:-vvveb}" --skip-ssl -e "SELECT 1" >/dev/null 2>&1; then
        echo "MySQL is ready!"
        break
    fi
    count=$((count + 1))
    echo "Waiting for MySQL... ($count/$MAX_RETRIES)"
    sleep 2
done

if [ $count -eq $MAX_RETRIES ]; then
    echo "WARNING: MySQL connection timed out, proceeding anyway..."
fi

# Set permissions
chmod -R 777 /var/www/html/storage 2>/dev/null || true
chmod -R 775 /var/www/html/public/themes 2>/dev/null || true
chmod -R 775 /var/www/html/public/media 2>/dev/null || true

# Check if Vvveb is already installed (config.php exists and has DB settings)
CONFIG_FILE="/var/www/html/config/config.php"
INSTALLED=false

if [ -f "$CONFIG_FILE" ]; then
    if grep -q "DB_HOST" "$CONFIG_FILE" 2>/dev/null; then
        INSTALLED=true
        echo "Vvveb appears to be already installed."
    fi
fi

# Run installation if not installed
if [ "$INSTALLED" = false ]; then
    echo "Installing Vvveb CMS..."
    cd /var/www/html

    # Run CLI installer
    php cli.php install module=index \
        host="${DB_HOST:-db}" \
        user="${DB_USER:-vvveb}" \
        password="${DB_PASSWORD:-vvveb}" \
        database="${DB_NAME:-vvveb}" \
        "admin[email]=admin@vvveb.com" \
        "admin[password]=admin" \
        2>&1 || echo "Installation may have encountered issues"

    echo "Installation complete!"
fi

# Ensure admin user has the correct credentials
echo "Ensuring admin credentials are set..."
ADMIN_HASH=$(php -r "echo password_hash('admin', PASSWORD_DEFAULT);")
mysql -h"${DB_HOST:-db}" -u"${DB_USER:-vvveb}" -p"${DB_PASSWORD:-vvveb}" --skip-ssl "${DB_NAME:-vvveb}" -e "UPDATE user SET email='admin@vvveb.com', username='admin', password='$ADMIN_HASH' WHERE user_id=1;" 2>/dev/null || echo "Admin user update may have failed"

# Start PHP-FPM in background
echo "Starting PHP-FPM..."
php-fpm -D

# Start Nginx in foreground
echo "Starting Nginx..."
exec nginx -g 'daemon off;'
