"""
Functionality tests for fonttools varLib variable font building.
These tests verify that normal font building operations work correctly.
Should PASS in both vulnerable and fixed states.
"""

import os
import sys
import tempfile
import pytest


def create_master_font(filepath, family_name="TestFont", style_name="Regular"):
    """Create a minimal TTF font for use as a designspace master."""
    from fontTools.fontBuilder import FontBuilder
    from fontTools.pens.ttGlyphPen import TTGlyphPen

    fb = FontBuilder(1000, isTTF=True)
    fb.setupGlyphOrder([".notdef", "space", "A"])
    fb.setupCharacterMap({32: "space", 65: "A"})

    # Draw a simple square glyph
    pen = TTGlyphPen(None)
    pen.moveTo((100, 0))
    pen.lineTo((100, 700))
    pen.lineTo((600, 700))
    pen.lineTo((600, 0))
    pen.closePath()
    glyph = pen.glyph()

    glyphs = {".notdef": glyph, "space": glyph, "A": glyph}
    fb.setupGlyf(glyphs)

    metrics = {".notdef": (600, 100), "space": (300, 0), "A": (700, 100)}
    fb.setupHorizontalMetrics(metrics)
    fb.setupHorizontalHeader(ascent=800, descent=-200)

    name_strings = {
        "familyName": family_name,
        "styleName": style_name,
        "uniqueFontIdentifier": f"{family_name}.{style_name}",
        "fullName": f"{family_name}-{style_name}",
        "psName": f"{family_name}-{style_name}",
        "version": "Version 1.0",
    }
    fb.setupNameTable(name_strings)
    fb.setupOS2(sTypoAscender=800, usWinAscent=800, usWinDescent=200)
    fb.setupPost()
    fb.save(filepath)


def create_designspace(output_dir, vf_filename="output.ttf"):
    """Create a valid designspace file with the given output filename."""
    designspace_content = f'''<?xml version='1.0' encoding='UTF-8'?>
<designspace format="5.0">
  <axes>
    <axis tag="wght" name="Weight" minimum="100" default="100" maximum="700"/>
  </axes>
  <sources>
    <source filename="source-light.ttf" name="Light Master">
      <lib copy="1"/>
      <groups copy="1"/>
      <info copy="1"/>
      <location>
        <dimension name="Weight" xvalue="100"/>
      </location>
    </source>
    <source filename="source-bold.ttf" name="Bold Master">
      <location>
        <dimension name="Weight" xvalue="700"/>
      </location>
    </source>
  </sources>
  <variable-fonts>
    <variable-font name="TestVF" filename="{vf_filename}">
      <axis-subsets>
        <axis-subset name="Weight"/>
      </axis-subsets>
    </variable-font>
  </variable-fonts>
</designspace>
'''
    ds_path = os.path.join(output_dir, "test.designspace")
    with open(ds_path, "w") as f:
        f.write(designspace_content)
    return ds_path


class TestVarLibFunctionality:
    """Test that varLib builds variable fonts correctly."""

    def test_builds_variable_font_from_designspace(self):
        """Test that varLib can successfully build a variable font."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            # Create source fonts
            create_master_font(os.path.join(tmpdir, "source-light.ttf"), "TestFont", "Light")
            create_master_font(os.path.join(tmpdir, "source-bold.ttf"), "TestFont", "Bold")

            # Create designspace with simple filename
            ds_path = create_designspace(tmpdir, "output.ttf")

            # Build variable font
            cwd = os.getcwd()
            os.chdir(tmpdir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Verify output exists
            output_path = os.path.join(tmpdir, "output.ttf")
            assert os.path.exists(output_path), "Variable font should be created"
            assert os.path.getsize(output_path) > 0, "Variable font should have content"

    def test_builds_variable_font_with_custom_name(self):
        """Test that custom output filenames work correctly."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            create_master_font(os.path.join(tmpdir, "source-light.ttf"), "TestFont", "Light")
            create_master_font(os.path.join(tmpdir, "source-bold.ttf"), "TestFont", "Bold")

            # Use a custom filename
            ds_path = create_designspace(tmpdir, "MyCustomFont-VF.ttf")

            cwd = os.getcwd()
            os.chdir(tmpdir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Should be created with the exact basename specified
            output_path = os.path.join(tmpdir, "MyCustomFont-VF.ttf")
            assert os.path.exists(output_path), "Custom named variable font should be created"

    def test_built_font_is_valid_ttf(self):
        """Test that the built variable font is a valid TrueType file."""
        from fontTools.varLib import main as varLib_main
        from fontTools.ttLib import TTFont

        with tempfile.TemporaryDirectory() as tmpdir:
            create_master_font(os.path.join(tmpdir, "source-light.ttf"), "TestFont", "Light")
            create_master_font(os.path.join(tmpdir, "source-bold.ttf"), "TestFont", "Bold")

            ds_path = create_designspace(tmpdir, "validated.ttf")

            cwd = os.getcwd()
            os.chdir(tmpdir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            output_path = os.path.join(tmpdir, "validated.ttf")

            # Load and verify it's a valid font
            font = TTFont(output_path)
            assert "fvar" in font, "Variable font should have fvar table"
            assert "glyf" in font, "Font should have glyf table"
            font.close()

    def test_designspace_without_explicit_filename(self):
        """Test that varLib handles designspace without explicit filename attribute."""
        from fontTools.varLib import main as varLib_main

        with tempfile.TemporaryDirectory() as tmpdir:
            create_master_font(os.path.join(tmpdir, "source-light.ttf"), "TestFont", "Light")
            create_master_font(os.path.join(tmpdir, "source-bold.ttf"), "TestFont", "Bold")

            # Create designspace without filename attribute - uses name instead
            designspace_content = '''<?xml version='1.0' encoding='UTF-8'?>
<designspace format="5.0">
  <axes>
    <axis tag="wght" name="Weight" minimum="100" default="100" maximum="700"/>
  </axes>
  <sources>
    <source filename="source-light.ttf" name="Light Master">
      <lib copy="1"/><groups copy="1"/><info copy="1"/>
      <location><dimension name="Weight" xvalue="100"/></location>
    </source>
    <source filename="source-bold.ttf" name="Bold Master">
      <location><dimension name="Weight" xvalue="700"/></location>
    </source>
  </sources>
  <variable-fonts>
    <variable-font name="NoFilenameVF">
      <axis-subsets><axis-subset name="Weight"/></axis-subsets>
    </variable-font>
  </variable-fonts>
</designspace>
'''
            ds_path = os.path.join(tmpdir, "no_filename.designspace")
            with open(ds_path, "w") as f:
                f.write(designspace_content)

            cwd = os.getcwd()
            os.chdir(tmpdir)
            try:
                varLib_main([ds_path])
            finally:
                os.chdir(cwd)

            # Should use the name attribute with extension
            output_path = os.path.join(tmpdir, "NoFilenameVF.ttf")
            assert os.path.exists(output_path), "Font should be created using name attribute"
