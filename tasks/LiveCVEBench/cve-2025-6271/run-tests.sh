#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== Setting up test environment ==="

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env
fi

# Initialize project and add dependencies
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

# Copy the malicious.wav to tests directory if not present
if [ -f "/app/task-deps/malicious.wav" ] && [ ! -f "/tests/malicious.wav" ]; then
    cp /app/task-deps/malicious.wav /tests/malicious.wav
fi

echo ""
echo "=== Running all tests ==="
# Run both test files in a single pytest command so the parser sees all results in one summary
uv run pytest test_func.py test_vuln.py -rA

echo ""
echo "=== All tests completed ==="
