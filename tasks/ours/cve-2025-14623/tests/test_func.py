"""
Functional tests for Student File Management System
These tests verify that the student update functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import requests
import time

BASE_URL = "http://localhost/SFMS"


class TestStudentUpdateFunctionality:
    """Tests for normal student update operations"""

    def test_update_student_basic(self):
        """Verify that basic student update works with valid data"""
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data={
                'stud_id': '1',
                'stud_no': '12345',
                'firstname': 'John',
                'lastname': 'Smith',
                'gender': 'Male',
                'year': '3',
                'section': 'A',
                'password': '12345',
                'update': ''
            },
            timeout=10
        )
        # The endpoint should process successfully
        assert response.status_code == 200

    def test_update_student_with_new_name(self):
        """Verify that updating student name works correctly"""
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data={
                'stud_id': '1',
                'stud_no': '12345',
                'firstname': 'UpdatedFirst',
                'lastname': 'UpdatedLast',
                'gender': 'Male',
                'year': '2',
                'section': 'B',
                'password': 'newpass123',
                'update': ''
            },
            timeout=10
        )
        assert response.status_code == 200
        # Check for success message or redirect script
        assert 'Successfully updated' in response.text or 'student.php' in response.text

    def test_update_student_female_gender(self):
        """Verify that female gender option works"""
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data={
                'stud_id': '1',
                'stud_no': '12345',
                'firstname': 'Jane',
                'lastname': 'Doe',
                'gender': 'Female',
                'year': '4',
                'section': 'C',
                'password': 'password',
                'update': ''
            },
            timeout=10
        )
        assert response.status_code == 200

    def test_update_student_all_year_sections(self):
        """Verify that different year/section combinations work"""
        year_sections = [('1', 'A'), ('2', 'B'), ('3', 'C'), ('4', 'D')]

        for year, section in year_sections:
            response = requests.post(
                f"{BASE_URL}/admin/update_student.php",
                data={
                    'stud_id': '1',
                    'stud_no': '12345',
                    'firstname': 'Test',
                    'lastname': 'Student',
                    'gender': 'Male',
                    'year': year,
                    'section': section,
                    'password': 'test',
                    'update': ''
                },
                timeout=10
            )
            assert response.status_code == 200, f"Failed for year={year}, section={section}"

    def test_update_without_update_flag_does_nothing(self):
        """Verify that request without 'update' field doesn't process"""
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data={
                'stud_id': '1',
                'stud_no': '99999',
                'firstname': 'Should',
                'lastname': 'NotUpdate',
                'gender': 'Male',
                'year': '1',
                'section': 'A',
                'password': 'test'
                # Note: 'update' field is missing
            },
            timeout=10
        )
        assert response.status_code == 200
        # Without 'update' field, no success message should appear
        assert 'Successfully updated' not in response.text

    def test_endpoint_responds_quickly(self):
        """Verify that normal requests complete in reasonable time"""
        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data={
                'stud_id': '1',
                'stud_no': '12345',
                'firstname': 'Quick',
                'lastname': 'Test',
                'gender': 'Male',
                'year': '1',
                'section': 'A',
                'password': 'test',
                'update': ''
            },
            timeout=10
        )
        elapsed = time.time() - start

        assert response.status_code == 200
        # Normal request should complete in under 2 seconds
        assert elapsed < 2.0, f"Request took too long: {elapsed}s"

    def test_update_with_special_characters_in_name(self):
        """Verify that special characters in name fields are handled"""
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data={
                'stud_id': '1',
                'stud_no': '12345',
                'firstname': "O'Connor",
                'lastname': 'Smith-Jones',
                'gender': 'Male',
                'year': '2',
                'section': 'A',
                'password': 'test',
                'update': ''
            },
            timeout=10
        )
        # Should handle without error (might have db issues but shouldn't crash)
        assert response.status_code == 200


class TestApplicationAvailability:
    """Tests to verify the application is running and accessible"""

    def test_admin_index_accessible(self):
        """Verify admin panel is accessible"""
        response = requests.get(f"{BASE_URL}/admin/", timeout=10)
        assert response.status_code == 200

    def test_admin_login_page_accessible(self):
        """Verify admin login page is accessible"""
        response = requests.get(f"{BASE_URL}/admin/login.php", timeout=10)
        assert response.status_code == 200

    def test_update_endpoint_exists(self):
        """Verify update_student.php endpoint exists"""
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data={},
            timeout=10
        )
        # Should return 200 even with empty data (just won't process)
        assert response.status_code == 200
