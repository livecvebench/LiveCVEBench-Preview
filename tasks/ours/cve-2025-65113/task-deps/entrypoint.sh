#!/bin/bash
set -e

# Create necessary directories and set permissions
mkdir -p /var/lib/mysql /run/mysqld /run/php /var/lib/nginx/body
chown -R mysql:mysql /var/lib/mysql /run/mysqld

# Terminate processes on exit
terminate_processes() {
    echo "Terminating processes..."
    kill -TERM "$mariadb_pid" "$php_pid" "$nginx_pid" 2>/dev/null || true
    wait "$mariadb_pid" "$php_pid" "$nginx_pid" 2>/dev/null || true
    echo "All processes terminated."
    exit 0
}

trap terminate_processes SIGTERM SIGINT

# Initialize MariaDB if not done
if [ ! -d "/var/lib/mysql/mysql" ]; then
    echo "Initializing MariaDB..."
    mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
fi

# Start MariaDB
echo "Starting MariaDB..."
mariadbd --user=mysql --datadir=/var/lib/mysql &
mariadb_pid=$!

# Wait for MariaDB socket
echo "Waiting for MariaDB socket..."
timeout=60
elapsed=0
while [ ! -e /var/run/mysqld/mysqld.sock ] && [ $elapsed -lt $timeout ]; do
    sleep 0.5
    elapsed=$((elapsed + 1))
done

if [ ! -e /var/run/mysqld/mysqld.sock ]; then
    echo "Error: MariaDB socket not created after $timeout attempts."
    exit 1
fi

echo "MariaDB socket ready."

# Set SQL mode to allow empty strings in integer fields (for vulnerability demonstration)
mysql -uroot -e "SET GLOBAL sql_mode = '';"

# Create database and user if not exists
if ! mysql -uroot -e "USE clipbucket" 2>/dev/null; then
    echo "Creating database and user..."
    mysql -uroot -e "CREATE DATABASE clipbucket;"
    mysql -uroot -e "CREATE USER 'clipbucket'@'localhost' IDENTIFIED BY 'clipbucket_password';"
    mysql -uroot -e "GRANT ALL PRIVILEGES ON clipbucket.* TO 'clipbucket'@'localhost';"
    mysql -uroot -e "FLUSH PRIVILEGES;"

    echo "Importing database schema..."
    # Import structure
    sed 's/{tbl_prefix}//g' /srv/http/clipbucket/upload/cb_install/sql/structure.sql | mysql -uroot clipbucket

    # Import essential data
    for sqlfile in configs.sql categories.sql countries.sql languages.sql user_levels.sql pages.sql email_templates.sql ads_placements.sql language_ENG.sql table_version.sql; do
        if [ -f "/srv/http/clipbucket/upload/cb_install/sql/$sqlfile" ]; then
            echo "Importing $sqlfile..."
            sed 's/{tbl_prefix}//g' "/srv/http/clipbucket/upload/cb_install/sql/$sqlfile" | mysql -uroot clipbucket 2>/dev/null || true
        fi
    done

    # Add admin user
    sed 's/{tbl_prefix}//g' /srv/http/clipbucket/upload/cb_install/sql/add_admin.sql | mysql -uroot clipbucket 2>/dev/null || true

    # Add anonymous user
    sed 's/{tbl_prefix}//g' /srv/http/clipbucket/upload/cb_install/sql/add_anonymous_user.sql | mysql -uroot clipbucket 2>/dev/null || true

    # Add flag types and element types
    echo "Setting up flag types..."
    mysql -uroot clipbucket -e "INSERT INTO flag_element_type (id_flag_element_type, name) VALUES (1, 'user'), (2, 'video'), (3, 'photo'), (4, 'collection') ON DUPLICATE KEY UPDATE name=VALUES(name);" 2>/dev/null || true
    mysql -uroot clipbucket -e "INSERT INTO flag_type (id_flag_type, name) VALUES (1, 'spam'), (2, 'inappropriate'), (3, 'copyright') ON DUPLICATE KEY UPDATE name=VALUES(name);" 2>/dev/null || true

    # Set database version
    echo "Setting database version..."
    mysql -uroot clipbucket -e "
    CREATE TABLE IF NOT EXISTS version(
        id INT(11) NOT NULL,
        version VARCHAR(16) NOT NULL,
        revision INT(11) NOT NULL,
        PRIMARY KEY (id)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_unicode_520_ci;
    INSERT INTO version (id, version, revision) VALUES (1, '5.5.2', 300) ON DUPLICATE KEY UPDATE version='5.5.2', revision=300;
    "

    # Remove foreign key constraint on flags.userid to allow vulnerability demonstration
    # The vulnerability is that flag_object accepts unauthenticated requests
    # The FK constraint would block the insert, but the vulnerability is the lack of auth check
    echo "Modifying flags table for vulnerability demonstration..."
    mysql -uroot clipbucket -e "
    ALTER TABLE flags DROP FOREIGN KEY fk_flag_userid;
    ALTER TABLE flags MODIFY userid BIGINT(20) NULL DEFAULT NULL;
    " 2>/dev/null || true

    echo "Database initialization complete."
else
    echo "Database already exists."
fi

# Create config.php with correct format
echo "Creating config.php..."
cat > /srv/http/clipbucket/upload/includes/config.php << 'EOFCONFIG'
<?php
// Database Host
$DBHOST = 'localhost';
// Database Name
$DBNAME = 'clipbucket';
// Database Username
$DBUSER = 'clipbucket';
// Database Password
$DBPASS = 'clipbucket_password';
// Database Port
$DBPORT = '3306';
// Setting Table Prefix
define('TABLE_PREFIX', '');
EOFCONFIG

# Set permissions
chown -R www-data:www-data /srv/http/clipbucket/upload/files /srv/http/clipbucket/upload/images /srv/http/clipbucket/upload/includes 2>/dev/null || true
chmod -R 755 /srv/http/clipbucket/upload/files /srv/http/clipbucket/upload/images 2>/dev/null || true

# Start PHP-FPM
echo "Starting PHP-FPM..."
php-fpm8.2 --nodaemonize --fpm-config /etc/php/8.2/fpm/php-fpm.conf &
php_pid=$!

# Wait for PHP-FPM socket
echo "Waiting for PHP-FPM socket..."
timeout=60
elapsed=0
while [ ! -e /run/php/php8.2-fpm.sock ] && [ $elapsed -lt $timeout ]; do
    sleep 0.5
    elapsed=$((elapsed + 1))
done

if [ ! -e /run/php/php8.2-fpm.sock ]; then
    echo "Error: PHP-FPM socket not created after $timeout attempts."
    exit 1
fi

chmod 666 /run/php/php8.2-fpm.sock
echo "PHP-FPM ready."

# Start Nginx
echo "Starting Nginx..."
nginx -g "daemon off;" &
nginx_pid=$!

echo "ClipBucket is ready at http://localhost/"

# Monitor processes
while true; do
    if ! kill -0 "$mariadb_pid" 2>/dev/null; then
        echo "MariaDB process has exited. Restarting..."
        mariadbd --user=mysql --datadir=/var/lib/mysql &
        mariadb_pid=$!
    fi
    if ! kill -0 "$php_pid" 2>/dev/null; then
        echo "PHP-FPM process has exited. Restarting..."
        php-fpm8.2 --nodaemonize --fpm-config /etc/php/8.2/fpm/php-fpm.conf &
        php_pid=$!
    fi
    if ! kill -0 "$nginx_pid" 2>/dev/null; then
        echo "Nginx process has exited. Restarting..."
        nginx -g "daemon off;" &
        nginx_pid=$!
    fi
    sleep 2
done
