/**
 * Test harness for the pollSubmitUserVote handler.
 *
 * This script reads test input from stdin as JSON, executes the
 * buildRedisMessage function, and outputs the result as JSON.
 *
 * Input format:
 * {
 *   "input": { "pollId": "...", "answerIds": [...] },
 *   "session": { "x-hasura-meetingid": "...", "x-hasura-userid": "..." }
 * }
 *
 * Output format (success):
 * { "success": true, "result": <RedisMessage> }
 *
 * Output format (error):
 * { "success": false, "error": "...", "status": 400 }
 */

import buildRedisMessage from './src/actions/pollSubmitUserVote';

async function main() {
    // Read input from stdin
    const chunks: Buffer[] = [];
    for await (const chunk of process.stdin) {
        chunks.push(chunk);
    }
    const inputStr = Buffer.concat(chunks).toString('utf8');

    try {
        const testData = JSON.parse(inputStr);
        const { input, session } = testData;

        try {
            const result = buildRedisMessage(session, input);
            console.log(JSON.stringify({
                success: true,
                result: result
            }));
        } catch (err: any) {
            // Handle validation errors from the handler
            console.log(JSON.stringify({
                success: false,
                error: err.message || String(err),
                status: err.status || 500
            }));
        }
    } catch (parseErr: any) {
        console.log(JSON.stringify({
            success: false,
            error: `Invalid JSON input: ${parseErr.message}`
        }));
        process.exit(1);
    }
}

main();
