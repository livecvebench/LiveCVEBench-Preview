"""
Functionality tests for turndown HTML-to-Markdown conversion.
These tests verify that normal HTML conversion works correctly.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import pytest


def run_node_script(script: str, timeout: int = 30) -> subprocess.CompletedProcess:
    """Execute a Node.js script and return the result."""
    return subprocess.run(
        ['node', '-e', script],
        capture_output=True,
        text=True,
        timeout=timeout,
        cwd='/app'
    )


class TestBasicConversion:
    """Test basic HTML to Markdown conversion functionality."""

    def test_heading_conversion(self):
        """Test that headings are converted correctly."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<h1>Hello World</h1>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        # Accept both ATX (# Hello World) and Setext (Hello World\n===) styles
        output = result.stdout.strip()
        assert 'Hello World' in output, f"Expected heading content, got: {output}"
        # Either # prefix or === underline
        assert '# Hello World' in output or '===' in output, f"Expected Markdown heading format, got: {output}"

    def test_paragraph_conversion(self):
        """Test that paragraphs are converted correctly."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<p>This is a paragraph.</p>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert 'This is a paragraph.' in result.stdout

    def test_multiple_headings(self):
        """Test conversion of multiple heading levels."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
const html = '<h1>Title</h1><h2>Subtitle</h2><h3>Section</h3>';
console.log(ts.turndown(html));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        output = result.stdout
        # Check content is present
        assert 'Title' in output
        assert 'Subtitle' in output
        assert 'Section' in output
        # H1 uses === in Setext or # in ATX
        # H2 uses --- in Setext or ## in ATX
        # H3 always uses ### in ATX (no Setext for h3)
        assert ('===' in output or '# Title' in output), f"H1 format incorrect: {output}"


class TestBlockquoteConversion:
    """Test blockquote HTML to Markdown conversion."""

    def test_simple_blockquote(self):
        """Test basic blockquote conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<blockquote>Quote text</blockquote>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert '> Quote text' in result.stdout, f"Expected blockquote, got: {result.stdout}"

    def test_blockquote_with_paragraph(self):
        """Test blockquote containing a paragraph."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<blockquote><p>Quoted paragraph</p></blockquote>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert '>' in result.stdout
        assert 'Quoted paragraph' in result.stdout

    def test_nested_blockquotes(self):
        """Test nested blockquote conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<blockquote><blockquote>Nested quote</blockquote></blockquote>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        # Should have multiple > characters for nesting
        assert 'Nested quote' in result.stdout

    def test_blockquote_with_small_newlines(self):
        """Test blockquote with a few newlines (should be fast in both versions)."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
const html = '<blockquote>\\n\\n\\nSome text after newlines</blockquote>';
const start = Date.now();
const result = ts.turndown(html);
const elapsed = Date.now() - start;
console.log(JSON.stringify({elapsed: elapsed, result: result}));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        import json
        data = json.loads(result.stdout)
        assert data['elapsed'] < 1000, f"Simple conversion should be fast, took {data['elapsed']}ms"
        assert 'Some text after newlines' in data['result']


class TestListConversion:
    """Test list HTML to Markdown conversion."""

    def test_unordered_list(self):
        """Test unordered list conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<ul><li>Item 1</li><li>Item 2</li></ul>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert 'Item 1' in result.stdout
        assert 'Item 2' in result.stdout

    def test_ordered_list(self):
        """Test ordered list conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<ol><li>First</li><li>Second</li><li>Third</li></ol>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert 'First' in result.stdout
        assert 'Second' in result.stdout
        assert 'Third' in result.stdout

    def test_nested_list(self):
        """Test nested list conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
const html = '<ul><li>Outer<ul><li>Inner</li></ul></li></ul>';
console.log(ts.turndown(html));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert 'Outer' in result.stdout
        assert 'Inner' in result.stdout

    def test_list_with_small_newlines(self):
        """Test list item with a few newlines (should be fast in both versions)."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
const html = '<ul><li>\\n\\n\\nItem with newlines</li></ul>';
const start = Date.now();
const result = ts.turndown(html);
const elapsed = Date.now() - start;
console.log(JSON.stringify({elapsed: elapsed, result: result}));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        import json
        data = json.loads(result.stdout)
        assert data['elapsed'] < 1000, f"Simple conversion should be fast, took {data['elapsed']}ms"


class TestLinkAndImageConversion:
    """Test link and image conversion."""

    def test_inline_link(self):
        """Test inline link conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<a href="https://example.com">Example</a>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert '[Example]' in result.stdout
        assert 'https://example.com' in result.stdout

    def test_image_conversion(self):
        """Test image conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<img src="image.png" alt="Alt text">'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert '![Alt text]' in result.stdout
        assert 'image.png' in result.stdout


class TestTextFormattingConversion:
    """Test text formatting conversion."""

    def test_bold_text(self):
        """Test bold text conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<strong>Bold text</strong>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert '**Bold text**' in result.stdout

    def test_italic_text(self):
        """Test italic text conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<em>Italic text</em>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert '_Italic text_' in result.stdout or '*Italic text*' in result.stdout

    def test_inline_code(self):
        """Test inline code conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<code>console.log()</code>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert '`console.log()`' in result.stdout


class TestCodeBlockConversion:
    """Test code block conversion."""

    def test_code_block(self):
        """Test code block conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<pre><code>function test() {}</code></pre>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        assert 'function test()' in result.stdout


class TestHorizontalRuleConversion:
    """Test horizontal rule conversion."""

    def test_horizontal_rule(self):
        """Test horizontal rule conversion."""
        script = '''
const TurndownService = require('turndown');
const ts = new TurndownService();
console.log(ts.turndown('<hr>'));
'''
        result = run_node_script(script)
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        # Horizontal rules can be ---, ***, ___, or * * * (with spaces)
        output = result.stdout.strip()
        valid_hr = any(x in output for x in ['---', '***', '___', '* * *', '- - -', '_ _ _'])
        assert valid_hr, f"Expected horizontal rule marker, got: {output}"
