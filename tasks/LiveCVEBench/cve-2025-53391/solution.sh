#!/bin/bash
# Solution script for zuluPolkit PolicyKit authorization issue
# This script fixes the insecure authorization configuration by changing auth_self to auth_admin

set -e

cd /app

echo "=== Fixing PolicyKit authorization configuration ==="

# The source file that generates the PolicyKit policy
CMAKE_FILE="/app/zuluPolkit/CMakeLists.txt"
POLICY_FILE="/usr/share/polkit-1/actions/org.zulucrypt.zulupolkit.policy"

# Check if the source file exists
if [ ! -f "$CMAKE_FILE" ]; then
    echo "ERROR: CMakeLists.txt not found at $CMAKE_FILE"
    exit 1
fi

# Check if the policy file exists
if [ ! -f "$POLICY_FILE" ]; then
    echo "ERROR: Policy file not found at $POLICY_FILE"
    exit 1
fi

echo ""
echo "=== Step 1: Fix source code (CMakeLists.txt) ==="

# Check if the fix has already been applied to source
if grep -q "<allow_any>auth_admin</allow_any>" "$CMAKE_FILE" && \
   grep -q "<allow_inactive>auth_admin</allow_inactive>" "$CMAKE_FILE" && \
   grep -q "<allow_active>auth_admin</allow_active>" "$CMAKE_FILE"; then
    if ! grep -q "auth_self" "$CMAKE_FILE"; then
        echo "Source code already fixed."
    else
        echo "Source has mixed auth values, applying fix..."
    fi
else
    echo "Applying fix to source code..."
fi

# Replace auth_self with auth_admin for all three authorization levels in source
sed -i 's/<allow_any>auth_self<\/allow_any>/<allow_any>auth_admin<\/allow_any>/g' "$CMAKE_FILE"
sed -i 's/<allow_inactive>auth_self<\/allow_inactive>/<allow_inactive>auth_admin<\/allow_inactive>/g' "$CMAKE_FILE"
sed -i 's/<allow_active>auth_self<\/allow_active>/<allow_active>auth_admin<\/allow_active>/g' "$CMAKE_FILE"

# Verify the source fix was applied
if grep -q "auth_self" "$CMAKE_FILE"; then
    echo "WARNING: auth_self still found in source file"
    exit 1
else
    echo "Source code verified: no auth_self remaining"
fi

echo ""
echo "=== Step 2: Fix installed policy file directly ==="

# Replace auth_self with auth_admin in the installed policy file
# This is faster than rebuilding and achieves the same result
sed -i 's/<allow_any>auth_self<\/allow_any>/<allow_any>auth_admin<\/allow_any>/g' "$POLICY_FILE"
sed -i 's/<allow_inactive>auth_self<\/allow_inactive>/<allow_inactive>auth_admin<\/allow_inactive>/g' "$POLICY_FILE"
sed -i 's/<allow_active>auth_self<\/allow_active>/<allow_active>auth_admin<\/allow_active>/g' "$POLICY_FILE"

# Also handle potential whitespace variations
sed -i 's/>auth_self</>auth_admin</g' "$POLICY_FILE"

# Verify the policy fix was applied
if grep -q "auth_self" "$POLICY_FILE"; then
    echo "ERROR: auth_self still found in policy file"
    exit 1
else
    echo "Policy file verified: no auth_self remaining"
fi

echo ""
echo "=== Step 3: Verify the fix ==="

# Count auth_admin in source
SOURCE_ADMIN_COUNT=$(grep -c "auth_admin" "$CMAKE_FILE" || echo "0")
echo "Source file has $SOURCE_ADMIN_COUNT auth_admin entries"

# Count auth_admin in policy
POLICY_ADMIN_COUNT=$(grep -c "auth_admin" "$POLICY_FILE" || echo "0")
echo "Policy file has $POLICY_ADMIN_COUNT auth_admin entries"

# Verify minimum count
if [ "$SOURCE_ADMIN_COUNT" -lt 3 ]; then
    echo "WARNING: Expected at least 3 auth_admin entries in source"
fi

if [ "$POLICY_ADMIN_COUNT" -lt 3 ]; then
    echo "WARNING: Expected at least 3 auth_admin entries in policy"
fi

echo ""
echo "=== Fix complete ==="
echo "The authorization vulnerability has been fixed."
echo "PolicyKit now requires administrator authentication for zuluPolkit."
echo ""
echo "Summary:"
echo "  - Source CMakeLists.txt: Fixed (auth_self -> auth_admin)"
echo "  - Installed policy file: Fixed (auth_self -> auth_admin)"
