"""
Functional tests for ESAPI SQL encoding.

These tests verify that the encoding functionality works correctly for
normal inputs - they should PASS in both vulnerable and fixed states.
"""

import subprocess
import pytest
import os

# Path to the test harness JAR in the container
TEST_JAR = "/app/target/esapi-test-1.0-SNAPSHOT-jar-with-dependencies.jar"


def run_encode_test(codec_type: str, input_str: str) -> dict:
    """
    Run the ESAPI encode test and return results.

    Args:
        codec_type: 'oracle' or 'mysql_ansi' or 'mysql_standard'
        input_str: The input string to encode

    Returns:
        dict with 'encoded' (string result or None), 'exception' (bool), 'message' (str)
    """
    cmd = [
        "java", "-cp", TEST_JAR,
        "com.test.ESAPIEncoderTest",
        codec_type,
        input_str
    ]

    result = subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        timeout=30
    )

    stdout = result.stdout.strip()
    stderr = result.stderr.strip()

    # Parse the output
    response = {
        'encoded': None,
        'exception': False,
        'message': ''
    }

    if "EXCEPTION:" in stdout:
        response['exception'] = True
        response['message'] = stdout.split("EXCEPTION:", 1)[1].strip()
    elif "ENCODED:" in stdout:
        response['encoded'] = stdout.split("ENCODED:", 1)[1].strip()
    else:
        response['message'] = stdout + "\n" + stderr

    return response


class TestBasicFunctionalityOracle:
    """Test basic encoding functionality with Oracle codec."""

    def test_normal_alphanumeric_input(self):
        """Normal alphanumeric input should pass through unchanged."""
        result = run_encode_test("oracle", "test_user")
        # In fixed version, exception is expected; in vulnerable version, encoding works
        if result['exception']:
            # Fixed version - method is disabled, which is acceptable
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "test_user"

    def test_single_quote_doubling(self):
        """Single quotes should be doubled (standard SQL escaping)."""
        result = run_encode_test("oracle", "O'Brien")
        if result['exception']:
            # Fixed version - method is disabled
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "O''Brien"

    def test_multiple_quotes(self):
        """Multiple single quotes should each be doubled."""
        result = run_encode_test("oracle", "It's John's")
        if result['exception']:
            # Fixed version
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "It''s John''s"

    def test_empty_string(self):
        """Empty string should return empty string."""
        result = run_encode_test("oracle", "")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == ""

    def test_space_is_preserved(self):
        """Spaces should be preserved (they're in IMMUNE_SQL)."""
        result = run_encode_test("oracle", "test user")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "test user"

    def test_numbers_preserved(self):
        """Numbers should pass through unchanged."""
        result = run_encode_test("oracle", "12345")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "12345"


class TestBasicFunctionalityMySQLANSI:
    """Test basic encoding functionality with MySQL ANSI codec."""

    def test_normal_alphanumeric_input(self):
        """Normal alphanumeric input should pass through unchanged."""
        result = run_encode_test("mysql_ansi", "test_user")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "test_user"

    def test_single_quote_doubling(self):
        """Single quotes should be doubled in ANSI mode."""
        result = run_encode_test("mysql_ansi", "O'Brien")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "O''Brien"

    def test_multiple_special_chars(self):
        """Test input with various characters."""
        result = run_encode_test("mysql_ansi", "hello world 123")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            assert result['encoded'] == "hello world 123"


class TestBasicFunctionalityMySQLStandard:
    """Test basic encoding functionality with MySQL Standard codec."""

    def test_normal_alphanumeric_input(self):
        """Normal alphanumeric input should be encoded (underscore escaped in standard mode)."""
        result = run_encode_test("mysql_standard", "test_user")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            # MySQL Standard mode escapes underscores as they are LIKE wildcards
            # test_user -> test\_user
            assert result['encoded'] == "test\\_user"

    def test_single_quote_escape(self):
        """Single quotes should be backslash-escaped in standard mode."""
        result = run_encode_test("mysql_standard", "O'Brien")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            # Standard mode uses \' not ''
            assert result['encoded'] == "O\\'Brien"

    def test_backslash_escape(self):
        """Backslashes should be double-escaped in standard mode."""
        result = run_encode_test("mysql_standard", "path\\to\\file")
        if result['exception']:
            assert "disabled" in result['message'].lower() or "not" in result['message'].lower()
        else:
            # Backslashes become double backslashes
            assert "\\\\" in result['encoded']


class TestNullHandling:
    """Test null input handling."""

    def test_null_returns_null(self):
        """Null input should return null (handled by Java test harness)."""
        # This is tested implicitly - the Java code handles null
        # If we send "NULL" as a special marker, test harness handles it
        result = run_encode_test("oracle", "__NULL__")
        # The test passes if it doesn't crash
        assert True


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
