"""
Functionality tests for Assimp library.
These tests verify that the library correctly processes valid 3D model files.
Should PASS in both vulnerable and fixed states.
"""
import subprocess
import os
import tempfile
import pytest


ASSIMP_BIN = "/app/bin/assimp"
TIMEOUT = 60


class TestBasicFunctionality:
    """Test basic file processing functionality."""

    def test_assimp_binary_exists(self):
        """Test that the assimp binary is available."""
        assert os.path.exists(ASSIMP_BIN), f"Assimp binary not found at {ASSIMP_BIN}"

    def test_assimp_help_command(self):
        """Test that assimp responds to help command."""
        result = subprocess.run(
            [ASSIMP_BIN, "--help"],
            capture_output=True,
            timeout=TIMEOUT
        )
        # Help command should run without crashing
        # Return code may be 0 or 1 depending on implementation
        output = result.stdout.decode('utf-8', errors='ignore') + result.stderr.decode('utf-8', errors='ignore')
        assert 'assimp' in output.lower() or result.returncode in (0, 1)

    def test_process_valid_obj_file(self):
        """Test processing a valid OBJ file."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.obj', delete=False) as f:
            f.write("# Simple triangle\n")
            f.write("v 0.0 0.0 0.0\n")
            f.write("v 1.0 0.0 0.0\n")
            f.write("v 0.5 1.0 0.0\n")
            f.write("f 1 2 3\n")
            obj_path = f.name

        try:
            result = subprocess.run(
                [ASSIMP_BIN, "info", obj_path],
                capture_output=True,
                timeout=TIMEOUT
            )
            # Should process successfully
            assert result.returncode == 0, f"Failed to process OBJ: {result.stderr.decode('utf-8', errors='ignore')}"
        finally:
            os.unlink(obj_path)

    def test_process_valid_obj_cube(self):
        """Test processing a valid OBJ cube mesh."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.obj', delete=False) as f:
            f.write("# Cube vertices\n")
            f.write("v 0 0 0\n")
            f.write("v 1 0 0\n")
            f.write("v 1 1 0\n")
            f.write("v 0 1 0\n")
            f.write("v 0 0 1\n")
            f.write("v 1 0 1\n")
            f.write("v 1 1 1\n")
            f.write("v 0 1 1\n")
            f.write("# Cube faces\n")
            f.write("f 1 2 3 4\n")
            f.write("f 5 6 7 8\n")
            f.write("f 1 2 6 5\n")
            f.write("f 2 3 7 6\n")
            f.write("f 3 4 8 7\n")
            f.write("f 4 1 5 8\n")
            obj_path = f.name

        try:
            result = subprocess.run(
                [ASSIMP_BIN, "info", obj_path],
                capture_output=True,
                timeout=TIMEOUT
            )
            assert result.returncode == 0, f"Failed: {result.stderr.decode('utf-8', errors='ignore')}"
            stdout = result.stdout.decode('utf-8', errors='ignore')
            # Should detect some geometry
            assert 'mesh' in stdout.lower() or 'vertices' in stdout.lower() or 'faces' in stdout.lower()
        finally:
            os.unlink(obj_path)

    def test_process_valid_obj_with_normals(self):
        """Test processing OBJ file with normals."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.obj', delete=False) as f:
            f.write("# Triangle with normals\n")
            f.write("v 0.0 0.0 0.0\n")
            f.write("v 1.0 0.0 0.0\n")
            f.write("v 0.5 1.0 0.0\n")
            f.write("vn 0.0 0.0 1.0\n")
            f.write("f 1//1 2//1 3//1\n")
            obj_path = f.name

        try:
            result = subprocess.run(
                [ASSIMP_BIN, "info", obj_path],
                capture_output=True,
                timeout=TIMEOUT
            )
            assert result.returncode == 0
        finally:
            os.unlink(obj_path)


class TestValidLWSFiles:
    """Test processing of valid LightWave Scene files."""

    def test_process_minimal_lws(self):
        """Test processing a minimal valid LWS file."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.lws', delete=False) as f:
            f.write("LWSC\n")
            f.write("5\n")
            f.write("\n")
            f.write("FirstFrame 0\n")
            f.write("LastFrame 60\n")
            f.write("FrameStep 1\n")
            f.write("FramesPerSecond 30\n")
            lws_path = f.name

        try:
            result = subprocess.run(
                [ASSIMP_BIN, "info", lws_path],
                capture_output=True,
                timeout=TIMEOUT
            )
            # May fail gracefully (empty scene) but should not crash
            stderr = result.stderr.decode('utf-8', errors='ignore')
            # Should not contain crash indicators
            assert "SEGV" not in stderr
            assert "AddressSanitizer" not in stderr
            assert "stack-buffer-overflow" not in stderr
        finally:
            os.unlink(lws_path)


class TestErrorHandling:
    """Test error handling for invalid inputs."""

    def test_nonexistent_file(self):
        """Test handling of non-existent file."""
        result = subprocess.run(
            [ASSIMP_BIN, "info", "/nonexistent/file.obj"],
            capture_output=True,
            timeout=TIMEOUT
        )
        # Should return error code but not crash
        stderr = result.stderr.decode('utf-8', errors='ignore')
        assert "SEGV" not in stderr
        assert "AddressSanitizer" not in stderr

    def test_empty_file(self):
        """Test handling of empty file."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.obj', delete=False) as f:
            f.write("")
            empty_path = f.name

        try:
            result = subprocess.run(
                [ASSIMP_BIN, "info", empty_path],
                capture_output=True,
                timeout=TIMEOUT
            )
            # Should handle gracefully, not crash
            stderr = result.stderr.decode('utf-8', errors='ignore')
            assert "SEGV" not in stderr
            assert "AddressSanitizer" not in stderr
        finally:
            os.unlink(empty_path)

    def test_invalid_format_content(self):
        """Test handling of file with invalid content."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.obj', delete=False) as f:
            f.write("this is not a valid obj file\n")
            f.write("random garbage content\n")
            invalid_path = f.name

        try:
            result = subprocess.run(
                [ASSIMP_BIN, "info", invalid_path],
                capture_output=True,
                timeout=TIMEOUT
            )
            # Should handle gracefully
            stderr = result.stderr.decode('utf-8', errors='ignore')
            assert "SEGV" not in stderr
            assert "AddressSanitizer" not in stderr
        finally:
            os.unlink(invalid_path)


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
