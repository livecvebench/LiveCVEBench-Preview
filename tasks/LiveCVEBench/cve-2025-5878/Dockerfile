FROM maven:3.9-eclipse-temurin-8

WORKDIR /app


# Install required system packages (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    python3 \
    && rm -rf /var/lib/apt/lists/*

# Configure Maven proxy in settings.xml
RUN mkdir -p /root/.m2
COPY task-deps/settings.xml /root/.m2/settings.xml

# Create directory structure
RUN mkdir -p src/main/java/com/test src/main/resources/esapi

# Copy test harness pom.xml and Java test file
COPY task-deps/test-pom.xml pom.xml
COPY task-deps/ESAPIEncoderTest.java src/main/java/com/test/

# Copy ESAPI configuration files
COPY task-deps/ESAPI.properties src/main/resources/esapi/
COPY task-deps/validation.properties src/main/resources/esapi/

# Build the project (downloads ESAPI 2.6.2.0 as dependency and creates fat JAR)
RUN mvn clean package -DskipTests -q

# Keep container running
CMD ["tail", "-f", "/dev/null"]
