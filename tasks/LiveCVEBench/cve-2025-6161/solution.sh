#!/bin/bash
set -e

echo "Applying fix to editproduct.php..."

# Define the file path
EDITPRODUCT_FILE="/var/www/html/ordersimple/editproduct.php"

# Verify file exists
if [ ! -f "$EDITPRODUCT_FILE" ]; then
    echo "Error: editproduct.php not found at $EDITPRODUCT_FILE"
    exit 1
fi

# Create backup
cp "$EDITPRODUCT_FILE" "${EDITPRODUCT_FILE}.bak"

# Apply the fix by replacing the entire file with the fixed version
cat > "$EDITPRODUCT_FILE" << 'EOFPHP'
<?php
	include('conn.php');

	$id=$_GET['product'];

	$pname=$_POST['pname'];
	$category=$_POST['category'];
	$price=$_POST['price'];

	$sql="select * from product where productid='$id'";
	$query=$conn->query($sql);
	$row=$query->fetch_array();

	$fileinfo=PATHINFO($_FILES["photo"]["name"]);

	if (empty($fileinfo['filename']) && empty($fileinfo['extension'])){
		$location = $row['photo'];
	}
	else{
		// Reject files that start with a dot (e.g., .htaccess)
		$original_filename = $_FILES["photo"]["name"];
		if (strpos($original_filename, '.') === 0) {
			die("Error: Invalid filename. Files starting with a dot are not allowed.");
		}

		// Validate file extension exists
		if (empty($fileinfo['extension'])) {
			die("Error: File must have an extension.");
		}

		// Validate file extension
		$allowed_extensions = array('jpg', 'jpeg', 'png', 'gif');
		$file_extension = strtolower($fileinfo['extension']);

		if (!in_array($file_extension, $allowed_extensions)) {
			die("Error: Only image files (jpg, jpeg, png, gif) are allowed.");
		}

		// Validate MIME type
		$finfo = finfo_open(FILEINFO_MIME_TYPE);
		$mime_type = finfo_file($finfo, $_FILES["photo"]["tmp_name"]);
		finfo_close($finfo);

		$allowed_mime_types = array('image/jpeg', 'image/png', 'image/gif');
		if (!in_array($mime_type, $allowed_mime_types)) {
			die("Error: Invalid file type. Only image files are allowed.");
		}

		// Generate secure filename
		$newFilename = uniqid() . "_" . time() . "." . $file_extension;
		move_uploaded_file($_FILES["photo"]["tmp_name"],"upload/" . $newFilename);
		$location="upload/" . $newFilename;
	}

	$sql="update product set productname='$pname', categoryid='$category', price='$price', photo='$location' where productid='$id'";
	$conn->query($sql);

	header('location:product.php');
?>
EOFPHP

echo "Fix applied successfully to editproduct.php"
echo "Changes made:"
echo "  - Added extension whitelist validation (jpg, jpeg, png, gif only)"
echo "  - Added MIME type validation using finfo_file()"
echo "  - Changed filename generation to use uniqid() for security"

# Verify fix was applied
if grep -q "allowed_extensions" "$EDITPRODUCT_FILE" && grep -q "finfo_open" "$EDITPRODUCT_FILE"; then
    echo "Verification: Fix successfully applied"
else
    echo "Warning: Fix verification failed"
    exit 1
fi
