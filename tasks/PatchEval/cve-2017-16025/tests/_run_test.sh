#!/bin/bash
# From ghcr.io/anonymous2578-data/cve-2017-16025:latest
# bash /workspace/fix-run.sh
set -e

cd /workspace/nes

GLOBAL_EXCLUDE="AggregateError,Atomics,BigUint64Array,BigInt64Array,BigInt,FinalizationRegistry,WeakRef,URL,URLSearchParams,DOMException,AbortController,AbortSignal,Event,EventTarget,TextEncoder,TextDecoder,TransformStream,TransformStreamDefaultController,WritableStream,WritableStreamDefaultController,WritableStreamDefaultWriter,ReadableStream,ReadableStreamDefaultReader,ReadableStreamBYOBReader,ReadableStreamBYOBRequest,ReadableByteStreamController,ReadableStreamDefaultController,ByteLengthQueuingStrategy,CountQueuingStrategy,TextEncoderStream,TextDecoderStream,CompressionStream,DecompressionStream,queueMicrotask,structuredClone,atob,btoa,BroadcastChannel,MessageChannel,MessagePort,Blob,File,Performance,PerformanceEntry,PerformanceMark,PerformanceMeasure,PerformanceObserver,PerformanceObserverEntryList,PerformanceResourceTiming,performance,fetch,FormData,Headers,Request,Response,MessageEvent,WebSocket,Iterator,SharedArrayBuffer,Navigator,navigator,crypto,CryptoKey,SubtleCrypto,CustomEvent,Crypto"

export NODE_NO_WARNINGS=1
git apply --whitespace=nowarn /tests/test.patch 
node node_modules/lab/bin/lab \
    -a code \
    --globals $GLOBAL_EXCLUDE \
    -g "errors on invalid cookie" \
    test/auth.js


cd /workspace
#!/bin/bash
# From ghcr.io/anonymous2578-data/cve-2017-16025:latest
# bash /workspace/unit_test.sh
set -e

cd /workspace/nes

GLOBAL_EXCLUDE="AggregateError,Atomics,BigUint64Array,BigInt64Array,BigInt,FinalizationRegistry,WeakRef,URL,URLSearchParams,DOMException,AbortController,AbortSignal,Event,EventTarget,TextEncoder,TextDecoder,TransformStream,TransformStreamDefaultController,WritableStream,WritableStreamDefaultController,WritableStreamDefaultWriter,ReadableStream,ReadableStreamDefaultReader,ReadableStreamBYOBReader,ReadableStreamBYOBRequest,ReadableByteStreamController,ReadableStreamDefaultController,ByteLengthQueuingStrategy,CountQueuingStrategy,TextEncoderStream,TextDecoderStream,CompressionStream,DecompressionStream,queueMicrotask,structuredClone,atob,btoa,BroadcastChannel,MessageChannel,MessagePort,Blob,File,Performance,PerformanceEntry,PerformanceMark,PerformanceMeasure,PerformanceObserver,PerformanceObserverEntryList,PerformanceResourceTiming,performance,fetch,FormData,Headers,Request,Response,MessageEvent,WebSocket,Iterator,SharedArrayBuffer,Navigator,navigator,crypto,CryptoKey,SubtleCrypto,CustomEvent,Crypto"

export NODE_NO_WARNINGS=1

node node_modules/lab/bin/lab \
    -a code \
    --globals $GLOBAL_EXCLUDE \
    test/index.js test/auth.js test/listener.js test/socket.js
