#!/usr/bin/env python3
"""
Functionality tests for WP Go Maps Nominatim geocoding cache.

These tests verify that the core geocoding cache functionality works correctly
in both vulnerable and fixed states. All tests should PASS regardless of
whether the fix has been applied.
"""

import pytest
import requests
import json
import os
import time
import uuid

BASE_URL = os.environ.get("WORDPRESS_URL", "http://localhost")
AJAX_URL = f"{BASE_URL}/wp-admin/admin-ajax.php"
TIMEOUT = 30


def wait_for_wordpress(max_wait=60):
    """Wait for WordPress to be ready."""
    start = time.time()
    while time.time() - start < max_wait:
        try:
            response = requests.get(BASE_URL, timeout=5)
            if response.status_code in (200, 301, 302, 403):
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


@pytest.fixture(scope="session", autouse=True)
def setup_wordpress():
    """Ensure WordPress is ready before running tests."""
    assert wait_for_wordpress(), "WordPress did not become ready in time"


class TestCacheStorage:
    """Test that cache storage functionality works correctly."""

    def test_store_valid_geocode_data(self):
        """Test storing valid geocoding response data."""
        unique_key = f"TestCity_{uuid.uuid4().hex[:8]}"

        valid_response = json.dumps([{
            "display_name": "Test City, Test Country",
            "lat": "40.7128",
            "lon": "-74.0060",
            "boundingbox": ["40.4774", "40.9176", "-74.2591", "-73.7004"]
        }])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }

        response = requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

        result = response.json()
        # In fixed version, success=1; in vulnerable version, also success=1 for valid data
        assert result.get('success') == 1, f"Store operation failed: {result}"

    def test_store_multiple_results(self):
        """Test storing multiple geocoding results for a single query."""
        unique_key = f"MultiResult_{uuid.uuid4().hex[:8]}"

        valid_response = json.dumps([
            {
                "display_name": "Paris, France",
                "lat": "48.8566",
                "lon": "2.3522",
                "boundingbox": ["48.8", "48.9", "2.2", "2.4"]
            },
            {
                "display_name": "Paris, Texas, USA",
                "lat": "33.6609",
                "lon": "-95.5555",
                "boundingbox": ["33.5", "33.7", "-95.6", "-95.5"]
            }
        ])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }

        response = requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)
        assert response.status_code == 200

        result = response.json()
        assert result.get('success') == 1


class TestCacheRetrieval:
    """Test that cache retrieval functionality works correctly."""

    def test_retrieve_cached_data(self):
        """Test retrieving previously cached geocoding data."""
        unique_key = f"RetrieveTest_{uuid.uuid4().hex[:8]}"

        # Store data first
        valid_response = json.dumps([{
            "display_name": "Seoul, South Korea",
            "lat": "37.5665",
            "lon": "126.9780",
            "boundingbox": ["37.5", "37.6", "126.9", "127.0"]
        }])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }
        requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)

        # Retrieve data
        query_params = {
            'action': 'wpgmza_query_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}})
        }
        response = requests.get(AJAX_URL, params=query_params, timeout=TIMEOUT)

        assert response.status_code == 200
        result = response.json()

        # Should return array with results
        assert isinstance(result, list), f"Expected list, got {type(result)}"
        assert len(result) > 0, "Expected at least one result"

        # Check data integrity
        first_result = result[0]
        assert "lat" in first_result or "lat" in str(first_result)
        assert "lon" in first_result or "lon" in str(first_result)

    def test_retrieve_nonexistent_query(self):
        """Test retrieving data for a query that doesn't exist in cache."""
        nonexistent_key = f"NonExistent_{uuid.uuid4().hex[:16]}"

        query_params = {
            'action': 'wpgmza_query_nominatim_cache',
            'query': json.dumps({"location": nonexistent_key, "options": {"address": nonexistent_key}})
        }
        response = requests.get(AJAX_URL, params=query_params, timeout=TIMEOUT)

        assert response.status_code == 200
        result = response.json()

        # Should return empty array for nonexistent query
        assert isinstance(result, list), f"Expected list, got {type(result)}"
        assert len(result) == 0, f"Expected empty result, got {result}"


class TestDataIntegrity:
    """Test that stored data maintains integrity."""

    def test_coordinates_preserved(self):
        """Test that latitude and longitude values are preserved correctly."""
        unique_key = f"CoordTest_{uuid.uuid4().hex[:8]}"

        expected_lat = "51.5074"
        expected_lon = "-0.1278"

        valid_response = json.dumps([{
            "display_name": "London, UK",
            "lat": expected_lat,
            "lon": expected_lon,
            "boundingbox": ["51.3", "51.7", "-0.5", "0.3"]
        }])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }
        requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)

        # Retrieve and verify
        query_params = {
            'action': 'wpgmza_query_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}})
        }
        response = requests.get(AJAX_URL, params=query_params, timeout=TIMEOUT)
        result = response.json()

        assert len(result) > 0, "No results returned"

        # Check coordinates are preserved (as strings or numbers)
        result_str = json.dumps(result)
        assert "51.5074" in result_str or "51.507" in result_str, "Latitude not preserved"
        assert "-0.1278" in result_str or "-0.127" in result_str, "Longitude not preserved"

    def test_display_name_stored(self):
        """Test that display names are stored (sanitized in fixed version)."""
        unique_key = f"DisplayTest_{uuid.uuid4().hex[:8]}"

        location_name = "Tokyo, Japan"

        valid_response = json.dumps([{
            "display_name": location_name,
            "lat": "35.6762",
            "lon": "139.6503",
            "boundingbox": ["35.5", "35.8", "139.5", "139.8"]
        }])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }
        requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)

        # Retrieve and verify
        query_params = {
            'action': 'wpgmza_query_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}})
        }
        response = requests.get(AJAX_URL, params=query_params, timeout=TIMEOUT)
        result = response.json()

        assert len(result) > 0, "No results returned"

        # Display name should contain the text (sanitized or not)
        result_str = json.dumps(result)
        assert "Tokyo" in result_str, "Display name not preserved"


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_unicode_location_names(self):
        """Test that unicode characters in location names are handled."""
        unique_key = f"Unicode_{uuid.uuid4().hex[:8]}"

        # Unicode location name
        unicode_name = "東京, 日本"

        valid_response = json.dumps([{
            "display_name": unicode_name,
            "lat": "35.6762",
            "lon": "139.6503",
            "boundingbox": ["35.5", "35.8", "139.5", "139.8"]
        }])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }
        response = requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)

        # Should succeed regardless of unicode content
        assert response.status_code == 200

    def test_special_characters_in_query(self):
        """Test queries with special characters."""
        unique_key = f"Special_Test_{uuid.uuid4().hex[:8]}"

        valid_response = json.dumps([{
            "display_name": "Test Location",
            "lat": "0",
            "lon": "0",
            "boundingbox": ["0", "0", "0", "0"]
        }])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }
        response = requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)

        assert response.status_code == 200

    def test_bounding_box_preserved(self):
        """Test that bounding box arrays are preserved."""
        unique_key = f"BBox_{uuid.uuid4().hex[:8]}"

        bbox = ["37.5", "37.6", "126.9", "127.0"]

        valid_response = json.dumps([{
            "display_name": "Test City",
            "lat": "37.55",
            "lon": "126.95",
            "boundingbox": bbox
        }])

        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': valid_response
        }
        requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)

        query_params = {
            'action': 'wpgmza_query_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}})
        }
        response = requests.get(AJAX_URL, params=query_params, timeout=TIMEOUT)
        result = response.json()

        assert len(result) > 0, "No results returned"

        # Check bounding box is present
        result_str = json.dumps(result)
        assert "boundingbox" in result_str or "37.5" in result_str


class TestAJAXEndpoints:
    """Test that AJAX endpoints are accessible."""

    def test_store_endpoint_accessible(self):
        """Test that the store AJAX endpoint is accessible with valid data."""
        unique_key = f"StoreTest_{uuid.uuid4().hex[:8]}"

        # Send valid data to properly test endpoint accessibility
        store_data = {
            'action': 'wpgmza_store_nominatim_cache',
            'query': json.dumps({"location": unique_key, "options": {"address": unique_key}}),
            'response': json.dumps([{
                "display_name": "Test Location",
                "lat": "0",
                "lon": "0",
                "boundingbox": ["0", "0", "0", "0"]
            }])
        }
        response = requests.post(AJAX_URL, data=store_data, timeout=TIMEOUT)

        # Should get a success response
        assert response.status_code == 200
        result = response.json()
        assert result.get('success') == 1, f"Store endpoint not accessible: {result}"

    def test_query_endpoint_accessible(self):
        """Test that the query AJAX endpoint is accessible."""
        response = requests.get(AJAX_URL, params={
            'action': 'wpgmza_query_nominatim_cache',
            'query': '{}'
        }, timeout=TIMEOUT)

        # Should get a response
        assert response.status_code == 200
