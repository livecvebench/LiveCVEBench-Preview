#!/bin/bash
set -e

# Create required directories
mkdir -p /run/php
mkdir -p /var/log/supervisor

# Wait for PostgreSQL
echo "Waiting for PostgreSQL to be ready..."
until pg_isready -h postgres -U ieducar -d ieducar; do
    echo "PostgreSQL is unavailable - sleeping"
    sleep 2
done
echo "PostgreSQL is ready!"

# Wait for Redis
echo "Waiting for Redis to be ready..."
until redis-cli -h redis ping | grep -q PONG; do
    echo "Redis is unavailable - sleeping"
    sleep 2
done
echo "Redis is ready!"

cd /var/www/ieducar

# Remove Telescope from app.php providers if it exists (dev dependency)
if [ -f config/app.php ]; then
    sed -i '/TelescopeServiceProvider/d' config/app.php
fi

# Remove Telescope from AppServiceProvider register method
if [ -f app/Providers/AppServiceProvider.php ]; then
    # Comment out any Telescope registration
    sed -i 's/.*Telescope.*//g' app/Providers/AppServiceProvider.php 2>/dev/null || true
fi

# Setup .env if not exists
if [ ! -f /var/www/ieducar/.env ]; then
    cp /var/www/ieducar/.env.example /var/www/ieducar/.env

    # Update database config
    sed -i 's/DB_HOST=.*/DB_HOST=postgres/' /var/www/ieducar/.env
    sed -i 's/DB_DATABASE=.*/DB_DATABASE=ieducar/' /var/www/ieducar/.env
    sed -i 's/DB_USERNAME=.*/DB_USERNAME=ieducar/' /var/www/ieducar/.env
    sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=ieducar/' /var/www/ieducar/.env

    # Update Redis config
    sed -i 's/REDIS_HOST=.*/REDIS_HOST=redis/' /var/www/ieducar/.env

    # Set cache and session drivers
    sed -i 's/CACHE_STORE=.*/CACHE_STORE=redis/' /var/www/ieducar/.env || echo "CACHE_STORE=redis" >> /var/www/ieducar/.env
    sed -i 's/SESSION_DRIVER=.*/SESSION_DRIVER=redis/' /var/www/ieducar/.env || echo "SESSION_DRIVER=redis" >> /var/www/ieducar/.env

    # Disable Telescope
    echo "TELESCOPE_ENABLED=false" >> /var/www/ieducar/.env
fi

# Also ensure Telescope is disabled in existing .env
if ! grep -q "TELESCOPE_ENABLED" /var/www/ieducar/.env; then
    echo "TELESCOPE_ENABLED=false" >> /var/www/ieducar/.env
fi

# Generate app key if not set
if ! grep -q "^APP_KEY=base64:" /var/www/ieducar/.env; then
    php artisan key:generate --force
fi

# Clear and cache config
php artisan config:clear
php artisan cache:clear

# Run migrations
echo "Running database migrations..."
php artisan migrate --force || echo "Migration may have already run"

# Run seeders
echo "Running database seeders..."
php artisan db:seed --force || echo "Seeding may have already completed"

# Set permissions
chown -R www-data:www-data /var/www/ieducar/storage
chown -R www-data:www-data /var/www/ieducar/bootstrap/cache

echo "Starting supervisord..."
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
