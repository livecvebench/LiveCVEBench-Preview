#!/bin/bash
# Entrypoint script for H2O server with restart capability
# This allows solution.sh to restart the server after applying patches

set -e

# Ensure log directory exists
mkdir -p /var/log/h2o

# Function to start h2o server
start_h2o() {
    echo "[entrypoint] Starting H2O server..."
    cd /app
    ./h2o -c /etc/h2o/h2o.conf &
    H2O_PID=$!
    echo $H2O_PID > /var/run/h2o.pid
    echo "[entrypoint] H2O started with PID $H2O_PID"
}

# Function to stop h2o server
stop_h2o() {
    if [ -f /var/run/h2o.pid ]; then
        H2O_PID=$(cat /var/run/h2o.pid)
        if kill -0 $H2O_PID 2>/dev/null; then
            echo "[entrypoint] Stopping H2O (PID $H2O_PID)..."
            kill $H2O_PID 2>/dev/null || true
            wait $H2O_PID 2>/dev/null || true
        fi
        rm -f /var/run/h2o.pid
    fi
    # Also kill any remaining h2o processes
    pkill -x h2o 2>/dev/null || true
    sleep 1
}

# Handle signals
trap 'stop_h2o; exit 0' SIGTERM SIGINT

# Initial start
start_h2o

# Keep container running and monitor h2o process
while true; do
    if [ -f /var/run/h2o.pid ]; then
        H2O_PID=$(cat /var/run/h2o.pid)
        if ! kill -0 $H2O_PID 2>/dev/null; then
            echo "[entrypoint] H2O process died, restarting..."
            sleep 1
            start_h2o
        fi
    else
        echo "[entrypoint] PID file missing, restarting H2O..."
        sleep 1
        start_h2o
    fi
    sleep 2
done
