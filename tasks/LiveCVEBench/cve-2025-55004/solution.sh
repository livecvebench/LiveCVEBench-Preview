#!/bin/bash
# Solution script for ImageMagick MNG heap-buffer overflow (CVE-2025-55004)
#
# The vulnerability is in ReadOneJNGImage function in coders/png.c.
# The issue: alpha_trait is set conditionally INSIDE the pixel processing loop,
# which causes buffer allocation to be incorrect when MAGN processing occurs.
#
# The fix: Set alpha_trait = BlendPixelTrait BEFORE the outer for loop.
set -e

cd /app

PNG_FILE="coders/png.c"

if [ ! -f "$PNG_FILE" ]; then
    echo "ERROR: $PNG_FILE not found"
    exit 1
fi

echo "Applying fix to $PNG_FILE..."

# Backup original
cp "$PNG_FILE" "${PNG_FILE}.bak"

# The vulnerable code pattern looks like this (around line 4793-4820):
#
#       if (jng_image != (Image *) NULL)
#         for (y=0; y < (ssize_t) image->rows; y++)
#         {
#           s=GetVirtualPixels(jng_image,0,y,image->columns,1,exception);
#           q=GetAuthenticPixels(image,0,y,image->columns,1,exception);
#           if ((s == (const Quantum *)  NULL) || (q == (Quantum *) NULL))
#             break;
#
#           if (image->alpha_trait != UndefinedPixelTrait)
#             for (x=(ssize_t) image->columns; x != 0; x--)
#             ...
#           else
#             for (x=(ssize_t) image->columns; x != 0; x--)
#             {
#               Quantum alpha;
#               alpha=GetPixelRed(jng_image,s);
#               SetPixelAlpha(image,alpha,q);
#               if (alpha != OpaqueAlpha)
#                 image->alpha_trait=BlendPixelTrait;  <-- BUG: Too late!
#             ...
#
# The fix adds "image->alpha_trait=BlendPixelTrait;" BEFORE the for(y=0...) loop

# Use Python for reliable multi-line fix
cat > /tmp/apply_fix.py << 'PYEOF'
#!/usr/bin/env python3
"""
Apply fix for CVE-2025-55004 heap-buffer-overflow in ImageMagick.

The fix sets image->alpha_trait=BlendPixelTrait; BEFORE the pixel processing
loop, rather than conditionally inside it.
"""
import sys
import re

def apply_fix(filepath):
    with open(filepath, 'r') as f:
        content = f.read()

    # Check if already fixed (look for alpha_trait=BlendPixelTrait; before the loop)
    # The vulnerable code has: if (jng_image != NULL) for (y=0...
    # The fixed code has: if (jng_image != NULL) { image->alpha_trait=BlendPixelTrait; for (y=0...

    if 'alpha_trait=BlendPixelTrait;\n        for (y=0' in content:
        print("File appears to already be fixed")
        return True

    # Pattern to find: the vulnerable section in ReadOneJNGImage
    # We look for: if (jng_image != (Image *) NULL)\n        for (y=0
    # And insert the fix

    vulnerable_pattern = r'''(if \(jng_image != \(Image \*\) NULL\)\n)(\s+for \(y=0; y < \(ssize_t\) image->rows; y\+\+\))'''

    fixed_replacement = r'''\1        {\n          image->alpha_trait=BlendPixelTrait;\2'''

    new_content, count1 = re.subn(vulnerable_pattern, fixed_replacement, content)

    if count1 == 0:
        print("Primary pattern not found, trying alternative...")

        # Alternative: look for the if statement with different spacing
        vulnerable_pattern2 = r'''(if \(jng_image != \(Image \*\) NULL\))\n(\s*)(for \(y=0;)'''
        fixed_replacement2 = r'''\1\n\2{\n\2  image->alpha_trait=BlendPixelTrait;\n\2  \3'''

        new_content, count1 = re.subn(vulnerable_pattern2, fixed_replacement2, content)

    if count1 == 0:
        print("ERROR: Vulnerable pattern not found")
        return False

    print(f"Found and patched {count1} occurrence(s) of vulnerable pattern")

    # Now we need to also close the brace and simplify the loop body
    # After our change, the code structure needs to be:
    #   if (jng_image != NULL) {
    #     image->alpha_trait=BlendPixelTrait;
    #     for (y=0...) {
    #       ...
    #       for (x=...) {
    #         SetPixelAlpha(image,GetPixelRed(jng_image,s),q);
    #         q+=...;
    #         s+=...;
    #       }
    #       if (SyncAuthenticPixels...
    #     }
    #   }

    # Remove the if/else branches since we always have alpha now
    # Remove: if (image->alpha_trait != UndefinedPixelTrait)
    # Keep only the first for loop, remove the else branch

    # Pattern to remove the conditional and else branch
    # This is the most critical part

    # Find: if (image->alpha_trait != UndefinedPixelTrait)
    #         for (x=...) { SetPixelAlpha...; q+=...; s+=...; }
    #       else
    #         for (x=...) { Quantum alpha; alpha=...; SetPixelAlpha...; if (alpha...) alpha_trait=...; q+=...; s+=...; }

    # Replace with just: for (x=...) { SetPixelAlpha...; q+=...; s+=...; }

    # Let's do this step by step
    # Step 1: Remove the "if (image->alpha_trait != UndefinedPixelTrait)" condition
    # Keep only its body (the first for loop)

    # Pattern for the if statement with first for loop
    pattern_if_alpha = r'''if \(image->alpha_trait != UndefinedPixelTrait\)\n\s+for \(x=\(ssize_t\) image->columns; x != 0; x--\)\n\s+\{\n\s+SetPixelAlpha\(image,GetPixelRed\(jng_image,s\),q\);\n\s+q\+=\(ptrdiff_t\) GetPixelChannels\(image\);\n\s+s\+=\(ptrdiff_t\) GetPixelChannels\(jng_image\);\n\s+\}\n\n\s+else\n\s+for \(x=\(ssize_t\) image->columns; x != 0; x--\)\n\s+\{\n\s+Quantum\n\s+alpha;\n\n\s+alpha=GetPixelRed\(jng_image,s\);\n\s+SetPixelAlpha\(image,alpha,q\);\n\s+if \(alpha != OpaqueAlpha\)\n\s+image->alpha_trait=BlendPixelTrait;\n\s+q\+=\(ptrdiff_t\) GetPixelChannels\(image\);\n\s+s\+=\(ptrdiff_t\) GetPixelChannels\(jng_image\);\n\s+\}'''

    replacement_simple = '''for (x=(ssize_t) image->columns; x != 0; x--)
            {
              SetPixelAlpha(image,GetPixelRed(jng_image,s),q);
              q+=(ptrdiff_t) GetPixelChannels(image);
              s+=(ptrdiff_t) GetPixelChannels(jng_image);
            }'''

    new_content, count2 = re.subn(pattern_if_alpha, replacement_simple, new_content)

    if count2 == 0:
        print("Second pattern (if/else branches) not found, trying alternative...")
        # The spacing might be different, try a more flexible pattern
        # Just remove the else branch

        # Find the else block with Quantum alpha declaration
        pattern_else = r'''\n\s+else\n\s+for \(x=\(ssize_t\) image->columns; x != 0; x--\)\n\s+\{\n\s+Quantum\n\s+alpha;\n\n\s+alpha=GetPixelRed\(jng_image,s\);\n\s+SetPixelAlpha\(image,alpha,q\);\n\s+if \(alpha != OpaqueAlpha\)\n\s+image->alpha_trait=BlendPixelTrait;\n\s+q\+=\(ptrdiff_t\) GetPixelChannels\(image\);\n\s+s\+=\(ptrdiff_t\) GetPixelChannels\(jng_image\);\n\s+\}'''

        new_content, count2 = re.subn(pattern_else, '', new_content)

        if count2 > 0:
            print(f"Removed {count2} else branch(es)")
            # Now remove the if condition but keep the for loop
            pattern_if_cond = r'''if \(image->alpha_trait != UndefinedPixelTrait\)\n(\s+for \(x=)'''
            new_content = re.sub(pattern_if_cond, r'\1', new_content)
    else:
        print(f"Simplified {count2} if/else branch(es)")

    # Finally, we need to add a closing brace for the "if (jng_image != NULL) {" block
    # Find the pattern that comes after our changes and add the closing brace

    # Look for: (void) RelinquishUniqueFileResource(alpha_image->filename);
    # Add "}" before it to close our new block

    pattern_close = r'''(\s+if \(SyncAuthenticPixels\(image,exception\) == MagickFalse\)\n\s+break;\n\s+\}\n)(\s+\(void\) RelinquishUniqueFileResource)'''
    replacement_close = r'''\1        }\n\2'''

    new_content, count3 = re.subn(pattern_close, replacement_close, new_content)
    if count3 > 0:
        print(f"Added {count3} closing brace(s)")

    with open(filepath, 'w') as f:
        f.write(new_content)

    print("Fix applied successfully")
    return True

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: apply_fix.py <png.c>")
        sys.exit(1)

    success = apply_fix(sys.argv[1])
    sys.exit(0 if success else 1)
PYEOF

python3 /tmp/apply_fix.py "$PNG_FILE"

# Verify the fix was applied correctly by checking compilation
echo "Fix applied. Rebuilding ImageMagick..."

# Build only png.c first to check for compile errors
make coders/MagickCore_libMagickCore_7_Q16HDRI_la-png.lo 2>&1 | tail -20

# If that succeeded, do a full rebuild
make -j$(nproc) 2>&1 | tail -10
make install 2>&1 | tail -5
ldconfig 2>/dev/null || true

echo "Fix complete. ImageMagick has been rebuilt."

# Verify the fix
echo "Verifying installation..."
magick -version | head -n 1
