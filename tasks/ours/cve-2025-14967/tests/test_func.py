#!/usr/bin/env python3
"""
Functional tests for the Student Management System candidates_report.php page.
These tests verify the application works correctly with valid inputs.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost"
TIMEOUT = 10


class TestCandidatesReportFunctionality:
    """Test that candidates_report.php functions correctly with valid inputs."""

    def test_page_loads_with_valid_school_year(self):
        """Test that the page loads successfully with a valid school year."""
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": "2019-2020"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "List of Candidates" in response.text

    def test_page_structure_has_table(self):
        """Test that the page contains the expected table structure."""
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": "2019-2020"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "<table" in response.text
        assert "Name" in response.text
        assert "Curriculum" in response.text

    def test_school_year_displayed_in_output(self):
        """Test that the school year is displayed in the page."""
        school_year = "2019-2020"
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": school_year},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert school_year in response.text

    def test_different_valid_school_years(self):
        """Test that different valid school years are handled correctly."""
        school_years = ["2018-2019", "2017-2018", "2016-2017"]
        for sy in school_years:
            response = requests.get(
                f"{BASE_URL}/candidates_report.php",
                params={"school_year": sy},
                timeout=TIMEOUT
            )
            assert response.status_code == 200
            assert "List of Candidates" in response.text

    def test_page_response_time_acceptable(self):
        """Test that page loads within acceptable time frame."""
        start_time = time.time()
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": "2019-2020"},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time
        assert response.status_code == 200
        assert elapsed < 3, f"Page took too long to load: {elapsed:.2f}s"

    def test_empty_school_year_handled(self):
        """Test that empty school year doesn't crash the page."""
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": ""},
            timeout=TIMEOUT
        )
        # Page should load without crashing (200 or any non-5xx response)
        assert response.status_code < 500

    def test_numeric_only_school_year(self):
        """Test handling of numeric-only school year."""
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": "2020"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "List of Candidates" in response.text

    def test_page_contains_tbody(self):
        """Test that the page has proper table body structure."""
        response = requests.get(
            f"{BASE_URL}/candidates_report.php",
            params={"school_year": "2019-2020"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "<tbody>" in response.text
        assert "</tbody>" in response.text


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
