"""
Functional tests for CMSimple_XH application.
These tests verify that core functionality works correctly in both
vulnerable and fixed states.
"""

import pytest
import requests
import time
import re

# Application runs on port 8080 in Docker
BASE_URL = "http://localhost:8080"

# Timeout for requests
REQUEST_TIMEOUT = 10


def wait_for_server(max_retries=30, delay=1):
    """Wait for the server to become available."""
    for i in range(max_retries):
        try:
            response = requests.get(BASE_URL, timeout=5)
            if response.status_code in [200, 302, 403]:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
    return False


class TestHomepage:
    """Tests for the homepage functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server did not start in time"

    def test_homepage_loads_successfully(self):
        """Verify the homepage loads with HTTP 200 status."""
        response = requests.get(f"{BASE_URL}/", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200, f"Homepage returned {response.status_code}"

    def test_homepage_contains_html_structure(self):
        """Verify the homepage contains expected HTML elements."""
        response = requests.get(f"{BASE_URL}/", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200

        # Should have basic HTML structure
        assert "<html" in response.text.lower(), "Missing <html> tag"
        assert "<head" in response.text.lower(), "Missing <head> tag"
        assert "<body" in response.text.lower(), "Missing <body> tag"

    def test_homepage_contains_searchbox(self):
        """Verify the search form is present on the homepage."""
        response = requests.get(f"{BASE_URL}/", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200

        # Search form should be present
        assert 'id="searchbox"' in response.text, "Search form not found"
        assert 'name="search"' in response.text, "Search input not found"


class TestSearchFunctionality:
    """Tests for search functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server did not start in time"

    def test_search_page_loads(self):
        """Verify search with a query returns results page."""
        response = requests.get(
            f"{BASE_URL}/?function=search&search=test",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200, f"Search returned {response.status_code}"

    def test_search_with_empty_query(self):
        """Verify search with empty query handles gracefully."""
        response = requests.get(
            f"{BASE_URL}/?function=search&search=",
            timeout=REQUEST_TIMEOUT
        )
        # Should return 200, possibly with "no results" message
        assert response.status_code == 200

    def test_search_with_special_characters(self):
        """Verify search with special chars does not cause errors."""
        response = requests.get(
            f"{BASE_URL}/?function=search&search=hello%20world",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200


class TestNavigationLinks:
    """Tests for navigation and menu functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server did not start in time"

    def test_sitemap_link_exists(self):
        """Verify sitemap link is present on the page."""
        response = requests.get(f"{BASE_URL}/", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200

        # Sitemap link should be present
        assert "sitemap" in response.text.lower(), "Sitemap link not found"

    def test_sitemap_page_loads(self):
        """Verify sitemap page loads correctly."""
        response = requests.get(
            f"{BASE_URL}/?&sitemap",
            timeout=REQUEST_TIMEOUT
        )
        assert response.status_code == 200, f"Sitemap returned {response.status_code}"

    def test_mailform_link_exists(self):
        """Verify mailform link exists in the page."""
        response = requests.get(f"{BASE_URL}/", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200

        # Check for mailform reference
        assert "mailform" in response.text.lower(), "Mailform link not found"


class TestFormAttributes:
    """Tests for proper form attribute rendering."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server did not start in time"

    def test_search_form_has_valid_action(self):
        """Verify search form action attribute is properly formed."""
        response = requests.get(f"{BASE_URL}/", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200

        # Find the searchbox form action
        match = re.search(r'<form[^>]*id="searchbox"[^>]*action="([^"]*)"', response.text)
        assert match, "Could not find searchbox form with action attribute"

        action = match.group(1)
        # Action should not contain unencoded special characters
        assert '<' not in action, "Form action contains unencoded < character"
        assert '>' not in action, "Form action contains unencoded > character"

    def test_page_contains_valid_links(self):
        """Verify page contains properly formed anchor tags."""
        response = requests.get(f"{BASE_URL}/", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200

        # Find all href attributes
        hrefs = re.findall(r'href="([^"]*)"', response.text)

        # At least some links should exist
        assert len(hrefs) > 0, "No href attributes found on page"


class TestIndexPhpAccess:
    """Tests for accessing via index.php path."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server did not start in time"

    def test_index_php_loads(self):
        """Verify index.php loads correctly."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=REQUEST_TIMEOUT)
        assert response.status_code == 200

    def test_index_php_with_path_info(self):
        """Verify index.php with path info loads without error."""
        response = requests.get(
            f"{BASE_URL}/index.php/some-path",
            timeout=REQUEST_TIMEOUT
        )
        # Should return 200 (possibly showing default page or 404 page)
        assert response.status_code in [200, 404], f"Unexpected status: {response.status_code}"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
