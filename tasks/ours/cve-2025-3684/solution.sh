#!/bin/bash
# Solution script for fixing SQL injection vulnerability in stu_list.php
# This script applies input sanitization using addslashes() to prevent SQL injection

set -e

TARGET_FILE="/var/www/html/stu_list.php"

echo "Applying SQL injection fix to ${TARGET_FILE}..."

# Check if file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo "Error: ${TARGET_FILE} not found"
    exit 1
fi

# Create a backup
cp "$TARGET_FILE" "${TARGET_FILE}.bak"

# First convert CRLF to LF to normalize line endings
sed -i 's/\r$//' "$TARGET_FILE"

# Use a PHP script for reliable patching since the file contains complex PHP patterns
php << 'PHPFIX'
<?php
$file = "/var/www/html/stu_list.php";
$content = file_get_contents($file);

if ($content === false) {
    echo "Error: Could not read file\n";
    exit(1);
}

// Fix sex parameter - replace the entire block
$old_sex_block = "if(!empty(\$_GET['sex'])){
    \$_k=\$_k.\" and #__wanglai.sex='\".trim(\$_GET['sex']).\"'\";
    \$_c[]=\"sex='\".trim(\$_GET['sex']).\"'\";
    \$_s['sex'] = trim(\$_GET['sex']);
}";

$new_sex_block = "if(!empty(\$_GET['sex'])){
    \$sex_safe = addslashes(trim(\$_GET['sex']));
    \$_k=\$_k.\" and #__wanglai.sex='\".\$sex_safe.\"'\";
    \$_c[]=\"sex='\".\$sex_safe.\"'\";
    \$_s['sex'] = trim(\$_GET['sex']);
}";

$content = str_replace($old_sex_block, $new_sex_block, $content);

// Fix nation parameter - replace the entire block
$old_nation_block = "if(!empty(\$_GET['nation'])){
    \$_k=\$_k.\" and #__wanglai.nation='\".trim(\$_GET['nation']).\"'\";
    \$_c[]=\"nation='\".trim(\$_GET['nation']).\"'\";
    \$_s['nation'] = trim(\$_GET['nation']);
}";

$new_nation_block = "if(!empty(\$_GET['nation'])){
    \$nation_safe = addslashes(trim(\$_GET['nation']));
    \$_k=\$_k.\" and #__wanglai.nation='\".\$nation_safe.\"'\";
    \$_c[]=\"nation='\".\$nation_safe.\"'\";
    \$_s['nation'] = trim(\$_GET['nation']);
}";

$content = str_replace($old_nation_block, $new_nation_block, $content);

// Fix keywords parameter - the complex LIKE clause
$old_keywords_block = "if(!empty(\$_GET['keywords']) && trim(\$_GET['keywords'])!=''){
    \$_k=\$_k.\" and (#__wanglai.name like '%\".trim(\$_GET['keywords']).\"%' or #__wanglai.bianhao like '%\".trim(\$_GET['keywords']).\"%' or #__jiaz.name like '%\".trim(\$_GET['keywords']).\"%' or #__jiaz.mobile like '%\".trim(\$_GET['keywords']).\"%' or #__wanglai.beizhu like '%\".trim(\$_GET['keywords']).\"%')\";
    \$_c[]=\"keywords=\".trim(\$_GET['keywords']);
    \$_s['keywords'] = trim(\$_GET['keywords']);
}";

$new_keywords_block = "if(!empty(\$_GET['keywords']) && trim(\$_GET['keywords'])!=''){
    \$keywords_safe = addslashes(trim(\$_GET['keywords']));
    \$_k=\$_k.\" and (#__wanglai.name like '%\".\$keywords_safe.\"%' or #__wanglai.bianhao like '%\".\$keywords_safe.\"%' or #__jiaz.name like '%\".\$keywords_safe.\"%' or #__jiaz.mobile like '%\".\$keywords_safe.\"%' or #__wanglai.beizhu like '%\".\$keywords_safe.\"%')\";
    \$_c[]=\"keywords=\".\$keywords_safe;
    \$_s['keywords'] = trim(\$_GET['keywords']);
}";

$content = str_replace($old_keywords_block, $new_keywords_block, $content);

// Write the fixed content back
$result = file_put_contents($file, $content);

if ($result === false) {
    echo "Error: Could not write to file\n";
    exit(1);
}

echo "PHP fix applied successfully!\n";
?>
PHPFIX

# Verify the fix was applied
if grep -q "addslashes" "$TARGET_FILE"; then
    rm -f "${TARGET_FILE}.bak"
    echo "SQL injection fix applied successfully!"
    echo ""
    echo "Changes made:"
    echo "  - Added addslashes() sanitization for 'sex' parameter"
    echo "  - Added addslashes() sanitization for 'nation' parameter"
    echo "  - Added addslashes() sanitization for 'keywords' parameter"
else
    echo "Fix verification failed. Restoring backup..."
    mv "${TARGET_FILE}.bak" "$TARGET_FILE"
    exit 1
fi

echo ""
echo "Fix complete. The application will use the updated code on next request."
