FROM wordpress:6.4-apache

WORKDIR /var/www/html

# Install required system packages: WP-CLI, tmux, asciinema, curl, mysql client, Python for tests
RUN apt-get update && apt-get install -y \
    tmux \
    asciinema \
    curl \
    wget \
    git \
    gcc \
    g++ \
    default-mysql-client \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Python test dependencies will be installed via uv in run-tests.sh

# Install WP-CLI
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && \
    chmod +x wp-cli.phar && \
    mv wp-cli.phar /usr/local/bin/wp

# Disable PHP error display to prevent headers already sent issues with old plugins
# Use multiple approaches to ensure error suppression
RUN echo "display_errors = Off" > /usr/local/etc/php/conf.d/zz-disable-errors.ini && \
    echo "error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT & ~E_NOTICE & ~E_WARNING" >> /usr/local/etc/php/conf.d/zz-disable-errors.ini && \
    echo "log_errors = On" >> /usr/local/etc/php/conf.d/zz-disable-errors.ini && \
    echo "<?php error_reporting(E_ALL & ~E_DEPRECATED & ~E_STRICT & ~E_NOTICE & ~E_WARNING); @ini_set('display_errors', 0); ?>" > /var/www/html/error-suppress.php && \
    echo "auto_prepend_file = /var/www/html/error-suppress.php" >> /usr/local/etc/php/conf.d/zz-disable-errors.ini

# Create plugin directory structure
RUN mkdir -p /var/www/html/wp-content/plugins/find-me-on/js \
    && mkdir -p /var/www/html/wp-content/plugins/find-me-on/css \
    && mkdir -p /var/www/html/wp-content/plugins/find-me-on/images

# Copy plugin files from task-deps/
COPY task-deps/find-me-on.php /var/www/html/wp-content/plugins/find-me-on/
COPY task-deps/readme.txt /var/www/html/wp-content/plugins/find-me-on/
COPY task-deps/findmeon.js /var/www/html/wp-content/plugins/find-me-on/js/
COPY task-deps/css/ /var/www/html/wp-content/plugins/find-me-on/css/

# Set proper permissions
RUN chown -R www-data:www-data /var/www/html/wp-content/plugins/find-me-on

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose port
EXPOSE 80

# Use custom entrypoint for WordPress setup
# CMD ["/entrypoint.sh"]
