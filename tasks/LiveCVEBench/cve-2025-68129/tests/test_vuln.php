<?php
/**
 * Vulnerability Tests - Test that ID tokens are rejected when validated as access tokens
 *
 * These tests verify that the token validation properly distinguishes between
 * ID tokens and access tokens. In the vulnerable version, ID tokens pass
 * validation when used as access tokens.
 *
 * FAIL in vulnerable state (validation passes when it should fail)
 * PASS in fixed state (validation correctly rejects ID tokens as access tokens)
 */

declare(strict_types=1);

use Auth0\SDK\Configuration\SdkConfiguration;
use Auth0\SDK\Exception\InvalidTokenException;
use Auth0\SDK\Token;
use Auth0\Tests\Utilities\TokenGenerator;
use Symfony\Component\Cache\Adapter\ArrayAdapter;

uses()->group('vulnerability');

beforeEach(function() {
    $this->cache = new ArrayAdapter();

    $this->configuration = new SdkConfiguration([
        'strategy' => SdkConfiguration::STRATEGY_NONE,
        'tokenCache' => $this->cache,
        'domain' => 'domain.test',
        'clientId' => '__test_client_id__',
        'tokenAlgorithm' => 'HS256',
        'clientSecret' => '__test_client_secret__',
        'audience' => ['https://api.example.com'],  // API audience different from clientId
    ]);
});

/**
 * Test 1: Basic ID token rejection when validated as access token
 *
 * ID tokens have a 'nonce' claim and audience set to clientId.
 * When validated as access tokens, they should be rejected.
 */
it('rejects ID token with nonce claim when validated as access token', function(): void {
    // Create ID token (has nonce, aud = clientId)
    $idToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ID,
        TokenGenerator::ALG_HS256,
        ['aud' => '__test_client_id__', 'nonce' => '__test_nonce__']
    );

    // Try to validate as access token - should fail
    $token = new Token($this->configuration, $idToken->token, Token::TYPE_ACCESS_TOKEN);
    $token->validate();
})->throws(InvalidTokenException::class, 'ID token cannot be validated as an access token');

/**
 * Test 2: ID token with different nonce values should all be rejected
 */
it('rejects ID token with any nonce value when validated as access token', function(): void {
    $idToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ID,
        TokenGenerator::ALG_HS256,
        ['aud' => '__test_client_id__', 'nonce' => 'random-nonce-' . uniqid()]
    );

    $token = new Token($this->configuration, $idToken->token, Token::TYPE_ACCESS_TOKEN);
    $token->validate();
})->throws(InvalidTokenException::class, 'ID token cannot be validated as an access token');

/**
 * Test 3: RS256 ID token should also be rejected as access token
 */
it('rejects RS256 ID token when validated as access token', function(): void {
    // Reconfigure for RS256
    $this->configuration->setTokenAlgorithm('RS256');

    $idToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ID,
        TokenGenerator::ALG_RS256,
        ['aud' => '__test_client_id__', 'nonce' => '__test_nonce__']
    );

    $token = new Token($this->configuration, $idToken->token, Token::TYPE_ACCESS_TOKEN);

    // Need to verify with the cached JWKS
    $token->verify(
        tokenCache: $idToken->cached,
        tokenJwksUri: $idToken->jwks
    );

    $token->validate();
})->throws(InvalidTokenException::class, 'ID token cannot be validated as an access token');

/**
 * Test 4: ID token with empty string nonce should still be rejected
 * Edge case - nonce claim exists but with empty string value
 */
it('rejects ID token with empty nonce when validated as access token', function(): void {
    $idToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ID,
        TokenGenerator::ALG_HS256,
        ['aud' => '__test_client_id__', 'nonce' => '']  // Empty string nonce
    );

    $token = new Token($this->configuration, $idToken->token, Token::TYPE_ACCESS_TOKEN);
    $token->validate();
})->throws(InvalidTokenException::class);

/**
 * Test 5: Verify clientId is NOT added to audience for access tokens with API audience configured
 *
 * This tests the other part of the fix - when an API audience is configured,
 * clientId should NOT be added to the expected audience list for access tokens.
 */
it('rejects access token with clientId audience when API audience is configured', function(): void {
    // Create token with only clientId as audience (not API audience)
    $accessToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ACCESS,
        TokenGenerator::ALG_HS256,
        [
            'aud' => '__test_client_id__',  // Wrong audience - should be API identifier
            'nonce' => null,  // Remove nonce to make it look like access token
        ]
    );

    $token = new Token($this->configuration, $accessToken->token, Token::TYPE_ACCESS_TOKEN);
    $token->validate();
})->throws(InvalidTokenException::class);  // Should fail audience check

/**
 * Test 6: Access token with nonce claim from token generator (simulating ID token misuse)
 */
it('rejects token with both access token format and nonce claim', function(): void {
    // TOKEN_ACCESS from TokenGenerator includes nonce by default (simulating the attack)
    $mixedToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ACCESS,
        TokenGenerator::ALG_HS256,
        ['aud' => '__test_client_id__']  // Override audience to clientId
    );

    $token = new Token($this->configuration, $mixedToken->token, Token::TYPE_ACCESS_TOKEN);
    $token->validate();
})->throws(InvalidTokenException::class, 'ID token cannot be validated as an access token');

/**
 * Test 7: Verify attack scenario - ID token with clientId audience passes in vulnerable version
 *
 * This is the core vulnerability test. In vulnerable code:
 * - API audience is ['https://api.example.com']
 * - clientId is '__test_client_id__'
 * - Vulnerable code adds clientId to expected audience: ['https://api.example.com', '__test_client_id__']
 * - ID token with aud='__test_client_id__' matches and passes
 *
 * After fix:
 * - For access tokens, clientId is NOT added to audience when API audience exists
 * - Additionally, nonce presence causes immediate rejection
 */
it('does not allow ID token audience to match when validating as access token', function(): void {
    $idToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ID,
        TokenGenerator::ALG_HS256,
        [
            'aud' => '__test_client_id__',
            'nonce' => '__test_nonce__',
            'sub' => '__test_sub__',
        ]
    );

    $token = new Token($this->configuration, $idToken->token, Token::TYPE_ACCESS_TOKEN);

    // In vulnerable version: This passes (WRONG!)
    // In fixed version: This throws InvalidTokenException (CORRECT!)
    $token->validate();
})->throws(InvalidTokenException::class, 'ID token cannot be validated as an access token');

/**
 * Test 8: Multiple attack payloads with varying nonce formats
 */
it('rejects tokens with various nonce formats as access tokens', function(string $nonce): void {
    $idToken = TokenGenerator::create(
        TokenGenerator::TOKEN_ID,
        TokenGenerator::ALG_HS256,
        ['aud' => '__test_client_id__', 'nonce' => $nonce]
    );

    $token = new Token($this->configuration, $idToken->token, Token::TYPE_ACCESS_TOKEN);
    $token->validate();
})->with([
    'standard nonce' => ['__test_nonce__'],
    'uuid nonce' => ['550e8400-e29b-41d4-a716-446655440000'],
    'base64 nonce' => ['YWJjZGVmZ2hpamtsbW5vcA=='],
    'numeric string nonce' => ['1234567890'],
    'special chars nonce' => ['nonce-with-special_chars.123'],
])->throws(InvalidTokenException::class, 'ID token cannot be validated as an access token');
