"""
Functionality tests for UTM Grabber plugin.
These tests verify that the plugin correctly captures and displays UTM parameters.
Tests should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
from urllib.parse import quote

BASE_URL = "http://localhost"
# Page with [utm_source] shortcode - use pagename parameter for reliability
TEST_PAGE_URL = f"{BASE_URL}/?pagename=utm-test"


def wait_for_wordpress(timeout=120):
    """Wait for WordPress to be ready."""
    start = time.time()
    while time.time() - start < timeout:
        try:
            response = requests.get(BASE_URL, timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(2)
    return False


class TestBasicFunctionality:
    """Test that the plugin works correctly for normal use cases."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure WordPress is ready before tests."""
        assert wait_for_wordpress(), "WordPress did not become ready in time"

    def test_wordpress_is_running(self):
        """Verify WordPress is accessible."""
        response = requests.get(BASE_URL)
        assert response.status_code == 200, "WordPress should be accessible"

    def test_normal_utm_source_displayed(self):
        """Test that a normal utm_source value is captured and displayed."""
        utm_value = "google"
        url = f"{TEST_PAGE_URL}&utm_source={utm_value}"

        response = requests.get(url)
        assert response.status_code == 200
        # The UTM value should appear in the page content
        assert utm_value in response.text, f"UTM value '{utm_value}' should be displayed on the page"

    def test_utm_medium_parameter(self):
        """Test that utm_medium parameter is correctly handled."""
        utm_value = "cpc"
        url = f"{TEST_PAGE_URL}&utm_medium={utm_value}"

        response = requests.get(url)
        assert response.status_code == 200

    def test_utm_campaign_parameter(self):
        """Test that utm_campaign parameter is correctly handled."""
        utm_value = "summer_sale"
        url = f"{TEST_PAGE_URL}&utm_campaign={utm_value}"

        response = requests.get(url)
        assert response.status_code == 200

    def test_utm_with_spaces(self):
        """Test UTM values containing spaces."""
        utm_value = "my campaign"
        encoded_value = quote(utm_value)
        url = f"{TEST_PAGE_URL}&utm_source={encoded_value}"

        response = requests.get(url)
        assert response.status_code == 200

    def test_utm_with_numbers(self):
        """Test UTM values containing numbers."""
        utm_value = "campaign2024"
        url = f"{TEST_PAGE_URL}&utm_source={utm_value}"

        response = requests.get(url)
        assert response.status_code == 200
        assert utm_value in response.text

    def test_multiple_utm_parameters(self):
        """Test multiple UTM parameters in single request."""
        url = f"{TEST_PAGE_URL}&utm_source=google&utm_medium=cpc&utm_campaign=test"

        response = requests.get(url)
        assert response.status_code == 200

    def test_utm_persistence_via_cookie(self):
        """Test that UTM values persist via cookies.

        Note: The plugin sets cookies via JavaScript on the client side.
        We simulate this by manually setting the cookie in our request.
        """
        session = requests.Session()

        # First request sets the UTM value via JavaScript on client
        # We simulate cookie being set by manually adding it
        utm_value = "facebook"
        session.cookies.set('utm_source', utm_value)

        # Second request should display the value from the cookie
        response = session.get(TEST_PAGE_URL)
        assert response.status_code == 200
        # The value should appear on the page from the cookie
        assert utm_value in response.text, "UTM value from cookie should be displayed"

    def test_empty_utm_source(self):
        """Test handling of empty utm_source parameter."""
        url = f"{TEST_PAGE_URL}&utm_source="

        response = requests.get(url)
        assert response.status_code == 200

    def test_long_utm_value(self):
        """Test handling of long UTM values."""
        utm_value = "a" * 200
        url = f"{TEST_PAGE_URL}&utm_source={utm_value}"

        response = requests.get(url)
        assert response.status_code == 200

    def test_utm_with_underscores_and_dashes(self):
        """Test UTM values with common special characters."""
        utm_value = "my_campaign-2024"
        url = f"{TEST_PAGE_URL}&utm_source={utm_value}"

        response = requests.get(url)
        assert response.status_code == 200
        assert utm_value in response.text


class TestOutputEncoding:
    """Test that special characters are properly handled (escaped in fixed version)."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure WordPress is ready before tests."""
        assert wait_for_wordpress(), "WordPress did not become ready in time"

    def test_ampersand_in_utm(self):
        """Test that ampersand is handled correctly."""
        utm_value = "source&test"
        encoded_value = quote(utm_value)
        url = f"{TEST_PAGE_URL}&utm_source={encoded_value}"

        response = requests.get(url)
        assert response.status_code == 200
        # Either the raw value or encoded version should appear
        assert "source" in response.text

    def test_quotes_in_utm(self):
        """Test that quotes are handled correctly."""
        utm_value = 'test"value'
        encoded_value = quote(utm_value)
        url = f"{TEST_PAGE_URL}&utm_source={encoded_value}"

        response = requests.get(url)
        assert response.status_code == 200

    def test_unicode_in_utm(self):
        """Test that unicode characters are handled correctly."""
        utm_value = "test_unicode"
        url = f"{TEST_PAGE_URL}&utm_source={utm_value}"

        response = requests.get(url)
        assert response.status_code == 200


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
