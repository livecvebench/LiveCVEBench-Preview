#!/bin/bash
set -e

# Find the vulnerable file - it could be in different locations
POSSIBLE_PATHS=(
    "/var/www/WeGIA/html/geral/cargos.php"
    "/var/www/html/html/geral/cargos.php"
    "/app/html/geral/cargos.php"
)

FILE=""
for path in "${POSSIBLE_PATHS[@]}"; do
    if [ -f "$path" ]; then
        FILE="$path"
        break
    fi
done

# If not found in expected locations, search for it
if [ -z "$FILE" ]; then
    FILE=$(find /var/www -name "cargos.php" -path "*/geral/*" 2>/dev/null | head -1)
fi

if [ -z "$FILE" ] || [ ! -f "$FILE" ]; then
    FILE=$(find /app -name "cargos.php" -path "*/geral/*" 2>/dev/null | head -1)
fi

if [ -z "$FILE" ] || [ ! -f "$FILE" ]; then
    echo "Error: Could not find cargos.php"
    exit 1
fi

echo "Found vulnerable file: $FILE"

# Create backup
cp "$FILE" "${FILE}.bak"

# Apply the fix: wrap $msg with htmlspecialchars() in both echo statements
# The vulnerable pattern is: '. $msg .'
# The fixed pattern is: '. htmlspecialchars($msg) .'

# Use sed to replace the vulnerable pattern
# This handles both msg_c and msg_e cases since they use the same pattern
sed -i "s/'\. \$msg \.'/'. htmlspecialchars(\$msg) .'/g" "$FILE"

# Verify the fix was applied
if grep -q "htmlspecialchars(\$msg)" "$FILE"; then
    echo "Fix applied successfully to $FILE"
else
    echo "Warning: Fix may not have been applied correctly"
    # Try alternative patterns in case of different whitespace
    sed -i "s/'\.\s*\$msg\s*\.'/'. htmlspecialchars(\$msg) .'/g" "$FILE"

    if grep -q "htmlspecialchars(\$msg)" "$FILE"; then
        echo "Fix applied with alternative pattern"
    else
        echo "Error: Could not apply fix"
        # Restore backup
        cp "${FILE}.bak" "$FILE"
        exit 1
    fi
fi

# Clean up backup
rm -f "${FILE}.bak"

echo "Solution applied successfully"
