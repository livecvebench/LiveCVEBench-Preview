#!/bin/bash
set -e

# Wait for database to be ready
echo "Waiting for database..."
max_attempts=30
attempt=0
while ! mysqladmin ping -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" --skip-ssl --silent 2>/dev/null; do
    attempt=$((attempt+1))
    if [ $attempt -ge $max_attempts ]; then
        echo "Database not available after $max_attempts attempts"
        exit 1
    fi
    echo "Waiting for database (attempt $attempt/$max_attempts)..."
    sleep 2
done
echo "Database is ready!"

# Initialize database if tables don't exist
echo "Checking database initialization..."
if ! mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" --skip-ssl "$DB_NAME" -e "SELECT 1 FROM users LIMIT 1" 2>/dev/null; then
    echo "Initializing database..."
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" --skip-ssl "$DB_NAME" < /var/www/html/school-management-system/database/_sms.sql
    echo "Database initialized!"
else
    echo "Database already initialized."
fi

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
