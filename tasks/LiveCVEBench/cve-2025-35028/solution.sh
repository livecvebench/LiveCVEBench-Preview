#!/bin/bash
# Solution script for HexStrike AI MCP Server command injection vulnerability
# CVE-2025-35028
# This script fixes the command injection vulnerability by modifying the
# EnhancedCommandExecutor.execute() method to use shell=False with shlex.split()
# This prevents shell metacharacter interpretation.
set -e

cd /app

echo "Applying fix for command injection vulnerability..."

# Step 1: Add shlex import if not present
if ! grep -q "^import shlex" hexstrike_server.py; then
    echo "Adding shlex import..."
    # Add 'import shlex' after 'import subprocess'
    sed -i '/^import subprocess/a import shlex' hexstrike_server.py
fi

# Step 2: Fix the EnhancedCommandExecutor.execute() method
# This is the central fix that protects ALL endpoints at once
echo "Patching EnhancedCommandExecutor.execute() method..."

# Change shell=True to shell=False and convert command string to list
# Original:
#     self.process = subprocess.Popen(
#         self.command,
#         shell=True,
# Fixed:
#     self.process = subprocess.Popen(
#         shlex.split(self.command),
#         shell=False,

# First, replace 'self.command,' with 'shlex.split(self.command),' in the Popen call
sed -i 's/self\.process = subprocess\.Popen(/self.process = subprocess.Popen(/g' hexstrike_server.py
sed -i '/self.process = subprocess.Popen(/,/shell=True,/{s/self\.command,/shlex.split(self.command),/}' hexstrike_server.py

# Then change shell=True to shell=False
sed -i 's/shell=True,/shell=False,/g' hexstrike_server.py

# Step 3: Verify the changes were applied
echo "Verifying fix application..."

if grep -q "shlex.split(self.command)" hexstrike_server.py; then
    echo "  - shlex.split(self.command): OK"
else
    echo "  - WARNING: shlex.split(self.command) not found"
fi

if grep -q "shell=False" hexstrike_server.py; then
    echo "  - shell=False: OK"
else
    echo "  - WARNING: shell=False not found"
fi

if ! grep -q "shell=True" hexstrike_server.py; then
    echo "  - No shell=True remaining: OK"
else
    echo "  - WARNING: shell=True still exists in code"
fi

# Step 4: Restart the server so changes take effect
echo "Restarting HexStrike server..."
pkill -f "python.*hexstrike_server" || true
sleep 3

echo ""
echo "Fix applied successfully!"
echo "The server will be restarted by the container entrypoint."
