#!/bin/bash
set -e

# Wait for database to be ready
echo "Waiting for database connection..."
until mysqladmin ping -h db -P 3306 --silent; do
    echo "Database not ready, waiting..."
    sleep 5
done
echo "Database connection established"

# Copy Cacti config
cp /app/config.php /var/www/html/cacti/include/config.php

# Check if database is initialized
if ! mysql -h db -P 3306 -u cacti -pcactipassword cacti -e "SELECT 1 FROM settings LIMIT 1" 2>/dev/null; then
    echo "Initializing Cacti database..."
    mysql -h db -P 3306 -u cacti -pcactipassword cacti < /var/www/html/cacti/cacti.sql
    echo "Database initialized successfully"
fi

# Complete Cacti setup
mysql -h db -P 3306 -u cacti -pcactipassword cacti < /app/init-cacti.sql

# Create RRD file for testing
echo "Creating test RRD file..."
rrdtool create /var/www/html/cacti/rra/local_traffic_1.rrd --step 300 DS:traffic:GAUGE:600:0:U RRA:AVERAGE:0.5:1:600 RRA:MAX:0.5:1:600
rrdtool update /var/www/html/cacti/rra/local_traffic_1.rrd N:1000
chown www-data:www-data /var/www/html/cacti/rra/local_traffic_1.rrd

# Start Apache in foreground
echo "Starting Apache..."
apache2ctl -D FOREGROUND
