FROM php:8.2-apache

WORKDIR /app

# Environment variables for database connection
ENV DB_HOST=db
ENV DB_NAME=wegia
ENV DB_USER=wegiauser
ENV DB_PASSWORD=senha

# Install system dependencies and PHP extensions
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libicu-dev \
    libxml2-dev \
    libzip-dev \
    libonig-dev \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Configure and install PHP extensions
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
    gd \
    intl \
    mbstring \
    mysqli \
    pdo \
    pdo_mysql \
    soap \
    xml \
    zip \
    opcache

# Enable Apache modules
RUN a2enmod rewrite

# Clone WeGIA at vulnerable version 3.4.6 and remove git history
RUN git clone --branch 3.4.6 --depth 1 https://github.com/LabRedesCefetRJ/WeGIA.git /app \
    && rm -rf /app/.git

# Copy configuration file with Docker database host
COPY task-deps/config.php /app/config.php

# Copy database files
COPY task-deps/wegia001.sql /app/BD/wegia001.sql
COPY task-deps/wegia002.sql /app/BD/wegia002.sql

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create required directories
RUN mkdir -p /var/www/bkpWeGIA \
    && mkdir -p /var/lib/php/sessions

# Create .release file (required by the application)
RUN echo "1720000000" > /app/.release

# Configure Apache virtual host - DocumentRoot at /app for proper relative paths
COPY task-deps/apache-vhost.conf /etc/apache2/sites-available/000-default.conf

# Set PHP timezone
RUN echo "date.timezone = America/Sao_Paulo" > /usr/local/etc/php/conf.d/timezone.ini

# Set file permissions
RUN chown -R www-data:www-data /app /var/www/bkpWeGIA /var/lib/php/sessions \
    && chmod -R 755 /app

EXPOSE 80

RUN mkdir -p /tests /oracle
# CMD ["/entrypoint.sh"]
