cat <<'EOF' > /workspace/fix.patch
diff --git a/cmd/snap/cmd_run.go b/cmd/snap/cmd_run.go
index 2895a336abc..9f86f25d205 100644
--- a/cmd/snap/cmd_run.go
+++ b/cmd/snap/cmd_run.go
@@ -387,6 +387,10 @@ func createUserDataDirs(info *snap.Info) error {
 		return fmt.Errorf(i18n.G("cannot get the current user: %v"), err)
 	}
 
+	snapDir := filepath.Join(usr.HomeDir, dirs.UserHomeSnapDir)
+	if err := os.MkdirAll(snapDir, 0700); err != nil {
+		return fmt.Errorf(i18n.G("cannot create snap home dir: %w"), err)
+	}
 	// see snapenv.User
 	instanceUserData := info.UserDataDir(usr.HomeDir)
 	instanceCommonUserData := info.UserCommonDataDir(usr.HomeDir)


EOF

cd /workspace/snapd
git apply --whitespace=nowarn  /workspace/fix.patch