"""
Functionality tests for the product management application.
These tests verify the application works correctly in both vulnerable and fixed states.
"""

import requests
import time

BASE_URL = "http://localhost"


class TestApplicationAccessibility:
    """Test that the application is accessible and serving content."""

    def test_update_page_accessible(self):
        """Test that the update page is accessible via GET request."""
        response = requests.get(f"{BASE_URL}/pet1/update_cnp.php", timeout=10)
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"

    def test_update_page_contains_product_table(self):
        """Test that the page contains the products table structure."""
        response = requests.get(f"{BASE_URL}/pet1/update_cnp.php", timeout=10)
        assert response.status_code == 200
        # Check for table headers that should be present
        assert "Name" in response.text or "name" in response.text.lower()
        assert "Price" in response.text or "prize" in response.text.lower()

    def test_update_page_contains_products(self):
        """Test that the page displays product data from database."""
        response = requests.get(f"{BASE_URL}/pet1/update_cnp.php", timeout=10)
        assert response.status_code == 200
        # The sample data should include some products
        # Check for product-related content
        assert "Available" in response.text or "Un-Available" in response.text or "product" in response.text.lower()


class TestValidProductUpdate:
    """Test valid product update functionality."""

    def test_valid_update_request_accepted(self):
        """Test that a valid product update request is processed without errors."""
        data = {
            "id": "2",
            "name": "Test Product Name",
            "prize": "199.99",
            "description": "Test product description",
            "status": "Available",
            "update": "1"
        }
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=10)
        assert response.status_code == 200, f"Expected 200, got {response.status_code}"
        # Should not contain PHP error messages
        assert "Fatal error" not in response.text
        assert "Parse error" not in response.text

    def test_update_with_numeric_price(self):
        """Test update with various numeric price formats."""
        data = {
            "id": "3",
            "name": "Price Test Product",
            "prize": "150",
            "description": "Testing numeric price",
            "status": "Available",
            "update": "1"
        }
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=10)
        assert response.status_code == 200

    def test_update_with_decimal_price(self):
        """Test update with decimal price format."""
        data = {
            "id": "4",
            "name": "Decimal Price Product",
            "prize": "99.50",
            "description": "Testing decimal price",
            "status": "Available",
            "update": "1"
        }
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=10)
        assert response.status_code == 200

    def test_update_status_available(self):
        """Test updating product status to Available."""
        data = {
            "id": "2",
            "name": "Status Test",
            "prize": "100",
            "description": "Status test description",
            "status": "Available",
            "update": "1"
        }
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=10)
        assert response.status_code == 200

    def test_update_status_unavailable(self):
        """Test updating product status to Un-Available."""
        data = {
            "id": "3",
            "name": "Unavailable Status Test",
            "prize": "100",
            "description": "Unavailable status test",
            "status": "Un-Available",
            "update": "1"
        }
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=10)
        assert response.status_code == 200


class TestFormRendering:
    """Test that forms are properly rendered."""

    def test_page_contains_form_elements(self):
        """Test that the page contains form elements for product updates."""
        response = requests.get(f"{BASE_URL}/pet1/update_cnp.php", timeout=10)
        assert response.status_code == 200
        # Check for form-related elements
        assert "form" in response.text.lower()
        assert "method" in response.text.lower()

    def test_page_contains_edit_buttons(self):
        """Test that edit buttons are present for products."""
        response = requests.get(f"{BASE_URL}/pet1/update_cnp.php", timeout=10)
        assert response.status_code == 200
        # Should have edit buttons or similar controls
        assert "Edit" in response.text or "edit" in response.text.lower() or "btn" in response.text


class TestResponseTiming:
    """Test that application responds in reasonable time."""

    def test_page_load_time_reasonable(self):
        """Test that the page loads within a reasonable time frame."""
        start_time = time.time()
        response = requests.get(f"{BASE_URL}/pet1/update_cnp.php", timeout=10)
        elapsed = time.time() - start_time

        assert response.status_code == 200
        # Page should load in under 5 seconds for normal operation
        assert elapsed < 5, f"Page load took too long: {elapsed}s"

    def test_valid_update_time_reasonable(self):
        """Test that a valid update completes within reasonable time."""
        data = {
            "id": "2",
            "name": "Timing Test",
            "prize": "100",
            "description": "Testing response time",
            "status": "Available",
            "update": "1"
        }

        start_time = time.time()
        response = requests.post(f"{BASE_URL}/pet1/update_cnp.php", data=data, timeout=10)
        elapsed = time.time() - start_time

        assert response.status_code == 200
        # Normal update should complete quickly
        assert elapsed < 3, f"Update took too long: {elapsed}s"
