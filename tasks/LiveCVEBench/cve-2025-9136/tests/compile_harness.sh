#!/bin/bash
# Compile the test harness for vulnerability testing
# This script compiles the C test harness with and without AddressSanitizer

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# Source file
SRC="test_harness.c"

# Output binaries
OUTPUT="test_harness"
OUTPUT_ASAN="test_harness_asan"

echo "Compiling test harness..."

# Compile normal version (for basic tests)
echo "  - Building standard version..."
gcc -Wall -Wextra -g -O0 \
    "$SRC" \
    -o "$OUTPUT" 2>&1 || {
    echo "Standard compilation failed"
    exit 1
}
echo "    -> $OUTPUT"

# Compile with AddressSanitizer (for memory error detection)
echo "  - Building ASan version..."
if gcc -fsanitize=address -fno-omit-frame-pointer -Wall -Wextra -g -O0 \
    "$SRC" \
    -o "$OUTPUT_ASAN" 2>&1; then
    echo "    -> $OUTPUT_ASAN"
else
    echo "    ASan compilation failed (sanitizer may not be available)"
    # Create symlink to regular version as fallback
    ln -sf "$OUTPUT" "$OUTPUT_ASAN" 2>/dev/null || true
fi

echo ""
echo "Compilation complete."
echo ""
echo "Test binaries:"
ls -la "$OUTPUT" "$OUTPUT_ASAN" 2>/dev/null || ls -la "$OUTPUT"
