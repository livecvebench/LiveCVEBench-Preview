#!/bin/bash
set -e
cd /app

echo "Applying fix for predictable filename generation..."

# Step 1: Install the cryptographically secure ID generator
echo "Installing @paralleldrive/cuid2..."
npm install @paralleldrive/cuid2 --save 2>/dev/null || true

# Step 2: Patch the Formidable.js file to use cuid2 instead of hexoid
FORMIDABLE_FILE="/app/node_modules/formidable/src/Formidable.js"

if [ ! -f "$FORMIDABLE_FILE" ]; then
    echo "Error: Formidable.js not found at $FORMIDABLE_FILE"
    exit 1
fi

echo "Patching $FORMIDABLE_FILE..."

# Replace hexoid import with cuid2 import
sed -i "s/import { hexoid } from 'hexoid';/import { init as cuid2init } from '@paralleldrive\/cuid2';/" "$FORMIDABLE_FILE"

# Replace the hexoid initialization with cuid2 initialization
# First, check if we need to add the os import for CUID2_FINGERPRINT
if ! grep -q "import os from 'node:os';" "$FORMIDABLE_FILE"; then
    # os is already imported at the top, but let's verify
    if ! grep -q "from 'node:os'" "$FORMIDABLE_FILE"; then
        sed -i "1i import os from 'node:os';" "$FORMIDABLE_FILE"
    fi
fi

# Replace the toHexoId initialization line
# The vulnerable line: const toHexoId = hexoid(25);
# The fixed lines: const CUID2_FINGERPRINT = ... and const createId = ...
sed -i "s/const toHexoId = hexoid(25);/const CUID2_FINGERPRINT = \`\${process.env.NODE_ENV}-\${os.platform()}-\${os.hostname()}-\${os.machine()}\`;\nconst createId = cuid2init({ length: 25, fingerprint: CUID2_FINGERPRINT.toLowerCase() });/" "$FORMIDABLE_FILE"

# Replace toHexoId() calls with createId()
sed -i "s/toHexoId()/createId()/g" "$FORMIDABLE_FILE"

echo "Verifying fix was applied..."

# Verify the changes
if grep -q "cuid2init" "$FORMIDABLE_FILE" && grep -q "createId()" "$FORMIDABLE_FILE"; then
    echo "Fix successfully applied!"
else
    echo "Warning: Fix may not have been fully applied. Checking file..."
    grep -n "hexoid\|cuid2\|toHexoId\|createId" "$FORMIDABLE_FILE" || true
fi

# Step 3: Restart the Node.js application to apply changes
echo "Restarting application..."
pkill -f "node.*server.js" || true
pkill -f "node.*app.js" || true
pkill -f "node.*index.js" || true

# Give time for process to terminate
sleep 2

echo "Fix applied. The application will restart with the fixed code."
