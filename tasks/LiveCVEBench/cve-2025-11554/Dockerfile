FROM php:8.3-fpm

WORKDIR /app

# System dependencies
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    nginx \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libzip-dev \
    libpq-dev \
    libxml2-dev \
    libonig-dev \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Configure GD extension with freetype and jpeg support
RUN docker-php-ext-configure gd --with-freetype --with-jpeg

# Install PHP extensions
RUN docker-php-ext-install \
    gd \
    pdo \
    pdo_pgsql \
    pgsql \
    zip \
    bcmath \
    mbstring \
    xml \
    opcache \
    pcntl \
    ftp

# Install Redis extension from source (avoid pecl network issues)
RUN git clone --depth 1 https://github.com/phpredis/phpredis.git /tmp/phpredis \
    && cd /tmp/phpredis \
    && phpize && ./configure && make && make install \
    && docker-php-ext-enable redis \
    && rm -rf /tmp/phpredis

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Clone the vulnerable version of i-Educar
RUN git clone --branch 2.9 --depth 1 https://github.com/portabilis/i-educar.git /app \
    && rm -rf /app/.git

# Copy environment file
COPY task-deps/.env.example /app/.env

# Configure environment for Docker networking
RUN sed -i 's/DB_HOST=localhost/DB_HOST=postgres/' /app/.env && \
    sed -i 's/REDIS_HOST=localhost/REDIS_HOST=redis/' /app/.env && \
    sed -i 's/APP_ENV=local/APP_ENV=production/' /app/.env

# Fix Telescope dependency issue - comment out Telescope registration since it's a dev dependency
RUN sed -i 's/^use Laravel\\Telescope\\TelescopeServiceProvider;$/\/\/ use Laravel\\Telescope\\TelescopeServiceProvider;/' /app/app/Providers/AppServiceProvider.php && \
    sed -i 's/$this->app->register(TelescopeServiceProvider::class);/\/\/ $this->app->register(TelescopeServiceProvider::class);/' /app/app/Providers/AppServiceProvider.php

# Install composer dependencies (with --no-scripts initially to avoid issues)
RUN composer install --no-dev --optimize-autoloader --no-scripts --no-interaction

# Run composer scripts manually
RUN composer run-script post-autoload-dump --no-interaction || true

# Set permissions
RUN chown -R www-data:www-data /app && \
    chmod -R 755 /app && \
    chmod -R 777 /app/storage /app/bootstrap/cache

# Configure nginx
COPY task-deps/nginx.conf /etc/nginx/sites-available/default
RUN rm -f /etc/nginx/sites-enabled/default && \
    ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default

# Configure PHP-FPM to listen on localhost:9000
COPY task-deps/php-fpm-listen.conf /usr/local/etc/php-fpm.d/zz-listen.conf

# Copy and prepare entrypoint
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables for application
ENV APP_ENV=production
ENV APP_DEBUG=true
ENV DB_CONNECTION=pgsql
ENV DB_HOST=postgres
ENV DB_PORT=5432
ENV DB_DATABASE=ieducar
ENV DB_USERNAME=ieducar
ENV DB_PASSWORD=ieducar
ENV CACHE_DRIVER=redis
ENV REDIS_HOST=redis
ENV REDIS_PORT=6379
ENV SESSION_DRIVER=file
ENV QUEUE_CONNECTION=sync

EXPOSE 80

# CMD ["/entrypoint.sh"]
