FROM golang:1.20

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y git tmux asciinema curl && rm -rf /var/lib/apt/lists/*

# Copy go.mod first for dependency caching
COPY task-deps/app_go.mod ./go.mod

# Copy application source so go mod tidy can resolve dependencies
COPY task-deps/example_vulnerable_app.go ./main.go

# Download dependencies and vendor them (makes them writable for solution.sh)
RUN go mod tidy && go mod vendor

# Copy entrypoint script
COPY task-deps/entrypoint.sh ./entrypoint.sh

# Make entrypoint executable
RUN chmod +x ./entrypoint.sh

# Build the application with vendor directory
RUN go build -mod=vendor -o server main.go

EXPOSE 3000

# CMD ["./entrypoint.sh"]  # Moved to docker-compose.yaml
