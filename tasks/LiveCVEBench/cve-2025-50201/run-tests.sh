#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== WeGIA Debug Info Tests ==="
echo ""

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "[*] Installing uv..."
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env
fi

# Initialize uv project if needed
if [ ! -f "pyproject.toml" ]; then
    echo "[*] Initializing uv project..."
    uv init 2>/dev/null || true
fi

# Add test dependencies
echo "[*] Installing test dependencies..."
uv add pytest requests 2>/dev/null

# Determine the application URL - use localhost inside container context
APP_URL="${APP_URL:-http://localhost}"
echo "[*] Waiting for application at ${APP_URL}..."

# Ensure curl doesn't use proxy for localhost
export no_proxy="localhost,127.0.0.1"
export NO_PROXY="localhost,127.0.0.1"

max_attempts=60
attempt=0
while [ $attempt -lt $max_attempts ]; do
    # Use timeout to prevent hanging, and explicitly target localhost
    result=$(curl -s --noproxy "*" -m 5 -o /dev/null -w "%{http_code}" "http://127.0.0.1/html/configuracao/debug_info.php" 2>/dev/null || echo "000")
    if echo "$result" | grep -qE "200|302|303"; then
        echo "[+] Application is ready! (status: $result)"
        break
    fi
    attempt=$((attempt + 1))
    echo "    Attempt $attempt/$max_attempts - waiting... (got: $result)"
    sleep 1
done

if [ $attempt -eq $max_attempts ]; then
    echo "[-] Warning: Application may not be fully ready, proceeding anyway..."
    # Debug: show what's listening
    netstat -tlpn 2>/dev/null | grep 80 || ss -tlpn 2>/dev/null | grep 80 || echo "Cannot check ports"
fi

echo ""
echo "=== Running Tests ==="
echo ""

# Run all tests with verbose output using -rA for proper parsing
APP_URL="http://127.0.0.1" uv run pytest . -rA --tb=short
