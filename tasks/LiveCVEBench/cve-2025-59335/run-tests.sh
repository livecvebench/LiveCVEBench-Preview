#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== Installing test dependencies ==="
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env
uv init 2>/dev/null || true
uv add pytest requests 2>/dev/null

echo "=== Waiting for CubeCart to be ready ==="
MAX_RETRIES=60
RETRY_COUNT=0
while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if curl -s -o /dev/null -w "%{http_code}" http://localhost:80/ | grep -q "200\|302"; then
        echo "CubeCart is ready!"
        break
    fi
    echo "Waiting for CubeCart... (attempt $((RETRY_COUNT+1))/$MAX_RETRIES)"
    sleep 2
    RETRY_COUNT=$((RETRY_COUNT+1))
done

if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    echo "ERROR: CubeCart did not start within the timeout period"
    exit 1
fi

# Create test user in database if possible
echo "=== Setting up test user ==="
cat > /tmp/create_test_user.php << 'EOPHP'
<?php
$config_file = "/var/www/html/includes/global.inc.php";
if (!file_exists($config_file)) {
    echo "Config file not found, skipping test user creation\n";
    exit(0);
}

include_once($config_file);

if (!isset($glob) || !isset($glob["dbhost"])) {
    echo "Config not loaded properly\n";
    exit(0);
}

$conn = new mysqli($glob["dbhost"], $glob["dbusername"], $glob["dbpassword"], $glob["dbdatabase"]);
if ($conn->connect_error) {
    echo "Database connection failed: " . $conn->connect_error . "\n";
    exit(0);
}

$prefix = isset($glob["dbprefix"]) ? $glob["dbprefix"] : "CubeCart_";
$email = "vuln_test@example.com";
$password = "OldPassword123!";
$salt = bin2hex(random_bytes(16));
// CubeCart uses whirlpool hash: hash('whirlpool', $salt.$password.$salt)
$hashed = hash('whirlpool', $salt . $password . $salt);

// Check if user exists
$stmt = $conn->prepare("SELECT customer_id FROM {$prefix}customer WHERE email = ?");
$stmt->bind_param("s", $email);
$stmt->execute();
$result = $stmt->get_result();

if ($result && $result->num_rows > 0) {
    // Update existing user - set new_password=1 to use new hash format
    $stmt = $conn->prepare("UPDATE {$prefix}customer SET password=?, salt=?, type=1, status=1, new_password=1 WHERE email=?");
    $stmt->bind_param("sss", $hashed, $salt, $email);
    $stmt->execute();
    echo "Test user updated\n";
} else {
    // Create new user with new_password=1 for new hash format
    $stmt = $conn->prepare("INSERT INTO {$prefix}customer (email, password, salt, type, status, first_name, last_name, new_password) VALUES (?, ?, ?, 1, 1, 'Test', 'User', 1)");
    $stmt->bind_param("sss", $email, $hashed, $salt);
    $stmt->execute();
    echo "Test user created\n";
}

$conn->close();
echo "Test user setup completed\n";
?>
EOPHP

php /tmp/create_test_user.php 2>/dev/null || echo "Could not create test user (this is OK if DB not accessible)"

echo "=== Running tests ==="
# Unset proxy for localhost tests
unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY
export no_proxy=localhost,127.0.0.1
uv run pytest . -rA
