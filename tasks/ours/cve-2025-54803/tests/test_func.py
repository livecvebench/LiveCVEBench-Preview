"""
Functional tests for js-toml parser.
These tests verify that basic TOML parsing functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""
import subprocess
import json
import pytest


def run_node(script):
    """Helper to run a Node.js script and return the result."""
    result = subprocess.run(
        ['node', '-e', script],
        capture_output=True,
        text=True,
        cwd='/app'
    )
    return result


class TestBasicParsing:
    """Test basic TOML parsing functionality."""

    def test_simple_key_value(self):
        """Test parsing simple key-value pairs."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
title = "TOML Example"
count = 42
enabled = true
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['title'] == 'TOML Example'
        assert data['count'] == 42
        assert data['enabled'] is True

    def test_string_types(self):
        """Test various string types."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
basic = "hello world"
literal = 'single quotes'
multiline = """
multi
line
"""
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['basic'] == 'hello world'
        assert data['literal'] == 'single quotes'
        assert 'multi' in data['multiline']

    def test_numeric_types(self):
        """Test various numeric types."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
integer = 100
negative = -50
float_val = 3.14
scientific = 1e10
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['integer'] == 100
        assert data['negative'] == -50
        assert abs(data['float_val'] - 3.14) < 0.01
        assert data['scientific'] == 1e10


class TestTables:
    """Test table parsing functionality."""

    def test_simple_table(self):
        """Test parsing a simple table."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
[server]
host = "localhost"
port = 8080
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['server']['host'] == 'localhost'
        assert data['server']['port'] == 8080

    def test_nested_tables(self):
        """Test parsing nested tables."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
[database]
name = "mydb"

[database.connection]
host = "db.example.com"
port = 5432

[database.connection.pool]
size = 10
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['database']['name'] == 'mydb'
        assert data['database']['connection']['host'] == 'db.example.com'
        assert data['database']['connection']['port'] == 5432
        assert data['database']['connection']['pool']['size'] == 10

    def test_dotted_keys(self):
        """Test parsing dotted keys."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
a.b.c = 123
x.y = "nested"
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['a']['b']['c'] == 123
        assert data['x']['y'] == 'nested'

    def test_multiple_tables(self):
        """Test parsing multiple tables."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
[owner]
name = "Alice"

[database]
server = "192.168.1.1"

[servers.alpha]
ip = "10.0.0.1"

[servers.beta]
ip = "10.0.0.2"
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['owner']['name'] == 'Alice'
        assert data['database']['server'] == '192.168.1.1'
        assert data['servers']['alpha']['ip'] == '10.0.0.1'
        assert data['servers']['beta']['ip'] == '10.0.0.2'


class TestArrays:
    """Test array parsing functionality."""

    def test_simple_array(self):
        """Test parsing simple arrays."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
numbers = [1, 2, 3, 4, 5]
strings = ["a", "b", "c"]
mixed = [1, "two", 3.0]
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['numbers'] == [1, 2, 3, 4, 5]
        assert data['strings'] == ['a', 'b', 'c']
        assert data['mixed'] == [1, 'two', 3.0]

    def test_nested_arrays(self):
        """Test parsing nested arrays."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
nested = [[1, 2], [3, 4], [5, 6]]
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['nested'] == [[1, 2], [3, 4], [5, 6]]

    def test_array_of_tables(self):
        """Test parsing array of tables."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
[[products]]
name = "Hammer"
price = 9.99

[[products]]
name = "Nail"
price = 0.05

[[products]]
name = "Screwdriver"
price = 4.99
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert len(data['products']) == 3
        assert data['products'][0]['name'] == 'Hammer'
        assert data['products'][0]['price'] == 9.99
        assert data['products'][1]['name'] == 'Nail'
        assert data['products'][2]['name'] == 'Screwdriver'

    def test_nested_array_of_tables(self):
        """Test parsing nested array of tables."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
[[fruits]]
name = "apple"

[[fruits.varieties]]
name = "red delicious"

[[fruits.varieties]]
name = "granny smith"

[[fruits]]
name = "banana"

[[fruits.varieties]]
name = "plantain"
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert len(data['fruits']) == 2
        assert data['fruits'][0]['name'] == 'apple'
        assert len(data['fruits'][0]['varieties']) == 2


class TestInlineTables:
    """Test inline table parsing functionality."""

    def test_simple_inline_table(self):
        """Test parsing simple inline tables."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
point = { x = 1, y = 2 }
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['point']['x'] == 1
        assert data['point']['y'] == 2

    def test_nested_inline_table(self):
        """Test parsing nested inline tables."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
person = { name = "John", address = { city = "NYC", zip = "10001" } }
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['person']['name'] == 'John'
        assert data['person']['address']['city'] == 'NYC'
        assert data['person']['address']['zip'] == '10001'

    def test_array_of_inline_tables(self):
        """Test parsing array of inline tables."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
points = [{ x = 1, y = 1 }, { x = 2, y = 4 }, { x = 3, y = 9 }]
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert len(data['points']) == 3
        assert data['points'][0] == {'x': 1, 'y': 1}
        assert data['points'][1] == {'x': 2, 'y': 4}
        assert data['points'][2] == {'x': 3, 'y': 9}


class TestComplexScenarios:
    """Test complex TOML parsing scenarios."""

    def test_realistic_config(self):
        """Test parsing a realistic configuration file."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
[application]
name = "MyApp"
version = "1.0.0"
debug = false

[database]
driver = "postgres"
host = "localhost"
port = 5432
name = "myapp_db"

[cache]
enabled = true
ttl = 3600
backend = "redis"

[[routes]]
path = "/api/users"
method = "GET"
handler = "UsersController.list"

[[routes]]
path = "/api/users"
method = "POST"
handler = "UsersController.create"
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert data['application']['name'] == 'MyApp'
        assert data['database']['port'] == 5432
        assert data['cache']['enabled'] is True
        assert len(data['routes']) == 2

    def test_empty_sections(self):
        """Test parsing empty tables/sections."""
        result = run_node('''
const { load } = require("js-toml");
const toml = `
[empty]

[nonempty]
key = "value"
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert 'empty' in data
        assert data['nonempty']['key'] == 'value'

    def test_special_characters_in_strings(self):
        """Test parsing strings with special characters."""
        result = run_node(r'''
const { load } = require("js-toml");
const toml = `
escaped = "Line1\\nLine2\\tTabbed"
path = "C:\\\\Users\\\\test"
`;
const data = load(toml);
console.log(JSON.stringify(data));
        ''')
        assert result.returncode == 0, f"Script failed: {result.stderr}"
        data = json.loads(result.stdout.strip())
        assert 'Line1' in data['escaped']
        assert 'Users' in data['path']
