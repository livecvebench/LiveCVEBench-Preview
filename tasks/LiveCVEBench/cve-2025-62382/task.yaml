instruction: |-
  This is a network video recorder (NVR) application that provides recording and
  export functionality for IP cameras. The application has an API endpoint that
  allows users to export video recordings and optionally specify a custom thumbnail
  image via the `image_path` parameter.

  Users have reported that when exporting recordings with a custom thumbnail image,
  the application accepts any file path without validation. This means that if a user
  accidentally provides a path to a file outside the expected media directory (e.g.,
  due to a typo or misconfiguration), the application will attempt to use that file
  as the thumbnail, which could lead to unexpected behavior.

  For example, if a user provides `image_path: "/etc/hostname"` instead of a valid
  clip path, the application accepts it without error. This is confusing because
  users expect the application to only accept valid clip paths within the media
  directory.

  Expected behavior:
  - The export API should only accept image paths that are within the allowed media
    clips directory (`/media/frigate/clips`)
  - If an invalid path is provided (paths outside the clips directory), the API
    should return HTTP 400 with an error message "Invalid image path"
  - Paths with traversal sequences (like `../`) should be sanitized
  - The export should still work correctly when no `image_path` is provided or when
    a valid clips directory path is provided

author_name: HIT-SCIR-LACG
author_email: xzluo@ir.hit.edu.cn

difficulty: medium
category: bug-fix
tags:
  - python
  - fastapi
  - input-validation
  - path-handling
parser_name: pytest

run_tests_in_same_shell: false
