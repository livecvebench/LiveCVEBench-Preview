#!/bin/bash
set -e

# Create container user with dynamic UID/GID
groupadd -g ${GID:-1000} containeruser 2>/dev/null || true
useradd -u ${UID:-1000} -g containeruser -m containeruser 2>/dev/null || true

# Start MariaDB
echo "Starting MariaDB..."
service mariadb start

# Wait for MySQL socket
echo "Waiting for MySQL socket..."
for i in {1..30}; do
    if [ -S /var/run/mysqld/mysqld.sock ]; then
        echo "MySQL socket ready"
        break
    fi
    sleep 1
done

if [ ! -S /var/run/mysqld/mysqld.sock ]; then
    echo "ERROR: MySQL socket not available after 30 seconds"
    exit 1
fi

# Initialize database if needed
echo "Initializing database..."
mysql -e "CREATE DATABASE IF NOT EXISTS clipbucket;"
mysql -e "CREATE USER IF NOT EXISTS 'clipbucket'@'localhost' IDENTIFIED BY '${MYSQL_PASSWORD:-clipbucket_password}';"
mysql -e "GRANT ALL PRIVILEGES ON clipbucket.* TO 'clipbucket'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

# Check if ClipBucket database is already populated with correct table names
TABLE_COUNT=$(mysql -N -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='clipbucket' AND table_name LIKE 'cb_%';")
if [ "$TABLE_COUNT" -eq 0 ]; then
    echo "Importing ClipBucket database schema..."
    SQL_DIR="/srv/http/clipbucket/upload/cb_install/sql"

    # Function to import SQL file with prefix replacement
    import_sql() {
        sed 's/{tbl_prefix}/cb_/g' "$1" | mysql clipbucket
    }

    # Import structure first
    import_sql "$SQL_DIR/structure.sql"

    # Import initial data
    import_sql "$SQL_DIR/configs.sql"
    import_sql "$SQL_DIR/categories.sql"
    import_sql "$SQL_DIR/countries.sql"
    import_sql "$SQL_DIR/languages.sql"
    import_sql "$SQL_DIR/language_ENG.sql"
    import_sql "$SQL_DIR/user_levels.sql"
    import_sql "$SQL_DIR/pages.sql"
    import_sql "$SQL_DIR/email_templates.sql"
    import_sql "$SQL_DIR/ads_placements.sql"
    import_sql "$SQL_DIR/add_admin.sql"
    import_sql "$SQL_DIR/add_anonymous_user.sql"
    import_sql "$SQL_DIR/table_version.sql"

    echo "Database schema imported successfully"

    # Create missing tables required for application to work
    echo "Creating additional required tables..."
    mysql clipbucket -e "
    CREATE TABLE IF NOT EXISTS cb_tools_status(
        id_tools_status INT NOT NULL AUTO_INCREMENT,
        language_key_title VARCHAR(1024) NOT NULL,
        PRIMARY KEY (id_tools_status)
    ) ENGINE=InnoDB;
    INSERT IGNORE INTO cb_tools_status (id_tools_status, language_key_title) VALUES
    (1, 'idle'),
    (2, 'in_progress'),
    (3, 'stopping'),
    (4, 'done'),
    (5, 'error');
    "

    # Set database version to avoid migration issues (version 5.5.1 rev 238 = vulnerable version)
    echo "Setting database version..."
    mysql clipbucket -e "INSERT INTO cb_version (id, version, revision) VALUES (1, '5.5.1', 238) ON DUPLICATE KEY UPDATE version='5.5.1', revision=238;"

    # Set admin password - password is 'admin', hashed with userid=1 and the dynamically generated password_salt
    echo "Setting admin password..."
    PASSWORD_SALT=$(mysql -N clipbucket -e "SELECT value FROM cb_config WHERE name='password_salt';")
    ADMIN_PASS_HASH=$(php -r "echo hash('sha512', 'admin' . '1' . '$PASSWORD_SALT');")
    mysql clipbucket -e "UPDATE cb_users SET password='$ADMIN_PASS_HASH' WHERE userid=1;"
    echo "Admin password set with salt: $PASSWORD_SALT"
else
    echo "Database already initialized ($TABLE_COUNT tables found)"
fi

# Create database config file
CONFIG_FILE="/srv/http/clipbucket/upload/includes/config.php"
echo "Creating database config..."
cat > "$CONFIG_FILE" << 'EOFCONFIG'
<?php
//Database Host
$DBHOST = 'localhost';
//Database Name
$DBNAME = 'clipbucket';
//Database Username
$DBUSER = 'clipbucket';
//Database Password
$DBPASS = 'clipbucket_password';
//Database Port
$DBPORT = '3306';
//Setting Table Prefix
define('TABLE_PREFIX', 'cb_');
?>
EOFCONFIG

# Create install.lock to prevent redirect to installer
touch /srv/http/clipbucket/upload/includes/install.lock

# Create install.me.not to bypass installer check
touch /srv/http/clipbucket/upload/files/temp/install.me.not

# Create playlist_covers directory with proper permissions
mkdir -p /srv/http/clipbucket/upload/images/playlist_covers
chmod -R 777 /srv/http/clipbucket/upload/images/playlist_covers

# Set permissions
echo "Setting permissions..."
chown -R www-data:www-data /srv/http/clipbucket
chmod -R 775 /srv/http/clipbucket/upload/files 2>/dev/null || true
chmod -R 775 /srv/http/clipbucket/upload/images 2>/dev/null || true
chmod -R 775 /srv/http/clipbucket/upload/cache 2>/dev/null || true

# Create PHP-FPM run directory
mkdir -p /run/php

# Start PHP-FPM
echo "Starting PHP-FPM..."
php-fpm8.2 &

# Wait for PHP-FPM socket
echo "Waiting for PHP-FPM socket..."
for i in {1..20}; do
    if [ -S /run/php/php8.2-fpm.sock ]; then
        echo "PHP-FPM socket ready"
        break
    fi
    sleep 1
done

if [ ! -S /run/php/php8.2-fpm.sock ]; then
    echo "ERROR: PHP-FPM socket not available after 20 seconds"
    exit 1
fi

# Start Nginx in foreground
echo "Starting Nginx..."
nginx -g "daemon off;"
