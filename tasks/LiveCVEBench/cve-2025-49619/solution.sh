#!/bin/bash
set -e

# Solution script for Skyvern template injection vulnerability
# This script applies the fix to use SandboxedEnvironment instead of Template

BLOCK_FILE="/app/skyvern/forge/sdk/workflow/models/block.py"

echo "Applying template sandboxing fix..."

# Check if the file exists
if [ ! -f "$BLOCK_FILE" ]; then
    echo "Error: Block file not found at $BLOCK_FILE"
    exit 1
fi

# Check if already fixed (idempotent)
if grep -q "from jinja2.sandbox import SandboxedEnvironment" "$BLOCK_FILE"; then
    echo "Fix already applied - SandboxedEnvironment import found"
else
    # Fix 1: Change import from 'jinja2 import Template' to 'jinja2.sandbox import SandboxedEnvironment'
    sed -i 's/from jinja2 import Template/from jinja2.sandbox import SandboxedEnvironment/' "$BLOCK_FILE"
    echo "Fixed import statement"
fi

# Check if sandbox environment variable already exists
if grep -q "jinja_sandbox_env = SandboxedEnvironment()" "$BLOCK_FILE"; then
    echo "Sandbox environment variable already exists"
else
    # Fix 2: Add sandbox environment variable after LOG definition
    # Using a more robust approach with awk for multi-line awareness
    sed -i '/^LOG = structlog.get_logger()$/a jinja_sandbox_env = SandboxedEnvironment()' "$BLOCK_FILE"
    echo "Added sandbox environment variable"
fi

# Check if template creation already uses sandbox
if grep -q "jinja_sandbox_env.from_string(potential_template)" "$BLOCK_FILE"; then
    echo "Template creation already uses sandbox"
else
    # Fix 3: Replace Template instantiation with sandbox
    sed -i 's/template = Template(potential_template)/template = jinja_sandbox_env.from_string(potential_template)/' "$BLOCK_FILE"
    echo "Fixed template instantiation to use sandbox"
fi

echo "Verifying fix..."

# Verify the changes
if grep -q "from jinja2.sandbox import SandboxedEnvironment" "$BLOCK_FILE" && \
   grep -q "jinja_sandbox_env = SandboxedEnvironment()" "$BLOCK_FILE" && \
   grep -q "jinja_sandbox_env.from_string(potential_template)" "$BLOCK_FILE"; then
    echo "Fix verified successfully!"
else
    echo "Warning: Fix verification failed. Manual review recommended."
    echo "Current state of key lines:"
    grep -n "jinja2" "$BLOCK_FILE" | head -5
    grep -n "jinja_sandbox_env" "$BLOCK_FILE" | head -5
    grep -n "from_string\|Template(" "$BLOCK_FILE" | head -5
fi

# Restart the Skyvern service if running (so it picks up the code changes)
echo "Attempting to restart Skyvern service..."
pkill -f "uvicorn.*skyvern" || pkill -f "python.*skyvern" || true
sleep 2

echo "Fix applied successfully!"
