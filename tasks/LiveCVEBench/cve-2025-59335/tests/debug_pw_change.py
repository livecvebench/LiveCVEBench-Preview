#!/usr/bin/env python3
import requests
import re

BASE_URL = "http://localhost:80"
TIMEOUT = 30
TEST_EMAIL = "vuln_test@example.com"
TEST_PASSWORD_OLD = "OldPassword123!"
TEST_PASSWORD_NEW = "NewPassword456!"

def extract_token(html):
    patterns = [
        r'name="token"\s+value="([^"]+)"',
        r'value="([^"]+)"\s+name="token"',
        r'<input[^>]+name=["\']token["\'][^>]+value=["\']([^"\']+)["\']',
        r'<input[^>]+value=["\']([^"\']+)["\'][^>]+name=["\']token["\']',
    ]
    for pattern in patterns:
        match = re.search(pattern, html, re.IGNORECASE)
        if match:
            return match.group(1)
    return None

# Login
session = requests.Session()
login_page = session.get(f"{BASE_URL}/index.php?_a=login", timeout=TIMEOUT)
print(f"Login page status: {login_page.status_code}")

token = extract_token(login_page.text)
print(f"Token found: {token is not None}")

login_data = {
    "username": TEST_EMAIL,
    "password": TEST_PASSWORD_OLD,
    "login": "Login",
}
if token:
    login_data["token"] = token

response = session.post(
    f"{BASE_URL}/index.php?_a=login",
    data=login_data,
    timeout=TIMEOUT,
    allow_redirects=True
)
print(f"After login - URL: {response.url}")
print(f"After login - Status: {response.status_code}")

# Check if logged in
account_check = session.get(f"{BASE_URL}/index.php?_a=account", timeout=TIMEOUT, allow_redirects=True)
is_logged_in = "login" not in account_check.url.lower() or "account" in account_check.text.lower()
print(f"Is logged in: {is_logged_in}")

if is_logged_in:
    # Get profile page
    profile_page = session.get(f"{BASE_URL}/index.php?_a=profile", timeout=TIMEOUT, allow_redirects=True)
    print(f"Profile page URL: {profile_page.url}")

    token = extract_token(profile_page.text)

    change_data = {
        "passold": TEST_PASSWORD_OLD,
        "passnew": TEST_PASSWORD_NEW,
        "passconf": TEST_PASSWORD_NEW,
        "update": "Save Changes",
    }
    if token:
        change_data["token"] = token

    response = session.post(
        f"{BASE_URL}/index.php?_a=profile",
        data=change_data,
        timeout=TIMEOUT,
        allow_redirects=True
    )
    print(f"After password change - URL: {response.url}")
    print(f"After password change - Status: {response.status_code}")
    print(f"URL contains login: {'login' in response.url.lower()}")
    print(f"URL contains pu=: {'pu=' in response.url}")
else:
    print("Could not login - skipping password change test")
