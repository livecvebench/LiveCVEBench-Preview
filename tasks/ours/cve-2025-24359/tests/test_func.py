"""
Functional tests for asteval library.
These tests verify that normal asteval functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
from asteval import Interpreter


class TestBasicEvaluation:
    """Test basic expression evaluation."""

    def test_arithmetic(self):
        """Test basic arithmetic operations."""
        aeval = Interpreter()
        assert aeval("2 + 2") == 4
        assert aeval("10 - 3") == 7
        assert aeval("4 * 5") == 20
        assert aeval("15 / 3") == 5.0
        assert aeval("2 ** 10") == 1024

    def test_string_operations(self):
        """Test string operations."""
        aeval = Interpreter()
        assert aeval("'hello' + ' world'") == 'hello world'
        assert aeval("'abc' * 3") == 'abcabcabc'
        assert aeval("len('test')") == 4

    def test_comparison_operations(self):
        """Test comparison operations."""
        aeval = Interpreter()
        assert aeval("5 > 3") is True
        assert aeval("2 < 1") is False
        assert aeval("5 == 5") is True
        assert aeval("5 != 3") is True

    def test_boolean_operations(self):
        """Test boolean operations."""
        aeval = Interpreter()
        assert aeval("True and True") is True
        assert aeval("True and False") is False
        assert aeval("True or False") is True
        assert aeval("not True") is False


class TestVariables:
    """Test variable assignment and retrieval."""

    def test_variable_assignment(self):
        """Test variable assignment."""
        aeval = Interpreter()
        aeval("x = 42")
        assert aeval("x") == 42

    def test_multiple_variables(self):
        """Test multiple variable assignments."""
        aeval = Interpreter()
        aeval("a = 10")
        aeval("b = 20")
        assert aeval("a + b") == 30

    def test_variable_reassignment(self):
        """Test variable reassignment."""
        aeval = Interpreter()
        aeval("x = 1")
        aeval("x = x + 1")
        assert aeval("x") == 2


class TestFStrings:
    """Test f-string functionality."""

    def test_fstring_basic(self):
        """Test that basic f-strings work."""
        aeval = Interpreter()
        aeval("x = 42")
        result = aeval("f'The answer is {x}'")
        assert result == "The answer is 42"

    def test_fstring_expression(self):
        """Test f-strings with expressions."""
        aeval = Interpreter()
        aeval("a = 5")
        aeval("b = 3")
        result = aeval("f'{a} + {b} = {a + b}'")
        assert result == "5 + 3 = 8"

    def test_fstring_formatting_float(self):
        """Test f-string format specifications for floats."""
        aeval = Interpreter()
        aeval("pi = 3.14159")
        result = aeval("f'{pi:.2f}'")
        assert result == "3.14"

    def test_fstring_formatting_width(self):
        """Test f-string width formatting."""
        aeval = Interpreter()
        aeval("x = 5")
        result = aeval("f'{x:>5}'")
        assert result == "    5"

    def test_fstring_formatting_zero_pad(self):
        """Test f-string zero padding."""
        aeval = Interpreter()
        aeval("n = 42")
        result = aeval("f'{n:05d}'")
        assert result == "00042"

    def test_fstring_multiple_values(self):
        """Test f-strings with multiple placeholders."""
        aeval = Interpreter()
        aeval("name = 'Alice'")
        aeval("age = 30")
        result = aeval("f'{name} is {age} years old'")
        assert result == "Alice is 30 years old"


class TestFunctions:
    """Test function definitions and calls."""

    def test_function_definition(self):
        """Test that function definitions work."""
        aeval = Interpreter()
        aeval("def add(a, b): return a + b")
        assert aeval("add(3, 5)") == 8

    def test_function_with_default_args(self):
        """Test functions with default arguments."""
        aeval = Interpreter()
        aeval("def greet(name, greeting='Hello'): return f'{greeting}, {name}!'")
        assert aeval("greet('World')") == "Hello, World!"
        assert aeval("greet('World', 'Hi')") == "Hi, World!"

    def test_recursive_function(self):
        """Test recursive functions."""
        aeval = Interpreter()
        aeval("""
def factorial(n):
    if n <= 1:
        return 1
    return n * factorial(n - 1)
""")
        assert aeval("factorial(5)") == 120

    def test_lambda_function(self):
        """Test lambda functions."""
        aeval = Interpreter()
        # asteval has limitations with lambda assignment, use regular function
        aeval("def square(x): return x * x")
        assert aeval("square(5)") == 25


class TestDataStructures:
    """Test list, dict, and other data structure operations."""

    def test_list_creation(self):
        """Test list creation."""
        aeval = Interpreter()
        result = aeval("[1, 2, 3, 4, 5]")
        assert result == [1, 2, 3, 4, 5]

    def test_list_comprehension(self):
        """Test list comprehensions."""
        aeval = Interpreter()
        result = aeval("[x*2 for x in range(5)]")
        assert result == [0, 2, 4, 6, 8]

    def test_list_operations(self):
        """Test list operations."""
        aeval = Interpreter()
        aeval("lst = [1, 2, 3]")
        assert aeval("len(lst)") == 3
        assert aeval("lst[0]") == 1
        assert aeval("lst[-1]") == 3

    def test_dict_creation(self):
        """Test dictionary creation."""
        aeval = Interpreter()
        result = aeval("{'a': 1, 'b': 2}")
        assert result == {'a': 1, 'b': 2}

    def test_dict_operations(self):
        """Test dictionary operations."""
        aeval = Interpreter()
        aeval("d = {'x': 10, 'y': 20}")
        assert aeval("d['x']") == 10
        assert aeval("len(d)") == 2

    def test_tuple_creation(self):
        """Test tuple creation."""
        aeval = Interpreter()
        result = aeval("(1, 2, 3)")
        assert result == (1, 2, 3)

    def test_set_creation(self):
        """Test set creation."""
        aeval = Interpreter()
        result = aeval("{1, 2, 3, 2, 1}")
        assert result == {1, 2, 3}


class TestControlFlow:
    """Test control flow statements."""

    def test_if_statement(self):
        """Test if statement."""
        aeval = Interpreter()
        aeval("""
x = 10
if x > 5:
    result = 'greater'
else:
    result = 'not greater'
""")
        assert aeval("result") == 'greater'

    def test_for_loop(self):
        """Test for loop."""
        aeval = Interpreter()
        aeval("""
total = 0
for i in range(5):
    total = total + i
""")
        assert aeval("total") == 10

    def test_while_loop(self):
        """Test while loop."""
        aeval = Interpreter()
        aeval("""
count = 0
while count < 5:
    count = count + 1
""")
        assert aeval("count") == 5


class TestBuiltinFunctions:
    """Test built-in functions."""

    def test_abs(self):
        """Test abs function."""
        aeval = Interpreter()
        assert aeval("abs(-5)") == 5
        assert aeval("abs(5)") == 5

    def test_min_max(self):
        """Test min and max functions."""
        aeval = Interpreter()
        assert aeval("min(3, 1, 4, 1, 5)") == 1
        assert aeval("max(3, 1, 4, 1, 5)") == 5

    def test_sum(self):
        """Test sum function."""
        aeval = Interpreter()
        assert aeval("sum([1, 2, 3, 4, 5])") == 15

    def test_round(self):
        """Test round function."""
        aeval = Interpreter()
        assert aeval("round(3.7)") == 4
        assert aeval("round(3.14159, 2)") == 3.14

    def test_sorted(self):
        """Test sorted function."""
        aeval = Interpreter()
        result = aeval("sorted([3, 1, 4, 1, 5, 9, 2, 6])")
        assert result == [1, 1, 2, 3, 4, 5, 6, 9]


class TestStringFormatting:
    """Test various string formatting operations."""

    def test_str_formatting_basic(self):
        """Test basic string operations that should work."""
        aeval = Interpreter()
        assert aeval("'hello'.upper()") == "HELLO"
        assert aeval("'HELLO'.lower()") == "hello"
        assert aeval("'hello world'.title()") == "Hello World"

    def test_str_split_join(self):
        """Test string split and join."""
        aeval = Interpreter()
        assert aeval("'a,b,c'.split(',')") == ['a', 'b', 'c']
        assert aeval("','.join(['x', 'y', 'z'])") == "x,y,z"

    def test_str_strip(self):
        """Test string strip operations."""
        aeval = Interpreter()
        assert aeval("'  hello  '.strip()") == "hello"
        assert aeval("'  hello  '.lstrip()") == "hello  "
        assert aeval("'  hello  '.rstrip()") == "  hello"

    def test_str_replace(self):
        """Test string replace."""
        aeval = Interpreter()
        assert aeval("'hello world'.replace('world', 'there')") == "hello there"
