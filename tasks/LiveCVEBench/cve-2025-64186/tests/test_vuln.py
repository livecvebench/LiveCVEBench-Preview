"""
Vulnerability tests for PCR attestation validation.

These tests verify the vulnerability status:
- FAIL in vulnerable state (vulnerability is exploitable - incomplete PCRs pass)
- PASS in fixed state (vulnerability is mitigated - incomplete PCRs rejected)

The vulnerability allows incomplete attestation documents (missing PCR values)
to incorrectly pass validation because the comparison helper treats empty
strings as "matching" any expected value.
"""

import subprocess
import pytest


def run_inline_go_test(code: str, test_file: str = "/tmp/vuln_test.go") -> subprocess.CompletedProcess:
    """Run inline Go code and return the result."""
    with open(test_file, "w") as f:
        f.write(code)
    return subprocess.run(
        ["go", "run", test_file],
        cwd="/app",
        capture_output=True,
        text=True,
        timeout=60
    )


class TestIncompleteReceivedPCRsVulnerability:
    """
    Tests for the vulnerability where incomplete received PCRs are accepted.

    The fix introduces SatisfiedBy() method that enforces minimal PCR set
    (PCR0, PCR1, PCR2 must be present in received attestation).
    """

    def test_satisfiedby_method_exists(self):
        """
        VULNERABILITY TEST: The fix adds a SatisfiedBy() method.

        Before fix: Method doesn't exist, test fails
        After fix: Method exists, test passes
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    expected := attestation.PCRs{PCR0: "0", PCR1: "1", PCR2: "2", PCR8: "8"}
    received := attestation.PCRs{PCR0: "0", PCR1: "1", PCR2: "2", PCR8: "8"}
    // This method only exists after the fix
    result := expected.SatisfiedBy(received)
    fmt.Println(result)
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_satisfiedby_exists.go")
        assert result.returncode == 0, f"SatisfiedBy method does not exist (fix not applied): {result.stderr}"
        assert "true" in result.stdout

    def test_empty_received_pcrs_rejected(self):
        """
        VULNERABILITY TEST: Empty received PCRs should be rejected.

        Before fix (vulnerable): Empty PCRs incorrectly pass Equal() validation
        After fix: SatisfiedBy() rejects empty PCRs
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    expected := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "jkl012",
    }

    // Malicious/incomplete attestation - all PCRs empty
    received := attestation.PCRs{
        PCR0: "",
        PCR1: "",
        PCR2: "",
        PCR8: "",
    }

    // SatisfiedBy should return false (reject empty PCRs)
    result := expected.SatisfiedBy(received)
    if result {
        fmt.Println("VULNERABLE:accepted")
    } else {
        fmt.Println("FIXED:rejected")
    }
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_empty_rejected.go")
        assert result.returncode == 0, f"Test execution failed: {result.stderr}"
        assert "FIXED:rejected" in result.stdout, "Vulnerability: empty received PCRs were incorrectly accepted"

    def test_missing_pcr0_rejected(self):
        """
        VULNERABILITY TEST: Received PCRs missing PCR0 should be rejected.
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    expected := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
    }

    // Missing PCR0 (empty string)
    received := attestation.PCRs{
        PCR0: "",        // Missing!
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "jkl012",
    }

    result := expected.SatisfiedBy(received)
    if result {
        fmt.Println("VULNERABLE:accepted_missing_pcr0")
    } else {
        fmt.Println("FIXED:rejected_missing_pcr0")
    }
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_missing_pcr0.go")
        assert result.returncode == 0, f"Test execution failed: {result.stderr}"
        assert "FIXED:rejected_missing_pcr0" in result.stdout, "Vulnerability: missing PCR0 was accepted"

    def test_missing_pcr1_rejected(self):
        """
        VULNERABILITY TEST: Received PCRs missing PCR1 should be rejected.
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    expected := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
    }

    // Missing PCR1 (empty string)
    received := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "",        // Missing!
        PCR2: "ghi789",
        PCR8: "jkl012",
    }

    result := expected.SatisfiedBy(received)
    if result {
        fmt.Println("VULNERABLE:accepted_missing_pcr1")
    } else {
        fmt.Println("FIXED:rejected_missing_pcr1")
    }
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_missing_pcr1.go")
        assert result.returncode == 0, f"Test execution failed: {result.stderr}"
        assert "FIXED:rejected_missing_pcr1" in result.stdout, "Vulnerability: missing PCR1 was accepted"

    def test_missing_pcr2_rejected(self):
        """
        VULNERABILITY TEST: Received PCRs missing PCR2 should be rejected.
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    expected := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
    }

    // Missing PCR2 (empty string)
    received := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "",        // Missing!
        PCR8: "jkl012",
    }

    result := expected.SatisfiedBy(received)
    if result {
        fmt.Println("VULNERABLE:accepted_missing_pcr2")
    } else {
        fmt.Println("FIXED:rejected_missing_pcr2")
    }
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_missing_pcr2.go")
        assert result.returncode == 0, f"Test execution failed: {result.stderr}"
        assert "FIXED:rejected_missing_pcr2" in result.stdout, "Vulnerability: missing PCR2 was accepted"

    def test_incomplete_received_pcrs_go_test(self):
        """
        VULNERABILITY TEST: Run official test case for incomplete received PCRs.

        This test uses the official test case from the fix commit.
        Received PCRs missing PCR1 should be rejected.
        """
        result = subprocess.run(
            ["go", "test", "-v", "-run", "TestFailureOnAnyIncompleteReceivedPCRs", "./attestation/..."],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Test failed - incomplete received PCRs not rejected: {result.stdout}\n{result.stderr}"


class TestPartialExpectedPCRsMatching:
    """
    Tests for partial expected PCRs matching against complete received PCRs.

    The fix allows clients to specify only a subset of expected PCRs,
    but received PCRs must still contain the minimal set (PCR0, PCR1, PCR2).
    """

    def test_partial_expected_pcrs_match(self):
        """
        VULNERABILITY TEST: Partial expected PCRs should match when received PCRs are complete.

        After fix: SatisfiedBy() allows partial expected PCRs to match
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    // Only expect PCR0 and PCR8 (partial set)
    expected := attestation.PCRs{
        PCR0: "abc123",
        PCR8: "jkl012",
    }

    // Complete set of received PCRs
    received := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "jkl012",
    }

    result := expected.SatisfiedBy(received)
    if result {
        fmt.Println("CORRECT:partial_match")
    } else {
        fmt.Println("WRONG:partial_no_match")
    }
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_partial_match.go")
        assert result.returncode == 0, f"Test execution failed: {result.stderr}"
        assert "CORRECT:partial_match" in result.stdout, "Partial expected PCRs should match complete received PCRs"

    def test_partial_expected_pcrs_go_test(self):
        """
        VULNERABILITY TEST: Run official test case for partial PCR matching.
        """
        result = subprocess.run(
            ["go", "test", "-v", "-run", "TestPartialPCRsMatchReceived", "./attestation/..."],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Test failed - partial PCRs matching broken: {result.stdout}\n{result.stderr}"


class TestMismatchDetection:
    """
    Tests for detection of mismatched PCR values.
    """

    def test_mismatch_in_pcr8_rejected(self):
        """
        VULNERABILITY TEST: Mismatched PCR8 should be rejected.
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    expected := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "expected_pcr8",
    }

    received := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "different_pcr8",  // Mismatch!
    }

    result := expected.SatisfiedBy(received)
    if result {
        fmt.Println("VULNERABLE:mismatch_accepted")
    } else {
        fmt.Println("FIXED:mismatch_rejected")
    }
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_mismatch_pcr8.go")
        assert result.returncode == 0, f"Test execution failed: {result.stderr}"
        assert "FIXED:mismatch_rejected" in result.stdout, "Mismatched PCR8 should be rejected"

    def test_mismatch_detection_go_test(self):
        """
        VULNERABILITY TEST: Run official test case for mismatch detection.
        """
        result = subprocess.run(
            ["go", "test", "-v", "-run", "TestFailureOnAnyMismatch", "./attestation/..."],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Test failed - mismatch not detected: {result.stdout}\n{result.stderr}"

    def test_expected_value_not_set_go_test(self):
        """
        VULNERABILITY TEST: Received PCRs missing expected value should be rejected.
        """
        result = subprocess.run(
            ["go", "test", "-v", "-run", "TestFailureOnAnyExpectedValueNotSet", "./attestation/..."],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Test failed - missing expected value not rejected: {result.stdout}\n{result.stderr}"


class TestMinimalPCRSetEnforcement:
    """
    Tests for enforcement of minimal PCR set (PCR0, PCR1, PCR2) in received attestation.
    """

    def test_minimal_pcr_set_method(self):
        """
        VULNERABILITY TEST: Verify isMinimalPCRSet helper exists (internal method via SatisfiedBy).
        """
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    // Expected: some PCRs
    expected := attestation.PCRs{PCR8: "8"}

    // Received: missing PCR1 (incomplete minimal set)
    received := attestation.PCRs{
        PCR0: "0",
        PCR1: "",  // Missing - breaks minimal set
        PCR2: "2",
        PCR8: "8",
    }

    result := expected.SatisfiedBy(received)
    if result {
        fmt.Println("VULNERABLE:incomplete_minimal_set_accepted")
    } else {
        fmt.Println("FIXED:incomplete_minimal_set_rejected")
    }
}
'''
        result = run_inline_go_test(test_code, "/tmp/test_minimal_set.go")
        assert result.returncode == 0, f"Test execution failed: {result.stderr}"
        assert "FIXED:incomplete_minimal_set_rejected" in result.stdout, "Incomplete minimal PCR set should be rejected"

    def test_all_attestation_tests_pass(self):
        """
        Run all attestation tests to verify the fix is complete.
        """
        result = subprocess.run(
            ["go", "test", "-v", "./attestation/..."],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=120
        )
        assert result.returncode == 0, f"Attestation tests failed: {result.stdout}\n{result.stderr}"
