"""
Functionality tests for MDC Renderer.

These tests verify that the markdown renderer works correctly and properly
sanitizes dangerous HTML elements. Tests should PASS in both vulnerable
and fixed states (except for new sanitization behavior).
"""

import pytest
import requests
import time
import re
from typing import Optional

BASE_URL = "http://localhost:3000"
TIMEOUT = 10


def wait_for_server(max_attempts: int = 30, delay: float = 1.0) -> bool:
    """Wait for the Nuxt server to be ready."""
    for _ in range(max_attempts):
        try:
            response = requests.get(f"{BASE_URL}/", timeout=5)
            if response.status_code == 200:
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
    return False


@pytest.fixture(scope="module", autouse=True)
def server_ready():
    """Ensure server is ready before running tests."""
    if not wait_for_server():
        pytest.skip("Server not available")


class TestBasicMarkdownRendering:
    """Test basic markdown rendering functionality."""

    def test_plain_text_renders(self):
        """Test that plain text markdown renders correctly."""
        response = requests.get(f"{BASE_URL}/test?content=Hello%20World", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Hello" in response.text

    def test_markdown_headers_render(self):
        """Test that markdown headers render correctly."""
        # URL encoded: # Test Header
        response = requests.get(f"{BASE_URL}/test?content=%23%20Test%20Header", timeout=TIMEOUT)
        assert response.status_code == 200
        # Should contain an h1 tag
        assert "<h1" in response.text.lower() or "test header" in response.text.lower()

    def test_markdown_paragraphs_render(self):
        """Test that paragraphs render correctly."""
        response = requests.get(f"{BASE_URL}/test?content=This%20is%20a%20paragraph", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "paragraph" in response.text.lower()

    def test_markdown_links_render(self):
        """Test that markdown links render correctly."""
        # URL encoded: [Link](https://example.com)
        content = "%5BLink%5D(https%3A%2F%2Fexample.com)"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        # Should contain a link
        assert "example.com" in response.text or "Link" in response.text


class TestScriptTagSanitization:
    """Test that script tags are properly sanitized (existing functionality)."""

    def test_script_tag_converted_to_pre(self):
        """Test that script tags are converted to pre elements."""
        # URL encoded: <script>alert('xss')</script>
        content = "%3Cscript%3Ealert('xss')%3C%2Fscript%3E"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        html = response.text.lower()
        # Should NOT contain executable script tag (without pre wrapper)
        # The script should be inside a pre tag or escaped
        assert "script-to-pre" in html or "mdc-renderer-dangerous-tag" in html or "&lt;script" in html

    def test_script_tag_content_not_executed(self):
        """Test that script content is not executable."""
        content = "%3Cscript%3Edocument.write('EXECUTED')%3C%2Fscript%3E"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        # The word EXECUTED should not appear as rendered output
        # (it would only appear if the script actually ran)
        # But it might appear as escaped content in a pre tag
        html = response.text
        # Check that it's properly escaped/contained
        assert "script-to-pre" in html or "mdc-renderer-dangerous-tag" in html or "&lt;script" in html


class TestNormalHtmlElements:
    """Test that normal safe HTML elements render correctly."""

    def test_div_renders(self):
        """Test that div elements render correctly."""
        content = "%3Cdiv%3ETest%20content%3C%2Fdiv%3E"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Test content" in response.text or "test content" in response.text.lower()

    def test_span_renders(self):
        """Test that span elements render correctly."""
        content = "%3Cspan%3EInline%20text%3C%2Fspan%3E"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Inline text" in response.text or "inline text" in response.text.lower()

    def test_strong_renders(self):
        """Test that strong/bold elements render correctly."""
        content = "%3Cstrong%3EBold%20text%3C%2Fstrong%3E"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Bold text" in response.text or "bold text" in response.text.lower()

    def test_code_block_renders(self):
        """Test that code blocks render correctly."""
        # URL encoded: ```\ncode\n```
        content = "%60%60%60%0Acode%0A%60%60%60"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        # Should contain code element or pre element
        assert "<code" in response.text.lower() or "<pre" in response.text.lower() or "code" in response.text.lower()


class TestMixedContent:
    """Test rendering of mixed markdown and HTML content."""

    def test_mixed_markdown_and_html(self):
        """Test that mixed content renders correctly."""
        # Markdown with HTML: # Header\n<div>Content</div>
        content = "%23%20Header%0A%3Cdiv%3EContent%3C%2Fdiv%3E"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Header" in response.text or "Content" in response.text

    def test_nested_elements(self):
        """Test that nested elements render correctly."""
        # <div><p>Nested paragraph</p></div>
        content = "%3Cdiv%3E%3Cp%3ENested%20paragraph%3C%2Fp%3E%3C%2Fdiv%3E"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        assert "Nested paragraph" in response.text or "nested paragraph" in response.text.lower()


class TestEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_empty_content(self):
        """Test that empty content is handled gracefully."""
        response = requests.get(f"{BASE_URL}/test?content=", timeout=TIMEOUT)
        assert response.status_code == 200

    def test_special_characters(self):
        """Test that special characters are handled correctly."""
        # Content with special chars: Hello & World < > "
        content = "Hello%20%26%20World%20%3C%20%3E%20%22"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
        # Should handle the content without crashing

    def test_unicode_content(self):
        """Test that unicode content renders correctly."""
        # Content: Hello ‰∏ñÁïå üåç
        content = "Hello%20%E4%B8%96%E7%95%8C%20%F0%9F%8C%8D"
        response = requests.get(f"{BASE_URL}/test?content={content}", timeout=TIMEOUT)
        assert response.status_code == 200
