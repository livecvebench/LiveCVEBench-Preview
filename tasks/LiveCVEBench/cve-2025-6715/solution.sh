#!/bin/bash
#
# Fix for LatePoint Plugin Local File Inclusion Vulnerability
#
# This script adds proper sanitization to the layout parameter to prevent
# path traversal attacks in the customer cabinet controller.
#

set -e

echo "[*] Applying fix for LatePoint layout parameter path traversal..."

PLUGIN_DIR="/var/www/html/wp-content/plugins/latepoint"
TARGET_FILE="$PLUGIN_DIR/lib/controllers/customer_cabinet_controller.php"

# Wait for plugin to be installed (setup-wordpress.sh runs asynchronously)
echo "[*] Waiting for LatePoint plugin to be installed..."
max_wait=120
waited=0
while [ ! -d "$PLUGIN_DIR" ]; do
    sleep 2
    waited=$((waited + 2))
    if [ $waited -ge $max_wait ]; then
        echo "[!] Timeout waiting for plugin installation"
        break
    fi
    echo "[*] Waiting for plugin... ($waited/$max_wait seconds)"
done

# Find the target file if it's in a different location
if [ ! -f "$TARGET_FILE" ]; then
    echo "[*] Target file not found at expected location, searching..."
    # Wait a bit more for all files to be copied
    sleep 5
    TARGET_FILE=$(find /var/www/html -name "customer_cabinet_controller.php" -type f 2>/dev/null | head -1)

    if [ -z "$TARGET_FILE" ]; then
        # Try alternate file names or locations
        TARGET_FILE=$(find /var/www/html -name "*customer*cabinet*.php" -type f 2>/dev/null | head -1)
    fi

    if [ -z "$TARGET_FILE" ]; then
        echo "[!] Error: customer_cabinet_controller.php not found"
        # List plugin directory to debug
        echo "[*] Plugin directory contents:"
        find "$PLUGIN_DIR" -type f -name "*.php" 2>/dev/null | head -20 || true
        exit 1
    fi
fi

echo "[*] Found target file: $TARGET_FILE"

# Create a backup
cp "$TARGET_FILE" "$TARGET_FILE.bak"

# Check if fix is already applied (idempotency check)
if grep -q "basename.*layout.*Security fix" "$TARGET_FILE" 2>/dev/null; then
    echo "[*] Fix already applied, skipping..."
    exit 0
fi

# Fix approach: Add basename() sanitization after the layout parameter is retrieved
# This removes any directory components from the user input

# First, try to find and modify the specific pattern for getting the layout parameter
# Pattern: $layout = OsParamsHelper::get_param('layout'
if grep -q "get_param.*'layout'" "$TARGET_FILE"; then
    echo "[*] Found layout parameter retrieval pattern"

    # Add sanitization line after the layout parameter assignment
    # We look for the line that assigns $layout from get_param and add our fix after it
    sed -i "/\$layout.*=.*get_param.*'layout'/a\\        \$layout = basename(preg_replace('/[^a-zA-Z0-9_-]/', '', \$layout)); // Security fix: prevent path traversal" "$TARGET_FILE"

    echo "[+] Added basename() sanitization after layout parameter retrieval"
else
    # Alternative: Search for any pattern that builds a path with $layout
    echo "[*] Trying alternative fix approach..."

    # Look for include/require statements with $layout
    if grep -qE "(include|require).*\\\$layout" "$TARGET_FILE"; then
        # Add sanitization before the include/require
        sed -i "/(include|require).*\\\$layout/i\\        \$layout = basename(preg_replace('/[^a-zA-Z0-9_-]/', '', \$layout)); // Security fix" "$TARGET_FILE"
        echo "[+] Added sanitization before include statement"
    else
        # Most generic fix: Find where $layout is used and sanitize it
        # Add sanitization at class level or function start
        echo "[*] Applying generic fix pattern..."

        # Find the function that handles the layout and add sanitization
        # Look for public function or function that likely renders views
        if grep -q "function.*index\|function.*render\|function.*show" "$TARGET_FILE"; then
            # Add a sanitization line early in the file after class/function definition
            sed -i '/function.*index\s*(/,/\$layout.*=/ {
                /\$layout.*=/ a\        $layout = basename(preg_replace("/[^a-zA-Z0-9_-]/", "", $layout)); // Security fix: prevent path traversal
            }' "$TARGET_FILE" 2>/dev/null || true
        fi
    fi
fi

# Verify the fix was applied
if grep -q "basename.*preg_replace.*layout\|Security fix" "$TARGET_FILE"; then
    echo "[+] Fix successfully applied!"
else
    echo "[!] Standard patterns not found, applying comprehensive fix..."

    # More aggressive approach: Add sanitization function and call it
    # Create a patch that adds sanitization directly
    cat > /tmp/latepoint_fix.patch << 'PATCHEOF'
--- a/customer_cabinet_controller.php
+++ b/customer_cabinet_controller.php
@@ -1,3 +1,13 @@
 <?php
+// Security fix: Sanitize layout parameter to prevent path traversal
+add_action('init', function() {
+    if (isset($_GET['layout'])) {
+        $_GET['layout'] = basename(preg_replace('/[^a-zA-Z0-9_-]/', '', $_GET['layout']));
+    }
+    if (isset($_POST['layout'])) {
+        $_POST['layout'] = basename(preg_replace('/[^a-zA-Z0-9_-]/', '', $_POST['layout']));
+    }
+}, 1);
+
PATCHEOF

    # Try to apply the patch
    cd "$(dirname "$TARGET_FILE")"
    patch -p1 < /tmp/latepoint_fix.patch 2>/dev/null || {
        # If patch fails, manually insert the fix at the beginning of the file
        echo "[*] Patch failed, inserting fix manually..."

        # Read the file content
        CONTENT=$(cat "$TARGET_FILE")

        # Create new content with fix
        cat > "$TARGET_FILE" << 'FIXEOF'
<?php
// Security fix: Sanitize layout parameter to prevent LFI
add_action('init', function() {
    if (isset($_GET['layout'])) {
        $layout = $_GET['layout'];
        $layout = basename($layout);
        $layout = preg_replace('/[^a-zA-Z0-9_-]/', '', $layout);
        if (empty($layout)) {
            $layout = 'default';
        }
        $_GET['layout'] = $layout;
    }
    if (isset($_POST['layout'])) {
        $layout = $_POST['layout'];
        $layout = basename($layout);
        $layout = preg_replace('/[^a-zA-Z0-9_-]/', '', $layout);
        if (empty($layout)) {
            $layout = 'default';
        }
        $_POST['layout'] = $layout;
    }
    if (isset($_REQUEST['layout'])) {
        $layout = $_REQUEST['layout'];
        $layout = basename($layout);
        $layout = preg_replace('/[^a-zA-Z0-9_-]/', '', $layout);
        if (empty($layout)) {
            $layout = 'default';
        }
        $_REQUEST['layout'] = $layout;
    }
}, 1);

FIXEOF

        # Append original content (minus the first <?php line)
        echo "$CONTENT" | tail -n +2 >> "$TARGET_FILE"

        echo "[+] Security fix injected at file start"
    }
fi

# Also add fix to the main plugin file for early sanitization
MAIN_PLUGIN="$PLUGIN_DIR/latepoint.php"
if [ -f "$MAIN_PLUGIN" ]; then
    if ! grep -q "Security fix.*layout.*path traversal" "$MAIN_PLUGIN"; then
        echo "[*] Adding early sanitization to main plugin file..."

        # Insert sanitization after the first <?php line
        sed -i '1a\// Security fix: Sanitize layout parameter early to prevent path traversal\nif (isset($_GET["layout"])) { $_GET["layout"] = basename(preg_replace("/[^a-zA-Z0-9_-]/", "", $_GET["layout"])); if (empty($_GET["layout"])) $_GET["layout"] = "default"; }\nif (isset($_POST["layout"])) { $_POST["layout"] = basename(preg_replace("/[^a-zA-Z0-9_-]/", "", $_POST["layout"])); if (empty($_POST["layout"])) $_POST["layout"] = "default"; }\nif (isset($_REQUEST["layout"])) { $_REQUEST["layout"] = basename(preg_replace("/[^a-zA-Z0-9_-]/", "", $_REQUEST["layout"])); if (empty($_REQUEST["layout"])) $_REQUEST["layout"] = "default"; }' "$MAIN_PLUGIN"

        echo "[+] Early sanitization added to latepoint.php"
    fi
fi

echo ""
echo "[+] Fix applied successfully!"
echo "[*] Changes made:"
echo "    - Added basename() to remove directory components"
echo "    - Added regex filter to only allow alphanumeric, underscore, and hyphen"
echo "    - Added fallback to 'default' for empty/invalid layouts"
echo ""

# Clear any PHP opcode cache by touching the files
touch "$TARGET_FILE"
[ -f "$MAIN_PLUGIN" ] && touch "$MAIN_PLUGIN"

echo "[*] Done!"
