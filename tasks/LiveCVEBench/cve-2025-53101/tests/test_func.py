"""
Functionality tests for ImageMagick.

These tests verify that ImageMagick's basic functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import tempfile
import pytest


class TestBasicFunctionality:
    """Test basic ImageMagick operations."""

    def test_imagemagick_version(self):
        """Verify ImageMagick is installed and can report version."""
        result = subprocess.run(
            ['magick', '--version'],
            capture_output=True,
            text=True,
            timeout=10
        )
        assert result.returncode == 0, f"Failed to get version: {result.stderr}"
        assert 'ImageMagick' in result.stdout, "Version output should contain 'ImageMagick'"

    def test_create_simple_image(self):
        """Test creating a simple image."""
        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f:
            temp_path = f.name

        try:
            result = subprocess.run(
                ['magick', '-size', '10x10', 'xc:white', temp_path],
                capture_output=True,
                text=True,
                timeout=30
            )
            assert result.returncode == 0, f"Failed to create image: {result.stderr}"
            assert os.path.exists(temp_path), "Output image should exist"
            assert os.path.getsize(temp_path) > 0, "Output image should not be empty"
        finally:
            if os.path.exists(temp_path):
                os.unlink(temp_path)

    def test_identify_image(self):
        """Test identifying image properties."""
        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f:
            temp_path = f.name

        try:
            # Create a test image
            subprocess.run(
                ['magick', '-size', '10x10', 'xc:red', temp_path],
                capture_output=True,
                check=True,
                timeout=30
            )

            # Identify the image
            result = subprocess.run(
                ['magick', 'identify', temp_path],
                capture_output=True,
                text=True,
                timeout=30
            )
            assert result.returncode == 0, f"Failed to identify image: {result.stderr}"
            assert 'PNG' in result.stdout or '10x10' in result.stdout, \
                "Identify output should contain image info"
        finally:
            if os.path.exists(temp_path):
                os.unlink(temp_path)

    def test_mogrify_resize(self):
        """Test mogrify resize operation."""
        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f:
            temp_path = f.name

        try:
            # Create a test image
            subprocess.run(
                ['magick', '-size', '100x100', 'xc:blue', temp_path],
                capture_output=True,
                check=True,
                timeout=30
            )

            # Mogrify to resize
            result = subprocess.run(
                ['magick', 'mogrify', '-resize', '50x50', temp_path],
                capture_output=True,
                text=True,
                timeout=30
            )
            assert result.returncode == 0, f"Failed to resize: {result.stderr}"

            # Verify the resize
            identify_result = subprocess.run(
                ['magick', 'identify', '-format', '%wx%h', temp_path],
                capture_output=True,
                text=True,
                timeout=30
            )
            assert '50x50' in identify_result.stdout, \
                f"Image should be resized to 50x50, got: {identify_result.stdout}"
        finally:
            if os.path.exists(temp_path):
                os.unlink(temp_path)

    def test_convert_format(self):
        """Test converting between image formats."""
        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f_png:
            png_path = f_png.name
        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as f_jpg:
            jpg_path = f_jpg.name

        try:
            # Create PNG
            subprocess.run(
                ['magick', '-size', '10x10', 'xc:green', png_path],
                capture_output=True,
                check=True,
                timeout=30
            )

            # Convert to JPG
            result = subprocess.run(
                ['magick', png_path, jpg_path],
                capture_output=True,
                text=True,
                timeout=30
            )
            assert result.returncode == 0, f"Failed to convert: {result.stderr}"
            assert os.path.exists(jpg_path), "Output JPG should exist"
        finally:
            for path in [png_path, jpg_path]:
                if os.path.exists(path):
                    os.unlink(path)


class TestSingleFormatSpecifier:
    """Test valid uses of single format specifiers."""

    def test_single_d_specifier_identify(self):
        """Test single %d format specifier in identify (valid use case)."""
        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f:
            temp_path = f.name

        try:
            # Create a test image
            subprocess.run(
                ['magick', '-size', '10x10', 'xc:white', temp_path],
                capture_output=True,
                check=True,
                timeout=30
            )

            # Use %d in identify format (valid - gets directory)
            result = subprocess.run(
                ['magick', 'identify', '-format', '%d', temp_path],
                capture_output=True,
                text=True,
                timeout=10
            )
            # Should complete without crashing
            assert result.returncode not in [139, 134, -11, -6], \
                f"Process should not crash, got exit code: {result.returncode}"
        finally:
            if os.path.exists(temp_path):
                os.unlink(temp_path)

    def test_format_specifier_with_width(self):
        """Test %0Nd format specifier with field width (e.g., %04d)."""
        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f:
            temp_path = f.name

        try:
            # Create a test image
            subprocess.run(
                ['magick', '-size', '10x10', 'xc:white', temp_path],
                capture_output=True,
                check=True,
                timeout=30
            )

            # Use format with field width
            result = subprocess.run(
                ['magick', 'identify', '-format', '%04d', temp_path],
                capture_output=True,
                text=True,
                timeout=10
            )
            # Should complete without crashing
            assert result.returncode not in [139, 134, -11, -6], \
                f"Process should not crash, got exit code: {result.returncode}"
        finally:
            if os.path.exists(temp_path):
                os.unlink(temp_path)


class TestMogrifyNoFiles:
    """Test mogrify behavior when no files match."""

    def test_mogrify_no_matching_files(self):
        """Test mogrify with a pattern that matches no files."""
        result = subprocess.run(
            ['magick', 'mogrify', 'nonexistent_file_12345.png'],
            capture_output=True,
            text=True,
            timeout=10
        )
        # Should handle gracefully (may return non-zero but not crash)
        crash_codes = [139, 134, -11, -6]
        assert result.returncode not in crash_codes, \
            f"Process crashed with code {result.returncode}"


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
