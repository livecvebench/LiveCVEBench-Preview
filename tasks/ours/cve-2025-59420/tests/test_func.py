"""
Functional tests for JWS basic operations.

These tests verify that the Authlib JWS implementation works correctly
for basic signing and verification operations. They should PASS on
both vulnerable and fixed versions.

Test behavior:
- PASS on vulnerable version (basic functionality works)
- PASS on fixed version (basic functionality still works)
"""
import json
import base64
import hmac
import hashlib
import pytest
from authlib.jose import JsonWebSignature
from authlib.jose import errors


def base64url_encode(data):
    """Base64url encode without padding."""
    if isinstance(data, str):
        data = data.encode('utf-8')
    return base64.urlsafe_b64encode(data).rstrip(b'=').decode('utf-8')


class TestBasicJWSOperations:
    """Test basic JWS signing and verification."""

    def test_serialize_compact_hs256(self):
        """Test basic HS256 compact serialization."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        header = {"alg": "HS256"}
        payload = b"hello world"

        token = jws.serialize_compact(header, payload, secret)
        assert token is not None
        assert isinstance(token, bytes)
        # Token should have 3 parts separated by dots
        parts = token.split(b'.')
        assert len(parts) == 3

    def test_deserialize_compact_hs256(self):
        """Test basic HS256 compact deserialization."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        header = {"alg": "HS256"}
        payload = b"hello world"

        token = jws.serialize_compact(header, payload, secret)
        result = jws.deserialize_compact(token, secret)

        assert result is not None
        assert result["payload"] == payload
        assert result["header"]["alg"] == "HS256"

    def test_roundtrip_compact_serialization(self):
        """Test roundtrip compact serialization."""
        jws = JsonWebSignature()
        secret = "my-secret-key-123"

        original_payload = b"Test payload data"
        header = {"alg": "HS256"}

        # Serialize
        token = jws.serialize_compact(header, original_payload, secret)

        # Deserialize
        result = jws.deserialize_compact(token, secret)

        # Verify roundtrip
        assert result["payload"] == original_payload

    def test_signature_verification_fails_with_wrong_key(self):
        """Test that verification fails with wrong key."""
        jws = JsonWebSignature()
        correct_secret = "correct-secret"
        wrong_secret = "wrong-secret"

        header = {"alg": "HS256"}
        payload = b"hello"

        token = jws.serialize_compact(header, payload, correct_secret)

        with pytest.raises(errors.BadSignatureError):
            jws.deserialize_compact(token, wrong_secret)


class TestJWSWithHeaders:
    """Test JWS with various header parameters."""

    def test_token_with_kid_header(self):
        """Test token with kid header."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        header = {"alg": "HS256", "kid": "key-1"}
        payload = b"payload"

        token = jws.serialize_compact(header, payload, secret)
        result = jws.deserialize_compact(token, secret)

        assert result["header"]["kid"] == "key-1"
        assert result["payload"] == payload

    def test_token_with_typ_header(self):
        """Test token with typ header."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        header = {"alg": "HS256", "typ": "JWT"}
        payload = b"test"

        token = jws.serialize_compact(header, payload, secret)
        result = jws.deserialize_compact(token, secret)

        assert result["header"]["typ"] == "JWT"

    def test_token_with_multiple_headers(self):
        """Test token with multiple header parameters."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        header = {"alg": "HS256", "kid": "key-1", "typ": "JWT"}
        payload = b"multi-header-test"

        token = jws.serialize_compact(header, payload, secret)
        result = jws.deserialize_compact(token, secret)

        assert result["header"]["alg"] == "HS256"
        assert result["header"]["kid"] == "key-1"
        assert result["header"]["typ"] == "JWT"
        assert result["payload"] == payload


class TestJWSWithCrit:
    """Test JWS with crit header (valid usage)."""

    def test_token_with_valid_crit_and_kid_present(self):
        """Test token with valid crit header where kid is present."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        # crit:["kid"] with kid actually present in header
        header = {"alg": "HS256", "kid": "key-1", "crit": ["kid"]}
        token = jws.serialize_compact(header, b"hello", secret)

        result = jws.deserialize_compact(token, secret)
        assert result["payload"] == b"hello"
        assert result["header"]["kid"] == "key-1"
        assert result["header"]["crit"] == ["kid"]

    def test_token_with_valid_crit_multiple_headers(self):
        """Test token with valid crit listing multiple headers."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        header = {"alg": "HS256", "kid": "key-1", "typ": "JWT", "crit": ["kid", "typ"]}
        token = jws.serialize_compact(header, b"hello", secret)

        result = jws.deserialize_compact(token, secret)
        assert result["payload"] == b"hello"
        assert "kid" in result["header"]["crit"]
        assert "typ" in result["header"]["crit"]


class TestTokensWithoutCrit:
    """Test that normal tokens without crit work correctly."""

    def test_accepts_valid_token_without_crit(self):
        """Normal tokens without crit work correctly."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        token = jws.serialize_compact({"alg": "HS256"}, b"hello", secret)
        result = jws.deserialize_compact(token, secret)

        assert result["payload"] == b"hello"
        assert result["header"]["alg"] == "HS256"
        assert "crit" not in result["header"]

    def test_accepts_token_with_kid_but_no_crit(self):
        """Token with kid header but no crit works normally."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        token = jws.serialize_compact({"alg": "HS256", "kid": "key-1"}, b"payload", secret)
        result = jws.deserialize_compact(token, secret)

        assert result["payload"] == b"payload"
        assert result["header"]["kid"] == "key-1"


class TestPrivateHeaders:
    """Test JWS with private headers configured."""

    def test_accepts_crit_with_registered_private_header(self):
        """JWS accepts crit with configured private header."""
        # Configure 'custom' as a private header
        jws = JsonWebSignature(private_headers=["custom"])
        secret = "test-secret-key"

        # Now 'custom' should be accepted in crit
        header = {"alg": "HS256", "custom": "value", "crit": ["custom"]}
        token = jws.serialize_compact(header, b"hello", secret)

        result = jws.deserialize_compact(token, secret)
        assert result["payload"] == b"hello"
        assert result["header"]["custom"] == "value"


class TestJSONSerialization:
    """Test JSON serialization format."""

    def test_json_serialization_basic(self):
        """Test basic JSON serialization."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        protected = {"alg": "HS256"}
        header = {"protected": protected}

        result = jws.serialize_json(header, b"hello", secret)

        assert result is not None
        assert "signature" in result
        assert "protected" in result
        assert "payload" in result

    def test_json_serialization_with_kid(self):
        """Test JSON serialization with kid in protected header."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        protected = {"alg": "HS256", "kid": "a"}
        header = {"protected": protected}

        result = jws.serialize_json(header, b"hello", secret)
        assert result is not None
        assert "signature" in result

    def test_json_serialization_with_valid_crit(self):
        """Test JSON serialization with valid crit in protected header."""
        jws_with_private = JsonWebSignature(private_headers=["foo"])
        secret = "test-secret-key"

        protected = {"alg": "HS256", "kid": "a", "crit": ["kid"]}
        header = {"protected": protected, "header": {"foo": "bar"}}

        result = jws_with_private.serialize_json(header, b"hello", secret)
        assert result is not None
        assert "signature" in result


class TestGenericDeserialize:
    """Test the generic deserialize() method."""

    def test_generic_deserialize_compact(self):
        """Test generic deserialize() with compact serialization."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        header = {"alg": "HS256", "kid": "key-1"}
        token = jws.serialize(header, b"hello", secret)

        result = jws.deserialize(token, secret)
        assert result["payload"] == b"hello"

    def test_generic_serialize_deserialize_roundtrip(self):
        """Test generic serialize/deserialize roundtrip."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        original_payload = b"roundtrip test"
        header = {"alg": "HS256"}

        token = jws.serialize(header, original_payload, secret)
        result = jws.deserialize(token, secret)

        assert result["payload"] == original_payload


class TestPayloadTypes:
    """Test various payload types."""

    def test_bytes_payload(self):
        """Test with bytes payload."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        payload = b"bytes payload"
        token = jws.serialize_compact({"alg": "HS256"}, payload, secret)
        result = jws.deserialize_compact(token, secret)

        assert result["payload"] == payload

    def test_json_payload(self):
        """Test with JSON-encoded payload."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        payload_dict = {"sub": "user", "exp": 12345}
        payload = json.dumps(payload_dict).encode('utf-8')

        token = jws.serialize_compact({"alg": "HS256"}, payload, secret)
        result = jws.deserialize_compact(token, secret)

        decoded_payload = json.loads(result["payload"].decode('utf-8'))
        assert decoded_payload == payload_dict

    def test_empty_payload(self):
        """Test with empty payload."""
        jws = JsonWebSignature()
        secret = "test-secret-key"

        payload = b""
        token = jws.serialize_compact({"alg": "HS256"}, payload, secret)
        result = jws.deserialize_compact(token, secret)

        assert result["payload"] == payload
