"""
Vulnerability tests for the Hotel Order List API.
These tests verify that the SQL injection vulnerability EXISTS.

For VULNERABLE environment:
- ALL tests should FAIL (vulnerability is present and detectable)
- Tests use payloads designed to cause SQL errors when unsanitized

For FIXED environment:
- ALL tests should PASS (fix blocks injection before database)
- Input is sanitized/validated before reaching database
"""
import requests
import pytest
import time

BASE_URL = "http://localhost"
API_ENDPOINT = f"{BASE_URL}/controller/api/orderList.php"


@pytest.fixture(scope="module")
def wait_for_server():
    """Wait for the web server to be ready"""
    for i in range(30):
        try:
            response = requests.get(BASE_URL, timeout=2)
            return True
        except requests.exceptions.RequestException:
            time.sleep(1)
    pytest.fail("Web server did not become ready in time")


def is_vulnerable_response(response_text):
    """
    Detect if the response indicates vulnerability.

    Returns True if ANY of these conditions are met:
    - SQL error messages are disclosed
    - HTML error div is present
    - Query structure is leaked in response
    """
    indicators = [
        "SQLSTATE",
        "SQL Error",
        "SQL syntax",
        "You have an error in your SQL syntax",
        "Error SQL:",
        "WHERE telephone=",
        "FROM `user`",
        "SELECT *",
    ]
    for indicator in indicators:
        if indicator in response_text:
            return True

    if response_text.strip().startswith("<div"):
        return True

    return False


class TestSQLInjectionPayloads:
    """
    Test SQL injection payloads that cause detectable SQL errors.

    Each payload is carefully chosen to cause a SQL syntax error
    when it reaches the database without sanitization.

    VULNERABLE: All tests FAIL (SQL errors disclosed)
    FIXED: All tests PASS (input blocked before DB)
    """

    def test_trailing_single_quote(self, wait_for_server):
        """Trailing single quote causes unclosed string error"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111'",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_backslash_escape(self, wait_for_server):
        """Backslash at end escapes the closing quote"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111\\",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_quote_comment(self, wait_for_server):
        """Quote with comment causes syntax error"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111'--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_union_select(self, wait_for_server):
        """UNION SELECT causes column mismatch error"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' UNION SELECT 1--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_sleep_function(self, wait_for_server):
        """SLEEP function injection"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111' AND SLEEP(1)--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_null_byte(self, wait_for_server):
        """Null byte injection"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111'%00",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_quote_dash(self, wait_for_server):
        """Quote and dash causes syntax error"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111'-",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_concat_function(self, wait_for_server):
        """CONCAT function injection"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' CONCAT('a','b')--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_subquery(self, wait_for_server):
        """Subquery injection"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' OR (SELECT 1)=1--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_benchmark(self, wait_for_server):
        """BENCHMARK function injection"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' AND BENCHMARK(1,1)--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_quote_paren(self, wait_for_server):
        """Quote with parenthesis"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "15757118111'(",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_triple_quote(self, wait_for_server):
        """Triple quote causes syntax error"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "'''",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_order_by_injection(self, wait_for_server):
        """ORDER BY injection"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' ORDER BY 1--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_extract_version(self, wait_for_server):
        """VERSION() extraction attempt"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' AND VERSION()--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_if_function(self, wait_for_server):
        """IF function injection"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' AND IF(1=1,1,0)--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"

    def test_extractvalue_injection(self, wait_for_server):
        """EXTRACTVALUE function injection - causes error"""
        response = requests.post(API_ENDPOINT, data={
            "telephone": "' AND EXTRACTVALUE(1,1)--",
            "page": "1",
            "size": "10"
        }, timeout=10)

        assert not is_vulnerable_response(response.text), \
            f"VULNERABLE: SQL error disclosed: {response.text[:300]}"
