"""
Vulnerability tests for the School File Management System (CVE-2025-14646).
These tests detect SQL injection vulnerability using time-based blind injection.

Test behavior:
- FAIL in vulnerable state (SQL injection works, SLEEP delays response)
- PASS in fixed state (SQL injection is blocked, no delay)

The delete_student.php endpoint is vulnerable to SQL injection via the stud_id
parameter. Time-based injection is the most reliable detection method for this
application since it doesn't return query results or expose errors visibly.
"""

import pytest
import requests
import time


BASE_URL = "http://localhost"
TIMEOUT = 15
DELETE_ENDPOINT = f"{BASE_URL}/admin/delete_student.php"


class TestTimeBasedSQLInjection:
    """
    Tests for time-based blind SQL injection.

    These tests send SLEEP payloads and measure response time.
    - If vulnerable: Response is delayed by SLEEP duration (test FAILS)
    - If fixed: Response is immediate (test PASSES)
    """

    def test_sleep_injection_3_seconds(self):
        """SQL injection with SLEEP(3) should not delay response when fixed."""
        payload = "1' AND SLEEP(3)-- -"

        start_time = time.time()
        response = requests.post(
            DELETE_ENDPOINT,
            data={"stud_id": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time

        # If vulnerable, response takes > 3 seconds due to SLEEP
        # If fixed, parameterized query treats input as string, no delay
        assert elapsed < 2.5, f"Response took {elapsed:.2f}s, indicates time-based SQL injection vulnerability"

    def test_sleep_injection_5_seconds(self):
        """SQL injection with SLEEP(5) should not delay response when fixed."""
        payload = "1' AND SLEEP(5)-- -"

        start_time = time.time()
        response = requests.post(
            DELETE_ENDPOINT,
            data={"stud_id": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time

        assert elapsed < 2.5, f"Response took {elapsed:.2f}s, indicates time-based SQL injection vulnerability"

    def test_conditional_sleep_true(self):
        """Conditional SLEEP with true condition should not work when fixed."""
        payload = "1' AND IF(1=1,SLEEP(3),0)-- -"

        start_time = time.time()
        response = requests.post(
            DELETE_ENDPOINT,
            data={"stud_id": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time

        assert elapsed < 2.5, f"Response took {elapsed:.2f}s, indicates conditional time-based SQL injection"

    def test_sleep_with_union(self):
        """UNION with SLEEP should cause delay when vulnerable."""
        payload = "1' UNION SELECT SLEEP(3),2,3,4,5,6,7-- -"

        start_time = time.time()
        response = requests.post(
            DELETE_ENDPOINT,
            data={"stud_id": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time

        assert elapsed < 2.5, f"Response took {elapsed:.2f}s, indicates UNION-based time injection"

    def test_sleep_nested_query(self):
        """Nested query with SLEEP should cause delay when vulnerable."""
        payload = "1' AND (SELECT SLEEP(3))-- -"

        start_time = time.time()
        response = requests.post(
            DELETE_ENDPOINT,
            data={"stud_id": payload},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time

        assert elapsed < 2.5, f"Response took {elapsed:.2f}s, indicates nested query time injection"
