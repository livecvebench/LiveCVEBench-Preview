#!/bin/bash
# Solution script for CVE-2025-12928 SQL Injection fix
# Fixes the vulnerable subscribe() function in includes/functions.php
# by adding mysql_real_escape_string() to sanitize user input

set -e

# Backup original file
cp /var/www/html/includes/functions.php /var/www/html/includes/functions.php.bak

# Create fixed version of functions.php
cat > /var/www/html/includes/functions.php << 'PHPEOF'
<?php
//Start session
	//session_start();
$connect=mysql_connect('mysql',DBUSER,DBPASS);
mysql_select_db(DATABASE);

$errmsg_arr = array();
	//Validation error flag
	$errflag = false;

function query($que){
	if(!$check = mysql_query($que))
	{
	echo '<h4> an error occured '.mysql_error(). '</h4>';
	echo '<p>error: '.mysql_error(). '</p>';
	echo '<p>SQL:'.$que.'</p>';
	exit;
	}
	else return $check;
	}

// Sanitization function to prevent SQL injection
function sanitize($str) {
    $str = trim($str);
    if(get_magic_quotes_gpc()) {
        $str = stripslashes($str);
    }
    return mysql_real_escape_string($str);
}

function subscribe($data){

    if(empty($data['txtfullname'])) return 'Please enter your FullName ';
	if(empty($data['txtaddress'])) return 'Please enter your Address';
	if(empty($data['txtphone'])) return 'Please enter your Phone';
	if(empty($data['txtusername'])) return 'Please enter your UserName';

	// FIXED: Sanitize userName to prevent SQL injection
	$userName = sanitize($data['txtusername']);
	if($chk = mysql_query("select username from registration where username ='$userName'"));
	$numrows = mysql_num_rows($chk);
	if($numrows > 0) return 'USERNAME NAME ALREADY EXIST, CHOOSE ANOTHER USERNAME';

	$bday=$_POST['month'] . "/" . $_POST['day'] . "/" . $_POST['year'];

	// FIXED: Sanitize all user inputs before inserting
	$regID = sanitize($data['txtregID']);
	$fullname = sanitize($data['txtfullname']);
	$phone = sanitize($data['txtphone']);
	$state = sanitize($data['state']);
	$sex = sanitize($data['cmdsex']);
	$address = sanitize($data['txtaddress']);
	$qualification = sanitize($data['cmdqualification']);
	$specialization = sanitize($data['cmdspecialization']);
	$bday = sanitize($bday);

	if(mysql_query("INSERT INTO registration(regID,username,fullname,phone,location,DOB,sex,address,highestqualification,Areaofspecialization) values('$regID','$userName','$fullname','$phone','$state','$bday','$sex','$address','$qualification','$specialization')")){
		return ' YOUR SUBSCRIPTION WAS SUCCESSFUL';
	}
	else return 'YOUR SUBSCRIPTION WAS NOT SUCCESSFUL';
}

function postjob($data){

    if(empty($data['txtcompanyname'])) return 'Please enter your Company Name';
	if(empty($data['txtphone'])) return 'Please enter your Phone';
	if(empty($data['txtjobtitle'])) return 'Please enter Job Title';
	if(empty($data['txtdescription'])) return 'Please enter Job Description';
	if(empty($data['txtsalary'])) return 'Please enter Salry';
	if(empty($data['txtdeadline'])) return 'Please enter Deadline';
	if(empty($data['txtapplyto'])) return 'Please enter Where to Apply To';

	// FIXED: Sanitize all inputs
	$jobID = sanitize($data['txtjobID']);
	$companyname = sanitize($data['txtcompanyname']);
	$state = sanitize($data['state']);
	$phone = sanitize($data['txtphone']);
	$jobtitle = sanitize($data['txtjobtitle']);
	$description = sanitize($data['txtdescription']);
	$specialization = sanitize($data['cmdspecialization']);
	$qualification = sanitize($data['cmdqualification']);
	$salary = sanitize($data['txtsalary']);
	$deadline = sanitize($data['txtdeadline']);
	$applyto = sanitize($data['txtapplyto']);

	if(mysql_query("INSERT INTO jobs(jobID,companyname,location,phone,jobtitle,description,specialization,qualification,salary,Deadline,applyTo) values('$jobID','$companyname','$state','$phone','$jobtitle','$description','$specialization','$qualification','$salary','$deadline','$applyto')")){
		return ' YOUR JOB WAS POSTED SUCCESSFULLY';
	}
	else return 'YOUR JOB POSTING WAS NOT SUCCESSFUL';
}

?>
PHPEOF

echo "Fix applied successfully - SQL injection vulnerability patched in functions.php"
