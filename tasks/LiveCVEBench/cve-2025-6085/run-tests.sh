#!/bin/bash
set -e
cd "$(dirname "$0")"

# Install uv package manager
echo "Installing uv package manager..."
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env

# Initialize project and install dependencies
echo "Setting up test environment..."
uv init 2>/dev/null || true
uv add pytest requests 2>/dev/null

# Wait for WordPress to be fully ready
echo "Waiting for WordPress to be ready..."
max_attempts=30
attempt=0
WP_URL="${WP_URL:-http://localhost}"

while [ $attempt -lt $max_attempts ]; do
    if curl -s -o /dev/null -w "%{http_code}" "${WP_URL}/wp-json/" | grep -q "200\|301\|302"; then
        echo "WordPress is ready!"
        break
    fi
    echo "Waiting for WordPress... (attempt $((attempt + 1))/$max_attempts)"
    sleep 2
    attempt=$((attempt + 1))
done

if [ $attempt -eq $max_attempts ]; then
    echo "Warning: WordPress may not be fully ready, proceeding anyway..."
fi

# Get API key if not provided
if [ -z "$API_KEY" ]; then
    echo "Attempting to retrieve API key from WordPress..."
    API_KEY=$(wp --path=/var/www/html option get iwc_api_key --allow-root 2>/dev/null || echo "")
    if [ -n "$API_KEY" ]; then
        export API_KEY
        echo "API key retrieved successfully."
    else
        echo "Warning: Could not retrieve API key. Tests may fail."
    fi
fi

# Run the tests
echo "Running tests..."
export WP_URL
uv run pytest . -rA -v
