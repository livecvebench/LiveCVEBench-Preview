FROM node:18-slim

WORKDIR /app

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y git tmux asciinema curl && rm -rf /var/lib/apt/lists/*

# Create application directory structure
RUN mkdir -p /app/toml

# Copy vulnerable source files from task-deps
COPY task-deps/parser_vulnerable.ts /app/toml/_parser.ts
COPY task-deps/parse.ts /app/toml/parse.ts

# Copy package.json for npm dependencies
COPY task-deps/package.json /app/package.json

# Configure npm for JSR registry and install dependencies
RUN npm config set @jsr:registry https://npm.jsr.io && npm install

# Transform Deno-style imports to npm-compatible imports
RUN sed -i 's|@std/collections/deep-merge|@jsr/std__collections/deep-merge|g' /app/toml/_parser.ts

# Compile TypeScript to CommonJS JavaScript using esbuild
RUN npx esbuild /app/toml/_parser.ts --bundle --platform=node --outfile=/app/toml/_parser.js --format=cjs && \
    npx esbuild /app/toml/parse.ts --bundle --platform=node --outfile=/app/toml/parse.js --format=cjs

# Keep container running
# CMD ["tail", "-f", "/dev/null"]
