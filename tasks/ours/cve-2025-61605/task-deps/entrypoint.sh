#!/bin/bash

# Initialize MariaDB data directory if needed
if [ ! -d "/var/lib/mysql/mysql" ]; then
    echo "Initializing MariaDB data directory..."
    mysql_install_db --user=mysql --datadir=/var/lib/mysql
fi

# Start MariaDB
echo "Starting MariaDB..."
service mariadb start

# Wait for MariaDB to be ready
echo "Waiting for MariaDB to start..."
for i in {1..30}; do
    if mysqladmin ping --silent 2>/dev/null; then
        echo "MariaDB is ready"
        break
    fi
    sleep 1
done

# Initialize database if not already done
if ! mariadb -e "USE wegia" 2>/dev/null; then
    echo "Setting up database..."

    # Create database
    mariadb -e "CREATE DATABASE IF NOT EXISTS wegia CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

    # Create wegia user with proper access
    mariadb -e "CREATE USER IF NOT EXISTS 'wegia'@'localhost' IDENTIFIED BY 'wegia_password';"
    mariadb -e "CREATE USER IF NOT EXISTS 'wegia'@'127.0.0.1' IDENTIFIED BY 'wegia_password';"
    mariadb -e "GRANT ALL PRIVILEGES ON wegia.* TO 'wegia'@'localhost';"
    mariadb -e "GRANT ALL PRIVILEGES ON wegia.* TO 'wegia'@'127.0.0.1';"
    mariadb -e "FLUSH PRIVILEGES;"

    # Import schema
    echo "Importing database schema..."
    mariadb wegia < /var/www/html/BD/wegia001.sql

    # Import initial data if exists
    if [ -f /var/www/html/BD/wegia002.sql ]; then
        echo "Importing initial data..."
        mariadb wegia < /var/www/html/BD/wegia002.sql
    fi

    # Create test pet data for testing the vulnerable endpoint
    echo "Creating test data..."
    mariadb wegia -e "
        INSERT IGNORE INTO pet_especie (id_pet_especie, descricao) VALUES (1, 'Dog');
        INSERT IGNORE INTO pet_raca (id_pet_raca, descricao) VALUES (1, 'Mixed');
        INSERT IGNORE INTO pet_cor (id_pet_cor, descricao) VALUES (1, 'Brown');
        INSERT IGNORE INTO pet (id_pet, nome, data_nascimento, data_acolhimento, sexo, id_pet_especie, id_pet_raca, id_pet_cor)
        VALUES (1, 'TestPet', '2023-01-01', '2023-06-01', 'M', 1, 1, 1);
    " 2>/dev/null || true

    echo "Database initialized"
else
    echo "Database already exists"
    # Ensure user exists anyway
    mariadb -e "CREATE USER IF NOT EXISTS 'wegia'@'localhost' IDENTIFIED BY 'wegia_password';" 2>/dev/null || true
    mariadb -e "CREATE USER IF NOT EXISTS 'wegia'@'127.0.0.1' IDENTIFIED BY 'wegia_password';" 2>/dev/null || true
    mariadb -e "GRANT ALL PRIVILEGES ON wegia.* TO 'wegia'@'localhost';" 2>/dev/null || true
    mariadb -e "GRANT ALL PRIVILEGES ON wegia.* TO 'wegia'@'127.0.0.1';" 2>/dev/null || true
    mariadb -e "FLUSH PRIVILEGES;" 2>/dev/null || true
fi

# Patch login.php to disable external version check (causes timeouts)
echo "Patching login.php to disable external version check..."
sed -i 's/file_get_contents("https:\/\/www.wegia.org\/software\/release")/0/g' /var/www/html/html/login.php

# Create .release file to prevent file_get_contents errors for local file
echo "1" > /var/www/html/.release

# Start Apache in foreground
echo "Starting Apache..."
exec apache2-foreground
