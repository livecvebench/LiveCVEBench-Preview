#!/usr/bin/env jruby
# CVE-2025-46551 PoC - Hostname verification bypass in jruby-openssl
#
# This script demonstrates the vulnerability where JRuby-OpenSSL fails to
# verify that the hostname in the SSL certificate matches the target hostname.
#
# In vulnerable versions (0.12.1 - 0.15.3), this script will succeed in
# connecting to bad.substitutealert.com which presents a certificate for s8a.me.
#
# In fixed version (0.15.4+), this will fail with hostname mismatch error.

require "net/http"
require "openssl"

# The bad.substitutealert.com domain presents a certificate for s8a.me
# This should FAIL with hostname mismatch but succeeds in vulnerable versions
uri = URI("https://bad.substitutealert.com/")
https = Net::HTTP.new(uri.host, uri.port)
https.use_ssl = true
https.verify_mode = OpenSSL::SSL::VERIFY_PEER

begin
  body = https.start { https.get(uri.request_uri).body }
  puts "VULNERABLE: Connection succeeded despite hostname mismatch!"
  puts "Response body: #{body[0..100]}..."
rescue OpenSSL::SSL::SSLError => e
  if e.message.include?("hostname") || e.message.include?("mismatch")
    puts "PATCHED: Correctly rejected connection with hostname mismatch"
  else
    puts "ERROR: #{e.message}"
  end
end
