FROM maven:3.9-eclipse-temurin-21

WORKDIR /app

# Copy Maven settings for proxy configuration (injected via build-args)
COPY task-deps/settings.xml /root/.m2/settings.xml

# System dependencies (tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Clone vulnerable version of Northstar
RUN git clone --depth 100 --branch v7.3.5 https://github.com/dromara/northstar.git . && \
    git checkout v7.3.5 && \
    rm -rf .git

# Build only backend modules (skip northstar-monitor frontend which has node-sass issues)
# The vulnerability is in the backend Java code, frontend is not needed
RUN mvn clean package -DskipTests -Dmaven.javadoc.skip=true -pl '!northstar-monitor'

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables for application
ENV env=dev
ENV NS_USER=admin
ENV NS_PWD=123456
ENV TZ=Asia/Shanghai


# Run with restart loop entrypoint
# CMD ["/entrypoint.sh"]
