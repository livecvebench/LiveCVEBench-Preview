"""
Functional tests for Fiber form data parsing.
These tests verify that normal form data parsing functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time


BASE_URL = "http://localhost:3000"
MAX_RETRIES = 10
RETRY_DELAY = 2


def wait_for_server():
    """Wait for the server to be available."""
    for i in range(MAX_RETRIES):
        try:
            response = requests.get(BASE_URL, timeout=5)
            # Server is running (any response is fine)
            return True
        except requests.exceptions.ConnectionError:
            if i < MAX_RETRIES - 1:
                time.sleep(RETRY_DELAY)
            continue
        except Exception:
            if i < MAX_RETRIES - 1:
                time.sleep(RETRY_DELAY)
            continue
    return False


class TestFunctionalFormParsing:
    """Test suite for normal form data parsing functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before each test."""
        assert wait_for_server(), "Server is not available"

    def test_basic_form_submission(self):
        """Test that basic form submission with single nested item works."""
        response = requests.post(
            f"{BASE_URL}/",
            data={"nested-content[0].value": "Hello"},
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        assert data["message"] == "Success"
        assert data["data"]["NestedContent"][0]["Value"] == "Hello"

    def test_multiple_nested_items(self):
        """Test form submission with multiple nested items."""
        response = requests.post(
            f"{BASE_URL}/",
            data={
                "nested-content[0].value": "First",
                "nested-content[1].value": "Second",
                "nested-content[2].value": "Third"
            },
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        assert data["message"] == "Success"
        assert len(data["data"]["NestedContent"]) >= 3
        assert data["data"]["NestedContent"][0]["Value"] == "First"
        assert data["data"]["NestedContent"][1]["Value"] == "Second"
        assert data["data"]["NestedContent"][2]["Value"] == "Third"

    def test_empty_form_data(self):
        """Test that empty form data is handled gracefully."""
        response = requests.post(
            f"{BASE_URL}/",
            data="",
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=10
        )

        # Should succeed with empty data
        assert response.status_code == 200

    def test_form_with_url_encoded_content_type(self):
        """Test form data with explicit URL-encoded content type."""
        response = requests.post(
            f"{BASE_URL}/",
            data={"nested-content[0].value": "Encoded"},
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        assert data["message"] == "Success"

    def test_form_with_special_characters(self):
        """Test form data with special characters in values."""
        special_value = "Hello<World>&Test\"Quote'"
        response = requests.post(
            f"{BASE_URL}/",
            data={"nested-content[0].value": special_value},
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        assert data["data"]["NestedContent"][0]["Value"] == special_value

    def test_large_index_number(self):
        """Test that reasonably large index numbers work correctly."""
        response = requests.post(
            f"{BASE_URL}/",
            data={"nested-content[5].value": "Index Five"},
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        # The slice should be created with enough space
        assert len(data["data"]["NestedContent"]) >= 6
        assert data["data"]["NestedContent"][5]["Value"] == "Index Five"

    def test_non_sequential_indices(self):
        """Test that non-sequential indices work correctly."""
        response = requests.post(
            f"{BASE_URL}/",
            data={
                "nested-content[0].value": "Zero",
                "nested-content[2].value": "Two"
            },
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        assert data["data"]["NestedContent"][0]["Value"] == "Zero"
        assert data["data"]["NestedContent"][2]["Value"] == "Two"

    def test_multipart_form_data(self):
        """Test form data with multipart/form-data encoding."""
        response = requests.post(
            f"{BASE_URL}/",
            files={"nested-content[0].value": (None, "Multipart")},
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        assert data["message"] == "Success"

    def test_server_responds_to_get(self):
        """Test that server is responsive to GET requests (Method Not Allowed expected)."""
        response = requests.get(f"{BASE_URL}/", timeout=10)

        # GET is not defined in our app, but server should respond
        # Fiber will return 405 Method Not Allowed
        assert response.status_code in [200, 404, 405]

    def test_server_remains_responsive(self):
        """Test that server remains responsive after multiple requests."""
        for i in range(5):
            response = requests.post(
                f"{BASE_URL}/",
                data={"nested-content[0].value": f"Request {i}"},
                timeout=10
            )
            assert response.status_code == 200
            time.sleep(0.5)

    def test_index_zero_works(self):
        """Test that index 0 works correctly (boundary case)."""
        response = requests.post(
            f"{BASE_URL}/",
            data={"nested-content[0].value": "Zero"},
            timeout=10
        )

        assert response.status_code == 200
        data = response.json()
        assert data["data"]["NestedContent"][0]["Value"] == "Zero"

    def test_index_max_int_handled(self):
        """Test that extremely large positive index is handled."""
        # This might cause memory issues, but shouldn't crash the server entirely
        try:
            response = requests.post(
                f"{BASE_URL}/",
                data={"nested-content[999999].value": "Large"},
                timeout=30
            )
            # Should either succeed or return meaningful error - not crash
            assert response.status_code in [200, 400, 422, 500, 503]
        except requests.exceptions.Timeout:
            # Timeout is acceptable for very large index
            pass
        except requests.exceptions.ConnectionError:
            # Server might refuse if index too large, but should recover
            time.sleep(3)
            # Re-check if server is still up
            try:
                check_response = requests.post(
                    f"{BASE_URL}/",
                    data={"nested-content[0].value": "HealthCheck"},
                    timeout=5
                )
                assert check_response.status_code == 200
            except:
                pytest.fail("Server crashed on very large index")
