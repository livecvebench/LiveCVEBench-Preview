#!/bin/bash
set -e

# Solution script for shiyi-blog arbitrary class instantiation vulnerability
# This fix adds:
# 1. A whitelist check before Class.forName() in JobInvokeUtil.java
# 2. A pre-validation check in JobServiceImpl.run() to block malicious targets BEFORE async execution

cd /app

JAVA_FILE="/app/src/main/java/com/shiyi/quartz/JobInvokeUtil.java"
SERVICE_FILE="/app/src/main/java/com/shiyi/service/impl/JobServiceImpl.java"

# Check if files exist
if [ ! -f "$JAVA_FILE" ]; then
    echo "ERROR: JobInvokeUtil.java not found at $JAVA_FILE"
    exit 1
fi

if [ ! -f "$SERVICE_FILE" ]; then
    echo "ERROR: JobServiceImpl.java not found at $SERVICE_FILE"
    exit 1
fi

echo "Applying security fix to JobInvokeUtil.java..."

# Create a backup
cp "$JAVA_FILE" "${JAVA_FILE}.bak"

# Create the fixed version of JobInvokeUtil.java
cat > "$JAVA_FILE" << 'ENDOFFILE'
package com.shiyi.quartz;

import com.shiyi.entity.Job;
import com.shiyi.util.SpringUtils;
import org.apache.commons.lang3.StringUtils;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;

/**
 * @author blue
 * @date 2021/12/8
 * @apiNote 任务执行工具
 */
public class JobInvokeUtil {

    // Whitelist of allowed task classes for security
    private static final Set<String> ALLOWED_CLASSES = new HashSet<>(Arrays.asList(
        "com.shiyi.task.BlogQuartz",
        "com.mojian.task.BlogQuartz"
    ));

    /**
     * Validate invokeTarget for security - public so it can be called from JobServiceImpl
     * @param invokeTarget the target string to validate
     * @throws SecurityException if the target class is not allowed
     */
    public static void validateInvokeTarget(String invokeTarget) {
        if (invokeTarget == null || invokeTarget.isEmpty()) {
            return;
        }
        String beanName = getBeanName(invokeTarget);
        if (isValidClassName(beanName)) {
            // This looks like a fully-qualified class name - check whitelist
            if (!ALLOWED_CLASSES.contains(beanName)) {
                throw new SecurityException("Unauthorized class instantiation not allowed: " + beanName);
            }
        }
    }

    /**
     * 执行方法
     *
     * @param job 系统任务
     */
    public static void invokeMethod(Job job) throws Exception
    {
        String invokeTarget = job.getInvokeTarget();
        String beanName = getBeanName(invokeTarget);
        String methodName = getMethodName(invokeTarget);
        List<Object[]> methodParams = getMethodParams(invokeTarget);

        if (!isValidClassName(beanName))
        {
            Object bean = SpringUtils.getBean(beanName);
            invokeMethod(bean, methodName, methodParams);
        }
        else
        {
            // Security check: only allow whitelisted classes to be instantiated
            if (!ALLOWED_CLASSES.contains(beanName)) {
                throw new SecurityException("Unauthorized class instantiation not allowed: " + beanName);
            }
            Object bean = Class.forName(beanName).newInstance();
            invokeMethod(bean, methodName, methodParams);
        }
    }

    /**
     * 调用任务方法
     *
     * @param bean 目标对象
     * @param methodName 方法名称
     * @param methodParams 方法参数
     */
    private static void invokeMethod(Object bean, String methodName, List<Object[]> methodParams)
            throws NoSuchMethodException, SecurityException, IllegalAccessException, IllegalArgumentException,
            InvocationTargetException
    {
        if (methodParams != null && methodParams.size() > 0)
        {
            Method method = bean.getClass().getDeclaredMethod(methodName, getMethodParamsType(methodParams));
            method.invoke(bean, getMethodParamsValue(methodParams));
        }
        else
        {
            Method method = bean.getClass().getDeclaredMethod(methodName);
            method.invoke(bean);
        }
    }

    /**
     * 校验是否为为class包名
     *
     * @return true是 false否
     */
    public static boolean isValidClassName(String invokeTarget)
    {
        return StringUtils.countMatches(invokeTarget, ".") > 1;
    }

    /**
     * 获取bean名称
     *
     * @param invokeTarget 目标字符串
     * @return bean名称
     */
    public static String getBeanName(String invokeTarget)
    {
        String beanName = StringUtils.substringBefore(invokeTarget, "(");
        return StringUtils.substringBeforeLast(beanName, ".");
    }

    /**
     * 获取bean方法
     *
     * @param invokeTarget 目标字符串
     * @return method方法
     */
    public static String getMethodName(String invokeTarget)
    {
        String methodName = StringUtils.substringBefore(invokeTarget, "(");
        return StringUtils.substringAfterLast(methodName, ".");
    }

    /**
     * 获取method方法参数相关列表
     *
     * @param invokeTarget 目标字符串
     * @return method方法相关参数列表
     */
    public static List<Object[]> getMethodParams(String invokeTarget)
    {
        String methodStr = StringUtils.substringBetween(invokeTarget, "(", ")");
        if (StringUtils.isEmpty(methodStr))
        {
            return null;
        }
        String[] methodParams = methodStr.split(",(?=(?:[^\']*\"[^\']*\')*[^\']*$)");
        List<Object[]> classs = new LinkedList<>();
        for (int i = 0; i < methodParams.length; i++)
        {
            String str = StringUtils.trimToEmpty(methodParams[i]);
            // String字符串类型，包含'
            if (StringUtils.contains(str, "'"))
            {
                classs.add(new Object[] { StringUtils.replace(str, "'", ""), String.class });
            }
            // boolean布尔类型，等于true或者false
            else if (StringUtils.equals(str, "true") || StringUtils.equalsIgnoreCase(str, "false"))
            {
                classs.add(new Object[] { Boolean.valueOf(str), Boolean.class });
            }
            // long长整形，包含L
            else if (StringUtils.containsIgnoreCase(str, "L"))
            {
                classs.add(new Object[] { Long.valueOf(StringUtils.replaceIgnoreCase(str, "L", "")), Long.class });
            }
            // double浮点类型，包含D
            else if (StringUtils.containsIgnoreCase(str, "D"))
            {
                classs.add(new Object[] { Double.valueOf(StringUtils.replaceIgnoreCase(str, "D", "")), Double.class });
            }
            // 其他类型归类为整形
            else
            {
                classs.add(new Object[] { Integer.valueOf(str), Integer.class });
            }
        }
        return classs;
    }

    /**
     * 获取参数类型
     *
     * @param methodParams 参数相关列表
     * @return 参数类型列表
     */
    public static Class<?>[] getMethodParamsType(List<Object[]> methodParams)
    {
        Class<?>[] classs = new Class<?>[methodParams.size()];
        int index = 0;
        for (Object[] os : methodParams)
        {
            classs[index] = (Class<?>) os[1];
            index++;
        }
        return classs;
    }

    /**
     * 获取参数值
     *
     * @param methodParams 参数相关列表
     * @return 参数值列表
     */
    public static Object[] getMethodParamsValue(List<Object[]> methodParams)
    {
        Object[] classs = new Object[methodParams.size()];
        int index = 0;
        for (Object[] os : methodParams)
        {
            classs[index] = (Object) os[0];
            index++;
        }
        return classs;
    }
}
ENDOFFILE

echo "Patching JobServiceImpl.java to add pre-validation..."

# Create a backup
cp "$SERVICE_FILE" "${SERVICE_FILE}.bak"

# Use sed to patch - check if already patched first
if ! grep -q "validateInvokeTarget" "$SERVICE_FILE"; then
    # Insert the validation call after "public ResponseResult run(Job job) {"
    sed -i '/public ResponseResult run(Job job) {/a\        // Security: Pre-validate invokeTarget before scheduling\n        if (job.getInvokeTarget() != null) {\n            com.shiyi.quartz.JobInvokeUtil.validateInvokeTarget(job.getInvokeTarget());\n        }' "$SERVICE_FILE"
    echo "JobServiceImpl.java patched successfully"
else
    echo "JobServiceImpl.java already patched"
fi

echo "Security fix applied successfully!"

# The application is a Spring Boot Java app - need to rebuild and restart
echo "Rebuilding application JAR..."
cd /app

# Use mvn package - dependencies are already downloaded
mvn package -DskipTests -q 2>&1

# Check if build was successful
if [ -f /app/target/shiyi-blog.jar ]; then
    echo "Build successful. Replacing old JAR..."
    cp /app/target/shiyi-blog.jar /app/shiyi-blog.jar
    echo "JAR replaced."
else
    echo "ERROR: Build failed or JAR not found."
    ls -la /app/target/ 2>/dev/null || echo "No target directory"
    exit 1
fi

# Kill the Java process so it can be restarted by the entrypoint
echo "Restarting application..."
pkill -f "java -jar" 2>/dev/null || true

# Brief wait for old process to terminate
sleep 2

# Wait for the application to come back up with shorter timeout
echo "Waiting for application to restart..."
MAX_WAIT=60
WAITED=0
while [ $WAITED -lt $MAX_WAIT ]; do
    # Check if the health endpoint responds
    if curl -s -o /dev/null -w "%{http_code}" http://localhost:8800/shiyi/ 2>/dev/null | grep -qE "200|302|405|500"; then
        echo "Application is ready! (after $WAITED seconds)"
        break
    fi
    sleep 2
    WAITED=$((WAITED + 2))
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo "WARNING: Timeout waiting for application, but fix has been applied"
fi

# Small stabilization delay
sleep 3

echo "Fix complete."
