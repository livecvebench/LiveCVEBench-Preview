#!/usr/bin/env python3
"""
Functional tests for Open5GS SMF NGAP handler - PathSwitchRequest processing.

These tests verify that the SMF's NGAP handler functions correctly after the fix.
They should PASS in both vulnerable and fixed states (functionality tests).
"""

import subprocess
import os
import re
import time
import pytest


class TestSMFBuildAndFunctionality:
    """Tests that verify SMF builds correctly and basic functionality works."""

    def test_source_code_exists(self):
        """Verify the NGAP handler source file exists."""
        ngap_handler = "/app/src/smf/ngap-handler.c"
        assert os.path.exists(ngap_handler), f"Missing source file: {ngap_handler}"

    def test_ngap_handler_function_exists(self):
        """Verify the ngap_handle_path_switch_request_transfer function exists in source."""
        ngap_handler = "/app/src/smf/ngap-handler.c"
        with open(ngap_handler, 'r') as f:
            content = f.read()

        # Function declaration should exist
        assert "ngap_handle_path_switch_request_transfer" in content, \
            "Function ngap_handle_path_switch_request_transfer not found in source"

    def test_smf_binary_exists(self):
        """Verify the SMF binary is compiled and available."""
        smf_binary = "/app/install/bin/open5gs-smfd"
        assert os.path.exists(smf_binary), f"SMF binary not found: {smf_binary}"
        assert os.access(smf_binary, os.X_OK), f"SMF binary not executable: {smf_binary}"

    def test_amf_binary_exists(self):
        """Verify the AMF binary is compiled and available."""
        amf_binary = "/app/install/bin/open5gs-amfd"
        assert os.path.exists(amf_binary), f"AMF binary not found: {amf_binary}"
        assert os.access(amf_binary, os.X_OK), f"AMF binary not executable: {amf_binary}"

    def test_smf_builds_without_errors(self):
        """Verify that SMF can be rebuilt after any modifications."""
        # Run ninja to rebuild - this catches any syntax errors from fixes
        result = subprocess.run(
            ["ninja", "-C", "/app/build", "src/smf/libsmf.a"],
            capture_output=True,
            text=True,
            timeout=120
        )

        # If already up to date, or builds successfully, that's fine
        if result.returncode != 0:
            # Check if it's just "no work to do" message
            if "no work to do" not in result.stdout.lower() and "ninja: no work to do" not in result.stderr.lower():
                pytest.fail(f"SMF build failed: {result.stderr}\n{result.stdout}")

    def test_ngap_handler_has_path_switch_logic(self):
        """Verify path switch request handling logic exists."""
        ngap_handler = "/app/src/smf/ngap-handler.c"
        with open(ngap_handler, 'r') as f:
            content = f.read()

        # Check for key path switch handling components
        assert "far_update" in content, "far_update variable should exist in path switch handler"
        assert "gnb_n3_ip" in content, "gNB N3 IP handling should exist"
        assert "gnb_n3_teid" in content, "gNB N3 TEID handling should exist"

    def test_mongodb_running(self):
        """Verify MongoDB is running (required for Open5GS)."""
        result = subprocess.run(
            ["pgrep", "-x", "mongod"],
            capture_output=True,
            text=True
        )
        # MongoDB might not be running in test environment, which is OK
        # This is more of a health check
        if result.returncode != 0:
            pytest.skip("MongoDB not running - skipping MongoDB-dependent tests")


class TestNRFandSBIServices:
    """Tests for NRF and SBI-based services that don't require SCTP."""

    def test_nrf_binary_exists(self):
        """Verify NRF binary exists."""
        nrf_binary = "/app/install/bin/open5gs-nrfd"
        assert os.path.exists(nrf_binary), f"NRF binary not found: {nrf_binary}"

    def test_config_files_exist(self):
        """Verify configuration files are present."""
        configs = [
            "/app/install/etc/open5gs/smf.yaml",
            "/app/install/etc/open5gs/amf.yaml",
            "/app/install/etc/open5gs/nrf.yaml",
        ]
        for config in configs:
            assert os.path.exists(config), f"Config file missing: {config}"


class TestCodeIntegrity:
    """Tests that verify the code maintains correct structure."""

    def test_ngap_handler_has_required_includes(self):
        """Verify required header includes exist."""
        ngap_handler = "/app/src/smf/ngap-handler.c"
        with open(ngap_handler, 'r') as f:
            content = f.read()

        # Check for essential includes
        assert '#include "ngap-handler.h"' in content or '#include "context.h"' in content, \
            "Expected include directives not found"

    def test_ngap_build_function_exists(self):
        """Verify the ngap_build_path_switch_request_ack_transfer function is available."""
        # This function is needed for the fix
        ngap_build = "/app/src/smf/ngap-build.c"
        if os.path.exists(ngap_build):
            with open(ngap_build, 'r') as f:
                content = f.read()
            assert "ngap_build_path_switch_request_ack_transfer" in content, \
                "Required function ngap_build_path_switch_request_ack_transfer not found in ngap-build.c"

    def test_sbi_send_function_exists(self):
        """Verify the SBI send function for N2 buffer is available."""
        # The fix uses smf_sbi_send_sm_context_updated_data_n2smbuf
        sbi_handler = "/app/src/smf/sbi-path.c"
        if os.path.exists(sbi_handler):
            with open(sbi_handler, 'r') as f:
                content = f.read()
            # This function should exist for proper N2 signaling
            assert "smf_sbi_send_sm_context_updated_data" in content, \
                "SBI send function for N2 signaling not found"


class TestOpenAPITypes:
    """Tests that verify OpenAPI types are properly defined."""

    def test_path_switch_req_ack_type_exists(self):
        """Verify the PATH_SWITCH_REQ_ACK type is available in OpenAPI."""
        # Search for the OpenAPI type definition
        result = subprocess.run(
            ["grep", "-r", "PATH_SWITCH_REQ_ACK", "/app/lib/sbi/openapi/"],
            capture_output=True,
            text=True
        )
        assert result.returncode == 0 or "PATH_SWITCH_REQ_ACK" in result.stdout, \
            "OpenAPI_n2_sm_info_type_PATH_SWITCH_REQ_ACK type should be defined"
