#!/bin/bash
set -e

echo "=== HAXcms Shell Escaping Tests ==="
echo

cd "$(dirname "$0")"

# Function to run pytest with fallback
run_pytest() {
    if command -v uv &> /dev/null; then
        uv run pytest "$@"
    elif command -v python3 &> /dev/null; then
        python3 -m pytest "$@"
    elif command -v python &> /dev/null; then
        python -m pytest "$@"
    else
        echo "ERROR: No python or uv found"
        exit 1
    fi
}

# Install test dependencies
echo "Installing test dependencies..."
if command -v uv &> /dev/null; then
    # Use uv if available
    if [ -f "$HOME/.local/bin/env" ]; then
        . "$HOME/.local/bin/env"
    fi
    uv init 2>/dev/null || true
    uv add pytest requests 2>/dev/null || true
elif command -v pip &> /dev/null; then
    pip install -q pytest requests 2>/dev/null || pip install --break-system-packages -q pytest requests 2>/dev/null || true
elif command -v pip3 &> /dev/null; then
    pip3 install -q pytest requests 2>/dev/null || pip3 install --break-system-packages -q pytest requests 2>/dev/null || true
fi

# Wait for HAXcms application to be ready
echo "Waiting for HAXcms to be ready..."
MAX_ATTEMPTS=90
ATTEMPT=0
READY=0

while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
    if curl -s --connect-timeout 2 http://localhost/ > /dev/null 2>&1; then
        echo ""
        echo "HAXcms is ready!"
        READY=1
        break
    fi
    sleep 1
    ((ATTEMPT++))
done

if [ $READY -eq 0 ]; then
    echo ""
    echo "ERROR: HAXcms failed to start after ${MAX_ATTEMPTS} seconds"
    echo "Debug - Apache status:"
    ps aux | grep apache || true
    echo "Debug - Curl attempt:"
    curl -v http://localhost/ 2>&1 | head -20 || true
    exit 1
fi

echo ""

# Run all tests together with -rA for summary
echo "=== Running All Tests ==="
run_pytest test_func.py test_vuln.py -rA --tb=no 2>&1 || true

echo ""
echo "=== All tests completed ==="
