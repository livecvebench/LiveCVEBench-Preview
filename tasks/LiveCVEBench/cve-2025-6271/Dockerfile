FROM debian:bullseye

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies and required tools with retry
RUN apt-get update && \
    apt-get install -y -o Acquire::Retries=5 -o Acquire::http::Timeout="60" \
    build-essential \
    autoconf \
    automake \
    libtool \
    zlib1g-dev \
    libjpeg-dev \
    libfreetype6-dev \
    git \
    tmux \
    asciinema \
    curl \
    python3 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Clone swftools repository and checkout vulnerable commit
RUN git clone https://github.com/swftools/swftools.git && \
    cd swftools && \
    git checkout 5c6a4570 && \
    rm -rf .git

# Build swftools
WORKDIR /app/swftools

# Fix the linker issue: the inline bitpressure_strategy1 function needs to be non-inline
# to be visible to the linker when called from other translation units
RUN sed -i 's/^inline$//' lib/lame/quantize.c && \
    sed -i 's/^inline void bitpressure_strategy1/void bitpressure_strategy1/' lib/lame/quantize.c

# Configure and build only the libraries needed for wav2swf
RUN ./configure && \
    make -C lib libbase.a libgfx.a libgfxswf.a librfxswf.a && \
    make -C src wav2swf

WORKDIR /app

# Copy test data
COPY task-deps/malicious.wav /app/task-deps/malicious.wav

# Keep container running with bash
CMD ["/bin/bash"]
