FROM debian:bookworm

WORKDIR /app

# System dependencies - build tools, test utilities, and required packages
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    make \
    libc6-dev \
    git \
    patch \
    redis-tools \
    python3 \
    python3-pip \
    tmux \
    asciinema \
    curl \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Clone Redis 7.2.0 (vulnerable version) and remove git history
WORKDIR /
RUN git clone --branch 7.2.0 --depth 1 https://github.com/redis/redis.git /redis && \
    rm -rf /redis/.git

# Build Redis
WORKDIR /redis
RUN make -j$(nproc)

# Install Redis binaries to /usr/local/bin
RUN make install

# Copy task-deps files into container
COPY task-deps/ /task-deps/

# Create config directory and copy configuration file
RUN mkdir -p /etc/redis && cp /task-deps/redis.conf /etc/redis/redis.conf

# Install Python dependencies for tests
RUN pip3 install redis pytest --break-system-packages

# Make entrypoint executable
RUN chmod +x /task-deps/entrypoint.sh

# Create workspace directory
RUN mkdir -p /workspace


WORKDIR /workspace

# Use entrypoint script for restart capability
# CMD ["/task-deps/entrypoint.sh"]
