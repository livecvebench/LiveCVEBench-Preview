"""
Vulnerability tests for Student File Management System
These tests verify that SQL injection is properly mitigated.
- FAIL in vulnerable state (SQL injection works)
- PASS in fixed state (SQL injection blocked)
"""

import requests
import time

BASE_URL = "http://localhost/SFMS"


class TestTimeBased:
    """Time-based SQL injection tests - the most reliable method for detecting SQLi in UPDATE endpoints"""

    def test_sleep_injection_stud_id(self):
        """
        Test time-based SQL injection via SLEEP() in stud_id parameter.
        Vulnerable: Response delayed by ~3 seconds
        Fixed: Response returns immediately
        """
        payload = {
            'stud_id': "1' AND SLEEP(3) AND '1'='1",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        # After fix, SLEEP should not be executed - response under 2 seconds
        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - SQL injection vulnerability detected! "
            f"The SLEEP(3) payload was executed."
        )

    def test_sleep_injection_longer_delay(self):
        """
        Test with longer SLEEP to confirm vulnerability detection.
        """
        payload = {
            'stud_id': "1' AND SLEEP(5) AND '1'='1",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - SQL injection vulnerability detected! "
            f"The SLEEP(5) payload was executed."
        )

    def test_conditional_sleep_injection(self):
        """
        Test conditional SLEEP injection using IF().
        """
        payload = {
            'stud_id': "1' AND IF(1=1,SLEEP(3),0) AND '1'='1",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - Conditional SLEEP injection detected!"
        )

    def test_sleep_with_comment_bypass(self):
        """
        Test SLEEP injection with comment to truncate query.
        """
        payload = {
            'stud_id': "1' AND SLEEP(3)-- -",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - SLEEP with comment injection detected!"
        )

    def test_sleep_with_hash_comment(self):
        """
        Test SLEEP injection with # comment style.
        """
        payload = {
            'stud_id': "1' AND SLEEP(3)#",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - SLEEP with # comment injection detected!"
        )

    def test_sleep_concatenation(self):
        """
        Test SLEEP using string concatenation variation.
        """
        payload = {
            'stud_id': "1' AND SLEEP/**/(3) AND '1'='1",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - SLEEP with comment bypass detected!"
        )

    def test_case_when_sleep(self):
        """
        Test SLEEP inside CASE WHEN construct.
        """
        payload = {
            'stud_id': "1' AND CASE WHEN 1=1 THEN SLEEP(3) ELSE 0 END AND '1'='1",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - CASE WHEN SLEEP injection detected!"
        )

    def test_nested_sleep(self):
        """
        Test nested conditional SLEEP.
        """
        payload = {
            'stud_id': "1' AND (SELECT SLEEP(3)) AND '1'='1",
            'stud_no': '12345',
            'firstname': 'Test',
            'lastname': 'User',
            'gender': 'Male',
            'year': '1',
            'section': 'A',
            'password': 'test',
            'update': ''
        }

        start = time.time()
        response = requests.post(
            f"{BASE_URL}/admin/update_student.php",
            data=payload,
            timeout=15
        )
        elapsed = time.time() - start

        assert elapsed < 2.0, (
            f"Response took {elapsed:.2f}s - Nested SELECT SLEEP injection detected!"
        )
