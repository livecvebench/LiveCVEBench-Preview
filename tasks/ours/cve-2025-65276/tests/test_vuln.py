"""
Vulnerability tests for HashTech admin access control.

These tests verify that unauthenticated users cannot access admin pages.
They should FAIL in the vulnerable state (pages are accessible without auth)
and PASS in the fixed state (pages redirect to login or block access).
"""

import pytest
import requests
import time

BASE_URL = "http://localhost:80"

# Content markers that indicate admin page is being shown
ADMIN_CONTENT_MARKERS = [
    "Hi admin, welcome",
    "Admin Management",
    "All Gadgets",
    "User Accounts",
    "welcome to your admin account",
]

# Sensitive data markers in user list
USER_LIST_MARKERS = [
    "User Account List",
    "User Email Address",
    "@gmail.com",
    "Phone Number",
]

# Gadget list markers
GADGET_LIST_MARKERS = [
    "Gadget List",
    "Gadget Model",
    "Gadget Price",
    "ASUS TUF",
    "Google Pixel",
]


def wait_for_server(max_retries=5, delay=2):
    """Wait for the server to become available."""
    for i in range(max_retries):
        try:
            requests.get(f"{BASE_URL}/", timeout=5)
            return True
        except requests.exceptions.ConnectionError:
            if i < max_retries - 1:
                time.sleep(delay)
    return False


class TestAdminDashboardAccess:
    """Test unauthenticated access to admin dashboard."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server not available"

    def test_admin_index_requires_auth(self):
        """Test that admin_index.php requires authentication."""
        # Make request WITHOUT any session/cookies
        response = requests.get(
            f"{BASE_URL}/admin_index.php",
            allow_redirects=False,
            timeout=10
        )

        # VULNERABLE if: Status 200 with admin content
        if response.status_code == 200:
            content = response.text.lower()
            for marker in ADMIN_CONTENT_MARKERS:
                if marker.lower() in content:
                    pytest.fail(
                        f"VULNERABLE: Admin dashboard accessible without authentication. "
                        f"Found marker: '{marker}'"
                    )

        # FIXED if: 302 redirect (to login page)
        # Also acceptable: 200 but with login form content instead of admin content

    def test_admin_index_redirects_to_login(self):
        """Test that unauthenticated access redirects to login."""
        response = requests.get(
            f"{BASE_URL}/admin_index.php",
            allow_redirects=False,
            timeout=10
        )

        # Should redirect to login page
        if response.status_code == 302:
            location = response.headers.get('Location', '')
            assert 'login' in location.lower(), \
                f"Redirect should be to login page, got: {location}"
        elif response.status_code == 200:
            # If 200, make sure it's NOT showing admin content
            content = response.text.lower()
            for marker in ADMIN_CONTENT_MARKERS:
                if marker.lower() in content:
                    pytest.fail(
                        f"VULNERABLE: Admin content shown without authentication. "
                        f"Found: '{marker}'"
                    )

    def test_admin_index_no_menu_without_auth(self):
        """Test that admin navigation menu is not shown without auth."""
        response = requests.get(
            f"{BASE_URL}/admin_index.php",
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            # Check for admin menu items
            admin_menu_items = [
                "All Gadgets",
                "Add Gadget",
                "Edit Gadget",
                "User Accounts",
                "All Orders",
            ]
            content = response.text
            for item in admin_menu_items:
                if item in content:
                    pytest.fail(
                        f"VULNERABLE: Admin menu visible without authentication. "
                        f"Found menu item: '{item}'"
                    )


class TestUserListAccess:
    """Test unauthenticated access to user list (contains PII)."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server not available"

    def test_user_list_requires_auth(self):
        """Test that user_list.php requires authentication."""
        response = requests.get(
            f"{BASE_URL}/user_list.php",
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            content = response.text
            for marker in USER_LIST_MARKERS:
                if marker in content:
                    pytest.fail(
                        f"VULNERABLE: User list with PII accessible without auth. "
                        f"Found: '{marker}'"
                    )

    def test_user_list_no_email_exposure(self):
        """Test that user email addresses are not exposed without auth."""
        response = requests.get(
            f"{BASE_URL}/user_list.php",
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            # Check for actual email addresses from the database
            exposed_emails = [
                "lawjunwei@gmail.com",
                "henrylawjunwei@gmail.com",
                "hanisshamimi252@gmail.com",
            ]
            for email in exposed_emails:
                if email in response.text:
                    pytest.fail(
                        f"VULNERABLE: User email exposed without authentication: {email}"
                    )

    def test_user_list_no_pii_exposure(self):
        """Test that user personal information is not exposed."""
        response = requests.get(
            f"{BASE_URL}/user_list.php",
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            # Check for personal data patterns
            pii_markers = [
                "0172482672",  # Phone number from database
                "persiaran multimedia",  # Address from database
                "cyberjaya",  # City from database
            ]
            for marker in pii_markers:
                if marker in response.text:
                    pytest.fail(
                        f"VULNERABLE: User PII exposed without authentication: {marker}"
                    )


class TestGadgetListAccess:
    """Test unauthenticated access to gadget management."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server not available"

    def test_gadget_list_requires_auth(self):
        """Test that gadget_list.php requires authentication."""
        response = requests.get(
            f"{BASE_URL}/gadget_list.php",
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            # Check for admin functionality markers
            admin_func_markers = [
                "Edit</a>",  # Edit link
                "Delete</a>",  # Delete link
                "Admin Management",
            ]
            for marker in admin_func_markers:
                if marker in response.text:
                    pytest.fail(
                        f"VULNERABLE: Admin gadget management accessible without auth. "
                        f"Found: '{marker}'"
                    )

    def test_gadget_list_no_admin_actions(self):
        """Test that admin action links are not shown without auth."""
        response = requests.get(
            f"{BASE_URL}/gadget_list.php",
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            # Look for action links that should only be visible to admins
            if "gadget_edit.php" in response.text and "gadget_list_delete.php" in response.text:
                # Both edit and delete links present - definitely vulnerable
                pytest.fail(
                    "VULNERABLE: Admin edit/delete links accessible without authentication"
                )


class TestMultipleEndpoints:
    """Test access control across multiple admin endpoints."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server not available"

    @pytest.mark.parametrize("endpoint", [
        "admin_index.php",
        "user_list.php",
        "gadget_list.php",
    ])
    def test_endpoint_not_accessible_without_auth(self, endpoint):
        """Test that admin endpoints are protected."""
        response = requests.get(
            f"{BASE_URL}/{endpoint}",
            allow_redirects=False,
            timeout=10
        )

        # Expected: 302 redirect OR 200 without admin content
        if response.status_code == 302:
            # Good - redirecting (hopefully to login)
            pass
        elif response.status_code == 200:
            # Check that admin navigation is not shown
            if "Admin Management" in response.text and "sidenav" in response.text:
                pytest.fail(
                    f"VULNERABLE: {endpoint} shows admin navigation without auth"
                )


class TestSessionBypass:
    """Test various session bypass attempts."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Ensure server is available before tests."""
        assert wait_for_server(), "Server not available"

    def test_empty_session_cookie(self):
        """Test that empty session cookie doesn't grant access."""
        response = requests.get(
            f"{BASE_URL}/admin_index.php",
            cookies={"PHPSESSID": ""},
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            if "Hi admin, welcome" in response.text:
                pytest.fail(
                    "VULNERABLE: Admin access granted with empty session"
                )

    def test_random_session_cookie(self):
        """Test that random session ID doesn't grant access."""
        response = requests.get(
            f"{BASE_URL}/admin_index.php",
            cookies={"PHPSESSID": "fake_session_12345"},
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            if "Hi admin, welcome" in response.text:
                pytest.fail(
                    "VULNERABLE: Admin access granted with fake session"
                )

    def test_no_cookies_at_all(self):
        """Test that requests without any cookies are blocked."""
        session = requests.Session()
        session.cookies.clear()

        response = session.get(
            f"{BASE_URL}/admin_index.php",
            allow_redirects=False,
            timeout=10
        )

        if response.status_code == 200:
            for marker in ADMIN_CONTENT_MARKERS:
                if marker.lower() in response.text.lower():
                    pytest.fail(
                        f"VULNERABLE: Admin access without cookies. Found: '{marker}'"
                    )
