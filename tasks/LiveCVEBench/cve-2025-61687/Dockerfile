# CVE-2025-61687: FlowiseAI Flowise Unrestricted File Upload Vulnerability
# Build from vulnerable commit flowise@2.2.7 (before the fix in c2b830f2)
FROM node:20-alpine

# Install system dependencies
RUN apk add --no-cache tmux asciinema gcc g++ wget curl git python3 py3-pip make bash coreutils && \
    pip3 install --break-system-packages --no-cache-dir pytest requests && \
    python3 -c "import pytest; print('pytest ready')"

# Set working directory
WORKDIR /app

# Clone Flowise at the vulnerable version 2.2.7
# The fix was in c2b830f2 which was released in 2.2.7-patch.1 and 3.0.0+
RUN git clone https://github.com/FlowiseAI/Flowise.git /app && \
    git checkout flowise@2.2.7

# Install pnpm globally
RUN npm install -g pnpm@9

# Install dependencies
RUN pnpm install

# Build the packages
RUN pnpm build

# Environment variables for vulnerability reproduction
ENV FLOWISE_HOST=0.0.0.0
ENV FLOWISE_PORT=3000
ENV STORAGE_TYPE=local
ENV NODE_ENV=production
# Disable authentication for easier testing
ENV FLOWISE_USERNAME=
ENV FLOWISE_PASSWORD=
ENV DATABASE_PATH=/root/.flowise
ENV SECRETKEY_PATH=/root/.flowise

# Ensure storage directory exists with proper permissions
RUN mkdir -p /root/.flowise/storage && chmod -R 755 /root/.flowise

# Copy entrypoint script for service restart capability
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 3000

# Health check (commented out - handled by docker-compose)
# HEALTHCHECK --interval=30s --timeout=10s --start-period=180s --retries=5 \
#   CMD wget -q --spider http://localhost:3000/api/v1/ping || exit 1

# Start Flowise via entrypoint for restart capability
# ENTRYPOINT []
# CMD ["/entrypoint.sh"]
