#!/bin/bash
set -e
cd "$(dirname "$0")"

echo "=== Setting up test environment ==="

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
    source $HOME/.local/bin/env
fi

# Initialize project and add dependencies
echo "Installing test dependencies..."
uv init 2>/dev/null || true
uv add pytest 2>/dev/null

# Wait for Apache to be ready
echo "Waiting for Apache server to be ready..."
max_attempts=30
attempt=0
while ! nc -z localhost 80 2>/dev/null; do
    attempt=$((attempt + 1))
    if [ $attempt -ge $max_attempts ]; then
        echo "ERROR: Apache server not responding on port 80 after ${max_attempts} attempts"
        exit 1
    fi
    echo "  Attempt $attempt/$max_attempts - waiting..."
    sleep 1
done
echo "Apache server is ready!"

# Run all tests together so pytest outputs a single combined summary
echo ""
echo "=== Running all tests ==="
uv run pytest test_func.py test_vuln.py -rA --tb=short
TEST_EXIT=$?

echo ""
echo "=== Test Summary ==="
echo "Combined tests exit code: $TEST_EXIT"

exit $TEST_EXIT
