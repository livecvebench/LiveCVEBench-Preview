#!/bin/bash
set -e

cd /app

# The actual fix needs to be in solid-js/web/dist/server.js
# because that's where the ssr() function is defined and where
# user content is rendered without escaping

WEB_SERVER_FILE="node_modules/solid-js/web/dist/server.js"

if [ ! -f "$WEB_SERVER_FILE" ]; then
    echo "Error: Could not find solid-js web server file at $WEB_SERVER_FILE"
    exit 1
fi

echo "Patching file: $WEB_SERVER_FILE"

# Create backup
cp "$WEB_SERVER_FILE" "${WEB_SERVER_FILE}.bak"

# Use Node.js to patch the file - more reliable than sed with complex patterns
node << 'EOF'
const fs = require('fs');

const filePath = 'node_modules/solid-js/web/dist/server.js';
let content = fs.readFileSync(filePath, 'utf8');

// Check if already patched (look for our specific fix marker)
if (content.includes('// CVE-2025-27109')) {
    console.log('File already patched, skipping...');
    process.exit(0);
}

// Fix 1: Main ssr() function - wrap resolveSSRNode(node) with escape()
// This is where user content is rendered to HTML templates
// Pattern: if (node !== undefined) result += resolveSSRNode(node);
const originalSsrLine = 'if (node !== undefined) result += resolveSSRNode(node);';
const fixedSsrLine = 'if (node !== undefined) result += resolveSSRNode(escape(node)); // CVE-2025-27109';
if (content.includes(originalSsrLine)) {
    content = content.replace(originalSsrLine, fixedSsrLine);
    console.log('Fixed ssr() function - wrapped node with escape()');
} else {
    console.log('Warning: Could not find ssr() pattern to fix');
}

// Write the patched file
fs.writeFileSync(filePath, content);
console.log('Successfully wrote patched file');
EOF

echo ""
echo "Verifying changes..."

# Check if fix was applied
if grep -q "CVE-2025-27109" "$WEB_SERVER_FILE"; then
    echo "✓ ssr() function patched successfully"
else
    echo "✗ Warning: ssr() function patch may not have been applied"
    grep -n "resolveSSRNode(node)" "$WEB_SERVER_FILE" || true
fi

# Restart the server so the fix takes effect
echo ""
echo "Restarting server to apply changes..."
pkill -f "node.*server" || true
sleep 2

echo "Fix applied successfully"
