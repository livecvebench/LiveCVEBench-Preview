#!/bin/bash
set -e
cd "$(dirname "$0")"

# Wait for Craft CMS to be fully ready
echo "Waiting for Craft CMS to be ready..."
for i in {1..60}; do
    # Check if we get a response from Craft (not just Apache)
    response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/admin/login 2>/dev/null || echo "000")
    if [ "$response" = "200" ] || [ "$response" = "302" ]; then
        echo "Craft CMS is ready (HTTP $response)"
        break
    fi
    if [ $i -eq 60 ]; then
        echo "Timeout waiting for Craft CMS"
        echo "Last response code: $response"
        exit 1
    fi
    echo "Waiting... (attempt $i, HTTP $response)"
    sleep 2
done

# Install uv for isolated Python environment
curl -LsSf https://astral.sh/uv/0.7.13/install.sh | sh 2>/dev/null
source $HOME/.local/bin/env
uv init 2>/dev/null || true
uv add pytest requests 2>/dev/null

# Run the tests
uv run pytest . -rA
