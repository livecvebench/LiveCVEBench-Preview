FROM denoland/deno:debian-2.1.4

WORKDIR /app

# System dependencies (git for cloning, tmux and asciinema as required)
RUN apt-get update && apt-get install -y git tmux asciinema curl wget gcc g++ && rm -rf /var/lib/apt/lists/*

# Clone vulnerable version of oak and remove git history
RUN git clone --depth 1 --branch v17.1.5 https://github.com/oakserver/oak.git . && rm -rf .git

# Copy the test server entry point
COPY task-deps/server.ts /app/server.ts

# Copy the entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Cache dependencies for faster startup
RUN deno cache mod.ts server.ts


# Run the server via entrypoint for restart capability
RUN mkdir -p /tests /oracle
# CMD ["/entrypoint.sh"]
