-- Database initialization for CVE-2025-12967 (PostgreSQL search_path hijacking)
-- This script sets up users and schema for demonstrating the vulnerability

-- Ensure public schema exists with default search_path behavior
-- The default search_path is: "$user", public

-- Create attacker user (low privilege but can create objects in public)
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'attacker') THEN
        CREATE USER attacker WITH PASSWORD 'attacker123';
    END IF;
END
$$;

-- Create victim user (higher privileges - simulates admin/application user)
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'victim') THEN
        CREATE USER victim WITH PASSWORD 'victim123' SUPERUSER;
    END IF;
END
$$;

-- Set victim's search_path to prioritize public schema before pg_catalog
-- This makes the user vulnerable to search_path hijacking attacks
-- (Without this, pg_catalog is implicitly searched first)
ALTER USER victim SET search_path TO public, pg_catalog;

-- Grant attacker ability to create in public schema
GRANT USAGE ON SCHEMA public TO attacker;
GRANT CREATE ON SCHEMA public TO attacker;

-- Grant victim access to public schema
GRANT USAGE ON SCHEMA public TO victim;

-- Create an attack tracking table (matching test_vuln.py expected schema)
CREATE TABLE IF NOT EXISTS public.attack_log (
    id SERIAL PRIMARY KEY,
    function_name TEXT,
    caller_user TEXT,
    attack_time TIMESTAMP DEFAULT NOW()
);

-- Allow all users to insert into attack_log
GRANT ALL ON public.attack_log TO PUBLIC;
GRANT USAGE, SELECT ON SEQUENCE public.attack_log_id_seq TO PUBLIC;

-- Create a test table to verify database is working
CREATE TABLE IF NOT EXISTS public.test_table (
    id SERIAL PRIMARY KEY,
    name TEXT
);
INSERT INTO public.test_table (name) VALUES ('test');

-- Verify search_path is set correctly (should show "$user", public)
-- SELECT current_setting('search_path');
