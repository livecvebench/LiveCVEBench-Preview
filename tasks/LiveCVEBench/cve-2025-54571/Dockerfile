FROM debian:bullseye

WORKDIR /app

# Apache environment variables
ENV APACHE_RUN_USER=www-data
ENV APACHE_RUN_GROUP=www-data
ENV APACHE_LOG_DIR=/var/log/apache2
ENV APACHE_PID_FILE=/var/run/apache2/apache2.pid

# Install build and runtime dependencies
RUN apt-get update && \
    apt-get install -y \
        apache2 \
        apache2-dev \
        build-essential \
        autoconf \
        automake \
        libtool \
        libpcre3-dev \
        libxml2-dev \
        libcurl4-openssl-dev \
        liblua5.3-dev \
        libyajl-dev \
        pkg-config \
        git \
        wget \
        curl \
        netcat-openbsd \
        tmux \
        asciinema && \
    rm -rf /var/lib/apt/lists/*

# Download and extract ModSecurity v2.9.11
RUN wget -q https://github.com/owasp-modsecurity/ModSecurity/archive/refs/tags/v2.9.11.tar.gz && \
    tar -xzf v2.9.11.tar.gz --strip-components=1 && \
    rm v2.9.11.tar.gz

# Build ModSecurity
RUN ./autogen.sh && \
    ./configure --with-apxs=/usr/bin/apxs && \
    make -j$(nproc) && \
    make install

# Enable required Apache modules
RUN a2enmod unique_id

# Create directory for ModSecurity config
RUN mkdir -p /etc/modsecurity /var/cache/modsecurity

# Copy ModSecurity configuration and unicode mapping file from source
COPY task-deps/modsecurity.conf /etc/modsecurity/modsecurity.conf
RUN cp /app/unicode.mapping /etc/modsecurity/

# Copy security2 module configuration files
COPY task-deps/security2.load /etc/apache2/mods-available/security2.load
COPY task-deps/security2.conf /etc/apache2/mods-available/security2.conf

# Enable security2 module
RUN ln -sf /etc/apache2/mods-available/security2.load /etc/apache2/mods-enabled/ && \
    ln -sf /etc/apache2/mods-available/security2.conf /etc/apache2/mods-enabled/

# Create task-deps directory and copy the patch file for solution.sh
RUN mkdir -p /app/task-deps

# Copy test page
COPY task-deps/index.html /var/www/html/index.html

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 80

RUN mkdir -p /tests /oracle
# CMD ["/entrypoint.sh"]