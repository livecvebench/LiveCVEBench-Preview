#!/bin/bash
# Solution for CVE-2025-49008: Atheos IDE Git argument injection vulnerability
# This script applies the fix to prevent command injection via Git operations

set -e

APP_PATH="/var/www/html"

echo "[*] Applying fix for CVE-2025-49008 argument injection vulnerability..."
echo "[*] Application path: $APP_PATH"

# Fix 1: Delete the vulnerable execute.php trait
# This flawed wrapper uses escapeshellcmd() which is insufficient for preventing argument injection
echo "[*] Removing vulnerable execute.php trait..."
rm -f "$APP_PATH/components/codegit/traits/execute.php"

# Fix 2: Add safe_execute() and raw_execute() functions to common.php
# Using PHP script to safely inject the code
echo "[*] Adding safe_execute() and raw_execute() functions to common.php..."

php << 'INJECT_PHP'
<?php
$filepath = '/var/www/html/common.php';
$content = file_get_contents($filepath);

// The new functions to add before the closing brace of the Common class
$newFunctions = '
	//////////////////////////////////////////////////////////////////////////80
	// Safe Execution Command with Template and Sanitized Arguments
	//////////////////////////////////////////////////////////////////////////80
	public static function safe_execute($cmd, ...$args) {
		if (count($args) > 0) {
			// Sanitize every single argument.
			$safe_args = array_map("escapeshellarg", $args);
			// Replace placeholders in template with the sanitized arguments.
			$cmd = vsprintf(str_replace("?", "%s", $cmd), $safe_args);
		} else {
			$cmd = str_replace("?", "", $cmd);
			$cmd = str_replace("%%", "%", $cmd);
		}
		return Common::raw_execute($cmd);
	}

	//////////////////////////////////////////////////////////////////////////80
	// Raw Execution Command; call directly only when absolutely necessary.
	//////////////////////////////////////////////////////////////////////////80
	public static function raw_execute($cmd = null) {
		$result = [
			"code" => 417,
			"text" => "common_missing_command"
		];

		if (!$cmd) return $result;
		$output = null;

		if (function_exists("system")) {
			ob_start();
			system($cmd, $result["code"]);
			$output = ob_get_clean();
		} elseif (function_exists("exec")) {
			$output = [];
			exec($cmd, $output, $result["code"]);
		}

		$result["text"] = is_array($output) ? implode("\n", $output) : $output;
		return $result;
	}
';

// Find the closing brace of the Common class (right before Common::initialize())
// The pattern is: the class ends with "}" followed by Common::initialize()
$pattern = '/^}(\s*\n\s*Common::initialize)/m';
$replacement = $newFunctions . "\n}\$1";

$newContent = preg_replace($pattern, $replacement, $content);

if ($newContent === null || $newContent === $content) {
    // If regex failed, try another approach - find the execute function and add after it
    // Look for the closing brace of execute() function
    $pattern2 = '/(public static function execute\(\$cmd = false\) \{.*?return array\([^)]+\);[\s\n]+\})/s';

    if (preg_match($pattern2, $content, $matches)) {
        $newContent = str_replace($matches[1], $matches[1] . $newFunctions, $content);
    }
}

if ($newContent && $newContent !== $content) {
    file_put_contents($filepath, $newContent);
    echo "Successfully injected safe_execute functions into common.php\n";
} else {
    echo "ERROR: Failed to inject functions\n";
    exit(1);
}
?>
INJECT_PHP

# Fix 3: Update transfer.php to use safe_execute instead of $this->execute
echo "[*] Patching transfer.php with secure transfer methods..."

cat > "$APP_PATH/components/codegit/traits/transfer.php" << 'TRANSFER_PHP_EOF'
<?php

trait Transfer {

	public function push($remote, $branch) {
		$result = Common::safe_execute("git push -- ? ?", $remote, $branch);
		if ($result["code"] === 0) {
			Common::send(200, $result["text"]);
		} else {
			Common::send(500, i18n("git_push_failed") . "\n\n" . ($result["text"] ?? ""));
		}
	}

	public function pull($remote, $branch) {
		$result = Common::safe_execute("git pull -- ? ?", $remote, $branch);
		if ($result["code"] === 0) {
			Common::send(200, $result["text"]);
		} else {
			Common::send(500, i18n("git_pull_failed") . "\n\n" . ($result["text"] ?? ""));
		}
	}

	public function fetch($remote, $branch) {
		$result = Common::safe_execute("git fetch -- ? ?", $remote, $branch);
		if ($result["code"] === 0) {
			Common::send(200, $result["text"]);
		} else {
			Common::send(500, i18n("git_fetch_failed") . "\n\n" . ($result["text"] ?? ""));
		}
	}
}
TRANSFER_PHP_EOF

# Fix 4: Update class.git.php to remove execute.php include
echo "[*] Updating class.git.php to remove execute.php dependency..."
sed -i 's|include_once "traits/execute.php";|// include_once "traits/execute.php"; // Removed: using Common::safe_execute() instead|g' "$APP_PATH/components/codegit/class.git.php"

# Verify changes
echo "[*] Verifying fix application..."

if [ -f "$APP_PATH/components/codegit/traits/execute.php" ]; then
    echo "[!] Warning: execute.php still exists, removing..."
    rm -f "$APP_PATH/components/codegit/traits/execute.php"
fi

if grep -q "safe_execute" "$APP_PATH/common.php"; then
    echo "[+] common.php: safe_execute() function added"
else
    echo "[!] Error: safe_execute() not found in common.php"
    exit 1
fi

if grep -q 'Common::safe_execute' "$APP_PATH/components/codegit/traits/transfer.php"; then
    echo "[+] transfer.php: Using safe_execute() for Git operations"
else
    echo "[!] Error: transfer.php not using safe_execute()"
    exit 1
fi

# Check for PHP syntax errors
echo "[*] Checking PHP syntax..."
php -l "$APP_PATH/common.php" || { echo "[!] PHP syntax error in common.php"; exit 1; }
php -l "$APP_PATH/components/codegit/traits/transfer.php" || { echo "[!] PHP syntax error in transfer.php"; exit 1; }

echo ""
echo "[*] Fix applied successfully!"
echo "[*] Summary of changes:"
echo "    - Deleted vulnerable execute.php trait"
echo "    - Added safe_execute() function with proper argument escaping"
echo "    - Added raw_execute() for internal use only"
echo "    - Updated transfer.php to use safe_execute() with '--' delimiter"

echo "[*] Fix complete!"
