FROM php:8.1-apache

WORKDIR /var/www/html

# System dependencies (git, tmux, asciinema, curl are required)
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    wget \
    gcc \
    g++ \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Install PHP mysqli extension
RUN docker-php-ext-install mysqli

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Clone the vulnerable version of the School Management System
RUN git config --global --add safe.directory /var/www/html \
    && git clone https://github.com/ProjectsAndPrograms/school-management-system.git . \
    && git checkout 6b6fae5426044f89c08d0dd101c7fa71f9042a59 \
    && rm -rf .git

# Copy the Docker-ready config.php (environment-aware)
COPY task-deps/config.php /var/www/html/assets/config.php

# Set proper file permissions
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

# Create upload directories if they don't exist and set permissions
RUN mkdir -p /var/www/html/uploads \
    && mkdir -p /var/www/html/studentUploads \
    && mkdir -p /var/www/html/teacherUploads \
    && mkdir -p /var/www/html/notesUploads \
    && chmod -R 777 /var/www/html/*Uploads /var/www/html/uploads || true

# Create session directory
RUN mkdir -p /var/lib/php/sessions \
    && chown www-data:www-data /var/lib/php/sessions

# Environment variables for database connection
ENV DB_HOST=db
ENV DB_USER=root
ENV DB_PASSWORD=root
ENV DB_NAME=_sms

# Expose port 80
EXPOSE 80

# Apache runs as foreground process
# CMD ["apache2-foreground"]
