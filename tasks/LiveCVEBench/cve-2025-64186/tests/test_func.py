"""
Functional tests for PCR attestation validation.

These tests verify that the attestation logic works correctly for valid inputs.
They should PASS in both vulnerable and fixed states.
"""

import subprocess
import os


def run_go_test(test_name: str, cwd: str = "/app") -> subprocess.CompletedProcess:
    """Run a specific Go test and return the result."""
    return subprocess.run(
        ["go", "test", "-v", "-run", test_name, "./attestation/..."],
        cwd=cwd,
        capture_output=True,
        text=True,
        timeout=60
    )


class TestPCRValidationFunctionality:
    """Tests for basic PCR validation functionality."""

    def test_go_module_compiles(self):
        """Test that the Go module compiles without errors."""
        result = subprocess.run(
            ["go", "build", "./..."],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=120
        )
        assert result.returncode == 0, f"Go build failed: {result.stderr}"

    def test_pcrs_struct_exists(self):
        """Test that PCRs struct is accessible."""
        # Create a simple test file to verify the struct exists
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    p := attestation.PCRs{
        PCR0: "test0",
        PCR1: "test1",
        PCR2: "test2",
        PCR8: "test8",
    }
    fmt.Println(p.PCR0, p.PCR1, p.PCR2, p.PCR8)
}
'''
        test_file = "/tmp/test_pcrs_struct.go"
        with open(test_file, "w") as f:
            f.write(test_code)

        result = subprocess.run(
            ["go", "run", test_file],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"PCRs struct test failed: {result.stderr}"
        assert "test0 test1 test2 test8" in result.stdout

    def test_equal_method_exists(self):
        """Test that the Equal method exists on PCRs struct."""
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    p1 := attestation.PCRs{PCR0: "a", PCR1: "b", PCR2: "c", PCR8: "d"}
    p2 := attestation.PCRs{PCR0: "a", PCR1: "b", PCR2: "c", PCR8: "d"}
    fmt.Println(p1.Equal(p2))
}
'''
        test_file = "/tmp/test_equal_method.go"
        with open(test_file, "w") as f:
            f.write(test_code)

        result = subprocess.run(
            ["go", "run", test_file],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Equal method test failed: {result.stderr}"
        assert "true" in result.stdout

    def test_is_empty_method(self):
        """Test that IsEmpty method works correctly."""
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    empty := attestation.PCRs{}
    nonempty := attestation.PCRs{PCR0: "a", PCR1: "b", PCR2: "c"}
    fmt.Printf("empty:%v nonempty:%v", empty.IsEmpty(), nonempty.IsEmpty())
}
'''
        test_file = "/tmp/test_is_empty.go"
        with open(test_file, "w") as f:
            f.write(test_code)

        result = subprocess.run(
            ["go", "run", test_file],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"IsEmpty test failed: {result.stderr}"
        assert "empty:true" in result.stdout
        assert "nonempty:false" in result.stdout

    def test_exact_match_equal_method(self):
        """Test that Equal method returns true for exactly matching PCRs."""
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    p1 := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "jkl012",
    }
    p2 := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "jkl012",
    }
    fmt.Println(p1.Equal(p2))
}
'''
        test_file = "/tmp/test_exact_match.go"
        with open(test_file, "w") as f:
            f.write(test_code)

        result = subprocess.run(
            ["go", "run", test_file],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Exact match test failed: {result.stderr}"
        assert "true" in result.stdout

    def test_mismatch_detection_equal_method(self):
        """Test that Equal method returns false for mismatched PCRs."""
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    p1 := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "def456",
        PCR2: "ghi789",
        PCR8: "jkl012",
    }
    p2 := attestation.PCRs{
        PCR0: "abc123",
        PCR1: "DIFFERENT",  // Mismatch here
        PCR2: "ghi789",
        PCR8: "jkl012",
    }
    fmt.Println(p1.Equal(p2))
}
'''
        test_file = "/tmp/test_mismatch.go"
        with open(test_file, "w") as f:
            f.write(test_code)

        result = subprocess.run(
            ["go", "run", test_file],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Mismatch test failed: {result.stderr}"
        assert "false" in result.stdout

    def test_build_static_pcr_provider(self):
        """Test that BuildStaticPcrProvider function works."""
        test_code = '''package main

import (
    "fmt"
    "github.com/evervault/evervault-go/attestation"
)

func main() {
    pcrs := []attestation.PCRs{
        {PCR0: "a", PCR1: "b", PCR2: "c", PCR8: "d"},
    }
    provider := attestation.BuildStaticPcrProvider(pcrs)
    result, err := provider()
    if err != nil {
        fmt.Println("error")
    } else {
        fmt.Printf("count:%d", len(result))
    }
}
'''
        test_file = "/tmp/test_provider.go"
        with open(test_file, "w") as f:
            f.write(test_code)

        result = subprocess.run(
            ["go", "run", test_file],
            cwd="/app",
            capture_output=True,
            text=True,
            timeout=60
        )
        assert result.returncode == 0, f"Provider test failed: {result.stderr}"
        assert "count:1" in result.stdout
