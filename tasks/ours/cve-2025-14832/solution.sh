#!/bin/bash
set -e

# Solution script for fixing the SQL injection vulnerability in updateproduct.php
# The fix replaces direct string concatenation with prepared statements

cd /var/www/html

# Path to the vulnerable file
VULN_FILE="/var/www/html/cakeshop/updateproduct.php"

# Create the fixed version of the file
# The key change is using prepared statements instead of string concatenation
cat > "$VULN_FILE" << 'FIXED_PHP'
<?php include('includes/connection.php');?>
<!--header area-->
<?php include 'includes/header.php'; ?>
<!--sidebar area-->
<?php include 'includes/sidebar.php'; ?>
<?php
if(!isset($_SESSION["userid"])){
 header("Location: login.php");
}
else{
?>

<?php
}
?>


                <!-- Page Heading -->

                <!-- /.row -->
<?php
// FIXED: Using prepared statement to prevent SQL injection
$stmt = $db->prepare('SELECT * FROM `tblproducts` WHERE `product_code` = ? GROUP BY product_code');
$id = $_GET['id'];
$stmt->bind_param('s', $id);
$stmt->execute();
$result = $stmt->get_result();
              while($row = $result->fetch_array())
              {
               $zz = $row['product_id'];
               $i = $row['product_name'];
               $a = $row['quantity'];
               $b = $row['price'];
               $c = $row['profit'];
               $d = $row['selling_price'];
               $e = $row['product_code'];

              }

              $id = $_GET['id'];

?>

             <div class="container">
      <div class="card card-register mx-auto mt-5">
        <div class="card-header">Update Product</div>
        <div class="card-body">

                        <form role="form" method="post" action="updateproduct1.php">

                            <div class="form-group">
                                <input type="hidden" name="id" value="<?php echo $zz; ?>" />
                            </div>
                            <div class="form-group">
                              <a>Product Name:</a>
                              <input class="form-control" placeholder="Product Name" name="Productname" value="<?php echo $i; ?>">
                            </div>
                            <div class="form-group">
                              <input class="form-control" type="hidden" placeholder="Available Quantity" name="Quantity" value="<?php echo $a; ?>">
                            </div>
                            <div class="form-group">
                              <a>Original Price:</a>
                              <input class="form-control" placeholder="Price" id="price" name="Price" value="<?php echo $b; ?>">
                            </div>
                            <div class="form-group">
                              <a>Markup:</a>
                              <input class="form-control" placeholder="Markup" id="price" name="Markup" value="<?php echo $c; ?>">
                            </div>
                            <div class="form-group">
                              <a>Selling Price:</a>
                              <input class="form-control" placeholder="Selling Price" id="sale" name="Selling" value="<?php echo $d; ?>">
                            </div>
                            <div class="form-group">
                              <input class="form-control"  type="hidden" name="code" value="<?php echo $e; ?>">
                            </div>

                            <button type="submit" class="btn btn-default">Update</button>



                      </form>
                    </div>
                </div>
                </div>
<script src="vendor/jquery/jquery.js"></script>
<script type="text/javascript">
  $(document).ready(function(e){
    $('input').change(function(){
      var toplam=0;
      $('input[id=price]').each(function(){
        toplam = toplam + parseInt($(this).val());
      })
      $('input[id=sale]').val(toplam);
    });

  });
</script>
           <!--footer area-->
<?php include 'includes/footer.php'; ?>
FIXED_PHP

echo "Fix applied successfully to $VULN_FILE"

# Apache/PHP-FPM typically picks up file changes automatically
# No need to restart for PHP file changes, but clear any opcache if enabled
if command -v php &> /dev/null; then
    php -r "if(function_exists('opcache_reset')) { opcache_reset(); }" 2>/dev/null || true
fi

echo "Solution applied: SQL injection vulnerability fixed using prepared statements"
