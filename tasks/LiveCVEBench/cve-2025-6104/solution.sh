#!/bin/bash
# solution.sh - Fix the input validation issue in PMS check endpoint
set -e
cd /app

echo "Applying fix to /app/billing/pms_check.php..."

# Backup original file
cp /app/billing/pms_check.php /app/billing/pms_check.php.backup

# Replace the vulnerable file with the fixed version
cat > /app/billing/pms_check.php << 'PHPEOF'
<?php
/**
 * PMS Check Script - Property Management System Integration
 * Part of UniBox Controller billing module
 */

// Partial Code Purpose:
# title : Function for ping
# author : UniBox Developers
# note  : Used for PMS connectivity check

function PmsCheck($target) {
    $result = array();

    // Validate input: only allow valid IP addresses
    if (!filter_var($target, FILTER_VALIDATE_IP)) {
        return "<?xml color=red>Response : Invalid IP address format</font>";
    }

    // Safely escape the IP address for shell execution
    $safe_target = escapeshellarg($target);
    $cmd_result = shell_exec("ping -c 3 -w 3 " . $safe_target);

    /* Get Results from Ping */
    $result = explode("\n", $cmd_result);

    if (isset($result[1])) {
        return "<?xml color=green>Response : PMS test success</font>";
    } else {
        return "<?xml color=red>Response : PMS test failed</font>";
    }
}

$target = isset($_REQUEST['ipaddress']) ? $_REQUEST['ipaddress'] : '';

if (!empty($target)) {
    echo PmsCheck($target);
} else {
    echo "<?xml color=red>Response : PMS test failed - No IP address provided</font>";
}
?>
PHPEOF

echo "Fix applied successfully!"
echo "Changes made:"
echo "  - Added IP address validation using filter_var()"
echo "  - Added escapeshellarg() to safely escape shell arguments"
