#!/bin/bash
# Solution script for md-to-pdf front-matter engine configuration issue
# This fix corrects the gray-matter engine key from 'js' to 'javascript'
# to properly block JavaScript execution in front-matter blocks.

set -e
cd /app

echo "[*] Applying fix to src/lib/config.ts..."

# The fix: change 'js' to 'javascript' in the engines configuration
# Gray-matter uses 'javascript' as the canonical engine name
# Both '---js' and '---javascript' delimiters resolve to 'javascript'
# So we need to override 'javascript', not 'js'

# Use sed to perform the replacement
# Match the line with 'js: () =>' and change to 'javascript: () =>'
sed -i "s/\bjs: () =>/javascript: () =>/" /app/src/lib/config.ts

echo "[*] Verifying the change..."
if grep -q "javascript: () =>" /app/src/lib/config.ts; then
    echo "[+] Source code updated successfully"
else
    echo "[-] Fix may not have been applied correctly"
    exit 1
fi

echo "[*] Rebuilding the project..."
npm run build

echo "[+] Fix applied and project rebuilt successfully"
