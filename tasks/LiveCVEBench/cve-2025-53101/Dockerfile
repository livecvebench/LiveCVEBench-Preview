FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies and required tools
RUN apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    automake \
    libtool \
    pkg-config \
    libpng-dev \
    libjpeg-dev \
    libtiff-dev \
    libwebp-dev \
    libgif-dev \
    libfreetype6-dev \
    libxml2-dev \
    ghostscript \
    git \
    wget \
    curl \
    patch \
    tmux \
    asciinema \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Clone vulnerable version and remove git history
WORKDIR /app
RUN git clone --depth 1 --branch 7.1.1-47 https://github.com/ImageMagick/ImageMagick.git . && \
    rm -rf .git

# Build ImageMagick with AddressSanitizer for reliable vulnerability detection
ENV CFLAGS="-fsanitize=address -g -O1"
ENV CXXFLAGS="-fsanitize=address -g -O1"
ENV LDFLAGS="-fsanitize=address"
RUN ./configure --disable-shared && make -j$(nproc) && make install && ldconfig /usr/local/lib

# Verify installation
RUN magick --version

# Working directory
WORKDIR /app

# Default command - keep container running for docker exec
# CMD ["tail", "-f", "/dev/null"]
