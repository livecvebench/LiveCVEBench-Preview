FROM php:8.1-apache

WORKDIR /var/www/html

# System dependencies
RUN apt-get update && apt-get install -y \
    git \
    tmux \
    asciinema \
    curl \
    unzip \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libzip-dev \
    python3-pip \
    python3-requests \
    && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install gd zip

# Enable Apache modules
RUN a2enmod rewrite headers

# Install composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer \
    && composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/

ENV COMPOSER_ALLOW_SUPERUSER=1

# Install pytest
RUN pip3 install --break-system-packages pytest -i https://mirrors.aliyun.com/pypi/simple/

# Clone vulnerable version
RUN git clone --branch 10.0.3 --depth 1 https://github.com/haxtheweb/haxcms-php.git . \
    && rm -rf .git

# ========== Attempt to install Composer dependencies ==========
RUN composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs || \
    echo "Composer install failed, will use fallback autoloader"

# Create required directories
RUN mkdir -p _config _sites _archived _published vendor \
    && chmod -R 755 _config _sites _archived _published vendor

# ========== Copy configuration files ==========
COPY task-deps/config/config.json _config/config.json
COPY task-deps/config/userData.json _config/userData.json
COPY task-deps/config/config.php _config/config.php

# ========== Copy fallback autoloader if composer fails ==========
COPY task-deps/vendor/autoload.php /tmp/fallback-autoload.php
RUN if [ ! -f "vendor/autoload.php" ]; then \
        echo "Using fallback autoloader"; \
        cp /tmp/fallback-autoload.php vendor/autoload.php; \
    fi && rm /tmp/fallback-autoload.php

# ========== Apply test patch: Disable authentication (before setting permissions) ==========
COPY task-deps/disable_auth.sh /tmp/disable_auth.sh
RUN bash /tmp/disable_auth.sh && rm /tmp/disable_auth.sh

# Set configuration file permissions (after all COPY operations)
RUN chown -R www-data:www-data _config/ vendor/ && \
    chmod 644 _config/*.json _config/*.php

# Set git environment
ENV GIT_AUTHOR_NAME="HAX CMS"
ENV GIT_AUTHOR_EMAIL="hax@example.com"
ENV GIT_COMMITTER_NAME="HAX CMS"
ENV GIT_COMMITTER_EMAIL="hax@example.com"

# Set ownership (final unified setting)
RUN chown -R www-data:www-data /var/www/html

# Configure Apache
ENV APACHE_DOCUMENT_ROOT=/var/www/html
RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf \
    && sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf

EXPOSE 80

# CMD 