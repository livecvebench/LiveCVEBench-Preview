#!/usr/bin/env python3
"""
Vulnerability tests for ClipBucket v5 flagging system.

These tests verify that authentication is required for flagging operations.

EXPECTED BEHAVIOR:
- FAIL when vulnerable (unauthenticated flagging is allowed)
- PASS when fixed (unauthenticated flagging is blocked)
"""

import pytest
import requests
import os
import re

# Base URL for the ClipBucket application
BASE_URL = os.environ.get("TARGET_URL", "http://localhost")

# Timeout for HTTP requests
REQUEST_TIMEOUT = 10


def send_flag_request(object_type: str, object_id: int = 1, flag_type: int = 1) -> requests.Response:
    """
    Send an unauthenticated flag request to the AJAX endpoint.

    Args:
        object_type: Type of object to flag (user, video, photo, collection)
        object_id: ID of the object to flag
        flag_type: Category of the flag

    Returns:
        Response object from the request
    """
    url = f"{BASE_URL}/actions/ajax.php"
    data = {
        "mode": "flag_object",
        "type": object_type,
        "id": str(object_id),
        "flag_type": str(flag_type)
    }

    # Explicitly send without any cookies or authentication
    response = requests.post(
        url,
        data=data,
        timeout=REQUEST_TIMEOUT,
        cookies={},  # No cookies
        headers={
            "Content-Type": "application/x-www-form-urlencoded"
        }
    )
    return response


def is_authentication_required(response: requests.Response) -> bool:
    """
    Check if the response indicates authentication is required.

    Args:
        response: The HTTP response to check

    Returns:
        True if login is required, False if action was allowed without auth
    """
    # Note: We do NOT treat 500 errors as "authentication required".
    # A 500 error is a server bug, not an authentication check.
    # The vulnerability test needs to verify that the application
    # explicitly checks for authentication, not that it crashes.

    response_text = response.text.lower()

    # Indicators that authentication is required (FIXED state)
    # These are explicit authentication messages, not generic errors
    auth_required_indicators = [
        "please_login",
        "please login",
        "log in",
        "sign in",
        "must be logged in",
        "login required",
        "authentication required",
        "not logged in",
        "please_login_to_flag",
    ]

    for indicator in auth_required_indicators:
        if indicator in response_text:
            return True

    return False


def is_flag_successful(response: requests.Response) -> bool:
    """
    Check if the response indicates the flag was successfully created.

    Args:
        response: The HTTP response to check

    Returns:
        True if flag was created without authentication
    """
    response_text = response.text.lower()

    # Indicators that flag was successful (VULNERABLE state)
    success_indicators = [
        "success",
        "report_successful",
        "reported",
        "thank you",
        "flagged",
        '<div class="msg">',
    ]

    for indicator in success_indicators:
        if indicator in response_text:
            return True

    return False


class TestUnauthenticatedFlaggingBlocked:
    """Test that unauthenticated users cannot flag content."""

    def test_unauthenticated_user_flagging_blocked(self):
        """Verify unauthenticated users cannot flag user objects."""
        response = send_flag_request("user", object_id=1)

        assert is_authentication_required(response), \
            f"Unauthenticated user flagging should require login. Response: {response.text[:300]}"
        assert not is_flag_successful(response), \
            f"Unauthenticated user flagging should not succeed. Response: {response.text[:300]}"

    def test_unauthenticated_video_flagging_blocked(self):
        """Verify unauthenticated users cannot flag video objects."""
        response = send_flag_request("video", object_id=1)

        assert is_authentication_required(response), \
            f"Unauthenticated video flagging should require login. Response: {response.text[:300]}"
        assert not is_flag_successful(response), \
            f"Unauthenticated video flagging should not succeed. Response: {response.text[:300]}"

    def test_unauthenticated_photo_flagging_blocked(self):
        """Verify unauthenticated users cannot flag photo objects."""
        response = send_flag_request("photo", object_id=1)

        assert is_authentication_required(response), \
            f"Unauthenticated photo flagging should require login. Response: {response.text[:300]}"
        assert not is_flag_successful(response), \
            f"Unauthenticated photo flagging should not succeed. Response: {response.text[:300]}"

    def test_unauthenticated_collection_flagging_blocked(self):
        """Verify unauthenticated users cannot flag collection objects."""
        response = send_flag_request("collection", object_id=1)

        assert is_authentication_required(response), \
            f"Unauthenticated collection flagging should require login. Response: {response.text[:300]}"
        assert not is_flag_successful(response), \
            f"Unauthenticated collection flagging should not succeed. Response: {response.text[:300]}"


class TestMultipleObjectIDs:
    """Test that authentication is required regardless of object ID."""

    @pytest.mark.parametrize("object_id", [1, 2, 100, 9999])
    def test_unauthenticated_flagging_blocked_various_ids(self, object_id):
        """Verify authentication is required for various object IDs."""
        response = send_flag_request("video", object_id=object_id)

        assert is_authentication_required(response), \
            f"Flagging object ID {object_id} should require login. Response: {response.text[:300]}"


class TestMultipleFlagTypes:
    """Test that authentication is required regardless of flag type."""

    @pytest.mark.parametrize("flag_type", [1, 2, 3, 4, 5])
    def test_unauthenticated_flagging_blocked_various_flag_types(self, flag_type):
        """Verify authentication is required for various flag categories."""
        response = send_flag_request("video", object_id=1, flag_type=flag_type)

        assert is_authentication_required(response), \
            f"Flagging with flag_type {flag_type} should require login. Response: {response.text[:300]}"


class TestBypassAttempts:
    """Test various bypass attempts that should all be blocked."""

    def test_uppercase_type_requires_auth(self):
        """Verify uppercase object type still requires authentication."""
        url = f"{BASE_URL}/actions/ajax.php"
        response = requests.post(
            url,
            data={
                "mode": "flag_object",
                "type": "VIDEO",  # Uppercase
                "id": "1",
                "flag_type": "1"
            },
            timeout=REQUEST_TIMEOUT
        )

        assert is_authentication_required(response), \
            f"Uppercase type should still require auth. Response: {response.text[:300]}"

    def test_mixed_case_type_requires_auth(self):
        """Verify mixed case object type still requires authentication."""
        url = f"{BASE_URL}/actions/ajax.php"
        response = requests.post(
            url,
            data={
                "mode": "flag_object",
                "type": "Video",  # Mixed case
                "id": "1",
                "flag_type": "1"
            },
            timeout=REQUEST_TIMEOUT
        )

        assert is_authentication_required(response), \
            f"Mixed case type should still require auth. Response: {response.text[:300]}"

    def test_empty_cookies_requires_auth(self):
        """Verify request with explicitly empty cookies requires authentication."""
        url = f"{BASE_URL}/actions/ajax.php"
        session = requests.Session()
        session.cookies.clear()

        response = session.post(
            url,
            data={
                "mode": "flag_object",
                "type": "user",
                "id": "1",
                "flag_type": "1"
            },
            timeout=REQUEST_TIMEOUT
        )

        assert is_authentication_required(response), \
            f"Request with empty cookies should require auth. Response: {response.text[:300]}"


class TestResponseFormat:
    """Test that error responses have correct format."""

    def test_auth_required_response_format(self):
        """Verify authentication is required and error response has proper format."""
        response = send_flag_request("video", object_id=1)

        # Authentication MUST be required - test should FAIL in vulnerable state
        assert is_authentication_required(response), \
            f"Authentication should be required for flagging. Response: {response.text[:300]}"

        # When auth is required, response should contain error structure
        response_lower = response.text.lower()
        has_error_structure = (
            '<div class="error">' in response_lower or
            '<div class=' in response_lower or
            'error' in response_lower
        )
        assert has_error_structure, \
            f"Error response should have proper structure. Response: {response.text[:300]}"

    def test_no_success_message_without_auth(self):
        """Verify success message is never shown without authentication."""
        for obj_type in ["user", "video", "photo", "collection"]:
            response = send_flag_request(obj_type, object_id=1)

            # Check that we don't see success indicators
            response_lower = response.text.lower()
            success_patterns = [
                '<div class="msg">',
                'report_successful',
                'successfully reported',
                'flag successful',
            ]

            for pattern in success_patterns:
                if pattern in response_lower:
                    # If we see success, authentication should have been required
                    assert is_authentication_required(response), \
                        f"Success message '{pattern}' shown without auth for {obj_type}. Response: {response.text[:300]}"


class TestRapidFlagAttempts:
    """Test that rapid flagging attempts are all blocked without auth."""

    def test_rapid_flag_attempts_all_blocked(self):
        """Verify rapid consecutive flag attempts all require authentication."""
        blocked_count = 0
        total_attempts = 10

        for i in range(total_attempts):
            response = send_flag_request("video", object_id=i+1)
            if is_authentication_required(response):
                blocked_count += 1

        assert blocked_count == total_attempts, \
            f"All {total_attempts} rapid flag attempts should require auth, but only {blocked_count} did"
