#!/bin/bash

# Initialize MariaDB if needed
if [ ! -d "/var/lib/mysql/mysql" ]; then
    echo "Initializing MariaDB..."
    mariadb-install-db --user=mysql --datadir=/var/lib/mysql
fi

# Start MariaDB
echo "Starting MariaDB..."
service mariadb start

# Wait for MariaDB to be ready
sleep 5

# Create database and user if they dont exist
mysql -e "CREATE DATABASE IF NOT EXISTS yeswiki;" 2>/dev/null || true
mysql -e "CREATE USER IF NOT EXISTS 'yeswiki'@'localhost' IDENTIFIED BY 'yeswiki_password';" 2>/dev/null || true
mysql -e "CREATE USER IF NOT EXISTS 'yeswiki'@'127.0.0.1' IDENTIFIED BY 'yeswiki_password';" 2>/dev/null || true
mysql -e "GRANT ALL PRIVILEGES ON yeswiki.* TO 'yeswiki'@'localhost';" 2>/dev/null || true
mysql -e "GRANT ALL PRIVILEGES ON yeswiki.* TO 'yeswiki'@'127.0.0.1';" 2>/dev/null || true
mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true

# Complete YesWiki installation if not already done
if [ ! -f "/app/wakka.config.php" ]; then
    echo "Completing YesWiki installation..."
    # Start PHP-FPM temporarily for installation
    php-fpm -D
    # Start Nginx temporarily
    nginx -g "daemon on;"
    sleep 3
    # Complete installation via HTTP POST
    curl -X POST "http://localhost:8085/?PagePrincipale&installAction=install" \
      -H "Content-Type: application/x-www-form-urlencoded" \
      -d "config%5Bdefault_language%5D=fr&config%5Bwakka_name%5D=YesWiki+CVE+Test&config%5Bmeta_description%5D=&config%5Bmeta_keywords%5D=&config%5Broot_page%5D=PagePrincipale&config%5Bmysql_host%5D=127.0.0.1&config%5Bmysql_database%5D=yeswiki&config%5Bmysql_user%5D=yeswiki&config%5Bmysql_password%5D=yeswiki_password&config%5Btable_prefix%5D=yeswiki_&admin_name=WikiAdmin&admin_password=admin123&admin_password_conf=admin123&admin_email=admin%40test.com&config%5Bbase_url%5D=http%3A//localhost%3A8085/%3F&config%5Brewrite_mode%5D=0&config%5Ballow_raw_html%5D=1" \
      -s > /tmp/install.log 2>&1 || true
    echo "Installation completed"

    # Disable hashcash anti-spam to allow programmatic page creation
    # This is required for testing - hashcash requires JavaScript execution
    if [ -f "/app/wakka.config.php" ]; then
        echo "Disabling hashcash for testing..."
        sed -i "s/);/'use_hashcash' => false,\n);/" /app/wakka.config.php
    fi

    # Stop temporary services
    pkill nginx
    pkill php-fpm
    sleep 2
fi

# Start PHP-FPM
echo "Starting PHP-FPM..."
php-fpm -D

# Start Nginx
echo "Starting Nginx..."
nginx -g "daemon off;" &

echo "YesWiki environment ready at http://localhost:8085"

# Keep container running
tail -f /var/log/nginx/access.log
