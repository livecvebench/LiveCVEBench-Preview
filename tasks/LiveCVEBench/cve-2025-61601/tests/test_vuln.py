"""
Vulnerability tests for poll vote submission handler.

These tests verify the vulnerability status:
- FAIL in vulnerable state (oversized arrays are accepted, vulnerability exploitable)
- PASS in fixed state (oversized arrays are rejected, vulnerability mitigated)
"""

import subprocess
import json
import pytest
import os
import time

# Path to the test runner script (copied to /app by run-tests.sh)
TEST_SCRIPT_PATH = "/app/test_poll_handler.ts"
APP_DIR = "/app"


def run_poll_handler_test(poll_id: str, answer_ids: list, meeting_id: str = "meeting-123", user_id: str = "user-456", timeout: int = 30) -> dict:
    """
    Execute the poll handler with given inputs and return the result.
    Returns dict with 'success', 'result' or 'error' keys.
    """
    input_data = {
        "pollId": poll_id,
        "answerIds": answer_ids
    }

    session_vars = {
        "x-hasura-meetingid": meeting_id,
        "x-hasura-userid": user_id
    }

    test_payload = json.dumps({
        "input": input_data,
        "session": session_vars
    })

    try:
        result = subprocess.run(
            ["npx", "ts-node", TEST_SCRIPT_PATH],
            input=test_payload,
            capture_output=True,
            text=True,
            cwd=APP_DIR,
            timeout=timeout
        )

        try:
            output = json.loads(result.stdout.strip().split('\n')[-1])
            return output
        except (json.JSONDecodeError, IndexError):
            return {
                "success": False,
                "error": f"Parse error: stdout={result.stdout[:500]}, stderr={result.stderr[:500]}",
                "returncode": result.returncode
            }
    except subprocess.TimeoutExpired:
        return {
            "success": False,
            "error": "Timeout - request took too long (possible DoS condition)",
            "timeout": True
        }


class TestOversizedArrayRejection:
    """
    Test that oversized answerIds arrays are properly rejected.

    The fix should reject any answerIds array with more than 100 elements.
    These tests should:
    - FAIL when vulnerable (arrays accepted, no validation)
    - PASS when fixed (arrays rejected with validation error)
    """

    def test_101_elements_rejected(self):
        """Test that 101 elements (just over limit) is rejected."""
        answer_ids = [0] * 101
        result = run_poll_handler_test(
            poll_id="poll-101",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 101 elements should be rejected but was accepted"
        assert "error" in result, "Expected error message for rejected request"
        error_msg = result.get("error", "").lower()
        assert "limit" in error_msg or "exceed" in error_msg or "maximum" in error_msg or "100" in error_msg, \
            f"Error message should mention limit: {result.get('error')}"

    def test_150_elements_rejected(self):
        """Test that 150 elements is rejected."""
        answer_ids = [0] * 150
        result = run_poll_handler_test(
            poll_id="poll-150",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 150 elements should be rejected but was accepted"
        assert "error" in result

    def test_200_elements_rejected(self):
        """Test that 200 elements is rejected."""
        answer_ids = [1] * 200
        result = run_poll_handler_test(
            poll_id="poll-200",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 200 elements should be rejected but was accepted"

    def test_500_elements_rejected(self):
        """Test that 500 elements is rejected."""
        answer_ids = [0] * 500
        result = run_poll_handler_test(
            poll_id="poll-500",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 500 elements should be rejected but was accepted"

    def test_1000_elements_rejected(self):
        """Test that 1000 elements is rejected."""
        answer_ids = [0] * 1000
        result = run_poll_handler_test(
            poll_id="poll-1000",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 1000 elements should be rejected but was accepted"


class TestLargerPayloads:
    """Test with larger payloads that could cause resource exhaustion."""

    def test_5000_elements_rejected(self):
        """Test that 5000 elements is rejected."""
        answer_ids = [0] * 5000
        result = run_poll_handler_test(
            poll_id="poll-5k",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 5000 elements should be rejected"

    def test_10000_elements_rejected(self):
        """Test that 10000 elements is rejected."""
        answer_ids = [0] * 10000
        result = run_poll_handler_test(
            poll_id="poll-10k",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 10000 elements should be rejected"

    def test_50000_elements_rejected(self):
        """Test that 50000 elements is rejected quickly (not processed)."""
        answer_ids = [0] * 50000

        start_time = time.time()
        result = run_poll_handler_test(
            poll_id="poll-50k",
            answer_ids=answer_ids,
            timeout=10  # Should reject fast, not process all elements
        )
        elapsed_time = time.time() - start_time

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 50000 elements should be rejected"

        # If fixed, rejection should be fast (validation happens before processing)
        # If vulnerable, it might timeout or take a long time
        assert elapsed_time < 5, \
            f"Request took too long ({elapsed_time:.2f}s) - may indicate processing instead of immediate rejection"


class TestMixedPayloads:
    """Test with various types of oversized payloads."""

    def test_varied_values_rejected(self):
        """Test that varied answer values (not just zeros) are still rejected when oversized."""
        answer_ids = list(range(200))  # [0, 1, 2, ..., 199]
        result = run_poll_handler_test(
            poll_id="poll-varied",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Array with 200 varied elements should be rejected"

    def test_negative_values_in_oversized_array_rejected(self):
        """Test that oversized array with negative values is rejected."""
        answer_ids = [-1] * 150
        result = run_poll_handler_test(
            poll_id="poll-negative",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Oversized array with negative values should be rejected"

    def test_large_values_in_oversized_array_rejected(self):
        """Test that oversized array with large integer values is rejected."""
        answer_ids = [999999] * 150
        result = run_poll_handler_test(
            poll_id="poll-large-vals",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Oversized array with large values should be rejected"

    def test_mixed_zero_and_ones_rejected(self):
        """Test that oversized array with mixed 0s and 1s is rejected."""
        answer_ids = [i % 2 for i in range(300)]  # [0, 1, 0, 1, ...]
        result = run_poll_handler_test(
            poll_id="poll-mixed",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Oversized array with mixed values should be rejected"


class TestValidationErrorDetails:
    """Test that the validation error contains proper details."""

    def test_error_status_code_is_400(self):
        """Test that the error response includes a 400 status code."""
        answer_ids = [0] * 150
        result = run_poll_handler_test(
            poll_id="poll-status",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Oversized array should be rejected"

        # Check for 400 status in the error
        error_info = result.get("error", "")
        status = result.get("status", result.get("statusCode", 0))

        # The error should indicate a 400 Bad Request
        assert status == 400 or "400" in str(error_info) or "bad request" in error_info.lower() or "validation" in error_info.lower(), \
            f"Expected 400 status or validation error, got: {result}"

    def test_error_message_mentions_answerids(self):
        """Test that the error message specifically mentions answerIds parameter."""
        answer_ids = [0] * 200
        result = run_poll_handler_test(
            poll_id="poll-errmsg",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Oversized array should be rejected"

        error_msg = result.get("error", "").lower()
        assert "answerids" in error_msg or "answer" in error_msg or "limit" in error_msg or "maximum" in error_msg, \
            f"Error message should mention answerIds or limit: {result.get('error')}"

    def test_error_message_mentions_100_limit(self):
        """Test that the error message mentions the 100 element limit."""
        answer_ids = [0] * 150
        result = run_poll_handler_test(
            poll_id="poll-limit-msg",
            answer_ids=answer_ids
        )

        assert not result["success"], \
            "VULNERABILITY PRESENT: Oversized array should be rejected"

        error_msg = result.get("error", "")
        assert "100" in error_msg, \
            f"Error message should mention 100 limit: {result.get('error')}"
