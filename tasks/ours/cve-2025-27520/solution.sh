#!/bin/bash
set -e

echo "Applying security fix for BentoML pickle content-type validation..."

# Find the installed BentoML app.py path and apply the fix
python3 << 'PYTHON_SCRIPT'
import sys
import os

# Find the installed BentoML app.py
try:
    import _bentoml_impl.server.app as m
    app_py_path = m.__file__
except ImportError as e:
    print(f"Error: Could not import BentoML server app: {e}")
    sys.exit(1)

print(f"Found app.py at: {app_py_path}")

with open(app_py_path, 'r') as f:
    content = f.read()

# Check if fix is already applied
if "application/vnd.bentoml+pickle" in content and "is not allowed in main server" in content:
    print("Fix already applied, skipping...")
    sys.exit(0)

# Fix Part 1: Add HTTPStatus import at the start of api_endpoint method
old_pattern1 = '''    async def api_endpoint(self, name: str, request: Request) -> Response:
        from _bentoml_sdk.io_models import ARGS'''

new_code1 = '''    async def api_endpoint(self, name: str, request: Request) -> Response:
        from http import HTTPStatus

        from _bentoml_sdk.io_models import ARGS'''

if old_pattern1 in content:
    content = content.replace(old_pattern1, new_code1)
    print("Added HTTPStatus import")
else:
    print("Warning: Could not find import pattern, trying alternative approach")
    # Alternative: Add import at top of method differently
    alt_pattern = 'async def api_endpoint(self, name: str, request: Request) -> Response:'
    if alt_pattern in content and 'from http import HTTPStatus' not in content.split(alt_pattern)[1].split('async def')[0]:
        # Need to handle this case
        pass

# Fix Part 2: Add the validation check after media_type extraction
old_pattern2 = '''        media_type = request.headers.get("Content-Type", "application/json")
        media_type = media_type.split(";")[0].strip()

        method = self.service.apis[name]'''

new_code2 = '''        media_type = request.headers.get("Content-Type", "application/json")
        media_type = media_type.split(";")[0].strip()

        if self.is_main and media_type == "application/vnd.bentoml+pickle":
            raise BentoMLException(
                "application/vnd.bentoml+pickle is not allowed in main server",
                error_code=HTTPStatus.UNSUPPORTED_MEDIA_TYPE,
            )

        method = self.service.apis[name]'''

if old_pattern2 in content:
    content = content.replace(old_pattern2, new_code2)
    print("Added pickle content-type validation check")
else:
    print("Warning: Could not find media_type pattern")
    # Try more flexible pattern matching
    import re

    # Pattern to match the media_type extraction followed by method assignment
    pattern = r'(        media_type = request\.headers\.get\("Content-Type", "application/json"\)\s+        media_type = media_type\.split\(";"\)\[0\]\.strip\(\)\s+)(        method = self\.service\.apis\[name\])'

    replacement = r'''\1        if self.is_main and media_type == "application/vnd.bentoml+pickle":
            raise BentoMLException(
                "application/vnd.bentoml+pickle is not allowed in main server",
                error_code=HTTPStatus.UNSUPPORTED_MEDIA_TYPE,
            )

\2'''

    new_content = re.sub(pattern, replacement, content)
    if new_content != content:
        content = new_content
        print("Applied fix using regex pattern matching")

# Write the patched file
with open(app_py_path, 'w') as f:
    f.write(content)

print(f"Successfully patched {app_py_path}")

# Verify the fix was applied
with open(app_py_path, 'r') as f:
    verify_content = f.read()

if "application/vnd.bentoml+pickle" in verify_content and "is not allowed in main server" in verify_content:
    print("Verification: Fix successfully applied!")
else:
    print("Warning: Fix may not have been applied correctly")
    sys.exit(1)
PYTHON_SCRIPT

echo ""
echo "Restarting BentoML service to apply changes..."

# Kill the running BentoML service so it restarts with the patched code
pkill -f "bentoml serve" || true
pkill -f "python.*bentoml" || true
pkill -f "uvicorn.*bentoml" || true

# Give time for process to terminate
sleep 3

echo "Fix applied successfully. Service will restart automatically."
