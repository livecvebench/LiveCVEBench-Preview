#!/bin/bash
# Solution script for WebSocket fragmented frame handling bug
# Fixes integer underflow when processing CONTINUE frame as first frame

set -e
cd /app

echo "Applying fix for WebSocket fragmented frame handling..."

# The fix adds a check (ofs > 0) to prevent integer underflow when ofs is 0
# This occurs in the condition for handling the last chunk of fragmented frames

# Fix in src/ws.c (if it exists as separate file)
if [ -f src/ws.c ]; then
    echo "Fixing src/ws.c..."
    sed -i 's/if (final && !op) {/if (final \&\& !op \&\& (ofs > 0)) {/' src/ws.c
fi

# Fix in mongoose.c (amalgamated single-file version)
if [ -f mongoose.c ]; then
    echo "Fixing mongoose.c..."
    sed -i 's/if (final && !op) {/if (final \&\& !op \&\& (ofs > 0)) {/' mongoose.c
fi

# If there's a tutorials directory with the vulnerable file
if [ -f tutorials/websocket/websocket-server/mongoose.c ]; then
    echo "Fixing tutorials/websocket/websocket-server/mongoose.c..."
    sed -i 's/if (final && !op) {/if (final \&\& !op \&\& (ofs > 0)) {/' tutorials/websocket/websocket-server/mongoose.c
fi

echo "Fix applied successfully."

# Rebuild the server
echo "Rebuilding server..."
if [ -f Makefile ]; then
    make clean 2>/dev/null || true
    make CFLAGS_EXTRA="-fsanitize=address -g" 2>/dev/null || make 2>/dev/null || true
else
    # Manual rebuild - match the original Dockerfile command
    rm -f server
    gcc -o server main.c mongoose.c -W -Wall -Wextra -g -fsanitize=address -I.
    echo "Server rebuilt successfully."
fi

# Verify the fix is in the binary by checking the source was modified
if grep -q 'if (final && !op && (ofs > 0))' mongoose.c; then
    echo "Fix verified in source code."
else
    echo "ERROR: Fix not found in source code!"
    exit 1
fi

# Restart the server process so changes take effect
# The entrypoint should restart it automatically
echo "Stopping server process..."
pkill -f "server" 2>/dev/null || pkill -f "example" 2>/dev/null || true
sleep 2

echo "Solution applied. Server will be restarted by entrypoint."
