"""
Functionality tests for mruby interpreter.
These tests verify that mruby works correctly for normal operations.
Should PASS in both vulnerable and fixed states.
"""
import subprocess
import pytest
import os
import tempfile

MRUBY_BIN = "/app/build/host/bin/mruby"


def run_mruby(code, timeout=30):
    """Run mruby with the given Ruby code and return the result."""
    with tempfile.NamedTemporaryFile(mode='w', suffix='.rb', delete=False) as f:
        f.write(code)
        f.flush()
        temp_file = f.name

    try:
        result = subprocess.run(
            [MRUBY_BIN, temp_file],
            capture_output=True,
            timeout=timeout,
            text=True
        )
        return result
    finally:
        os.unlink(temp_file)


def run_mruby_stdin(code, timeout=30):
    """Run mruby with code via stdin."""
    result = subprocess.run(
        [MRUBY_BIN, "-e", code],
        capture_output=True,
        timeout=timeout,
        text=True
    )
    return result


class TestBasicExecution:
    """Test basic mruby functionality."""

    def test_hello_world(self):
        """Test basic puts output."""
        result = run_mruby_stdin('puts "Hello, World!"')
        assert result.returncode == 0
        assert "Hello, World!" in result.stdout

    def test_arithmetic(self):
        """Test basic arithmetic operations."""
        result = run_mruby_stdin('puts 1 + 2 + 3')
        assert result.returncode == 0
        assert "6" in result.stdout

    def test_string_operations(self):
        """Test string concatenation and methods."""
        result = run_mruby_stdin('puts "foo" + "bar"')
        assert result.returncode == 0
        assert "foobar" in result.stdout

    def test_print_expression(self):
        """Test p expression output."""
        result = run_mruby_stdin('p [1, 2, 3]')
        assert result.returncode == 0
        assert "[1, 2, 3]" in result.stdout


class TestLocalVariables:
    """Test local variable handling."""

    def test_simple_assignment(self):
        """Test simple variable assignment and use."""
        result = run_mruby_stdin('x = 42; puts x')
        assert result.returncode == 0
        assert "42" in result.stdout

    def test_multiple_variables(self):
        """Test multiple local variables."""
        code = '''
x = 1
y = 2
z = x + y
puts z
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "3" in result.stdout

    def test_variable_shadowing(self):
        """Test variable shadowing in blocks."""
        code = '''
x = 10
[1, 2, 3].each { |x| }
puts x
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "10" in result.stdout


class TestModuleDefinition:
    """Test module definitions work correctly."""

    def test_simple_module(self):
        """Test basic module definition."""
        code = '''
module Foo
end
p Foo
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "Foo" in result.stdout

    def test_module_with_method(self):
        """Test module with method definition."""
        code = '''
module Calculator
  def self.add(a, b)
    a + b
  end
end
puts Calculator.add(3, 4)
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "7" in result.stdout

    def test_nested_modules(self):
        """Test nested module definitions."""
        code = '''
module Outer
  module Inner
    VALUE = 100
  end
end
puts Outer::Inner::VALUE
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "100" in result.stdout


class TestClassDefinition:
    """Test class definitions work correctly."""

    def test_simple_class(self):
        """Test basic class instantiation."""
        code = '''
class Person
  def initialize(name)
    @name = name
  end

  def greet
    "Hello, #{@name}!"
  end
end

p = Person.new("Alice")
puts p.greet
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "Hello, Alice!" in result.stdout

    def test_class_inheritance(self):
        """Test class inheritance."""
        code = '''
class Animal
  def speak
    "..."
  end
end

class Dog < Animal
  def speak
    "Woof!"
  end
end

puts Dog.new.speak
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "Woof!" in result.stdout


class TestControlFlow:
    """Test control flow statements."""

    def test_if_else(self):
        """Test if/else statements."""
        code = '''
x = 5
if x > 3
  puts "big"
else
  puts "small"
end
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "big" in result.stdout

    def test_while_loop(self):
        """Test while loop."""
        code = '''
i = 0
while i < 3
  i += 1
end
puts i
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "3" in result.stdout

    def test_blocks(self):
        """Test block execution."""
        code = '''
sum = 0
[1, 2, 3, 4, 5].each { |n| sum += n }
puts sum
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "15" in result.stdout


class TestExceptionHandling:
    """Test exception handling works correctly."""

    def test_begin_rescue(self):
        """Test begin/rescue block."""
        code = '''
begin
  raise "test error"
rescue => e
  puts "caught: #{e.message}"
end
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "caught: test error" in result.stdout

    def test_retry_in_rescue(self):
        """Test valid retry inside rescue block."""
        code = '''
attempts = 0
begin
  attempts += 1
  raise "fail" if attempts < 3
  puts "success after #{attempts} attempts"
rescue
  retry if attempts < 3
end
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "success after 3 attempts" in result.stdout


class TestProcs:
    """Test Proc and lambda functionality."""

    def test_simple_proc(self):
        """Test basic proc creation and call."""
        code = '''
add = Proc.new { |a, b| a + b }
puts add.call(2, 3)
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "5" in result.stdout

    def test_lambda(self):
        """Test lambda creation."""
        code = '''
double = ->(x) { x * 2 }
puts double.call(7)
'''
        result = run_mruby(code)
        assert result.returncode == 0
        assert "14" in result.stdout


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
