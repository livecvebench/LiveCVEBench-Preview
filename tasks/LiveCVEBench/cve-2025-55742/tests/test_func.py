"""
Functionality tests for UnoPim user image upload.
These tests verify the application works correctly in both vulnerable and fixed states.
"""

import pytest
import requests
import os
import base64
import io
import time
import re


BASE_URL = os.environ.get("APP_URL", "http://localhost:8000")
ADMIN_EMAIL = os.environ.get("ADMIN_EMAIL", "admin@example.com")
ADMIN_PASSWORD = os.environ.get("ADMIN_PASSWORD", "admin123")


class TestSession:
    """Helper class to manage authenticated sessions"""

    def __init__(self):
        self.session = requests.Session()
        self.csrf_token = None
        self._logged_in = False

    def get_csrf_token(self):
        """Get CSRF token from login page"""
        response = self.session.get(f"{BASE_URL}/admin/login", timeout=30)
        assert response.status_code == 200, f"Failed to get login page: {response.status_code}"

        # Extract CSRF token from the page
        match = re.search(r'name="csrf-token"\s+content="([^"]+)"', response.text)
        if match:
            self.csrf_token = match.group(1)
        else:
            # Try alternative patterns
            match = re.search(r'name="_token"\s+value="([^"]+)"', response.text)
            if match:
                self.csrf_token = match.group(1)
            else:
                match = re.search(r'"csrfToken":\s*"([^"]+)"', response.text)
                if match:
                    self.csrf_token = match.group(1)

        return self.csrf_token

    def login(self):
        """Authenticate with the admin panel"""
        if self._logged_in:
            return True

        self.get_csrf_token()

        login_data = {
            "_token": self.csrf_token,
            "email": ADMIN_EMAIL,
            "password": ADMIN_PASSWORD,
        }

        response = self.session.post(
            f"{BASE_URL}/admin/login",
            data=login_data,
            allow_redirects=True,
            timeout=30
        )

        # Check if login was successful (redirected to dashboard or no error)
        if response.status_code == 200:
            self._logged_in = True
            # Refresh CSRF token after login
            self.get_csrf_token()
            return True

        return False

    def upload_user_image(self, file_content, filename, mime_type=None):
        """
        Upload a file as user profile image.
        Returns the response from the server.
        """
        if not self._logged_in:
            self.login()

        # Refresh CSRF token
        self.get_csrf_token()

        # First, get the create user page to get fresh tokens
        response = self.session.get(f"{BASE_URL}/admin/settings/users", timeout=30)

        # Extract any updated CSRF token
        match = re.search(r'name="csrf-token"\s+content="([^"]+)"', response.text)
        if match:
            self.csrf_token = match.group(1)

        # Prepare user data with required fields
        user_data = {
            "name": "Test User",
            "email": f"test{int(time.time())}@example.com",
            "password": "password123",
            "password_confirmation": "password123",
            "status": "1",
            "timezone": "UTC",
        }

        # Get available roles and locales
        roles_resp = self.session.get(f"{BASE_URL}/admin/settings/roles", timeout=30)
        if roles_resp.status_code == 200:
            role_match = re.search(r'"id":\s*(\d+)', roles_resp.text)
            if role_match:
                user_data["role_id"] = role_match.group(1)
            else:
                user_data["role_id"] = "1"
        else:
            user_data["role_id"] = "1"

        # Get locale ID (typically 1 for default)
        user_data["ui_locale_id"] = "1"

        files = {
            "image[]": (filename, io.BytesIO(file_content), mime_type or "application/octet-stream")
        }

        headers = {
            "X-CSRF-TOKEN": self.csrf_token,
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest",
        }

        response = self.session.post(
            f"{BASE_URL}/admin/settings/users/create",
            data=user_data,
            files=files,
            headers=headers,
            timeout=30
        )

        return response


@pytest.fixture(scope="module")
def auth_session():
    """Fixture to provide authenticated session"""
    session = TestSession()
    max_retries = 5

    for attempt in range(max_retries):
        try:
            if session.login():
                return session
        except requests.exceptions.ConnectionError:
            if attempt < max_retries - 1:
                time.sleep(5)
                continue
            raise

    pytest.skip("Could not authenticate with admin panel")


def create_valid_gif():
    """Create a minimal valid GIF file"""
    # Minimal valid GIF (1x1 pixel, transparent)
    gif_bytes = base64.b64decode(
        "R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
    )
    return gif_bytes


def create_valid_png():
    """Create a minimal valid PNG file"""
    # Minimal valid PNG (1x1 pixel, red)
    png_bytes = base64.b64decode(
        "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
    )
    return png_bytes


def create_valid_jpeg():
    """Create a minimal valid JPEG file"""
    # Minimal valid JPEG (1x1 pixel)
    jpeg_bytes = base64.b64decode(
        "/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0a"
        "HBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIy"
        "MjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAABAAEDASIA"
        "AhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAn/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEB"
        "AQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCwAB//2Q=="
    )
    return jpeg_bytes


def create_valid_svg():
    """Create a minimal valid SVG file"""
    svg_content = '''<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
  <rect width="100" height="100" fill="#3498db"/>
</svg>'''
    return svg_content.encode('utf-8')


class TestBasicFunctionality:
    """
    Test basic functionality of the application.
    These tests should pass in both vulnerable and fixed versions.
    """

    def test_admin_login_page_accessible(self):
        """Test that the admin login page is accessible"""
        response = requests.get(f"{BASE_URL}/admin/login", timeout=30)
        assert response.status_code == 200
        assert "login" in response.text.lower() or "password" in response.text.lower()

    def test_admin_authentication(self, auth_session):
        """Test that admin authentication works"""
        assert auth_session._logged_in, "Admin should be able to authenticate"

    def test_users_page_accessible(self, auth_session):
        """Test that users management page is accessible after login"""
        response = auth_session.session.get(f"{BASE_URL}/admin/settings/users", timeout=30)
        assert response.status_code == 200


class TestValidImageUploads:
    """
    Test that legitimate image uploads work correctly.
    These tests should pass in both vulnerable and fixed versions.
    """

    def test_upload_valid_gif(self, auth_session):
        """Test uploading a valid GIF image"""
        gif_content = create_valid_gif()
        response = auth_session.upload_user_image(gif_content, "test.gif", "image/gif")

        # Should succeed (200 or 302 redirect on success)
        # Could also be 422 for other validation errors (not image-related)
        assert response.status_code in [200, 201, 302, 422], f"Unexpected status: {response.status_code}"

        # If 422, check it's not about image mime mismatch
        if response.status_code == 422:
            try:
                error_text = response.text.lower()
                assert "mime" not in error_text or "extension" not in error_text, \
                    "Valid GIF should not fail MIME/extension validation"
            except:
                pass  # Non-JSON response is okay

    def test_upload_valid_png(self, auth_session):
        """Test uploading a valid PNG image"""
        png_content = create_valid_png()
        response = auth_session.upload_user_image(png_content, "test.png", "image/png")

        assert response.status_code in [200, 201, 302, 422], f"Unexpected status: {response.status_code}"

        if response.status_code == 422:
            try:
                error_text = response.text.lower()
                assert "mime" not in error_text or "extension" not in error_text, \
                    "Valid PNG should not fail MIME/extension validation"
            except:
                pass

    def test_upload_valid_jpeg(self, auth_session):
        """Test uploading a valid JPEG image"""
        jpeg_content = create_valid_jpeg()
        response = auth_session.upload_user_image(jpeg_content, "test.jpg", "image/jpeg")

        assert response.status_code in [200, 201, 302, 422], f"Unexpected status: {response.status_code}"

        if response.status_code == 422:
            try:
                error_text = response.text.lower()
                assert "mime" not in error_text or "extension" not in error_text, \
                    "Valid JPEG should not fail MIME/extension validation"
            except:
                pass

    def test_upload_valid_svg(self, auth_session):
        """Test uploading a valid SVG image"""
        svg_content = create_valid_svg()
        response = auth_session.upload_user_image(svg_content, "test.svg", "image/svg+xml")

        assert response.status_code in [200, 201, 302, 422], f"Unexpected status: {response.status_code}"

        if response.status_code == 422:
            try:
                error_text = response.text.lower()
                # Valid SVG should not fail MIME validation
                assert "mime" not in error_text or "extension" not in error_text, \
                    "Valid SVG should not fail MIME/extension validation"
            except:
                pass


class TestApplicationHealth:
    """
    Basic health checks for the application.
    """

    def test_application_responds(self):
        """Test that the application is running and responding"""
        max_retries = 10
        for i in range(max_retries):
            try:
                response = requests.get(f"{BASE_URL}/admin/login", timeout=10)
                if response.status_code == 200:
                    return
            except requests.exceptions.ConnectionError:
                if i < max_retries - 1:
                    time.sleep(3)
                    continue

        pytest.fail("Application did not respond after multiple retries")
