"""
Functional tests for the TOML parser library.
Tests that the parser works correctly for normal TOML inputs.
These tests should PASS in both vulnerable and fixed states.
"""

import subprocess
import json
import os


def run_toml_parse(toml_content: str) -> dict:
    """
    Helper function to run the TOML parser and return the parsed result.
    Uses Node.js to execute the TypeScript parser (compiled to JS).
    """
    # Escape the TOML content for JavaScript
    escaped_toml = toml_content.replace('\\', '\\\\').replace('\n', '\\n').replace('"', '\\"').replace("'", "\\'")

    js_code = f'''
const {{ parse }} = require('/app/toml/parse.js');
try {{
    const result = parse("{escaped_toml}");
    console.log(JSON.stringify(result, (key, value) => {{
        if (value instanceof Date) {{
            return {{ __date__: value.toISOString() }};
        }}
        return value;
    }}));
}} catch (e) {{
    console.error("PARSE_ERROR:", e.message);
    process.exit(1);
}}
'''

    result = subprocess.run(
        ['node', '-e', js_code],
        capture_output=True,
        text=True,
        cwd='/app'
    )

    if result.returncode != 0:
        raise RuntimeError(f"Failed to parse TOML: {result.stderr}")

    return json.loads(result.stdout.strip())


class TestBasicParsing:
    """Tests for basic TOML parsing functionality."""

    def test_simple_key_value(self):
        """Test parsing simple key-value pairs."""
        toml_content = 'title = "Test Application"'
        result = run_toml_parse(toml_content)
        assert result['title'] == 'Test Application'

    def test_multiple_keys(self):
        """Test parsing multiple key-value pairs."""
        toml_content = 'name = "Test"\nversion = "1.0.0"\nauthor = "Developer"'
        result = run_toml_parse(toml_content)
        assert result['name'] == 'Test'
        assert result['version'] == '1.0.0'
        assert result['author'] == 'Developer'

    def test_integer_values(self):
        """Test parsing integer values."""
        toml_content = 'count = 42\nport = 8080\nnegative = -100'
        result = run_toml_parse(toml_content)
        assert result['count'] == 42
        assert result['port'] == 8080
        assert result['negative'] == -100

    def test_float_values(self):
        """Test parsing float values."""
        toml_content = 'pi = 3.14159\nrate = 0.5\nnegative = -2.5'
        result = run_toml_parse(toml_content)
        assert abs(result['pi'] - 3.14159) < 0.0001
        assert abs(result['rate'] - 0.5) < 0.0001
        assert abs(result['negative'] - (-2.5)) < 0.0001

    def test_boolean_values(self):
        """Test parsing boolean values."""
        toml_content = 'enabled = true\ndisabled = false'
        result = run_toml_parse(toml_content)
        assert result['enabled'] is True
        assert result['disabled'] is False


class TestTableParsing:
    """Tests for TOML table parsing."""

    def test_simple_table(self):
        """Test parsing a simple table."""
        toml_content = '[database]\nhost = "localhost"\nport = 5432'
        result = run_toml_parse(toml_content)
        assert 'database' in result
        assert result['database']['host'] == 'localhost'
        assert result['database']['port'] == 5432

    def test_nested_tables(self):
        """Test parsing nested tables."""
        toml_content = '[server.http]\nhost = "localhost"\nport = 8080'
        result = run_toml_parse(toml_content)
        assert 'server' in result
        assert 'http' in result['server']
        assert result['server']['http']['host'] == 'localhost'
        assert result['server']['http']['port'] == 8080

    def test_multiple_tables(self):
        """Test parsing multiple tables."""
        toml_content = '[database]\nhost = "db.local"\n\n[cache]\nhost = "cache.local"'
        result = run_toml_parse(toml_content)
        assert result['database']['host'] == 'db.local'
        assert result['cache']['host'] == 'cache.local'

    def test_deeply_nested_tables(self):
        """Test parsing deeply nested tables."""
        toml_content = '[a.b.c.d]\nvalue = "deep"'
        result = run_toml_parse(toml_content)
        assert result['a']['b']['c']['d']['value'] == 'deep'


class TestArrayParsing:
    """Tests for TOML array parsing."""

    def test_simple_array(self):
        """Test parsing a simple array."""
        toml_content = 'colors = ["red", "green", "blue"]'
        result = run_toml_parse(toml_content)
        assert result['colors'] == ['red', 'green', 'blue']

    def test_integer_array(self):
        """Test parsing an array of integers."""
        toml_content = 'numbers = [1, 2, 3, 4, 5]'
        result = run_toml_parse(toml_content)
        assert result['numbers'] == [1, 2, 3, 4, 5]

    def test_nested_array(self):
        """Test parsing nested arrays."""
        toml_content = 'matrix = [[1, 2], [3, 4]]'
        result = run_toml_parse(toml_content)
        assert result['matrix'] == [[1, 2], [3, 4]]

    def test_array_of_tables(self):
        """Test parsing array of tables."""
        toml_content = '[[products]]\nname = "Apple"\n\n[[products]]\nname = "Banana"'
        result = run_toml_parse(toml_content)
        assert len(result['products']) == 2
        assert result['products'][0]['name'] == 'Apple'
        assert result['products'][1]['name'] == 'Banana'


class TestInlineTable:
    """Tests for TOML inline table parsing."""

    def test_simple_inline_table(self):
        """Test parsing a simple inline table."""
        toml_content = 'point = { x = 1, y = 2 }'
        result = run_toml_parse(toml_content)
        assert result['point']['x'] == 1
        assert result['point']['y'] == 2

    def test_empty_inline_table(self):
        """Test parsing an empty inline table."""
        toml_content = 'empty = {}'
        result = run_toml_parse(toml_content)
        assert 'empty' in result
        # The empty table should be present but have no keys (except possibly __proto__ with null value)
        assert isinstance(result['empty'], dict)

    def test_nested_inline_table(self):
        """Test parsing nested inline tables."""
        toml_content = 'config = { db = { host = "localhost" } }'
        result = run_toml_parse(toml_content)
        assert result['config']['db']['host'] == 'localhost'


class TestStringTypes:
    """Tests for various TOML string types."""

    def test_basic_string(self):
        """Test parsing basic strings."""
        toml_content = 'message = "Hello, World!"'
        result = run_toml_parse(toml_content)
        assert result['message'] == 'Hello, World!'

    def test_literal_string(self):
        """Test parsing literal strings."""
        toml_content = "path = 'C:\\Users\\name'"
        result = run_toml_parse(toml_content)
        assert result['path'] == 'C:\\Users\\name'

    def test_escape_sequences(self):
        """Test parsing strings with escape sequences."""
        toml_content = 'text = "line1\\nline2\\ttab"'
        result = run_toml_parse(toml_content)
        assert 'line1' in result['text']


class TestSpecialValues:
    """Tests for special TOML values."""

    def test_hex_octal_binary(self):
        """Test parsing hex, octal, and binary numbers."""
        toml_content = 'hex = 0xDEAD\noctal = 0o755\nbinary = 0b11010110'
        result = run_toml_parse(toml_content)
        assert result['hex'] == 0xDEAD
        assert result['octal'] == 0o755
        assert result['binary'] == 0b11010110


class TestEdgeCases:
    """Tests for edge cases."""

    def test_empty_input(self):
        """Test parsing empty input."""
        result = run_toml_parse('')
        assert isinstance(result, dict)

    def test_comment_only(self):
        """Test parsing input with only comments."""
        toml_content = '# This is a comment'
        result = run_toml_parse(toml_content)
        assert isinstance(result, dict)

    def test_dashes_underscores_in_keys(self):
        """Test keys with dashes and underscores."""
        toml_content = 'my-key = 1\nmy_key = 2\nmy-long_key-name = 3'
        result = run_toml_parse(toml_content)
        assert result['my-key'] == 1
        assert result['my_key'] == 2
        assert result['my-long_key-name'] == 3

    def test_quoted_keys(self):
        """Test quoted keys with special characters."""
        toml_content = '"key with spaces" = "value"'
        result = run_toml_parse(toml_content)
        assert result['key with spaces'] == 'value'
