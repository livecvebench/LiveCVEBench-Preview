FROM debian:bookworm

WORKDIR /app

# Apache environment variables
ENV APACHE_RUN_USER=www-data \
    APACHE_RUN_GROUP=www-data \
    APACHE_LOG_DIR=/var/log/apache2

# Install build dependencies and runtime packages
RUN apt-get update && apt-get install -y \
    apache2 \
    apache2-dev \
    gcc \
    g++ \
    make \
    libtool \
    automake \
    autoconf \
    libpcre3-dev \
    libxml2-dev \
    libcurl4-openssl-dev \
    libyajl-dev \
    libapr1-dev \
    libaprutil1-dev \
    pkg-config \
    curl \
    wget \
    procps \
    git \
    tmux \
    asciinema \
    && rm -rf /var/lib/apt/lists/*

# Download and build ModSecurity v2.9.8
RUN wget -q https://github.com/owasp-modsecurity/ModSecurity/archive/refs/tags/v2.9.8.tar.gz \
    && tar -xzf v2.9.8.tar.gz \
    && mv ModSecurity-2.9.8/* . \
    && rm -rf ModSecurity-2.9.8 v2.9.8.tar.gz \
    && ./autogen.sh \
    && ./configure --with-apxs=/usr/bin/apxs --with-apr=/usr/bin/apr-1-config \
    && make \
    && make install

# Configure Apache to load ModSecurity
RUN echo "LoadModule security2_module /usr/lib/apache2/modules/mod_security2.so" > /etc/apache2/mods-available/security2.load \
    && mkdir -p /etc/modsecurity \
    && cp unicode.mapping /etc/modsecurity/

# Copy configuration files
COPY task-deps/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf
COPY task-deps/modsecurity_custom.conf /etc/modsecurity/modsecurity_custom.conf
COPY task-deps/apache-modsecurity.conf /etc/apache2/mods-available/security2.conf

# Enable ModSecurity module and unique_id (required by ModSecurity)
RUN a2enmod unique_id \
    && a2enmod security2

# Create a simple test page
RUN echo "<html><body><h1>ModSecurity Test Server</h1></body></html>" > /var/www/html/index.html

# Create audit log file with proper permissions
RUN touch /var/log/modsec_audit.log && chmod 666 /var/log/modsec_audit.log

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 80

# ENTRYPOINT ["/entrypoint.sh"]  # Moved to docker-compose.yaml
