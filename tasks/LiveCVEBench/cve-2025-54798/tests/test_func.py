"""
Functionality tests for the tmp library.
These tests verify that basic temporary file/directory operations work correctly.
Should PASS in both vulnerable and fixed states.
"""
import subprocess
import os


def run_node_script(script, cwd='/app'):
    """Helper to run Node.js scripts and capture output."""
    result = subprocess.run(
        ['node', '-e', script],
        capture_output=True,
        text=True,
        cwd=cwd
    )
    return result


def test_basic_file_creation():
    """Test that tmp.fileSync() creates files in /tmp."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');
    const result = tmp.fileSync();
    console.log(result.name);
    fs.unlinkSync(result.name);
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert '/tmp/' in result.stdout, f"File not in /tmp: {result.stdout}"


def test_basic_dir_creation():
    """Test that tmp.dirSync() creates directories in /tmp."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');
    const result = tmp.dirSync();
    console.log(result.name);
    fs.rmdirSync(result.name);
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert '/tmp/' in result.stdout, f"Directory not in /tmp: {result.stdout}"


def test_file_with_prefix():
    """Test that prefix option works correctly."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');
    const result = tmp.fileSync({ prefix: 'myprefix-' });
    console.log(result.name);
    fs.unlinkSync(result.name);
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert 'myprefix-' in result.stdout, f"Prefix not found: {result.stdout}"


def test_file_with_postfix():
    """Test that postfix option works correctly."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');
    const result = tmp.fileSync({ postfix: '.txt' });
    console.log(result.name);
    fs.unlinkSync(result.name);
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert result.stdout.strip().endswith('.txt'), f"Postfix not found: {result.stdout}"


def test_relative_dir_within_tmp():
    """Test that relative dir option within /tmp works correctly."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');
    const path = require('path');
    const os = require('os');

    const subdir = path.join(os.tmpdir(), 'testsubdir');
    fs.mkdirSync(subdir, { recursive: true });

    try {
        const result = tmp.fileSync({ dir: subdir });
        console.log(result.name);
        fs.unlinkSync(result.name);
    } finally {
        fs.rmdirSync(subdir);
    }
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert '/tmp/testsubdir/' in result.stdout, f"File not in subdir: {result.stdout}"


def test_async_file_creation():
    """Test that async tmp.file() works correctly."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');

    tmp.file((err, path, fd, cleanup) => {
        if (err) {
            console.error('ERROR:', err.message);
            process.exit(1);
        }
        console.log(path);
        cleanup();
    });
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert '/tmp/' in result.stdout, f"File not in /tmp: {result.stdout}"


def test_async_dir_creation():
    """Test that async tmp.dir() works correctly."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');

    tmp.dir((err, path, cleanup) => {
        if (err) {
            console.error('ERROR:', err.message);
            process.exit(1);
        }
        console.log(path);
        cleanup();
    });
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert '/tmp/' in result.stdout, f"Directory not in /tmp: {result.stdout}"


def test_tmpname_sync():
    """Test that tmpNameSync() generates names in /tmp."""
    script = '''
    const tmp = require('tmp');
    const name = tmp.tmpNameSync();
    console.log(name);
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert '/tmp/' in result.stdout, f"Name not in /tmp: {result.stdout}"


def test_template_option():
    """Test that template option works correctly for valid templates."""
    script = '''
    const tmp = require('tmp');
    const fs = require('fs');
    const path = require('path');
    const os = require('os');

    // Create a template with XXXXXX placeholder
    const result = tmp.fileSync({ template: 'test-XXXXXX.tmp' });
    console.log(result.name);
    fs.unlinkSync(result.name);
    '''
    result = run_node_script(script)
    assert result.returncode == 0, f"Failed: {result.stderr}"
    assert '/tmp/' in result.stdout, f"File not in /tmp: {result.stdout}"
    assert 'test-' in result.stdout, f"Template prefix not found: {result.stdout}"
