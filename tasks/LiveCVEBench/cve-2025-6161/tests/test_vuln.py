"""
Vulnerability tests for the Simple Food Ordering System file upload.
These tests verify that malicious file uploads are BLOCKED (security checks).

Expected behavior:
- FAIL in vulnerable state (exploit succeeds, assertion fails)
- PASS in fixed state (exploit blocked, assertion passes)

NOTE: These tests assert that dangerous uploads should be REJECTED.
In the vulnerable state, uploads succeed, causing assertions to FAIL.
After the fix, uploads are blocked, causing assertions to PASS.
"""

import requests
import time

BASE_URL = "http://localhost"
UPLOAD_ENDPOINT = f"{BASE_URL}/editproduct.php"


class TestPHPFileUploadBlocked:
    """Test that PHP files are blocked by the upload handler."""

    def test_php_file_upload_rejected(self):
        """
        Test that a PHP file is rejected by the upload handler.
        Security: Extension validation should block .php files.
        """
        url = f"{UPLOAD_ENDPOINT}?product=14"

        php_content = '<?php echo "UPLOAD_TEST_MARKER_ABC123"; ?>'

        files = {
            'photo': ('testfile.php', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test Product',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # Security check: PHP upload should be BLOCKED (not redirect to success)
        # After fix: returns 200 with error message instead of 302 redirect
        assert response.status_code not in [302, 303], \
            f"VULNERABLE: PHP file upload was accepted (status {response.status_code}). Server should block .php uploads."

    def test_phtml_file_upload_rejected(self):
        """
        Test that alternative PHP extension (.phtml) is rejected.
        Security: Extension whitelist should exclude .phtml.
        """
        url = f"{UPLOAD_ENDPOINT}?product=15"

        php_content = '<?php echo "PHTML_TEST_MARKER"; ?>'

        files = {
            'photo': ('alttest.phtml', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Egg Product',
            'category': '4',
            'price': '310'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # Security check: .phtml upload should be BLOCKED
        assert response.status_code not in [302, 303], \
            f"VULNERABLE: .phtml file upload was accepted (status {response.status_code}). Server should block non-image extensions."

    def test_php5_file_upload_rejected(self):
        """
        Test that .php5 extension is rejected.
        Security: Extension whitelist should exclude .php5.
        """
        url = f"{UPLOAD_ENDPOINT}?product=16"

        php_content = '<?php echo "PHP5_MARKER"; ?>'

        files = {
            'photo': ('test.php5', php_content, 'image/png')
        }
        data = {
            'pname': 'Beef Product',
            'category': '5',
            'price': '360'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # Security check: .php5 upload should be BLOCKED
        assert response.status_code not in [302, 303], \
            f"VULNERABLE: .php5 file upload was accepted (status {response.status_code}). Server should block non-image extensions."

    def test_case_sensitivity_bypass_blocked(self):
        """
        Test case sensitivity bypass (file.PhP).
        Security: Should normalize case before checking extensions.
        """
        url = f"{UPLOAD_ENDPOINT}?product=14"

        php_content = '<?php echo "CASE_BYPASS_TEST"; ?>'

        files = {
            'photo': ('casetest.PhP', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # Security check: Case-variant PHP should be BLOCKED
        assert response.status_code not in [302, 303], \
            f"VULNERABLE: Case-variant PHP extension (.PhP) was accepted (status {response.status_code}). Server should normalize case."

    def test_double_extension_rejected(self):
        """
        Test double extension bypass (file.php.jpg or file.jpg.php).
        Security: Server should reject files with dangerous final extensions.
        """
        url = f"{UPLOAD_ENDPOINT}?product=17"

        php_content = '<?php echo "DOUBLE_EXT_TEST"; ?>'

        # Try .jpg.php - the actual extension is .php
        files = {
            'photo': ('malicious.jpg.php', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # Security check: Double extension with .php last should be BLOCKED
        assert response.status_code not in [302, 303], \
            f"VULNERABLE: Double extension (.jpg.php) was accepted (status {response.status_code}). Server should check final extension."


class TestUploadedFileShouldNotExecute:
    """Test that uploaded PHP files cannot execute server-side code."""

    def test_uploaded_php_should_not_execute(self):
        """
        Test that uploaded PHP file does NOT execute on the server.
        Security: Uploaded files should not be executable.
        """
        url = f"{UPLOAD_ENDPOINT}?product=14"
        timestamp = int(time.time())

        unique_marker = f"EXEC_TEST_{timestamp}"
        php_content = f'<?php echo "{unique_marker}"; ?>'

        files = {
            'photo': ('exectest.php', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        upload_response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # If upload was blocked, that's secure - test passes
        if upload_response.status_code not in [302, 303]:
            return  # Upload blocked - SECURE

        # Upload succeeded - check if PHP executes (VULNERABLE)
        for offset in range(-10, 10):
            test_timestamp = timestamp + offset
            test_url = f"{BASE_URL}/upload/exectest_{test_timestamp}.php"

            try:
                exec_response = requests.get(test_url, timeout=5)
                if exec_response.status_code == 200 and unique_marker in exec_response.text:
                    assert False, f"VULNERABLE: Uploaded PHP file executed successfully at {test_url}"
            except requests.exceptions.RequestException:
                continue

    def test_webshell_should_not_execute(self):
        """
        Test that a webshell cannot execute system commands.
        Security: Code execution should be impossible.
        """
        url = f"{UPLOAD_ENDPOINT}?product=14"
        timestamp = int(time.time())

        php_content = '<?php if(isset($_POST["c"])){system($_POST["c"]);} ?>'

        files = {
            'photo': ('cmdshell.php', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        upload_response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # If upload was blocked, that's secure
        if upload_response.status_code not in [302, 303]:
            return  # Upload blocked - SECURE

        # Upload succeeded - check if commands can be executed (VULNERABLE)
        for offset in range(-10, 10):
            test_timestamp = timestamp + offset
            shell_url = f"{BASE_URL}/upload/cmdshell_{test_timestamp}.php"

            try:
                cmd_response = requests.post(
                    shell_url,
                    data={'c': 'echo COMMAND_EXECUTED_SUCCESSFULLY'},
                    timeout=5
                )
                if cmd_response.status_code == 200 and "COMMAND_EXECUTED_SUCCESSFULLY" in cmd_response.text:
                    assert False, f"VULNERABLE: Webshell command execution succeeded at {shell_url}"
            except requests.exceptions.RequestException:
                continue

    def test_eval_webshell_blocked(self):
        """
        Test that eval-based webshell cannot execute.
        Security: Arbitrary PHP code execution should be blocked.
        """
        url = f"{UPLOAD_ENDPOINT}?product=18"
        timestamp = int(time.time())

        php_content = '<?php @eval($_POST["cmd"]); ?>'

        files = {
            'photo': ('evalshell.php', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        upload_response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # If upload was blocked, that's secure
        if upload_response.status_code not in [302, 303]:
            return  # Upload blocked - SECURE

        # Upload succeeded - try to execute eval code
        for offset in range(-10, 10):
            test_timestamp = timestamp + offset
            shell_url = f"{BASE_URL}/upload/evalshell_{test_timestamp}.php"

            try:
                cmd_response = requests.post(
                    shell_url,
                    data={'cmd': 'echo "EVAL_EXECUTED";'},
                    timeout=5
                )
                if cmd_response.status_code == 200 and "EVAL_EXECUTED" in cmd_response.text:
                    assert False, f"VULNERABLE: Eval webshell executed at {shell_url}"
            except requests.exceptions.RequestException:
                continue


class TestMIMETypeValidation:
    """Test MIME type validation."""

    def test_php_with_fake_jpeg_mime_rejected(self):
        """
        Test that PHP content with fake image/jpeg MIME type is rejected.
        Security: Should validate actual file content, not just headers.
        """
        url = f"{UPLOAD_ENDPOINT}?product=14"

        php_content = '<?php echo "FAKE_MIME_TEST"; ?>'

        files = {
            'photo': ('fakemime.php', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # Security check: Fake MIME type should be detected and blocked
        assert response.status_code not in [302, 303], \
            f"VULNERABLE: PHP file with fake MIME type was accepted (status {response.status_code}). Server should validate file content."

    def test_php_with_fake_png_mime_rejected(self):
        """
        Test that PHP content with fake image/png MIME type is rejected.
        Security: Should verify actual content, not just declared type.
        """
        url = f"{UPLOAD_ENDPOINT}?product=14"

        php_content = '<?php system($_GET["cmd"]); ?>'

        files = {
            'photo': ('fakepng.php', php_content, 'image/png')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        # Security check: Should not trust Content-Type header blindly
        assert response.status_code not in [302, 303], \
            f"VULNERABLE: PHP file with image Content-Type was accepted (status {response.status_code}). Server should perform content-based validation."

    def test_php_with_gif_mime_rejected(self):
        """
        Test that PHP content with fake image/gif MIME type is rejected.
        Security: All fake MIME types should be rejected.
        """
        url = f"{UPLOAD_ENDPOINT}?product=19"

        php_content = '<?php phpinfo(); ?>'

        files = {
            'photo': ('fakegif.php', php_content, 'image/gif')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        assert response.status_code not in [302, 303], \
            f"VULNERABLE: PHP file with image/gif Content-Type was accepted (status {response.status_code})."


class TestVariousExtensionsBlocked:
    """Test that various dangerous extensions are blocked."""

    def test_php7_extension_rejected(self):
        """
        Test that .php7 extension is rejected.
        """
        url = f"{UPLOAD_ENDPOINT}?product=20"

        php_content = '<?php echo "PHP7_TEST"; ?>'

        files = {
            'photo': ('test.php7', php_content, 'image/jpeg')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        assert response.status_code not in [302, 303], \
            f"VULNERABLE: .php7 file upload was accepted (status {response.status_code})."

    def test_inc_extension_rejected(self):
        """
        Test that .inc (include) extension is rejected.
        """
        url = f"{UPLOAD_ENDPOINT}?product=21"

        php_content = '<?php echo "INC_TEST"; ?>'

        files = {
            'photo': ('config.inc', php_content, 'text/plain')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        assert response.status_code not in [302, 303], \
            f"VULNERABLE: .inc file upload was accepted (status {response.status_code})."

    def test_htaccess_upload_rejected(self):
        """
        Test that .htaccess files cannot be uploaded.
        Security: .htaccess could be used to enable PHP execution.
        """
        url = f"{UPLOAD_ENDPOINT}?product=22"

        htaccess_content = 'AddType application/x-httpd-php .jpg'

        files = {
            'photo': ('.htaccess', htaccess_content, 'text/plain')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        assert response.status_code not in [302, 303], \
            f"VULNERABLE: .htaccess file upload was accepted (status {response.status_code})."

    def test_txt_extension_rejected(self):
        """
        Test that .txt files are rejected (only images allowed).
        """
        url = f"{UPLOAD_ENDPOINT}?product=23"

        files = {
            'photo': ('notes.txt', 'Some text content', 'text/plain')
        }
        data = {
            'pname': 'Test',
            'category': '4',
            'price': '100'
        }

        response = requests.post(url, files=files, data=data, allow_redirects=False, timeout=10)

        assert response.status_code not in [302, 303], \
            f"VULNERABLE: .txt file upload was accepted (status {response.status_code}). Only image files should be allowed."
