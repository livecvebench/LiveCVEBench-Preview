"""
Functionality tests for the kindergarten management system.
These tests verify that the application works correctly for normal operations.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time
import urllib.parse

BASE_URL = "http://localhost"
LOGIN_URL = f"{BASE_URL}/index.php"
STU_LIST_URL = f"{BASE_URL}/stu_list.php"


class TestAuthentication:
    """Test login and session management"""

    def test_login_page_accessible(self):
        """Test that login page is accessible"""
        response = requests.get(LOGIN_URL, timeout=10)
        assert response.status_code == 200
        # Check for login form elements (Chinese: 登录 = login)
        assert '登录' in response.text or 'login' in response.text.lower() or 'username' in response.text.lower()

    def test_login_with_valid_credentials(self):
        """Test login with valid admin credentials"""
        session = requests.Session()
        response = session.post(LOGIN_URL, data={
            'username': 'admin',
            'userpwd': 'admin'
        }, timeout=10, allow_redirects=True)

        assert response.status_code == 200
        # After successful login, should be redirected or see admin content
        # Check that we're not still on the login page with an error
        assert 'PHPSESSID' in session.cookies or len(session.cookies) > 0

    def test_login_creates_session(self):
        """Test that login creates a valid session cookie"""
        session = requests.Session()
        session.post(LOGIN_URL, data={
            'username': 'admin',
            'userpwd': 'admin'
        }, timeout=10)

        # Session should have cookies after login
        assert len(session.cookies) > 0


class TestStuListPage:
    """Test the student list (stu_list.php) page functionality"""

    @pytest.fixture
    def authenticated_session(self):
        """Create an authenticated session"""
        session = requests.Session()
        session.post(LOGIN_URL, data={
            'username': 'admin',
            'userpwd': 'admin'
        }, timeout=10)
        return session

    def test_stu_list_accessible_after_login(self, authenticated_session):
        """Test that stu_list.php is accessible after authentication"""
        response = authenticated_session.get(STU_LIST_URL, timeout=10)
        assert response.status_code == 200
        # Should show student management page (幼儿档案管理 = Child Archive Management)
        assert '幼儿档案管理' in response.text or '档案' in response.text or 'stu_list' in response.url

    def test_search_with_valid_sex_parameter(self, authenticated_session):
        """Test search with valid gender parameter"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'sex': '男'  # Male
        }, timeout=10)

        assert response.status_code == 200
        # Should not contain SQL error messages
        assert 'error' not in response.text.lower() or 'sql' not in response.text.lower()

    def test_search_with_valid_nation_parameter(self, authenticated_session):
        """Test search with valid ethnicity parameter"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'nation': '汉族'  # Han Chinese
        }, timeout=10)

        assert response.status_code == 200
        assert 'error' not in response.text.lower() or 'sql' not in response.text.lower()

    def test_search_with_valid_keywords(self, authenticated_session):
        """Test search with valid keyword parameter"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'keywords': '张'  # Common Chinese surname
        }, timeout=10)

        assert response.status_code == 200
        assert 'error' not in response.text.lower() or 'sql' not in response.text.lower()

    def test_search_with_banji_parameter(self, authenticated_session):
        """Test search with class (banji) parameter"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'banji': '1'
        }, timeout=10)

        assert response.status_code == 200
        assert 'error' not in response.text.lower() or 'sql' not in response.text.lower()

    def test_search_with_isok_parameter(self, authenticated_session):
        """Test search with status (isok) parameter"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'isok': '1'
        }, timeout=10)

        assert response.status_code == 200
        assert 'error' not in response.text.lower() or 'sql' not in response.text.lower()

    def test_search_with_multiple_valid_parameters(self, authenticated_session):
        """Test search combining multiple valid parameters"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'sex': '女',  # Female
            'banji': '1',
            'isok': '1'
        }, timeout=10)

        assert response.status_code == 200
        assert 'error' not in response.text.lower() or 'sql' not in response.text.lower()

    def test_page_responds_quickly_for_normal_search(self, authenticated_session):
        """Test that normal searches respond within reasonable time"""
        start_time = time.time()
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'sex': '男'
        }, timeout=10)
        elapsed = time.time() - start_time

        assert response.status_code == 200
        # Normal search should complete within 3 seconds
        assert elapsed < 3, f"Search took {elapsed}s, expected < 3s"

    def test_empty_search_returns_results(self, authenticated_session):
        """Test that accessing the page without search parameters works"""
        response = authenticated_session.get(STU_LIST_URL, timeout=10)

        assert response.status_code == 200
        # Should show the page structure
        assert '<table' in response.text.lower() or 'tbody' in response.text.lower()


class TestSearchSpecialCharacters:
    """Test that search handles special characters correctly after fix"""

    @pytest.fixture
    def authenticated_session(self):
        """Create an authenticated session"""
        session = requests.Session()
        session.post(LOGIN_URL, data={
            'username': 'admin',
            'userpwd': 'admin'
        }, timeout=10)
        return session

    def test_search_with_space_in_keywords(self, authenticated_session):
        """Test search with spaces in keywords"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'keywords': '张 三'  # Name with space
        }, timeout=10)

        assert response.status_code == 200
        # Should not cause errors
        assert 'error' not in response.text.lower() or 'syntax' not in response.text.lower()

    def test_search_with_chinese_characters(self, authenticated_session):
        """Test search with various Chinese characters"""
        response = authenticated_session.get(STU_LIST_URL, params={
            'action': 'search',
            'keywords': '李明华'
        }, timeout=10)

        assert response.status_code == 200


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
