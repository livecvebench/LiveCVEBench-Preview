"""
Functional tests for the Simple Attendance Record System.
These tests verify that basic functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import time

BASE_URL = "http://localhost"
TIMEOUT = 10


class TestApplicationAccessibility:
    """Test that the application is accessible and responding."""

    def test_index_page_accessible(self):
        """Test that the main index page is accessible."""
        response = requests.get(f"{BASE_URL}/index.php", timeout=TIMEOUT)
        assert response.status_code == 200
        # The page should contain the login form
        assert "student" in response.text.lower() or "attendance" in response.text.lower()

    def test_check_endpoint_responds(self):
        """Test that the check.php endpoint responds to POST requests."""
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "test"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        # Should return either Success or Error
        assert "Success" in response.text or "Error" in response.text


class TestValidStudentLookup:
    """Test valid student ID lookups."""

    def test_valid_student_id_returns_success(self):
        """Test that a valid student ID returns Success."""
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "121299"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "Success" in response.text

    def test_valid_student_id_as_string(self):
        """Test valid student ID passed as string."""
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "121299"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "Success" in response.text


class TestInvalidStudentLookup:
    """Test invalid student ID lookups."""

    def test_invalid_student_id_returns_error(self):
        """Test that an invalid student ID returns Error."""
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "999999"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "Error" in response.text

    def test_nonexistent_student_id_returns_error(self):
        """Test that a non-existent student ID returns Error."""
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "000000"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "Error" in response.text

    def test_empty_student_id_returns_error(self):
        """Test that an empty student ID returns Error or handles gracefully."""
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": ""},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        # Empty ID should not be successful
        assert "Error" in response.text or "Success" not in response.text

    def test_alphabetic_student_id_returns_error(self):
        """Test that an alphabetic student ID returns Error."""
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "abcdef"},
            timeout=TIMEOUT
        )
        assert response.status_code == 200
        assert "Error" in response.text


class TestResponseFormat:
    """Test the response format of the check endpoint."""

    def test_response_contains_expected_text(self):
        """Test that response contains expected text format."""
        # Test with valid ID
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "121299"},
            timeout=TIMEOUT
        )
        # Response should be simple text
        assert len(response.text.strip()) < 100  # Should be short response

    def test_response_time_is_reasonable(self):
        """Test that response time is reasonable for normal queries."""
        start_time = time.time()
        response = requests.post(
            f"{BASE_URL}/check.php",
            data={"student": "121299"},
            timeout=TIMEOUT
        )
        elapsed = time.time() - start_time
        assert response.status_code == 200
        assert elapsed < 3.0  # Normal query should complete in under 3 seconds
