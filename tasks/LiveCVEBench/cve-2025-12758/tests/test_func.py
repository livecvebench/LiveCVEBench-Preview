"""
Functional tests for the isLength() validator function.
These tests verify basic functionality and should PASS in both vulnerable and fixed states.
"""

import subprocess
import json
import pytest


def run_js(code):
    """Run JavaScript code and return output"""
    result = subprocess.run(
        ['node', '-e', code],
        capture_output=True,
        text=True,
        cwd='/app'
    )
    if result.returncode != 0:
        raise RuntimeError(f"JS execution failed: {result.stderr}")
    return result.stdout.strip()


class TestBasicLengthValidation:
    """Test basic min/max length validation works correctly"""

    def test_string_within_range(self):
        """String within min/max range should return true"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('abc', { min: 2, max: 5 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_string_below_min(self):
        """String below minimum length should return false"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('a', { min: 2 }));
        '''
        result = run_js(code)
        assert result == 'false', f"Expected 'false', got '{result}'"

    def test_string_exceeds_max(self):
        """String exceeding max length should return false"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('abcdef', { max: 5 }));
        '''
        result = run_js(code)
        assert result == 'false', f"Expected 'false', got '{result}'"

    def test_string_exactly_at_max(self):
        """String exactly at max length should return true"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('hello', { min: 5, max: 5 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_empty_string_with_max_zero(self):
        """Empty string with max:0 should return true"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('', { max: 0 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"


class TestMinMaxEdgeCases:
    """Test edge cases for min/max validation"""

    def test_no_options(self):
        """No options should use defaults (min=0, max=undefined)"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('anything'));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_only_min(self):
        """Only min specified should work"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('hello', { min: 3 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_only_max(self):
        """Only max specified should work"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('hi', { max: 5 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_legacy_positional_args(self):
        """Legacy positional arguments (min, max) should work"""
        code = '''
        const v = require('validator');
        // isLength(str, min, max) legacy syntax
        console.log(v.isLength('hello', 3, 10));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"


class TestUnicodeBasics:
    """Test basic Unicode character handling"""

    def test_chinese_characters(self):
        """Chinese characters should be counted correctly"""
        code = '''
        const v = require('validator');
        // Two Chinese characters
        console.log(v.isLength('中文', { max: 2 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_simple_emoji_with_surrogate_pair(self):
        """Emoji with surrogate pairs should be handled"""
        code = '''
        const v = require('validator');
        // Grinning face emoji (surrogate pair)
        const emoji = '\\uD83D\\uDE00';
        console.log(v.isLength(emoji, { max: 1 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_mixed_ascii_and_unicode(self):
        """Mixed ASCII and Unicode should work"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('hi中', { max: 3 }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"


class TestDiscreteLengths:
    """Test the discreteLengths option"""

    def test_discrete_length_match(self):
        """String matching discrete length should return true"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('hello', { min: 0, max: 10, discreteLengths: [5, 10] }));
        '''
        result = run_js(code)
        assert result == 'true', f"Expected 'true', got '{result}'"

    def test_discrete_length_no_match(self):
        """String not matching discrete lengths should return false"""
        code = '''
        const v = require('validator');
        console.log(v.isLength('hello', { min: 0, max: 10, discreteLengths: [4, 6] }));
        '''
        result = run_js(code)
        assert result == 'false', f"Expected 'false', got '{result}'"


class TestInputValidation:
    """Test input validation behavior"""

    def test_non_string_throws(self):
        """Non-string input should throw TypeError"""
        code = '''
        const v = require('validator');
        try {
            v.isLength(123, { max: 5 });
            console.log('no_error');
        } catch (e) {
            console.log('error');
        }
        '''
        result = run_js(code)
        assert result == 'error', f"Expected 'error', got '{result}'"

    def test_null_throws(self):
        """Null input should throw TypeError"""
        code = '''
        const v = require('validator');
        try {
            v.isLength(null, { max: 5 });
            console.log('no_error');
        } catch (e) {
            console.log('error');
        }
        '''
        result = run_js(code)
        assert result == 'error', f"Expected 'error', got '{result}'"


class TestLegitimateVariationSelectors:
    """
    Test that legitimate use of variation selectors still works correctly.
    A single variation selector following a base character should be excluded
    from length calculation (this is the intended behavior for emoji styling).
    These tests should PASS in both vulnerable and fixed states.
    """

    def test_single_selector_after_base_char(self):
        """
        Single selector after base char should be excluded from length.
        This is legitimate use: base char + selector = 1 grapheme.
        """
        code = '''
        const v = require('validator');
        // '☺' (U+263A) + FE0F = 2 chars but 1 grapheme
        const testStr = '\\u263A\\uFE0F';
        const result = v.isLength(testStr, { max: 2 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'true', \
            f"Legitimate single selector after base char broken! Got: {result}"

    def test_emoji_with_single_selector(self):
        """
        Emoji with single variation selector should work.
        """
        code = '''
        const v = require('validator');
        // Star (U+2B50) + FE0F = should be counted as 1 grapheme
        const testStr = '\\u2B50\\uFE0F';
        const result = v.isLength(testStr, { max: 2 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'true', \
            f"Emoji with selector handling broken! Got: {result}"


class TestMinLengthWithSelectors:
    """
    Verify that minimum length validation works correctly with variation selectors.
    These tests should PASS in both vulnerable and fixed states.
    """

    def test_min_length_still_works_with_selectors(self):
        """
        Minimum length should still be enforced with variation selectors.
        """
        code = '''
        const v = require('validator');
        // 'a' + 1 selector = 2 chars, min 5 should fail
        const testStr = 'a\\uFE0F';
        const result = v.isLength(testStr, { min: 5 });
        console.log(result);
        '''
        result = run_js(code)
        assert result == 'false', \
            f"Min length not enforced with selectors! Got: {result}"
