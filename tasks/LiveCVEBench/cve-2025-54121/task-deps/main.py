"""
Starlette application for CVE-2025-54121 reproduction.
Accepts file uploads via multipart form.
"""
from starlette.applications import Starlette
from starlette.requests import Request
from starlette.responses import JSONResponse
from starlette.routing import Route


async def upload_handler(request: Request):
    """Handles file uploads via multipart form."""
    form = await request.form()
    result = {}
    for key, value in form.items():
        if hasattr(value, 'read'):
            content = await value.read()
            result[key] = {
                "filename": value.filename,
                "size": len(content)
            }
        else:
            result[key] = {"value": value}
    await request.close()
    return JSONResponse(result)


async def health(request: Request):
    """Health check endpoint."""
    return JSONResponse({"status": "ok"})


app = Starlette(routes=[
    Route("/upload", upload_handler, methods=["POST"]),
    Route("/health", health, methods=["GET"]),
])
