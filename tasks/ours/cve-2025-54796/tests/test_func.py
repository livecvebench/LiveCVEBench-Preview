"""
Functional tests for copyparty file server.

These tests verify that basic functionality works correctly.
They should PASS in both vulnerable and fixed states.
"""

import time
import requests
import pytest


BASE_URL = "http://localhost:3923"
TIMEOUT = 10


class TestServerBasicFunctionality:
    """Test that the server is running and accessible."""

    def test_server_is_accessible(self):
        """Verify the server responds to basic requests."""
        resp = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        assert resp.status_code == 200

    def test_server_returns_html(self):
        """Verify the main page returns HTML content."""
        resp = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        assert "text/html" in resp.headers.get("Content-Type", "")


class TestRecentUploadsPage:
    """Test that the recent uploads page works correctly."""

    def test_recent_uploads_page_loads(self):
        """Test that recent uploads page (/?ru) is accessible."""
        resp = requests.get(f"{BASE_URL}/?ru", timeout=TIMEOUT)
        # Should return 200 (success) or some valid response
        assert resp.status_code in [200, 500]  # 500 if no uploads configured, but should respond

    def test_user_uploads_page_loads(self):
        """Test that user's own uploads page (/?ups) is accessible."""
        resp = requests.get(f"{BASE_URL}/?ups", timeout=TIMEOUT)
        # Should respond (may be 500 if not configured, but shouldn't hang)
        assert resp.status_code in [200, 500]


class TestFilterFunctionality:
    """Test that filtering functionality works correctly."""

    def test_filter_with_simple_string(self):
        """Test filtering with a simple string works."""
        resp = requests.get(f"{BASE_URL}/?ru&filter=test", timeout=TIMEOUT)
        assert resp.status_code in [200, 500]

    def test_filter_with_prefix_anchor(self):
        """Test prefix filtering with ^ anchor works."""
        resp = requests.get(f"{BASE_URL}/?ru&filter=^/uploads", timeout=TIMEOUT)
        assert resp.status_code in [200, 500]

    def test_filter_with_suffix_anchor(self):
        """Test suffix filtering with $ anchor works."""
        resp = requests.get(f"{BASE_URL}/?ru&filter=.txt$", timeout=TIMEOUT)
        assert resp.status_code in [200, 500]

    def test_filter_with_exact_match(self):
        """Test exact match filtering with ^...$ works."""
        resp = requests.get(f"{BASE_URL}/?ru&filter=^/uploads/file.txt$", timeout=TIMEOUT)
        assert resp.status_code in [200, 500]

    def test_filter_empty_string(self):
        """Test that empty filter returns all results."""
        resp = requests.get(f"{BASE_URL}/?ru&filter=", timeout=TIMEOUT)
        assert resp.status_code in [200, 500]

    def test_ups_filter_with_simple_string(self):
        """Test filtering on user uploads page works."""
        resp = requests.get(f"{BASE_URL}/?ups&filter=doc", timeout=TIMEOUT)
        assert resp.status_code in [200, 500]


class TestServerResponseTimes:
    """Test that server responds in reasonable time."""

    def test_main_page_response_time(self):
        """Verify main page responds quickly."""
        start = time.time()
        resp = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        elapsed = time.time() - start
        assert elapsed < 5, f"Main page took too long: {elapsed:.2f}s"
        assert resp.status_code == 200

    def test_ru_page_response_time(self):
        """Verify recent uploads page responds quickly."""
        start = time.time()
        try:
            resp = requests.get(f"{BASE_URL}/?ru", timeout=TIMEOUT)
        except requests.Timeout:
            pytest.fail("Recent uploads page timed out")
        elapsed = time.time() - start
        assert elapsed < 5, f"Recent uploads page took too long: {elapsed:.2f}s"

    def test_filter_response_time(self):
        """Verify filtered requests respond quickly."""
        start = time.time()
        try:
            resp = requests.get(f"{BASE_URL}/?ru&filter=test", timeout=TIMEOUT)
        except requests.Timeout:
            pytest.fail("Filtered request timed out")
        elapsed = time.time() - start
        assert elapsed < 5, f"Filtered request took too long: {elapsed:.2f}s"
