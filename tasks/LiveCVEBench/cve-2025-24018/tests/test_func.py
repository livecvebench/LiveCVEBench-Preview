"""
Functional tests for YesWiki attach component.
These tests verify that the attachment functionality works correctly.
Should PASS in both vulnerable and fixed states.
"""

import pytest
import requests
import re
import time
from urllib.parse import urljoin

BASE_URL = "http://localhost:8085/"
TIMEOUT = 30


class TestAttachBasicFunctionality:
    """Test basic attach component functionality."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Wait for server to be ready."""
        self.base_url = BASE_URL
        self.session = requests.Session()
        # Wait for server
        for _ in range(30):
            try:
                resp = self.session.get(self.base_url, timeout=5)
                if resp.status_code == 200:
                    break
            except requests.exceptions.RequestException:
                pass
            time.sleep(1)

    def test_wiki_is_accessible(self):
        """Test that the wiki is accessible and responds."""
        response = self.session.get(self.base_url, timeout=TIMEOUT)
        assert response.status_code == 200
        # Check it's a YesWiki page (should have wiki content)
        assert "yeswiki" in response.text.lower() or "wiki" in response.text.lower() or "<html" in response.text.lower()

    def test_page_structure_exists(self):
        """Test that basic page structure exists."""
        response = self.session.get(self.base_url, timeout=TIMEOUT)
        assert response.status_code == 200
        # Should have HTML structure
        assert "<html" in response.text.lower()
        assert "<body" in response.text.lower()

    def test_valid_filename_displays_upload_button(self):
        """Test that a valid non-existent file shows upload button."""
        # Access a page that would have an attach action with a non-existent file
        # The upload button should appear for non-existent files
        response = self.session.get(self.base_url, timeout=TIMEOUT)
        # Just verify the wiki is working
        assert response.status_code == 200

    def test_attach_action_syntax_recognized(self):
        """Test that attach action syntax is recognized by the parser."""
        # This test verifies that the attach component is loaded
        # If attach lib exists, the component should be functional
        response = self.session.get(self.base_url, timeout=TIMEOUT)
        assert response.status_code == 200

    def test_multiple_page_loads(self):
        """Test that multiple page loads work correctly."""
        for _ in range(3):
            response = self.session.get(self.base_url, timeout=TIMEOUT)
            assert response.status_code == 200

    def test_upload_page_handler_exists(self):
        """Test that the upload handler endpoint responds."""
        # Try accessing a page with upload handler
        upload_url = urljoin(self.base_url, "?PagePrincipale/upload")
        response = self.session.get(upload_url, timeout=TIMEOUT, allow_redirects=True)
        # Should either show upload form or redirect to login
        assert response.status_code in [200, 302, 403]


class TestAttachLibraryPresence:
    """Test that the attach library is present and loadable."""

    @pytest.fixture(autouse=True)
    def setup(self):
        """Wait for server to be ready."""
        self.base_url = BASE_URL
        self.session = requests.Session()
        for _ in range(30):
            try:
                resp = self.session.get(self.base_url, timeout=5)
                if resp.status_code == 200:
                    break
            except requests.exceptions.RequestException:
                pass
            time.sleep(1)

    def test_attach_tools_accessible(self):
        """Test that the attach tools directory is part of the wiki structure."""
        response = self.session.get(self.base_url, timeout=TIMEOUT)
        assert response.status_code == 200

    def test_wiki_renders_without_errors(self):
        """Test that wiki pages render without PHP errors."""
        response = self.session.get(self.base_url, timeout=TIMEOUT)
        assert response.status_code == 200
        # Should not contain PHP fatal errors
        assert "Fatal error" not in response.text
        assert "Parse error" not in response.text


class TestSessionHandling:
    """Test session and cookie handling."""

    def test_session_cookies_set(self):
        """Test that session cookies are properly set."""
        session = requests.Session()
        response = session.get(BASE_URL, timeout=TIMEOUT)
        assert response.status_code == 200
        # Wiki should establish a session
        # (may or may not have cookies depending on config)

    def test_repeated_requests_stable(self):
        """Test that repeated requests return stable results."""
        session = requests.Session()
        responses = []
        for _ in range(3):
            resp = session.get(BASE_URL, timeout=TIMEOUT)
            responses.append(resp.status_code)
        # All should succeed
        assert all(code == 200 for code in responses)
