# Dockerfile for CVE-2025-48866: ModSecurity sanitiseArg Denial of Service
# This builds a vulnerable ModSecurity v2.9.9 environment

FROM debian:bullseye

WORKDIR /app

# Note: Proxy is injected via --build-arg during build, not hardcoded here

# Install build dependencies and runtime dependencies (with multiple retries for network issues)
RUN apt-get update && \
    for i in 1 2 3 4 5; do \
        apt-get install -y --fix-missing \
            apache2 apache2-dev \
            build-essential \
            libapr1-dev libaprutil1-dev \
            libpcre2-dev libpcre3-dev \
            libxml2 libxml2-dev \
            libcurl4-openssl-dev \
            libyajl-dev \
            liblua5.2-dev \
            libtool autoconf automake \
            git curl \
            php php-common libapache2-mod-php \
            tmux asciinema \
            python3 python3-requests && break; \
        echo "Attempt $i failed, retrying..."; \
        apt-get update; \
        apt --fix-broken install -y || true; \
        sleep 5; \
    done && \
    apt --fix-broken install -y || true && \
    gcc --version && \
    rm -rf /var/lib/apt/lists/*

# Clone ModSecurity source at vulnerable version v2.9.9
RUN git clone https://github.com/owasp-modsecurity/ModSecurity.git /app/ModSecurity && \
    cd /app/ModSecurity && \
    git checkout v2.9.9 && \
    rm -rf .git

# Build ModSecurity from source
RUN cd /app/ModSecurity && \
    ./autogen.sh && \
    ./configure --with-apxs=/usr/bin/apxs && \
    make -j$(nproc) && \
    make install

# Create ModSecurity configuration directories
RUN mkdir -p /etc/modsecurity/rules

# Copy ModSecurity vulnerable rules
COPY task-deps/modsecurity_vuln_rule.conf /etc/modsecurity/rules/modsecurity_vuln_rule.conf

# Copy test application
COPY task-deps/test.php /var/www/html/test.php

# Copy ModSecurity module load configuration
COPY task-deps/security2.load /etc/apache2/mods-available/security2.load
COPY task-deps/security2.conf /etc/apache2/mods-available/security2.conf

# Enable Apache modules (unique_id is REQUIRED for ModSecurity audit logging!)
RUN a2enmod security2 && \
    a2enmod unique_id && \
    a2enmod php7.4 || a2enmod php8.0 || a2enmod php || true

# Configure Apache to listen on port 8080
COPY task-deps/ports-8080.conf /tmp/ports-8080.conf
RUN cat /tmp/ports-8080.conf >> /etc/apache2/ports.conf && rm /tmp/ports-8080.conf

# Copy virtual host configuration for port 8080
COPY task-deps/modsec-test.conf /etc/apache2/sites-available/modsec-test.conf

# Enable the site
RUN a2ensite modsec-test.conf

# Create log files and set permissions
RUN touch /var/log/modsec_audit.log && \
    chown www-data:www-data /var/log/modsec_audit.log

# Copy entrypoint script
COPY task-deps/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Set working directory for application
WORKDIR /var/www/html

# Expose port 8080
EXPOSE 8080

# Start Apache in foreground
# CMD ["/entrypoint.sh"]  # Moved to docker-compose.yaml
