#!/bin/bash
set -e

# Fix for EXIF metadata exposure in image uploads
# This script adds metadata stripping to uploaded images

cd /app/api

# Step 1: Install Pillow dependency
pip install "Pillow>=10.0.0" --quiet

# Step 2: Create the fixed upload_content.py with metadata stripping
cat > src/services/utils/upload_content.py << 'PYTHONEOF'
from typing import Literal, Optional
import boto3
from botocore.exceptions import ClientError
import os
from io import BytesIO
from PIL import Image

from fastapi import HTTPException

from config.config import get_learnhouse_config


def ensure_directory_exists(directory: str):
    if not os.path.exists(directory):
        os.makedirs(directory)


def strip_image_metadata(file_binary: bytes, file_format: str) -> bytes:
    """Strip EXIF and other metadata from image files to prevent information disclosure."""
    image_formats = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'tiff', 'bmp']

    if file_format.lower() not in image_formats:
        return file_binary

    if not file_binary:
        return file_binary

    try:
        img = Image.open(BytesIO(file_binary))

        # Create a new image with only pixel data (no metadata)
        data = list(img.getdata())
        clean_img = Image.new(img.mode, img.size)
        clean_img.putdata(data)

        # Save to bytes
        output = BytesIO()
        save_format = 'JPEG' if file_format.lower() in ['jpg', 'jpeg'] else file_format.upper()
        clean_img.save(output, format=save_format)
        return output.getvalue()
    except Exception:
        # If processing fails, return original bytes
        return file_binary


async def upload_content(
    directory: str,
    type_of_dir: Literal["orgs", "users"],
    uuid: str,  # org_uuid or user_uuid
    file_binary: bytes,
    file_and_format: str,
    allowed_formats: Optional[list[str]] = None,
):
    # Get Learnhouse Config
    learnhouse_config = get_learnhouse_config()

    file_format = file_and_format.split(".")[-1].strip().lower()

    # Get content delivery method
    content_delivery = learnhouse_config.hosting_config.content_delivery.type

    # Check if format file is allowed
    if allowed_formats:
        if file_format not in allowed_formats:
            raise HTTPException(
                status_code=400,
                detail=f"File format {file_format} not allowed",
            )

    # Strip metadata from image files to prevent information disclosure
    file_binary = strip_image_metadata(file_binary, file_format)

    ensure_directory_exists(f"content/{type_of_dir}/{uuid}/{directory}")

    if content_delivery == "filesystem":
        # upload file to server
        with open(
            f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            "wb",
        ) as f:
            f.write(file_binary)
            f.close()

    elif content_delivery == "s3api":
        # Upload to server then to s3 (AWS Keys are stored in environment variables and are loaded by boto3)
        # TODO: Improve implementation of this
        print("Uploading to s3...")
        s3 = boto3.client(
            "s3",
            endpoint_url=learnhouse_config.hosting_config.content_delivery.s3api.endpoint_url,
        )

        # Upload file to server
        with open(
            f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            "wb",
        ) as f:
            f.write(file_binary)
            f.close()

        print("Uploading to s3 using boto3...")
        try:
            s3.upload_file(
                f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
                "learnhouse-media",
                f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            )
        except ClientError as e:
            print(e)

        print("Checking if file exists in s3...")
        try:
            s3.head_object(
                Bucket="learnhouse-media",
                Key=f"content/{type_of_dir}/{uuid}/{directory}/{file_and_format}",
            )
            print("File upload successful!")
        except Exception as e:
            print(f"An error occurred: {str(e)}")
PYTHONEOF

echo "Fix applied: EXIF metadata is now stripped from uploaded images"
