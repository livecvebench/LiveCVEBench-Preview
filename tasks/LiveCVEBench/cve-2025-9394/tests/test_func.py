"""
Functional tests for PoDoFo PDF library.
These tests verify the library works correctly with valid PDFs.
Should PASS in both vulnerable and fixed states.
"""

import subprocess
import os
import tempfile
import pytest


# Path to podofoencrypt tool
PODOFOENCRYPT = "/app/build/target/podofoencrypt"


def create_minimal_pdf(path):
    """
    Create a minimal valid PDF file with correct xref offsets.
    This PDF is carefully constructed to be parseable by PoDoFo.
    """
    # Build PDF content tracking exact byte offsets
    header = b"%PDF-1.4\n"

    obj1_offset = len(header)
    obj1 = b"1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n"

    obj2_offset = obj1_offset + len(obj1)
    obj2 = b"2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n"

    obj3_offset = obj2_offset + len(obj2)
    obj3 = b"3 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] >>\nendobj\n"

    xref_offset = obj3_offset + len(obj3)

    xref = b"xref\n0 4\n"
    xref += b"0000000000 65535 f \n"
    xref += f"{obj1_offset:010d} 00000 n \n".encode()
    xref += f"{obj2_offset:010d} 00000 n \n".encode()
    xref += f"{obj3_offset:010d} 00000 n \n".encode()

    trailer = b"trailer\n<< /Size 4 /Root 1 0 R >>\n"
    trailer += f"startxref\n{xref_offset}\n%%EOF\n".encode()

    with open(path, 'wb') as f:
        f.write(header)
        f.write(obj1)
        f.write(obj2)
        f.write(obj3)
        f.write(xref)
        f.write(trailer)


class TestPdfBasicFunctionality:
    """Test basic PDF processing functionality."""

    def test_podofoencrypt_exists(self):
        """Verify podofoencrypt tool is built and accessible."""
        assert os.path.exists(PODOFOENCRYPT), \
            f"podofoencrypt not found at {PODOFOENCRYPT}"

    def test_podofoencrypt_help(self):
        """Verify podofoencrypt --help works."""
        result = subprocess.run(
            [PODOFOENCRYPT, "--help"],
            capture_output=True,
            text=True,
            timeout=30
        )
        # Help should show usage info - exit code may vary
        assert 'usage' in result.stdout.lower() or 'usage' in result.stderr.lower() or \
               'encrypt' in result.stdout.lower() or 'encrypt' in result.stderr.lower(), \
            f"Help output doesn't contain expected keywords"

    def test_encrypt_minimal_pdf(self):
        """Test encryption of a minimal valid PDF file."""
        with tempfile.NamedTemporaryFile(suffix=".pdf", delete=False) as f:
            input_path = f.name

        with tempfile.NamedTemporaryFile(suffix=".pdf", delete=False) as f:
            output_path = f.name

        try:
            create_minimal_pdf(input_path)

            result = subprocess.run(
                [PODOFOENCRYPT, "-o", "testpassword", input_path, output_path],
                capture_output=True,
                text=True,
                timeout=30,
                env={**os.environ, 'ASAN_OPTIONS': 'detect_leaks=0'}
            )

            # The tool should complete without crashing (ASAN errors)
            combined = (result.stdout + result.stderr).lower()
            assert 'addresssanitizer' not in combined, \
                f"ASAN error detected: {result.stderr}"
            assert 'heap-use-after-free' not in combined, \
                f"Memory corruption detected: {result.stderr}"

            # Exit code 0 means success, other codes may indicate PDF parsing issues
            # but not crashes
            assert result.returncode != -6, "Process crashed with SIGABRT"
            assert result.returncode != -11, "Process crashed with SIGSEGV"

        finally:
            for path in [input_path, output_path]:
                if os.path.exists(path):
                    os.unlink(path)


class TestLibraryBuild:
    """Test that the library is properly built."""

    def test_library_exists(self):
        """Verify libpodofo.so is built."""
        lib_path = "/app/build/target/libpodofo.so"
        assert os.path.exists(lib_path), f"Library not found at {lib_path}"

    def test_tools_built(self):
        """Verify various PoDoFo tools are built."""
        tools = [
            "/app/build/target/podofoencrypt",
            "/app/build/target/podofouncompress",
        ]
        for tool in tools:
            assert os.path.exists(tool), f"Tool not found: {tool}"

    def test_source_code_exists(self):
        """Verify source code is available for inspection."""
        src_path = "/app/src/podofo/main/PdfTokenizer.cpp"
        assert os.path.exists(src_path), f"Source not found: {src_path}"


class TestEnvironment:
    """Test that the environment is correctly set up."""

    def test_asan_enabled(self):
        """Verify AddressSanitizer is enabled in the build."""
        result = subprocess.run(
            ["nm", PODOFOENCRYPT],
            capture_output=True,
            text=True,
            timeout=30
        )
        assert 'asan' in result.stdout.lower(), \
            "ASAN symbols not found - build may not have sanitizer enabled"

    def test_vulnerable_commit(self):
        """
        Verify we're testing the vulnerable version by checking
        that the vulnerable code pattern exists.
        """
        src_path = "/app/src/podofo/main/PdfTokenizer.cpp"
        with open(src_path, 'r') as f:
            content = f.read()

        # The vulnerable version has these warning messages
        assert 'Invalid real while parsing content' in content, \
            "Expected warning message not found in source"
        assert 'Invalid number while parsing content' in content, \
            "Expected warning message not found in source"

    def test_library_has_asan(self):
        """
        Verify that the PoDoFo library is linked with ASAN.
        """
        libpodofo = "/app/build/target/libpodofo.so"
        assert os.path.exists(libpodofo), f"Library not found: {libpodofo}"

        result = subprocess.run(
            ["ldd", libpodofo],
            capture_output=True,
            text=True,
            timeout=30
        )

        has_asan = 'libasan' in result.stdout.lower()

        assert has_asan, \
            "libasan not linked to libpodofo.so. " \
            "Build should link against AddressSanitizer runtime."
